<?php
/*!
 * FONTE        : incluir_linha_credito.php                    Última alteração: 10/10/2017
 * CRIAÇÃO      : Andrei (RKAM)
 * DATA CRIAÇÃO : Julho/2016 
 * OBJETIVO     : Rotina para incluir uma linha de crédito
 * --------------
 * ALTERAÇÕES   :  10/08/2016 - Ajuste referente a homologação da área de negócio
                                (Andrei - RKAM)

			       09/09/2016 - Ajuste para pegar corretamente o valor do parametro consaut
								(Adriano)

                   27/03/2017 - Inclusao dos campos Produto e Indexador. (Jaison/James - PRJ298)

                   10/10/2017 - Inclusao do campo % Mínimo Garantia e opção 4 no campo Modelo. (Lombardi - PRJ404)
					  03/2019 - Projeto 437 AMcom JDB
				   06/01/2019 - Inclusao do campo vlperidx (Nagasava - Supero - PRJ298.2.2)
 */
?>

<?php	
 
    session_start();
	require_once('../../includes/config.php');
	require_once('../../includes/funcoes.php');
	require_once('../../includes/controla_secao.php');
	require_once('../../class/xmlfile.php');
	isPostMethod();		
	
	// Carrega permissões do operador
	require_once('../../includes/carrega_permissoes.php');		
	
	$cddopcao = (isset($_POST["cddopcao"])) ? $_POST["cddopcao"] : '';
	
	if (($msgError = validaPermissao($glbvars['nmdatela'],$glbvars['nmrotina'],$cddopcao)) <> '') {		
	
		exibirErro('error',$msgError,'Alerta - Ayllos','',false);
	}
  
  $cdlcremp = (isset($_POST["cdlcremp"])) ? $_POST["cdlcremp"] : 0;
  $dslcremp = (isset($_POST["dslcremp"])) ? $_POST["dslcremp"] : '';
  $dsoperac = (isset($_POST["dsoperac"])) ? $_POST["dsoperac"] : 0;
  $tplcremp = (isset($_POST["tplcremp"])) ? $_POST["tplcremp"] : 0;
  $tpdescto = (isset($_POST["tpdescto"])) ? $_POST["tpdescto"] : 0;
  $tpctrato = (isset($_POST["tpctrato"])) ? $_POST["tpctrato"] : 0;
  $nrdevias = (isset($_POST["nrdevias"])) ? $_POST["nrdevias"] : 0;
  $permingr = (isset($_POST["permingr"])) ? $_POST["permingr"] : 0;
  $flgrefin = (isset($_POST["flgrefin"])) ? $_POST["flgrefin"] : 0;
  $flgreneg = (isset($_POST["flgreneg"])) ? $_POST["flgreneg"] : 0;
  $cdusolcr = (isset($_POST["cdusolcr"])) ? $_POST["cdusolcr"] : 0;
  $flgtarif = (isset($_POST["flgtarif"])) ? $_POST["flgtarif"] : 0;
  $flgtaiof = (isset($_POST["flgtaiof"])) ? $_POST["flgtaiof"] : 0;
  $vltrfesp = (isset($_POST["vltrfesp"])) ? $_POST["vltrfesp"] : 0;
  $flgcrcta = (isset($_POST["flgcrcta"])) ? $_POST["flgcrcta"] : 0;
  $manterpo = (isset($_POST["manterpo"])) ? $_POST["manterpo"] : 0;
  $flgimpde = (isset($_POST["flgimpde"])) ? $_POST["flgimpde"] : 0;
  $dsorgrec = (isset($_POST["dsorgrec"])) ? $_POST["dsorgrec"] : 0;
  $flglispr = (isset($_POST["flglispr"])) ? $_POST["flglispr"] : 0;
  $cdmodali = (isset($_POST["cdmodali"])) ? $_POST["cdmodali"] : 0;
  $cdsubmod = (isset($_POST["cdsubmod"])) ? $_POST["cdsubmod"] : 0;
  $txjurfix = (isset($_POST["txjurfix"])) ? $_POST["txjurfix"] : 0;
  $txjurvar = (isset($_POST["txjurvar"])) ? $_POST["txjurvar"] : 0;
  $txpresta = (isset($_POST["txpresta"])) ? $_POST["txpresta"] : 0;
  $txminima = (isset($_POST["txminima"])) ? $_POST["txminima"] : 0;
  $txmaxima = (isset($_POST["txmaxima"])) ? $_POST["txmaxima"] : 0;
  $txbaspre = (isset($_POST["txbaspre"])) ? $_POST["txbaspre"] : 0;
  $nrgrplcr = (isset($_POST["nrgrplcr"])) ? $_POST["nrgrplcr"] : 0;
  $qtcarenc = (isset($_POST["qtcarenc"])) ? $_POST["qtcarenc"] : 0;
  $perjurmo = (isset($_POST["perjurmo"])) ? $_POST["perjurmo"] : 0;
  $vlmaxass = (isset($_POST["vlmaxass"])) ? $_POST["vlmaxass"] : 0;
  $consaut  = (isset($_POST["consaut"])) ? $_POST["consaut"] : 0;
  $vlmaxasj = (isset($_POST["vlmaxasj"])) ? $_POST["vlmaxasj"] : 0;
  $nrinipre = (isset($_POST["nrinipre"])) ? $_POST["nrinipre"] : 0;
  $nrfimpre = (isset($_POST["nrfimpre"])) ? $_POST["nrfimpre"] : 0;
  $qtdcasas = (isset($_POST["qtdcasas"])) ? $_POST["qtdcasas"] : 0;
  $qtrecpro = (isset($_POST["qtrecpro"])) ? $_POST["qtrecpro"] : 0;
  $flgdisap = (isset($_POST["flgdisap"])) ? $_POST["flgdisap"] : 0;
  $flgcobmu = (isset($_POST["flgcobmu"])) ? $_POST["flgcobmu"] : 0;
  $flgsegpr = (isset($_POST["flgsegpr"])) ? $_POST["flgsegpr"] : 0;
  $cdhistor = (isset($_POST["cdhistor"])) ? $_POST["cdhistor"] : 0;
  $finalidades = (isset($_POST["finalidades"])) ? $_POST["finalidades"] : '';
  $tpprodut = (isset($_POST["tpprodut"])) ? $_POST["tpprodut"] : 0;
  $cddindex = (isset($_POST["cddindex"])) ? $_POST["cddindex"] : 0;
  $vlperidx	= (isset($_POST["vlperidx"])) ? $_POST["vlperidx"] : 0;
  $tpmodcon = (isset($_POST["tpmodcon"])) ? $_POST["tpmodcon"] : 0;
    
  validaDados();
  
  $cdfinali = '';

	foreach($finalidades as $dados){

		$valores = '';

		foreach($dados as $valor){

			if($valores == ''){

				$valores = $valor;
				
			}else{
				
				$valores = $valores.'|'.$valor;
				
			}
		
		}

		if($cdfinali == ''){

			$cdfinali = $valores;

		}else{

			$cdfinali = $cdfinali.'#'.$valores;

		}

	}
  
  // Monta o xml de requisição		
	$xml  		= "";
	$xml 	   .= "<Root>";
	$xml 	   .= "  <Dados>";
	$xml 	   .= "     <cdlcremp>".$cdlcremp."</cdlcremp>";
	$xml 	   .= "     <dslcremp>".$dslcremp."</dslcremp>";
  $xml 	   .= "     <dsoperac>".$dsoperac."</dsoperac>";
  $xml 	   .= "     <tplcremp>".$tplcremp."</tplcremp>";
  $xml 	   .= "     <tpdescto>".$tpdescto."</tpdescto>";
  $xml 	   .= "     <tpctrato>".$tpctrato."</tpctrato>";
  $xml 	   .= "     <nrdevias>".$nrdevias."</nrdevias>";
  $xml 	   .= "     <flgrefin>".$flgrefin."</flgrefin>";
  $xml 	   .= "     <flgreneg>".$flgreneg."</flgreneg>";
  $xml 	   .= "     <cdusolcr>".$cdusolcr."</cdusolcr>";
  $xml 	   .= "     <flgtarif>".$flgtarif."</flgtarif>";
  $xml 	   .= "     <flgtaiof>".$flgtaiof."</flgtaiof>";
  $xml 	   .= "     <vltrfesp>".$vltrfesp."</vltrfesp>";
  $xml 	   .= "     <flgcrcta>".$flgcrcta."</flgcrcta>";
  $xml 	   .= "     <manterpo>".$manterpo."</manterpo>";
  $xml 	   .= "     <flgimpde>".$flgimpde."</flgimpde>";
  $xml 	   .= "     <dsorgrec>".$dsorgrec."</dsorgrec>";
  $xml 	   .= "     <flglispr>".$flglispr."</flglispr>";
  $xml 	   .= "     <cdmodali>".$cdmodali."</cdmodali>";
  $xml 	   .= "     <cdsubmod>".$cdsubmod."</cdsubmod>";
  $xml 	   .= "     <txjurfix>".$txjurfix."</txjurfix>";
  $xml 	   .= "     <txjurvar>".$txjurvar."</txjurvar>";
  $xml 	   .= "     <txpresta>".$txpresta."</txpresta>";
  $xml 	   .= "     <txminima>".$txminima."</txminima>";
  $xml 	   .= "     <txmaxima>".$txmaxima."</txmaxima>";
  $xml 	   .= "     <txbaspre>".$txbaspre."</txbaspre>";
  $xml 	   .= "     <nrgrplcr>".$nrgrplcr."</nrgrplcr>";
  $xml 	   .= "     <qtcarenc>".$qtcarenc."</qtcarenc>";
  $xml 	   .= "     <perjurmo>".$perjurmo."</perjurmo>";
  $xml 	   .= "     <vlmaxass>".$vlmaxass."</vlmaxass>";
  $xml 	   .= "     <consaut>".$consaut ."</consaut>";
  $xml 	   .= "     <vlmaxasj>".$vlmaxasj."</vlmaxasj>";
  $xml 	   .= "     <nrinipre>".$nrinipre."</nrinipre>";
  $xml 	   .= "     <nrfimpre>".$nrfimpre."</nrfimpre>";
  $xml 	   .= "     <qtdcasas>".$qtdcasas."</qtdcasas>";
  $xml 	   .= "     <qtrecpro>".$qtrecpro."</qtrecpro>";
  $xml 	   .= "     <flgdisap>".$flgdisap."</flgdisap>";
  $xml 	   .= "     <flgcobmu>".$flgcobmu."</flgcobmu>";
  $xml 	   .= "     <flgsegpr>".$flgsegpr."</flgsegpr>";
  $xml 	   .= "     <cdhistor>".$cdhistor."</cdhistor>";
  $xml 	   .= "     <cdfinali>".$cdfinali."</cdfinali>";
  $xml 	   .= "     <tpprodut>".$tpprodut."</tpprodut>";
  $xml 	   .= "     <cddindex>".$cddindex."</cddindex>";
  $xml 	   .= "     <permingr>".$permingr."</permingr>";
  $xml 	   .= "     <vlperidx>".$vlperidx."</vlperidx>";
  $xml 	   .= "     <tpmodcon>".$tpmodcon."</tpmodcon>";
	$xml 	   .= "  </Dados>";
	$xml 	   .= "</Root>";
	
	// Executa script para envio do XML	
	$xmlResult = mensageria($xml, "TELA_LCREDI", "INCLINHA", $glbvars["cdcooper"], $glbvars["cdagenci"], $glbvars["nrdcaixa"], $glbvars["idorigem"], $glbvars["cdoperad"], "</Root>");
	$xmlObj = getObjectXML($xmlResult);
	
	// Se ocorrer um erro, mostra crítica
	if (strtoupper($xmlObj->roottag->tags[0]->name) == "ERRO") {
	
		$msgErro = $xmlObjMotivos->roottag->tags[0]->tags[0]->tags[4]->cdata;
    $nmdcampo = $xmlObj->roottag->tags[0]->attributes["NMDCAMPO"];	
		
		if(empty ($nmdcampo)){ 
			$nmdcampo = "dslcremp";
		}
		
		if($msgErro == null || $msgErro == ''){
			$msgErro = $xmlObj->roottag->tags[0]->tags[0]->tags[4]->cdata;
		}  
            
    exibirErro('error',$msgErro,'Alerta - Ayllos','formataFormularioConsulta(); focaCampoErro(\''.$nmdcampo.'\',\'frmConsulta\');',false);		
					
	}else {
     
     exibirErro('inform','Linha de cr&eacute;dito incluida com sucesso.','Alerta - Ayllos','$(\'#btVoltar\',\'#divBotoesConsulta\').click();', false);      
  }
		
		
	function validaDados(){
			
		IF($GLOBALS["cdlcremp"] == 0 ){ 
			exibirErro('error','Linha de cr&eacute;dito inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'dslcremp\',\'frmConsulta\');',false);
		}
   
		IF($GLOBALS["dslcremp"] == '' ){ 
			exibirErro('error','Descri&ccedil;&atilde;o da linha de cr&eacute;dito inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'dslcremp\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["tplcremp"] != 1 && $GLOBALS["tplcremp"] != 2){ 
			exibirErro('error','Tipo inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'tplcremp\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["tpdescto"] != 1 && $GLOBALS["tpdescto"] != 2){ 
			exibirErro('error','Tipo inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'tpdescto\',\'frmConsulta\');',false);
		}
   
    IF($GLOBALS["tpctrato"] != 1 && $GLOBALS["tpctrato"] != 2 && $GLOBALS["tpctrato"] != 3 && $GLOBALS["tpctrato"] != 4){ 
			exibirErro('error','Modelo de contrato inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'tpctrato\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["nrdevias"] == 0){ 
			exibirErro('error','N&uacute;mero de vias inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'nrdevias\',\'frmConsulta\');',false);
		}
    
	IF(($GLOBALS["permingr"] < 0.01 && $GLOBALS["tpctrato"] == 4) || $GLOBALS["permingr"] > 300){ 
			exibirErro('error','% M&iacute;nimo Garantia inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'permingr\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["cdusolcr"] != 0 && $GLOBALS["cdusolcr"] != 1 && $GLOBALS["cdusolcr"] != 2){ 
			exibirErro('error','C&oacute;digo inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'cdusolcr\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["cdmodali"] == ''){ 
			exibirErro('error','C&oacute;digo da modalidade inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'cdmodali\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["cdsubmod"] == ''){ 
			exibirErro('error','C&oacute;digo da submodalidade inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'cdsubmod\',\'frmConsulta\');',false);
		}

    // Se for Pos-Fixado e Taxa Variavel nao for maior que zero
    IF($GLOBALS["tpprodut"] == 2 && $GLOBALS["txjurvar"] <= 0) {
        exibirErro('error','Taxa inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'txjurvar\',\'frmConsulta\');',false);
    }

    IF($GLOBALS["nrinipre"] == 0){ 
			exibirErro('error','Valor inv&aacute;lido','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'nrinipre\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["nrfimpre"] == 0 || $GLOBALS["nrfimpre"] > 240){ 
			exibirErro('error','Valor inv&aacute;lido.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'nrfimpre\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["qtdcasas"] == 0 || $GLOBALS["qtdcasas"] > 6){ 
			exibirErro('error','Quantidade de casas decimais inv&aacute;lida.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'qtdcasas\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["nrinipre"] > $GLOBALS["nrfimpre"]){ 
			exibirErro('error','Valor inicial da presta&ccedil;&atilde;o deve menor que o final.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'nrinipre\',\'frmConsulta\');',false);
		}
    
    IF($GLOBALS["tpdescto"] == 2 && $GLOBALS["nrfimpre"] > 99){ 
			exibirErro('error','Permitido informar no maximo 99 parcelas para Linhas com Desconto em Folha.','Alerta - Ayllos','formataFormularioConsulta();focaCampoErro(\'nrfimpre\',\'frmConsulta\');',false);
		}
    
    
	}	
  
 ?>
