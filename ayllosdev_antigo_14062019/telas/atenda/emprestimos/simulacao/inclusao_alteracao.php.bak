<?php

/* !
 * FONTE        : inclusao_alteracao.php
 * CRIAÇÃO      : Marcelo L. Pereira (GATI)
 * DATA CRIAÇÃO : 27/06/2011
 * OBJETIVO     : Executa os processos da rotina filha de Simulações da rotina de Empréstimos 

  ALTERACOES   :  04/08/2014 -  Ajustes referentes ao projeto CET (Lucas R./Gielow)
 *                30/06/2015 - Ajustes referentes Projeto 215 - DV 3 (Daniel)
 *                20/09/2017 - Projeto 410 - Incluir campo Indicador de financiamento do IOF (Diogo - Mouts)
 *                13/12/2018 - Projeto 298 - Inclusos novos campos tpemprst e campos de carencia (Andre Clemer - Supero)
 * 				  28/02/2018 - Alterado para buscar os dados na mensageria Oracle (P438 Douglas Pagel / AMcom) 
 * 				  03/2018 - Ajustes para inclusa e alteracao de simulacoes do consignado (P437 JDB / AMcom) 
 * */

session_start();
require_once('../../../../includes/config.php');
require_once('../../../../includes/funcoes.php');
require_once('../../../../includes/controla_secao.php');
require_once('../../../../class/xmlfile.php');
require_once('../wssoa.php');

isPostMethod();

// Guardo os parâmetos do POST em variáveis	
$operacao = (isset($_POST['operacao'])) ? $_POST['operacao'] : '';
$gconsig = (isset($_POST['gconsig'])) ? $_POST['gconsig'] : '';
$vlparepr = '';
$vliofepr = '';
$vlrcet = '';
$jurosAnual = '';
$nrdconta = (isset($_POST['nrdconta'])) ? $_POST['nrdconta'] : '';
$idseqttl = (isset($_POST['idseqttl'])) ? $_POST['idseqttl'] : '';
$nrsimula = (isset($_POST['nrsimula'])) ? $_POST['nrsimula'] : '';
$cdlcremp = (isset($_POST['cdlcremp'])) ? $_POST['cdlcremp'] : '';
$vlemprst = (isset($_POST['vlemprst'])) ? $_POST['vlemprst'] : '';
$qtparepr = (isset($_POST['qtparepr'])) ? $_POST['qtparepr'] : '';
$dtlibera = (isset($_POST['dtlibera'])) ? $_POST['dtlibera'] : '';
$dtdpagto = (isset($_POST['dtdpagto'])) ? $_POST['dtdpagto'] : '';
//$percetop = (isset($_POST['percetop'])) ? $_POST['percetop'] : '';
$percetop = '';
$cdfinemp = (isset($_POST['cdfinemp'])) ? $_POST['cdfinemp'] : '';
$idfiniof = (isset($_POST['idfiniof'])) ? $_POST['idfiniof'] : '1';
$tpemprst = (isset($_POST['tpemprst'])) ? $_POST['tpemprst'] : '';
$idcarenc = (isset($_POST['idcarenc'])) ? $_POST['idcarenc'] : '';
$dtcarenc = (isset($_POST['dtcarenc'])) ? $_POST['dtcarenc'] : '';
$cddopcao = (($operacao == "A_SIMULACAO") ? "A" : "I");

if (($msgError = validaPermissao($glbvars['nmdatela'], $glbvars['nmrotina'], $cddopcao)) <> '') {
    exibirErro('error', $msgError, 'Alerta - Aimaro', '', false);
}

//se consignado busca valor de parcela e iof consumir soa exemplo tela manbem
if ($gconsig == '1'){		
		//Busca XML BD converte em json e comunica com a FIS	
		$xml  = '';
		$xml .= '<Root>';
		$xml .= '	<dto>';
		$xml .= '       <cdlcremp>'.$cdlcremp.'</cdlcremp>';
		$xml .= '       <vlemprst>'.$vlemprst.'</vlemprst>';
		$xml .= '       <nrdconta>'.$nrdconta.'</nrdconta>';
		$xml .= '       <fintaxas>'.$idfiniof.'</fintaxas>';
		$xml .= '       <quantidadeparcelas>'.$qtparepr.'</quantidadeparcelas>';
		$xml .= '       <dataprimeiraparcela>'.$dtdpagto.'</dataprimeiraparcela>';
		$xml .= '	</dto>';
		$xml .= '</Root>';
		
		$xmlResult = mensageria(
			$xml,
			"TELA_ATENDA_SIMULACAO",
			"SIMULA_BUSCA_DADOS_CALC_FIS",
			$glbvars["cdcooper"],
			$glbvars["cdagenci"],
			$glbvars["nrdcaixa"],
			$glbvars["idorigem"],
			$glbvars["cdoperad"],
			"</Root>");

		$xmlObj = getObjectXML($xmlResult);

		if ( strtoupper($xmlObj->roottag->tags[0]->name) == "ERRO" ) {
			gravaLog("Erro gerando o xml com dados.",$xmlObj->roottag->tags[0]->tags[0]->tags[4]->cdata,$nrdconta,$glbvars,'1','2');
		}else{	
			$xml = simplexml_load_string($xmlResult);
			$json = json_encode($xml);
			//echo "cttc('".$json."');";
			$rs = chamaServico($json,$Url_SOA, $Auth_SOA);
			//echo "cttc('".$rs."');";
			
			if (isset($rs->msg)){
				gravaLog("Retorno erro tratado pela fis.",$rs->msg,$nrdconta,$glbvars,$json,json_encode($rs));				
			}else if (isset($rs->errorMessage)){
				gravaLog("Retorno erro nao tratado pela fis.",$rs->errorMessage,$nrdconta,$glbvars,'1','2');					
			}			
			else if (isset($rs->parcela->valor) && isset($rs->sistemaTransacao->dataHoraRetorno)){
				if ($rs->parcela->valor > 0 && $rs->sistemaTransacao->dataHoraRetorno != ""){
					$vlparepr = $rs->parcela->valor;
					$vliofepr = $rs->credito->tributoIOFValor;
					$vlrcet = $rs->credito->CETPercentAoAno;	
					$jurosAnual = $rs->credito->taxaJurosRemuneratoriosAnual;
				}else{
					gravaLog("Retorno erro nao tratado pela fis.","valores de retorno em branco",$nrdconta,$glbvars,'1','2');
				}
			}
			
		}
}

// Monta o xml de requisição
$xml = "";
$xml.= "<Root>";
$xml.= "	<Dados>";
$xml.= "		<nrdconta>" . $nrdconta . "</nrdconta>";
$xml.= "		<idseqttl>" . $idseqttl . "</idseqttl>";
$xml .= "		<dtmvtolt>" . $glbvars["dtmvtolt"] . "</dtmvtolt>";
$xml .= "		<cddopcao>" . $cddopcao . "</cddopcao>";
$xml.= "		<nrsimula>" . $nrsimula . "</nrsimula>";
$xml.= "		<cdlcremp>" . $cdlcremp . "</cdlcremp>";
$xml.= "		<vlemprst>" . str_replace(",", ".",str_replace(".","",$vlemprst)) . "</vlemprst>";
$xml.= "		<qtparepr>" . $qtparepr . "</qtparepr>";
$xml.= "		<dtlibera>" . $dtlibera . "</dtlibera>";
$xml.= "		<dtdpagto>" . $dtdpagto . "</dtdpagto>";
$xml.= "        <percetop>" . $percetop . "</percetop>";
$xml.= "        <cdfinemp>" . $cdfinemp . "</cdfinemp>";
$xml.= "        <idfiniof>" . $idfiniof . "</idfiniof>";
$xml.= "        <flggrava>1</flggrava>";
$xml.= "        <idpessoa>0</idpessoa>";
$xml.= "        <nrseq_email>0</nrseq_email>";
$xml.= "        <nrseq_telefone>0</nrseq_telefone>";
$xml.= "        <idsegmento>0</idsegmento>";
$xml.= "        <tpemprst>" . $tpemprst . "</tpemprst>";
$xml.= "        <idcarenc>" . $idcarenc . "</idcarenc>";
$xml.= "        <dtcarenc>" . $dtcarenc . "</dtcarenc>";
$xml .= "		<flgerlog>1</flgerlog>";
$xml .= "		<vlparepr>".$vlparepr."</vlparepr>";
$xml .= "		<vliofepr>".$vliofepr."</vliofepr>";
$xml.= "		<vlcapint>0</vlcapint>";
$xml.= "        <tpgarope></tpgarope>"; 
$xml.= "	</Dados>";
$xml.= "</Root>";


// Executa script para envio do XML
$xmlResult = mensageria($xml, "TELA_ATENDA_SIMULACAO", "SIMULA_GRAVA_SIMULACAO", $glbvars["cdcooper"], $glbvars["cdagenci"], $glbvars["nrdcaixa"], $glbvars["idorigem"], $glbvars["cdoperad"], "</Root>");
// Cria objeto para classe de tratamento de XML
$xmlObj = getObjectXML($xmlResult);

// Obtém número da simulação gravada
$nrgravad = getByTagName($xmlObj->roottag->tags,'NRGRAVAD');
//$nrgravad = $xmlObj->roottag->tags[0]->attributes["NRGRAVAD"];
//$txcetano = $xmlObj->roottag->tags[0]->attributes['TXCETANO'];
$txcetano = getByTagName($xmlObj->roottag->tags,'TXCETANO');


//$vliofepr = $xmlObj->roottag->tags[0]->attributes['TXCETANO'];
//$vlrtarif = $xmlObj->roottag->tags[0]->attributes['TXCETANO'];
//$vlrtotal = $xmlObj->roottag->tags[0]->attributes['TXCETANO'];
//$vliofepr = '0';
//$vlrtarif = '0';
//$vlrtotal = '0';
/*
if ($vlrcet == ''){
	echo "$('#percetop','#frmSimulacao').val('" . $txcetano . "');";
}else{
	echo "$('#percetop','#frmSimulacao').val('" . $vlrcet . "');";
}
echo "$('#vliofepr','#frmSimulacao').val('" . $vliofepr . "');";
echo "$('#vlrtarif','#frmSimulacao').val('" . $vlrtarif . "');";
echo "$('#vlrtotal','#frmSimulacao').val('" . $vlrtotal . "');";
*/
//echo "cttc('".$vliofepr."');";

if (strtoupper($xmlObj->roottag->tags[0]->name) == 'ERRO') {
    echo 'hideMsgAguardo();';
    echo 'showError("error","' . $xmlObj->roottag->tags[0]->tags[0]->tags[4]->cdata . '","Alerta - Aimaro","blockBackground(parseInt($(\'#divRotina\').css(\'z-index\')))");';
} else {

    if ($operacao == "I_SIMULACAO") {
        echo "controlaOperacaoSimulacoes('C_INCLUSAO'," . $nrgravad . ");";
    } else {
        echo "mostraTabelaSimulacao('TS');";
    }
}


?>