declare
  vr_nrctrseg   cecred.crawseg.nrctrseg%TYPE;
  vr_nrproposta cecred.crawseg.nrproposta%TYPE;
  vr_exc_saida  EXCEPTION;
  vr_nrseqdig   NUMERIC(15);
  vr_nrsequen   NUMBER(10);
  vr_dtrefere   DATE;
  vr_nmdir      VARCHAR2(4000) := CECRED.gene0001.fn_param_sistema('CRED',3,'ROOT_MICROS')||'cpd/bacas/INC0270109';
  vr_nmarq      VARCHAR2(100)  := 'ROLLBACK_INC0270109.sql';
  vr_ind_arq    utl_file.file_type;
  vr_linha      VARCHAR2(32767);
  vr_dscritic   VARCHAR2(2000);
  vr_nrseguro   cecred.tbseg_prestamista.nrctrseg%TYPE;

  CURSOR cr_crawseg IS
    SELECT w.* 
      FROM CECRED.crawseg W,
           cecred.crapepr e
     WHERE w.cdcooper = e.cdcooper
       AND w.nrdconta = e.nrdconta
       AND w.nrctrato = e.nrctremp
       AND e.vlsdeved > 0
       AND e.inliquid = 0 
       AND nrproposta IN ('770573711963','770350220607','770349686023',
                          '770357416060',
                          '770657475750',
                          '770349026694',
                          '770350246835',
                          '770349193892',
                          '770357409837',
                          '770349306239',
                          '770657532312',
                          '770573655303',
                          '770613182403',
                          '770349494299',
                          '770350094032',
                          '770353822799',
                          '770350206930',
                          '770355157440',
                          '770613464816',
                          '770351205865',
                          '770355812383',
                          '770353405497',
                          '770657503959',
                          '770354612054',
                          '770353660950',
                          '770354497263',
                          '770613598278',
                          '770573610997',
                          '770350486577',
                          '770357218012',
                          '770349057727',
                          '770355063062',
                          '770349225280',
                          '770573323823',
                          '770354700077',
                          '770573324005',
                          '770353148001',
                          '770613224670',
                          '770353653687',
                          '770573385217',
                          '770354616408',
                          '770353958780',
                          '770572881091',
                          '770572926184',
                          '770354736110',
                          '770354668246',
                          '770358101798',
                          '770573307909',
                          '770358800777',
                          '770359201060',
                          '770359416555',
                          '770573358333',
                          '770613690310',
                          '770613597042',
                          '770349243580',
                          '770349249367',
                          '770354209675',
                          '770349642964',
                          '770359678231',
                          '770350363653',
                          '770356740297',
                          '770350382500',
                          '770351374586',
                          '770350535535',
                          '770351372621',
                          '770657296511',
                          '770351490942',
                          '770351912847',
                          '770352127590',
                          '770353928163',
                          '770573201728',
                          '770613701800',
                          '770354535971',
                          '770354938405',
                          '770573513975',
                          '770355334031',
                          '770355969169',
                          '770358360882',
                          '770349642980',
                          '770351510692',
                          '770349214660',
                          '770350241884',
                          '770349285886',
                          '770350257268',
                          '770354516519',
                          '770358656048',
                          '770349314258',
                          '770358916074',
                          '770349642930',
                          '770357125944',
                          '770349930234',
                          '770357829380',
                          '770349642948',
                          '770356893611',
                          '770349642956',
                          '770356672623',
                          '770354948010',
                          '770349642999',
                          '770573022742',
                          '770573681770',
                          '770657643017',
                          '770358393004',
                          '770613124080',
                          '770354206072',
                          '770349314274',
                          '770350176756',
                          '770349911477',
                          '770357345243',
                          '770573520491',
                          '770350256032',
                          '770356664400',
                          '770351047526',
                          '770353450913',
                          '770573611420',
                          '770573611446',
                          '770354280604',
                          '770358052010',
                          '770355079988',
                          '770358981259',
                          '770359444460',
                          '770356018370',
                          '770356083857',
                          '770613579133',
                          '770613668403',
                          '770356996070',
                          '770573552571',
                          '770613011692',
                          '770613148302',
                          '770573094832',
                          '770573789008',
                          '770573270541',
                          '770573456076',
                          '770573570103',
                          '770573725298',                          
                          '770349232090', 
                          '770657727725',
                          '770356737709',
                          '770573772938',
                          '770573589637',
                          '770357790905',
                          '770349255090',
                          '770359753381',
                          '770349232383',
                          '770354947137',
                          '770573329490',
                          '770655956590',
                          '770656008407',
                          '770349246392',
                          '770351690232',
                          '770349225549',
                          '770356190491',
                          '770657223387',
                          '770349148153',
                          '770358477593',
                          '770356939158',
                          '770356697944',
                          '770355917363',
                          '770573794265',
                          '770357092760',
                          '770613684824',
                          '770573121716',
                          '770573161270',
                          '770655772138',
                          '770349283280',
                          '770349210207',
                          '770349235773',
                          '770349295172',
                          '770613486216',
                          '770613063595',
                          '770354746522',
                          '770359957637',
                          '770351064455',
                          '770573348052',
                          '770655943889',
                          '770351876603',
                          '770349167387',
                          '770349095475',
                          '770353531549',
                          '770350856072',
                          '770350246959',
                          '770351379146',
                          '770656261382',
                          '770349203340',
                          '770349148021',
                          '770658298135',
                          '770658469568',
                          '770657887609',
                          '770658453963',
                          '770572850641',
                          '770657323233',
                          '770352452785',
                          '770349194775',
                          '770351121858',
                          '770354092174',
                          '770358308333',
                          '770613492038',
                          '770656336587',
                          '770352531413',
                          '770351410094',
                          '770658274295',
                          '770351626127',
                          '770352698679',
                          '770351912901',
                          '770350925856',
                          '770349296519',
                          '770356438175',
                          '770572946592',
                          '770355692949',
                          '770573606086',
                          '770350607005',
                          '770349195828',
                          '770349205068',
                          '770349182157',
                          '770349182165',
                          '770658326716',
                          '770349203014',
                          '770354502321',
                          '770350821031',
                          '770612937370',
                          '770352200751',
                          '770613394680',
                          '770613492828',
                          '770658222490',
                          '770351152265',
                          '770351844884',
                          '770656219831',
                          '770349202360',
                          '770350512063',
                          '770573760093',
                          '770356596269',
                          '770349479222',
                          '770351032766',
                          '770349352125',
                          '770657713490',
                          '770351852925',
                          '770351578793',
                          '770351659025',
                          '770349613042',
                          '770349631083',
                          '770612838445',
                          '770357867215',
                          '770573755030',
                          '770657394351',
                          '770349444640',
                          '770354935228',
                          '770356770951',
                          '770349433141',
                          '770354414937',
                          '770356729196',
                          '770356181468',
                          '770354526000',
                          '770354799863',
                          '770359975520',
                          '770655890572',
                          '770358796770',
                          '770573798864',
                          '770613012370',
                          '770351625007',
                          '770657484644',
                          '770354298864',
                          '770349417987',
                          '770355497933',
                          '770354966158',
                          '770349358972',
                          '770349366851',
                          '770350451560',
                          '770358234160',
                          '770657969460',
                          '770357172870',
                          '770573467590',
                          '770573352092',
                          '770572986322',
                          '770573681410',
                          '770573213173',
                          '770573146166',
                          '770573538803',
                          '770657514357',
                          '770350571019',
                          '770613009787',
                          '770349393107',
                          '770349403420',
                          '770350858458',
                          '770354779315',
                          '770349222680',
                          '770350321403',
                          '770572893871',
                          '770359567162',
                          '770349381583',
                          '770359242638',
                          '770350501606',
                          '770355751627',
                          '770355863352',
                          '770349351722',
                          '770349410443',
                          '770350919562',
                          '770352179426',
                          '770573036999',
                          '770358782329',
                          '770353150596',
                          '770573207769',
                          '770613141855',
                          '770352606774',
                          '770655848274',
                          '770351812176',
                          '770613128182',
                          '770573606310',
                          '770656008636',
                          '770655944559',
                          '770349225107',
                          '770573519477',
                          '770657539279',
                          '770349394707',
                          '770352497878',
                          '770352302040',
                          '770573506510',
                          '770349572249',
                          '770359070314',
                          '770359253800',
                          '770356263790',
                          '770613335129',
                          '770349614863',
                          '770612797889',
                          '770349650169',
                          '770655754474',
                          '770658267027',
                          '770573209060',
                          '770613272291',
                          '770573014448',
                          '770658288164',
                          '770349959860',
                          '770354503891',
                          '770349957701',
                          '770657532231',
                          '770349609045',
                          '770658081314',
                          '770349630079',
                          '770351193859',
                          '770355092712',
                          '770350195491',
                          '770658489518',
                          '770573271653',
                          '770573653432',
                          '770351810378',
                          '770658540041',
                          '770351298162',
                          '770658422308',
                          '770655707751',
                          '770351082526',
                          '770573409027',
                          '770356544099',
                          '770352186961',
                          '770657193399',
                          '770349633256',
                          '770357904986',
                          '770657931730',
                          '770657987182',
                          '770355605183',
                          '770655890513',
                          '770354738589',
                          '770572969983',
                          '770349626020',
                          '770356266749',
                          '770657609447',
                          '770657789070',
                          '770658217763',
                          '770349967545',
                          '770350518878',
                          '770655754245',
                          '770351390352',
                          '770349972050',
                          '770573274156',
                          '770350182632',
                          '770357543843',
                          '770657752193',
                          '770353547313',
                          '770349300265',
                          '770349251124',
                          '770612935670',
                          '770350129189',
                          '770349212242',
                          '770354673347',
                          '770349220199',
                          '770349257351',
                          '770349312239',
                          '770349286637',
                          '770351514361',
                          '770350422544',
                          '770353377949',
                          '770573394232',
                          '770349244187',
                          '770355722767',
                          '770656151226',
                          '770349314690',
                          '770351225734',
                          '770349283034',
                          '770349283050',
                          '770359855974',
                          '770349228335',
                          '770349274817',
                          '770349274809',
                          '770655881212',
                          '770655944273',
                          '770351579595',
                          '770349197081',
                          '770356986814',
                          '770349261260',
                          '770657743151',
                          '770658142356',
                          '770349945401',
                          '770355337987',
                          '770613185186',
                          '770354368013',
                          '770354435136',
                          '770358225764',
                          '770359770936',
                          '770358345654',
                          '770357357993',
                          '770357477549',
                          '770359064047',
                          '770351875216',
                          '770351969644',
                          '770573137108',
                          '770573146638',
                          '770349273330',
                          '770351514779',
                          '770573519710',
                          '770349452995',
                          '770352261998',
                          '770349345382',
                          '770355272559',
                          '770354766531',
                          '770658172590',
                          '770658171577',
                          '770356700562',
                          '770356469186',
                          '770357137128',
                          '770357391105',
                          '770351849436',
                          '770349969424',
                          '770657987298',
                          '770349629240',
                          '770356652118',
                          '770349474620',
                          '770612826471',
                          '770612894353',
                          '770349614219',
                          '770655890718',
                          '770358884571',
                          '770573520890',
                          '770358336922',
                          '770351485728',
                          '770572942953',
                          '770359388543',
                          '770612827079',
                          '770359816030',
                          '770573221109',
                          '770356215311',
                          '770349258188',
                          '770359204523',
                          '770358290817',
                          '770357377609',
                          '770613127305',
                          '770351924195',
                          '770354795906',
                          '770657788791',
                          '770349283204',
                          '770349405555',
                          '770359160070',
                          '770359416326',
                          '770358827527',
                          '770352131466',
                          '770613078398',
                          '770349193825',
                          '770351369140',
                          '770351369175',
                          '770350920617',
                          '770349362082',
                          '770349225808',
                          '770657737283',
                          '770354557886',
                          '770657921580',
                          '770658292668',
                          '770349220385',
                          '770655996788',
                          '770349272334',
                          '770350438181',
                          '770349465728',
                          '770355405249',
                          '770351557621',
                          '770658349600',
                          '770657527050',
                          '770573807812',
                          '770658249614',
                          '770359070870',
                          '770573143973',
                          '770613001581',
                          '770656188227',
                          '770612878340',
                          '770573305019',
                          '770613665331',
                          '770349318130',
                          '770573487737',
                          '770655944346',
                          '770573198506',
                          '770572880923',
                          '770573417640',
                          '770351705361',
                          '770351291460',
                          '770349221926',
                          '770612795860',
                          '770572872556',
                          '770656384611',
                          '770357493005',
                          '770355107680',
                          '770356798686',
                          '770655819274',
                          '770350545190',
                          '770358615937',
                          '770357076978',
                          '770572865126',
                          '770352218952',
                          '770349261103',
                          '770354552108',
                          '770573282809',
                          '770613050485',
                          '770350713883',
                          '770354312409',
                          '770357856329',
                          '770351505389',
                          '770359713916',
                          '770572876420',
                          '770656228504',
                          '770350144056',
                          '770352050792',
                          '770352817384',
                          '770349246171',
                          '770349097222',
                          '770351080876',
                          '770349296802',
                          '770355617157',
                          '770353191519',
                          '770358884288',
                          '770573146158',
                          '770613238565',
                          '770356611047',
                          '770356012917',
                          '770657938386',
                          '770573601793',
                          '770350330003',
                          '770658524178',
                          '770349284197',
                          '770351480190',
                          '770658105922',
                          '770573301498',
                          '770349287927',
                          '770352053643',
                          '770349236540',
                          '770655695869',
                          '770354290057',
                          '770351535890',
                          '770613059954',
                          '770349456508',
                          '770350491120',
                          '770356595998',
                          '770359002491',
                          '770573255313',
                          '770349245272',
                          '770349351420',
                          '770349351439',
                          '770349241978',
                          '770573030060',
                          '770573375165',
                          '770354509997',
                          '770354936682',
                          '770573095383',
                          '770573725484',
                          '770572985857',
                          '770352180203',
                          '770352802107',
                          '770353335235',
                          '770353386174',
                          '770613141456',
                          '770359800916',
                          '770359235542',
                          '770354998807',
                          '770573214684',
                          '770573531540',
                          '770349439972',
                          '770657497177',
                          '770357477182',
                          '770572981150',
                          '770351714379',
                          '770356127927',
                          '770349009064',
                          '770358459951',
                          '770349270196',
                          '770351154217',
                          '770613368566',
                          '770353732030',
                          '770613066993',
                          '770573006828',
                          '770349421836',
                          '770573812581',
                          '770658372106',
                          '770351515449',
                          '770351356600',
                          '770354372886',
                          '770349279606',
                          '770350342770',
                          '770351521139',
                          '770351134534',
                          '770355158209',
                          '770573011848',
                          '770359717865',
                          '770656240547',
                          '770349387018',
                          '770351486325',
                          '770349436116',
                          '770613229124',
                          '770357336880',
                          '770354139073',
                          '770352205737',
                          '770351202092',
                          '770351824913',
                          '770354680831',
                          '770351849657',
                          '770349355035',
                          '770349443228',
                          '770655956697',
                          '770573677200',
                          '770349297981',
                          '770351734868',
                          '770357013887',
                          '770351443731',
                          '770358904653',
                          '770656101091',
                          '770359975252',
                          '770356038010',
                          '770655771743',
                          '770573645561',
                          '770349388502',
                          '770356380134',
                          '770655721096',
                          '770351179961',
                          '770573456343',
                          '770349249413',
                          '770613645314',
                          '770349260336',
                          '770613161210',
                          '770359800509',
                          '770657811556',
                          '770351873680',
                          '770351999640',
                          '770349295482',
                          '770349572184',
                          '770613499148',
                          '770349189577',
                          '770573678907',
                          '770573653521',
                          '770657964573',
                          '770573364619',
                          '770656007290',
                          '770573802055',
                          '770572891828',
                          '770349605945',
                          '770349482754',
                          '770351559543',
                          '770349440997',
                          '770349209756',
                          '770658047396',
                          '770349959402',
                          '770573777719',
                          '770349590751',
                          '770349596954',
                          '770350185658',
                          '770357801206',
                          '770353545760',
                          '770349031477',
                          '770351093706',
                          '770349587386',
                          '770658026968',
                          '770349598833',
                          '770349560054',
                          '770573242190',
                          '770349560801',
                          '770656002557',
                          '770349593734',
                          '770349506882',
                          '770350431764',
                          '770358228860',
                          '770658476017',
                          '770351146826',
                          '770358502792',
                          '770353083040',
                          '770657948829',
                          '770351625074',
                          '770357144167',
                          '770358048978',
                          '770356620305',
                          '770349549336',
                          '770349549344',
                          '770355141608',
                          '770349569841',
                          '770352499056',
                          '770349560003',
                          '770354902290',
                          '770658249100',
                          '770657422665',
                          '770358665870',
                          '770358554440',
                          '770657266043',
                          '770356490908',
                          '770350906673',
                          '770349566150',
                          '770350360484',
                          '770350096922',
                          '770352262021',
                          '770357640504',
                          '770356329503',
                          '770356579925',
                          '770356214935',
                          '770572986365',
                          '770573118065',
                          '770613127534',
                          '770657571792',
                          '770657319341',
                          '770658596403',
                          '770658332961',
                          '770351557001',
                          '770352627070',
                          '770658025457',
                          '770573304063',
                          '770572887740',
                          '770358281400',
                          '770613548882',
                          '770349565110',
                          '770655819118',
                          '770357898242',
                          '770613561196',
                          '770349561719',
                          '770349503476',
                          '770658326015',
                          '770573315049',
                          '770358605826',
                          '770356705220',
                          '770349549018',
                          '770658245708',
                          '770354147904',
                          '770349496194',
                          '770573762231',
                          '770658058576',
                          '770349497239',
                          '770349562685',
                          '770658410440',
                          '770573524306',
                          '770351204575',
                          '770658399268',
                          '770357298857',
                          '770573436873',
                          '770658452959',
                          '770655987754',
                          '770657103292',
                          '770349502283',
                          '770573140613',
                          '770573372166',
                          '770349509423',
                          '770349509431',
                          '770349509440',
                          '770350227318',
                          '770351576456',
                          '770656181249',
                          '770613400680',
                          '770359487495',
                          '770352721883',
                          '770656312459',
                          '770355939740',
                          '770658049070',
                          '770358412270',
                          '770573724739',
                          '770351503130',
                          '770349943611',
                          '770658157019',
                          '770358572529',
                          '770350474536',
                          '770350176489',
                          '770350128107',
                          '770350581090',
                          '770349418207',
                          '770573601440',
                          '770356694520')
  ORDER BY w.cdcooper, w.nrdconta, w.nrctrato;

  rw_crawseg cr_crawseg%ROWTYPE;
  
  CURSOR cr_crapseg(pr_cdcooper in cecred.crapseg.cdcooper%TYPE,
                    pr_nrdconta in cecred.crapseg.nrdconta%TYPE,
                    pr_nrctrseg in cecred.crapseg.nrctrseg%TYPE) IS
    SELECT * 
      FROM CECRED.crapseg s
     WHERE s.cdcooper = pr_cdcooper
       AND s.nrdconta = pr_nrdconta
       AND s.nrctrseg = pr_nrctrseg;
  rw_crapseg cr_crapseg%ROWTYPE;
  
  CURSOR cr_tbseg_prestamista(pr_cdcooper in cecred.tbseg_prestamista.cdcooper%TYPE,
                              pr_nrdconta in cecred.tbseg_prestamista.nrdconta%TYPE,
                              pr_nrctremp in cecred.tbseg_prestamista.nrctremp%TYPE,
                              pr_nrctrseg in cecred.tbseg_prestamista.nrctrseg%TYPE) IS
    SELECT * 
      FROM CECRED.tbseg_prestamista p
     WHERE p.cdcooper = pr_cdcooper
       AND p.nrdconta = pr_nrdconta
       AND p.nrctremp = pr_nrctremp
       AND p.nrctrseg = pr_nrctrseg;
  rw_tbseg_prestamista cr_tbseg_prestamista%ROWTYPE; 
  
  CURSOR cr_crappep(pr_cdcooper in cecred.crappep.cdcooper%TYPE,
                    pr_nrdconta in cecred.crappep.nrdconta%TYPE,
                    pr_nrctremp in cecred.crappep.nrctremp%TYPE) IS
                     
    SELECT MAX(dtvencto) dtfimvig 
      FROM cecred.crappep 
     WHERE cdcooper = pr_cdcooper
       AND nrdconta = pr_nrdconta 
       AND nrctremp = pr_nrctremp;   
  rw_crappep cr_crappep%ROWTYPE;   
  
  
  CURSOR cr_saldo(pr_cdcooper in cecred.crapris.cdcooper%TYPE,
                  pr_nrdconta in cecred.crapris.nrdconta%TYPE,
                  pr_nrctremp in cecred.crapris.nrctremp%TYPE,
                  pr_dtrefere in cecred.crapris.dtrefere%TYPE) IS
    SELECT SUM(j.vldivida) saldo
      FROM CECRED.crapris j,
           CECRED.crapepr e
     WHERE j.cdcooper = e.cdcooper
       AND j.nrdconta = e.nrdconta
       AND j.nrctremp = e.nrctremp
       AND j.cdcooper = pr_cdcooper
       AND j.nrdconta = pr_nrdconta
       AND j.nrctremp = pr_nrctremp
       AND j.dtrefere = pr_dtrefere;
  rw_saldo cr_saldo%ROWTYPE;  
    
  CURSOR cr_crapris(pr_cdcooper in cecred.crapris.cdcooper%TYPE,
                    pr_nrdconta in cecred.crapris.nrdconta%TYPE,
                    pr_dtrefere in cecred.crapris.dtrefere%TYPE) IS
    SELECT SUM(j.vldivida) saldo
      FROM cecred.crapris j,
           cecred.crapepr e
     WHERE j.cdcooper = e.cdcooper
       AND j.nrdconta = e.nrdconta
       AND j.nrctremp = e.nrctremp
       AND j.dtrefere = pr_dtrefere 
       AND j.cdcooper = pr_cdcooper
       AND j.nrdconta = pr_nrdconta;
  rw_crapris cr_crapris%ROWTYPE;       
 
  PROCEDURE pc_valida_direto(pr_nmdireto IN  VARCHAR2,
                             pr_dscritic OUT CECRED.crapcri.dscritic%TYPE) IS
    vr_dscritic  CECRED.crapcri.dscritic%TYPE;
    vr_typ_saida VARCHAR2(3);
    vr_des_saida VARCHAR2(1000);
    vr_exc_erro  EXCEPTION;
    
  BEGIN
    IF NOT CECRED.gene0001.fn_exis_diretorio(pr_nmdireto) THEN

      CECRED.gene0001.pc_OSCommand_Shell(pr_des_comando => 'mkdir ' || pr_nmdireto || ' 1> /dev/null',
                                         pr_typ_saida   => vr_typ_saida,
                                         pr_des_saida   => vr_des_saida);

      IF vr_typ_saida = 'ERR' THEN
        vr_dscritic := 'CRIAR DIRETORIO ARQUIVO -> Nao foi possivel criar o diretorio para gerar os arquivos. ' || vr_des_saida;
        RAISE vr_exc_erro;
      END IF;

      CECRED.gene0001.pc_OSCommand_Shell(pr_des_comando => 'chmod 777 ' || pr_nmdireto || ' 1> /dev/null',
                                         pr_typ_saida   => vr_typ_saida,
                                         pr_des_saida   => vr_des_saida);

      IF vr_typ_saida = 'ERR' THEN
        vr_dscritic := 'PERMISSAO NO DIRETORIO -> Nao foi possivel adicionar permissao no diretorio dos arquivos. ' || vr_des_saida;
        RAISE vr_exc_erro;
      END IF;
    END IF;
  EXCEPTION
    WHEN vr_exc_erro THEN
      pr_dscritic := vr_dscritic;
  END;  

BEGIN
  pc_valida_direto(pr_nmdireto => vr_nmdir,
                   pr_dscritic => vr_dscritic);

  IF TRIM(vr_dscritic) IS NOT NULL THEN
    RAISE vr_exc_saida;
  END IF;    
    
  CECRED.GENE0001.pc_abre_arquivo(pr_nmdireto => vr_nmdir,
                                  pr_nmarquiv => vr_nmarq,
                                  pr_tipabert => 'W',
                                  pr_utlfileh => vr_ind_arq,
                                  pr_des_erro => vr_dscritic);

  IF vr_dscritic IS NOT NULL THEN
    vr_dscritic := vr_dscritic ||'  Não pode abrir arquivo '|| vr_nmdir || vr_nmarq;
    RAISE vr_exc_saida;
  END IF;
      
   update cecred.crapseg    
      set cdsitseg = 2
    where cdcooper = 1
      and nrdconta = 9599835
      and nrctrseg = 1381015;
        
   update cecred.tbseg_prestamista    
      set tpregist = 0
    where nrproposta = '770349686023A01';  
	
   update tbseg_prestamista pp
	  set pp.dtrecusa = to_date('25/05/2022','dd/mm/yyyy'),
		  pp.tprecusa = 'Proposta com irregularidades.',
		  pp.cdmotrec = 143,
		  pp.situacao = 0
	where pp.cdcooper =1
	  and pp.nrdconta = 9599835
	  and pp.nrctrseg  in(375874)
	  and pp.nrproposta = '770349686023' 	

  COMMIT;

 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,'BEGIN');
 
 vr_linha := 'update cecred.crapseg set cdsitseg = 1 where cdcooper = 1 and nrdconta = 9599835 and nrctrseg = 1381015;';
 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);
   
 vr_linha := 'update cecred.tbseg_prestamista set tpregist = 3 where cdcooper = 1 and nrdconta = 9599835 and nrctremp = 2257444 and nrctrseg = 1381015;';
 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);
 
 FOR rw_crawseg IN cr_crawseg LOOP
     
   vr_nrproposta := CECRED.SEGU0003.FN_NRPROPOSTA(pr_tpcustei => rw_crawseg.tpcustei,
                                                  pr_cdcooper => rw_crawseg.cdcooper,
                                                  pr_nrdconta => rw_crawseg.nrdconta,
                                                  pr_nrctrseg => rw_crawseg.nrctrseg);
    
   cecred.pc_sequence_progress(pr_nmtabela => 'CRAPMAT'
                              ,pr_nmdcampo => 'NRCTRSEG'
                              ,pr_dsdchave => 1
                              ,pr_flgdecre => 'N'
                              ,pr_sequence => vr_nrctrseg);
                              
   OPEN cr_crappep(pr_cdcooper => rw_crawseg.cdcooper,
                   pr_nrdconta => rw_crawseg.nrdconta,
                   pr_nrctremp => rw_crawseg.nrctrato);
   FETCH cr_crappep INTO rw_crappep;
   CLOSE cr_crappep;
   
   IF rw_crawseg.nrproposta = '770573711963' THEN
     vr_dtrefere := TO_DATE('28/02/2023','DD/MM/RRRR');    
   ELSIF rw_crawseg.nrproposta = '770349686023' THEN
     vr_dtrefere := TO_DATE('30/04/2023','DD/MM/RRRR'); 
   ELSE
     vr_dtrefere := TO_DATE('31/03/2023','DD/MM/RRRR');
   END IF;
   
   OPEN cr_saldo(pr_cdcooper => rw_crawseg.cdcooper,
                 pr_nrdconta => rw_crawseg.nrdconta,
                 pr_nrctremp => rw_crawseg.nrctrato,
                 pr_dtrefere => vr_dtrefere);
   FETCH cr_saldo INTO rw_saldo;
   CLOSE cr_saldo;
   
   OPEN cr_crapris(pr_cdcooper => rw_crawseg.cdcooper,
                   pr_nrdconta => rw_crawseg.nrdconta,
                   pr_dtrefere => vr_dtrefere);
   FETCH cr_crapris INTO rw_crapris;
   CLOSE cr_crapris;
   
   INSERT INTO CECRED.crawseg(dtmvtolt,
                              nrdconta,
                              nrctrseg,
                              tpseguro,
                              nmdsegur,
                              tpplaseg,
                              nmbenefi,
                              nrcadast,
                              nmdsecao,
                              dsendres,
                              nrendres,
                              nmbairro,
                              nmcidade,
                              cdufresd,
                              nrcepend,
                              dtinivig,
                              dtfimvig,
                              dsmarvei,
                              dstipvei,
                              nranovei,
                              nrmodvei,
                              qtpasvei,
                              ppdbonus,
                              flgdnovo,
                              nrapoant,
                              nmsegant,
                              flgdutil,
                              flgnotaf,
                              flgapant,
                              vlpreseg,
                              vlseguro,
                              vldfranq,
                              vldcasco,
                              vlverbae,
                              flgassis,
                              vldanmat,
                              vldanpes,
                              vldanmor,
                              vlappmor,
                              vlappinv,
                              cdsegura,
                              nmempres,
                              dschassi,
                              flgrenov,
                              dtdebito,
                              vlbenefi,
                              cdcalcul,
                              flgcurso,
                              dtiniseg,
                              nrdplaca,
                              lsctrant,
                              nrcpfcgc,
                              nrctratu,
                              nmcpveic,
                              flgunica,
                              nrctrato,
                              flgvisto,
                              cdapoant,
                              dtprideb,
                              vldifseg,
                              dscobext##1,
                              dscobext##2,
                              dscobext##3,
                              dscobext##4,
                              dscobext##5,
                              vlcobext##1,
                              vlcobext##2,
                              vlcobext##3,
                              vlcobext##4,
                              vlcobext##5,
                              flgrepgr,
                              vlfrqobr,
                              tpsegvid,
                              dtnascsg,
                              cdsexosg,
                              vlpremio,
                              qtparcel,
                              nrfonemp,
                              nrfonres,
                              dsoutgar,
                              vloutgar,
                              tpdpagto,
                              cdcooper,
                              flgconve,
                              complend,
                              nrproposta,
                              flggarad,
                              flgassum,
                              tpcustei,
                              tpmodali,
                              flfinanciasegprestamista,
                              flgsegma)
                       values(rw_crawseg.dtmvtolt,
                              rw_crawseg.nrdconta,
                              vr_nrctrseg,
                              rw_crawseg.tpseguro,
                              rw_crawseg.nmdsegur,
                              rw_crawseg.tpplaseg,
                              rw_crawseg.nmbenefi,
                              rw_crawseg.nrcadast,
                              rw_crawseg.nmdsecao,
                              rw_crawseg.dsendres,
                              rw_crawseg.nrendres,
                              rw_crawseg.nmbairro,
                              rw_crawseg.nmcidade,
                              rw_crawseg.cdufresd,
                              rw_crawseg.nrcepend,
                              rw_crawseg.dtinivig, 
                              rw_crappep.dtfimvig,
                              rw_crawseg.dsmarvei,
                              rw_crawseg.dstipvei,
                              rw_crawseg.nranovei,
                              rw_crawseg.nrmodvei,
                              rw_crawseg.qtpasvei,
                              rw_crawseg.ppdbonus,
                              rw_crawseg.flgdnovo,
                              rw_crawseg.nrapoant,
                              rw_crawseg.nmsegant,
                              rw_crawseg.flgdutil,
                              rw_crawseg.flgnotaf,
                              rw_crawseg.flgapant,
                              rw_crawseg.vlpreseg,
                              rw_crapris.saldo,
                              rw_crawseg.vldfranq,
                              rw_crawseg.vldcasco,
                              rw_crawseg.vlverbae,
                              rw_crawseg.flgassis,
                              rw_crawseg.vldanmat,
                              rw_crawseg.vldanpes,
                              rw_crawseg.vldanmor,
                              rw_crawseg.vlappmor,
                              rw_crawseg.vlappinv,
                              rw_crawseg.cdsegura,
                              rw_crawseg.nmempres,
                              rw_crawseg.dschassi,
                              rw_crawseg.flgrenov,
                              rw_crawseg.dtdebito, 
                              rw_crawseg.vlbenefi,
                              rw_crawseg.cdcalcul,
                              rw_crawseg.flgcurso,
                              rw_crawseg.dtiniseg, 
                              rw_crawseg.nrdplaca,
                              rw_crawseg.lsctrant,
                              rw_crawseg.nrcpfcgc,
                              rw_crawseg.nrctratu,
                              rw_crawseg.nmcpveic,
                              rw_crawseg.flgunica,
                              rw_crawseg.nrctrato,
                              rw_crawseg.flgvisto,
                              rw_crawseg.cdapoant,
                              rw_crawseg.dtprideb, 
                              rw_crawseg.vldifseg,
                              rw_crawseg.dscobext##1,
                              rw_crawseg.dscobext##2,
                              rw_crawseg.dscobext##3,
                              rw_crawseg.dscobext##4,
                              rw_crawseg.dscobext##5,
                              rw_crawseg.vlcobext##1,
                              rw_crawseg.vlcobext##2,
                              rw_crawseg.vlcobext##3,
                              rw_crawseg.vlcobext##4,
                              rw_crawseg.vlcobext##5,
                              rw_crawseg.flgrepgr,
                              rw_crawseg.vlfrqobr,
                              rw_crawseg.tpsegvid,
                              rw_crawseg.dtnascsg,
                              rw_crawseg.cdsexosg,
                              rw_crawseg.vlpremio,
                              rw_crawseg.qtparcel,
                              rw_crawseg.nrfonemp,
                              rw_crawseg.nrfonres,
                              rw_crawseg.dsoutgar,
                              rw_crawseg.vloutgar,
                              rw_crawseg.tpdpagto,
                              rw_crawseg.cdcooper,
                              rw_crawseg.flgconve,
                              rw_crawseg.complend,
                              vr_nrproposta,
                              rw_crawseg.flggarad,
                              rw_crawseg.flgassum,
                              rw_crawseg.tpcustei,
                              rw_crawseg.tpmodali,
                              rw_crawseg.flfinanciasegprestamista,
                              rw_crawseg.flgsegma);
    
   COMMIT;
   
   vr_linha := 'DELETE CECRED.crawseg w WHERE w.cdcooper = ' || rw_crawseg.cdcooper || ' AND w.nrdconta = ' || rw_crawseg.nrdconta || ' AND w.nrctrseg = ' || vr_nrctrseg || ' AND w.tpseguro = 4;';

   CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);
  
   IF rw_crawseg.nrproposta = '770349686023' THEN
     vr_nrseguro := 375874;
   ELSE
     vr_nrseguro := rw_crawseg.nrctrseg;
   END IF;
 
   OPEN cr_crapseg(pr_cdcooper => rw_crawseg.cdcooper,
                   pr_nrdconta => rw_crawseg.nrdconta,
                   pr_nrctrseg => vr_nrseguro);
   FETCH cr_crapseg INTO rw_crapseg;
   
   IF cr_crapseg%FOUND THEN
   
     vr_nrseqdig := cecred.fn_sequence('CRAPLOT'
                                      ,'NRSEQDIG'
                                      ,1||';'||rw_crapseg.cdagenci||';'||'900;'||rw_crapseg.nrdolote); 
   
     INSERT INTO CECRED.crapseg(nrdconta,
                                nrctrseg,
                                dtinivig,
                                dtfimvig,
                                dtmvtolt,
                                cdagenci,
                                cdbccxlt,
                                cdsitseg,
                                dtaltseg,
                                dtcancel,
                                dtdebito,
                                dtiniseg,
                                indebito,
                                nrdolote,
                                nrseqdig,
                                qtprepag,
                                vlprepag,
                                vlpreseg,
                                dtultpag,
                                tpseguro,
                                tpplaseg,
                                qtprevig,
                                cdsegura,
                                lsctrant,
                                nrctratu,
                                flgunica,
                                dtprideb,
                                vldifseg,
                                nmbenvid##1,
                                nmbenvid##2,
                                nmbenvid##3,
                                nmbenvid##4,
                                nmbenvid##5,
                                dsgraupr##1,
                                dsgraupr##2,
                                dsgraupr##3,
                                dsgraupr##4,
                                dsgraupr##5,
                                txpartic##1,
                                txpartic##2,
                                txpartic##3,
                                txpartic##4,
                                txpartic##5,
                                dtultalt,
                                cdoperad,
                                vlpremio,
                                qtparcel,
                                tpdpagto,
                                cdcooper,
                                flgconve,
                                flgclabe,
                                cdmotcan,
                                tpendcor,
                                cdopecnl,
                                dtrenova,
                                cdopeori,
                                cdageori,
                                dtinsori,
                                cdopeexc,
                                cdageexc,
                                dtinsexc,
                                vlslddev,
                                idimpdps)
                         VALUES(rw_crapseg.nrdconta,
                                vr_nrctrseg,
                                rw_crapseg.dtinivig, 
                                rw_crappep.dtfimvig,
                                rw_crapseg.dtmvtolt, 
                                rw_crapseg.cdagenci,
                                rw_crapseg.cdbccxlt,
                                1,
                                rw_crapseg.dtaltseg,
                                null,
                                rw_crapseg.dtdebito, 
                                rw_crapseg.dtiniseg, 
                                rw_crapseg.indebito,
                                rw_crapseg.nrdolote,
                                vr_nrseqdig,
                                rw_crapseg.qtprepag,
                                rw_crapseg.vlprepag,
                                rw_crapseg.vlpreseg,
                                rw_crapseg.dtultpag, 
                                rw_crapseg.tpseguro,
                                rw_crapseg.tpplaseg,
                                rw_crapseg.qtprevig,
                                rw_crapseg.cdsegura,
                                rw_crapseg.lsctrant,
                                rw_crapseg.nrctratu,
                                rw_crapseg.flgunica,
                                rw_crapseg.dtprideb, 
                                rw_crapseg.vldifseg,
                                rw_crapseg.nmbenvid##1,
                                rw_crapseg.nmbenvid##2,
                                rw_crapseg.nmbenvid##3,
                                rw_crapseg.nmbenvid##4,
                                rw_crapseg.nmbenvid##5,
                                rw_crapseg.dsgraupr##1,
                                rw_crapseg.dsgraupr##2,
                                rw_crapseg.dsgraupr##3,
                                rw_crapseg.dsgraupr##4,
                                rw_crapseg.dsgraupr##5,
                                rw_crapseg.txpartic##1,
                                rw_crapseg.txpartic##2,
                                rw_crapseg.txpartic##3,
                                rw_crapseg.txpartic##4,
                                rw_crapseg.txpartic##5,
                                rw_crapseg.dtultalt, 
                                rw_crapseg.cdoperad,
                                rw_crapseg.vlpremio,
                                rw_crapseg.qtparcel,
                                rw_crapseg.tpdpagto,
                                rw_crapseg.cdcooper,
                                rw_crapseg.flgconve,
                                rw_crapseg.flgclabe,
                                null,
                                rw_crapseg.tpendcor,
                                rw_crapseg.cdopecnl,
                                rw_crapseg.dtrenova,
                                rw_crapseg.cdopeori,
                                rw_crapseg.cdageori,
                                rw_crapseg.dtinsori, 
                                rw_crapseg.cdopeexc,
                                rw_crapseg.cdageexc,
                                rw_crapseg.dtinsexc,
                                rw_crapris.saldo,
                                rw_crapseg.idimpdps);
     COMMIT;
     
     vr_linha := 'DELETE CECRED.crapseg WHERE cdcooper = ' || rw_crapseg.cdcooper || ' AND nrdconta = ' || rw_crapseg.nrdconta || ' AND nrctrseg = ' || vr_nrctrseg || ' AND tpseguro = 4;';

     CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);
   END IF;
   CLOSE cr_crapseg;
   
   IF rw_crawseg.nrproposta = '770349686023' THEN
     vr_nrseguro := 692728;
   ELSE
     vr_nrseguro := rw_crawseg.nrctrseg;
   END IF;
   
   OPEN cr_tbseg_prestamista(pr_cdcooper => rw_crawseg.cdcooper,
                             pr_nrdconta => rw_crawseg.nrdconta,
                             pr_nrctremp => rw_crawseg.nrctrato,
                             pr_nrctrseg => vr_nrseguro);
                             
   FETCH cr_tbseg_prestamista INTO rw_tbseg_prestamista;
   
   IF cr_tbseg_prestamista%FOUND THEN
     vr_nrsequen := cecred.fn_sequence('TBSEG_PRESTAMISTA', 'SEQCERTIFICADO', 0);
     
     INSERT INTO CECRED.tbseg_prestamista(cdcooper,
                                          nrdconta,
                                          nrctrseg,
                                          nrctremp,
                                          tpregist,
                                          cdapolic,
                                          nrcpfcgc,
                                          nmprimtl,
                                          dtnasctl,
                                          cdsexotl,
                                          dsendres,
                                          dsdemail,
                                          nmbairro,
                                          nmcidade,
                                          cdufresd,
                                          nrcepend,
                                          nrtelefo,
                                          dtdevend,
                                          dtinivig,
                                          cdcobran,
                                          cdadmcob,
                                          tpfrecob,
                                          tpsegura,
                                          cdprodut,
                                          cdplapro,
                                          vlprodut,
                                          tpcobran,
                                          vlsdeved,
                                          vldevatu,
                                          dtrefcob,
                                          dtfimvig,
                                          dtdenvio,
                                          nrproposta,
                                          tprecusa,
                                          cdmotrec,
                                          dtrecusa,
                                          situacao,
                                          tpcustei,
                                          pemorte,
                                          peinvalidez,
                                          peiftttaxa,
                                          qtifttdias,
                                          nrapolice,
                                          qtparcel,
                                          vlpielimit,
                                          vlifttlimi,
                                          dsprotocolo,
                                          flfinanciasegprestamista)
                                   values(rw_tbseg_prestamista.cdcooper,
                                          rw_tbseg_prestamista.nrdconta,
                                          vr_nrctrseg,
                                          rw_tbseg_prestamista.nrctremp,
                                          1,
                                          vr_nrsequen,
                                          rw_tbseg_prestamista.nrcpfcgc,
                                          rw_tbseg_prestamista.nmprimtl,
                                          rw_tbseg_prestamista.dtnasctl,
                                          rw_tbseg_prestamista.cdsexotl,
                                          rw_tbseg_prestamista.dsendres,
                                          rw_tbseg_prestamista.dsdemail,
                                          rw_tbseg_prestamista.nmbairro,
                                          rw_tbseg_prestamista.nmcidade,
                                          rw_tbseg_prestamista.cdufresd,
                                          rw_tbseg_prestamista.nrcepend,
                                          rw_tbseg_prestamista.nrtelefo,
                                          rw_tbseg_prestamista.dtdevend, 
                                          rw_tbseg_prestamista.dtinivig, 
                                          rw_tbseg_prestamista.cdcobran,
                                          rw_tbseg_prestamista.cdadmcob,
                                          rw_tbseg_prestamista.tpfrecob,
                                          rw_tbseg_prestamista.tpsegura,
                                          rw_tbseg_prestamista.cdprodut,
                                          rw_tbseg_prestamista.cdplapro,
                                          rw_tbseg_prestamista.vlprodut,
                                          rw_tbseg_prestamista.tpcobran,
                                          rw_crapris.saldo,
                                          rw_saldo.saldo,
                                          rw_tbseg_prestamista.dtrefcob, 
                                          rw_crappep.dtfimvig,
                                          rw_tbseg_prestamista.dtdenvio, 
                                          vr_nrproposta,
                                          null,
                                          null,
                                          null,
                                          rw_tbseg_prestamista.situacao,
                                          rw_tbseg_prestamista.tpcustei,
                                          rw_tbseg_prestamista.pemorte,
                                          rw_tbseg_prestamista.peinvalidez,
                                          rw_tbseg_prestamista.peiftttaxa,
                                          rw_tbseg_prestamista.qtifttdias,
                                          rw_tbseg_prestamista.nrapolice,
                                          rw_tbseg_prestamista.qtparcel,
                                          rw_tbseg_prestamista.vlpielimit,
                                          rw_tbseg_prestamista.vlifttlimi,
                                          rw_tbseg_prestamista.dsprotocolo,
                                          rw_tbseg_prestamista.flfinanciasegprestamista);
   
     COMMIT;
     
     UPDATE cecred.crawseg
        SET nrproposta = vr_nrproposta,
            nrctrseg = vr_nrctrseg 
      WHERE cdcooper = rw_crawseg.cdcooper
        AND nrdconta = rw_crawseg.nrdconta
        AND nrctrato = rw_crawseg.nrctrato
        AND nrctrseg = vr_nrctrseg;
     
    COMMIT;
    vr_linha := 'DELETE CECRED.tbseg_prestamista WHERE cdcooper = ' || rw_tbseg_prestamista.cdcooper || ' AND nrdconta = ' || rw_tbseg_prestamista.nrdconta || ' AND nrctrseg = ' || vr_nrctrseg || ' AND nrctremp = ' || rw_tbseg_prestamista.nrctremp || ';';

    CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);
    
   END IF;
   CLOSE cr_tbseg_prestamista;
 END LOOP;
 
 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,' COMMIT;');
 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,' END; ');
 CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,'/ ');
 CECRED.GENE0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arq ); 
  
end;
