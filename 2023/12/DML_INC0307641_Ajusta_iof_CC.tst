PL/SQL Developer Test script 3.0
363
DECLARE 

  pr_dtrefere DATE := to_date('21/12/2023','DD/MM/RRRR');
  vr_vlbasiof NUMBER := 0;
  vr_diretorio   VARCHAR2(500);
  vr_cdcritic    NUMBER;
  vr_dscritic    VARCHAR2(1000);
  vr_dsrollback  VARCHAR2(4000);
  vr_arquivo_log utl_file.file_type;
  vr_arquivo_rollback utl_file.file_type;
  vr_excerro     EXCEPTION;
  
  
  CURSOR cr_craplcm IS
    SELECT h.DSHISTOR,
           s.rowid rowid_sld,
           s.vlbasiof,
           s.vliofmes,
           l.*
      FROM craplcm l, 
           craphis h,
           crapsld s
     WHERE h.CDCOOPER = l.CDCOOPER
       AND h.CDHISTOR = l.CDHISTOR
       AND l.cdcooper = s.cdcooper
       AND l.nrdconta = s.nrdconta
       AND l.DTMVTOLT = pr_dtrefere
       AND l.CDHISTOR = 2323
       AND (l.CDCOOPER,l.NRDCONTA,l.NRDCONTA)  IN    
            (
            (1 ,6336825 ,6336825),
            (1 ,6406149 ,6406149),
            (1 ,8507228 ,8507228),
            (1 ,8600678 ,8600678),
            (1 ,10738061  ,10738061),
            (1 ,11021357  ,11021357),
            (1 ,11474521  ,11474521),
            (1 ,11598166  ,11598166),
            (1 ,11781149  ,11781149),
            (1 ,11785896  ,11785896),
            (1 ,12104477  ,12104477),
            (1 ,12381160  ,12381160),
            (1 ,13082264  ,13082264),
            (1 ,13094530  ,13094530),
            (1 ,13241788  ,13241788),
            (1 ,13773127  ,13773127),
            (1 ,14395630  ,14395630),
            (9 ,297402  ,297402),
            (13  ,183059  ,183059),
            (14  ,131644  ,131644),
            (16  ,761966  ,761966),
            (16  ,959880  ,959880),
            (16  ,2460793 ,2460793),
            (1 ,6589464 ,6589464),
            (1 ,7918240 ,7918240),
            (1 ,7949227 ,7949227),
            (1 ,8692904 ,8692904),
            (1 ,10194932  ,10194932),
            (1 ,10618813  ,10618813),
            (1 ,10900195  ,10900195),
            (1 ,11266392  ,11266392),
            (1 ,11381019  ,11381019),
            (1 ,11547391  ,11547391),
            (1 ,11562269  ,11562269),
            (1 ,11763469  ,11763469),
            (1 ,12122262  ,12122262),
            (1 ,12144908  ,12144908),
            (1 ,12236004  ,12236004),
            (1 ,12414182  ,12414182),
            (1 ,12540226  ,12540226),
            (1 ,12890375  ,12890375),
            (1 ,12968625  ,12968625),
            (1 ,13036963  ,13036963),
            (1 ,13175866  ,13175866),
            (1 ,13303791  ,13303791),
            (1 ,13530720  ,13530720),
            (1 ,13979892  ,13979892),
            (1 ,15026663  ,15026663),
            (13  ,9636  ,9636),
            (13  ,229814  ,229814),
            (13  ,549231  ,549231),
            (16  ,518379  ,518379),
            (16  ,659290  ,659290),
            (16  ,1003186 ,1003186),
            (1 ,4017153 ,4017153),
            (1 ,6145990 ,6145990),
            (1 ,6223664 ,6223664),
            (1 ,6930956 ,6930956),
            (1 ,7309414 ,7309414),
            (1 ,7898657 ,7898657),
            (1 ,7956258 ,7956258),
            (1 ,7965028 ,7965028),
            (1 ,7967454 ,7967454),
            (1 ,8088756 ,8088756),
            (1 ,8186707 ,8186707),
            (1 ,9677283 ,9677283),
            (1 ,9683895 ,9683895),
            (1 ,9850910 ,9850910),
            (1 ,9861602 ,9861602),
            (1 ,10038353  ,10038353),
            (1 ,10510672  ,10510672),
            (1 ,10739831  ,10739831),
            (1 ,10957235  ,10957235),
            (1 ,11011971  ,11011971),
            (1 ,11493100  ,11493100),
            (1 ,11664029  ,11664029),
            (1 ,12067539  ,12067539),
            (1 ,12185540  ,12185540),
            (1 ,12247626  ,12247626),
            (1 ,12373036  ,12373036),
            (1 ,12644099  ,12644099),
            (1 ,12808512  ,12808512),
            (1 ,13173405  ,13173405),
            (1 ,13874691  ,13874691),
            (1 ,14010224  ,14010224),
            (1 ,14136872  ,14136872),
            (1 ,14348748  ,14348748),
            (1 ,15312445  ,15312445),
            (5 ,122661  ,122661),
            (13  ,166669  ,166669),
            (16  ,20451 ,20451),
            (16  ,1051660 ,1051660),
            (1 ,6405541 ,6405541),
            (1 ,6946542 ,6946542),
            (1 ,7238010 ,7238010),
            (1 ,7992564 ,7992564),
            (1 ,8702764 ,8702764),
            (1 ,8907765 ,8907765),
            (1 ,8915687 ,8915687),
            (1 ,9089012 ,9089012),
            (1 ,10124918  ,10124918),
            (1 ,10510281  ,10510281),
            (1 ,10544313  ,10544313),
            (1 ,10877630  ,10877630),
            (1 ,10960643  ,10960643),
            (1 ,11202629  ,11202629),
            (1 ,11368390  ,11368390),
            (1 ,11455292  ,11455292),
            (1 ,11766174  ,11766174),
            (1 ,11832266  ,11832266),
            (1 ,11941332  ,11941332),
            (1 ,12039578  ,12039578),
            (1 ,12322105  ,12322105),
            (1 ,12371025  ,12371025),
            (1 ,13024272  ,13024272),
            (1 ,13242458  ,13242458),
            (1 ,13997998  ,13997998),
            (1 ,14001306  ,14001306),
            (2 ,168408  ,168408),
            (2 ,897868  ,897868),
            (6 ,126004  ,126004),
            (11  ,653187  ,653187),
            (16  ,235563  ,235563),
            (16  ,579980  ,579980),
            (16  ,648582  ,648582),
            (16  ,966460  ,966460),
            (16  ,981249  ,981249),
            (1 ,3053881 ,3053881),
            (1 ,7030037 ,7030037),
            (1 ,7458762 ,7458762),
            (1 ,7855397 ,7855397),
            (1 ,9265821 ,9265821),
            (1 ,10638130  ,10638130),
            (1 ,10941525  ,10941525),
            (1 ,11058935  ,11058935),
            (1 ,11246243  ,11246243),
            (1 ,11263300  ,11263300),
            (1 ,11492562  ,11492562),
            (1 ,11851333  ,11851333),
            (1 ,11951001  ,11951001),
            (1 ,11954434  ,11954434),
            (1 ,12056464  ,12056464),
            (1 ,12075922  ,12075922),
            (1 ,12477265  ,12477265),
            (1 ,12541788  ,12541788),
            (1 ,12557366  ,12557366),
            (1 ,12729353  ,12729353),
            (1 ,13053450  ,13053450),
            (1 ,13145320  ,13145320),
            (1 ,13584723  ,13584723),
            (13  ,137880  ,137880),
            (1 ,1939602 ,1939602),
            (1 ,2558246 ,2558246),
            (1 ,3171647 ,3171647),
            (1 ,3879160 ,3879160),
            (1 ,4079299 ,4079299),
            (1 ,7098995 ,7098995),
            (1 ,7427972 ,7427972),
            (1 ,8841179 ,8841179),
            (1 ,9423184 ,9423184),
            (1 ,9462864 ,9462864),
            (1 ,10407685  ,10407685),
            (1 ,10731229  ,10731229),
            (1 ,10995510  ,10995510),
            (1 ,11134615  ,11134615),
            (1 ,11480610  ,11480610),
            (1 ,11773030  ,11773030),
            (1 ,11913266  ,11913266),
            (1 ,12000000  ,12000000),
            (1 ,12028274  ,12028274),
            (1 ,12434930  ,12434930),
            (1 ,12609684  ,12609684),
            (1 ,12745820  ,12745820),
            (1 ,12843300  ,12843300),
            (1 ,13362402  ,13362402),
            (1 ,13785826  ,13785826),
            (1 ,14185342  ,14185342),
            (1 ,14516772  ,14516772),
            (7 ,209082  ,209082),
            (11  ,878499  ,878499),
            (11  ,959626  ,959626),
            (13  ,593052  ,593052),
            (14  ,381888  ,381888),
            (16  ,990981  ,990981),
            (1 ,3507041 ,3507041),
            (1 ,3515176 ,3515176),
            (1 ,3522679 ,3522679),
            (1 ,6438660 ,6438660),
            (1 ,6513727 ,6513727),
            (1 ,6886795 ,6886795),
            (1 ,7288190 ,7288190),
            (1 ,7918860 ,7918860),
            (1 ,8070946 ,8070946),
            (1 ,8112860 ,8112860),
            (1 ,8252750 ,8252750),
            (1 ,8569509 ,8569509),
            (1 ,9908951 ,9908951),
            (1 ,9992480 ,9992480),
            (1 ,9993320 ,9993320),
            (1 ,10036431  ,10036431),
            (1 ,11231157  ,11231157),
            (1 ,11492422  ,11492422),
            (1 ,11550503  ,11550503),
            (1 ,11920807  ,11920807),
            (1 ,12047422  ,12047422),
            (1 ,12112208  ,12112208),
            (1 ,12857190  ,12857190),
            (1 ,12986720  ,12986720),
            (1 ,13526464  ,13526464),
            (1 ,14384060  ,14384060),
            (1 ,14454823  ,14454823),
            (9 ,357111  ,357111),
            (11  ,923400  ,923400),
            (13  ,238210  ,238210),
            (16  ,632147  ,632147),
            (16  ,648450  ,648450),
            (16  ,677566  ,677566),
            (16  ,720518  ,720518),
            (1 ,2751089 ,2751089),
            (1 ,2826909 ,2826909),
            (1 ,6669638 ,6669638),
            (1 ,8068127 ,8068127),
            (1 ,8681040 ,8681040),
            (1 ,9509127 ,9509127),
            (1 ,9678816 ,9678816),
            (1 ,9951326 ,9951326),
            (1 ,9960449 ,9960449),
            (1 ,10424652  ,10424652),
            (1 ,10466738  ,10466738),
            (1 ,10870849  ,10870849),
            (1 ,10946870  ,10946870),
            (1 ,11230371  ,11230371),
            (1 ,11597453  ,11597453),
            (1 ,11874767  ,11874767),
            (1 ,13126253  ,13126253),
            (1 ,13314122  ,13314122),
            (1 ,13536834  ,13536834),
            (1 ,14170132  ,14170132),
            (1 ,80140327  ,80140327),
            (7 ,101907  ,101907),
            (13  ,54976 ,54976) )
    ORDER BY l.DTMVTOLT, l.NRDCONTA,l.DTTRANS, l.NRSEQDIG;
  
  PROCEDURE pc_abrir_arquivos IS
  BEGIN
    sistema.abrirArquivo(pr_nmdireto => vr_diretorio,
                         pr_nmarquiv => 'IOF_CC_'||to_char(SYSDATE,'RRRRMMDD')||'.log',
                         pr_tipabert => 'A',
                         pr_utlfileh => vr_arquivo_log,
                         pr_dscritic => vr_dscritic);
    IF vr_dscritic IS NOT NULL THEN
      vr_dscritic := 'Arquivo contas.txt não encontrado.';
      RAISE vr_excerro;
    END IF;
    
    sistema.abrirArquivo(pr_nmdireto => vr_diretorio,
                         pr_nmarquiv => 'rollback_IOF_CC_'||to_char(SYSDATE,'RRRRMMDD')||'.log',
                         pr_tipabert => 'A',
                         pr_utlfileh => vr_arquivo_rollback,
                         pr_dscritic => vr_dscritic);
    IF vr_dscritic IS NOT NULL THEN
      vr_dscritic := 'Arquivo contas.txt não encontrado.';
      RAISE vr_excerro;
    END IF;
  
  END;    
  
  PROCEDURE pc_fechar_arquivos IS
  BEGIN
    sistema.fecharArquivo(pr_utlfileh => vr_arquivo_log);
    sistema.fecharArquivo(pr_utlfileh => vr_arquivo_rollback);
  END;  
  
  PROCEDURE pc_gera_log(pr_tipo VARCHAR2 DEFAULT 'L',
                        pr_dsmensagen VARCHAR2) IS
  
    vr_utlfileh   utl_file.file_type;
    vr_dsmensagen VARCHAR2(4000);
  BEGIN
    IF pr_tipo = 'R' THEN
      vr_utlfileh := vr_arquivo_rollback;
      vr_dsmensagen := pr_dsmensagen;
    ELSE
      vr_utlfileh := vr_arquivo_log;
      vr_dsmensagen := pr_dsmensagen;
    END IF;    
    sistema.escrevelinhaarquivo(pr_utlfileh => vr_utlfileh, 
                                pr_des_text => vr_dsmensagen);
  
  END;      
  
BEGIN
  
  vr_diretorio := sistema.obterParametroSistema(pr_nmsistem => 'CRED'
                                               ,pr_cdacesso => 'ROOT_MICROS') || 'cpd/bacas/RISCO/BNDES';
                                               
  pc_abrir_arquivos;

  pc_gera_log('L','cdcooper;nrdconta;vlbasiof_atual;vlbasiof_novo;vliofmes_atual;vliofmes_novo;vliof_add');
  
  FOR rw_craplcm IN cr_craplcm LOOP
    vr_vlbasiof := 0;
    
    BEGIN
      vr_vlbasiof := gene0002.fn_char_para_number(rw_craplcm.cdpesqbb);        
      pc_gera_log('L',rw_craplcm.cdcooper||';'||rw_craplcm.nrdconta||';'||rw_craplcm.vlbasiof||';'||vr_vlbasiof||';'||rw_craplcm.vliofmes||';'||(rw_craplcm.vliofmes+rw_craplcm.vllanmto)||';'||rw_craplcm.vllanmto);
    
      UPDATE crapsld s
         SET vliofmes = vliofmes + rw_craplcm.vllanmto
           , vlbasiof = nvl(vlbasiof,0) +  nvl(vr_vlbasiof,0)
       WHERE s.rowid = rw_craplcm.rowid_sld;
        
    
      pc_gera_log('R',' UPDATE crapsld s
                       SET vliofmes = '|| rw_craplcm.vliofmes  ||'
                         , vlbasiof = '|| rw_craplcm.vlbasiof  ||'
                     WHERE s.rowid = ' || rw_craplcm.rowid_sld ||';');    
    END;  
    
  END LOOP;  
  
  pc_gera_log('R','Commit;');
  pc_fechar_arquivos;
  
  COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    pc_gera_log('L','Erro: '||SQLERRM); 
    pc_fechar_arquivos; 
    
    ROLLBACK;  
END;
0
0
