
<!--
  Programa: crap061.htm

  Alteracoes: 17/03/2010 - Criação da rotina (Evandro).
  
              16/09/2010 - Aumentado o campo v_nrsequni para 7 caracteres (Evandro).
              
              10/02/2011 - Refeita toda a rotina transformando-a dinamica. Alterado
                           o metodo de programação de Mapped Web (.w + .htm) 
                           para SpeedScript (.htm) (Guilherme).
                           
              04/05/2012 - Incluido variavel de parametro v_pestorno.
                          (David Kruger).
                          
              06/08/2012 - Nao autenticar mais cheque das cooperativa por aqui pois
                           a rotina b1crap51 passou a fazer autenticacoes
                           (Guilherme).  
                           
              17/10/2012 - Incluso tamanho maximo no campo valor computado (Daniel).
              
              16/04/2013 - Adicionado verificacao de sangria de caixa no
                           REQUEST-METHOD = GET. (Fabricio)
                           
              08/08/2013 - Ajustado processo para chamar tela liberacao supervisor
                            na rotina 61 (Jean Michel).
              
              11/11/2013 - Nova forma de chamar as agências, de PAC agora 
                           a escrita será PA (Guilherme Gielow)
                           
              12/12/2013 - Alteracao referente a integracao Progress X 
                           Dataserver Oracle 
                           Inclusao do VALIDATE ( André Euzébio / SUPERO)              

              20/06/2014 - Deposito Intercooperativas
                           - Novo parametro "Coop Destino"
                             -- valida-deposito-com-captura
                             -- valida-deposito-com-captura-migrado
                             -- valida-deposito-com-captura-migrado-host
                           - Limpar o v_valor2 quando valores Comp e Inf batem
                           (Guilherme/SUPERO)
                           
              03/12/2014 - Alteração foco em rotina de processamento de envelope de 
                           depósito de cheque (Lunelli - SD. 215486)
                           
              05/01/2015 - Realizado os seguintes ajustes:
                           - Identacao do codigo
                           - Ajuste para nao gerar sobreposicao de trancacoes
                           - Ao processar os envelopes de dinheiro, quando houver
                             um erro o processo sera parado. A lista de envelopes
                             apenas ira apresentar o envelope que deu erro e os 
                             demais a partir deste. Todos os envelopes que foram
                             processados com sucesso nao serao listados.
                           - Ajuste para evitar o envio de dois submits no processo
                             de inclusao dos envelopes a lista para serem 
                             processados  
                             (Adriano SD - 237890)              

             13/02/2015 - Ocultado o campo Conferência (dinheiro) por não será
                          mais necessário (Lunelli - SD 229246)  
                          
             06/05/2015 - Alteração de foco para o campo de Valor (Lunelli - SD 264635)   
             
             23/09/2015 - Limpeza da crapmrw antes da execução da rotina, evitando que sejam
                          carregados dados de operações anteriores (Lucas Lunelli - SD 324126)                               

             02/08/2016 - Removido EXCLUSIVE-LOCK da crapmdw que totalizava os valores
                          (Douglas - Chamado 496644)

             12/09/2016 - Adicionado chamada da função "callBlass(event)" - (Evandro - RKAM).
             
             31/01/2017 - Validar corretamente a conta beneficiaria CRAPASS (Lucas Ranghetti #603860)
			 
			 15/03/2018 - Aumentado o tamanho do campo v_nrsequniC de 7 caracteres para 9 (Tiago #INC0010516)
			 
			 04/05/2018 - Possibilidade de usar caixa on-line mesmo com o processo batch (noturno) executando 
			              (Fabio Adriano - Amcom).
-->

<html>
<head>
    <meta http-equiv="Content-Language" content="pt-br">
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <meta name="GENERATOR" content="Microsoft FrontPage 4.0">
    <meta name="ProgId" content="FrontPage.Editor.Document">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="Pragma"        content="No-Cache">
    <meta http-equiv="Expires"       content="0">
    <script language=JavaScript src="/script/formatadadosie.js"></script>
    <link rel=StyleSheet type="text/css" href="/script/viacredi.css">
    <title>LIBERAÇÃO DE ENVELOPES</title>
</head>

<body background="/images/moeda.jpg" bgproperties="fixed" class=fundo onLoad="JavaScript:mudaFoco(); click();" onKeyUp="callBlass(event); callBLini(event); callBLsal(event);">
<script language="JavaScript">
 
    function validarData( data ) {
 
        data = data.replace(/[^0-9\/]/g, "");
 
        var partes = data.split("/");
 
        if( partes.length != 3 ) return true;
 
        var dia = partes[0];
        var mes = partes[1];
        var ano = partes[2];
 
        if( isNaN(dia) || isNaN(mes) || isNaN(ano) ) return false;
 
        if( mes > 12 || mes < 1 || ano < 1 || dia < 1) return true;
 
        if( mes == 2 ) {
 
                maiorDia = ( ( (!(ano % 4)) && (ano % 100) ) || (!(ano % 400)) )? 29: 28;
 
                if( dia > maiorDia ) return true;
 
        }else {
 
                if( mes == 4 || mes == 6 || mes == 9 || mes == 11 ) {
 
                        if( dia > 30 ) return true;
                }else {
 
                        if( dia > 31 ) return true;
                }
        }
 
        return false;
    }
    
    function mostraCheque(foco){

        if (document.getElementById('v_nrterfin').value != ""){
            document.getElementById('divCheque').style.display="block";
            document.getElementById('divDinheiro').style.display="none";
            document.getElementById('vh_foco').value = foco;
        }else{
            document.getElementById('vh_foco').value = 8;
        }
    }
    
    function mostraDinheiro(foco){
        if (document.getElementById('v_nrterfin').value != ""){
            document.getElementById('divCheque').style.display="none";
            document.getElementById('divDinheiro').style.display="block";
            document.getElementById('vh_foco').value = foco;
        }else{
            alert("Deve ser informado numero do Terminal.");
            document.getElementById('vh_foco').value = 8;
        }
    }

    /* usada quando retorna da funcao Manual ou quando ha mensagem alerta */
    function retornaManual(){
        if (document.getElementById("v_valorcomput").value == document.getElementById("v_valorproc").value &&
            document.getElementById("v_valorcomput").value != "") {
            document.getElementById("v_cheque").disabled = false;
            mostraCheque(27);
        }else
        if (document.getElementById("v_dtmvtoltC").value != "" &&
            document.getElementById("v_nrsequniC").value == "") {
            document.getElementById("v_conta").value = "";
            document.getElementById("v_nome").value = "";
            mostraCheque(18);
        }
        else{
            mostraCheque(23);
        }
    }

    function efetuaSubmit(dscopcao){

       document.getElementById('v_dscopcao').value = dscopcao;
       document.forms[0].submit();                 

    }

    function efetuaSubmitCheque(dscopcao){

       if(dscopcao == "v_cheque"){
          document.getElementById('v_prosschq').value = dscopcao;
          document.forms[0].submit();                 
       }else if(dscopcao == "v_descartar"){
          document.getElementById('v_descachq').value = dscopcao;
          document.forms[0].submit();                 
       }else if(dscopcao == "detalhar"){
          document.getElementById('v_detalhar').value = dscopcao;
          document.forms[0].submit();                 

       }else if(dscopcao == "Manual"){
          document.getElementById('v_manual').value = dscopcao;
          document.forms[0].submit();   
       }

    }

    function insereEnvelope(tipo){
        if ((tipo == 1 && document.getElementById('v_dtmvtoltD').value != "") ||
            (tipo == 2 && document.getElementById('v_nrsequniC').value != "")) {
            document.getElementById("v_altcompt").value = "sim";
            document.forms[0].submit();
            
        }
    }
    
    function trocaSituacao(id){
        if (document.getElementById("v_flgsitua"+id).value == "A confirmar") {
            document.getElementById("v_at_situa").value = "Descartado";
            document.getElementById("v_at_compt").value = "0,00";
            document.getElementById("v_id_compt").value = id;
        }else{
            document.getElementById("v_at_situa").value = "A confirmar";
            document.getElementById("v_at_compt").value = document.getElementById("v_vlinform"+id).innerHTML;
            document.getElementById("v_id_compt").value = id;
    
        }
        document.forms[0].submit();
    }

    function alteraComputado(id){
        if  (document.getElementById("v_vlcomput"+id).value == "" ){
            document.getElementById("v_vlcomput"+id).value = "0,00";
            document.getElementById("v_at_compt").value = "0,00"
            document.getElementById("v_id_compt").value = id;
            document.getElementById("v_at_situa").value = "Descartado";
        }
        else {
            document.getElementById("v_at_situa").value = "A confirmar";
            document.getElementById("v_at_compt").value = document.getElementById("v_vlcomput"+id).value;
            document.getElementById("v_id_compt").value = id;
    
        }
    
        document.forms[0].submit();
    }
    
    function alteraBtnProcessar(){
        if (document.getElementById("v_valorcomput").value == document.getElementById("v_valorproc").value) {
            document.getElementById("v_cheque").disabled = false;
            document.getElementById("v_cheque").focus();
        }else{
            document.getElementById("v_cheque").disabled = true;
        }
    }

    function validaComputado(){
        for (var i = 1; i <= document.getElementById("vh_qtdenvel").value; i++) {
            if (parseFloat(document.getElementById("v_vlcomput"+i).value.replace('.','').replace('.','').replace(',','')) == 0 && 
                document.getElementById("v_flgsitua"+i).value != "Descartado") {
                alert('Valor computado deve ser maior que zero.');
                return false;
            }
        }
        document.getElementById("v_dinheiro").value = "v_dinheiro";
        document.forms[0].submit();
    }

    function totalizaCampos(){
        var v_vltotcpt = 0,
            v_vltotdif = 0;
        
        for (var i = 1; i <= document.getElementById("vh_qtdenvel").value; i++) {
            v_vltotcpt = v_vltotcpt + parseFloat(document.getElementById("v_vlcomput"+i).value.replace('.','').replace('.','').replace(',',''));
            v_vltotdif = v_vltotdif + parseFloat(document.getElementById("v_vldifere"+i).innerHTML.replace('.','').replace('.','').replace(',',''));
        }
        document.getElementById("v_vltotcpt").innerHTML = formataDecimal(v_vltotcpt);
        document.getElementById("v_vltotdif").innerHTML = formataDecimal(v_vltotdif);
    
    }


    ///função para formatar campos com valores decimais - Adaptacao da FormataValor
    function formataDecimal(valor) {
       var vr  = valor.toString();
       var tam = 0;   
       var retorno = "";
       var sinal = "";
    
       if (valor < 0 ) {
           tam = vr.length - 1;
           sinal = "-";
       }else{ tam = vr.length; }
    
       vr = vr.replace( "/", "" );
       vr = vr.replace( "/", "" );
       vr = vr.replace( ",", "" );
       vr = vr.replace( ".", "" );
       vr = vr.replace( ".", "" );
       vr = vr.replace( ".", "" );
       vr = vr.replace( ".", "" );
       vr = vr.replace( "-", "" );
    
       if ( valor == 0 ) {return "0,00";}
       if (  tam ==  1 ){ retorno = "0,0" +vr ; }
       if (  tam ==  2 ){ retorno =  "0," +vr ; }
       if ( (tam >   2 ) && (tam <=  5) ){retorno = vr.substr( 0, tam - 2 ) + ',' + vr.substr( tam - 2, tam ) ; }
       if ( (tam >=  6 ) && (tam <=  8) ){retorno = vr.substr( 0, tam - 5 ) + '.' + vr.substr( tam - 5, 3 ) + ',' + vr.substr( tam - 2, tam ) ; }
       if ( (tam >=  9 ) && (tam <= 11) ){retorno = vr.substr( 0, tam - 8 ) + '.' + vr.substr( tam - 8, 3 ) + '.' + vr.substr( tam - 5, 3 ) + ',' + vr.substr( tam - 2, tam ) ; }
       if ( (tam >= 12 ) && (tam <= 14) ){retorno = vr.substr( 0, tam - 11 ) + '.' + vr.substr( tam - 11, 3 ) + '.' + vr.substr( tam - 8, 3 ) + '.' + vr.substr( tam - 5, 3 ) + ',' + vr.substr( tam - 2, tam ) ; }
       if ( (tam >= 15 ) && (tam <= 17) ){retorno = vr.substr( 0, tam - 14 ) + '.' + vr.substr( tam - 14, 3 ) + '.' + vr.substr( tam - 11, 3 ) + '.' + vr.substr( tam - 8, 3 ) + '.' + vr.substr( tam - 5, 3 ) + ',' + vr.substr( tam - 2, tam ) ;}
           
       return sinal + retorno;
    
    }

</script>
<script language="SpeedScript">

    DEF VAR v_coop        AS CHAR                                  NO-UNDO.
    DEF VAR v_conta       AS CHAR                                  NO-UNDO.
    DEF VAR v_nome        AS CHAR                                  NO-UNDO.
    DEF VAR v_pac         AS CHAR                                  NO-UNDO.
    DEF VAR v_caixa       AS CHAR                                  NO-UNDO.
    DEF VAR v_operador    AS CHAR                                  NO-UNDO.
    DEF VAR v_rowid       AS CHAR                                  NO-UNDO.
    DEF VAR v_msg         AS CHAR                                  NO-UNDO.
    DEF VAR vh_foco       AS CHAR                                  NO-UNDO.
    DEF VAR vh_qtdenvel   AS CHAR                                  NO-UNDO.
    DEF VAR v_poupanca    AS CHAR                                  NO-UNDO.
    DEF VAR v_identifica  AS CHAR                                  NO-UNDO.
    DEF VAR v_valor       AS CHAR                                  NO-UNDO.
    DEF VAR v_valor1      AS CHAR                                  NO-UNDO.
    DEF VAR v_valor2      AS CHAR                                  NO-UNDO.
    DEF VAR v_chequescoop AS DECI                                  NO-UNDO.
    DEF VAR aux_qtddchqs  AS INTE                                  NO-UNDO.
    DEF VAR aux_tpdmovto  AS INTE                                  NO-UNDO.
    DEF VAR v_totdepos    AS DECI                                  NO-UNDO.
    DEF VAR v_qtdchqs     AS INTE                                  NO-UNDO.
    DEF VAR v_nrsequniD   AS CHAR                                  NO-UNDO.
    DEF VAR v_nrsequniC   AS CHAR                                  NO-UNDO.
    DEF VAR v_dtenvelo    AS CHAR                                  NO-UNDO.
    DEF VAR v_valorcomput AS CHAR                                  NO-UNDO.
    DEF VAR v_altcompt    AS CHAR                                  NO-UNDO.
    DEF VAR v_valorproc   AS CHAR                                  NO-UNDO.
    DEF VAR v_at_situa    AS CHAR                                  NO-UNDO.
    DEF VAR v_at_compt    AS CHAR                                  NO-UNDO.
    DEF VAR v_id_compt    AS CHAR                                  NO-UNDO.
    DEF VAr v_pestorno    AS LOGICAL INIT FALSE                    NO-UNDO.

    DEF VAR h-b1crap00 AS HANDLE                                   NO-UNDO.
    DEF VAR h-b1crap22 AS HANDLE                                   NO-UNDO.
    DEF VAR h-b1crap51 AS HANDLE                                   NO-UNDO.
    DEF VAR h-b1crap61 AS HANDLE                                   NO-UNDO.
    DEF VAR aux_tipo   AS INTEGER                                  NO-UNDO.

    DEF VAR p-cdcmpchq  AS INT     FORMAT "zz9".               /* Comp */     
    DEF VAR p-cdbanchq  AS INT     FORMAT "zz9".               /* Banco */
    DEF VAR p-cdagechq  AS INT     FORMAT "zzz9".              /* Agencia */
    DEF VAR p-nrddigc1  AS INT     FORMAT "9".                 /* C1 */
    DEF VAR p-nrctabdb  AS DEC     FORMAT "zzz,zzz,zzz,9".     /* Conta */
    DEF VAR p-nrddigc2  AS INT     FORMAT "9".                 /* C2 */
    DEF VAR p-nrcheque  AS INT     FORMAT "zzz,zz9".           /* Cheque */
    DEF VAR p-nrddigc3  AS INT     FORMAT "9".                  /* C3 */
    DEF VAR v_mensagem1 AS CHAR                                    NO-UNDO.
    DEF VAR v_mensagem2 AS CHAR                                    NO-UNDO.
    
    DEF VAR p-valor-disponivel AS DEC                              NO-UNDO.
    DEF VAR p-mensagem         AS CHAR                             NO-UNDO.
    DEF VAR de-saldo-cheque    AS DEC                              NO-UNDO.
    DEF VAR p-mensagem1        AS CHAR                             NO-UNDO.
    
    DEF VAR v_flg-cta-migrada AS CHAR                              NO-UNDO.
    DEF VAR v_coop-migrada    AS CHAR                              NO-UNDO.
    DEF VAR v_flg-coop-host   AS CHAR                              NO-UNDO.
    DEF VAR v_nro-conta-nova  AS CHAR                              NO-UNDO.
    DEF VAR v_nro-conta-anti  AS CHAR                              NO-UNDO.

    DEF VAR p-flg-cta-migrada AS LOG                               NO-UNDO.
    DEF VAR p-coop-migrada    AS CHAR                              NO-UNDO.
    DEF VAR p-flg-coop-host   AS LOG                               NO-UNDO.
    DEF VAR p-nro-conta-nova  AS INT                               NO-UNDO.
    DEF VAR p-nro-conta-anti  AS INT                               NO-UNDO.

    
    DEF VAR p-literal        AS CHAR                               NO-UNDO.
    DEF VAR p-ult-sequencia  AS INTE                               NO-UNDO.
    DEF VAR p-programa       AS CHAR   INITIAL "CRAP061".      
    DEF VAR l-houve-erro     AS LOG                                NO-UNDO.
    DEF VAR c-nome           AS CHAR                               NO-UNDO.
    DEF VAR c-poup           AS CHAR                               NO-UNDO.
    DEF VAR aux_achou        AS LOGI                               NO-UNDO. 

    DEF VAR v_nrterfin   AS CHARACTER                              NO-UNDO.
    DEF VAR v_dsterfin   AS CHARACTER                              NO-UNDO.
    DEF VAR v_dtmvtoltC  AS CHARACTER                              NO-UNDO.
    DEF VAR v_dtmvtoltD  AS CHARACTER                              NO-UNDO.
    DEF VAR v_nrdocmto   AS CHARACTER                              NO-UNDO.
    DEF VAR aux_contador AS INTEGER                                NO-UNDO.
    DEF VAR aux_nmcopdst AS CHAR                                   NO-UNDO.
    DEF VAR aux_nrctadst AS INTEGER                                NO-UNDO.
    DEF VAR v_vltotinf   AS DECIMAL                                NO-UNDO.
    DEF VAR v_vltotcpt   AS DECIMAL                                NO-UNDO.
    DEF VAR v_vltotdif   AS DECIMAL                                NO-UNDO.
    DEF VAR v_cmc7       AS CHARACTER                              NO-UNDO.
    DEF VAR aux_vlrproc  AS DECIMAL                                NO-UNDO.
    DEF VAR aux_erro_env AS LOGICAL INIT FALSE                     NO-UNDO.
    DEF VAR aux_erro_vlr AS LOGICAL INIT FALSE                     NO-UNDO.
    DEF VAR p-nro-docto  AS INTEGER                                NO-UNDO.
    DEF VAR p-nro-lote   AS INTEGER                                NO-UNDO.
    DEF VAR v_dinheiro   AS CHARACTER                              NO-UNDO.
    DEF VAR v_cheque     AS CHARACTER                              NO-UNDO.
    
    DEF BUFFER crabcop FOR crapcop.
    
    DEFINE TEMP-TABLE w-craperr  NO-UNDO
           FIELD cdagenci   LIKE craperr.cdagenc
           FIELD nrdcaixa   LIKE craperr.nrdcaixa
           FIELD nrsequen   LIKE craperr.nrsequen
           FIELD cdcritic   LIKE craperr.cdcritic
           FIELD dscritic   LIKE craperr.dscritic
           FIELD erro       LIKE craperr.erro.

    DEF TEMP-TABLE ab_unmap
        FIELD v_coop      AS CHAR
        FIELD v_pac       AS CHAR
        FIELD v_caixa     AS CHAR
        FIELD v_operador  AS CHAR
        FIELD v_data      AS CHAR
        FIELD v_deschist  AS CHAR
        FIELD vh_foco     AS CHAR
        FIELD v_msg       AS CHAR.

    /* temp-table também usada na b1crap61 */
    DEFINE TEMP-TABLE tt-depositos-env NO-UNDO
        FIELD nrsequen AS INTE
        FIELD cdcopdst AS INTE
        FIELD nmcopdst AS CHAR
        FIELD nrdconta AS INTE
        FIELD nrconfer AS INTE
        FIELD vlinform AS DECI
        FIELD vlcomput AS DECI
        FIELD dssituac AS CHAR
        FIELD dtlibcom AS DATE
        INDEX tt-depositos-env1 nrsequen.
        
    CREATE ab_unmap.

    {include/i-global.i}

    ASSIGN v_conta      = GET-VALUE("v_pconta")
           v_nome       = GET-VALUE("v_pnome")
           aux_nmcopdst = GET-VALUE("v_pcopdst")
           v_poupanca   = GET-VALUE("v_ppoup")
           v_identifica = GET-VALUE("v_pidentifica")
           v_caixa      = GET-VALUE("User_cx")
           v_operador   = GET-VALUE("operador")
           v_pac        = GET-VALUE("User_pac")
           v_coop       = get-value("user_coop") 
           v_nrterfin   = get-value("v_nrterfin") 
           v_dtmvtoltC   = get-value("v_dtmvtoltC") 
           v_nrsequniC   = get-value("v_nrsequniC") 
           v_dtmvtoltD   = get-value("v_dtmvtoltD")
           v_nrsequniD   = get-value("v_nrsequniD")  
           v_valorcomput = get-value("v_valorcomput")
           v_altcompt    = get-value("v_altcompt")
           v_valorproc   = get-value("v_valorproc")
           v_valor1      = get-value("v_valor1")
           v_at_compt    = get-value("v_at_compt")
           v_id_compt    = get-value("v_id_compt")
           v_at_situa    = get-value("v_at_situa")
           v_valor2      = get-value("v_valor2")
           v_valor       = get-value("v_valor")
           v_cmc7        = get-value("v_cmc7")
           v_dsterfin    = get-value("v_dsterfin")
           v_coop-migrada    = GET-VALUE("p-coop-migrada")
           v_nro-conta-nova  = GET-VALUE("p-nro-conta-nova")
           v_nro-conta-anti  = GET-VALUE("p-nro-conta-anti")
           v_flg-cta-migrada = GET-VALUE("p-flg-cta-migrada")
           v_flg-coop-host   = GET-VALUE("p-flg-coop-host")
           aux_tipo = 1 NO-ERROR.

    ASSIGN p-flg-cta-migrada = LOGICAL(v_flg-cta-migrada)
           p-flg-coop-host   = LOGICAL(v_flg-coop-host)
           p-coop-migrada    = v_coop-migrada
           p-nro-conta-nova  = INTE(v_nro-conta-nova)
           p-nro-conta-anti  = INTE(v_nro-conta-anti) NO-ERROR.

    /* Criada para o JavaScript nao ficar com o código feio */
    PROCEDURE JavaScript:

        {include/monta_js.i} /* Utilizada includes pois o programa não compila*/
        
    END PROCEDURE.    
    
    IF REQUEST_METHOD = "POST":U  THEN  
       DO:
          IF NOT VALID-HANDLE(h-b1crap00) THEN
             RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
       
          RUN valida-transacao2 IN h-b1crap00(INPUT v_coop,
                                             INPUT v_pac,
                                             INPUT v_caixa).
       
          IF VALID-HANDLE(h-b1crap00) THEN
             DELETE PROCEDURE h-b1crap00.
          
          IF RETURN-VALUE = "NOK" THEN 
             DO:
                 FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                          craperr.cdagenci = INT(v_pac)       AND
                                          craperr.nrdcaixa = INT(v_caixa) 
                                          NO-LOCK NO-ERROR.
                                          
                 IF AVAIL craperr  THEN
                    RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").

             END.
          ELSE 
             DO:
                IF NOT VALID-HANDLE(h-b1crap00) THEN
                   RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
             
                RUN verifica-abertura-boletim IN h-b1crap00(INPUT v_coop,
                                                            INPUT v_pac,
                                                            INPUT v_caixa,
                                                            INPUT v_operador).
             
                IF VALID-HANDLE(h-b1crap00) THEN
                   DELETE PROCEDURE h-b1crap00.
                
                IF RETURN-VALUE = "NOK"  THEN 
                   DO:
                      FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                               craperr.cdagenci = INT(v_pac)       AND
                                               craperr.nrdcaixa = INT(v_caixa) 
                                               NO-LOCK NO-ERROR.
                                               
                      IF AVAIL craperr  THEN
                         RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
             
                   END.
                ELSE
                   DO:
                      IF get-value("v_nrterfin") <> " "  THEN
                         DO:
                            IF NOT VALID-HANDLE(h-b1crap61) THEN
                               RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                         
                            RUN busca_nome_taa IN h-b1crap61 (INPUT v_coop,
                                                              INPUT v_pac,
                                                              INPUT v_caixa,
                                                              INPUT v_nrterfin,
                                                              OUTPUT v_dsterfin).
                   
                            IF VALID-HANDLE(h-b1crap61) THEN
                               DELETE PROCEDURE h-b1crap61.
                            
                            IF RETURN-VALUE = "NOK" THEN 
                               DO:
                                  ASSIGN v_nrterfin = "".
                   
                                  FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                           craperr.cdagenci = INT(v_pac)       AND
                                                           craperr.nrdcaixa = INT(v_caixa)
                                                           NO-LOCK NO-ERROR.
                                                           
                                  IF AVAIL craperr  THEN
                                     RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                      
                               END.
                            ELSE
                               DO:
                                  ASSIGN vh_foco = "11".
                                  
                                  /* Clicou em algum dos botoes dinheiro/cheque */
                                  IF get-value("v_dscopcao") <> " " THEN
                                     DO: 
                                        ASSIGN v_dtmvtoltC   = "" 
                                               v_nrsequniC   = ""
                                               v_dtmvtoltD   = ""
                                               v_nrsequniD   = ""
                                               v_valorcomput = ""
                                               v_altcompt    = ""
                                               v_at_compt    = ""
                                               v_id_compt    = ""
                                               v_at_situa    = ""
                                               v_valorproc   = ""
                                               v_valor1      = ""
                                               v_valor2      = ""
                                               v_valor       = ""
                                               v_cmc7        = ""
                                               v_conta       = ""
                                               v_nome        = ""
                                               aux_nmcopdst  = "".
                                                                                                            
                                        FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                               crapmdw.cdagenci = INT(v_pac)       AND
                                                               crapmdw.nrdcaixa = INT(v_caixa)     
                                                               EXCLUSIVE-LOCK:
                   
                                            DELETE crapmdw.
                   
                                        END.            

                                        FOR EACH crapmrw WHERE crapmrw.cdcooper = crapcop.cdcooper AND
                                                              crapmrw.cdagenci = INT(v_pac)       AND
                                                              crapmrw.nrdcaixa = INT(v_caixa) 
                                                              EXCLUSIVE-LOCK:
                                     
                                           DELETE crapmrw.
                                     
                                       END.
                               
                                        IF get-value("v_dscopcao") = "cheque"  THEN
                                           DO:
                                              IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                 RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                               
                                              RUN gera-tabela-resumo-cheques IN h-b1crap51(INPUT v_coop,
                                                                                           INPUT INT(v_pac),
                                                                                           INPUT INT(v_caixa),
                                                                                           INPUT v_operador,
                                                                                           INPUT INT(v_conta)).

                                              IF VALID-HANDLE(h-b1crap51) THEN
                                                 DELETE PROCEDURE h-b1crap51.
                               
                                           END.

                                     END.
                                  ELSE
                                     DO:
                                        /* preencheu conferencia e data de cheque */
                                        IF v_nrsequniC <> " "  AND
                                           v_dtmvtoltC <> " "  THEN
                                           DO:
                                              IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                 RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                           
                                               RUN verifica_envelope IN h-b1crap61(INPUT  v_coop,
                                                                                   INPUT  v_pac,
                                                                                   INPUT  v_caixa,
                                                                                   INPUT  date(v_dtmvtoltC),
                                                                                   INPUT  v_nrsequniC,
                                                                                   INPUT  v_nrterfin,
                                                                                   INPUT  FALSE, /* cheque */
                                                                                   OUTPUT v_nrdocmto,
                                                                                   OUTPUT aux_nmcopdst,
                                                                                   OUTPUT v_conta,
                                                                                   OUTPUT v_nome,
                                                                                   OUTPUT v_valor,
                                                                                   OUTPUT v_valor1).
                                           
                                              IF VALID-HANDLE(h-b1crap61) THEN
                                                 DELETE PROCEDURE h-b1crap61.
                                              
                                              ASSIGN aux_tipo = 2.
                                           
                                              IF RETURN-VALUE <> "OK"  THEN
                                                 ASSIGN aux_erro_env = TRUE
                                                        v_nrsequniC  = "".
                                           
                                              IF v_altcompt = "sim"  THEN
                                                 DO:                                                                     
                                                    /* limpar dados */
                                                    FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                           crapmdw.cdagenci = INT(v_pac)       AND
                                                                           crapmdw.nrdcaixa = INT(v_caixa)     
                                                                           EXCLUSIVE-LOCK:
                                                        DELETE crapmdw.
                   
                                                    END.                                                                  
                                                 
                                                    ASSIGN v_valorcomput = v_valor1
                                                           v_altcompt    = "nao".
                   
                                                 END.
                                           
                                           END.
                                        ELSE
                                           /* preencheu data de dinheiro */
                                           IF  v_dtmvtoltD <> ""  THEN
                                               DO:
                                                  FIND FIRST crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                           crapmdw.cdagenci = INT(v_pac)       AND
                                                                           crapmdw.nrdcaixa = INT(v_caixa)     
                                                                           NO-LOCK NO-ERROR.

                                                  IF  NOT AVAIL crapmdw THEN
                                                      DO:
                                                          IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                             RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                                      
                                                          RUN grava_dados_envelope IN h-b1crap61(INPUT v_coop,
                                                                                                 INPUT v_pac,
                                                                                                 INPUT v_caixa,
                                                                                                 INPUT DATE(v_dtmvtoltD),
                                                                                                 INPUT v_nrsequniD,
                                                                                                 INPUT v_nrterfin,
                                                                                                 INPUT TRUE). /* dinheiro */
                                                      
                                                          IF VALID-HANDLE(h-b1crap61) THEN
                                                             DELETE PROCEDURE h-b1crap61.
                                                      
                                                          ASSIGN aux_tipo = 1
                                                                 v_nrsequniD = "".
                   
                                                      END.
                                               END.
                                        
                                        /* caso retorne erro mostra */
                                        IF RETURN-VALUE = "NOK"  THEN 
                                           DO:
                                              FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                       craperr.cdagenci = INT(v_pac)       AND
                                                                       craperr.nrdcaixa = INT(v_caixa) 
                                                                       NO-LOCK NO-ERROR.
                                                                       
                                              IF AVAIL craperr  THEN
                                                 RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                           
                                           END.
                                        
                                        /* se apertou botao para processar dinheiro */
                                        IF get-value("v_dinheiro") <> " "  THEN
                                           DO:
                                              IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                 RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                           
                                              IF NOT VALID-HANDLE(h-b1crap22) THEN
                                                 RUN dbo/b1crap22.p PERSISTENT SET h-b1crap22.
                                           
                                              ASSIGN aux_contador = INTEGER(get-value("vh_qtdenvel")).
                                              
                                              DO WHILE (aux_contador > 0):
                                                 
                                                 /* se o envelope foi marcado para descarte */
                                                 IF get-value("v_flgsitua" + STRING(aux_contador)) = "Descartado"  THEN
                                                    DO:
                                                        RUN descarta_envelope IN h-b1crap61 (INPUT v_coop,
                                                                                             INPUT v_pac,
                                                                                             INPUT v_caixa,
                                                                                             INPUT DATE(get-value("v_dtlibcom" + STRING(aux_contador))),
                                                                                             INPUT get-value("v_nrconfer" + STRING(aux_contador))).
                                                    END.
                                                 ELSE
                                                    DO:
                                                       /* caso contrario faz o deposito do envelope */
                                                       ASSIGN aux_nmcopdst = get-value("v_nmcopdst" + STRING(aux_contador))
                                                              aux_nrctadst = INTEGER(get-value("v_nrctadst" + STRING(aux_contador)))
                                                              aux_nmcopdst = TRIM(ENTRY(1,aux_nmcopdst,"-")).
                                                       
                                                       IF aux_nmcopdst =  v_coop THEN
                                                          RUN deposita_envelope_dinheiro IN h-b1crap61(INPUT v_coop,
                                                                                                       INPUT v_pac,
                                                                                                       INPUT v_caixa,
                                                                                                       INPUT v_operador,
                                                                                                       INPUT aux_nmcopdst,
                                                                                                       INPUT v_conta,    
                                                                                                       INPUT "Deposito de envelope CONFERENCIA " + get-value("v_nrconfer" + STRING(aux_contador)),   
                                                                                                       INPUT DATE(get-value("v_dtlibcom" + STRING(aux_contador))),
                                                                                                       INPUT get-value("v_nrconfer" + STRING(aux_contador)),
                                                                                                       INPUT DECI(get-value("v_vlcomput" + STRING(aux_contador)))).
                                                       ELSE
                                                          RUN deposita_envelope_dinheiro IN h-b1crap61(INPUT v_coop,
                                                                                                       INPUT v_pac,
                                                                                                       INPUT v_caixa,
                                                                                                       INPUT v_operador,
                                                                                                       INPUT aux_nmcopdst,
                                                                                                       INPUT aux_nrctadst,    
                                                                                                       INPUT "Deposito de envelope CONFERENCIA " + get-value("v_nrconfer" + STRING(aux_contador)),   
                                                                                                       INPUT DATE(get-value("v_dtlibcom" + STRING(aux_contador))),
                                                                                                       INPUT get-value("v_nrconfer" + STRING(aux_contador)),
                                                                                                       INPUT DECI(get-value("v_vlcomput" + STRING(aux_contador)))).
                                                       
                                                    END.
                                           
                                                 /* se retornou erro, mostra na tela */
                                                 IF RETURN-VALUE = "NOK"  THEN 
                                                    DO: 
                                                       /*Busca a mensagem de erro*/
                                                       FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                craperr.cdagenci = INT(v_pac)       AND
                                                                                craperr.nrdcaixa = INT(v_caixa) 
                                                                                NO-LOCK NO-ERROR.
                                                       
                                                       /*Apresenta o erro na tela*/
                                                       IF AVAIL craperr THEN
                                                          RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                           
                                                       /* Devido ao envelope em questao ter gerado um erro em seu processamento,
                                                          serao buscados todos os envelopes que ainda faltam processar inclusive,
                                                          o que teve erro para ser apresentado em tela.*/
                                                       RUN busca_envelopes_deposito IN h-b1crap61(INPUT v_coop,
                                                                                                  INPUT v_pac,
                                                                                                  INPUT v_caixa,
                                                                                                  INPUT aux_tipo,
                                                                                                  INPUT v_id_compt,
                                                                                                  INPUT v_at_compt,
                                                                                                  INPUT v_at_situa,
                                                                                                  OUTPUT TABLE tt-depositos-env).
                                                 
                                                       IF v_id_compt <> "" THEN
                                                          ASSIGN v_id_compt = ""
                                                                 v_at_compt = ""
                                                                 v_at_situa = "".
                                                
                                                       /*Sai fora do contador para retornar a tela, apresentar o erro
                                                         e mostrar os envelopes que ainda faltan processar.*/
                                                       LEAVE.
                                                       
                                                    END.
                                                 ELSE
                                                    /*Para cada envelope processado corretamente sera excluido seu respectivo
                                                      registro na crapmdw para que este, nao seja listado em tela caso
                                                      o processo seja parado para listar os envelopes com erro e pendentes.*/
                                                    FOR FIRST crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                            crapmdw.cdagenci = INT(v_pac)       AND
                                                                            crapmdw.nrdcaixa = INT(v_caixa)     AND
                                                                            crapmdw.nrcheque = INT(get-value("v_nrconfer" + STRING(aux_contador)))
                                                                            EXCLUSIVE-LOCK.
                                                                             
                                                        DELETE crapmdw.

                                                    END.
                                                 
                                                 ASSIGN aux_contador = aux_contador - 1.
                                                  
                                              END.
                                           
                                              IF VALID-HANDLE(h-b1crap61) THEN
                                                 DELETE PROCEDURE h-b1crap61.
                                           
                                              IF VALID-HANDLE(h-b1crap22) THEN
                                                 DELETE PROCEDURE h-b1crap22.
                                           
                                              /* Retorna para a tela inicial somente se todos
                                                 os envolopes foram efetuados com sucesso. Do contrario
                                                 apresenta todos os envelopes pendentes. */
                                              IF aux_contador = 0 THEN
                                                 RUN JavaScript("window.location='crap061.w';").
                                           
                                           END. /* fim processar dinheiro */
                                        ELSE
                                           DO:
                                              /* se apertou no botao descartar e informou dados do envelope para descarte */
                                              IF get-value("v_descachq") = "v_descartar" AND
                                                 v_nrsequniC <> " "                      AND
                                                 v_dtmvtoltC <> " "                      THEN
                                                 DO:
                                                    IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                       RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                                 
                                                    RUN descarta_envelope IN h-b1crap61 (INPUT v_coop,
                                                                                         INPUT v_pac,
                                                                                         INPUT v_caixa,
                                                                                         INPUT date(v_dtmvtoltC),
                                                                                         INPUT v_nrsequniC).
                   
                                                    IF VALID-HANDLE(h-b1crap61) THEN
                                                       DELETE PROCEDURE h-b1crap61.
                                                 
                                                    IF RETURN-VALUE = "NOK"  THEN 
                                                       DO:
                                                          FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                   craperr.cdagenci = INT(v_pac)       AND
                                                                                   craperr.nrdcaixa = INT(v_caixa) 
                                                                                   NO-LOCK NO-ERROR.
                   
                                                          IF AVAIL craperr  THEN
                                                             RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                                       
                                                       END.
                                                    ELSE 
                                                       RUN JavaScript("window.location='crap061.w'").
                                                        
                                                 END.
                                              ELSE
                                                 /* se cliclou no botao para processar o envelope de cheque */
                                                 IF get-value("v_prosschq") = "v_cheque"  THEN
                                                    DO: 
                                                       IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                          RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                                    
                                                       /* alimentar a tabela de resumo */
                                                       RUN gera-tabela-resumo-cheques IN h-b1crap51(INPUT v_coop,
                                                                                                    INPUT INT(v_pac),
                                                                                                    INPUT INT(v_caixa),
                                                                                                    INPUT v_operador,
                                                                                                    INPUT INT(v_conta)).
                                                       
                                                       IF VALID-HANDLE(h-b1crap51) THEN
                                                          DELETE PROCEDURE h-b1crap51.
                                                    
                                                       /* caso conta foi transferida, pega o numero da nova conta */
                                                       DO WHILE TRUE:
                                                    
                                                          FIND FIRST crabcop WHERE crabcop.nmrescop = TRIM(ENTRY(1,aux_nmcopdst,"-"))
                                                                             NO-LOCK NO-ERROR.
                                                                             
                                                          IF  NOT AVAIL crabcop THEN
                                                              LEAVE.
                                                              
                                                          FIND FIRST crapass WHERE crapass.cdcooper = crabcop.cdcooper AND
                                                                                   crapass.nrdconta = INT(v_conta) 
                                                                                   NO-LOCK NO-ERROR.
                                                    
                                                          IF NOT AVAIL crapass THEN
                                                             LEAVE.
                                                    
                                                          IF AVAIL crapass THEN 
                                                             DO:
                                                                IF CAN-DO("2,4,6,8",STRING(crapass.cdsitdtl))   THEN  
                                                                   DO:
                                                                      FIND FIRST craptrf WHERE craptrf.cdcooper = crapass.cdcooper AND
                                                                                               craptrf.nrdconta = crapass.nrdconta AND
                                                                                               craptrf.tptransa = 1                AND
                                                                                               craptrf.insittrs = 2 
                                                                                               NO-LOCK USE-INDEX craptrf1 NO-ERROR.
                                                    
                                                                      IF AVAIL craptrf THEN
                                                                         ASSIGN v_conta = STRING(craptrf.nrsconta).
                                                                      ELSE
                                                                         LEAVE.
                                                                   END.
                                                                ELSE
                                                                   LEAVE.       
                                                             END.
                                                       END.
                                                           
                                                       /* efetua o deposito na conta-corrente do cooperado do envelope e autentica cheques coop */
                                                       DO TRANSACTION ON ERROR UNDO:
                                                    
                                                          IF NOT VALID-HANDLE(h-b1crap22) THEN
                                                             RUN dbo/b1crap22.p PERSISTENT SET h-b1crap22.
                   
                                                          IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                             RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                                             
                                                          ASSIGN aux_nmcopdst = TRIM(ENTRY(1,aux_nmcopdst,"-"))
                                                                 v_identifica = "Deposito de envelope".
                                                    
                                                          IF v_flg-cta-migrada = "no"  THEN 
                                                             DO:
                                                                IF aux_nmcopdst =  v_coop THEN 
                                                                   DO:
                                                                      RUN atualiza-deposito-com-captura IN h-b1crap51(INPUT v_coop,
                                                                                                                      INPUT INT(v_pac),
                                                                                                                      INPUT INT(v_caixa),
                                                                                                                      INPUT v_operador,
                                                                                                                      INPUT INT(v_conta),
                                                                                                                      INPUT v_nome,
                                                                                                                      INPUT v_identifica,
                                                                                                                      INPUT v_pestorno,
                                                                                                                      OUTPUT p-literal,
                                                                                                                      OUTPUT p-ult-sequencia,
                                                                                                                      OUTPUT p-nro-docto).
                                                                   END.
                                                                ELSE 
                                                                   DO:
                                                                      RUN realiza-deposito-cheque IN h-b1crap22 (INPUT v_coop,                
                                                                                                                 INPUT INT(v_pac),
                                                                                                                 INPUT INT(v_caixa),
                                                                                                                 INPUT v_operador,
                                                                                                                 INPUT aux_nmcopdst,
                                                                                                                 INPUT INT(v_conta), /* Cta Para*/
                                                                                                                 INPUT 0,
                                                                                                                 INPUT 0, /*v_valorproc,*/
                                                                                                                 INPUT v_identifica,
                                                                                                                 INPUT FALSE,
                                                                                                                 OUTPUT p-nro-docto,
                                                                                                                 OUTPUT p-literal,
                                                                                                                 OUTPUT p-ult-sequencia).
                                                                   END.
                                                             END.
                                                          ELSE 
                                                             DO: 
                                                                IF v_flg-coop-host = "no"  THEN 
                                                                   DO:
                                                                      IF aux_nmcopdst =  v_coop THEN
                                                                         RUN atualiza-deposito-com-captura-migrado IN h-b1crap51(INPUT v_coop,
                                                                                                                                 INPUT v_coop-migrada,
                                                                                                                                 INPUT INT(v_pac),
                                                                                                                                 INPUT INT(v_caixa),
                                                                                                                                 INPUT v_operador,
                                                                                                                                 INPUT INT(v_conta),
                                                                                                                                 INPUT v_nome,
                                                                                                                                 INPUT v_identifica,
                                                                                                                                 INPUT INT(v_nro-conta-nova),
                                                                                                                                 INPUT INT(v_nro-conta-anti),
                                                                                                                                 INPUT v_pestorno,
                                                                                                                                 OUTPUT p-literal,
                                                                                                                                 OUTPUT p-ult-sequencia,
                                                                                                                                 OUTPUT p-nro-docto).
                                                                      ELSE
                                                                         RUN realiza-deposito-cheque-migrado IN h-b1crap22 (INPUT v_coop,
                                                                                                                            INPUT v_coop-migrada,
                                                                                                                            INPUT INT(v_pac),
                                                                                                                            INPUT INT(v_caixa),
                                                                                                                            INPUT v_operador,
                                                                                                                            INPUT aux_nmcopdst,
                                                                                                                            INPUT INT(v_conta), /* Cta Para*/
                                                                                                                            INPUT 0,
                                                                                                                            INPUT 0, /*v_valorproc,*/
                                                                                                                            INPUT v_identifica,
                                                                                                                            INPUT FALSE,
                                                                                                                            OUTPUT p-nro-docto,
                                                                                                                            OUTPUT p-literal,
                                                                                                                            OUTPUT p-ult-sequencia).
                                                                   END.
                                                                ELSE 
                                                                   DO:  
                                                                      IF aux_nmcopdst =  v_coop THEN
                                                                         RUN atualiza-deposito-com-captura-migrado-host IN h-b1crap51(INPUT v_coop,
                                                                                                                                      INPUT v_coop-migrada,
                                                                                                                                      INPUT INT(v_pac),
                                                                                                                                      INPUT INT(v_caixa),
                                                                                                                                      INPUT v_operador,
                                                                                                                                      INPUT INT(v_conta),
                                                                                                                                      INPUT v_nome,
                                                                                                                                      INPUT v_identifica,
                                                                                                                                      INPUT INT(v_nro-conta-nova),
                                                                                                                                      INPUT INT(v_nro-conta-anti),
                                                                                                                                      INPUT v_pestorno,
                                                                                                                                      OUTPUT p-literal,
                                                                                                                                      OUTPUT p-ult-sequencia,
                                                                                                                                      OUTPUT p-nro-docto).
                                                                      ELSE
                                                                         RUN realiza-deposito-cheque-migrado-host IN h-b1crap22 (INPUT v_coop,
                                                                                                                                 INPUT v_coop-migrada,
                                                                                                                                 INPUT INT(v_pac),
                                                                                                                                 INPUT INT(v_caixa),
                                                                                                                                 INPUT v_operador,
                                                                                                                                 INPUT aux_nmcopdst,
                                                                                                                                 INPUT INT(v_conta), /* Cta Para*/
                                                                                                                                 INPUT 0,
                                                                                                                                 INPUT 0, /*v_valorproc,*/
                                                                                                                                 INPUT v_identifica,
                                                                                                                                 INPUT FALSE,
                                                                                                                                 OUTPUT p-nro-docto,
                                                                                                                                 OUTPUT p-literal,
                                                                                                                                 OUTPUT p-ult-sequencia).

                                                                   END.

                                                             END.
                                                    
                                                          IF VALID-HANDLE(h-b1crap22) THEN
                                                             DELETE PROCEDURE h-b1crap22.
                   
                                                          IF VALID-HANDLE(h-b1crap51) THEN
                                                             DELETE PROCEDURE h-b1crap51.
                                                    
                                                          /* Em caso de erro alimenta temp-table para gerar erro apos acertar dados da crapmdw */
                                                          IF RETURN-VALUE <> "OK" THEN 
                                                             DO:
                                                                ASSIGN l-houve-erro = YES.
                                                    
                                                                EMPTY TEMP-TABLE w-craperr.
                                                    
                                                                FOR EACH craperr WHERE craperr.cdcooper =  crapcop.cdcooper AND
                                                                                       craperr.cdagenci =  INT(v_pac)       AND
                                                                                       craperr.nrdcaixa =  INT(v_caixa)  
                                                                                       NO-LOCK:
                   
                                                                    CREATE w-craperr.
                   
                                                                    ASSIGN w-craperr.cdagenci   = craperr.cdagenc
                                                                           w-craperr.nrdcaixa   = craperr.nrdcaixa
                                                                           w-craperr.nrsequen   = craperr.nrsequen
                                                                           w-craperr.cdcritic   = craperr.cdcritic
                                                                           w-craperr.dscritic   = craperr.dscritic
                                                                           w-craperr.erro       = craperr.erro.
                                                    
                                                                END.
                                                    
                                                                FIND LAST w-craperr NO-LOCK NO-ERROR.
                                                    
                                                                UNDO, LEAVE.
                   
                                                             END.
                                                          ELSE
                                                             /* liberar o envelope se nao houver erros nos deposito */
                                                             DO:
                                                                IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                                   RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                                             
                                                                RUN libera_envelope IN h-b1crap61(INPUT v_coop,
                                                                                                  INPUT INT(v_pac),
                                                                                                  INPUT INT(v_caixa),
                                                                                                  INPUT DATE(v_dtmvtoltC),
                                                                                                  INPUT INT(v_nrsequniC),
                                                                                                  INPUT p-ult-sequencia).
                   
                                                                IF VALID-HANDLE(h-b1crap61) THEN
                                                                   DELETE PROCEDURE h-b1crap61.
                   
                                                                /* se houver erro na liberacao alimenta temp-table para mostrar erro */
                                                                IF RETURN-VALUE <> "OK" THEN 
                                                                   DO:
                                                                      ASSIGN l-houve-erro = YES.
                                                             
                                                                      EMPTY TEMP-TABLE w-craperr.
                                                             
                                                                      FOR EACH craperr WHERE craperr.cdcooper =  crapcop.cdcooper  AND
                                                                                             craperr.cdagenci =  INT(v_pac)        AND
                                                                                             craperr.nrdcaixa =  INT(v_caixa)  
                                                                                             NO-LOCK:
                                                             
                                                                          CREATE w-craperr.
                   
                                                                          ASSIGN w-craperr.cdagenci   = craperr.cdagenc
                                                                                 w-craperr.nrdcaixa   = craperr.nrdcaixa
                                                                                 w-craperr.nrsequen   = craperr.nrsequen
                                                                                 w-craperr.cdcritic   = craperr.cdcritic
                                                                                 w-craperr.dscritic   = craperr.dscritic
                                                                                 w-craperr.erro       = craperr.erro.
                   
                                                                      END.
                                                             
                                                                      FIND LAST w-craperr NO-LOCK NO-ERROR.
                                                             
                                                                      UNDO.
                   
                                                                   END.
                                                             
                                                             END.
                                                    
                                                       END. /* Final da Transacao*/
                                                    
                                                       /* se houve erro em na liberacao do envelope ou no deposito dos cheques mostra tela */
                                                       IF l-houve-erro = YES  THEN 
                                                          DO:
                                                             IF CAN-FIND(FIRST crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                                             crapmdw.cdagenci = INT(v_pac)       AND
                                                                                             crapmdw.nrdcaixa = INT(v_caixa)     AND
                                                                                             crapmdw.cdhistor = 386)  THEN 
                                                                RUN reinicia-crapmdw IN THIS-PROCEDURE(INPUT INT(v_pac),
                                                                                                       INPUT INT(v_caixa)).
                                                    
                                                             FOR EACH craperr WHERE craperr.cdcooper = crapcop.cdcooper  AND
                                                                                    craperr.cdagenci = INTE(v_pac)       AND
                                                                                    craperr.nrdcaixa = INTE(v_caixa)
                                                                                    EXCLUSIVE-LOCK:
                                                                                    
                                                                 DELETE craperr.
                                                    
                                                             END.
                                                    
                                                             FOR EACH w-craperr NO-LOCK:
                                                    
                                                                 CREATE craperr.
                                                    
                                                                 ASSIGN craperr.cdcooper   = crapcop.cdcooper
                                                                        craperr.cdagenci   = w-craperr.cdagenc
                                                                        craperr.nrdcaixa   = w-craperr.nrdcaixa
                                                                        craperr.nrsequen   = w-craperr.nrsequen
                                                                        craperr.cdcritic   = w-craperr.cdcritic
                                                                        craperr.dscritic   = w-craperr.dscritic
                                                                        craperr.erro       = w-craperr.erro.
                                                    
                                                                 VALIDATE craperr.
                                                    
                                                             END.
                                                    
                                                             ASSIGN vh_foco = "24".
                                                    
                                                             FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                      craperr.cdagenci = INT(v_pac)       AND
                                                                                      craperr.nrdcaixa = INT(v_caixa) 
                                                                                      NO-LOCK NO-ERROR.
                                                    
                                                             IF AVAIL craperr  THEN
                                                                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                                    
                                                          END. /* Final do IF erro YES */
                                                       ELSE
                                                          DO: 
                                                             /* se haver algum cheque para previa, marca-o para passar na previa */
                                                             ASSIGN aux_achou = FALSE.
                                                    
                                                             FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                                    crapmdw.cdagenci = INT(v_pac)       AND
                                                                                    crapmdw.nrdcaixa = INT(v_caixa) 
                                                                                    NO-LOCK:
                                                    
                                                                 FIND FIRST crapfdc WHERE crapfdc.cdcooper = crapmdw.cdcooper AND
                                                                                          crapfdc.cdbanchq = crapmdw.cdbanchq AND
                                                                                          crapfdc.cdagechq = crapmdw.cdagechq AND
                                                                                          crapfdc.nrctachq = crapmdw.nrctabdb AND
                                                                                          crapfdc.nrcheque = crapmdw.nrcheque 
                                                                                          NO-LOCK NO-ERROR.
                                                    
                                                                 IF AVAIL crapfdc THEN
                                                                    ASSIGN aux_achou = TRUE.
                                                    
                                                             END.
                                                    
                                                             IF NOT aux_achou THEN
                                                                DO:
                                                                   IF NOT VALID-HANDLE(h-b1crap00) THEN
                                                                      RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
                                                    
                                                                   RUN atualiza-previa-caixa IN h-b1crap00(INPUT v_coop,
                                                                                                           INPUT INT(v_pac),
                                                                                                           INPUT INT(v_caixa),
                                                                                                           INPUT v_operador,
                                                                                                           INPUT v_data,
                                                                                                           INPUT 3). /*Consulta*/ 
                                                    
                                                                   IF RETURN-VALUE = "NOK" THEN 
                                                                      DO:
                                                                         FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                                  craperr.cdagenci = INT(v_pac)       AND
                                                                                                  craperr.nrdcaixa = INT(v_caixa) 
                                                                                                  NO-LOCK NO-ERROR.
                                                                         
                                                                         IF AVAIL craperr  THEN
                                                                            RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                                                      END.
                                                    
                                                                   IF VALID-HANDLE(h-b1crap00) THEN
                                                                      DELETE PROCEDURE h-b1crap00. 
                                                    
                                                                END.
                                                             
                                                             /* limpar registro temporarios de deposito do cheque */
                                                             FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                                                    crapmdw.cdagenci = INT(v_pac)       AND
                                                                                    crapmdw.nrdcaixa = INT(v_caixa)     
                                                                                    EXCLUSIVE-LOCK:
                                                    
                                                                 DELETE crapmdw.
                                                    
                                                             END.
                                                    
                                                             FOR EACH crapmrw WHERE crapmrw.cdcooper = crapcop.cdcooper AND
                                                                                    crapmrw.cdagenci = INT(v_pac)       AND
                                                                                    crapmrw.nrdcaixa = INT(v_caixa) 
                                                                                    EXCLUSIVE-LOCK:
                                                    
                                                                 DELETE crapmrw.
                                                    
                                                             END.
                                                    
                                                             /* redireciona para o inicio da tela */
                                                             RUN JavaScript("window.location='crap061.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_dtenvelo=" + v_dtmvtoltC + "&p-flg-cta-migrada=" + v_flg-cta-migrada + "&p-flg-coop-host=" + v_flg-coop-host + "&p-coop-migrada=" + p-coop-migrada + "&v_nrterfin=" + v_nrterfin + "&v_dsterfin=" + v_dsterfin + "&v_dtmvtoltC=" + v_dtmvtoltC + "'").
                                                    
                                                          END. /* Final do IF erro NO */
                                                    
                                                    END. /* final v_cheque */
                                                 ELSE
                                                    DO:
                                                        IF NOT VALID-HANDLE(h-b1crap61) THEN
                                                           RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                                    
                                                        /* buscar dados dos envelope(s) */
                                                        RUN busca_envelopes_deposito IN h-b1crap61 (INPUT v_coop,
                                                                                                    INPUT v_pac,
                                                                                                    INPUT v_caixa,
                                                                                                    INPUT aux_tipo,
                                                                                                    INPUT v_id_compt,
                                                                                                    INPUT v_at_compt,
                                                                                                    INPUT v_at_situa,
                                                                                                    OUTPUT TABLE tt-depositos-env).
                                                    
                                                        IF v_id_compt <> ""  THEN
                                                           ASSIGN v_id_compt = ""
                                                                  v_at_compt = ""
                                                                  v_at_situa = "".

                                                        IF v_dtmvtoltC <> ""  THEN
                                                           DO:
                                                               ASSIGN aux_vlrproc = 0.
                   
                                                               FOR EACH tt-depositos-env NO-LOCK:

                                                                   ASSIGN aux_vlrproc = aux_vlrproc + tt-depositos-env.vlcomput.

                                                               END.
                   
                                                               ASSIGN v_valorproc = TRIM(STRING(aux_vlrproc,"zzz,zzz,zzz,zz9.99-")).
                   
                                                           END.
                                                    
                                                        IF VALID-HANDLE(h-b1crap61) THEN
                                                           DELETE PROCEDURE h-b1crap61.
                   
                                                    END.
                   
                                           END. /*Fim else processa dinherio*/
                                        
                                        /* redirecionar para a tela de detalhamento de cheques, caso houver */
                                        IF get-value("v_detalhar") <> ""  THEN
                                           DO:
                                              IF aux_vlrproc > 0  THEN 
                                                 RUN JavaScript("window.location='crap061b.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor=" + STRING(v_valor) + "&v_pvalor1=" + STRING(v_valorcomput) + "&v_nrsequni=" + v_nrsequniC + "&v_dtenvelo=" + v_dtmvtoltC + "&v_vlenvelo=" + v_valor1 + "&p-flg-cta-migrada=" + v_flg-cta-migrada + "&p-coop-migrada=" + p-coop-migrada + "&p-flg-coop-host=" + v_flg-coop-host + "&v_nrterfin=" + v_nrterfin + "&v_vlcomput=" + v_valorcomput + "'").
                                              
                                           END.
                                        ELSE
                                           /* redirecionar para a tela de passagem manual do cmc7 */
                                           IF get-value("v_manual") <> " " AND
                                              v_valor2 <> " "              THEN 
                                              DO: 
                                                 IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                    RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                              
                                                 /* validar valor cheque */
                                                 RUN critica-cheque-valor-individual IN h-b1crap51(INPUT v_coop,
                                                                                                   INPUT INT(v_pac),
                                                                                                   INPUT INT(v_caixa),
                                                                                                   INPUT DEC(v_valor2)).
                   
                                                 IF VALID-HANDLE(h-b1crap51) THEN
                                                    DELETE PROCEDURE h-b1crap51.
                                                 
                                                 /* em caso de erro mostra na tela */
                                                 IF RETURN-VALUE = "NOK" THEN 
                                                    DO:
                                                       ASSIGN aux_erro_vlr = TRUE.
                                                    
                                                       FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                craperr.cdagenci = INT(v_pac)       AND
                                                                                craperr.nrdcaixa = INT(v_caixa) 
                                                                                NO-LOCK NO-ERROR.
                                                    
                                                       IF AVAIL craperr  THEN
                                                          RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                   
                                                    END.
                                                 ELSE 
                                                    DO:
                                                       /*ASSIGN aux_nmcopdst = TRIM(ENTRY(1,aux_nmcopdst,"-")).*/
                                                    
                                                       /* redirecionar para tela de digitacao manual */
                                                       RUN JavaScript("window.location='crap051a1.w" +
                                                                      "?v_pconta="      + v_conta            + 
                                                                      "&v_pcopdst="     + aux_nmcopdst       + 
                                                                      "&v_pnome="       + v_nome             + 
                                                                      "&v_ppoup= "      +
                                                                      "&v_pidentifica=Deposito de envelope CONFERENCIA " + v_nrsequniC +
                                                                      "&v_pvalor="      + v_valor            + 
                                                                      "&v_pvalor1="     + v_valorcomput      +
                                                                      "&v_pvalor2="     + v_valor2           +
                                                                      "&v_pvlcomput="   + v_valorcomput      +
                                                                      "&v_pvlenvelo="   + v_valor1           +
                                                                      "&v_pnrsequni="   + v_nrsequniC        +
                                                                      "&v_pdtenvelo="   + v_dtmvtoltC        +
                                                                      "&v_pnrterfin="   + v_nrterfin + "'").
                                                    END.
                   
                                              END. /* final do manual */
                                           ELSE 
                                              DO:             
                                                 /* caso tenha passado o cmc7 na leitora e informado o valor */
                                                 IF DECI(v_valor2) > 0             AND 
                                                    get-value("v_descachq")  = ""  AND
                                                    get-value("v_detalhar")  = ""  THEN
                                                    DO:       
                                                       IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                          RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                   
                                                       RUN critica-codigo-cheque-valor IN h-b1crap51(INPUT v_coop,
                                                                                                     INPUT INT(v_pac),
                                                                                                     INPUT INT(v_caixa),
                                                                                                     INPUT v_cmc7,
                                                                                                     INPUT DEC(v_valor2)).
                   
                                                       IF VALID-HANDLE(h-b1crap51) THEN
                                                          DELETE PROCEDURE h-b1crap51.
                                                 
                                                       IF RETURN-VALUE <> "OK" THEN  
                                                          DO:
                                                             ASSIGN aux_erro_vlr = TRUE.
                                                          
                                                             FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                      craperr.cdagenci = INT(v_pac)       AND
                                                                                      craperr.nrdcaixa = INT(v_caixa) 
                                                                                      NO-LOCK NO-ERROR.
                                                                                      
                                                             IF AVAIL craperr  THEN
                                                                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                   
                                                          END.
                                                       ELSE
                                                          DO:
                                                             IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                                RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                                             
                                                             RUN valida-codigo-cheque IN h-b1crap51(INPUT v_coop,
                                                                                                    INPUT INT(v_pac),
                                                                                                    INPUT INT(v_caixa),
                                                                                                    INPUT v_cmc7,
                                                                                                    INPUT " ",
                                                                                                    OUTPUT p-cdcmpchq,  
                                                                                                    OUTPUT p-cdbanchq,       
                                                                                                    OUTPUT p-cdagechq,       
                                                                                                    OUTPUT p-nrddigc1,       
                                                                                                    OUTPUT p-nrctabdb,       
                                                                                                    OUTPUT p-nrddigc2,       
                                                                                                    OUTPUT p-nrcheque,       
                                                                                                    OUTPUT p-nrddigc3). 
                   
                                                             IF VALID-HANDLE(h-b1crap51) THEN
                                                                DELETE PROCEDURE h-b1crap51.
                                                                                       
                                                             FOR FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper  AND
                                                                                      craperr.cdagenci = INT(v_pac)       AND
                                                                                      craperr.nrdcaixa = INT(v_caixa)     AND
                                                                                      craperr.cdcritic = 8 
                                                                                      EXCLUSIVE-LOCK:
                                                             
                                                                 DELETE craperr.

                                                             END.

                                                             IF RETURN-VALUE = "OK"  THEN 
                                                                DO:
                                                                   IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                                      RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                   
                                                                   RUN critica-contra-ordem IN h-b1crap51(INPUT v_coop,
                                                                                                          INPUT INT(v_pac),           
                                                                                                          INPUT INT(v_caixa),         
                                                                                                          INPUT v_operador,           
                                                                                                          INPUT INT(v_conta),         
                                                                                                          INPUT v_cmc7,               
                                                                                                          INPUT " ",                  
                                                                                                          INPUT p-cdcmpchq,           
                                                                                                          INPUT p-cdbanchq,           
                                                                                                          INPUT p-cdagechq,           
                                                                                                          INPUT p-nrddigc1,           
                                                                                                          INPUT p-nrctabdb,           
                                                                                                          INPUT p-nrddigc2,           
                                                                                                          INPUT p-nrcheque,           
                                                                                                          INPUT p-nrddigc3,           
                                                                                                          INPUT DEC(v_valor2),        
                                                                                                          INPUT NO,                   
                                                                                                          OUTPUT v_mensagem1,         
                                                                                                          OUTPUT v_mensagem2,         
                                                                                                          OUTPUT p-mensagem,          
                                                                                                          OUTPUT p-valor-disponivel,     
                                                                                                          OUTPUT p-flg-cta-migrada,
                                                                                                          OUTPUT p-coop-migrada,   
                                                                                                          OUTPUT p-flg-coop-host,  
                                                                                                          OUTPUT p-nro-conta-nova,
                                                                                                          OUTPUT p-nro-conta-anti). 
                                                                
                                                                   IF VALID-HANDLE(h-b1crap51) THEN
                                                                      DELETE PROCEDURE h-b1crap51.
                   
                                                                END. /* fim da critica contra-ordem */
                                                                
                                                             IF RETURN-VALUE = "OK"  THEN 
                                                                DO:
                                                                   ASSIGN v_flg-cta-migrada = STRING(p-flg-cta-migrada)
                                                                          v_coop-migrada    = STRING(p-coop-migrada)   
                                                                          v_flg-coop-host   = STRING(p-flg-coop-host)
                                                                          v_nro-conta-nova  = STRING(p-nro-conta-nova) 
                                                                          v_nro-conta-anti  = STRING(p-nro-conta-anti).
                                                                   
                                                                   IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                                      RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                                                   
                                                                   /* Validar os dados na cooperativa geradora do cheque */
                                                                   IF NOT p-flg-cta-migrada  THEN
                                                                      RUN valida-deposito-com-captura
                                                                          IN h-b1crap51(INPUT v_coop,
                                                                                        INPUT INT(v_pac),
                                                                                        INPUT INT(v_caixa),
                                                                                        INPUT v_operador,
                                                                                        INPUT " ",
                                                                                        INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                        INPUT INT(v_conta),
                                                                                        INPUT v_cmc7,
                                                                                        INPUT " ",
                                                                                        INPUT p-cdcmpchq,  
                                                                                        INPUT p-cdbanchq,       
                                                                                        INPUT p-cdagechq,       
                                                                                        INPUT p-nrddigc1,       
                                                                                        INPUT p-nrctabdb,       
                                                                                        INPUT p-nrddigc2,       
                                                                                        INPUT p-nrcheque,       
                                                                                        INPUT p-nrddigc3, 
                                                                                        INPUT DEC(v_valor2),
                                                                                        INPUT NO,
                                                                                        OUTPUT v_mensagem1,
                                                                                        OUTPUT v_mensagem2,
                                                                                        OUTPUT p-mensagem,
                                                                                        OUTPUT p-valor-disponivel).
                                                                   ELSE
                                                                      DO:
                                                                         IF NOT p-flg-coop-host  THEN
                                                                            RUN valida-deposito-com-captura-migrado
                                                                                IN h-b1crap51(INPUT v_coop,
                                                                                              INPUT p-coop-migrada,
                                                                                              INPUT INT(v_pac),
                                                                                              INPUT INT(v_caixa),
                                                                                              INPUT v_operador,
                                                                                              INPUT " ",
                                                                                              INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                              INPUT INT(v_conta),
                                                                                              INPUT v_cmc7,
                                                                                              INPUT " ",
                                                                                              INPUT p-cdcmpchq,  
                                                                                              INPUT p-cdbanchq,       
                                                                                              INPUT p-cdagechq,       
                                                                                              INPUT p-nrddigc1,       
                                                                                              INPUT p-nrctabdb,       
                                                                                              INPUT p-nrddigc2,       
                                                                                              INPUT p-nrcheque,       
                                                                                              INPUT p-nrddigc3, 
                                                                                              INPUT DEC(v_valor2),
                                                                                              INPUT NO,
                                                                                              INPUT p-nro-conta-nova,
                                                                                              INPUT p-nro-conta-anti,
                                                                                              OUTPUT v_mensagem1,
                                                                                              OUTPUT v_mensagem2,
                                                                                              OUTPUT p-mensagem,
                                                                                              OUTPUT p-valor-disponivel).
                                                                         ELSE
                                                                            RUN valida-deposito-com-captura-migrado-host
                                                                                IN h-b1crap51(INPUT v_coop,
                                                                                              INPUT p-coop-migrada,
                                                                                              INPUT INT(v_pac),
                                                                                              INPUT INT(v_caixa),
                                                                                              INPUT v_operador,
                                                                                              INPUT " ",
                                                                                              INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                              INPUT INT(v_conta),
                                                                                              INPUT v_cmc7,
                                                                                              INPUT " ",
                                                                                              INPUT p-cdcmpchq,  
                                                                                              INPUT p-cdbanchq,       
                                                                                              INPUT p-cdagechq,       
                                                                                              INPUT p-nrddigc1,       
                                                                                              INPUT p-nrctabdb,       
                                                                                              INPUT p-nrddigc2,       
                                                                                              INPUT p-nrcheque,       
                                                                                              INPUT p-nrddigc3, 
                                                                                              INPUT DEC(v_valor2),
                                                                                              INPUT NO,
                                                                                              INPUT p-nro-conta-nova,
                                                                                              INPUT p-nro-conta-anti,
                                                                                              OUTPUT v_mensagem1,
                                                                                              OUTPUT v_mensagem2,
                                                                                              OUTPUT p-mensagem,
                                                                                              OUTPUT p-valor-disponivel).
                                                                            
                                                                      END.
                   
                                                                   IF VALID-HANDLE(h-b1crap51) THEN
                                                                      DELETE PROCEDURE h-b1crap51.
                   
                                                             END.  
                                                          
                                                             IF RETURN-VALUE = "NOK" THEN 
                                                                DO:
                                                                   ASSIGN v_cmc7 = ""
                                                                          aux_erro_vlr = TRUE.
                                                                
                                                                   FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                            craperr.cdagenci = INT(v_pac)       AND
                                                                                            craperr.nrdcaixa = INT(v_caixa)
                                                                                            NO-LOCK NO-ERROR.
                                                                                            
                                                                   IF AVAIL craperr  THEN
                                                                      RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                                                
                                                                END.
                                                             ELSE 
                                                                DO: 
                                                                   /* se nao deu nenhuma mensagem ou critica refaz a validação 
                                                                      e habilita o botao processar */
                                                                   IF v_mensagem1 = " " AND
                                                                      v_mensagem2 = " " AND
                                                                      p-mensagem =  " " AND
                                                                      p-valor-disponivel = 0 THEN 
                                                                      DO:
                                                                         IF NOT VALID-HANDLE(h-b1crap51) THEN
                                                                            RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
                                                                      
                                                                         IF NOT p-flg-cta-migrada  THEN
                                                                            RUN valida-deposito-com-captura
                                                                                 IN h-b1crap51  
                                                                                            (INPUT v_coop,
                                                                                             INPUT INT(v_pac),
                                                                                             INPUT INT(v_caixa),
                                                                                             INPUT v_operador,
                                                                                             INPUT " ",
                                                                                             INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                             INPUT INT(v_conta),
                                                                                             INPUT v_cmc7,
                                                                                             INPUT " ",
                                                                                             INPUT p-cdcmpchq,    
                                                                                             INPUT p-cdbanchq,       
                                                                                             INPUT p-cdagechq,       
                                                                                             INPUT p-nrddigc1,       
                                                                                             INPUT p-nrctabdb,       
                                                                                             INPUT p-nrddigc2,       
                                                                                             INPUT p-nrcheque,       
                                                                                             INPUT p-nrddigc3, 
                                                                                             INPUT DEC(v_valor2),
                                                                                             INPUT YES,
                                                                                             OUTPUT v_mensagem1,
                                                                                             OUTPUT v_mensagem2,
                                                                                             OUTPUT p-mensagem,
                                                                                             OUTPUT p-valor-disponivel).
                                                                         ELSE
                                                                            DO:
                                                                               IF NOT p-flg-coop-host  THEN
                                                                                  RUN valida-deposito-com-captura-migrado
                                                                                       IN h-b1crap51  
                                                                                                  (INPUT v_coop,
                                                                                                   INPUT p-coop-migrada,
                                                                                                   INPUT INT(v_pac),
                                                                                                   INPUT INT(v_caixa),
                                                                                                   INPUT v_operador,
                                                                                                   INPUT " ",
                                                                                                   INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                                   INPUT INT(v_conta),
                                                                                                   INPUT v_cmc7,
                                                                                                   INPUT " ",
                                                                                                   INPUT p-cdcmpchq,    
                                                                                                   INPUT p-cdbanchq,       
                                                                                                   INPUT p-cdagechq,       
                                                                                                   INPUT p-nrddigc1,       
                                                                                                   INPUT p-nrctabdb,       
                                                                                                   INPUT p-nrddigc2,       
                                                                                                   INPUT p-nrcheque,       
                                                                                                   INPUT p-nrddigc3, 
                                                                                                   INPUT DEC(v_valor2),
                                                                                                   INPUT YES,
                                                                                                   INPUT p-nro-conta-nova,
                                                                                                   INPUT p-nro-conta-anti,
                                                                                                   OUTPUT v_mensagem1,
                                                                                                   OUTPUT v_mensagem2,
                                                                                                   OUTPUT p-mensagem,
                                                                                                   OUTPUT p-valor-disponivel).
                                                                               ELSE
                                                                                  RUN valida-deposito-com-captura-migrado-host
                                                                                      IN h-b1crap51(INPUT v_coop,
                                                                                                    INPUT p-coop-migrada,
                                                                                                    INPUT INT(v_pac),
                                                                                                    INPUT INT(v_caixa),
                                                                                                    INPUT v_operador,
                                                                                                    INPUT " ",
                                                                                                    INPUT trim(entry(1,aux_nmcopdst,"-")), /*Dep.Intercoop.*/
                                                                                                    INPUT INT(v_conta),
                                                                                                    INPUT v_cmc7,
                                                                                                    INPUT " ",
                                                                                                    INPUT p-cdcmpchq,  
                                                                                                    INPUT p-cdbanchq,       
                                                                                                    INPUT p-cdagechq,       
                                                                                                    INPUT p-nrddigc1,       
                                                                                                    INPUT p-nrctabdb,       
                                                                                                    INPUT p-nrddigc2,       
                                                                                                    INPUT p-nrcheque,       
                                                                                                    INPUT p-nrddigc3, 
                                                                                                    INPUT DEC(v_valor2),
                                                                                                    INPUT YES,
                                                                                                    INPUT p-nro-conta-nova,
                                                                                                    INPUT p-nro-conta-anti,
                                                                                                    OUTPUT v_mensagem1,
                                                                                                    OUTPUT v_mensagem2,
                                                                                                    OUTPUT p-mensagem,
                                                                                                    OUTPUT p-valor-disponivel).
                                                                                  
                                                                            END.
                                                                      
                                                                         IF VALID-HANDLE(h-b1crap51) THEN
                                                                            DELETE PROCEDURE h-b1crap51.
                                                                      
                                                                         IF RETURN-VALUE = "NOK"  THEN 
                                                                            DO:
                                                                               ASSIGN vh_foco  = "24"
                                                                                      aux_erro_vlr = TRUE.
                                                                           
                                                                               FIND FIRST craperr WHERE craperr.cdcooper = crapcop.cdcooper AND
                                                                                                        craperr.cdagenci = INT(v_pac)       AND
                                                                                                        craperr.nrdcaixa = INT(v_caixa) 
                                                                                                        NO-LOCK NO-ERROR.
                                                                           
                                                                               IF AVAIL craperr  THEN
                                                                                  RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                   
                                                                            END.
                                                                         ELSE
                                                                            DO:
                                                                               /* totalizar p/ atualizar campo */
                                                                               ASSIGN aux_vlrproc = 0.
                   
                                                                               FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                                                                                                      crapmdw.cdagenci   = INT(v_pac)       AND
                                                                                                      crapmdw.nrdcaixa   = INT(v_caixa) 
                                                                                                      NO-LOCK:
                   
                                                                                   ASSIGN aux_vlrproc = aux_vlrproc + crapmdw.vlcompel.
                   
                                                                               END.
                                                                               
                                                                               ASSIGN v_valorproc = TRIM(STRING(aux_vlrproc,"zzz,zzz,zzz,zz9.99-")).
                   
                                                                            END.
                   
                                                                      END.
                                                                   
                                                                   /* Se deu alguma mensagem de alerta pede senha */
                                                                   IF v_mensagem1 <> "" OR 
                                                                      v_mensagem2 <> "" OR 
                                                                      p-mensagem <> "" THEN
                                                                      DO:                             
                                                                          RUN JavaScript("window.location='crap051a2.w"               +
                                                                                  "?v_pconta="           + v_conta                    +
                                                                                  "&v_pcopdst="          + aux_nmcopdst               + 
                                                                                  "&v_pnome="            + v_nome                     + 
                                                                                  "&v_ppoup="            + 
                                                                                  "&v_pidentifica=Deposito de envelope CONFERENCIA "  + v_nrsequniC +
                                                                                  "&v_pvalor="            + v_valor                    + 
                                                                                  "&v_pvalor1="           + v_valorcomput              +
                                                                                  "&v_pvalor2="           + v_valor2                   +
                                                                                  "&v_cmc7="             + v_cmc7                     +
                                                                                  "&v_cdcmpchq="         + STRING(p-cdcmpchq)         +                    
                                                                                  "&v_cdbanchq="         + STRING(p-cdbanchq)         +                    
                                                                                  "&v_cdagechq="         + STRING(p-cdagechq)         +                    
                                                                                  "&v_nrddigc1="         + STRING(p-nrddigc1)         +                    
                                                                                  "&v_nrctabdb="         + STRING(p-nrctabdb)         +                    
                                                                                  "&v_nrddigc2="         + STRING(p-nrddigc2)         +                    
                                                                                  "&v_nrcheque="         + STRING(p-nrcheque)         +                    
                                                                                  "&v_nrddigc3="         + STRING(p-nrddigc3)         +                    
                                                                                  "&p-valor-disponivel=" + STRING(p-valor-disponivel) +
                                                                                  "&v_pmensagem1="       + v_mensagem1                +
                                                                                  "&v_pmensagem2="       + v_mensagem2                +
                                                                                  "&p-mensagem="         + p-mensagem                 +
                                                                                  "&p-valor-disponivel=" + STRING(p-valor-disponivel) +
                                                                                  "&v_pdtenvelo="        + v_dtmvtoltC                +
                                                                                  "&v_pnrsequni="        + v_nrsequniC                +
                                                                                  "&v_flg-cta-migrada="  + STRING(p-flg-cta-migrada)  +
                                                                                  "&v_coop-migrada="     + STRING(p-coop-migrada)     +
                                                                                  "&v_flg-coop-host="    + STRING(p-flg-coop-host)    +
                                                                                  "&v_nro-conta-nova="   + STRING(p-nro-conta-nova)   +
                                                                                  "&v_nro-conta-anti="   + STRING(p-nro-conta-anti)   +
                                                                                  "&v_pvlcomput="        + v_valorcomput              +
                                                                                  "&v_pvlenvelo="        + v_valor1                   +
                                                                                  "&v_pnrterfin="        + v_nrterfin + "'").
                                                                   
                                                                      END.
                                                                     /* final do ELSE v_mensagem */
                                                                
                                                                END. /* se nao houve mensagem de alerta */
                                                          
                                                          END. /* Else de nao deu critica no valor */
                                                 
                                                    END.   /* Automatico (Informa o cmc7 pela leitora) */
                                              
                                              END. /* Se houve informacao de valor de chque */
                                     
                                     END. /* fim do else - clicou botao dinheiro/cheque*/
                               
                               END. /* fim do else busca_nome_taa */
                         
                         END. /* fim do if nrterfin */
                   
                   END. /* final do else abertura boletim */
             
             END. /* final do else do valida transacao */

       END. /* final do metodo post */
    ELSE
       DO:                                                       
          IF GET-VALUE("v_sangria") <> "" THEN
             DO:
                IF NOT VALID-HANDLE(h-b1crap00) THEN
                   RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
             
                RUN verifica-sangria-caixa IN h-b1crap00 (INPUT v_coop,
                                                          INPUT INT(v_pac),
                                                          INPUT INT(v_caixa),
                                                          input v_operador).
             
                IF VALID-HANDLE(h-b1crap00) THEN
                   DELETE PROCEDURE h-b1crap00.
             
                IF RETURN-VALUE = "MAX" THEN
                   DO:
                       {include/i-erro.i}
                  
                       RUN JavaScript("window.location='crap002.w';").
                  
                   END.
                  
                IF RETURN-VALUE = "MIN" THEN
                    {include/i-erro.i}
             
                IF RETURN-VALUE = "NOK" THEN
                  DO:
                      {include/i-erro.i}
                  
                      RUN JavaScript("window.location='crap002.w';").
                  END.
             END.
             
             IF get-value("v_nrterfin") <> " " AND
                v_nrsequniC <> " "             THEN
                DO:
                   IF NOT VALID-HANDLE(h-b1crap61) THEN
                      RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                
                   RUN busca_nome_taa IN h-b1crap61 (INPUT v_coop,
                                                     INPUT v_pac,
                                                     INPUT v_caixa,
                                                     INPUT v_nrterfin,
                                                     OUTPUT v_dsterfin).

                   IF VALID-HANDLE(h-b1crap61) THEN
                      DELETE PROCEDURE h-b1crap61.
                
                   ASSIGN aux_vlrproc = 0.
                
                   FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                                          crapmdw.cdagenci   = INT(v_pac)       AND
                                          crapmdw.nrdcaixa   = INT(v_caixa) 
                                          NO-LOCK:
                
                       ASSIGN aux_vlrproc = aux_vlrproc + crapmdw.vlcompel.
                
                   END.
                   
                   ASSIGN v_valorproc = TRIM(STRING(aux_vlrproc,"zzz,zzz,zzz,zz9.99-")).
                
                END.

       END. 

    PROCEDURE reinicia-crapmdw:

        DEF INPUT PARAM p-cod-agencia AS INT NO-UNDO.
        DEF INPUT PARAM p-nr-caixa    AS INT NO-UNDO.

        FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                               crapmdw.cdagenci   = p-cod-agencia    AND 
                               crapmdw.nrdcaixa   = p-nr-caixa       
                               EXCLUSIVE-LOCK:

            ASSIGN crapmdw.inautent = NO.

        END.

    END PROCEDURE.



</script>
    <form onKeyDown="change_page(event)" method=post>
        <input type="hidden" id="v_msg"       name="v_msg">
        <input type="hidden" id="vh_foco"     name="vh_foco"     value="8">
        <input type="hidden" id="vh_qtdenvel" name="vh_qtdenvel" value="0">
        <p style="word-spacing: 0; line-height: 100%; margin-top: 0; margin-bottom: 0">&nbsp;</p>
        <div align="center">
            <center>
            <table width="100%" class=cabtab>
                <tr>
                    <td width="15%" align="center"> <input type="text" id="v_coop" name="v_coop" value="`v_coop`" size="11" class="transp" readOnly></td>
                    <td width="20%" align="center"> PA&nbsp; <input type="text" id="v_pac" name="v_pac" value="`v_pac`" size="1" class="transp"  readOnly></td>
                    <td width="20%" align="center"> CAIXA&nbsp; <input type="text" id="v_caixa" name="v_caixa" value="`v_caixa`" size="1" class="transp" readOnly></td>
                    <td width="30%" align="center"> OPERADOR&nbsp; <input type="text" id="v_operador" name="v_operador" value="`v_operador`" name="" size="7" class="transp" readOnly></td>
                    <td width="15%" align="center"> <input type="text" id="v_data" name="v_data" value="`ab_unmap.v_data`" size="10" class="transp" readOnly></td>
                </tr>
            </table>
            </center>
        </div>
        <div align="center">
            <center>
            <table width="100%" class=cabtab>
                <tr>
                    <td class=titulo>LIBERAÇÃO DE ENVELOPES</td>
                    <td width="21%" class=programa align="right">P.061&nbsp; V.2.00</td>
                </tr>
            </table>
            </center>
        </div>
        
        <table width="100%" cellspacing=0 cellpadding=1 class=tcampo>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td width="115px" align="right" class="linhaform">N&uacute;mero do TAA:</td>
                <td width="60px" align="center"> <input type="text" id="v_nrterfin" name="v_nrterfin" class="input" value="`v_nrterfin`" maxlength="7" style="width: 55px; text-align: right;" onKeyDown="JavaScript:validaInteiro(event);"  onChange="document.forms[0].submit();for(var i=0;i<document.forms[0].length;i++){document.forms[0].elements[i].disabled=true;}"> </td>
                <td width="210px" align="left"> <input type="text" id="v_dsterfin" name="v_dsterfin" class="input" style="width: 190px;" value="`v_dsterfin`" disabled></td>
                <td align="right" class="linhaform"><input type="button" id="v_dsterfin" value="Estorno" name="estorno" class="button" onClick="JavaScript:redir_login('crap071.w')">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
        </table>
        <table width="100%" cellspacing=0 cellpadding=1 class=tcampo>
            <tr>
                <td colspan="3">&nbsp;</td>
            </tr>
            <tr>
                <td width="160px" align="right" class="linhaform">Escolha o tipo de dep&oacute;sito:</td>
                <td width="90" align="center" class="linhaform">&nbsp;<input type="button" value="Dinheiro" id="dinheiro" name="dinheiro" class="button" onclick="JavaScript:efetuaSubmit(this.id);"></td>
                <td align="left" class="linhaform">&nbsp;<input type="button" value="Cheque" id="cheque" name="cheque" class="button" onclick="JavaScript:efetuaSubmit(this.id);"></td>
            </tr>
            <tr>
                <td colspan="3">&nbsp;</td>
            </tr>
        </table>
        <div id="divDinheiro" style="display: none;">
            <div id="divTituloDinheiro" align="center">
                <center>
                <table width="100%" class=cabtab>
                    <tr>
                        <td class="titulo" align="center">Dinheiro</td>
                    </tr>
                </table>
                </center>
            </div>
           <div id="divConteudoDinheiro" align="center">
                <div>
                <table width="100%" class=tcampo>
                    <tr>
                        <td colspan="4">&nbsp;</td>
                    </tr>
                    <tr>
                        <td width="25%" align="right" class="linhaform">Data:</td>
                        <td width="25%" align="left"><input type="text" name="v_dtmvtoltD" id="v_dtmvtoltD" value="`v_dtmvtoltD`" style="width: 65;" class="input" maxlength="10" onKeyUp="FormataData(this,this.value);" onBlur="if ( validarData(this.value) && (this.value.length!=0) ){alert('Data Invalida!');this.value=''; this.focus(); } else { JavaScript:insereEnvelope(1); }"></td>
                        <td width="25%" align="right" class="linhaform" style="display: none;">Confer&ecirc;ncia:</td>
                        <td width="25%" align="left"><input type="text" name="v_nrsequniD" id="v_nrsequniD" class="input" maxlength="7" style="display: none; width: 55px; text-align: right;" onKeyDown="JavaScript:validaInteiro(event);" onblur="JavaScript:insereEnvelope(1);"> </td>
                    </tr>
                    <tr>
                        <td colspan="4">&nbsp;</td>
                    </tr>
                </table>
                </div>
                <div>
                <table width="100%" class=cabtab>
                    <tr>
                        <td width="8%" class="titulo" align="right">Coop.</td>
                        <td width="5%" class="titulo" align="right">Seq.</td>
                        <td width="13%" class="titulo" align="right">Conta/dv</td>
                        <td width="10%" class="titulo" align="right">Conf.</td>
                        <td width="17%" class="titulo" align="right">Informado</td>
                        <td width="17%" class="titulo" align="right">Computado</td>
                        <td width="15%" class="titulo" align="right">Diferen&ccedil;a</td>
                        <td width="15%" class="titulo" align="left">Situa&ccedil;&atilde;o</td>
                        <td class="titulo" align="center">&nbsp;</td>
                    </tr>
                </table>
                </div>
                <div>
                <table width="100%" class=tcampo>
                    <script language="SpeedScript">
                    ASSIGN aux_contador = 0
                           vh_qtdenvel = "0". 

                    IF v_dtmvtoltD <> "" THEN
                       DO:
                          FOR EACH tt-depositos-env NO-LOCK BY tt-depositos-env.nrsequen DESC:
                              ASSIGN aux_contador = aux_contador + 1
                                     vh_qtdenvel = STRING(aux_contador)
                                     v_vltotinf = v_vltotinf + tt-depositos-env.vlinform
                                     v_vltotcpt = v_vltotcpt + tt-depositos-env.vlcomput
                                     v_vltotdif = v_vltotdif + (tt-depositos-env.vlinform - tt-depositos-env.vlcomput).
                          </script>
                          <tr>
                              <td width="8%" class="linhaform" align="right">`tt-depositos-env.nmcopdst`</td>
                              <td width="5%" class="linhaform" align="right">`tt-depositos-env.nrsequen`</td>
                              <td width="13%" class="linhaform" align="right">`TRIM(STRING(tt-depositos-env.nrdconta,"zzzz,zz9,9"))`</td>
                              <td width="10%" class="linhaform" align="right">
                                  <input type="hidden" id="`'v_nmcopdst' + STRING(tt-depositos-env.nrsequen)`" name="`'v_nmcopdst' + STRING(tt-depositos-env.nrsequen)`" value="`tt-depositos-env.nmcopdst`"> 
                                  <input type="hidden" id="`'v_nrctadst' + STRING(tt-depositos-env.nrsequen)`" name="`'v_nrctadst' + STRING(tt-depositos-env.nrsequen)`" value="`tt-depositos-env.nrdconta`"> 
                                  <input type="hidden" id="`'v_dtlibcom' + STRING(tt-depositos-env.nrsequen)`" name="`'v_dtlibcom' + STRING(tt-depositos-env.nrsequen)`" value="`tt-depositos-env.dtlibcom`">
                                  <input type="hidden" id="`'v_nrconfer' + STRING(tt-depositos-env.nrsequen)`" name="`'v_nrconfer' + STRING(tt-depositos-env.nrsequen)`" value="`tt-depositos-env.nrconfer`">`tt-depositos-env.nrconfer`</td>
                              <td width="17%" class="linhaform" align="right"><span id="`'v_vlinform' + STRING(tt-depositos-env.nrsequen)`">`TRIM(STRING(tt-depositos-env.vlinform,"zzz,zzz,zzz,zz9.99-"))`</span></td>
                              <td width="17%" class="linhaform" align="right"><input type="text"  maxlength = "18" id="`'v_vlcomput' + STRING(tt-depositos-env.nrsequen)`" name="`'v_vlcomput' + STRING(tt-depositos-env.nrsequen)`" style="width: 100%; text-align: right;" value="`TRIM(STRING(tt-depositos-env.vlcomput,'zzz,zzz,zzz,zz9.99-'))`" class="input" onKeyDown="JavaScript:FormataValor(this,14,event)" onblur="alteraComputado(`STRING(tt-depositos-env.nrsequen)`);"></td>
                              <td width="15%" class="linhaform" align="right"><span id="`'v_vldifere' + STRING(tt-depositos-env.nrsequen)`">`TRIM(STRING(tt-depositos-env.vlinform - tt-depositos-env.vlcomput,"zzz,zzz,zzz,zz9.99-"))`</span></td>
                              <td width="15%" class="linhaform" align="left"><input type="text" id="`'v_flgsitua' + STRING(tt-depositos-env.nrsequen)`" name="`'v_flgsitua' + STRING(tt-depositos-env.nrsequen)`" style="width: 100%;" value="`tt-depositos-env.dssituac`" class="input" readOnly></td>
                              <td class="linhaform" align="center"><img src="/images/ico_excluir.gif" style="cursor: pointer;" alt="Alterar Situação" onClick="trocaSituacao('`STRING(tt-depositos-env.nrsequen)`');"/></td>
                          </tr>
                          <script language="SpeedScript">
                          END.
                       END.
                    </script>
                    <tr>
                        <td class="linhaform" align="right" colspan="4">Total:</td>
                        <td class="linhaform" align="right"><span id="v_vltotinf" style="font-weight: bold;">`TRIM(STRING(v_vltotinf,"zzz,zzz,zzz,zz9.99-"))`</span></td>
                        <td class="linhaform" align="right"><span id="v_vltotcpt" style="font-weight: bold;">`TRIM(STRING(v_vltotcpt,"zzz,zzz,zzz,zz9.99-"))`</span></td>
                        <td class="linhaform" align="right"><span id="v_vltotdif" style="font-weight: bold;">`TRIM(STRING(v_vltotdif,"zzz,zzz,zzz,zz9.99-"))`</span></td>
                        <td class="linhaform" align="left" colspan="2">&nbsp;</td>
                    </tr>
                </table>
                </div>
                <div id="divDinheiroProcessar">
                    <table width="100%" class=tcampo>
                        <tr>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td align="center" class="linhaform">
                                <input type="hidden" id="v_dinheiro" name="v_dinheiro" value="">
                                <input type="button" value="Processar" id="processardinheiro" name="processardinheiro" id="processardinheiro" class="button" onclick="validaComputado();">
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div id="divCheque" style="display: none;">
            <div id="divTituloCheque" align="center">
                <center>
                <table width="100%" class=cabtab>
                    <tr>
                        <td class="titulo" align="center">Cheque</td>
                    </tr>
                </table>
                </center>
            </div>
            <div id="divConteudoCheque" align="center">

                <table width="101%" cellspacing = 1 cellpadding = 1 class=tcampo>
                    <tr>
                        <td align="center" class="linhaform" colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                        <td width="30%" align="right" class="linhaform">Data:</td>
                        <td width="70%" align="left"  class="linhaform" colspan="2"> <input type="text" name="v_dtmvtoltC" id="v_dtmvtoltC" value="`v_dtmvtoltC`" style="width: 65;" class="input" maxlength="10" onKeyUp="JavaScript:FormataData(this,this.value);" onblur="if ( validarData(this.value) && (this.value.length!=0) ){alert('Data Invalida!');this.value=''; this.focus();}"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Confer&ecirc;ncia:&nbsp;<input type="text" name="v_nrsequniC" id="v_nrsequniC" value="`v_nrsequniC`" maxlength="9" class="input" style="width: 60px; text-align: right;" onKeyDown="JavaScript:validaInteiro(event);" onchange="JavaScript:insereEnvelope(2);"></td>
                    </tr>

                    <tr>
                        <td width="30%" align="right" class="linhaform">Cooperativa:</td>
                        <td width="70%" align="left" colspan="2">
                            <input type="text" id="aux_nmcopdst" name="aux_nmcopdst"       value="`aux_nmcopdst`"   size="61"        class="input" style="text-align: right" disabled>
                        </td>
                    </tr>

                    <tr>
                        <td width="30%" align="right" class="linhaform">Conta/DV:</td>
                        <td width="70%" colspan="2">              <input type="text" id="v_conta"  name="v_conta"      size="10" value="`v_conta`"      class="input" disabled style="text-align: right">&nbsp;<input type="text" id="v_nome" name="v_nome" size="38" class="input" value="`v_nome`" disabled maxlength="38" style="font-weight: bold"></td>
                    </tr>
                    <tr>
                        <td align="right" class="linhaform" width="30%">Infor. envelope:</td>
                        <td align="left" class="linhaform" width="70%" colspan="2"><input type="text" id="v_valor1"  name="v_valor1" value="`TRIM(v_valor1)`" size="20" class="input" style="text-align: right" disabled>&nbsp;&nbsp;&nbsp;&nbsp;Computado:&nbsp;<input type="text" id="v_valorcomput" name="v_valorcomput" value="`TRIM(v_valorcomput)`" onKeyDown="JavaScript:FormataValor(this,14,event)" onblur="alteraBtnProcessar();" size="20" maxlength="18" class="input" style="text-align: right"></td>
                    </tr>
                    <tr>
                        <td align="right" class="linhaform" width="30%">Valor:</td>
                        <td align="left" class="linhaform" width="70%" colspan="2"><input type="text" id="v_valor2" name="v_valor2" size="20" class="input" onKeyUp="callCalc(event, this)" onKeyDown="JavaScript:FormataValor(this,14,event)" maxlength="18" style="text-align: right" value="`TRIM(v_valor2)`">&nbsp;&nbsp;&nbsp;Processado:&nbsp;<input type="text" name="v_valorproc" id="v_valorproc" size="20" class="input" value="`TRIM(v_valorproc)`" style="text-align: right" disabled></td>
                    </tr>
                    <tr>
                        <td align="right" class="linhaform" width="30%">CMC7:</td>
                        <td align="left" class="linhaform" width="70%" colspan="2"><input type="text" id="v_cmc7" name="v_cmc7" size="40" class="input" onKeyDown="JavaScript:if (event.keyCode == 13){ return false; }"  OnKeyUp="Javascript: preenchimento(event,0,this,34,'submit')" maxlength="40" style="text-align: right">&nbsp;<input type="button" value="Manual" id="Manual" name="Manual" class="button" onclick="JavaScript:efetuaSubmitCheque(this.id);"></td>
                    </tr>
                    <tr>
                        <td align="right" class="linhaform"></td>
                        <td align="left" class="linhaform">&nbsp;</td>
                        <td align="left" class="linhaform"></td>
                    </tr>
                    <tr>
                        <td align="center" class="linhaform" colspan="3"><input type="button" value="Processar" name="v_cheque" id="v_cheque" class="button" onclick="efetuaSubmitCheque(this.id);" disabled>&nbsp;&nbsp;&nbsp;<input type="button" value="Descartar" id="v_descartar" name="v_descartar" class="button" onclick="efetuaSubmitCheque(this.id);"></td>
                    </tr>
                    <tr>
                        <td align="right" class="linhaform" colspan="3">
                            <input type="hidden" id="p-flg-cta-migrada" name="p-flg-cta-migrada" value="`string(p-flg-cta-migrada)`">
                            <input type="hidden" id="p-coop-migrada"    name="p-coop-migrada"    value="`string(p-coop-migrada)`">
                            <input type="hidden" id="p-flg-coop-host"   name="p-flg-coop-host"   value="`string(p-flg-coop-host)`">
                            <input type="hidden" id="p-nro-conta-nova"  name="p-nro-conta-nova"  value="`string(p-nro-conta-nova)`">
                            <input type="hidden" id="p-nro-conta-anti"  name="p-nro-conta-anti"  value="`string(p-nro-conta-anti)`">
                            <input type="hidden" id="v_altcompt"        name="v_altcompt"        value="`string(v_altcompt)`">
                            <input type="button" value="Detalhar" name="detalhar" id="detalhar" class="button" onclick="efetuaSubmitCheque(this.id);">&nbsp;
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <input type="hidden" id="v_id_compt" name="v_id_compt" value="`STRING(v_id_compt)`">
        <input type="hidden" id="v_at_compt" name="v_at_compt" value="`STRING(v_at_compt)`">
        <input type="hidden" id="v_at_situa" name="v_at_situa" value="`STRING(v_at_situa)`">
        <input type="hidden" id="v_dscopcao" name="v_dscopcao" value="">
        <input type="hidden" id="v_prosschq" name="v_prosschq" value="">
        <input type="hidden" id="v_descachq" name="v_descachq" value="">
        <input type="hidden" id="v_detalhar" name="v_detalhar" value="">
        <input type="hidden" id="v_manual"   name="v_manual" value="">
    </form>
    <script language="SpeedScript">

    RUN JavaScript("document.getElementById('vh_qtdenvel').value = " + vh_qtdenvel + ";").
    
    /* Controles de focus e divs */
    IF REQUEST_METHOD = "POST":U  THEN 
       DO:
          /* clicou no botao dinheiro */
          IF get-value("v_dscopcao") = "dinheiro" THEN
             RUN JavaScript("mostraDinheiro(13);").
          ELSE
          /* clicou no botao cheque */
          IF get-value("v_dscopcao") = "cheque" THEN 
             DO:                
                RUN JavaScript("mostraCheque(17);").
             END.
          ELSE
          /* informou o numero do TAA */
          IF get-value("v_nrterfin") <> " "  THEN 
             RUN JavaScript("document.getElementById('vh_foco').value = 11;").
          
          IF v_dtmvtoltD <> " "  THEN
              RUN JavaScript("mostraDinheiro(" + string(15 + (aux_contador * 6)) + ");").
          ELSE
          /* deu erro na busca do envelope */
          IF v_dtmvtoltC <> " " AND aux_erro_env  THEN
             RUN JavaScript("mostraCheque(18);").
          ELSE
          /* deixou valor zerado no cheque */
          IF v_dtmvtoltC <> " " AND aux_erro_vlr  THEN
             RUN JavaScript("mostraCheque(24);").
          ELSE
          /* passou cmc7 e os valores bateram */
          IF v_dtmvtoltC <> " " AND 
             v_valorproc = v_valorcomput  THEN
             RUN JavaScript("document.getElementById('v_valor2').value = ''; retornaManual(); mostraCheque(24);").
          ELSE
          /* incluiu um cheque sem erro */
          IF v_dtmvtoltC <> " "  AND
             v_valor2 <> " "  THEN 
             RUN JavaScript("document.getElementById('v_valor2').value = ''; mostraCheque(24);").
          ELSE
          IF v_dtmvtoltC <> " "  THEN
             RUN JavaScript("mostraCheque(23);"). /* foca no valor */
       END.
    ELSE
       DO:
          /* voltou de alguma tela como pedesenha ou digitacao manual ou detalhamento de cheque */
          IF  get-value("v_nrterfin") <> " "  AND
              v_dtmvtoltC <> " " THEN
              RUN JavaScript("retornaManual();").
       END.

    </script>
</body>                      
</html>
