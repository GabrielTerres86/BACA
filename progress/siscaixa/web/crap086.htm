<!-- ............................................................................

   Programa: siscaixa/web/crap086.htm
   Sistema : Conta-Corrente - Cooperativa de Credito
   Sigla   : CRED
   Autor   : Guilherme
   Data    : Julho/2011                    Ultima atualizacao: 20/06/2018

   Dados referentes ao programa: 
                   -Lançamento de cheques (adaptacao da rotina 51 + lanchq)

   Frequencia: Diario (Caixa Online).
   Objetivo  : Processar a rotina de estorno 86

   Alteracoes: 29/07/2011 - Adaptado da rotina 71 (Guilherme).
   
               21/09/2011 - Procedure grava-autenticacao de RC para PG
                            (Guilherme).
               
               11/11/2013 - Nova forma de chamar as agências, de PAC agora 
                           a escrita será PA (Guilherme Gielow)             
               
               12/12/2013 - Alteracao referente a integracao Progress X 
                            Dataserver Oracle 
                            Inclusao do VALIDATE ( André Euzébio / SUPERO) 

               12/09/2016 - Adicionado chamada da função "callBlass(event)" - (Evandro - RKAM). 
			   
		  	   16/01/2018 - Aumentado tamanho do campo de senha para 30 caracteres. (PRJ339 - Reinert)
			   
			   20/06/2018 - Alteracoes para usar as rotinas mesmo com o processo 
							norturno rodando (Douglas Pagel - AMcom).
							
   .......................................................................... -->

<html>

<head>
<meta http-equiv="Content-Language" content="pt-br">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Pragma"        content="No-Cache">
<meta http-equiv="Expires"       content="0">
<script language=JavaScript src="/script/formatadadosie.js"></script>
<link rel=StyleSheet type="text/css" href="/script/viacredi.css">
<title>ESTORNO - LANÇAMENTO DE CHEQUES</title>
</head>


<body background="/images/moeda.jpg" bgproperties="fixed" class="fundo" onKeyUp="callBlass(event); callBLini(event); callBLsal(event);"> 
<script language="JavaScript">
habilita = new Array();
function desabilitaForm() { 
    for (var i = 0; i < window.document.forms[0].elements.length; i++) { 
        habilita[i] = window.document.forms[0].elements[i].disabled;
        window.document.forms[0].elements[i].disabled=true; 
    } 
}
function reabilitaForm() { 
    for (var j = 0; j < window.document.forms[0].elements.length; j++) { 
        window.document.forms[0].elements[j].disabled = habilita[j]; 
    } 
}

function doFocus(erro){
    if (erro = "erro") {
        document.action.v_nrautent.focus();
    }else{
        if (document.action.v_nrautent.value != '') {
            document.action.v_nrautent.disabled=true;
            document.action.v_cod.focus();
        }else{
            document.action.v_nrautent.focus();
        }
    }
    return false;
    
}
</script>
<script language="SpeedScript">
        
    DEF VAR v_coop        AS CHAR         NO-UNDO.
    DEF VAR v_conta       AS CHAR         NO-UNDO.
    DEF VAR v_nome        AS CHAR         NO-UNDO.
    DEF VAR v_pac         AS CHAR         NO-UNDO.
    DEF VAR v_caixa       AS CHAR         NO-UNDO.
    DEF VAR v_operador    AS CHAR         NO-UNDO.
    DEF VAR v_data        AS CHAR         NO-UNDO.
    DEF VAR v_foco_ope    AS LOGICAL      NO-UNDO.
    DEF VAR v_nrautent    AS char         NO-UNDO.
    DEF VAR v_pnrautent   AS char         NO-UNDO.
    DEF VAR v_flgfirst    AS LOGICAL      NO-UNDO.
    DEF VAR v_cod         AS CHAR         NO-UNDO.
    DEF VAR v_senha       AS CHAR         NO-UNDO.
    DEF VAR v_totaldep    AS DECIMAL      NO-UNDO.

    DEF VAR h-b1crap86 AS HANDLE          NO-UNDO.
    DEF VAR h-b1crap00 AS HANDLE          NO-UNDO.
    DEF VAR h-b1crap66 AS HANDLE          NO-UNDO.
    
    DEF VAR p-literal       AS CHAR       NO-UNDO.
    DEF VAR p-ult-sequencia AS INTE       NO-UNDO.
    DEF VAR p-valor         AS DEC        NO-UNDO.
    DEF VAR p-docto         AS DEC        NO-UNDO.
    DEF VAR p-poupanca      AS LOG        NO-UNDO.
    DEF VAR p-registro      AS RECID      NO-UNDO.
    
    DEF VAR l-houve-erro    AS LOG          NO-UNDO.
    
    DEF TEMP-TABLE w-craperr  NO-UNDO
        FIELD cdagenci   LIKE craperr.cdagenc
        FIELD nrdcaixa   LIKE craperr.nrdcaixa
        FIELD nrsequen   LIKE craperr.nrsequen
        FIELD cdcritic   LIKE craperr.cdcritic
        FIELD dscritic   LIKE craperr.dscritic
        FIELD erro       LIKE craperr.erro.
    
    DEF TEMP-TABLE tt-lancamentos NO-UNDO
        FIELD tpdocmto AS INTE
        FIELD dtmvtolt AS DATE
        FIELD vllanmto AS DECI
        INDEX tt-lancamentos1 tpdocmto dtmvtolt.
    
    DEF VAR aux_contador    AS INTE NO-UNDO.
    
    DEF VAR p-data1 AS DATE NO-UNDO.
    DEF VAR p-data2 AS DATE NO-UNDO.
    DEF VAR p-data3 AS DATE NO-UNDO.
    DEF VAR p-data4 AS DATE NO-UNDO.
    
    DEFINE VARIABLE de_valor1 AS DECIMAL    NO-UNDO.
    
    FIND crapcop WHERE crapcop.nmrescop = get-value("user_coop")
                       NO-LOCK NO-ERROR.
    
    FIND crapdat WHERE crapdat.cdcooper = crapcop.cdcooper
                       NO-LOCK NO-ERROR.

    ASSIGN v_caixa      = GET-VALUE("User_cx")
           v_operador   = GET-VALUE("operador")
           v_pac        = GET-VALUE("User_pac")
           v_coop       = get-value("user_coop")
           v_nrautent   = get-value("v_nrautent")
           v_data       = STRING(crapdat.dtmvtocd,"99/99/9999")
           v_cod        = GET-VALUE("v_cod")
           v_senha      = GET-VALUE("v_senha") 
           l-houve-erro = FALSE NO-ERROR.

    IF  get-value("v_nrautent") <> ""  THEN
        v_pnrautent  = get-value("v_nrautent").
    ELSE
        v_pnrautent  = get-value("v_pnrautent").

    /* Criada para o JavaScript nao ficar com o código feio */
    PROCEDURE JavaScript:

        {include/monta_js.i} /* Utilizada includes pois o programa não compila*/
        
    END PROCEDURE.    
    
    IF  REQUEST_METHOD = "POST":U  THEN  
        DO:
            RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
        
            RUN valida-transacao2 IN h-b1crap00(INPUT v_coop,
                                               INPUT v_pac,
                                               INPUT v_caixa).
        
            IF  RETURN-VALUE = "NOK"  THEN 
                DO:
                    ASSIGN l-houve-erro = TRUE.
                    FIND FIRST craperr NO-LOCK  where
                               craperr.cdcooper = crapcop.cdcooper AND
                               craperr.cdagenci = INT(v_pac)   and
                               craperr.nrdcaixa = INT(v_caixa) no-error.
                              
                    IF  AVAIL craperr  THEN
                        RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                END.
            ELSE 
                DO:
                   IF  get-value("cancela") <> ""  THEN 
                       DO:
                           ASSIGN  v_nrautent = "".
                           EMPTY TEMP-TABLE tt-lancamentos.
                       END.
                   ELSE 
                       DO:
                           RUN verifica-abertura-boletim IN h-b1crap00(INPUT v_coop,
                                                                       INPUT v_pac,
                                                                       INPUT v_caixa,
                                                                       INPUT v_operador).
                           IF  RETURN-VALUE = "NOK"  THEN 
                               DO:
                                   ASSIGN l-houve-erro = TRUE.
                                   FIND FIRST craperr NO-LOCK  where
                                              craperr.cdcooper = crapcop.cdcooper AND
                                              craperr.cdagenci = INT(v_pac)   and
                                              craperr.nrdcaixa = INT(v_caixa) no-error.
                                             
                                   IF  AVAIL craperr  THEN
                                       RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                               END.
                           ELSE 
                               DO:
                                   RUN dbo/b1crap86.p PERSISTENT SET h-b1crap86.
                                   RUN valida-autenticacao IN h-b1crap86(INPUT  v_coop,
                                                                         INPUT  v_pac,    
                                                                         INPUT  v_caixa,
                                                                         INPUT  v_pnrautent,
                                                                         OUTPUT TABLE tt-lancamentos).
                                   
                                   IF  RETURN-VALUE = "NOK" THEN          
                                       DO:
                                           ASSIGN l-houve-erro = TRUE.

                                           FIND FIRST craperr NO-LOCK  where
                                                      craperr.cdcooper = crapcop.cdcooper AND
                                                      craperr.cdagenci = INT(v_pac)   and
                                                      craperr.nrdcaixa = INT(v_caixa) no-error.
                                                     
                                           IF  AVAIL craperr  THEN
                                               RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                                       END.
                                   ELSE 
                                       DO:
                                          IF  GET-VALUE("sok") <> "" AND GET-VALUE("vh_totdepos") <> ""  THEN 
                                              DO:
                                                  ASSIGN l-houve-erro = NO.
                                                  
                                                  DO  TRANSACTION:
                                                      
                                                      RUN estorna-lancamento IN h-b1crap86 (INPUT v_coop,
                                                                                            INPUT v_pac, 
                                                                                            INPUT v_caixa,
                                                                                            INPUT v_operador,
                                                                                            INPUT v_pnrautent,
                                                                                            INPUT v_cod,
                                                                                            INPUT v_senha,
                                                                                            OUTPUT p-valor,
             OUTPUT p-docto).
                                                      IF  RETURN-VALUE = "OK"  THEN  
                                                          DO:
                                                          
                                                              RUN grava-autenticacao IN h-b1crap00 (INPUT v_coop,
                                                                                                    INPUT INT(v_pac),
                                                                                                    INPUT INT(v_caixa),
                                                                                                    INPUT v_operador,
                                                                                                    INPUT DEC(p-valor),
                                                                                                    INPUT DEC(p-docto),
                                                                                                    INPUT YES, /* YES(PG),NO(REC) */
                                                                                                    INPUT "1",
                                                                                                    INPUT yes,   /* Estorno  */
                                                                                                    INPUT "731", /* Historico */ 
                                                                                                    INPUT ?, /* Data off-line */
                                                                                                    INPUT 0, /* Sequencia off-line */
                                                                                                    INPUT 0, /* Hora off-line */
                                                                                                    INPUT 0, /* Seq.orig.Off-line */
                                                                                                    OUTPUT p-literal,
                                                                                                    OUTPUT p-ult-sequencia,
                                                                                                    OUTPUT p-registro).
                                                          END.
                                                      ELSE
                                                          DO:
                                                              ASSIGN l-houve-erro = YES.
                                                              EMPTY TEMP-TABLE w-craperr.
                                                              
                                                              FOR EACH craperr WHERE craperr.cdcooper = crapcop.cdcooper   AND
                                                                                     craperr.cdagenci = INT(v_pac)         AND
                                                                                     craperr.nrdcaixa = INT(v_caixa) NO-LOCK:
                                                     
                                                                  CREATE w-craperr.
                                                                  ASSIGN w-craperr.cdagenci = craperr.cdagenc
                                                                         w-craperr.nrdcaixa = craperr.nrdcaixa
                                                                         w-craperr.nrsequen = craperr.nrsequen
                                                                         w-craperr.cdcritic = craperr.cdcritic
                                                                         w-craperr.dscritic = craperr.dscritic
                                                                         w-craperr.erro     = craperr.erro.
                                                              END.
                                                              
                                                              UNDO.
                                                          END.     

                                                  END.
                                                  IF  l-houve-erro = YES  THEN 
                                                      DO:
                                                          FOR EACH w-craperr NO-LOCK:
                                                              CREATE craperr.
                                                              ASSIGN craperr.cdcooper = crapcop.cdcooper
                                                                     craperr.cdagenci = w-craperr.cdagenc
                                                                     craperr.nrdcaixa = w-craperr.nrdcaixa
                                                                     craperr.nrsequen = w-craperr.nrsequen
                                                                     craperr.cdcritic = w-craperr.cdcritic
                                                                     craperr.dscritic = w-craperr.dscritic
                                                                     craperr.erro     = w-craperr.erro.
                                                              VALIDATE craperr.
                                                          END.
                                                          FIND FIRST craperr NO-LOCK  where
                                                                     craperr.cdcooper = crapcop.cdcooper AND
                                                                     craperr.cdagenci = INT(v_pac)   and
                                                                     craperr.nrdcaixa = INT(v_caixa) no-error.
       
                                                          IF  AVAIL craperr  THEN
                                                              RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
       
                                                      END.
                                                  ELSE
                                                      DO:
                                                          RUN JavaScript("window.open('autentica.html?v_plit=" + STRING(p-literal) + "&v_pseq=" + STRING(p-ult-sequencia) + "&v_prec=NO&v_psetcook=yes','waut','width=250,height=145,scrollbars=auto,alwaysRaised=true')").

                                                          FOR EACH crapmdw  WHERE crapmdw.cdcooper = crapcop.cdcooper  AND
                                                                                  crapmdw.cdagenci = INT(v_pac)        AND
                                                                                  crapmdw.nrdcaixa = INT(v_caixa) EXCLUSIVE-LOCK:
                                                              DELETE crapmdw.
                                                          END.

                                                          FOR EACH crapmrw WHERE crapmrw.cdcooper   = crapcop.cdcooper AND
                                                                                 crapmrw.cdagenci   = INT(v_pac)       AND
                                                                                 crapmrw.nrdcaixa   = INT(v_caixa) EXCLUSIVE-LOCK:
                                                              DELETE crapmrw.
                                                          END.

                                                          ASSIGN  v_nrautent = ""
                                                                  v_pnrautent = "".

                                                          EMPTY TEMP-TABLE tt-lancamentos.
       
                                                      END. /* final do l houve erro no */
                                       
                                              END. /* final do get value sok */
                                              
                                         END. /* else return value */

                               END. /* final do else get value ok */
               
                               DELETE PROCEDURE h-b1crap86.
                       
                       END. /* final do else get value cancela */
                
                END. /* final do else return ok */
                
            DELETE PROCEDURE h-b1crap00.

        END. /* final do metodo post */
    ELSE
        DO:
            FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                                   crapmdw.cdagenci   = INT(v_pac)       AND
                                   crapmdw.nrdcaixa   = INT(v_caixa) EXCLUSIVE-LOCK:
                DELETE crapmdw.
            END.
            FOR EACH crapmrw WHERE crapmrw.cdcooper   = crapcop.cdcooper AND
                                   crapmrw.cdagenci   = INT(v_pac)       AND
                                   crapmrw.nrdcaixa   = INT(v_caixa) EXCLUSIVE-LOCK:
                DELETE crapmrw.
            END.
        END. 

</script>

<form name="action" onKeyDown="change_page(event)" method=post>
<p style="word-spacing: 0; line-height: 100%; margin-top: 0; margin-bottom: 0">&nbsp;</p>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td width="15%" align="center"> <input type="text" name="v_coop" value="`v_coop`" size="11" class="transp" readOnly>
      </td>
      <td width="20%" align="center"> PA&nbsp; <input type="text" name="v_pac" value="`v_pac`" size="1" class="transp"  readOnly>
      </td>
      <td width="20%" align="center"> CAIXA&nbsp; <input type="text" name="v_caixa" value="`v_caixa`" size="1" class="transp" readOnly>
      </td>
      <td width="30%" align="center"> OPERADOR&nbsp; <input type="text" name="v_operador" value="`v_operador`" size="7" class="transp" readOnly>
      </td>
      <td width="15%" align="center"> <input type="text" name="v_data" value="`v_data`" size="10" class="transp" readOnly>
      </td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td class=titulo>ESTORNO - LANÇAMENTO DE CHEQUES</td>
      <td width="21%" class=programa align="right">P.086&nbsp; V.1.00</td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
<table cellspacing = 0 cellpadding= 0 width=100%>
  <tr>
    <td width="100%" valign="middle" align="center">
      <div align="center">
      <center>
      <table width="101%" cellspacing = 0 cellpadding = 1 class=tcampo>
        <tr>
          <td width="30%" align="right" class="linhaform">&nbsp;</td>
          <td width="67%"></td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform">Autenticação:</td>
          <td width="67%"><!--webbot bot="Validation" B-Value-Required="TRUE" I-Maximum-Length="8" --><input type="text" name="v_nrautent" value="`v_pnrautent`" size="10" class="input" maxlength="8" onKeyDown="JavaScript:validaInteiro(event)" onchange="document.forms[0].submit();for(var i=0;i<document.forms[0].length;i++){document.forms[0].elements[i].disabled=false;}" style="text-align: right"></td>
        </tr>
        <tr>
          <td colspan="2"><input type="hidden" name="v_pnrautent" value="`v_pnrautent`"></td>
        </tr>
        <script language="SpeedScript">
        FOR EACH tt-lancamentos NO-LOCK BREAK BY tt-lancamentos.tpdocmto:
            ASSIGN v_foco_ope = TRUE
                   v_totaldep = v_totaldep + tt-lancamentos.vllanmto.
                   
            IF   LAST-OF(tt-lancamentos.tpdocmto) THEN
                 DO:
        </script>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp; </td>
        </tr>
        <tr>
          <td align="right" class="linhaform">Total dos Depósito:</td>
          <td><input type="text" size="18" name="v_totdepos" value="`STRING(v_totaldep,"zzz,zzz,zzz,zz9.99")`" disabled class="input" style="text-align: right"><input type="hidden" name="vh_totdepos" value="`STRING(v_totaldep,"zzz,zzz,zzz,zz9.99")`"></td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp; </td>
        </tr>
        <tr>
          <td class=linhaform align="right">Codigo:</td>
          <td><input class=input type="text" name="v_cod" size="12" 
               maxlength="10"></td>
        </tr>
        <tr>
          <td class=linhaform align="right">Senha:</td>
          <td><input class=input type="password" name="v_senha" size="12" 
               maxlength="30"></td>
        </tr>
      <script language="SpeedScript">
                 END.
        END.
      </script>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp;</td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%"><input type="submit" value="Ok" name="sok" 
              class="button">&nbsp;<input type="submit" value="Cancelar"
               name="Cancela" class="button"></td>
        </tr>
      </table>
      </center>
      </div>
      </td>
      </tr>
</table>      
  </center>
</div>
 <div align="center">
  <table width="100%">
        <tr>
           <td align="right" class="linhaform">
           <a href="crap066.htm">
           <input type="button" value="Inclusão" name="inclusao" class="button" onClick="location='crap066.w'">
           </a>
           </td>
        </tr>
  </table>      
</div>
</form>
<script language="SpeedScript">
    IF  v_foco_ope  THEN
        RUN JavaScript("document.action.v_nrautent.disabled=true;document.action.v_cod.focus();").
    ELSE
        IF  l-houve-erro  THEN
            RUN JavaScript("doFocus('erro');").
        ELSE
            RUN JavaScript("doFocus('');").
</script>
</body>
</html>
