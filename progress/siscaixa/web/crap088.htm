<!--.............................................................................

   Programa: siscaixa/web/crap088.htm
   Sistema : Caixa On-Line
   Autor   : Andre Santos - Supero
   Data    : Junho/2014                      Ultima atualizacao:

   Dados referentes ao programa:

   Frequencia:  Diario (on-line)
   Objetivo  :  Estorno de deposito em cheque entre cooperativas

   Alteracoes:   
                12/09/2016 - Adicionado chamada da função "callBlass(event)" - (Evandro - RKAM).      
                
                03/06/2017 - Retirada tratamento de documentos 3,4 e 5. PRJ367 - Compe Sessao Unica (Lombardi)
                
----------------------------------------------------------------------------->

<html>

<head>
<meta http-equiv="Content-Language" content="pt-br">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Pragma"        content="No-Cache">
<meta http-equiv="Expires"       content="0">
<script language=JavaScript src="/script/formatadadosie.js"></script>
<link rel=StyleSheet type="text/css" href="/script/viacredi.css">
<title>ESTORNO - DEPÓSITOS COM CAPTURA</title>
</head>


<body background="/images/moeda.jpg" bgproperties="fixed" class="fundo" onKeyUp="callBlass(event); callBLini(event); callBLsal(event);"> 
<script language="JavaScript">
habilita = new Array();
function desabilitaForm() { 
    for (var i = 0; i < window.document.forms[0].elements.length; i++) { 
        habilita[i] = window.document.forms[0].elements[i].disabled;
        window.document.forms[0].elements[i].disabled=true; 
    } 
}
function reabilitaForm() { 
    for (var j = 0; j < window.document.forms[0].elements.length; j++) { 
        window.document.forms[0].elements[j].disabled = habilita[j]; 
    } 
}
</script>
<script language="SpeedScript">
        
    DEF VAR v_coop         AS CHAR                  NO-UNDO.
    DEF VAR v_cooppara     AS CHAR                  NO-UNDO.
    DEF VAR v_coop_sel     AS CHAR                  NO-UNDO.
    DEF VAR v_conta        AS CHAR                  NO-UNDO.
    DEF VAR v_nome         AS CHAR                  NO-UNDO.
    DEF VAR v_pac          AS CHAR                  NO-UNDO.
    DEF VAR v_caixa        AS CHAR                  NO-UNDO.
    DEF VAR v_operador     AS CHAR                  NO-UNDO.
    DEF VAR v_data         AS CHAR                  NO-UNDO.
    DEF VAR v_poupanca     AS CHAR                  NO-UNDO.
    DEF VAR v_identifica   AS CHAR                  NO-UNDO.
    DEF VAR v_valor1       AS CHAR                  NO-UNDO.
    DEF VAR v_valor2       AS DECI                  NO-UNDO.
    DEF VAR v_foco_conta   AS LOGICAL               NO-UNDO.
    DEF VAR v_docto        AS CHAR                  NO-UNDO.

    DEF VAR h-b1crap71 AS HANDLE                    NO-UNDO.
    DEF VAR h-b1crap88 AS HANDLE                    NO-UNDO.
    DEF VAR h-b1crap00 AS HANDLE                    NO-UNDO.
    DEF VAR h-b1crap51 AS HANDLE                    NO-UNDO.
                                                    
    DEF VAR p-literal       AS CHAR                 NO-UNDO.
    DEF VAR p-ult-sequencia AS INTE                 NO-UNDO.
    DEF VAR p-valor         AS DEC                  NO-UNDO.
    DEF VAR p-poupanca      AS LOG                  NO-UNDO.
    DEF VAR p-registro      AS RECID                NO-UNDO.
    DEF VAR lOpen051d       AS LOGICAL              NO-UNDO.
    DEF VAR aux_nmrescop    AS CHAR                 NO-UNDO.

    DEF VAR l-houve-erro    AS LOG                  NO-UNDO.
    
    DEF TEMP-TABLE w-craperr  NO-UNDO
        FIELD cdagenci   LIKE craperr.cdagenc
        FIELD nrdcaixa   LIKE craperr.nrdcaixa
        FIELD nrsequen   LIKE craperr.nrsequen
        FIELD cdcritic   LIKE craperr.cdcritic
        FIELD dscritic   LIKE craperr.dscritic
        FIELD erro       LIKE craperr.erro.
    
    DEF TEMP-TABLE tt-lancamentos NO-UNDO
        FIELD tpdocmto AS INTE
        FIELD dtmvtolt AS DATE
        FIELD vllanmto AS DECI
        INDEX tt-lancamentos1 tpdocmto dtmvtolt.
    
    DEF VAR aux_contador    AS INTE NO-UNDO.
    
    DEF VAR p-data1 AS DATE NO-UNDO.
    DEF VAR p-data2 AS DATE NO-UNDO.
    DEF VAR p-data3 AS DATE NO-UNDO.
    DEF VAR p-data4 AS DATE NO-UNDO.

    DEF BUFFER crabcop FOR crapcop.

    FIND crapcop WHERE crapcop.nmrescop = get-value("user_coop") NO-LOCK NO-ERROR.

    FIND crapdat WHERE crapdat.cdcooper = crapcop.cdcooper NO-LOCK NO-ERROR.

    DEFINE VARIABLE de_valor1 AS DECIMAL    NO-UNDO.

    ASSIGN v_cooppara     = GET-VALUE("v_cooppara")
           v_conta        = GET-VALUE("v_conta")
           v_nome         = GET-VALUE("v_nome")
           v_poupanca     = GET-VALUE("v_poup")
           v_identifica   = GET-VALUE("v_identifica")
           v_valor1       = STRING(DEC(GET-VALUE("v_pvalor1")),"zzz,zzz,zzz,zz9.99")
           v_caixa        = GET-VALUE("User_cx")
           v_operador     = GET-VALUE("operador")
           v_pac          = GET-VALUE("User_pac")
           v_coop         = get-value("user_coop")
           v_data         = STRING(crapdat.dtmvtolt,"99/99/9999")
           v_docto        = GET-VALUE("v_docto").
        
    /* Criada para o JavaScript nao ficar com o código feio */
    PROCEDURE JavaScript:

        {include/monta_js.i} /* Utilizada includes pois o programa não compila*/
        
    END PROCEDURE.

    IF  REQUEST_METHOD = "POST":U  THEN DO:
    
        RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
        
        RUN valida-transacao IN h-b1crap00(INPUT v_coop,
                                           INPUT v_pac,
                                           INPUT v_caixa).

        DELETE PROCEDURE h-b1crap00.

        IF  RETURN-VALUE = "NOK"  THEN DO:
            FIND FIRST craperr NO-LOCK WHERE craperr.cdcooper = crapcop.cdcooper
                                         AND craperr.cdagenci = INT(v_pac)
                                         AND craperr.nrdcaixa = INT(v_caixa) NO-ERROR.
                              
            IF  AVAIL craperr  THEN
                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
        END.
        ELSE DO:
            IF  get-value("cancela") <> ""  THEN DO:
                ASSIGN  v_docto              = " "
                        v_conta              = " "
                        v_nome               = " "
                        v_poupanca           = " "
                        v_identifica         = " "
                        v_valor1             = " ".
                EMPTY TEMP-TABLE tt-lancamentos.
            END.
            ELSE DO:

                RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.

                RUN verifica-abertura-boletim IN h-b1crap00(INPUT v_coop,
                                                            INPUT v_pac,
                                                            INPUT v_caixa,
                                                            INPUT v_operador).

                DELETE PROCEDURE h-b1crap00.

                IF  RETURN-VALUE = "NOK"  THEN DO:
                    FIND FIRST craperr NO-LOCK  WHERE craperr.cdcooper = crapcop.cdcooper
                                                  AND craperr.cdagenci = INT(v_pac)
                                                  AND craperr.nrdcaixa = INT(v_caixa)
                                                  NO-ERROR.

                    IF  AVAIL craperr  THEN
                        RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                END.
                ELSE DO:
                    
                    RUN dbo/b1crap88.p PERSISTENT SET h-b1crap88.

                    RUN valida-cheque-com-captura IN h-b1crap88(INPUT  v_coop,
                                                                INPUT  v_pac,
                                                                INPUT  v_caixa,
                                                                INPUT  v_cooppara,
                                                                INPUT  v_conta,
                                                                INPUT  v_docto,
                                                                OUTPUT v_identifica,
                                                                OUTPUT v_nome,
                                                                OUTPUT p-poupanca,
                                                                OUTPUT v_valor1,
                                                                OUTPUT TABLE tt-lancamentos).

                    DELETE PROCEDURE h-b1crap88.

                    ASSIGN v_valor1 = STRING(DEC(v_valor1),"zzz,zzz,zzz,zz9.99").

                    IF  RETURN-VALUE = "NOK" THEN DO:
                        FIND FIRST craperr NO-LOCK WHERE craperr.cdcooper = crapcop.cdcooper
                                                     AND craperr.cdagenci = INT(v_pac)
                                                     AND craperr.nrdcaixa = INT(v_caixa)
                                                     NO-ERROR.

                        IF  AVAIL craperr  THEN
                            RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                    END.
                    ELSE DO:

                        IF  p-poupanca = yes  THEN
                            ASSIGN v_poupanca = "******* CONTA POUPANCA ********".
                        ELSE
                            ASSIGN v_poupanca = " ".

                        IF  DEC(v_valor1) > 0 THEN DO:
                            RUN dbo/b1crap71.p PERSISTENT SET h-b1crap71.
                            RUN grava-cheque-cooperativa IN h-b1crap71(INPUT v_coop,
                                                                       INPUT INT(v_pac),
                                                                       INPUT INT(v_caixa),
                                                                       INPUT INT(v_docto)).
                            DELETE PROCEDURE h-b1crap71.
                        END.

                        IF  GET-VALUE("sok") <> ""  THEN DO:
                            IF  RETURN-VALUE = "NOK" THEN DO:
                                FIND FIRST craperr NO-LOCK  WHERE craperr.cdcooper = crapcop.cdcooper
                                                              AND craperr.cdagenci = INT(v_pac)
                                                              AND craperr.nrdcaixa = INT(v_caixa)
                                                              NO-ERROR.

                                IF  AVAIL craperr  THEN
                                    RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                            END.
                            ELSE DO:
                                ASSIGN l-houve-erro = NO.

                                DO  TRANSACTION:

                                    RUN dbo/b1crap88.p PERSISTENT SET h-b1crap88.
    
                                    RUN estorna-dep-cheque-com-captura IN h-b1crap88 (INPUT  v_coop,
                                                                                      INPUT  INT(v_pac),
                                                                                      INPUT  INT(v_caixa),
                                                                                      INPUT  v_operador,
                                                                                      INPUT  v_cooppara,
                                                                                      INPUT  INT(v_conta),
                                                                                      INPUT  INT(v_docto),
                                                                                      INPUT  DEC(v_valor1),
                                                                                      INPUT  YES,
                                                                                      INPUT  ?,
                                                                                      OUTPUT p-valor).

                                    DELETE PROCEDURE h-b1crap88.

                                    IF  RETURN-VALUE = "OK"  THEN  DO:

                                        RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
                                        RUN grava-autenticacao IN h-b1crap00 (INPUT v_coop,
                                                                              INPUT INT(v_pac),
                                                                              INPUT INT(v_caixa),
                                                                              INPUT v_operador,
                                                                              INPUT DEC(p-valor),
                                                                              INPUT DEC(v_docto),
                                                                              INPUT NO, /* YES(PG),NO(REC) */
                                                                              INPUT "1",
                                                                              INPUT yes,   /* Estorno  */
                                                                              INPUT "700", /* Historico */
                                                                              INPUT ?, /* Data off-line */
                                                                              INPUT 0, /* Sequencia off-line */
                                                                              INPUT 0, /* Hora off-line */
                                                                              INPUT 0, /* Seq.orig.Off-line */
                                                                              OUTPUT p-literal,
                                                                              OUTPUT p-ult-sequencia,
                                                                              OUTPUT p-registro).
                                        DELETE PROCEDURE h-b1crap00.

                                    END.
                                    ELSE DO:
                                        ASSIGN l-houve-erro = YES.
                                        EMPTY TEMP-TABLE w-craperr.

                                        FOR EACH craperr WHERE craperr.cdcooper = crapcop.cdcooper
                                                           AND craperr.cdagenci = INT(v_pac)
                                                           AND craperr.nrdcaixa = INT(v_caixa)
                                                           NO-LOCK:

                                            CREATE w-craperr.
                                            ASSIGN w-craperr.cdagenci = craperr.cdagenc
                                                   w-craperr.nrdcaixa = craperr.nrdcaixa
                                                   w-craperr.nrsequen = craperr.nrsequen
                                                   w-craperr.cdcritic = craperr.cdcritic
                                                   w-craperr.dscritic = craperr.dscritic
                                                   w-craperr.erro     = craperr.erro.
                                        END.

                                        UNDO.
                                    END.
                                    
                                    IF  l-houve-erro = YES  THEN
                                        UNDO.
                                END.

                                IF  l-houve-erro = YES  THEN DO:
                                    FOR EACH w-craperr NO-LOCK:
                                        CREATE craperr.
                                        ASSIGN craperr.cdcooper = crapcop.cdcooper
                                               craperr.cdagenci = w-craperr.cdagenc
                                               craperr.nrdcaixa = w-craperr.nrdcaixa
                                               craperr.nrsequen = w-craperr.nrsequen
                                               craperr.cdcritic = w-craperr.cdcritic
                                               craperr.dscritic = w-craperr.dscritic
                                               craperr.erro     = w-craperr.erro.
                                        VALIDATE craperr.
                                    END.
                                    FIND FIRST craperr NO-LOCK  where
                                               craperr.cdcooper = crapcop.cdcooper AND
                                               craperr.cdagenci = INT(v_pac)   and
                                               craperr.nrdcaixa = INT(v_caixa) no-error.

                                    IF  AVAIL craperr  THEN
                                        RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").

                                END.

                                IF  l-houve-erro = NO  THEN DO:
                                    RUN JavaScript("window.open('autentica.html?v_plit=" + STRING(p-literal) + "&v_pseq=" + STRING(p-ult-sequencia) + "&v_prec=NO&v_psetcook=yes','waut','width=250,height=145,scrollbars=auto,alwaysRaised=true')").

                                    FOR EACH crapmdw  WHERE crapmdw.cdcooper = crapcop.cdcooper  AND
                                                            crapmdw.cdagenci = INT(v_pac)        AND
                                                            crapmdw.nrdcaixa = INT(v_caixa) EXCLUSIVE-LOCK:
                                        DELETE crapmdw.
                                    END.

                                    ASSIGN  v_docto              = " "
                                            v_conta              = " "
                                            v_nome               = " "
                                            v_poupanca           = " "
                                            v_identifica         = " "
                                            v_valor1             = " ".
                                    EMPTY TEMP-TABLE tt-lancamentos.

                                END. /* final do l houve erro no */

                            END. /* final do else return */

                        END. /* final do get value sok */

                    END. /* else return value */ 

                END. /* final do else get value ok */

            END. /* final do else get value cancela */

        END. /* final do else return ok */

    END. /* final do metodo post */
    ELSE DO:

        FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper
                           AND crapmdw.cdagenci   = INT(v_pac)
                           AND crapmdw.nrdcaixa   = INT(v_caixa)
                           EXCLUSIVE-LOCK:
            DELETE crapmdw.
        END.
            
        FOR EACH crapmrw WHERE crapmrw.cdcooper   = crapcop.cdcooper
                           AND crapmrw.cdagenci   = INT(v_pac)
                           AND crapmrw.nrdcaixa   = INT(v_caixa)
                           EXCLUSIVE-LOCK:
            DELETE crapmrw.
        END.

    END. 

</script>

<form name="action" onKeyDown="change_page(event)" method=post>
<p style="word-spacing: 0; line-height: 100%; margin-top: 0; margin-bottom: 0">&nbsp;</p>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td width="15%" align="center"> <input type="text" name="v_coop" value="`v_coop`" size="11" class="transp" readOnly>
      </td>
      <td width="20%" align="center"> PA&nbsp; <input type="text" name="v_pac" value="`v_pac`" size="1" class="transp"  readOnly>
      </td>
      <td width="20%" align="center"> CAIXA&nbsp; <input type="text" name="v_caixa" value="`v_caixa`" size="1" class="transp" readOnly>
      </td>
      <td width="30%" align="center"> OPERADOR&nbsp; <input type="text" name="v_operador" value="`v_operador`" size="7" class="transp" readOnly>
      </td>
      <td width="15%" align="center"> <input type="text" name="v_data" value="`v_data`" size="10" class="transp" readOnly>
      </td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td class=titulo>ESTORNO - DEPÓSITOS EM CHEQUE ENTRE COOPERATIVAS</td>
      <td width="21%" class=programa align="right">P.088&nbsp; V.1.01</td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
<table cellspacing = 0 cellpadding= 0 width=100%>
  <tr>
    <td width="100%" valign="middle" align="center">
      <div align="center">
      <center>
      <table width="101%" cellspacing = 0 cellpadding = 1 class=tcampo>
        <tr>
          <td width="30%" align="right" class="linhaform">&nbsp;</td>
          <td width="67%"></td>
        </tr>
        <tr>
          <td align="right" class="linhaform">Cooperativa Dest:</td>
          <td nowrap class="linhaform">
            <select name="v_cooppara" size="1">
                <script language="SpeedScript">ASSIGN v_coop_sel = v_cooppara.
                                               FOR EACH crabcop WHERE crabcop.cdcooper <> 3 
                                                                  AND crabcop.nmrescop <> get-value("user_coop") NO-LOCK:
                                                   ASSIGN aux_nmrescop = crabcop.nmrescop.
                                                   IF  v_coop_sel = crabcop.nmrescop THEN DO:
                                                       </script>
                                                       <option value="`aux_nmrescop`" selected>`aux_nmrescop`</option>
                    <script language="SpeedScript">END.
                                                   ELSE DO:</script>
                                                   <option value="`aux_nmrescop`">`aux_nmrescop`</option>
                                                   <script language="SpeedScript">
                                                   END.
                                               END.</script>
            </select>
          </td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform">Conta/DV:</td>
          <td width="67%"><input type="text" name="v_conta" value="`v_conta`" size="10" class="input" maxlength="10" onKeyDown="JavaScript:validaInteiro(event); FormataConta(this,8,event);" style="text-align: right"><!--webbot bot="Validation" B-Value-Required="TRUE" I-Maximum-Length="40" -->
            <input type="text" name="v_nome" value="`v_nome`" size="40" class="input" disabled maxlength="40" style="font-weight: bold"></td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform">Documento:</td>
          <td width="67%"><!--webbot bot="Validation" B-Value-Required="TRUE" I-Maximum-Length="8" --><input type="text" name="v_docto" value="`v_docto`" size="10" class="input" maxlength="5" onKeyDown="JavaScript:validaInteiro(event)" onBlur="document.forms[0].submit();for(var i=0;i<document.forms[0].length;i++){document.forms[0].elements[i].disabled=false;}" style="text-align: right"></td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform" nowrap></td>
          <td width="67%"><input type="text" name="v_poupanca" value="`v_poupanca`" size="52" class="input" disabled></td>
        </tr>
		<tr>
          <td width="30%" align="right" class="linhaform">Ident.Depósito:</td>
          <td width="67%">
          <p align="left">
          <input type="text" name="v_identifica" value="`v_identifica`" size="52" class="input" disabled></p>
          </td>
        </tr>
        <script language="SpeedScript">
        IF  DEC(v_valor1) <> 0  THEN
            DO:
                ASSIGN v_foco_conta = FALSE.
        </script>
        <tr>
          <td width="30%" align="right" class="linhaform">Cheq. Cooperativa:</td>
          <td width="67%">
          <input type="text" name="v_valor1" value="`v_valor1`" size="18" class="input" style="text-align: right" disabled>
          </td>
        </tr>
        <script language="SpeedScript">
            END.
        FOR EACH tt-lancamentos WHERE tt-lancamentos.tpdocmto = 6 NO-LOCK:
            ASSIGN v_foco_conta = FALSE.
        </script>
        <tr>
          <td width="30%" align="right" class="linhaform">Cheq. Outros Bancos:</td>
          <td width="67%"><!--webbot bot="Validation" B-Value-Required="TRUE" I-Maximum-Length="14" --><input type="text" size="18" value="`STRING(tt-lancamentos.vllanmto,"zzz,zzz,zzz,zz9.99")`" class="input" maxlength="14" disabled style="text-align: right"><!--webbot bot="Validation" B-Value-Required="TRUE" I-Maximum-Length="8" -->&nbsp;<input type="text" value="`tt-lancamentos.dtmvtolt`" size="12" disabled maxlength="8" class="input"></td>
        </tr>
        <script language="SpeedScript">
        END.
        </script>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp;</td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%"><input type="submit" value="Ok" name="sok" class="button">&nbsp;<input type="submit" value="Cancelar" name="Cancela" class="button"></td>
        </tr>
        <tr>
          <td width="30%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp; </td>
        </tr>
      </table>
      </center>
      </div>
      </td>
      </tr>
</table>      
  </center>
</div>
 <div align="center">
  <table width="100%">
        <tr>
           <td align="right" class="linhaform">
           <a href="crap051.htm">
           <input type="button" value="Inclusão" name="inclusao" class="button" onClick="location='crap022.w'">
           </a>
           </td>
        </tr>
  </table>      
</div>
</form>
<script language="SpeedScript">
    IF  lOpen051d  THEN 
        RUN JavaScript("desabilitaForm();window.open('crap051d.p?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor1=" + STRING(v_valor1)+ "&v_pestorno=YES','wautcoop','width=500,height=290,scrollbars=auto,alwaysRaised=true');").
    
    IF  DEC(v_valor1) = 0  THEN 
    DO: 
        IF  v_foco_conta  THEN /* foco no input conta */
            RUN JavaScript("document.action.elements[5].focus();").
        ELSE                 /* foco no botao ok */
            RUN JavaScript("document.action.sok.focus();").
    END.
    ELSE
    DO:
        /* foco no OK */
        RUN JavaScript("document.action.elements[11].focus();").
    END.
</script>
</body>
</html>

