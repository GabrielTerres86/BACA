<!-- ............................................................................

   Programa: siscaixa/web/crap066c.htm
   Sistema : Conta-Corrente - Cooperativa de Credito
   Sigla   : CRED
   Autor   : Guilherme
   Data    : Julho/2011                    Ultima atualizacao: 12/12/2013

   Dados referentes ao programa:

   Frequencia: Diario (Caixa Online).
   Objetivo  : Lançamento de cheques (adaptacao da rotina 51 + lanchq)

   Alteracoes: 29/07/2011 - Adaptado da rotina 51 (Guilherme).
              
               11/11/2013 - Nova forma de chamar as agências, de PAC agora 
                            a escrita será PA (Guilherme Gielow)            
               
               12/12/2013 - Alteracao referente a integracao Progress X 
                            Dataserver Oracle 
                            Inclusao do VALIDATE ( André Euzébio / SUPERO) 
   ......................................................................... -->

<html>

<head>
<meta http-equiv="Content-Language" content="pt-br">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Pragma"        content="No-Cache">
<meta http-equiv="Expires"       content="0">
<script language=JavaScript src="/script/formatadadosie.js"></script>
<link rel=StyleSheet type="text/css" href="/script/viacredi.css">
<title>LANÇAMENTO DE CHEQUES</title>
</head>


<body background="/images/moeda.jpg" bgproperties="fixed" class="fundo" onLoad="JavaScript:mudaFoco(); click();" onKeyUp="callBLini(event); callBLsal(event);"> 
<script language="JavaScript">
habilita = new Array();
function desabilitaForm() { 
    for (var i = 0; i < window.document.forms[0].elements.length; i++) { 
        habilita[i] = window.document.forms[0].elements[i].disabled;
        window.document.forms[0].elements[i].disabled=true; 
    } 
}
function reabilitaForm() { 
    for (var j = 0; j < window.document.forms[0].elements.length; j++) { 
        window.document.forms[0].elements[j].disabled = habilita[j]; 
    } 
}
</script>
<script language="SpeedScript">

    DEF VAR v_coop        AS CHAR NO-UNDO.
    DEF VAR v_conta       AS CHAR NO-UNDO.
    DEF VAR v_nome        AS CHAR NO-UNDO.
    DEF VAR v_pac         AS CHAR NO-UNDO.
    DEF VAR v_caixa       AS CHAR NO-UNDO.
    DEF VAR v_operador    AS CHAR NO-UNDO.
    DEF VAR v_data        AS CHAR NO-UNDO.
    DEF VAR v_rowid       AS CHAR NO-UNDO.
    DEF VAR v_msg         AS CHAR NO-UNDO.
    DEF VAR vh_foco       AS CHAR NO-UNDO.
    DEF VAR v_poupanca    AS CHAR NO-UNDO.
    DEF VAR v_valor1      AS CHAR NO-UNDO.
    DEF VAR aux_qtddchqs  AS INTE NO-UNDO.
    DEF VAR aux_tpdmovto  AS INTE NO-UNDO.
    DEF VAR v_totdepos    AS DECI NO-UNDO.
    DEF VAR v_qtdchqs     AS INTE NO-UNDO.
    DEF VAR v_cod         AS CHAR NO-UNDO.
    DEF VAR v_senha       AS CHAR NO-UNDO.
    DEF VAR v_nrsequni    AS CHAR NO-UNDO.
    DEF VAR v_dtenvelo    AS CHAR NO-UNDO.
    
    DEFINE VARIABLE h-b1crap00 AS HANDLE     NO-UNDO. 
    DEFINE VARIABLE h-b1crap66 AS HANDLE     NO-UNDO.
    DEFINE VARIABLE h-b1crap61 AS HANDLE     NO-UNDO.

    DEF VAR p-literal           AS CHAR            NO-UNDO.
    DEF VAR p-ult-sequencia     AS INTE            NO-UNDO.
    DEF VAR p-programa          AS CHAR   INITIAL "crap066".      
    DEFINE VARIABLE p-nro-docto AS INTEGER         NO-UNDO.
    DEF VAR l-houve-erro        AS LOG             NO-UNDO.
    DEF VAR c-nome              AS CHAR            NO-UNDO.
    DEF VAR c-poup              AS CHAR            NO-UNDO.
    DEF VAR aux_achou           AS LOGI            NO-UNDO. 


    DEFINE TEMP-TABLE w-craperr  NO-UNDO
           FIELD cdagenci   LIKE craperr.cdagenc
           FIELD nrdcaixa   LIKE craperr.nrdcaixa
           FIELD nrsequen   LIKE craperr.nrsequen
           FIELD cdcritic   LIKE craperr.cdcritic
           FIELD dscritic   LIKE craperr.dscritic
           FIELD erro       LIKE craperr.erro.
    
    DEFINE TEMP-TABLE tt-cheques NO-UNDO
           FIELD dtlibera AS DATE
           FIELD nrdocmto AS INTE
           FIELD vlcompel AS DECI
           INDEX tt-cheques1 nrdocmto dtlibera.
    
    ASSIGN v_conta      = GET-VALUE("v_pconta")
           v_nome       = GET-VALUE("v_pnome")
           v_poupanca   = GET-VALUE("v_ppoup")
           v_valor1     = STRING(DEC(GET-VALUE("v_pvalor1")),"zzz,zzz,zzz,zz9.99")
           v_caixa      = GET-VALUE("User_cx")
           v_operador   = GET-VALUE("operador")
           v_pac        = GET-VALUE("User_pac")
           v_data       = GET-VALUE("v_data") 
           v_coop       = get-value("user_coop")
           v_totdepos   = 0
           v_qtdchqs    = 0
           v_nrsequni   = GET-VALUE("v_pnrsequni")
           v_dtenvelo   = GET-VALUE("v_pdtenvelo")
           v_cod        = GET-VALUE("v_cod")
           v_senha      = GET-VALUE("v_senha")
           NO-ERROR.
    
    /* Criada para montar o JavaScript nao ficar com o código feio */
    PROCEDURE JavaScript:

        {include/monta_js.i} /* Utilizada includes pois o programa não compila*/
        
    END PROCEDURE.    
    
    FIND crapcop WHERE crapcop.nmrescop = v_coop NO-LOCK NO-ERROR.
    
    IF  REQUEST_METHOD = "POST":U  THEN 
        DO:                   
            /* Montar o Resumo */
            /* Buscar os totais de cheque maior e menor da Praca ou fora Praca */
            FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                   crapmdw.cdagenci = INT(v_pac) AND
                                   crapmdw.nrdcaixa = INT(v_caixa) NO-LOCK:
                ASSIGN v_qtdchqs = v_qtdchqs + 1
                       v_totdepos = v_totdepos + crapmdw.vlcompel.
            END.
            /* Fim da montagem dos dados do resumo */        

            IF  GET-VALUE("ok") <> "" THEN 
                DO:
                    ASSIGN l-houve-erro = NO.
                                                                  
                    DO  TRANSACTION ON ERROR UNDO:
                        
                        RUN dbo/b1crap66.p PERSISTENT SET h-b1crap66.

                        RUN atualiza-deposito-com-captura IN h-b1crap66(INPUT v_coop,
                                                                        INPUT INT(v_pac),
                                                                        INPUT INT(v_caixa),
                                                                        INPUT v_operador,
                                                                        INPUT INT(v_conta),
                                                                        INPUT v_nome,
                                                                        INPUT "",
                                                                        INPUT v_cod,
                                                                        INPUT v_senha,
                                                                        OUTPUT p-literal,
                                                                        OUTPUT p-ult-sequencia,
                                                                        OUTPUT p-nro-docto).
                        DELETE PROCEDURE h-b1crap66.
                        
                        IF  RETURN-VALUE = "NOK" THEN 
                            DO:
                                
                                ASSIGN l-houve-erro = YES.
                                
                                EMPTY TEMP-TABLE w-craperr.
                                
                                FOR EACH craperr WHERE craperr.cdcooper =  crapcop.cdcooper  AND
                                                       craperr.cdagenci =  INT(v_pac)        AND
                                                       craperr.nrdcaixa =  INT(v_caixa)  NO-LOCK :
                                    CREATE w-craperr.
                                    ASSIGN w-craperr.cdagenci   = craperr.cdagenc
                                           w-craperr.nrdcaixa   = craperr.nrdcaixa
                                           w-craperr.nrsequen   = craperr.nrsequen
                                           w-craperr.cdcritic   = craperr.cdcritic
                                           w-craperr.dscritic   = craperr.dscritic
                                           w-craperr.erro       = craperr.erro.
                                END.
                                
                                find last w-craperr no-lock no-error.
                                
                                UNDO.
                            END.

                    END. /* Final da Transacao*/
    
                    IF  l-houve-erro = YES  THEN 
                        DO:
                            FOR EACH craperr WHERE 
                                     craperr.cdcooper = crapcop.cdcooper  AND
                                     craperr.cdagenci = INTE(v_pac)       AND
                                     craperr.nrdcaixa = INTE(v_caixa)
                                     EXCLUSIVE-LOCK:
                                     DELETE craperr.
                            END.
                      
                            FOR EACH w-craperr NO-LOCK:
                                CREATE craperr.
                                ASSIGN craperr.cdcooper   = crapcop.cdcooper
                                       craperr.cdagenci   = w-craperr.cdagenc
                                       craperr.nrdcaixa   = w-craperr.nrdcaixa
                                       craperr.nrsequen   = w-craperr.nrsequen
                                       craperr.cdcritic   = w-craperr.cdcritic
                                       craperr.dscritic   = w-craperr.dscritic
                                       craperr.erro       = w-craperr.erro.
                                VALIDATE craperr.
                            END.
                            
                            FIND FIRST craperr NO-LOCK  where
                                       craperr.cdcooper = crapcop.cdcooper AND
                                       craperr.cdagenci = INT(v_pac)   and
                                       craperr.nrdcaixa = INT(v_caixa) no-error.
                           
                            IF  AVAIL craperr  THEN
                                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").

                        END. /* Final do IF erro YES */
                    ELSE
                        DO: 
                            RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
                            RUN atualiza-previa-caixa  IN h-b1crap00  (INPUT v_coop,
                                                                       INPUT int(v_pac),
                                                                       INPUT int(v_caixa),
                                                                       INPUT v_operador,
                                                                       INPUT v_data,
                                                                       INPUT 3). /*Consulta*/ 
                            IF   RETURN-VALUE = "NOK" THEN DO:
                               {include/i-erro.i}
                            END.

                            DELETE PROCEDURE h-b1crap00. 
                            /**********
                            Não apresentar tela de autenticação
                            RUN JavaScript("window.open('autentica.html?v_plit=" + STRING(p-literal) + "&v_pseq=" + STRING(p-ult-sequencia) + "&v_prec=YES&v_psetcook=yes','waut','width=250,height=145,scrollbars=auto,alwaysRaised=true')").
                            **********/
                            FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                   crapmdw.cdagenci = INT(v_pac)       AND
                                                   crapmdw.nrdcaixa = INT(v_caixa)     EXCLUSIVE-LOCK:
                                DELETE crapmdw.
                            END.

                            FOR EACH crapmrw WHERE crapmrw.cdcooper = crapcop.cdcooper AND
                                                   crapmrw.cdagenci = INT(v_pac) AND
                                                   crapmrw.nrdcaixa = INT(v_caixa) EXCLUSIVE-LOCK:
                                DELETE crapmrw.
                            END.

                      
                            RUN JavaScript("window.location='crap066.w'").
                      
                        END. /* Final do IF erro NO */

                    /* se apertou ok e tem erro */
                    IF  get-value("ok") <> "" AND get-value("autentica") = ""  THEN
                        DO:
                            FIND FIRST craperr NO-LOCK  where
                                       craperr.cdcooper = crapcop.cdcooper AND
                                       craperr.cdagenci = INT(v_pac)   and
                                       craperr.nrdcaixa = INT(v_caixa) no-error.
                                      
                            IF  AVAIL craperr  THEN
                                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                        END.

                END. /* Final do GET VALUE OK <> "" */
            ELSE 
            IF  GET-VALUE("retorna") <> ""  THEN 
                DO:
                    IF  GET-VALUE("v_pvalor1") <> "" THEN 
                        RUN JavaScript("window.location='crap066b.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pvalor1=" + STRING(v_valor1) + "'").
                   ELSE 
                        RUN JavaScript("window.location='crap066.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pvalor1=" + STRING(v_valor1) + "'").                       
                END.
            ELSE
            IF  GET-VALUE("autentica") <> ""  THEN 
                DO:
                    RUN dbo/b1crap66.p PERSISTENT SET h-b1crap66.
                    RUN critica-cheque-cooperativa-autenticado IN h-b1crap66(INPUT v_coop,
                                                                             INPUT INT(v_pac),
                                                                             INPUT INT(v_caixa),
                                                                             INPUT NO,
                                                                             INPUT NO).
                    DELETE PROCEDURE h-b1crap66.
                    
                    IF  RETURN-VALUE = "NOK"  THEN 
                        DO:
                            FIND FIRST craperr NO-LOCK  where
                                       craperr.cdcooper = crapcop.cdcooper AND
                                       craperr.cdagenci = INT(v_pac)   and
                                       craperr.nrdcaixa = INT(v_caixa) no-error.
        
                            IF  AVAIL craperr  THEN
                                RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                        END.
                END.

        END.
    ELSE /* GET */
        DO:
            RUN dbo/b1crap66.p PERSISTENT SET h-b1crap66.
            
            RUN gera-tabela-resumo-cheques IN h-b1crap66(INPUT v_coop,
                                                         INPUT INT(v_pac),
                                                         INPUT INT(v_caixa),
                                                         INPUT v_operador,
                                                         INPUT INT(GET-VALUE("v_pconta"))).
            DELETE PROCEDURE h-b1crap66.            
        
            /* Montar o Resumo */
            /* Buscar os totais de cheque */
            FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                   crapmdw.cdagenci = INT(v_pac) AND
                                   crapmdw.nrdcaixa = INT(v_caixa) NO-LOCK:
                
                ASSIGN v_qtdchqs = v_qtdchqs + 1
                       v_totdepos = v_totdepos + crapmdw.vlcompel.
            END.
            /* Fim da montagem dos dados do resumo */        
        END.

    PROCEDURE reinicia-crapmdw:
    
        DEF INPUT PARAM p-cod-agencia AS INT NO-UNDO.
        DEF INPUT PARAM p-nr-caixa    AS INT NO-UNDO.
        
        FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                               crapmdw.cdagenci   = p-cod-agencia    AND 
                               crapmdw.nrdcaixa   = p-nr-caixa       EXCLUSIVE-LOCK:
            ASSIGN crapmdw.inautent = NO.
        END.
    
    END PROCEDURE.
</script>
<form name="action" id="action" onKeyDown="change_page(event)" method=post>

<input type="hidden" name="vh_foco" value="9">
<input type="hidden" name="v_msg">
<input type="hidden" name="v_nrsequni">
<input type="hidden" name="v_dtenvelo">
<p style="word-spacing: 0; line-height: 100%; margin-top: 0; margin-bottom: 0">&nbsp;</p>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td width="15%" align="center"> <input type="text" name="v_coop" value="`v_coop`" size="11" class="transp" readOnly>
      </td>
      <td width="20%" align="center"> PA&nbsp; <input type="text" name="v_pac" value="`v_pac`" size="1" class="transp"  readOnly>
      </td>
      <td width="20%" align="center"> CAIXA&nbsp; <input type="text" name="v_caixa" value="`v_caixa`" size="1" class="transp" readOnly>
      </td>
      <td width="30%" align="center"> OPERADOR&nbsp; <input type="text" name="v_operador" value="`v_operador`" name="" size="7" class="transp" readOnly>
      </td>
      <td width="15%" align="center"> <input type="text" name="v_data" value="`GET-VALUE("v_data")`" size="10" class="transp" readOnly>
      </td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td class=titulo>LANÇAMENTO DE CHEQUES</td>
      <td width="21%" class=programa align="right">P.066c&nbsp; V.1.00</td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
<table cellspacing = 0 cellpadding= 0 width=100%>
  <tr>
    <td width="100%" valign="middle" align="center">
      <div align="center">
        <center>
      <table width="101%" cellspacing = 0 cellpadding = 1 class=tcampo>
        <tr>
          <td width="34%" align="right" class="linhaform"></td>
          <td width="67%">
          &nbsp;
          </td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform">Conta/DV:</td>
          <td width="67%">
          <input type="text" name="v_conta" value="`v_conta`" size="10" class="input" maxlength="8" onKeyDown="JavaScript:validaInteiro(event)" style="text-align: right" disabled>
                   <input type="text" name="v_nome" value="`v_nome`" size="40" class="input" disabled maxlength="40" style="font-weight: bold">
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="23%"></td>
          <td align="left" class="linhaform" width="77%">
          <input type="text" name="v_poupanca" value="`v_poupanca`" size="52" class="input" maxlength="50" disabled>
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="23%">Cheque:</td>
          <td align="left" class="linhaform" width="77%">
          <input type="text" name="v_valor1" value="`v_valor1`" size="20" class="input" onKeyUp="callCalc(event, this)" onKeyDown="JavaScript:FormataValor(this,14,event)" maxlength="18" style="text-align: right" disabled>
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="15%" colspan="2">
            <hr class="input">
            </td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform">Total do Depósito:</td>
          <td width="67%"><input type="text" name="v_totdepos" value="`STRING(v_totdepos,"zzz,zzz,zzz,zz9.99")`" size="20" class="input" maxlength="14" style="text-align: right" disabled></td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform">Qtde. Cheques:</td>
          <td width="67%"><input type="text" name="v_qtdchqs" value="`STRING(v_qtdchqs)`" size="20" class="input" maxlength="14" style="text-align: right" disabled></td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp;</td>
        </tr>
        <tr>
          <td class=linhaform align="right">Código:</td>
          <td colspan="2"><input class=input type="text" name="v_cod" size="12" maxlength="10"></td>
        </tr>
        <tr>
          <td class=linhaform align="right">Senha:</td>
          <td colspan="2"><input class=input type="password" name="v_senha" size="12" maxlength="10"></td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp;</td>
        </tr>
        <tr>
          <td width="101%" align="center" class="linhaform" colspan="2">
          <input type="submit" value="Ok" name="sok" onClick="desabok()" class="button"><input type="hidden" name="ok" value="">
          </td>
        </tr>
        <tr>
          <td width="101%" align="center" class="linhaform" colspan="2">&nbsp; </td>
        </tr>
      </table>
        </center>
      </div>
      </td>
      </tr>
</table>      
  </center>
</div>
 <div align="center">
  <table width="100%">
        <tr>
           <td align="right" class="linhaform">
           <input type="submit" value="Retornar" name="retorna" class="button2">
           </td>
        </tr>
  </table>      
</div>
</form>
</body>

</html>


