<!-- ............................................................................

   Programa: siscaixa/web/crap051c.htm
   Sistema : Conta-Corrente - Cooperativa de Credito
   Sigla   : CRED
   Autor   : Guilherme
   Data    : Outubro/2009                    Ultima atualizacao: 24/07/2017

   Dados referentes ao programa:

   Frequencia: Diario (Caixa Online).
   Objetivo  : Processar a rotina 051c

   Alteracoes: 22/03/2010 - Tratar o campo nrsequni e dtenvelo para liberar
                            os envelopes depositados no cash e lancados na
                            rotina 61 (Evandro).
                            
               28/12/2010 - Tratamento para cheques de contas migradas 
                            (Guilherme).   
                            
               03/05/2012 - Realizado tratamento para remoção do botao 
                            autenticar que chama a crap051d.p pois será feito
                            automaticamente. (David Kruger).
               11/11/2013 - Nova forma de chamar as agências, de PAC agora 
                            a escrita será PA (Guilherme Gielow)                      
               
               12/12/2013 - Alteracao referente a integracao Progress X 
                            Dataserver Oracle 
                            Inclusao do VALIDATE ( André Euzébio / SUPERO) 

              28/11/2014 - Utilizar funcao js para nao deixar digitar caracteres 
                           e numeros negativo para o valor em dinheiro e cheque. 
                           (Douglas - Chamado 226702)
                           
              06/05/2015 - Alteração no formato de valores (Lunelli SD 264635).
             
              12/09/2016 - Adicionado chamada da função "callBlass(event)" - (Evandro - RKAM).                
              10/10/2016 - Incluir log na chamada da rotina crap051e -  CONTROLE 
                           de movimentacao em especie (Lucas Ranghetti #463572)
              
              21/06/2017 - Substituidos os históricos 3 e 4 pelo histórico 6-DEPOSITO BLOQ. 
                           PRJ367 - Compe Sessao Unica (LOMBARDI)
                           
              24/07/2017 - Incluir log para cada inclusao de deposito de cheque afim de 
                           identificar o motivo de nao solicitar operador para quando nao
                           tem saldo para compensar o cheque (Lucas Ranghetti #679029)
   ......................................................................... -->

<html>

<head>
<meta http-equiv="Content-Language" content="pt-br">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Pragma"        content="No-Cache">
<meta http-equiv="Expires"       content="0">
<script language=JavaScript src="/script/formatadadosie.js"></script>
<link rel=StyleSheet type="text/css" href="/script/viacredi.css">
<title>DEPÓSITO COM CAPTURA</title>
</head>


<body background="/images/moeda.jpg" bgproperties="fixed" class="fundo" onLoad="JavaScript:mudaFoco(); click();" onKeyUp="callBlass(event); callBLini(event); callBLsal(event);"> 
<script language="JavaScript">
habilita = new Array();
function desabilitaForm() { 
    for (var i = 0; i < window.document.forms[0].elements.length; i++) { 
        habilita[i] = window.document.forms[0].elements[i].disabled;
        window.document.forms[0].elements[i].disabled=true; 
    } 
}
function reabilitaForm() { 
    for (var j = 0; j < window.document.forms[0].elements.length; j++) { 
        window.document.forms[0].elements[j].disabled = habilita[j]; 
    } 
}
</script>
<script language="SpeedScript">

    DEF VAR v_coop        AS CHAR NO-UNDO.
    DEF VAR v_conta       AS CHAR NO-UNDO.
    DEF VAR v_nome        AS CHAR NO-UNDO.
    DEF VAR v_pac         AS CHAR NO-UNDO.
    DEF VAR v_caixa       AS CHAR NO-UNDO.
    DEF VAR v_operador    AS CHAR NO-UNDO.
    DEF VAR v_data        AS CHAR NO-UNDO.
    DEF VAR v_rowid       AS CHAR NO-UNDO.
    DEF VAR v_msg         AS CHAR NO-UNDO.
    DEF VAR vh_foco       AS CHAR NO-UNDO.
    DEF VAR v_poupanca    AS CHAR NO-UNDO.
    DEF VAR v_identifica  AS CHAR NO-UNDO.
    DEF VAR v_valor       AS CHAR NO-UNDO.
    DEF VAR v_valor1      AS CHAR NO-UNDO.
    DEF VAR v_valor2      AS DECI NO-UNDO.
    DEF VAR v_chequescoop AS DECI NO-UNDO.
    DEF VAR aux_qtddchqs  AS INTE NO-UNDO.
    DEF VAR v_totdepos    AS DECI NO-UNDO.
    DEF VAR v_qtdchqs     AS INTE NO-UNDO.
    DEF VAR v_nrsequni    AS CHAR NO-UNDO.
    DEF VAR v_dtenvelo    AS CHAR NO-UNDO.
    DEF VAR v_flg-cta-migrada AS LOGICAL NO-UNDO.
    DEF VAR v_coop-migrada    AS CHAR NO-UNDO.
    DEF VAR v_flg-coop-host   AS LOGICAL NO-UNDO.
    DEF VAR v_nro-conta-nova  AS CHAR NO-UNDO.
    DEF VAR v_nro-conta-anti  AS CHAR NO-UNDO.
    DEF VAR v_pestorno        AS LOG NO-UNDO.
    
    DEFINE VARIABLE h-b1crap00 AS HANDLE     NO-UNDO. 
    DEFINE VARIABLE h-b1crap51 AS HANDLE     NO-UNDO.
    DEFINE VARIABLE h-b1crap61 AS HANDLE     NO-UNDO.
    DEFINE VARIABLE h-b1crap02 AS HANDLE     NO-UNDO.

    DEF VAR p-literal           AS CHAR            NO-UNDO.
    DEF VAR p-ult-sequencia     AS INTE            NO-UNDO.
    DEF VAR p-programa          AS CHAR   INITIAL "CRAP051".      
    DEFINE VARIABLE p-nro-docto AS INTEGER         NO-UNDO.
    DEF VAR l-houve-erro        AS LOG             NO-UNDO.
    DEF VAR c-nome              AS CHAR            NO-UNDO.
    DEF VAR c-poup              AS CHAR            NO-UNDO.
    DEF VAR aux_achou           AS LOGI            NO-UNDO. 
    DEF VAR aux_nmarqlog        AS CHAR            NO-UNDO.
    DEF VAR de-valor-bloqueado      AS DEC                    NO-UNDO.
    DEF VAR de-valor-liberado       AS DEC                    NO-UNDO.
    def var aux_limite-credito as dec              no-undo.


    DEFINE TEMP-TABLE w-craperr  NO-UNDO
           FIELD cdagenci   LIKE craperr.cdagenc
           FIELD nrdcaixa   LIKE craperr.nrdcaixa
           FIELD nrsequen   LIKE craperr.nrsequen
           FIELD cdcritic   LIKE craperr.cdcritic
           FIELD dscritic   LIKE craperr.dscritic
           FIELD erro       LIKE craperr.erro.
    
    DEFINE TEMP-TABLE tt-cheques NO-UNDO
           FIELD dtlibera AS DATE
           FIELD nrdocmto AS INTE
           FIELD vlcompel AS DECI
           INDEX tt-cheques1 nrdocmto dtlibera.
    
    
DEF TEMP-TABLE tt-conta NO-UNDO
        FIELD situacao           AS CHAR FORMAT "x(21)"
        FIELD tipo-conta         AS CHAR FORMAT "x(21)"
        FIELD empresa            AS CHAR FORMAT "x(15)"
        FIELD devolucoes         AS INT  FORMAT "99"
        FIELD agencia            AS CHAR FORMAT "x(15)"
        FIELD magnetico          AS INT  FORMAT "z9"
        FIELD estouros           AS INT  FORMAT "zzz9"
        FIELD folhas             AS INT  FORMAT "zzz,zz9"
        FIELD identidade         AS CHAR
        FIELD orgao              AS CHAR
        FIELD cpfcgc             AS CHAR
        FIELD disponivel         AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD bloqueado          AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD bloq-praca         AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD bloq-fora-praca    AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD cheque-salario     AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD saque-maximo       AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD acerto-conta       AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD db-cpmf            AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD limite-credito     AS DEC
        FIELD ult-atualizacao    AS DATE
        FIELD saldo-total        AS DEC FORMAT "zzz,zzz,zzz,zz9.99-"
        FIELD nome-tit           AS CHAR
        FIELD nome-seg-tit       AS CHAR                         
        FIELD capital            AS DEC FORMAT "zzz,zzz,zzz,zz9.99-".
    
    ASSIGN v_conta      = GET-VALUE("v_pconta")
           v_nome       = GET-VALUE("v_pnome")
           v_poupanca   = GET-VALUE("v_ppoup")
           v_identifica = GET-VALUE("v_pidentifica")
           v_valor      = STRING(DEC(GET-VALUE("v_pvalor")),"zzz,zzz,zzz,zz9.99")
           v_valor1     = STRING(DEC(GET-VALUE("v_pvalor1")),"zzz,zzz,zzz,zz9.99")
           v_caixa      = GET-VALUE("User_cx")
           v_operador   = GET-VALUE("operador")
           v_pac        = GET-VALUE("User_pac")
           v_data       = GET-VALUE("v_data") 
           v_coop       = get-value("user_coop")
           v_totdepos   = 0
           v_qtdchqs    = 0
           v_nrsequni   = GET-VALUE("v_pnrsequni")
           v_dtenvelo   = GET-VALUE("v_pdtenvelo")
           v_coop-migrada    = GET-VALUE("v_coop-migrada")
           v_nro-conta-nova  = GET-VALUE("v_nro-conta-nova")
           v_nro-conta-anti  = GET-VALUE("v_nro-conta-anti")
           v_pestorno = LOGICAL(GET-VALUE("v_pestorno")) NO-ERROR.
    
    IF  GET-VALUE("v_flg-coop-host") <> ""  THEN
        v_flg-coop-host   = LOGICAL(GET-VALUE("v_flg-coop-host")).
    ELSE
        v_flg-coop-host   = FALSE.

    IF  GET-VALUE("v_flg-cta-migrada") <> ""  THEN
        v_flg-cta-migrada = LOGICAL(GET-VALUE("v_flg-cta-migrada")).
    ELSE
        v_flg-cta-migrada = FALSE.

    /* Criada para montar o JavaScript nao ficar com o código feio */
    PROCEDURE JavaScript:

        {include/monta_js.i} /* Utilizada includes pois o programa não compila*/
        
    END PROCEDURE.    
    
    FIND crapcop WHERE crapcop.nmrescop = v_coop NO-LOCK NO-ERROR.
    
    IF  REQUEST_METHOD = "POST":U  THEN 
        DO:                   
            /* Montar o Resumo */
            /* Buscar os totais de dinheiro e Cheque Cooperativa */
            FIND FIRST crapmrw WHERE crapmrw.cdcooper  = crapcop.cdcooper AND
                                     crapmrw.cdagenci  = INT(v_pac)       AND
                                     crapmrw.nrdcaixa  = INT(v_caixa) NO-LOCK NO-ERROR.
        
            IF  AVAIL crapmrw  THEN 
                ASSIGN v_valor2 = crapmrw.vldepdin
                       v_chequescoop = crapmrw.vlchqcop
                       v_totdepos = v_totdepos + crapmrw.vldepdin + crapmrw.vlchqcop.
            
            /* Buscar os totais de cheque maior e menor da Praca ou fora Praca */
            FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                   crapmdw.cdagenci = INT(v_pac) AND
                                   crapmdw.nrdcaixa = INT(v_caixa) NO-LOCK:
                ASSIGN v_qtdchqs = v_qtdchqs + 1.
        
                FIND tt-cheques WHERE tt-cheques.dtlibera = crapmdw.dtlibcom AND
                                      tt-cheques.nrdocmto = crapmdw.nrdocmto
                                      EXCLUSIVE-LOCK NO-ERROR NO-WAIT.
        
                IF  NOT AVAIL tt-cheques  THEN
                    CREATE tt-cheques.
                
                IF  crapmdw.cdhistor = 2433  THEN
                    ASSIGN tt-cheques.nrdocmto = 6
                           tt-cheques.dtlibera = crapmdw.dtlibcom
                           tt-cheques.vlcompel = tt-cheques.vlcompel + crapmdw.vlcompel
                           v_totdepos = v_totdepos + crapmdw.vlcompel.
            
                FIND CURRENT tt-cheques NO-LOCK.
                
                ASSIGN aux_limite-credito = 0
                       de-valor-liberado  = 0
                       de-valor-bloqueado = 0.
               
                IF GET-VALUE("ok") <> "" THEN 
                   DO:                     
                        RUN dbo/b1crap02.p PERSISTENT SET h-b1crap02.
             
                        RUN consulta-conta IN h-b1crap02(INPUT v_coop,
                                                         INPUT int(v_pac),
                                                         INPUT int(v_caixa),
                                                         INPUT crapmdw.nrctaaux,
                                                        OUTPUT TABLE tt-conta).
                        DELETE PROCEDURE h-b1crap02.
                         
                         FIND FIRST tt-conta NO-LOCK NO-ERROR.
                         IF  AVAIL tt-conta   THEN  
                             DO:
                                 IF  tt-conta.cheque-salario = 0   THEN
                                     DO:
                                         ASSIGN de-valor-bloqueado = 
                                                         tt-conta.bloqueado      +
                                                         tt-conta.bloq-praca     +
                                                         tt-conta.bloq-fora-praca
                                                de-valor-liberado = tt-conta.acerto-conta.
                                     END.
                                     
                                 ASSIGN aux_limite-credito = tt-conta.limite-credito.
                             END.
                             
                         ASSIGN aux_nmarqlog = "/usr/coop/" + crapcop.dsdircop + 
                                                         "/log/caixa_online_"            +
                                                         STRING(YEAR(TODAY),"9999")      +
                                                         STRING(MONTH(TODAY),"99")       +
                                                         STRING(DAY(TODAY),"99") + ".log".    
                                                         
                        /* Logar para identificar se cooperado tera saldo para cobrir o deposito */
                         UNIX SILENT VALUE("echo " +  
                                         STRING(TIME,"HH:MM:SS") + "' --> '"          +
                                         "ROTINA: " + CAPS(p-programa) + "/CRAP051c"  +
                                         " PA: " + STRING(v_pac)                      +
                                         " CAIXA: " + STRING(v_caixa)                 +
                                         " OPERADOR: " + STRING(v_operador)           +
                                         " CONTA DEPOSITADA: " + STRING(v_conta)      +
                                         " BANCO: " + STRING(crapmdw.cdbanchq)        +
                                         " AGENCIA: " + STRING(crapmdw.cdagechq)      +                                                 
                                         " CONTA CHEQUE: " + STRING(crapmdw.nrctabdb) +
                                         " CHEQUE: " + string(crapmdw.nrcheque)       + 
                                         " VALOR CHEQUE: " + STRING(crapmdw.vlcompel,"zzzz,zz9.99") +
                                         " SALDO CONTA CHEQUE: " + STRING(de-valor-liberado,"-zzz,zzz,zz9.99") + 
                                         " VALOR LIMITE: " + STRING(aux_limite-credito,"zzz,zzz,zz9.99")       + 
                                         " CMC7: '" + STRING(crapmdw.dsdocmc7)        +
                                         "' >> " + aux_nmarqlog).  
                   END.
            END.
            /* Fim da montagem dos dados do resumo */        
             
            IF  GET-VALUE("ok") <> "" THEN 
                DO:
                   ASSIGN l-houve-erro = NO.

                   DO  WHILE TRUE:
                        
                        FIND FIRST crapass NO-LOCK WHERE
                                   crapass.cdcooper = crapcop.cdcooper  AND
                                   crapass.nrdconta = INT(v_conta) NO-ERROR.
                        
                        IF  NOT AVAIL crapass THEN
                            LEAVE.
                        
                        IF  AVAIL crapass THEN 
                            DO:
                                IF  CAN-DO("2,4,6,8",STRING(crapass.cdsitdtl))   THEN  
                                    DO:
                                        FIND FIRST craptrf WHERE craptrf.cdcooper = crapcop.cdcooper AND
                                                                 craptrf.nrdconta = crapass.nrdconta AND
                                                                 craptrf.tptransa = 1 AND
                                                                 craptrf.insittrs = 2 
                                                                 NO-LOCK USE-INDEX craptrf1 NO-ERROR.
                              
                                        IF AVAIL craptrf THEN
                                           ASSIGN v_conta = string(craptrf.nrsconta).
                                        ELSE
                                           LEAVE.
                                    END.
                                ELSE
                                    LEAVE.       
                            END.
                   END.
                   DO:  
                       DO  TRANSACTION ON ERROR UNDO:
                
                           RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.

                           IF  NOT v_flg-cta-migrada  THEN
                           RUN atualiza-deposito-com-captura IN h-b1crap51(INPUT v_coop,
                                                                    INPUT INT(v_pac),
                                                                    INPUT INT(v_caixa),
                                                                    INPUT v_operador,
                                                                    INPUT INT(v_conta),
                                                                    INPUT v_nome,
                                                                    INPUT v_identifica,
                                                                    INPUT v_pestorno,
                                                                    OUTPUT p-literal,
                                                                    OUTPUT p-ult-sequencia,
                                                                    OUTPUT p-nro-docto).
                           ELSE
                           DO:
                               IF  NOT v_flg-coop-host  THEN
                               RUN atualiza-deposito-com-captura-migrado IN h-b1crap51(INPUT v_coop,
                                                                                 INPUT v_coop-migrada,
                                                                                 INPUT INT(v_pac),
                                                                                 INPUT INT(v_caixa),
                                                                                 INPUT v_operador,
                                                                                 INPUT INT(v_conta),
                                                                                 INPUT v_nome,
                                                                                 INPUT v_identifica,
                                                                                 INPUT INT(v_nro-conta-nova),
                                                                                 INPUT INT(v_nro-conta-anti),
                                                                                 INPUT v_pestorno,
                                                                                 OUTPUT p-literal,
                                                                                 OUTPUT p-ult-sequencia,
                                                                                 OUTPUT p-nro-docto).
                               ELSE
                               RUN atualiza-deposito-com-captura-migrado-host IN h-b1crap51(INPUT v_coop,
                                                                                       INPUT v_coop-migrada,
                                                                                       INPUT INT(v_pac),
                                                                                       INPUT INT(v_caixa),
                                                                                       INPUT v_operador,
                                                                                       INPUT INT(v_conta),
                                                                                       INPUT v_nome,
                                                                                       INPUT v_identifica,
                                                                                       INPUT INT(v_nro-conta-nova),
                                                                                       INPUT INT(v_nro-conta-anti),
                                                                                       INPUT v_pestorno,
                                                                                       OUTPUT p-literal,
                                                                                       OUTPUT p-ult-sequencia,
                                                                                       OUTPUT p-nro-docto).
                           END.
                           
                           DELETE PROCEDURE h-b1crap51.

                           /* Caso esteja liberando envelopes depositados no cash */
                           IF  v_nrsequni <> ""  THEN
                               DO:
                                   RUN dbo/b1crap61.p PERSISTENT SET h-b1crap61.
                                   
                                   RUN libera_envelope IN h-b1crap61(INPUT v_coop,
                                                                     INPUT INT(v_pac),
                                                                     INPUT INT(v_caixa),
                                                                     INPUT DATE(v_dtenvelo),
                                                                     INPUT INT(v_nrsequni),
                                                                     INPUT p-ult-sequencia).
                                   DELETE PROCEDURE h-b1crap61.
                               END.
                           
                           IF  RETURN-VALUE = "NOK" THEN 
                               DO:
                                   
                                   ASSIGN l-houve-erro = YES.
                                   
                                   EMPTY TEMP-TABLE w-craperr.
                                   
                                   FOR EACH craperr WHERE craperr.cdcooper =  crapcop.cdcooper  AND
                                                          craperr.cdagenci =  INT(v_pac)        AND
                                                          craperr.nrdcaixa =  INT(v_caixa)  NO-LOCK :
                                       CREATE w-craperr.
                                       ASSIGN w-craperr.cdagenci   = craperr.cdagenc
                                              w-craperr.nrdcaixa   = craperr.nrdcaixa
                                              w-craperr.nrsequen   = craperr.nrsequen
                                              w-craperr.cdcritic   = craperr.cdcritic
                                              w-craperr.dscritic   = craperr.dscritic
                                              w-craperr.erro       = craperr.erro.
                                   END.
                                   
                                   find last w-craperr no-lock no-error.
                                   
                                   UNDO.
                               END.
                       
                       END. /* Final da Transacao*/
        
                       IF  l-houve-erro = YES  THEN 
                           DO:
                               IF  CAN-FIND(FIRST crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                                               crapmdw.cdagenci = INT(v_pac)        AND
                                                               crapmdw.nrdcaixa = INT(v_caixa)      AND
                                                               crapmdw.cdhistor = 386)  THEN 
                                   DO:
                                       
                                       RUN reinicia-crapmdw IN THIS-PROCEDURE(INPUT INT(v_pac),
                                                                              INPUT INT(v_caixa)).
                       
                                       RUN JavaScript("window.open('crap051d.p?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor=" + STRING(v_valor) + "&v_pvalor1=" + STRING(v_valor1) + "&v_pestorno=YES','wautcoop','width=500,height=290,scrollbars=auto,alwaysRaised=true')").
                                                  
                       
                                   END. 
                         
                               FOR EACH craperr WHERE 
                                        craperr.cdcooper = crapcop.cdcooper  AND
                                        craperr.cdagenci = INTE(v_pac)       AND
                                        craperr.nrdcaixa = INTE(v_caixa)
                                        EXCLUSIVE-LOCK:
                                        DELETE craperr.
                               END.
                         
                               FOR EACH w-craperr NO-LOCK:
                                   CREATE craperr.
                                   ASSIGN craperr.cdcooper   = crapcop.cdcooper
                                          craperr.cdagenci   = w-craperr.cdagenc
                                          craperr.nrdcaixa   = w-craperr.nrdcaixa
                                          craperr.nrsequen   = w-craperr.nrsequen
                                          craperr.cdcritic   = w-craperr.cdcritic
                                          craperr.dscritic   = w-craperr.dscritic
                                          craperr.erro       = w-craperr.erro.
                                   VALIDATE craperr.
                               END.
                               
                               FIND FIRST craperr NO-LOCK  where
                                          craperr.cdcooper = crapcop.cdcooper AND
                                          craperr.cdagenci = INT(v_pac)   and
                                          craperr.nrdcaixa = INT(v_caixa) no-error.
                       
                               IF  AVAIL craperr  THEN
                                   RUN JavaScript("window.open('mensagem.p','werro','height=220,width=400,scrollbars=yes,alwaysRaised=true')").
                       
                           END. /* Final do IF erro YES */
                       ELSE
                           DO: 
                               ASSIGN   aux_achou = FALSE.
                               FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper     AND
                                                      crapmdw.cdagenci = int(v_pac)           AND
                                                      crapmdw.nrdcaixa = int(v_caixa) NO-LOCK:
                                   
                                   FIND FIRST crapfdc WHERE crapfdc.cdcooper = crapmdw.cdcooper AND
                                                            crapfdc.cdbanchq = crapmdw.cdbanchq AND
                                                            crapfdc.cdagechq = crapmdw.cdagechq AND
                                                            crapfdc.nrctachq = crapmdw.nrctabdb AND
                                                            crapfdc.nrcheque = crapmdw.nrcheque 
                                                            NO-LOCK NO-ERROR.
    
    
                                   
                                   IF  AVAIL crapfdc THEN
                                       ASSIGN aux_achou = true.
                                   

                                   

                                                                             
                               END.
                                
                               IF   NOT aux_achou THEN
                                    DO:
                                           RUN dbo/b1crap00.p PERSISTENT SET h-b1crap00.
                                           RUN atualiza-previa-caixa  IN h-b1crap00  (INPUT v_coop,
                                                                                      INPUT int(v_pac),
                                                                                      INPUT int(v_caixa),
                                                                                      INPUT v_operador,
                                                                                      INPUT v_data,
                                                                                      INPUT 3). /*Consulta*/ 
                                           IF   RETURN-VALUE = "NOK" THEN DO:
                                              {include/i-erro.i}
                                           END.
                                           DELETE PROCEDURE h-b1crap00. 
                                    END.
                               
                               RUN JavaScript("window.open('autentica.html?v_plit=" + STRING(p-literal) + "&v_pseq=" + STRING(p-ult-sequencia) + "&v_prec=YES&v_psetcook=yes','waut','width=250,height=145,scrollbars=auto,alwaysRaised=true')").
                         
                               IF  DEC(v_valor2) <> 0  THEN  
                                   DO:
                                       FIND craptab NO-LOCK WHERE
                                            craptab.cdcooper = crapcop.cdcooper  AND
                                            craptab.nmsistem = "CRED"            AND
                                            craptab.tptabela = "GENERI"          AND
                                            craptab.cdempres = 0                 AND
                                            craptab.cdacesso = "VLCTRMVESP"      AND
                                            craptab.tpregist = 0  NO-ERROR.
                                       IF  AVAIL craptab   THEN  
                                           DO:     
                                               IF  DEC(v_valor2) >= DEC(craptab.dstextab)  THEN 
                                                   do:
                                                       ASSIGN aux_nmarqlog = "/usr/coop/" + crapcop.dsdircop + 
                                                                             "/log/caixa_online_"            +
                                                                             STRING(YEAR(TODAY),"9999")      +
                                                                             STRING(MONTH(TODAY),"99")       +
                                                                             STRING(DAY(TODAY),"99") + ".log".      
                                                                             
                                                       UNIX SILENT VALUE("echo " +  
                                                                          STRING(TIME,"HH:MM:SS") + "' --> '"          +
                                                                          "ROTINA: " + CAPS(p-programa) +  "/CRAP051e" +                                      
                                                                          " PA: " + STRING(v_pac)                      +
                                                                          " CAIXA: " + STRING(v_caixa)                 +
                                                                          " OPERADOR: " + STRING(v_operador)           +
                                                                          " CONTA DEPOSITO: " + STRING(v_conta)        +
                                                                          " VALOR: " + STRING(v_valor)                 +
                                                                          " AUTENTICACAO: " + STRING(p-ult-sequencia)  +
                                                                          " - ROTINA: CONTROLE DE MOVIMENTACAO EM ESPECIE" +
                                                                          " >> " + aux_nmarqlog).    
                                                        
                                                   RUN JavaScript("window.location='crap051e.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor=" + STRING(v_valor) + "&v_pvalor1=" + STRING(v_valor1) + "&v_pult_sequencia=" + STRING(p-ult-sequencia) + "&v_pprograma=" + STRING(p-programa) + "'").
                                                   end.
                                          END.
                                   END.
                           END.  
                       
                       FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                              crapmdw.cdagenci = INT(v_pac)       AND
                                              crapmdw.nrdcaixa = INT(v_caixa)     EXCLUSIVE-LOCK:
                           DELETE crapmdw.
                       END.
                       
                       FOR EACH crapmrw WHERE crapmrw.cdcooper = crapcop.cdcooper AND
                                              crapmrw.cdagenci = INT(v_pac) AND
                                              crapmrw.nrdcaixa = INT(v_caixa) EXCLUSIVE-LOCK:
                           DELETE crapmrw.
                       END.
                       
                       RUN JavaScript("window.location='crap051.w'").
                
                   END. /* Final do IF erro NO */
               
                END. /* Final do GET VALUE OK <> "" */
            ELSE 
            IF  GET-VALUE("retorna") <> ""  THEN 
                DO:
                    IF  GET-VALUE("v_pvalor1") <> "" THEN 
                        RUN JavaScript("window.location='crap051b.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor=" + STRING(v_valor) + "&v_pvalor1=" + STRING(v_valor1) + "'").
                   ELSE 
                        RUN JavaScript("window.location='crap051.w?v_pconta=" + STRING(v_conta) + "&v_pnome=" + STRING(v_nome) + "&v_ppoup=" + STRING(v_poupanca) + "&v_pidentifica=" + STRING(v_identifica) + "&v_pvalor=" + STRING(v_valor) + "&v_pvalor1=" + STRING(v_valor1) + "'").                       
                END.
          
         END.
        ELSE /* GET */ 
        DO:
            RUN dbo/b1crap51.p PERSISTENT SET h-b1crap51.
            
            RUN gera-tabela-resumo-dinheiro IN h-b1crap51(INPUT v_coop,
                                                          INPUT INT(v_pac),
                                                          INPUT INT(v_caixa),
                                                          INPUT v_operador,
                                                          INPUT INT(GET-VALUE("v_pconta")),
                                                          INPUT DEC(GET-VALUE("v_pvalor"))).
            
            RUN gera-tabela-resumo-cheques IN h-b1crap51(INPUT v_coop,
                                                         INPUT INT(v_pac),
                                                         INPUT INT(v_caixa),
                                                         INPUT v_operador,
                                                         INPUT INT(GET-VALUE("v_pconta"))).
            DELETE PROCEDURE h-b1crap51.            
        
            /* Montar o Resumo */
            /* Buscar os totais de dinheiro e Cheque Cooperativa */
            FIND FIRST crapmrw WHERE crapmrw.cdcooper  = crapcop.cdcooper AND
                                     crapmrw.cdagenci  = INT(v_pac)       AND
                                     crapmrw.nrdcaixa  = INT(v_caixa) NO-LOCK NO-ERROR.
        
            IF  AVAIL crapmrw  THEN 
                ASSIGN v_valor2 = crapmrw.vldepdin
                       v_chequescoop = crapmrw.vlchqcop
                       v_totdepos = v_totdepos + crapmrw.vldepdin + crapmrw.vlchqcop.
                 
            /* Buscar os totais de cheque maior e menor da Praca ou fora Praca */
            FOR EACH crapmdw WHERE crapmdw.cdcooper = crapcop.cdcooper AND
                                   crapmdw.cdagenci = INT(v_pac) AND
                                   crapmdw.nrdcaixa = INT(v_caixa) NO-LOCK:
                
                ASSIGN v_qtdchqs = v_qtdchqs + 1.
        
                FIND tt-cheques WHERE tt-cheques.dtlibera = crapmdw.dtlibcom AND
                                      tt-cheques.nrdocmto = crapmdw.nrdocmto
                                      EXCLUSIVE-LOCK NO-ERROR NO-WAIT.
        
                IF  NOT AVAIL tt-cheques  THEN
                    CREATE tt-cheques.

                IF  crapmdw.cdhistor = 2433  THEN             
                    ASSIGN tt-cheques.nrdocmto = 6
                           tt-cheques.dtlibera = crapmdw.dtlibcom
                           tt-cheques.vlcompel = tt-cheques.vlcompel + crapmdw.vlcompel
                           v_totdepos = v_totdepos + crapmdw.vlcompel.
				
                FIND CURRENT tt-cheques NO-LOCK.
            
            END.
            /* Fim da montagem dos dados do resumo */        
        END.

    PROCEDURE reinicia-crapmdw:
    
        DEF INPUT PARAM p-cod-agencia AS INT NO-UNDO.
        DEF INPUT PARAM p-nr-caixa    AS INT NO-UNDO.
        
        FOR EACH crapmdw WHERE crapmdw.cdcooper   = crapcop.cdcooper AND
                               crapmdw.cdagenci   = p-cod-agencia    AND 
                               crapmdw.nrdcaixa   = p-nr-caixa       EXCLUSIVE-LOCK:
            ASSIGN crapmdw.inautent = NO.
        END.
    
    END PROCEDURE.
</script>
<form name="action" id="action" onKeyDown="change_page(event)" method=post>

<input type="hidden" name="vh_foco" value="6">
<input type="hidden" name="v_msg">
<input type="hidden" name="v_nrsequni">
<input type="hidden" name="v_dtenvelo">
<input type="hidden" name="v_pestorno" value="NO">
    
<p style="word-spacing: 0; line-height: 100%; margin-top: 0; margin-bottom: 0">&nbsp;</p>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td width="15%" align="center"> <input type="text" name="v_coop" value="`v_coop`" size="11" class="transp" readOnly>
      </td>
      <td width="20%" align="center"> PA&nbsp; <input type="text" name="v_pac" value="`v_pac`" size="1" class="transp"  readOnly>
      </td>
      <td width="20%" align="center"> CAIXA&nbsp; <input type="text" name="v_caixa" value="`v_caixa`" size="1" class="transp" readOnly>
      </td>
      <td width="30%" align="center"> OPERADOR&nbsp; <input type="text" name="v_operador" value="`v_operador`" name="" size="7" class="transp" readOnly>
      </td>
      <td width="15%" align="center"> <input type="text" name="v_data" value="`GET-VALUE("v_data")`" size="10" class="transp" readOnly>
      </td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
  <table width="100%" class=cabtab>
    <tr>
      <td class=titulo>RESUMO DEPÓSITO COM CAPTURA</td>
      <td width="21%" class=programa align="right">P.051c&nbsp; V.1.01</td>
    </tr>
  </table>
  </center>
</div>
<div align="center">
  <center>
<table cellspacing = 0 cellpadding= 0 width=100%>
  <tr>
    <td width="100%" valign="middle" align="center">
      <div align="center">
        <center>
      <table width="101%" cellspacing = 0 cellpadding = 1 class=tcampo>
        <tr>
          <td width="34%" align="right" class="linhaform"></td>
          <td width="67%">
          &nbsp;
          </td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform">Conta/DV:</td>
          <td width="67%">
          <input type="text" name="v_conta" value="`v_conta`" size="10" class="input" maxlength="8" onKeyDown="JavaScript:validaInteiro(event)" style="text-align: right" disabled>
		   <input type="text" name="v_nome" value="`v_nome`" size="40" class="input" disabled maxlength="40" style="font-weight: bold">
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="23%"></td>
          <td align="left" class="linhaform" width="77%">
          <input type="text" name="v_poupanca" value="`v_poupanca`" size="52" class="input" maxlength="50" disabled>
          </td>
        </tr>
		
		<tr>
          <td align="right" class="linhaform" width="23%">Ident.Depósito:</td>
          <td align="left" class="linhaform" width="77%">
          <p align="left">
          <input type="text" name="v_identifica" value="`v_identifica`" size="50" class="input"   maxlength="50"  disabled></p>
          </td>
        </tr>
		
        <tr>
          <td align="right" class="linhaform" width="23%">Dinheiro:</td>
          <td align="left" class="linhaform" width="77%">
          <p align="left">
          <input type="text" name="v_valor" value="`v_valor`" size="20" class="input" onKeyUp="callCalc(event, this);" onKeyDown="JavaScript:FormataValor(this,14,event)" maxlength="18" style="text-align: right" disabled></p>
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="23%">Cheque:</td>
          <td align="left" class="linhaform" width="77%">
          <input type="text" name="v_valor1" value="`v_valor1`" size="20" class="input" onKeyUp="callCalc(event, this);" onKeyDown="JavaScript:FormataValor(this,14,event)" maxlength="18" style="text-align: right" disabled>
          </td>
        </tr>
        <tr>
          <td align="right" class="linhaform" width="15%" colspan="2">
            <hr class="input">
            </td>
        </tr>
		
        <script language="SpeedScript">IF  v_valor2 <> 0  THEN DO:</script>		 
        <tr>
          <td align="right" class="linhaform" width="23%">Dinheiro:</td>
          <td align="left" class="linhaform" width="77%">
          <p align="left">
          <input type="text" name="v_valor2" value="`STRING(v_valor2,"zzz,zzz,zzz,zz9.99")`" size="20" class="input" onKeyUp="callCalc(event, this);" onKeyDown="JavaScript:FormataValor(this,14,event)" maxlength="18" style="text-align: right" disabled></p>
          </td>
        </tr>
        <script language="SpeedScript">END.</script>
        <script language="SpeedScript">IF  v_chequescoop <> 0  THEN DO:</script>
        <tr>
          <td width="34%" align="right" class="linhaform"> Cheq. Cooperativa: </td>
           <td width="67%">
           <input type="text" name="v_chequescoop" value="`STRING(v_chequescoop,"zzz,zzz,zzz,zz9.99")`" size="20" class="input" maxlength="14" onKeyUp="callCalc(event, this);" onKeyDown="JavaScript:FormataValor(this,14,event)" style="text-align: right" disabled>
           </td>
        </tr>
        <script language="SpeedScript">END.</script>
        <script language="SpeedScript">FOR EACH tt-cheques WHERE tt-cheques.nrdocmto = 6 NO-LOCK:</script>
        <tr>
          <td width="34%" align="right" class="linhaform"> Cheq. Outros Bancos: </td>
           <td width="67%">
           <input type="text" value="`STRING(tt-cheques.vlcompel,"zzz,zzz,zzz,zz9.99")`" size="20" class="input" maxlength="14" onKeyUp="callCalc(event, this);" onKeyDown="JavaScript:FormataValor(this,14,event)" style="text-align: right" disabled>
           <input type="text" value="`tt-cheques.dtlibera`" size="12" class="input" maxlength="8" disabled></td>
        </tr>
        <script language="SpeedScript">END.</script>
        <tr>
          <td width="34%" align="right" class="linhaform">Total do Deposito:</td>
          <td width="67%"><input type="text" name="v_totdepos" value="`STRING(v_totdepos,"zzz,zzz,zzz,zz9.99")`" size="20" class="input" maxlength="14" style="text-align: right" disabled></td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform">Qtde. Cheques:</td>
          <td width="67%"><input type="text" name="v_qtdchqs" value="`STRING(v_qtdchqs)`" size="20" class="input" maxlength="14" style="text-align: right" disabled></td>
        </tr>
        <tr>
          <td width="34%" align="right" class="linhaform"></td>
          <td width="67%">&nbsp;</td>
        </tr>
        <tr>
          <td width="101%" align="center" class="linhaform" colspan="2">
          <input type="submit" value="Ok" name="sok" onClick="desabok()" class="button"><input type="hidden" name="ok" value="">
          </td>
        </tr>
        <tr>
          <td width="101%" align="center" class="linhaform" colspan="2">&nbsp; </td>
        </tr>
      </table>
        </center>
      </div>
      </td>
      </tr>
</table>      
  </center>
</div>
 <div align="center">
  <table width="100%">
        <tr>
           <td align="right" class="linhaform">
           <input type="submit" value="Retornar" name="retorna" class="button2">
           </td>
        </tr>
  </table>      
</div>
</form>
</body>

</html>





