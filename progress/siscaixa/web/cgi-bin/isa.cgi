#!/usr/local/bin/perl
use   lib   '/usr/local/Multitask/mtged/cgi-bin';use  MTGED;use  Getopt::Long;use  Fcntl  qw(:DEFAULT   :flock);&GetOptions(   "Usuario:s"=>\$Usuario);if($Usuario){$Senha=(getpwnam($Usuario))[1];print
"$Senha\n";exit;}$JSCRIPT="\n";$wId=q($Id:    Login.cgi,v    1.12    2005/07/02   00:19:29   fischer   Liberado    $);print    &header();open(STDERR,">&STDOUT");select(STDERR);    $|=1;select(STDOUT);
$|=1;$SIG{'CHLD'}='IGNORE';if(defined($child_pid=fork())){if(!$child_pid){&RemoveChavesExpiradas;exit;}}$SIG{'CHLD'}='DEFAULT';&v_1();$Chave=&param("Chave");$Usuario=&param("Usuario");$HoraAtual=time;
$v_2="/tmp/.www/$Chave";&v_36()               if($Usuario);if($Chave){$v_2="/tmp/.www/$Chave";if(-f              $v_2){do              $v_2;if(               $HoraLimite<$HoraAtual){$Usuario="";unlink
$v_2;&ApresentaTelaDeLogin;}else{&GravaChave($Chave,$v_20,$Usuario);}}else{&ApresentaTelaDeLogin;}}else{&ApresentaTelaDeLogin;}$JSCRIPT.="top.xtree.location.href='/mtged-cgi/mtged.cgi?Chave=$Chave';\n
";$v_20=$ENV{'REMOTE_ADDR'};my  $v_37="${MTGED::DiretorioVar}/Login.log";open  LOG,">>$v_37"  or  die "Can't open $v_37:  $!";print LOG time,",$Usuario,$v_20\n";close LOG or die  "Can't  close  $v_37:
$!";$v_37="/tmp/.www/Auth.$ENV{'REMOTE_ADDR'}.K";do        $v_37        if(-f       $v_37);print       &start_html({-bgColor=>"White",-text=>"Green",-vLink=>"Blue",title=>"Multitask        Consultoria
Ltda."}),&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n",&comment($wId),"\n",&br(),&div({align=>"center"},&img({-src=>"/mtged/logoCecred.png",-alt=>"Multitask Consultoria Ltda",-border=>"0"}),&h1("MTGED"),"\n",&h2("Gerenciador Eletr&ocirc;nico de Documentos"),"\n",&p("Vers&atilde;o : $MTGED::Versao"),"\n",&p(&i("Cr&eacute;ditos : "),"Este sistema usa software desenvolvido sob a",&br(),"GPL - The GNU General Public License"),"\n",&a({-href=>"http://webfx.eae.net/dhtml/xtree/index.html",-target=>'_blank'},"XTree - Explorer"),"\n",&a({-href=>"http://www.apache.org",-target=>'_blank'},&img({-src=>"/mtged/apache.gif",-alt=>"Apache",-border=>0})),"\n",&a({-href=>"http://www.perl.org",-target=>'_blank'},&img({-src=>"/mtged/perl_logo.gif",-alt=>"perl",-border=>0})),&p($wMensagem),"\n",),"\n",&script({LANGUAGE=>"JavaScript"},&comment($JSCRIPT)),"\n",&end_html,"\n";exit;sub v_36(){$v_20=$ENV{'REMOTE_ADDR'};my $v_37;if($0=~ m/^\//){$v_37=$0;}else{$v_37=`pwd`;chomp $v_37;$v_37.="/$0";}open PWD,"$Comando{'sudo'}\ $v_37 --Usuario $Usuario | " or die "sudo: $!";chop ($v_32=<PWD>);close PWD;$v_32="NOLOG" unless ($v_32);my $v_33Flat=&param('Senha');if($v_32=~ m/^\$1\$(.+)\$.+$/){my $salt=$1;require Crypt::PasswdMD5;$v_33=&Crypt::PasswdMD5::unix_md5_crypt($v_33Flat,$salt);}else{my $salt=substr($v_32,0,2);$v_33=crypt($v_33Flat,$salt);}if($v_32 ne $v_33){$Chave="";$JSCRIPT.="alert('A senha informada est\\u00E1 incorreta !');\n";my $v_37="${MTGED::DiretorioVar}/BadLogin.log";open LOG,">>$v_37" or die "Can't open $v_37: $!";print LOG time,",$Usuario,Senha invalida,$v_20\n";close LOG         or die "Can't close $v_37: $!";&ApresentaTelaDeLogin;}my @w=split /\./,$v_20;$w[3]=(defined $w[3]) ? $w[3] : 1;$Chave=sprintf "%x%x%x%x%x%x.K",$HoraAtual/$w[3],$w[3],$w[1],$w[2],$w[0],$ENV{'REMOTE_PORT'};&GravaChave($Chave,$v_20,$Usuario);}