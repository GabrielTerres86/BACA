#!/usr/local/bin/perl
use lib '/usr/local/Multitask/mtged/cgi-bin';use MTGED;use File::Copy;print &header() if($CGI::VERSION);$JSCRIPT="\n";$wId=q($Id: mtged.cgi,v 1.26 2005/07/19 02:44:02 fischer Liberado $);$Opcao=&param('Opcao');&VerificaTransferencia();$GeraPDF=&param('GeraPDF');$Ordem=&param('Ordem');$Paginas=&param('Paginas');$Descending=&param('Descending');$Historico=&param('Historico');$CamposHidden='';$v_37="/tmp/.www/Auth.$ENV{'REMOTE_ADDR'}.K";exit unless (-x $v_37);if($Opcao){if($Opcao eq '/pesquisa'){&ProcessaPesquisa();}else{&ApresentaDocumentos();}}print &start_html(-title=>"Multitask Consultoria Ltda.",-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"stylesheet",-type=>"text/css",-href=>'/mtged/xtree.css'}),),"\n",&meta({'-HTTP-EQUIV'=>'Pragma',-CONTENT=>'no-cache'}),"\n";$JSCRIPT.="<!--\n";$JSCRIPT.="  window.status='$v_15';\n";$JSCRIPT.="  function AbrePasta(n1){\n";$JSCRIPT.="    document.xtree.Opcao.value=n1;\n";$JSCRIPT.="    document.xtree.submit();\n";$JSCRIPT.="}\n";$JSCRIPT.="  function ConverteParaUsuario(token){\n";$JSCRIPT.="    document.xtree.Opcao.value='';\n";$JSCRIPT.="    document.xtree.Token.value=token;\n";$JSCRIPT.="    document.xtree.target='xtree';\n";$JSCRIPT.="    document.xtree.submit();\n";$JSCRIPT.="}\n";$JSCRIPT.="  if(document.getElementById){\n";$JSCRIPT.="    var tree000000000000=new WebFXTree('$MTGED::Cliente');\n";$JSCRIPT.="    tree000000000000.setBehavior('classic');\n";$JSCRIPT.="    tree000000000000.add(new WebFXTreeItem('Pesquisa',\"javascript:AbrePasta('/pesquisa');\"));\n";$v_37="$MTGED::DiretorioConf/${Usuario}.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{$v_37="$MTGED::DiretorioConf/default.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{print &h1("Erro na autoriza&ccedil;&atilde;o de usu&aacute;rio."),&b("Arquivo $v_37 n&atilde;o encontrado."),&end_html();exit;}}@Controle=(0,0,0,0,0);while(<CTRL>){chomp;&GeraJavaScript($_);}close CTRL;$JSCRIPT.="    document.write(tree000000000000);\n";$JSCRIPT.="}\n";$JSCRIPT.="// -->\n";print &start_multipart_form({-name=>'xtree',-target=>'relatorios',-action=>''}),"\n",&input({-type=>"hidden",-name=>"Opcao",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Chave",-value=>$Chave}),"\n",&input({-type=>"hidden",-name=>"wTarget",-value=>'xtree'}),"\n",$CamposHidden,&end_form(),"\n",&script({-src=>"/mtged/xtree.js"},""),"\n",&script({-language=>"JavaScript"},$JSCRIPT),"\n",&end_html;exit;sub GeraJavaScript($){my $Diretorio=shift;my $v_37='';if($Usuario eq 'root'){if($Diretorio=~ m/^c.\d{6}/){$v_37='Usuarios/';}elsif($Diretorio=~ m/^c\d{4}/){$v_37='Computadores/';}}@Nivel=split('/',"$v_37$Diretorio",5);if($#NivelAnterior>$#Nivel){foreach my $n ($#Nivel..$#NivelAnterior){$NivelAnterior[$n]='';}}my $v_39=$#Nivel;if($#Nivel>3){$v_39=3;$JSCRIPT.="alert('Erro na pasta $Diretorio. Muitos niveis.')\n";}for $n (0..$v_39){if($NivelAnterior[$n] ne $Nivel[$n]){$Controle[$n]++;for $m (($n+1)..3){$Controle[$m]=0;}$FolderPaiAnterior=$FolderPai="tree";for $m (0..3){$FolderPai.=sprintf("%03d",$Controle[$m]);$FolderPaiAnterior.=($n>$m) ? sprintf("%03d",$Controle[$m]) : "000";}my $v_37=qq(javascript:AbrePasta('$Diretorio'););my $v_39='';if($Usuario eq 'root'){if($n==0){}}$JSCRIPT.="    var $FolderPai=new WebFXTreeItem('$v_39$Nivel[$n]',\"$v_37\");\n";$JSCRIPT.="    ${FolderPaiAnterior}.add($FolderPai);\n";$NivelAnterior[$n]=$Nivel[$n];}}}sub ApresentaDocumentos(){my ($v_37,$v_39,$v_41,$v_42);chdir $MTGED::DiretorioBase or die "chdir $MTGED::DiretorioBase: $!";&AbreArquivo if(-f $Opcao);print &start_html(-title=>"Multitask Consultoria Ltda.",-onLoad=>"self.focus();",-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone}),),"\n",&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n";$Action=&param('Action');if($Action eq 'Upload'){my ($buffer,$v_37,$v_39,$wDestino);$v_37=$wUpload=&param('wUpload');$wDestino=&param('wDestino');open (OUTFILE,">/var/tmp/$wUpload") or die "open /var/tmp/$wUpload: $!";while (read($wUpload,$buffer,1024)){print OUTFILE $buffer;}close OUTFILE;close $wUpload;$v_37=~s/^.*[\\\/]//;$v_37=~s/\s/_/g;$v_37=~s/\W/./g;$v_39=($wDestino eq 'User') ? $Usuario : $Opcao;if(-d $Opcao){$v_39.="/$v_37";move "/var/tmp/$wUpload",$v_39 or die "mv /var/tmp/$wUpload $v_39: $!";}else{print &div({-align=>"Center"},&h2("Aten&ccedil;&atilde;o : n&atilde;o existe o diret&oacute;rio '$v_39'."),&h2("Contate o administrador do MTGED")),"\n";}}if($Opcao=~ m,upload/[^/]*$,){$OpcaoUpload=&p({-title=>"Informe o nome do documento e confirme",-onMouseOver=>qq(window.status='Informe o nome do documento e confirme.';return true;),-onMouseOut=>"window.status='$v_15';return true;"},"Arquivo para upload :",&input({-name=>'wUpload',-type=>'file'}))."\n";my $v_37='';if(-d "Usuario/$Usuario"){if(-d $Opcao){$v_37=&p("Pasta para upload :",&input({-type=>'radio',-name=>'wDestino',-value=>'User',-checked=>1},"Pessoal"),&input({-type=>'radio',-name=>'wDestino',-value=>'Upload'},"Upload"),&submit({-onClick=>'ValidaUpload();return PodeProcessar;',-name=>'Action',-value=>'Upload'}));}else{$v_37=&p("Pasta para upload : Usuario/$Usuario",&submit({-onClick=>'ValidaUpload();return PodeProcessar;',-name=>'Action',-value=>'Upload'}));$v_37.=&input({-type=>'hidden',-name=>'wDestino',-value=>'User'});}}else{if(-d $Opcao){$v_37=&p("Pasta para upload : $Opcao",&submit({-onClick=>'ValidaUpload();return PodeProcessar;',-name=>'Action',-value=>'Upload'}));$v_37.=&input({-type=>'hidden',-name=>'wDestino',-value=>'Upload'});}else{print &div({-align=>"Center"},&h2("Aten&ccedil;&atilde;o : n&atilde;o existe o diret&oacute;rio '$v_39'."),&h2("Contate o administrador do MTGED")),"\n";}}$OpcaoUpload.=$v_37 if($v_37);}else{$OpcaoUpload='';}$v_37="$MTGED::DiretorioConf/${Usuario}.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{$v_37="$MTGED::DiretorioConf/default.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{print &h1("Erro na autoriza&ccedil;&atilde;o de usu&aacute;rio."),&b("Arquivo $v_37 n&atilde;o encontrado."),&end_html();exit;}}my %ListaAutorizada=();while(<CTRL>){chomp;$ListaAutorizada{$_}=1;}close CTRL;if(! $ListaAutorizada{$Opcao}){$JSCRIPT.="alert('A validade da senha expirou !');\n";$JSCRIPT.="top.xtree.location.href='/mtged/Branco.html';\n";&ApresentaTelaDeLogin();}if(-d $Opcao){opendir DIR,$Opcao or die "open $Opcao: $!";@contents=grep !/^(\.\.?|Excluidos)$/,readdir DIR;closedir DIR;}else{@contents=();}$JSCRIPT.="<!--\n";$JSCRIPT.="  function ChamaURL(Documento,GeraPDF){\n";$JSCRIPT.="    document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="    document.Documentos.GeraPDF.value=GeraPDF;\n";$JSCRIPT.="    document.Documentos.target='_blank';\n";$JSCRIPT.="    document.Documentos.submit();\n";$JSCRIPT.="    document.Documentos.Opcao.value='$Opcao';\n";$JSCRIPT.="    document.Documentos.GeraPDF.value='';\n";$JSCRIPT.="    document.Documentos.target='relatorios';\n";$JSCRIPT.="}\n";$JSCRIPT.="  function ChamaPasta(Documento){\n";$JSCRIPT.="    document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="    document.Documentos.submit();\n";$JSCRIPT.="    document.Documentos.Opcao.value='$Opcao';\n";$JSCRIPT.="}\n";$JSCRIPT.="  function SelecionaPaginas(Documento,GeraPDF){\n";$JSCRIPT.="    Paginas=prompt(\"Informe as p\\u00E1ginas desejadas : \",\"\");\n";$JSCRIPT.="    if(Paginas==null){return}\n";$JSCRIPT.="    if(Paginas.length>0){\n";$JSCRIPT.="      document.Documentos.Paginas.value=Paginas;\n";$JSCRIPT.="      ChamaURL(Documento,GeraPDF);\n";$JSCRIPT.="      document.Documentos.Paginas.value='';\n";$JSCRIPT.="}\n";$JSCRIPT.="}\n";$JSCRIPT.="  function CopiaParaHistorico(Documento,Pasta){\n";$JSCRIPT.="    if(confirm(\"Copiar documento \"+Documento+\" para pasta \"+Pasta+\"?\")){\n";$JSCRIPT.="      var w=window.open(\"\",\"TelaCopia\",\"resizable,width=840,height=150\");\n";$JSCRIPT.="      document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="      document.Documentos.target='TelaCopia';\n";$JSCRIPT.="      document.Documentos.Historico.value='1';\n";$JSCRIPT.="      document.Documentos.submit();\n";$JSCRIPT.="      document.Documentos.Historico.value='';\n";$JSCRIPT.="}\n";$JSCRIPT.="}\n";$JSCRIPT.="  function RemoveDocumento(Documento){\n";$JSCRIPT.="    if(confirm(\"Remover documento \"+Documento+\"?\")){\n";$JSCRIPT.="/*\n";$JSCRIPT.="      var w=window.open(\"\",\"TelaRemove\",\"resizable,width=840,height=150\");\n";$JSCRIPT.="*/\n";$JSCRIPT.="      document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="      document.Documentos.target='TelaRemove';\n";$JSCRIPT.="      document.Documentos.Historico.value='Remover';\n";$JSCRIPT.="      document.Documentos.submit();\n";$JSCRIPT.="      document.Documentos.Historico.value='';\n";$JSCRIPT.="      document.Documentos.Opcao.value='$Opcao';\n";$JSCRIPT.="      document.Documentos.target='relatorios';\n";$JSCRIPT.="}\n";$JSCRIPT.="}\n";$JSCRIPT.="  function DefineOrdem(Documento,Ordem,Sentido){\n";$JSCRIPT.="    document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="    document.Documentos.Ordem.value=Ordem;\n";$JSCRIPT.="    document.Documentos.Descending.value=Sentido;\n";$JSCRIPT.="    document.Documentos.target='relatorios';\n";$JSCRIPT.="    document.Documentos.submit();\n";$JSCRIPT.="}\n";my (%Chave,$Info,$nDoc);$ColSpanAcoes='';$nDoc=0;foreach $Arquivo (@contents){my ($v_37,$v_39,$v_41);if($Arquivo=~m/^(.*)\.pdf/i){next if(-f "$Opcao/$1");}$v_37="$Opcao/$Arquivo";if(-f $v_37){$nDoc++;($size,$mtime)=(stat $v_37)[7,9];my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($mtime))[1..5];$v_0+=1900; $v_29++;$Info{$Arquivo}=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);$Size{$Arquivo}=$size;if($Ordem){$Chave{$Arquivo}=($Ordem==1) ? $size : $mtime;}else{$Chave{$Arquivo}=$Arquivo;}}}$MTGED::Cliente.=" [$nDoc documentos]" if($nDoc>0);if($Ordem){if($Descending){$RotinaSort=sub{$Chave{$b}<=>$Chave{$a}};}else{$RotinaSort=sub{$Chave{$a}<=>$Chave{$b}};}}else{if($Descending){$RotinaSort=sub{$b cmp $a};}else{$RotinaSort=sub{$a cmp $b};}}$v_37=$Opcao;if($v_37=~s/\/[^\/]+$//){$Arquivo="/$v_37";}else{$v_37='.';$Arquivo="/";}my $Tabela='';if($Opcao ne '.'){my ($size,$mtime)=(stat $v_37)[7,9];my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($mtime))[1..5];$v_0+=1900; $v_29++;my $Info=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);my $v_39="Abre pasta $Arquivo";$Tabela=&Tr(&td(&a({-href=>"#",-onClick=>"ChamaPasta('$v_37'); this.focus(); return false;",-title=>$v_39,-onMouseOver=>"window.status='$v_39';return true;",-onMouseOut=>"window.status='$v_15';return true;"},&img({-src=>"/mtged/images/foldericon.png",-alt=>$v_39,-border=>0}),)),&td(&a({-href=>"#",-onClick=>"ChamaPasta('$v_37'); this.focus(); return false;",-title=>$v_39,-onMouseOver=>"window.status='$v_39';return true;",-onMouseOut=>"window.status='$v_15';return true;"},'..')),&td({-align=>"Right"},"&nbsp;$size&nbsp;"),&td($Info),&td("&nbsp;"));$Tabela.="\n";}foreach $Arquivo (sort @contents){my $v_37;if($Opcao eq '.'){$v_37=$Arquivo;}else{$v_37="$Opcao/$Arquivo";}next unless ($ListaAutorizada{$v_37});if(-d $v_37){my ($size,$mtime)=(stat $v_37)[7,9];my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($mtime))[1..5];$v_0+=1900; $v_29++;my $Info=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);my $v_39="Abre pasta /$v_37";$Tabela.=&Tr(&td(&a({-href=>"#",-onClick=>"ChamaPasta('$v_37',0); this.focus(); return false;",-title=>$v_39,-onMouseOver=>"window.status='$v_39';return true;",-onMouseOut=>"window.status='$v_15';return true;"},&img({-src=>"/mtged/images/foldericon.png",-alt=>$v_39,-border=>0}),)),&td(&a({-href=>"#",-onClick=>"ChamaPasta('$v_37',0); this.focus(); return false;",-title=>$v_39,-onMouseOver=>"window.status='$v_39';return true;",-onMouseOut=>"window.status='$v_15';return true;"},$Arquivo)),&td({-align=>"Right"},"&nbsp;$size&nbsp;"),&td($Info),&td("&nbsp;"));$Tabela.="\n";}}foreach $Arquivo (sort $RotinaSort keys %Chave){my ($v_37,$v_39,$v_41,$v_42);my $TemRemover=0;my $TemHistorico=0;$v_37="$Opcao/$Arquivo";if(! -r $v_37){print &comment("Arquivo $Arquivo sem permissao de leitura"),"\n";next;}&MontaTabelaSufixo();$Arquivo=~ m/(\.\w+)$/;$w5=lc($1);if($mtgedSufixo{$w5}){$v_39=&br();}else{if(-x $Comando{"mtpdf"}){$v_39=&img({src=>"/mtged/pdf.gif",alt=>"Ver em PDF",-border=>0});}}if($w5 eq '.pdf'){$wSelecaoDePaginas=1;}elsif($mtgedSufixo{$w5}){$wSelecaoDePaginas=0;}else{$wSelecaoDePaginas=1;}if($wSelecaoDePaginas){my $wGeraPDF=($Arquivo=~ m/\.pdf$/i) ? 0 : 1;$v_41=&td({-align=>"Center"},&a({-href=>"#",-onClick=>"SelecionaPaginas('$v_37',$wGeraPDF); this.focus(); return false;",-title=>"Seleciona de paginas do documento $Arquivo",-onMouseOver=>qq(window.status='Cria arquivo PDF com as p\\u00E1ginas selecionadas. Ex.: \\u00221,4 5 10-15\\u0022 selecionar\\u00E1 as p\\u00E1ginas \\u00221\\u0022,\\u00224\\u0022,\\u00225\\u0022 e as p\\u00E1ginas \\u002210\\u0022 at\\u00E9 \\u002215\\u0022.';return true;),-onMouseOut=>"window.status='$v_15';return true;"},&img({-src=>"/mtged/Selecao.png",-border=>0,-alt=>"Sele&ccedil;&atilde;o"})));}else{$v_41=&td(&br());}$v_42=$Arquivo;$v_42=~s/^(.{35}).*$/$1.../;if($Opcao eq "$Usuario/Historico"){$TemRemover=1;}else{if($Usuario=~ m/root|operacao/i){$TemRemover=1;if($Opcao !~ m/Historico$/){$TemHistorico=1;}}else{$TemHistorico=1;}}$TemRemover=0   if($Opcao=~ m/Excluidos$/);$TemRemover=1   if($Opcao=~ m/^upload/);$TemHistorico=0 if($Opcao=~ m/^HIST/);if($TemHistorico){my $wPasta;my $PastaUsuario=1;$PastaUsuario=0 if($Usuario=~ m/root|operacao/i);$PastaUsuario=0 if($Opcao=~ m/^upload/);if($PastaUsuario){$wPasta="$Usuario/Historico";}else{my @w=split(/\//,$Opcao);my $v_39='';foreach $v_37 (@w){last if($v_37=~ m/Anteriores|Excluidos|Historico/);$wPasta.=$v_39;$wPasta.=$v_37;$v_39='/';}$wPasta.="/Historico";}$v_41.=&td({-align=>"Center"},&a({-href=>"#",-onClick=>"CopiaParaHistorico('$v_37','$wPasta'); this.focus(); return false;",-title=>"Copiar para historico o documento $Arquivo",-onMouseOver=>qq(window.status='Copia $Arquivo para hist\\u00F3rico.';return true;),-onMouseOut=>"window.status='$v_15';return true;"},&img({src=>"/mtged/Historico.png",alt=>"Historico",-border=>0})));}if($TemRemover){$v_41.=&td({-align=>"Center"},&a({-href=>"#",-onClick=>"RemoveDocumento('$v_37');",-title=>"Remover o documento $Arquivo",-onMouseOver=>qq(window.status='Remove $Arquivo';return true;),-onMouseOut=>"window.status='$v_15';return true;"},&img({-src=>"/mtged/Remover.png",-border=>0,-alt=>"Remover"})));}$Tabela.=&Tr(&td(&a({-href=>"#",-onClick=>"ChamaURL('$v_37',1); this.focus(); return false;",-title=>"$Arquivo em formato PDF",-onMouseOver=>"window.status='Abre arquivo $Arquivo em formato PDF';return true;",-onMouseOut=>"window.status='$v_15';return true;"},$v_39)),&td(&a({-href=>"#",-title=>$Arquivo,-onClick=>"ChamaURL('$v_37',0); this.focus(); return false;",-onMouseOver=>"window.status='Abre arquivo $Arquivo';return true;",-onMouseOut=>"window.status='$v_15';return true;"},$v_42)),&td({-align=>"Right"},"&nbsp;$Size{$Arquivo}&nbsp;"),&td($Info{$Arquivo}),$v_41);$Tabela.="\n";$ColSpanAcoes=1+$TemHistorico+$TemRemover unless ($ColSpanAcoes);}my $w5=($Opcao eq '.') ? "/" : "/$Opcao";print &start_multipart_form({-method=>'post',-name=>'Documentos',-action=>"/mtged-cgi/mtged.cgi"}),"\n",&input({-type=>"hidden",-name=>"Chave",-value=>$Chave}),"\n",&input({-type=>"hidden",-name=>"wTarget",-value=>'relatorios'}),"\n",&input({-type=>"hidden",-name=>"GeraPDF",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Opcao",-value=>$Opcao}),"\n",&input({-type=>"hidden",-name=>"Ordem",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Paginas",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Historico",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Descending",-value=>''}),"\n",&h1({-align=>"Center"},$w5),$OpcaoUpload;if($Tabela){my ($v_37,$v_39,$v_41,$v_42,$w5);$w5=($Descending) ? 0 : 1;$v_42=($Ordem==0) ? $w5 : 0;$v_37=&a({-href=>"#",-onClick=>"DefineOrdem('$Opcao',0,$v_42);",-title=>'Ordena pelo nome do documento',-onMouseOver=>"window.status='Ordena pelo nome do documento';return true;",-onMouseOut=>"window.status='$v_15';return true;"},"Nome do documento");$v_42=($Ordem==1) ? $w5 : 0;$v_39=&a({-href=>"#",-onClick=>"DefineOrdem('$Opcao',1,$v_42);",-title=>'Ordena pelo tamanho do documento',-onMouseOver=>"window.status='Ordena pelo tamanho do documento';return true;",-onMouseOut=>"window.status='$v_15';return true;"},"Tamanho");$v_42=($Ordem==2) ? $w5 : 0;$v_41=&a({-href=>"#",-onClick=>"DefineOrdem('$Opcao',2,$v_42);",-title=>'Ordena pela data do documento',-onMouseOver=>"window.status='Ordena pela data do documento';return true;",-onMouseOut=>"window.status='$v_15';return true;"},"Data de Cria&ccedil;&atilde;o");print &pre(&table({-border=>0,-align=>'Center'},&Tr(&th({-colspan=>2},$v_37),&th($v_39),&th($v_41),"\n",&th({-colspan=>$ColSpanAcoes},&a({-href=>"#"},"A&ccedil;&otilde;es"))),"\n",$Tabela,)),"\n";}$JSCRIPT.="  window.status='$v_15';\n";$JSCRIPT.="// -->\n";print &end_form(),"\n",&script({LANGUAGE=>"JavaScript"},$JSCRIPT),"\n",&end_html,"\n";exit;}sub AbreArquivo(){my ($Documento,$wDir,$Link);my ($v_37,$v_39);$Documento=$Opcao;$Documento=~s,^.*/,,;$Link="/mtged/temp/$Usuario/$Documento";$wDir="$MTGED::htmlDir/temp/$Usuario";$baseOpcao="$MTGED::DiretorioBase/$Opcao";mkdir $wDir unless (-d $wDir);unlink "$wDir/$Documento" if(-e "$wDir/$Documento");my ($mon,$year)=(localtime(time))[4..5];$year+=1900; $mon++;$v_37=sprintf("$MTGED::DiretorioVar/mtged.%04d%02d.log",$year,$mon);$v_39=($GeraPDF) ? "PDF" : "";open LOG,">>$v_37" or die "Can't open $v_37: $!";print LOG time,",$Usuario,$Opcao,$v_39\n";close LOG         or die "Can't close $v_37: $!";if($Historico){my ($v_37,$v_39,$v_41);my $PastaUsuario=1;$PastaUsuario=0 if($Usuario=~ m/root|operacao/i);$PastaUsuario=0 if($Opcao=~ m/^upload/);if($PastaUsuario){$v_41="$Usuario/Historico";}else{my @w=split(/\//,$Opcao);$v_39='';pop @w;foreach $v_37 (@w){last if($v_37=~ m/Anteriores|Excluidos|Historico/);$v_41.=$v_39;$v_41.=$v_37;$v_39='/';}$v_41.="/Historico";}$v_37="$MTGED::DiretorioBase/$v_41/$Documento";if($Historico eq 'Remover'){if(-f "$baseOpcao"){my ($v_30,$hour,$mday,$mon,$year)=(localtime(time))[1..5];$year+=1900; $mon++;$v_37="$MTGED::DiretorioBase/Excluidos/$Documento";$v_37.=sprintf(".%04d%02d%02d.%02d%02d",$year,$mon,$mday,$hour,$v_30);system "$Comando{'gzip'}\ $baseOpcao";move "${baseOpcao}.gz","${v_37}.gz" or warn "mv $baseOpcao $v_37: $!";my $v_39=time;utime($v_39,$v_39,${v_37}.gz);}$v_39="Documento '$Documento'<br>removido da pasta<br>$Opcao";print &script({LANGUAGE=>"JavaScript"},"<!--\nwindow.opener.document.Documentos.submit();\n// -->"),"\n";}else{unlink $v_37 if(-f $v_37);copy "$baseOpcao",$v_37 or warn "cp $baseOpcao $v_37: $!";$v_39="Documento '$Documento'<br>copiado para a pasta<br>$v_41";}print &br(),&div({-align=>"Center"},&b($v_39),&p(&a({-href=>"#",-onClick=>"javascript:self.close();",-title=>"Fechar a Janela",-onMouseOver=>qq(window.status='Fechar a janela';return true;),-onMouseOut=>"window.status='$v_15';return true;"},"Fechar a janela"))),&end_html;exit;}my $wDocumentoLinkado=0;if($GeraPDF){$Link.=".pdf";$Documento.=".pdf";if(-f "${baseOpcao}.pdf" && ! $Paginas){copy "${baseOpcao}.pdf","$wDir/$Documento";}else{my ($v_37,$v_39);$Paginas=~s/^\-/1-/;$v_37=qq(--paginas "$Paginas" --saida $wDir/$Documento $baseOpcao);$v_39='';open MTPDF,qq($Comando{'mtpdf.pl'}\ $v_37 2>&1 |);while(<MTPDF>){$v_39.=$_;}close MTPDF;if($v_39){chomp $v_39;print "<HTML><HEAD><TITLE>MTPDF : $v_39</TITLE></HEAD>",&comment("MTPDF : $v_39"),"\n";}}}else{if($Paginas){if($Opcao=~ m/\.pdf$/i){$Paginas=~s/[\s;,]+/,/g;$Paginas=~s/^\-/1-/;$Link=~s/\.pdf$/_${Paginas}.pdf/i;$Documento=~s/\.pdf$/_${Paginas}.pdf/i;&SelecionaPaginasDeDocumento("$baseOpcao","$wDir/$Documento");}else{$wDocumentoLinkado=1;}}else{$wDocumentoLinkado=1;}}if($wDocumentoLinkado){&MontaTabelaSufixo();$Documento=~ m/(\.\w+)$/;my $w5=lc($1);if($mtgedSufixo{$w5}){copy "$baseOpcao","$wDir/$Documento";}else{my $wLinha=&param('wLinha');if($wLinha){$Link.="_lnk.html#L$wLinha";}else{$Link.="_lnk.html";}open ENTRADA,$baseOpcao;open SAIDA,">$wDir/${Documento}_lnk.html";print SAIDA &start_html(-title=>"Documento $Documento",-onLoad=>"self.focus();",-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone})),"\n",&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n",&script({-language=>"JavaScript"},"window.status='Documento $Documento'"),"\n","<font size=$MTGED::FontSize><PRE>";while(<ENTRADA>){my $v_37=$_;if($.==1){$v_37=~s/\f//;}else{$v_37=~s/\f/<hr width=50%>/;}if($.==$wLinha){chomp($v_37);print SAIDA &a({-name=>"L$wLinha"},$v_37);}else{print SAIDA "$v_37";}}print SAIDA "</PRE>",&end_html(),"\n";close ENTRADA;close SAIDA;}}chdir $wDir or die "chdir $wDir: $!";opendir DIR,'.' or die "open $wDir: $!";my @contents=grep !/^\.\.?$/,readdir DIR;closedir DIR;my $HoraLimite=time-1800;foreach my $v_37 (@contents){my $v_39=(lstat($v_37))[9];unlink $v_37 if($v_39<$HoraLimite);}print qq(<FRAMESET>);print qq(<FRAME SRC=$Link>);print qq(</FRAMESET>);exit;}sub SelecionaPaginasDeDocumento($$){my ($Origem,$Destino)=@_;require PDF::API2;PDF::API2->import;my @w=split(/,/,$Paginas);foreach my $v_37 (@w){$v_37.=999999999 if($v_37=~m/-$/);my ($pInicio,$pFim)=split(/-/,$v_37);$pInicio=1 unless ($pInicio);if(defined $pFim){($pInicio,$pFim)=($pFim,$pInicio) if($pInicio>$pFim);}else{$pFim=$pInicio;}if(defined $pRange{$pInicio}[1]){$pFim=$pRange{$pInicio}if($pRange{$pInicio}>$pFim);}$pRange{$pInicio}=$pFim;}foreach my $v_37 (sort{$a<=>$b}keys %pRange){next unless (defined $pRange{$v_37});foreach my $v_39 (sort{$a<=>$b}keys %pRange){next if($v_37>=$v_39);if($v_39<=$pRange{$v_37}){if($pRange{$v_37}<$pRange{$v_39}){$pRange{$v_37}=$pRange{$v_39};}delete $pRange{$v_39};}}}@Paginas=sort{$a<=>$b}keys %pRange;my $pdf=PDF::API2->new;my $inpdf=PDF::API2->open($Origem);$wPagina=shift @Paginas;my $pages=scalar @{$inpdf->{pagestack}};for my $page (1..$pages){if($pRange{$wPagina}<$page){last if($#Paginas==-1);$wPagina=shift @Paginas;}next if($wPagina>$page);$pdf->importpage($inpdf,$page);}$inpdf->end();$pdf->saveas($Destino);}sub ProcessaPesquisa(){my (%Computador,%PG,%Usuario,%Upload,@w,$v_37,$v_39);my ($v_30,$v_23,$v_17,$v_29,$v_0);$JSCRIPT.="<!--\n";$JSCRIPT.="  document.Pesquisa.wArgumento.focus();\n";$JSCRIPT.="  document.Pesquisa.wArgumento.select();\n";$JSCRIPT.="  window.status='$v_15';\n";$JSCRIPT.="  function Valida_Formulario(){\n";$JSCRIPT.="    var n=document.Pesquisa.wArgumento.value.length+document.Pesquisa.wCriterio.value.length\n";$JSCRIPT.="    if(n==0){\n";$JSCRIPT.="      alert(\"Informe o argumento de pesquisa\");\n";$JSCRIPT.="      document.Pesquisa.wArgumento.focus();\n";$JSCRIPT.="      document.Pesquisa.wArgumento.select();\n";$JSCRIPT.="      return false;\n";$JSCRIPT.="}\n";$JSCRIPT.="    return true;\n";$JSCRIPT.="}\n";$v_37=&self_url();$v_37=~s/mtged\.cgi.*/pesquisa.cgi/;print &start_html(-title=>"Multitask Consultoria Ltda.",-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone})),"\n",&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n",&h1({-align=>"Center"},"Pesquisa em documentos"),"\n",&start_multipart_form({-name=>'Pesquisa',-target=>"_blank",-action=>$v_37}),"\n",&p("Informe o argumento de busca : ",&input({-name=>'wArgumento',-type=>'text',-size=>20}),"\n",&input({-type=>"submit",-name=>"Processa",-value=>'Inicia pesquisa',-onClick=>"return Valida_Formulario();"}),"\n",),"\n",&p(&input({-type=>'radio',-name=>'wEOU',-value=>'E'},"E"),&input({-type=>'radio',-name=>'wEOU',-value=>'OU',-checked=>1},"OU"),"\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n",&input({-type=>'checkbox',-name=>'wDetalhar',-value=>'1'},"Detalhar&nbsp;pesquisa"),"\n",),"\n";if($MTGED::TotalDiasPesquisa){my $w9=$MTGED::TotalDiasPesquisa*24-1;print &h1($w9);($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime((int(time/3600)-$w9)*3600))[1..5];$v_0+=1900; $v_29++;$v_37=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);}else{$v_37='01/01/1970 00:00';}($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime((int(time/3600)+1)*3600))[1..5];$v_0+=1900; $v_29++;$v_39=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);print &h3("Informe os crit&eacute;rios para a consulta :"),"\n",&table(&Tr(&td({-align=>"Right"},"Data Inicial : "),&td(&input({-name=>'wDataInicio',-type=>'text',-size=>16,-value=>$v_37}))),"\n",&Tr(&td({-align=>"Right"},"Data Final : "),&td(&input({-name=>'wDataFim',-type=>'text',-size=>16,-value=>$v_39}))),"\n",&Tr(&td({-align=>"Right"},"Nome do arquivo cont&eacute;m : "),&td(&input({-name=>'wCriterio',-type=>'text',-size=>16}))));print &h3("Defina as pastas na grade abaixo para realizar a pesquisa :"),"\n";$v_37="$MTGED::DiretorioConf/${Usuario}.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{$v_37="$MTGED::DiretorioConf/default.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't $v_37: $!";}else{print &h1("Erro na autoriza&ccedil;&atilde;o de usu&aacute;rio."),&b("Arquivo $v_37 n&atilde;o encontrado."),&end_html();exit;}}while(<CTRL>){chomp;if(m/^([^\/]+)\/([^\/]+)/){$Nivel1{$1}=1;$Nivel2{$2}=1;}elsif(m/^([^\/]+)$/){$Nivel1{$1}=1;}}close CTRL;@w=keys %Nivel1;%Usuario=();&ApresentaInformacoes(\@w,5,"wNivel1","N&iacute;vel 1") if($#w>-1);@w=keys %Nivel2;%Upload=();&ApresentaInformacoes(\@w,5,"wNivel2","N&iacute;vel 2") if($#w>-1);$JSCRIPT.="// -->\n";print &input({-type=>"hidden",-name=>"Opcao",-value=>''}),"\n",&input({-type=>"hidden",-name=>"Chave",-value=>$Chave}),"\n",&end_form(),"\n",&script({-language=>"JavaScript"},$JSCRIPT),"\n",&end_html;exit 0;}sub ApresentaInformacoes($$$$){my ($w,$n,$Variavel,$Label)=@_;return if($#{$w}==-1);$JSCRIPT.="  function Valida_$Variavel(Parametro){\n";$JSCRIPT.="    for (i=0; i<document.Pesquisa.$Variavel.length; i++){\n";$JSCRIPT.="      if(Parametro=='T'){\n";$JSCRIPT.="        document.Pesquisa.${Variavel}\[i].checked=true;\n";$JSCRIPT.="}else{\n";$JSCRIPT.="        document.Pesquisa.${Variavel}\[i].checked=false;\n";$JSCRIPT.="}\n";$JSCRIPT.="}\n";$JSCRIPT.="    return false;\n";$JSCRIPT.="}\n";my $v_39='';my $v_41=0;my $Tabela='';print &p(&b("$Label : ")),"\n";foreach my $v_37 (sort @{$w}){$v_39.=&td(&checkbox(-name=>$Variavel,-value=>$v_37,-label=>$v_37,-checked=>1));$v_41++;if($v_41>$n){$Tabela.=&Tr($v_39);$Tabela.="\n";$v_39='';$v_41=0;}}$Tabela.=&Tr($v_39) if($v_39);print &table({-align=>"Center",-border=>5},[ $Tabela ] ),"\n";if($#{$w}>$n){print &p({-align=>"Center"},&input({-type=>"submit",-name=>"v_$Variavel",-value=>'Todos',-onClick=>"return Valida_$Variavel('T');"}),"\n",&input({-type=>"submit",-name=>"v_$Variavel",-value=>'Nenhum',-onClick=>"return Valida_$Variavel('N');"})),"\n";}else{print &br(),"\n";}}sub MontaTabelaSufixo(){%mtgedSufixo=();open TABELA,"/usr/local/Multitask/mtged/etc/TabelaDeSufixos";while(<TABELA>){chomp;$mtgedSufixo{lc(".$_")}=1;}close TABELA;}