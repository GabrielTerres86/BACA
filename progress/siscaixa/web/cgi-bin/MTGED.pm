use CGI qw/:standard/;
open(STDERR,">&STDOUT");select(STDERR); $|=1;select(STDOUT); $|=1;umask(000);mkdir '/tmp/.www' unless (-d '/tmp/.www');$v_18="/usr/local/Multitask/mtged";my $v_37='/usr/local/bin/ComandosMT.pl';do "$v_37" or die "Can't do $v_37: $!";package MTGED;do "Versao.cgi" or die "Can't do Versao.cgi: $!";package main;$v_37="$v_18/etc/Parametros.mtged";package MTGED;do $v_37 or die "Can't do $v_37: $!";package main;$v_37=($MTGED::Cliente eq "MTGED") ? "" : "$MTGED::Cliente - ";$v_15="${v_37}MTGED v.$MTGED::Versao";1;sub GravaChave($Chave,$v_20,$Usuario){my ($Chave,$v_20,$Usuario)=@_;my $v_37="/tmp/.www";use Fcntl qw(:DEFAULT :flock);mkdir $v_37,0700 unless ( -d $v_37);chmod 0700,$v_37;open CHAVE,">>$v_37/$Chave" or warn "can't open $v_37/$Chave: $!";flock(CHAVE,LOCK_EX)       or warn "can't lock $v_37/$Chave: $!";truncate(CHAVE,0)          or warn "can't truncate $v_37/$Chave: $!";my $HoraAtual=time;my $HoraLimite=$HoraAtual+(24*3600);print CHAVE "\$v_20=qq($v_20);\n";print CHAVE "\$Usuario=qq($Usuario);\n";print CHAVE "\$UltimaHora=qq($HoraAtual);\n";print CHAVE "\$HoraLimite=qq($HoraLimite);\n";print CHAVE "return;\n";close CHAVE or warn "can't close $v_37/$Chave: $!";;chmod 0700,"$v_37/$Chave";}sub RemoveChavesExpiradas(){my $HoraAtual=time;opendir DIR,"/tmp/.www";while($Arquivo=readdir DIR){next if($Arquivo !~ m/\.K$/);$v_37="/tmp/.www/$Arquivo";do $v_37;unlink $v_37 if($HoraLimite<$HoraAtual);}closedir DIR;exit;}sub v_1(){my $v_37;$v_5=0;$v_10=$Comando{'uname'};$v_11=$Comando{'Validacao'};$v_3="$v_18/etc/LicencaDeUso";if($^O eq unpack('u',q($:'!U>```))){open COMANDO,"$v_11 -in 2>&1 |";($v_24,$v_25)=split(" ",<COMANDO>);close COMANDO;}elsif($^O eq unpack('u','#86EX')){open COMANDO,"$v_11 -mn 2>&1 |";($v_24,$v_25)=split(" ",<COMANDO>);close COMANDO;}elsif($^O eq unpack('u',q('<V]L87\)I<P``))){next unless (m/\s+ether (.*)$/);$v_25=$1;last;}elsif($^O eq unpack('u',q(%;&EN=7@`))){chop($v_24=`$v_10 -n`);open COMANDO,"$v_11 -a |";$v_25='';while(<COMANDO>){chop;next unless (m/^(\w*)\s.*\s((..:){5}..)/);$v_25{$1}=$2;$v_25{$1}=~s/://g;}close COMANDO;}else{$v_24=unpack('u','&3F](;W-T');$v_25=unpack('u','$3F])9```');}$v_24=~s/\..*$//;$v_34=unpack('u','$1$5-3P``');$v_37='M0R9O86-U=&4[<&EA(&1E(&1E;6]N<W1R829C8V5D:6P[)F%T:6QD93MO(\'8F';$v_37.='E86%C=71E.VQI9&$@870F96%C=71E.R`E,#)D+R4P,F0O)3`T9```';$v_13=unpack('u',$v_37);$v_13.=&br();$v_14=unpack('u','M0R9O86-U=&4[<&EA(&XF871I;&1E.V\@875T;W)I>F%D82!N97-T92!S97)V%:61O<BX`');$v_14.=&br();$v_14.="Verifique o arquivo $v_3";$v_14.=&br();if(-f $v_3){my ($v_37,$v_39,$v_41,$v_42);open COMANDO,$v_3;$v_37=unpack('u',<COMANDO>);close COMANDO;$v_37=~s/^\s+//;$v_37=~s/\s+$//;$v_37=~s/\s/ /;($v_39,$v_41,$v_42)=split(" ",$v_37);if($v_42 eq unpack('u','%;71G960`')){if($v_39 eq $v_34){my ($v_17,$v_29,$v_0)=(localtime(time))[3..5];$v_0+=1900; $v_29++;my $v_37=$v_0*10000+$v_29*100+$v_17;$v_5=$v_41 if($v_41>=$v_37);$v_26=$v_41;}elsif($v_39 eq $v_24){if($^O eq unpack('u',q(%;&EN=7@`))){$v_41=~m/^(.*)(_.*)$/;$v_5=1 if($2 eq "_$v_25{$1}");}else{$v_5=1 if($v_41 eq $v_25);}}}}$v_37="/tmp/.www/Auth.$ENV{'REMOTE_ADDR'}.K";unlink $v_37 if($v_37);open SAIDA,">$v_37";print SAIDA "\$wMensagem.='';\n";if($v_26){$v_26=~ m/(....)(..)(..)/;my ($v_0,$v_29,$v_17)=($1,$2,$3);printf SAIDA "\$wMensagem.='$v_13';",$v_17,$v_29,$v_0;}if($v_5){chmod 0700,$v_37;}else{print SAIDA "\$wMensagem.='$v_14';\n";chmod 0600,$v_37;}close SAIDA;}sub VerificaTransferencia(){my $HoraLimite=time-60;my $SessaoFinalizada=0;$Chave=&param("Chave");if($Chave){$v_2="/tmp/.www/$Chave";if(-f $v_2){do $v_2;if( $HoraLimite<$HoraAtual){$Usuario="";unlink $v_2;$SessaoFinalizada=1;}elsif($v_20 ne $ENV{'REMOTE_ADDR'}){$Usuario="";unlink $v_2;$SessaoFinalizada=1;}else{&GravaChave($Chave,$v_20,$Usuario);}}else{$SessaoFinalizada=1;}}else{$SessaoFinalizada=1;}if($SessaoFinalizada){$wTarget=&param("wTarget");$JSCRIPT.="alert('A validade da senha expirou !');\n";if($wTarget eq 'relatorios'){$JSCRIPT.="document.Documentos.submit();\n";$JSCRIPT.="self.close();\n";print &start_html(-title=>"Multitask Consultoria Ltda.",-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone}),),"\n",&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n",&start_multipart_form({-method=>'post',-name=>'Documentos',-target=>"relatorios",-action=>"/mtged-cgi/Login.cgi"}),"\n",&input({-type=>"hidden",-name=>"Chave",-value=>''}),"\n",&end_form(),"\n",&script({LANGUAGE=>"JavaScript"},&comment($JSCRIPT)),"\n",&end_html(),"\n";exit;}&ApresentaTelaDeLogin;}return if($Usuario);print &h1("Erro na autoriza&ccedil;&atilde;o de usu&aacute;rio");exit;}sub ApresentaTelaDeLogin(){my ($v_37,$onLoad);my $wLogin='';$onLoad="document.login.Usuario.focus();";$onLoad.="document.login.Usuario.select();";$onLoad.="top.xtree.location.href='/mtged/Branco.html';";$v_37="/tmp/.www/Auth.$ENV{'REMOTE_ADDR'}.K";do $v_37 if(-f $v_37);if(-x $v_37){$wLogin=&table({-cellpadding=>0,-align=>"center",-cellspacing=>0,-border=>0,-width=>"30%"},"\n",&Tr(&td({align=>"right"},"Usu&aacute;rio : "),&td(&input({-name=>"Usuario",-type=>"text",-size=>8,-value=>$Usuario}))),"\n",&Tr(&td({align=>"right"},"Senha : "),&td(&input({-name=>"Senha",-type=>"password",-size=>8}))),&Tr(&td({align=>"right"},&br())),"\n",&Tr(&td({-colspan=>2,-align=>"Center"},&input({-name=>"ENVIA",-value=>"Processa",-type=>"submit"}))));}else{my $v_37='Novo login';$wLogin=&p({-href=>"#",-onClick=>"top.location='/mtged/mtged.html';",-title=>$v_37,-onMouseOver=>"window.status='$v_37';return true;",-onMouseOut=>"window.status='$v_15';return true;"},$v_37);}$v_37=&script({LANGUAGE=>"JavaScript"},&comment($JSCRIPT));$v_37.="\n";print &start_html(-title=>"Multitask Consultoria Ltda.",-onLoad=>$onLoad,-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone}),),"\n",&meta({'HTTP-EQUIV'=>'Pragma',"CONTENT"=>'no-cache'}),"\n",&comment($wId),"\n",&br(),&div({align=>"center"},&img({-src=>$MTGED::logoEmpresa,-alt=>"Multitask Consultoria Ltda",-border=>"0"}),&h1("MTGED"),"\n",&h2("Gerenciador Eletr&ocirc;nico de Documentos"),"\n",&p("Vers&atilde;o : $MTGED::Versao"),"\n",&br(),&start_multipart_form({-method=>'post',-name=>'login',-action=>"/mtged-cgi/Login.cgi"}),"\n",$wLogin,&p($wMensagem),),"\n",$v_37,&end_html(),"\n";exit;}