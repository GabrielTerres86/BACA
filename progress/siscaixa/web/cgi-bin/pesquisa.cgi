#!/usr/local/bin/perl
use lib '/usr/local/Multitask/mtged/cgi-bin';use MTGED;use File::Copy;use FileHandle;use Time::Local;print &header() if($CGI::VERSION);$JSCRIPT="\n";$wId=q($Id: pesquisa.cgi,v 1.9 2005/07/19 02:45:18 fischer Liberado $);print &start_html(-title=>'MTGED - Pesquisa documentos',-head=>&Link({-rel=>"stylesheet",-type=>"text/css",-href=>$MTGED::padraoCSS}).&Link({-rel=>"SHORTCUT ICON",-href=>$MTGED::padraoIcone}),),"\n",&comment($wId),"\n",&meta({'-HTTP-EQUIV'=>'Pragma',-CONTENT=>'no-cache'}),"\n";&VerificaTransferencia();&Abortar() unless ($Usuario);@pFork=();%Nivel1=%Nivel2=();@Nivel1=&param('wNivel1'); foreach my $v_37 (@Nivel1){$Nivel1{$v_37}=1;}@Nivel2=&param('wNivel2'); foreach my $v_37 (@Nivel2){$Nivel2{$v_37}=1;}$TipoDePesquisa=&param('wEOU');$TipoDePesquisa="OU" unless ($TipoDePesquisa);$wArgumento=&param('wArgumento');$wArgumento=~s/^\s+//;$wArgumento=~s/\s+$//;$wDetalhar=&param('wDetalhar');$wCriterio=&param('wCriterio');$wCriterio='.' unless ($wCriterio);$v_37=&param('wDataInicio');$wDataInicio=&ConverteDataInformada($v_37);$v_37=&param('wDataFim');$wDataFim=&ConverteDataInformada($v_37);$PrepararForm=1;my $v_37;if($wArgumento){my @w=split(/\s+/,$wArgumento);$v_37="Procura '".join("' $TipoDePesquisa '",@w)."' nos documentos";}else{$v_37="Procura arquivos";$wArgumento='.';}if($wCriterio ne '.'){$v_37.=" cujo nome cont&eacute;m a string '$wCriterio' ";}my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($wDataInicio))[1..5];$v_0+=1900; $v_29++;$v_37.=sprintf(" criados entre %02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($wDataFim))[1..5];$v_0+=1900; $v_29++;$v_37.=sprintf(" e %02d/%02d/%04d %02d:%02d.",$v_17,$v_29,$v_0,$v_23,$v_30);print &h1({-align=>"Center"},"Resultado de pesquisa"),"\n",&p(&b("Argumento : "),$v_37),"\n";$v_37="$MTGED::DiretorioConf/${Usuario}.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't open $v_37: $!";}else{$v_37="$MTGED::DiretorioConf/default.cfg";if(-f $v_37){open CTRL,$v_37 or die "Can't open $v_37: $!";}else{print &h1("Erro na autoriza&ccedil;&atilde;o de usu&aacute;rio."),&b("Arquivo $v_37 n&atilde;o encontrado."),&end_html();exit;}}my @Permissoes=<CTRL>;close CTRL;foreach my $v_37 (@Permissoes){chomp($v_37);if($v_37=~ m/^([^\/]+)\/([^\/]+)/){next if(($Nivel1{$1}+$Nivel2{$2}) !=2);&ProcessaPasta($v_37);}elsif($v_37=~ m/^([^\/]+)$/){next unless ($Nivel1{$1});&ProcessaPasta($v_37);}}while(){my $v_37=&VerificaFork();last if($v_37==$MTGED::TotalDeProcessosParaPesquisa);}if($PrepararForm){print &h2({-align=>"Center"},"Nenhum documento atendeu aos crit&eacute;rios informados"),"\n";}else{print &end_form(),"\n";}print &script({LANGUAGE=>"JavaScript"}," window.status='$v_15';"),"\n",&br(),&br(),&end_html,"\n";exit;sub ProcessaPasta($){my $Pasta=shift;my $v_37;my @Lista=();$v_37="Pesquisando na pasta $Pasta";print &script({-Language=>"JavaScript"},"  window.status='$v_37';"),"\n";$DirPasta="$MTGED::DiretorioBase/$Pasta";return unless (-d $DirPasta);opendir DIR,"$DirPasta" or die qq(Can't<i>ls -l $Pasta</i>: $!);@Lista=grep !/^\.\.?$/i,readdir DIR;closedir DIR;while($v_37=shift @Lista){next if($v_37=~ m/\.(pdf|png|jpeg|jpg|gif|bmp)$/i);my $v_39="$DirPasta/$v_37";next if(-d $v_39);next unless ($v_37=~ m/$wCriterio/i);my $n=0;my $v_41=(stat $v_39)[9];if($v_41>$wDataInicio && $v_41<$wDataFim){for my $v_37 (1..$MTGED::TotalDeProcessosParaPesquisa){next if($pFork[$v_37]);$n=$v_37;last;}$SIG{CHLD}='IGNORE';if(defined($child_pid=fork())){if(!$child_pid){$SIG{CHLD}='DEFAULT';&PesquisaDocumento("$Pasta/$v_37",$v_39);exit;}}$SIG{CHLD}='DEFAULT';$pFork[$n]=$child_pid;&VerificaFork();}}}sub PesquisaDocumento($$){my ($wPasta,$Documento)=@_;my (%Pesquisa,%wPesquisa);my $fEntrada=new FileHandle;my $fSaida=new FileHandle;my $v_37="$MTGED::htmlDir/temp/$Usuario";my $ArquivoDeWork="$v_37/Pesquisa.$$";my $AchouArgumentos=0;my $GravarLinkInicial=1;my $nLinha=0;my $wMouseOut="window.status='$v_15';return true;";mkdir $v_37,0777 unless (-d $v_37);foreach my $v_39 (split(/\s+/,$wArgumento)){$Pesquisa{$v_39}=0;$wPesquisa{$v_39}=0;}open $fSaida,">${ArquivoDeWork}.tmp" or die "open ${ArquivoDeWork}.tmp: $!";open $fEntrada,$Documento;while(<$fEntrada>){chomp;$nLinha++;my ($v_37,$v_39)=split/\f/;if($v_39){&ProcessaLinha($v_37);$v_37=$v_39}&ProcessaLinha($v_37);next if($wDetalhar);my @w=keys(%wPesquisa);$AchouArgumentos=1 if($#w==-1);last if($AchouArgumentos);}close $fEntrada;if($TipoDePesquisa eq 'E'){my @w=keys(%wPesquisa);if($#w>-1){seek($fSaida,0,0);truncate($fSaida,0);}}close $fSaida;move "${ArquivoDeWork}.tmp",$ArquivoDeWork or die "mv ${ArquivoDeWork}.tmp $ArquivoDeWork: $!";sub ProcessaLinha($){my $Linha=shift;my $ImprimirLinha=1;foreach $arg (keys %Pesquisa){$arg=~ s/(['\\"])/\\$1/g;if($Linha=~ m/$arg/i){if($wDetalhar){if(exists $wPesquisa{$arg}){delete $wPesquisa{$arg};}}else{delete $wPesquisa{$arg};delete $Pesquisa{$arg};if($TipoDePesquisa eq 'E'){my @w=keys(%wPesquisa);next if($#w>-1);}else{$AchouArgumentos=1;}}if($GravarLinkInicial){my ($v_37,$v_39,$v_41);$GravarLinkInicial=0;($size,$mtime)=(stat $Documento)[7,9];$v_37=$Documento;$v_37=~s,^.*/,,;if($Arquivo=~ m/\.(doc|xls|pdf|png|jpeg|jpg|gif|bmp)$/i){$v_39=&br();}else{$v_39=&img({src=>"/mtged/pdf.gif",alt=>"Ver em PDF",-border=>0});}my ($v_30,$v_23,$v_17,$v_29,$v_0)=(localtime($mtime))[1..5];$v_0+=1900; $v_29++;$Info=sprintf("%02d/%02d/%04d %02d:%02d",$v_17,$v_29,$v_0,$v_23,$v_30);$Size=$size;$v_41=&Tr(&td(&a({-href=>"#",-title=>"$v_37 em formato PDF",-onClick=>"ChamaURL('$wPasta',1,''); this.focus(); return false;",-onMouseOver=>"window.status='Abre arquivo $v_37 em formato PDF';return true;",-onMouseOut=>$wMouseOut},$v_39)),&td(&a({-href=>"#",-title=>$Arquivo,-onClick=>"ChamaURL('$wPasta',0,''); this.focus(); return false;",-onMouseOver=>"window.status='Abre arquivo $v_37';return true;",-onMouseOut=>$wMouseOut},$wPasta)),&td({-align=>"Right"},"&nbsp;${Size}&nbsp;"),&td($Info),);print $fSaida "$v_41\n";}if($wDetalhar){if($ImprimirLinha){my ($v_37,$v_39,$v_41);$v_37=$Documento;$v_37=~s,^.*/,,;$v_39="window.status='Abre arquivo $v_37 na linha $nLinha';return true;";$v_41=&Tr(&td(&a({-href=>"#",-title=>"$v_37",-onClick=>"ChamaURL('$wPasta',0,$nLinha); this.focus(); return false;",-onMouseOver=>$v_39,-onMouseOut=>$wMouseOut},"#$nLinha")),&td({-colspan=>3,-onMouseOver=>$v_39,-onMouseOut=>$wMouseOut},$Linha),);print $fSaida "$v_41\n";$ImprimirLinha=0;}}else{return if($AchouArgumentos);}}}}}sub VerificaFork(){my $fLog=new FileHandle;my $Espera=1;while(){my $TotalLivre=0;for my $v_37 (1..$MTGED::TotalDeProcessosParaPesquisa){if($pFork[$v_37]){$ArquivoDeWork="$MTGED::htmlDir/temp/$Usuario/Pesquisa.$pFork[$v_37]";if(-f $ArquivoDeWork){if(-s $ArquivoDeWork){open $fLog,$ArquivoDeWork;while(<$fLog>){&PreparaForm() if($PrepararForm);print;}close $fLog;if($wDetalhar){print &Tr(&td({-colspan=>4},&hr({-width=>"50%"}))),"\n";}}unlink $ArquivoDeWork;$pFork[$v_37]=0;$TotalLivre++;}}else{$TotalLivre++;}}return $TotalLivre if($TotalLivre);sleep $Espera;$Espera++ if($Espera<5);}}sub PreparaForm(){$PrepararForm=0;my $v_37=&self_url();$v_37=~s/pesquisa.cgi.*/mtged.cgi/;$JSCRIPT.="  function ChamaURL(Documento,GeraPDF,Linha){\n";$JSCRIPT.="    document.Documentos.Opcao.value=Documento;\n";$JSCRIPT.="    document.Documentos.GeraPDF.value=GeraPDF;\n";$JSCRIPT.="    document.Documentos.wLinha.value=Linha;\n";$JSCRIPT.="    document.Documentos.target='_blank';\n";$JSCRIPT.="    document.Documentos.action='$v_37';\n";$JSCRIPT.="    document.Documentos.submit();\n";$JSCRIPT.="}\n";print &start_multipart_form({-method=>'post',-name=>'Documentos'}),"\n",&input({-type=>"hidden",-name=>"Chave",-value=>$Chave}),"\n",&hidden({-name=>"GeraPDF",-value=>''}),"\n",&hidden({-name=>"Opcao",-value=>''}),"\n",&hidden({-name=>"wLinha",-value=>''}),"\n",&script({LANGUAGE=>"JavaScript"},&comment($JSCRIPT)),"\n","<TABLE Border=0 Align=Center\n",&Tr(&th({-colspan=>2},"Nome do documento"),&th("Tamanho"),&th("Data de Cria&ccedil;&atilde;o"),"\n",),"\n";}sub ConverteDataInformada($$){my ($Data,$Hora);my $StringInformada=shift;my ($v_30,$hour,$mday,$mon,$year)=(localtime(time))[1..5];$mon++;$year+=1900;my $DiaHoje=$mday;my $MesHoje=$mon;$StringInformada=~s/[^\d\/: ]//g;my @w=split(/ +/,$StringInformada);if($#w==-1){$Data="$mday/$mon/$year";$Hora="$hour:$v_30";}elsif($#w==0){$Data=$w[0];$Hora="$hour:$v_30";}else{$Data=$w[0];$Hora=$w[1];}@w=split('/',$Data);$mday=$w[0] if($#w>-1);$mon=$w[1]  if($#w>0);$year=$w[2] if($#w>1);@w=split(':',$Hora);if($#w>-1){$hour=$w[0];$v_30=($#w>0) ? $w[1] : 0;}$year-=1900 if $year>1900;$mon--;$mon=0  if $mon<0;  $mon=$MesHoje  if $mon>11;$mday=0 if $mday<0; $mday=$DiaHoje if $mday>30;$v_30=0  if $v_30<0;  $v_30=59        if $v_30>59;$hour=0 if $hour<0; $hour=23       if $hour>23;return &timelocal(0,$v_30,$hour,$mday,$mon,$year);}sub Abortar(){print &h1({-align=>"Center"},"Erro na chamada do programa"),&end_html();exit;}