<!-------------------------------------------------------------------------------

   Programa: sistema/internet/fontes/wcrm0007.html
   Sistema : Internet - Cooperativa de Credito
   Sigla   : CRED
   Autor   : Anderson Fossa
   Data    : 17/03/2016.                       Ultima atualizacao: 

   Dados referentes ao programa:
   Frequencia: Sempre que for chamado (On-Line)

   Objetivo  : Consulta de cursos EAD.

   Alteracoes:
--------------------------------------------------------------------------------->

<script language="SpeedScript">
DEF VAR aux_nmrescop LIKE crapcop.nmrescop NO-UNDO.
DEF VAR aux_cdcooper LIKE crapcop.cdcooper NO-UNDO.
		
/* Recebe os parametros  */
ASSIGN aux_cdcooper = INT(GET-VALUE("aux_cdcooper")).
       
/* Busca o nome da cooperativa para montagen da chamada inscLink dinamicamente */
FIND FIRST crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR. 
    
IF  NOT AVAILABLE crapcop  THEN
    DO:
        {&out} '~<script type=~"text/javascript~">alert(~"Nome da cooperativa nao encontrado~")~;~</script~>'.
        RETURN.
    END.
ELSE	
    aux_nmrescop = LC(REPLACE(crapcop.nmrescop, " ", "")).
</script>
<html>
<head>
<title>CECRED</title>
<script language="SpeedScript">
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/alt.css~"~>\n'.
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/estilos_progrid.css~"~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/bloqueio.js~"~>~</script~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/ajax.js~"~>~</script~>\n'.
</script>
<script language="SpeedScript"> 
	DEF VAR aux_dtanoage LIKE gnpapgd.dtanoage NO-UNDO.
	DEF VAR aux_cdevento LIKE crapedp.cdevento NO-UNDO.
  DEF VAR aux_nmevento LIKE crapedp.nmevento NO-UNDO.
	DEF VAR aux_cdagenci LIKE crapagp.cdagenci NO-UNDO.
	DEF VAR aux_nrmeseve LIKE crapadp.nrmeseve NO-UNDO.

	ASSIGN aux_cdevento = INT(GET-VALUE("aux_cdevento"))
		     aux_cdagenci = INT(GET-VALUE("aux_cdagenci"))
		     aux_dtanoage = INT(GET-VALUE("aux_dtanoage"))
         aux_nmevento = STRING(GET-VALUE("aux_nmevento")).
		   
    IF  aux_cdevento = 0  THEN
			ASSIGN aux_nrmeseve = INT(MONTH(TODAY)).
	ELSE
			ASSIGN aux_nrmeseve = INT(GET-VALUE("aux_nrmeseve")).

	FIND crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR.

	IF  NOT AVAILABLE crapcop  THEN
			DO:
					RUN RodaJavaScript("alert('Cooperativa nao encontrada')").
					RETURN.
			END.
	ELSE
			aux_cdcooper = crapcop.cdcooper.		   

	IF  aux_dtanoage = 0  THEN
			DO:
					FIND LAST gnpapgd WHERE gnpapgd.idevento = 1            AND
																	gnpapgd.cdcooper = aux_cdcooper NO-LOCK NO-ERROR. 
        
					IF  NOT AVAILABLE gnpapgd  THEN
							DO:
									RUN RodaJavaScript("alert('Agenda nao encontrada')").
									RETURN.
							END.
					ELSE	
							aux_dtanoage = gnpapgd.dtanoage.					 
			END.
	
	PROCEDURE RodaJavaScript:
		{ includes/rodajava.i }
	END PROCEDURE.				 							
</script>
<script language="javascript" type="text/javascript"> 
function getQueryString() {
	var qs = window.location.search.substring(1).split('&');    
	
	for (var i = 0; i < qs.length; i++) {        
		qs[i] = qs[i].split('='); 
		contador++;   
	}    
	
	return qs;
}

var contador    = 0;
var queryString = getQueryString();

cooperativa = "aux_cdcooper=" + queryString[0][1];
cooper      = "aux_cdcooper=" + queryString[0][1];

if (contador > 1 && window.location.href.search("aux_nrdconta=") != "-1") {
	var nome_array  = queryString[2][1].split(" ");
	var part_nome   = 0;
	var nom_cliente = "";
	
	while (part_nome < nome_array.length) {
		nom_cliente = nom_cliente + nome_array[part_nome] + "%20";
		part_nome += 1;
	}
	
	conta  = "aux_nrdconta=" + queryString[1][1];
	nome   = "aux_nminseve=" + nom_cliente;
	cooper = cooper + "&" + conta + "&" + nome;
}

function ajax_onResponse() {  
	if (checkReadyState(request)) { 
    
		var conteudo = '';
        conteudo += '<div style="position: relative; overflow-y: scroll; overflow-x: hidden; height: 398px; width: 100%;">';
		conteudo += '  <table width="100%" border="0" cellpadding="0" cellspacing="0">';
		
		var xmlDoc = request.responseXML;		
		var erro   = xmlDoc.getElementsByTagName('ERRO');

		if (erro.length > 0) {
			erro = xmlDoc.getElementsByTagName('ERRO').item(0).firstChild.data;
			
			conteudo += '<tr class="fonte_geral">';
			conteudo += '  <td height="25">&nbsp;&nbsp;</td>';
			conteudo += '</tr>';
			conteudo += '<tr class="fonte_geral" align="center">';
			conteudo += '  <td height="25"><strong>' + erro + '</strong></td>';
			conteudo += '</tr>';
			conteudo += '<tr class="fonte_geral">';
			conteudo += '  <td height="25">&nbsp;&nbsp;</td>';
			conteudo += '</tr>';
		} else { 
			var node     = xmlDoc.getElementsByTagName('CURSOS_EAD');			
			var corFundo = new Array('#F2F4F9','#FFFFFF');
			var j        = 0;
			
			for (i = 0; i < node.length; i++) { 
				idevento    = node[i].getElementsByTagName("IDEVENTO").item(0).firstChild.data;
                cdevento    = node[i].getElementsByTagName("CDEVENTO").item(0).firstChild.data;
				dtanoage    = node[i].getElementsByTagName("DTANOAGE").item(0).firstChild.data;
				nmevento    = node[i].getElementsByTagName("NMEVENTO").item(0).firstChild.data;
				if (node[i].getElementsByTagName("DSCARHOR").item(0).firstChild != null) {
				    dscarhor = node[i].getElementsByTagName("DSCARHOR").item(0).firstChild.data;
				} else {
				    dscarhor = '00:00';
				}
        
				conteudo += '<tr>';
                conteudo += '  <td width="10"  height="25" class="fonte_geral_bold"></td>';
				conteudo += '  <td width="550" height="25" class="fonte_geral" bgcolor="' + corFundo[j] + '">&nbsp;' + 
                            '<a href="#" onClick="window.open(' + "'" + 'wcrm0007a.html?' + cooperativa + '&aux_cdevento=' + cdevento + '&aux_idevento=' + idevento + '&aux_dtanoage='+ dtanoage + "','_blank','top=10,left=100,width=570,height=500,maximized=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,scrolling=yes,resizebled=no');return false;" + '" class="fonte_geral_azul">' + nmevento + '</a>';
                    '  </td>';        
				conteudo += '  <td             height="25" bgcolor="' + corFundo[j] + '" class="fonte_geral">' + dscarhor + '  </td>';
				conteudo += '</tr>';
        
				// define a cor de fundo das linhas
				if (j == 0) { 
					j = 1;
				} else {
					j = 0;
				} 
			} 
		}
		
    conteudo += '  </table>';
		conteudo += '</div>';

		document.getElementById("copy").innerHTML = conteudo;

		return conteudo; 
	}                    
}
</script>
<script language="JavaScript">
function pesquisar(){
	// monta a URL do programa que gera o XML   
	var url = "wcrm0007_xml.p?aux_cdcooper=" + `aux_cdcooper` + "&aux_nmevento=" + escape(document.form.aux_nmevento.value) + "&aux_dtanoage=" + `aux_dtanoage`;
	ajax(url);
} 
</script>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
</head>
<body bgcolor="#FFFFFF">
<div id="dhtmltooltip"></div>
<script language="SpeedScript">
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/alt.js~"~>~</script~>\n'.
</script>
<table width="100%" border="0" cellpadding="0" cellspacing="0" align="center">
<form action="javascript:pesquisar()" method="POST" name="form">				
	<tr>
		<td height="6" colspan="5"></td>
	</tr>
	<tr>
    <td width="10"  height="28" class="fonte_geral_bold"></td>
    <td width="45"  height="28" class="fonte_geral_bold">Curso:</td>
		<td width="380" height="28" class="fonte_geral_bold">	
			<input name="aux_nmevento" class="formulario" id="cdevento" style="width: 345px;" />
		</td>				
    <td>
      <input name="btn_pesquisar" type="button" class="formulario" onClick="pesquisar();" value="Pesquisar">
     </td>
	</tr>

	<tr>
		<td colspan="5" height="6" class="fonte_geral_bold">&nbsp;</td>
	</tr>
</form>
</table>
<table width="100%" border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
    <td height="25" background="" class="tit_topo"> 
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
				<tr>
           <td width="10"  height="25" class="fonte_geral_bold"></td>
           <td width="550" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Curso</td>
           <td             background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Carga Hor&aacute;ria</td>
				</tr>
			</table>
      <div id="copy"></div>
		</td>
	</tr>
</table>
<script language="javascript" type="text/javascript"> 
document.form.aux_nmevento.value = "`aux_nmevento`";

pesquisar(); 
</script>
</body>
</html>
