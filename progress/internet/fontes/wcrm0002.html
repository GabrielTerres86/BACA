<!--

Alterações: 12/06/2012 - Alterado busca na tabela gncoper para crapcop. Incluído tratamento
						 no nome da cooperativa para retirar espaços (Guilherme Maba).
						 
            08/08/2013 - Alterada String de PAC para PA. (Reinert)
			
            16/03/2015 - #265366 Inclusão da cláusula crapage.flgdopgd = true para LISTAR
                         somente os PAs ativos para o PROGRID (Carlos)

            02/08/2016 - Inclusao insitage 3-Temporariamente Indisponivel. (Jaison/Anderson)

            21/12/2016 - Ajustes para utilizar o agenda do ano corrente.(Odirlei-AMcom/Marcio-Mouts)

-->
<script language="SpeedScript">

DEF VAR aux_nmrescop LIKE crapcop.nmrescop NO-UNDO.
DEF VAR aux_cdcooper LIKE crapcop.cdcooper NO-UNDO.
		
/* Recebe os parametros  */
ASSIGN aux_cdcooper = INT(GET-VALUE("aux_cdcooper")).
       
/* Busca o nome da cooperativa para montagen da chamada inscLink dinamicamente */
FIND FIRST crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR. 
    
IF  NOT AVAILABLE crapcop  THEN
    DO:
        {&out} '~<script type=~"text/javascript~">alert(~"Nome da cooperativa nao encontrado~")~;~</script~>'.
        RETURN.
    END.
ELSE	
    aux_nmrescop = LC(REPLACE(crapcop.nmrescop, " ", "")).
</script>
<html>
<head>
<title>CECRED</title>
<script language="SpeedScript">
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/alt.css~"~>\n'.
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/estilos_progrid.css~"~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/bloqueio.js~"~>~</script~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/ajax.js~"~>~</script~>\n'.
</script>
<script language="SpeedScript"> 
	DEF VAR aux_dtanoage LIKE gnpapgd.dtanoage NO-UNDO.
	DEF VAR aux_cdevento LIKE crapedp.cdevento NO-UNDO.
	DEF VAR aux_cdagenci LIKE crapagp.cdagenci NO-UNDO.
	DEF VAR aux_nrmeseve LIKE crapadp.nrmeseve NO-UNDO.

	ASSIGN aux_cdevento = INT(GET-VALUE("aux_cdevento"))
		   aux_cdagenci = INT(GET-VALUE("aux_cdagenci"))
		   aux_dtanoage = INT(GET-VALUE("aux_dtanoage")).
		   
  IF aux_cdevento = 0  THEN
			ASSIGN aux_nrmeseve = INT(MONTH(TODAY)).
	ELSE
			ASSIGN aux_nrmeseve = INT(GET-VALUE("aux_nrmeseve")).

	FIND crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR.

	IF  NOT AVAILABLE crapcop  THEN
			DO:
					RUN RodaJavaScript("alert('Cooperativa nao encontrada')").
					RETURN.
			END.
	ELSE
			aux_cdcooper = crapcop.cdcooper.		   

	IF  aux_dtanoage = 0  THEN
			DO:
                    aux_dtanoage = INT(YEAR(TODAY)).
            
					FIND LAST gnpapgd WHERE gnpapgd.idevento = 1            AND
							  gnpapgd.cdcooper = aux_cdcooper     AND
                              gnpapgd.dtanoage = aux_dtanoage
                              NO-LOCK NO-ERROR. 
        
					IF  NOT AVAILABLE gnpapgd  THEN
							DO:
									RUN RodaJavaScript("alert('Agenda nao encontrada')").
									RETURN.
							END.
					ELSE	
							aux_dtanoage = gnpapgd.dtanoage.					 
			END.
	
	PROCEDURE RodaJavaScript:
		{ includes/rodajava.i }
	END PROCEDURE.				 							
</script>
<script language="javascript" type="text/javascript"> 
function getQueryString() {    
	var qs = window.location.search.substring(1).split('&');    
	
	for (var i = 0; i < qs.length; i++) {        
		qs[i] = qs[i].split('='); 
		contador++;   
	}    
	
	return qs;
}

var contador    = 0;
var queryString = getQueryString();

cooperativa = "aux_cdcooper=" + queryString[0][1];
cooper      = "aux_cdcooper=" + queryString[0][1];

if (contador > 1 && window.location.href.search("aux_nrdconta=") != "-1") {
	var nome_array  = queryString[2][1].split(" ");
	var part_nome   = 0;
	var nom_cliente = "";
	
	while (part_nome < nome_array.length) {
		nom_cliente = nom_cliente + nome_array[part_nome] + "%20";
		part_nome += 1;
	}
	
	conta  = "aux_nrdconta=" + queryString[1][1];
	nome   = "aux_nminseve=" + nom_cliente;
	cooper = cooper + "&" + conta + "&" + nome;
}

function ajax_onResponse() {
	if (checkReadyState(request)) { 
		var conteudo = '';
        conteudo += '<div style="position: relative; overflow-y: scroll; overflow-x: hidden; height: 398px; width: 100%;">';
		conteudo += '  <table width="100%" border="0" cellpadding="0" cellspacing="0">';
		
		var xmlDoc = request.responseXML;		
		var erro   = xmlDoc.getElementsByTagName('ERRO');

		if (erro.length > 0) {
			erro = xmlDoc.getElementsByTagName('ERRO').item(0).firstChild.data;
			
			conteudo += '<tr class="fonte_geral">';
			conteudo += '  <td height="25">&nbsp;&nbsp;</td>';
			conteudo += '</tr>';
			conteudo += '<tr class="fonte_geral" align="center">';
			conteudo += '  <td height="25"><strong>' + erro + '</strong></td>';
			conteudo += '</tr>';
			conteudo += '<tr class="fonte_geral">';
			conteudo += '  <td height="25">&nbsp;&nbsp;</td>';
			conteudo += '</tr>';
		} else { 
			var node     = xmlDoc.getElementsByTagName('PROGRAMACAO');			
			var corFundo = new Array('#F2F4F9','#FFFFFF');
			var j        = 0;
			
			for (i = 0; i < node.length; i++) { 
				programacao = node[i].getElementsByTagName("DTMESEVE").item(0).firstChild.data;
				evento      = node[i].getElementsByTagName("NMEVENTO").item(0).firstChild.data;		
				eve_array   = evento.split(" ");
				part_evento = 0;
				eve         = "";
				
				while (part_evento < eve_array.length) {
					eve = eve + eve_array[part_evento] + "%20";
					part_evento += 1;
				}
		
				pac           = node[i].getElementsByTagName("NMRESAGE").item(0).firstChild.data;
				par_permitida = node[i].getElementsByTagName("TPPARTIC").item(0).firstChild.data;		
				cont_array    = par_permitida.split(" ");
				part_tppartic = 0;
				tp            = "";
				
				while (part_tppartic < cont_array.length) {
					tp = tp + cont_array[part_tppartic] + "%20";
					part_tppartic += 1;
				}
		
				pre_incricao  = node[i].getElementsByTagName("IDSTAEVE").item(0).firstChild.data;
				flgcompr      = node[i].getElementsByTagName("FLGCOMPR").item(0).firstChild.data;
				qtmaxtur      = node[i].getElementsByTagName("QTMAXTUR").item(0).firstChild.data;
				dtanoage      = node[i].getElementsByTagName("DTANOAGE").item(0).firstChild.data;
				prfreque      = node[i].getElementsByTagName("PRFREQUE").item(0).firstChild.data;
				nmcidade      = node[i].getElementsByTagName("NMCIDADE").item(0).firstChild.data;		
				cid_array     = nmcidade.split(" ");
				part_nmcidade = 0;
				
				cid           = "";
				
				while (part_nmcidade < cid_array.length) {
					cid = cid + cid_array[part_nmcidade] + "%20";
					part_nmcidade += 1;
				}
		
				cdevento = xmlDoc.getElementsByTagName('NMEVENTO')[i].getAttribute('CDEVENTO');
				cdagenci = xmlDoc.getElementsByTagName('NMRESAGE')[i].getAttribute('CDAGENCI');
				nrseqdig = xmlDoc.getElementsByTagName('NMEVENTO')[i].getAttribute('NRSEQDIG');
				cdpartic = xmlDoc.getElementsByTagName('TPPARTIC')[i].getAttribute('CDPARTIC');
				dsevento = node[i].getElementsByTagName("DSEVENTO").item(0).firstChild.data;
				
				if ((pre_incricao == 'Abertas') || (pre_incricao == 'ABERTAS')) {
					classe_fonte = "fonte_link_verde";
					inscLink     = "/extrato-`aux_nmrescop`/crm/wcrm0003.php?" + cooper + "&aux_idevento=1&aux_cdevento=" + cdevento + "&aux_dtanoage=" + dtanoage + "&cdpartic=" + cdpartic + "&qtmaxtur=" + qtmaxtur + "&flgcompr=" + flgcompr + "&tppartic=" + tp + "&nmevento=" + eve + "&cdagenci=" + cdagenci + "&nrseqdig=" + nrseqdig + "&prfreque=" + prfreque + "&nmcidade=" + cid + "&dsevento=" + dsevento;
					popup        = "window.open('" + inscLink + "','_blank','top=10,left=100,width=566,height=476,maximized=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,scrolling=yes,resizebled=no');";
				} else {
					classe_fonte = "fonte_geral_vermelha";
					popup        = "";
				}	
				
				conteudo += '<tr>';
                conteudo += '  <td width="10" height="25" class="fonte_geral_bold"></td>';
				conteudo += '  <td width="110" height="25" class="fonte_geral" bgcolor="' + corFundo[j] + '">&nbsp;' + programacao + '</td>';
				conteudo += '  <td width="253" height="25" class="fonte_geral_azul" bgcolor="' + corFundo[j] + '">';
				conteudo += '    <a href="#" onClick="window.open(' + "'" + 'wcrm0002a.html?' + cooperativa + '&aux_cdevento=' + cdevento + '&aux_cdagenci=' + cdagenci + '&aux_nrseqdig='+ nrseqdig + "','_blank','top=10,left=100,width=570,height=500,maximized=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,scrolling=yes,resizebled=no');return false;" + '" class="fonte_geral_azul">' + evento + '</a>';
				conteudo += '  </td>';
				conteudo += '  <td width="127" height="25" bgcolor="' + corFundo[j] + '" class="fonte_geral">' + pac + '</td>';
				conteudo += '  <td height="25" colspan="2" bgcolor="' + corFundo[j] + '" class="fonte_geral"><a href="#" onClick="' + popup + 'return false;" class="' + classe_fonte + '" onMouseOver="ddrivetip(' + "'<div align=center><font face=Verdana, Arial, Helvetica, sans-serif size=1 color=#000099>" + par_permitida + "</font></div>','#E4E9F3',200);" + '" onMouseOut="hideddrivetip();">' + pre_incricao + '</a></td>';
				conteudo += '</tr>';
				
				// define a cor de fundo das linhas
				if (j == 0) { 
					j = 1;
				} else {
					j = 0;
				} 
			} 
		}
		
        conteudo += '  </table>';
		conteudo += '</div>';

		document.getElementById("copy").innerHTML = conteudo;

		return conteudo; 
	}                    
}
</script>
<script language="JavaScript">
    function pesquisar(){

	// monta a URL do programa que gera o XML   
	var url = "wcrm0002_xml.p?aux_cdcooper=" + `aux_cdcooper` + "&aux_cdevento=" + document.form.aux_nmevento.value + "&aux_cdagenci=" + document.form.aux_nmresage.value + "&aux_nrmeseve=" + document.form.aux_dtmeseve.value + "&aux_dtanoage=" + `aux_dtanoage`;		 
	ajax(url);
} 
</script>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
</head>
<body bgcolor="#FFFFFF">
<div id="dhtmltooltip"></div>
<script language="SpeedScript">
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/alt.js~"~>~</script~>\n'.
</script>
<table width="100%" border="0" cellpadding="0" cellspacing="0" align="center">
<form action="#." method="POST" name="form">				
	<tr>
		<td height="6" colspan="5"></td>
	</tr>
	<tr>
        <td width="10" height="28" class="fonte_geral_bold"></td>
        <td width="45" height="28" class="fonte_geral_bold">Evento:</td>
		<td height="28" colspan="3" class="fonte_geral_bold">	
			<select name="aux_nmevento" class="formulario" id="cdevento" style="width: 345px;">
				<script language="SpeedScript">		
				FOR EACH crapedp WHERE crapedp.idevento = 1            AND 
															 crapedp.cdcooper = aux_cdcooper AND
															 crapedp.dtanoage = aux_dtanoage AND
															 crapedp.dtlibint <= TODAY       AND
															 crapedp.dtretint >= TODAY       NO-LOCK
															 BREAK BY crapedp.nmevento:										 
				</script>		
				<option value="`crapedp.cdevento`" class="fonte_geral">`CAPS(crapedp.nmevento)`</option>
				<script language="SpeedScript">
				END.					
				</script>
				<option value = "0" class="fonte_geral">TODOS</option>
			</select>
		</td>					
	</tr>
    <tr>
        <td width="10" height="28" class="fonte_geral_bold"></td>
        <td width="45" height="28" class="fonte_geral_bold">Pa:</td>
		<td width="228" height="28" class="fonte_geral_bold">
			<select name="aux_nmresage" class="formulario" id="aux_nmresage">
				<script language="SpeedScript">
				FOR EACH crapage WHERE crapage.cdcooper = aux_cdcooper AND 
									  (crapage.insitage = 1  OR   /* Ativo */
                                       crapage.insitage = 3) AND  /* Temporariamente Indisponivel */
									   crapage.flgdopgd = true
									   NO-LOCK 
									   BREAK BY crapage.nmresage:
				</script>
				<option value="`crapage.cdagenci`" class="fonte_geral">`CAPS(crapage.nmresage)`</option>
				<script language="SpeedScript">
				END. 
				</script>
				<option value="0" class="fonte_geral">TODOS</option>
			</select>
		</td>
		<td width="32" class="fonte_geral_bold">M&ecirc;s:</td>
        <td height="28" class="fonte_geral_bold">
			<select name="aux_dtmeseve" class="formulario" id="aux_dtmeseve">
				<option value = "1"  class="fonte_geral">JANEIRO</option>    
				<option value = "2"  class="fonte_geral">FEVEREIRO</option>    
				<option value = "3"  class="fonte_geral">MARÇO</option>    
				<option value = "4"  class="fonte_geral">ABRIL</option>    
				<option value = "5"  class="fonte_geral">MAIO</option>    
				<option value = "6"  class="fonte_geral">JUNHO</option>    
				<option value = "7"  class="fonte_geral">JULHO</option>  
				<option value = "8"  class="fonte_geral">AGOSTO</option>    
				<option value = "9"  class="fonte_geral">SETEMBRO</option>  
				<option value = "10" class="fonte_geral">OUTUBRO</option>  
				<option value = "11" class="fonte_geral">NOVEMBRO</option>  
				<option value = "12" class="fonte_geral">DEZEMBRO</option>  
				<option value = "0"  class="fonte_geral">TODOS</option>
			</select>
			&nbsp;
			<input name="btn_pesquisar" type="button" class="formulario" onClick="pesquisar();" value="Pesquisar">
		</td>
	</tr>
	<tr>
		<td colspan="5" height="6" class="fonte_geral_bold">&nbsp;</td>
	</tr>
</form>
</table>
<table width="100%" border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
        <td height="25" background="" class="tit_topo"> 
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
				<tr>
                    <td width="10" height="25" class="fonte_geral_bold"></td>
					<td width="110" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">&nbsp;Programa&ccedil;&atilde;o</td>
					<td width="253" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Evento</td>
					<td width="127" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Pa</td>
					<td background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Pr&eacute;-inscri&ccedil;&otilde;es</td>
				</tr>
			</table>
            <div id="copy"></div>
		</td>
	</tr>
</table>
<script language="javascript" type="text/javascript">
 
document.form.aux_nmevento.value = `aux_cdevento`;
document.form.aux_nmresage.value = `aux_cdagenci`;	 
document.form.aux_dtmeseve.value = `aux_nrmeseve`;   

pesquisar(); 

function RemoverMes(){
    var dataPadrao = new Date();
    var mm = dataPadrao.getMonth() + 1;
    
    //Identificar os mese menores que o mês atual e remover da lista
    var aux_dtmeseve = document.getElementById("aux_dtmeseve");
    if (aux_dtmeseve.length > 0) {
        for (i = 0; i < aux_dtmeseve.length; i++) {             
            
            var mes_2 = parseFloat(aux_dtmeseve.options.item(i).value);
            
            if (mes_2 < mm && 
                aux_dtmeseve.options.item(i).value != '0') {
                aux_dtmeseve.remove(i);
                i = i-1;
            }
        }
    }
    
    return false;    
}
RemoverMes();

</script>
</body>
</html>
