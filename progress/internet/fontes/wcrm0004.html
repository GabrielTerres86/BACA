<!--

Alterações: 30/11/2010 - David - Ajuste na leitura do xml para listagem de eventos por nome.

			12/06/2012 - Alterado busca na tabela gncoper para crapcop. Incluído tratamento
						 no nome da cooperativa para retirar espaços (Guilherme Maba).

-->
<script language="SpeedScript">
DEF VAR aux_nmrescop LIKE crapcop.nmrescop NO-UNDO.
DEF VAR aux_cdcooper LIKE crapcop.cdcooper NO-UNDO.
		
/* Recebe os parametros  */
ASSIGN aux_cdcooper = INT(GET-VALUE("aux_cdcooper")).
       
/* Busca o nome da cooperativa para montagen da chamada inscLink dinamicamente */
FIND FIRST crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR. 
    
IF  NOT AVAILABLE crapcop  THEN
    DO:
        {&out} '~<script type=~"text/javascript~">alert(~"Nome da cooperativa nao encontrado~")~;~</script~>'.
        RETURN.
    END.
ELSE	
    aux_nmrescop = LC(REPLACE(crapcop.nmrescop, " ", "")).
</script>
<html>
<head>
<title>CECRED</title>
<script language="SpeedScript">
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/estilos_progrid.css~"~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/bloqueio.js~"~>~</script~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/ajax.js~"~>~</script~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/valida_data.js~"~>~</script~>\n'.
</script>
<script>
document.oncontextmenu = new Function("return false");
function ajax_onResponse() {
	if (checkReadyState(request)) {  
		xmlDoc = request.responseXML;
		
		conteudo = "<div style='position:relative; left:-1px; top:0px; width:100%; height:420px; z-index:1; visibility: inherit; overflow:auto;'><table width='573' border='0' cellpadding='0' cellspacing='0'>";

		var erro = xmlDoc.getElementsByTagName('ERRO');
		
		if (erro.length > 0) {
			erro = erro[0].firstChild.data;
			conteudo = conteudo + '<tr class="fonte_geral"><td height="25">&nbsp;&nbsp;</td></tr>';
			conteudo = conteudo + '<tr class="fonte_geral" align="center"><td height="25"><strong>'+erro+'</strong></td></tr>';
			conteudo = conteudo + '<tr class="fonte_geral"><td height="25">&nbsp;&nbsp;</td></tr>';
		} else {
			// Obtem nodes com dados dos eventos por associado
			var node = xmlDoc.getElementsByTagName('ASSOCIADO');
			
			for (i = 0; i < node.length; i++) {
				// Nome do associado
				associado = node[i].getAttribute('NMINSEVE');
				
				conteudo = conteudo + '<tr><td width="367" height="25" bgcolor="#F2F4F9" class="fonte_geral_azul">&nbsp;&nbsp;' + associado + '</td><td width="102" height="25" align="center" bgcolor="#F2F4F9" class="fonte_geral_link"></td><td width="104" height="25" align="center" bgcolor="#F2F4F9" class="fonte_geral"></td></tr>';
				conteudo = conteudo + '<tr><td height="25" class="fonte_geral"><span class="fonte_geral_bold">&nbsp;&nbsp;Eventos</span></td><td height="25" align="center" class="fonte_geral_link"></td><td height="25" align="center" class="fonte_geral"></td></tr>';

				// Carrega conteudo dos eventos
				evento = node[i].getElementsByTagName('EVENTO');
				
				for (j = 0; j < evento.length; j++) {
					// Nome do evento
					nom_evento = evento[j].getElementsByTagName('NMEVENTO').item(0).firstChild.data;
					// Data de inicio
					dat_inicio = evento[j].getElementsByTagName('DTINIEVE').item(0).firstChild.data;
					// Data de fim
					dat_fim = evento[j].getElementsByTagName('DTFINEVE').item(0).firstChild.data;
					
					conteudo = conteudo + '<tr><td width="367" height="25" class="fonte_geral">&nbsp;&nbsp;<span class="fonte_geral">'+ nom_evento + '</span></td><td width="102" height="25" align="center" class="fonte_geral">' + dat_inicio + '</td><td width="104" height="25" align="center" class="fonte_geral">' + dat_fim + '</td></tr>';
				}
				
				conteudo = conteudo+'<tr><td height="1" colspan="3" bgcolor="#666666" class="fonte_geral"></td></tr>';
			}
		}
		
		conteudo = conteudo + '</table></div>';
		
		document.getElementById('copy').innerHTML = conteudo;
		
		return conteudo;
	}
}
</script>
<script language="SpeedScript">
    DEF VAR aux_nrdconta LIKE crapidp.nrdconta      		NO-UNDO.
	DEF VAR aux_dtinihis LIKE crapidp.dtpreins          NO-UNDO.
	DEF VAR aux_dtfimhis LIKE crapidp.dtpreins          NO-UNDO.
	DEF VAR aux_idseqttl LIKE crapidp.idseqttl          NO-UNDO.

    /* Recebe os parametros */
	ASSIGN aux_nrdconta = INT(GET-VALUE("aux_nrdconta"))
           aux_dtinihis = DATE(1,1,YEAR(TODAY))
           aux_dtfimhis = DATE(1,1,YEAR(TODAY) + 1) - 1
		                  aux_idseqttl = INT(GET-VALUE("aux_idseqttl")).
</script>
<script language="JavaScript">
function pesquisar(){
   // monta a URL do programa que gera o XML   
   var url = "wcrm0004_xml.p?aux_cdcooper=" + `aux_cdcooper` + "&aux_nrdconta=" + `aux_nrdconta` + "&aux_dtinihis=" + document.form.aux_dtinihis.value + 
	         "&aux_dtfimhis=" + document.form.aux_dtfimhis.value + "&aux_idseqttl=" + `aux_idseqttl`;
   ajax(url);
}
</script>
</head>
<body>
<table width="600" border="0" cellpadding="0" cellspacing="0">
<form action="POST" name="form">
  <tr>
    <td height="10"></td>
    <td height="10" class="fonte_geral"></td>
    </tr>
  <tr>
    <td width="9" height="30">&nbsp;</td>
    <td width="535" height="30" class="fonte_geral"><span class="fonte_geral_bold">
      &nbsp;&nbsp;Data inicial: 
      <input name="aux_dtinihis" type="text" class="formulario" id="aux_dtinihis" size="10" maxlength="10" value="`aux_dtinihis FORMAT "99/99/9999"`" onBlur="DateFormat(this,this.value,event,true,'3')" onKeyUp="DateFormat(this,this.value,event,false,'3')">
      &nbsp;&nbsp;Data&nbsp;final:
      <input name="aux_dtfimhis" type="text" class="formulario" id="aux_dtfimhis" size="10" maxlength="10" value="`aux_dtfimhis FORMAT "99/99/9999"`" onBlur="DateFormat(this,this.value,event,true,'3')" onKeyUp="DateFormat(this,this.value,event,false,'3')">
      &nbsp;&nbsp;
	  <input name="btn_pesquisar" type="button" class="formulario" onClick="pesquisar();" value="Pesquisar">
    </span></td>
    </tr>
  <tr>
    <td height="10"></td>
    <td height="10" class="fonte_geral"></td>
    </tr>
  <tr>
    <td height="20"></td>
    <td height="20" class="fonte_geral"><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="367" height="25" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">&nbsp;&nbsp;Nome</td>
        <td width="102" height="25" align="center" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Data inicial </td>
        <td width="104" height="25" align="center" background="/extrato-`aux_nmrescop`/imagens/geral/fnt_tit_lista.jpg" class="fonte_geral_bold">Data final </td>
        <td width="18" align="center" class="fonte_geral_bold">&nbsp;</td>
      </tr>

      <tr>
        <td height="2" colspan="4" class="fonte_geral"></td>
        </tr>
      <tr>
        <td height="25" colspan="4" class="fonte_geral"><div id="copy"></div></td>
        </tr>

    </table></td>
    </tr>
</form>
</table>
<script language="JavaScript">
	pesquisar();
</script>
</body>
</html>
