<!--

Alterações: 12/06/2012 - Alterado busca na tabela gncoper para crapcop. Incluído tratamento
						 no nome da cooperativa para retirar espaços (Guilherme Maba).

            19/04/2013 - Condicoes para setar banner de cursos (Jorge).
-->
<script language="SpeedScript">
DEF VAR aux_nmrescop LIKE crapcop.nmrescop NO-UNDO.
DEF VAR aux_cdcooper LIKE crapcop.cdcooper NO-UNDO.

DEF VAR aux_imgcurso AS CHAR               NO-UNDO.


/* Recebe os parametros  */
ASSIGN aux_cdcooper = INT(GET-VALUE("aux_cdcooper")).
       
       
/* Busca o nome da cooperativa para montagen da chamada inscLink dinamicamente */
FIND FIRST crapcop WHERE crapcop.cdcooper = aux_cdcooper NO-LOCK NO-ERROR. 
    
IF  NOT AVAILABLE crapcop  THEN
    DO:
        {&out} '~<script type=~"text/javascript~">alert(~"Nome da cooperativa nao encontrado~")~;~</script~>'.
        RETURN.
    END.
ELSE	
    aux_nmrescop = LC(REPLACE(crapcop.nmrescop, " ", "")). 

/* condicoes para banner de cursos */
IF (aux_cdcooper  = 1 AND TODAY < 05/10/2013) OR
   (aux_cdcooper <> 1 AND TODAY < 04/24/2013) THEN  
    ASSIGN aux_imgcurso = "agenda_cursos_new.jpg".
ELSE
    ASSIGN aux_imgcurso = "agenda_cursos_nova.jpg".

</script>
<html>
<head>
<title>CECRED</title>
<script language="SpeedScript">
{&out} '~<link rel=~"stylesheet~" type=~"text/css~" href=~"/extrato-' + aux_nmrescop + '/crm/css/estilos_progrid.css~"~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/bloqueio.js~"~>~</script~>\n'.
{&out} '~<script type=~"text/javascript~" src=~"/extrato-' + aux_nmrescop + '/crm/js/ajax.js~"~>~</script~>\n'.
</script>
<script type="text/javascript">
// recupera os parametros do extrato
function getQueryString(){    
	var qs = window.location.search.substring(1).split('&');    
	for (var i = 0; i < qs.length; i++) {        
		qs[i] = qs[i].split('=');    
	}    
	return qs;
}

parametros = '';

var queryString = getQueryString();
var nome_array  = queryString[0][1].split(" ");
var part_nome   = 0;
var nom_cliente = '';

while (part_nome < nome_array.length){
	nom_cliente = nom_cliente+nome_array[part_nome]+"%20";
	part_nome+=1;
}

nome          = 'aux_nminseve=' + nom_cliente;
conta         = 'aux_nrdconta=' + queryString[1][1];
aux_cdcooper  = 'aux_cdcooper=' + queryString[2][1];
aux_cdagenci  = 'cdagenci=' + queryString[3][1];
conta_cliente = queryString[4][1];
parametros    = nome+'&'+conta+'&'+aux_cdcooper+'&'+aux_cdagenci;

nrdconta = queryString[1][1];
cdcooper = queryString[2][1];
cdagenci = queryString[3][1];
idseqttl = queryString[5][1];
 
// carraga dados na tela
function ajax_onResponse() {
    if (checkReadyState(request)) {  
        xmlDoc = request.responseXML;
		conteudo = "<div style='position:relative; left:-1px; top:0px; width:380px; height:134px; z-index:1; visibility: inherit; overflow:auto;'><table border='0' cellpadding='0' cellspacing='0'><tr><td colspan='3'><hr width='350' size='1' color='#CCCCCC'></td></tr>";
        
		var erro = xmlDoc.getElementsByTagName('ERRO');
		
        if (erro.length > 0) {
			erro = xmlDoc.getElementsByTagName('ERRO').item(0).firstChild.data;
			conteudo = conteudo+'<tr class=fonte_geral><td height=25>&nbsp;&nbsp;</td></tr>';
			conteudo = conteudo+'<tr class=fonte_geral align=center><td height=25><strong>'+erro+'</strong></td></tr>';
			conteudo = conteudo+'<tr class=fonte_geral><td height=25>&nbsp;&nbsp;</td></tr>';
		} else {
			var node = xmlDoc.getElementsByTagName('EVENTO');
			// retorna atributos
			// codigo da agencia
			cdagenci =  xmlDoc.getElementsByTagName('CECRED')[0].getAttribute('CDAGENCI');
			// Pac
			nmresage =  xmlDoc.getElementsByTagName('CECRED')[0].getAttribute('NMRESAGE');

			for(i=0; i < node.length; i++) {
				// data
				dat_evento = node[i].getElementsByTagName("DTINIEVE").item(0).firstChild.data;
				// nome do evento
				nom_evento = node[i].getElementsByTagName("NMEVENTO").item(0).firstChild.data;

				var eve_array=nom_evento.split(" ");
				var part_evento=0;
				var eve = '';
				while (part_evento < eve_array.length){
					eve = eve+eve_array[part_evento]+"%20";
					part_evento+=1;
				}

				// quantidade maxima da turma
				qtmaxtur = node[i].getElementsByTagName("QTMAXTUR").item(0).firstChild.data;
				// flgcompr
				flgcompr = node[i].getElementsByTagName("FLGCOMPR").item(0).firstChild.data;
				// nome do evento
				tppartic = node[i].getElementsByTagName("TPPARTIC").item(0).firstChild.data;

				var cont_array=tppartic.split(" ");
				var part_tppartic=0;
				var tp = '';
				while (part_tppartic < cont_array.length){
					tp = tp+cont_array[part_tppartic]+"%20";
					part_tppartic+=1;
				}
				//atributos dos campos
				//codigo do evento
				cdevento = xmlDoc.getElementsByTagName('NMEVENTO')[i].getAttribute('CDEVENTO');
				//NRMESEVE
				nrmeseve = xmlDoc.getElementsByTagName('DTINIEVE')[i].getAttribute('NRMESEVE');
				//NRSEQDIG
                nrseqdig = node[i].getElementsByTagName("NRSEQDIG").item(0).firstChild.data;
				// Frequencia
                prfreque = node[i].getElementsByTagName("PRFREQUE").item(0).firstChild.data;
				// Cidade
                nmcidade = node[i].getElementsByTagName("NMCIDADE").item(0).firstChild.data;
				// Ano do evento
				dtanoage = node[i].getElementsByTagName("DTANOAGE").item(0).firstChild.data;
				// descricao
				dsevento = node[i].getElementsByTagName("DSEVENTO").item(0).firstChild.data;

				var cont_cid=nmcidade.split(" ");
				var part_cid=0;
				var cid = '';
				while (part_cid < cont_cid.length){
					cid = cid+cont_cid[part_cid]+"%20";
					part_cid+=1;
				}
				inscLink = "/extrato-`aux_nmrescop`/crm/wcrm0003.php?"+parametros+"&AREA=4&aux_idevento=1&aux_cdevento="+cdevento+"&qtmaxtur="+qtmaxtur+"&tppartic="+tp+"&flgcompr="+flgcompr+"&nmevento="+eve+"&nrseqdig="+nrseqdig+"&prfreque="+prfreque+"&nmcidade="+cid+"&aux_dtanoage="+dtanoage+"&dsevento="+dsevento;
				popup = "onClick=javascript:window.open('"+inscLink+"','_blank','top=10,left=100,width=566,height=476,maximized=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,scrolling=yes,resizebled=no');";

				// linha da tabela
				conteudo = conteudo+"<tr><td width='11'>&nbsp;</td><td colspan='2' class='tit_normal'><a href='#' onclick=javascript:window.open('wcrm0002a.html?aux_cdcooper="+cdcooper+"&aux_cdevento="+cdevento+"&aux_cdagenci="+cdagenci+"&aux_nrseqdig="+nrseqdig+"','_blank','top=10,left=100,width=570,height=500,maximized=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,scrolling=yes,resizebled=no'); class='tit_normal'><strong>"+
                                           nom_evento+"</strong></a><br></td></tr><tr><td width='11'>&nbsp;</td><td width='169' class='tit_normal'>"+dat_evento+"&nbsp;</td><td width='170' align='right' class='tit_normal'><a href='#' "+popup+"><font color=#000000>Pré Inscrição</font></a>&nbsp;&nbsp;</td></tr><tr><td colspan='3' height='1' bgcolor='cccccc'></td></tr>";

			}
		}

		conteudo = conteudo+"</table></div>";
		document.getElementById('copy').innerHTML = conteudo;
		return conteudo;
	}
}

function historico() {
	window.parent.location.href = "/extrato-`aux_nmrescop`/frame_extrato.php?AREA=3&aux_cdcooper="+cdcooper+"&aux_nrdconta="+conta_cliente+"&aux_idseqttl="+idseqttl;
}
function eventos() {
	window.parent.location.href = "/extrato-`aux_nmrescop`/frame_extrato.php?AREA=2&cdcooper="+cdcooper+"&aux_nrdconta="+conta_cliente;
}
</script>
<script language="JavaScript">
var url = "wcrm0005_xml.p?aux_cdcooper=" + cdcooper + "&aux_cdagenci=" +  cdagenci;
</script> 
</head>
<body onLoad="ajax(url);">
<table width="380" border="0" class="tabelaBorda" cellpadding="0" cellspacing="0">
    <tr>
	    <td height="70" align="center" valign="top" bgcolor="#FFFFFF">
            <img height="60" src="/extrato-`aux_nmrescop`/crm/images/geral/`aux_imgcurso`" width="378" border="0">
        </td>
    </tr>
    <tr>
	    <td valign="top" bgcolor="#FFFFFF"><div id="copy"></div></td>
    </tr>                                                             
</table>
</body>
</html>
