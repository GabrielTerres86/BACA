<!-------------------------------------------------------------------------------------

  Alterações: 25/07/2017 - Criaçao da Tela para Eventos Assembleares, fonte cópia da
                           tela WPGD0019, Prj. 322 (Jean Michel).
                         
              01/06/2018 - Ajustes referente alteracao da nova marca (P413 - Jonata Mouts).

			  18/07/2018 - Ajuste realizado para que o sequencial NRSEQDIG nunca seja inserido zerado. (INC0017391 - Kelvin)

-------------------------------------------------------------------------------------->
<html>
  <head>
    <link REL=STYLESHEET TYPE="text/css" HREF="/cecred/estilos/estiloage.css">
    <link href="/cecred/estilos/progrid.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="/cecred/scripts/jquery.js"></script>
    <script type="text/javascript" src="/cecred/scripts/scripts.js"></script>	
    <script type="text/javascript" src="/cecred/scripts/funcoes.js"></script>
   </head>
    <script language="JavaScript">
      // variaveis q aramazenam os valores das coordenadas x e y da div onde esta o nome do PAC
      var vXD=0;vYD=0;vXCabec=0;vYCabec=0;
      /*
      MesEvento - Array de Registros com as informações dos eventos
      p: Codigo do PAC
      m: Mes da realizacao do evento
      e: codigo do evento 
      x: coordenada x para posicionar a div
      y: coordenada y para posicionar a div
      td: id da <td> onde esta a div do pac
      ev: id da div com o nome do pac
      a: boolean indicando se houve alteracao do evento para o PAC na agenda
      ix: numero da linha(<tr>) na tabela(<table>) onde esta a div
      rw: rowid do registro do evetno(crapadp)
      bg: cor de fundo da div do evento
      mo: motivo da transferencia
      */
      var mesEvento = new Array();  
      
      // Arrays auxiliares para enviar as informações alteradas e incluidas na agenda
      var mEventos = new Array();
      var mPacs = new Array();
      var mMes = new Array();
      var mMotivos = new Array();
      var mRowids = new Array();
	  
	  function aguarde(){
        // abre a janela com a mesagem de aguarde
          showMsgAguardo("Carregando Dados..."); 
	  } 
	  
      // Acha a posição do eixo X do objeto
      function findPosX(obj){       
        var curleft = 0;
        if (obj.offsetParent){
          while (obj.offsetParent){
            curleft += obj.offsetLeft
            obj = obj.offsetParent;
          }
        }else if (obj.x)
        
        curleft += obj.x;
        return curleft;
      }
      
      // Acha a posição do eixo Y do objeto
      function findPosY(obj){
        var curtop = 0;
        if (obj.offsetParent){
          while (obj.offsetParent){
            curtop += obj.offsetTop
            obj = obj.offsetParent;
          }
        }else if (obj.y){
          curtop += obj.y;
        }
          return curtop;
      }
      
      //Adiciona linha na tabela de seleção
      function novaLinha(num,indice,evento,linha,zebra){
        // num = numero da ultima div
        // indice = indice do evento no vetor q informa o numero de linhas por evento
        // evento = codigo do evento
        // linha = numero da ultima linha da agenda

        /* Observação: Na criação da PRIMEIRA linha nova para o PRIMEIRO EVENTO da lista (indice = 0),
        as células eram criadas com o mesmo nome das anteriores, fazendo com que fossem
        anuladas as duas linhas.
        Para isso foi feito alterações nas variáveis que controlam esses nomes, somando
        e diminuindo os contadores das mesmas.
        */
        num = parseInt(num);
        var row;var cell;var linky="";
        var aux_corfundo;

        if(zebra == ''){
          aux_corfundo = "white";
        }else{
          aux_corfundo = "#e4e6dd";
        }
        
        poseventos[indice] = parseInt(poseventos[indice]  + 1);   

        for (i=0;i<mesEvento.length;i++) {   
          if (mesEvento[i].ix >= poseventos[indice]){
            mesEvento[i].ix += 1;
          }
        }

        row=document.all.selecao.insertRow(poseventos[indice]);
        
        for (i=indice+1;i<poseventos.length;i++) {
          poseventos[i] = parseInt(poseventos[i] + 1);
        }

        // para não duplicar os nomes das células
        if(indice == 0){
          poseventos[indice] = parseInt(poseventos[indice]  + 1);  
        }

        num += 1;
        row.className = "dataTableRow";   
        document.all['ev' + evento].rowSpan=parseInt(document.all['ev' + evento].rowSpan)+1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";  
        cell.id = poseventos[indice]  + 'jan' + evento;   
        linky='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>';
        cell.innerHTML=linky;
        mesEvento.push({mo:'',bg:'white',a:'n',m:1,e:evento,p:'',x:0,y:0,td:poseventos[indice]  + 'jan' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'fev' + evento;
        linky='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>';
        cell.innerHTML=linky; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:2,e:evento,p:'',x:0,y:0,td:poseventos[indice]  + 'fev' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'mar' + evento;
        linky='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>';
        cell.innerHTML=linky; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:3,e:evento,p:'',x:0,y:0,td:poseventos[indice]  + 'mar' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'abr' + evento;
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:4,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'abr' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'mai' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:5,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'mai' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'jun' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:6,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'jun' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'jul' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:7,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'jul' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'ago' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:8,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'ago' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'set' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:9,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'set' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'out' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:10,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'out' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'nov' + evento
        cell.innerHTML='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>'; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:11,e:evento,p:'',x:0,y:0,td:poseventos[indice] + 'nov' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        num += 1;
        cell=row.insertCell();
        cell.className = "LinhaTabelaSelect";
        cell.id = poseventos[indice]  + 'dez' + evento;
        linky='<div STYLE="width:55px; BACKGROUND-COLOR:' + aux_corfundo + '" class="infparcela" id="nome' + num + '"></div>';
        cell.innerHTML=linky; 
        mesEvento.push({mo:'',bg:'white',a:'n',m:12,e:evento,p:'',x:0,y:0,td:poseventos[indice]  + 'dez' + evento,rw:'',ix:poseventos[indice],ev:'nome' + num });
        
        document.form.ultimadiv.value = num;
        document.form.ultimalinha.value = parseInt(document.form.ultimalinha.value) + 1;
        mudaXYdoEvento();

        // para não "se perder" na criacao das linhas
        if(indice == 0){
          poseventos[indice] = parseInt(poseventos[indice]  - 1);          
        }
      }
      
      function mudaTitulo(valor){
        document.all[document.form.novopac.value].innerHTML = valor.substr(0,9);
      }
      
      // função que corrige a posição do eixo x e y de cada div de evento de cada celula de mes de acordo com a resolução do video 
      function mudaXYdoEvento(){
        for(j=0;j<mesEvento.length;j++){ 
          mesEvento[j].x = parseInt(findPosX(document.all[mesEvento[j].ev]));
          mesEvento[j].y = parseInt(findPosY(document.all[mesEvento[j].ev]));
        }
      }
      
      function MostraPACs(){
        var oOption;
        var tpevento = $("#cdevento").children(":selected").attr("tpevento");
        for (var i=document.all.cdagenci.options.length; i>=0; i--){
          document.all.cdagenci.remove(i); 
        }
        
        if(tpevento != 7 && tpevento != 12){
          for(i=0;i<mpac.length;i++){
            if (mpac[i].cdcooper == document.form.aux_cdcooper.value){
              oOption = document.createElement("OPTION");
              document.all.cdagenci.options.add(oOption);
              oOption.innerText = mpac[i].nmresage;
              oOption.value = mpac[i].cdagenci;
            }
          }
        }else{
          oOption = document.createElement("OPTION");
          document.all.cdagenci.options.add(oOption);
          oOption.innerText = "TODOS";
          oOption.value = 0;
        }
        
      }
    </script>
    <script language="SpeedScript">

      /***************************************************************************************************/
      /*            TABELAS                                                                              */
      /*            crapeap - Eventos da Agenda do  Progrid                                               */
      /*            gnpapgd - Parametros da Agenda do Progrid                                            */
      /***************************************************************************************************/
      DEF BUFFER b-crapage FOR crapage.
      DEF BUFFER b-crapadp FOR crapadp.

      DEF VAR aux_dtanoage     LIKE gnpapgd.dtanoage    NO-UNDO.
      DEF VAR aux_erro         AS LOG INIT NO           NO-UNDO.
      DEF VAR aux_mesini       AS INT INIT 1            NO-UNDO. /* mes inicial */
      DEF VAR aux_mesmax       AS INT INIT 12           NO-UNDO. /* mes final */
      DEF VAR aux_maxlin       AS INT INIT 2            NO-UNDO. /* maximo de linhas por evento */
      DEF VAR aux_mesaux       AS INT                   NO-UNDO.
      DEF VAR aux_mescont      AS INT                   NO-UNDO.
      DEF VAR aux_linhacont    AS INT                   NO-UNDO.
      DEF VAR aux_meses        AS CHAR EXTENT 12 INIT ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"].
      DEF VAR aux_cdagenci     AS INT                   NO-UNDO.
      DEF VAR aux_nmresage23   LIKE crapage.nmresage    NO-UNDO. /* pacs "montados" pela tela, nao pela include de pacs */
      DEF VAR c-poseventos     AS CHAR                  NO-UNDO. /* vetor das linhas por evento */
      DEF VAR i-poseventos     AS INT INIT -1           NO-UNDO. 
      DEF VAR aux_corfundo     AS CHAR                  NO-UNDO.
      DEF VAR aux_acdagenci    AS CHAR                  NO-UNDO.
      DEF VAR aux_dstextab     AS CHAR                  NO-UNDO.
      DEF VAR aux_acdevento    AS CHAR                  NO-UNDO.
      DEF VAR aux_idinseve     AS CHAR                  NO-UNDO.

      DEF VAR vetorpac         AS CHAR                  NO-UNDO.
      DEF VAR aux_prievento    AS CHAR                  NO-UNDO.
      DEF VAR aux_segevento    AS CHAR                  NO-UNDO.
      DEF VAR aux_abaevento    AS CHAR                  NO-UNDO.
      DEF VAR aux_contador     AS INT                   NO-UNDO.
      DEF VAR aux_linha        AS INT                   NO-UNDO.
      DEF VAR aux_posicaovetor AS INT                   NO-UNDO.
      DEF VAR aux_arrumacab    AS CHAR                  NO-UNDO.
      DEF VAR aux_evts         AS CHAR FORMAT "X(2000)" NO-UNDO.
      DEF VAR aux_i            AS INTEGER               NO-UNDO.
      DEF VAR aux_mes          AS CHAR                  NO-UNDO.
      DEF VAR aux_motivos      AS CHAR                  NO-UNDO.
      DEF VAR aux_evento       AS CHAR                  NO-UNDO.
			DEF VAR aux_contnrseq     AS INTEGER                  NO-UNDO.
      DEF VAR aux_pac          AS CHAR                  NO-UNDO.
      DEF VAR aux_rowid        AS CHAR                  NO-UNDO.
      DEF VAR aux_ttrowid      AS CHAR                  NO-UNDO.
      DEF VAR aux_selevento    AS INT                   NO-UNDO.
      DEF VAR aux_cdcooper     AS INT                   NO-UNDO.
      DEF VAR aux_selected     AS CHAR                  NO-UNDO.
      DEF VAR aux_zebra        AS CHAR                  NO-UNDO.
      DEF VAR aux_idstagen     AS CHAR                  NO-UNDO.
          
      DEF VAR aux_dsdemail      LIKE crapage.dsdemail.
      DEF VAR h-b1wgen0011 		AS HANDLE NO-UNDO.
      DEF VAR aux_dsconteu 		AS CHAR NO-UNDO.
      DEF VAR aux_dscritic 		AS CHAR NO-UNDO.
  
      /* Total de Eventos */
      DEF VAR aux_qttoteve     AS INTEGER                                     NO-UNDO.
      DEF VAR aux_idevento     AS INTEGER                                     NO-UNDO.
            
      /* Total de Integracoes */
      DEF VAR aux_qttotint     AS INTEGER                                     NO-UNDO.
      /* Total de Eventos + Integracoes */
      DEF VAR aux_qttotger     AS INTEGER                                     NO-UNDO.

      DEF VAR aux_msgderro     AS CHAR                  NO-UNDO.
      DEF VAR aux_nrdrowid     AS CHAR                  NO-UNDO.        

      DEF TEMP-TABLE cratedp LIKE crapedp
      FIELD flgordem       AS LOGICAL   INIT NO.  /* Para poder ordenar por NOME e colocar as INTEGRAÇÔES no fim da lista */

      /* gera agenda*/
      DEF TEMP-TABLE  tt-eventomes
      FIELD cdevento LIKE crapeap.cdevento
      FIELD mes      LIKE crapadp.nrmeseve    
      FIELD vezes    as int
      INDEX ch-vezes  cdevento vezes .

      DEF TEMP-TABLE  tt-pacmes
      FIELD cdagenci LIKE crapeap.cdagenci
      FIELD mes      LIKE crapadp.nrmeseve    
      FIELD vezes    as int
      INDEX ch-mes cdagenci mes
      INDEX ch-vezes  cdagenci vezes .

      DEF BUFFER b-eventomes FOR tt-eventomes.

      DEF TEMP-TABLE tt-novaagenda
      FIELD cdevento LIKE crapadp.cdevento
      FIELD cdagenci LIKE crapeap.cdagenci
      FIELD mes      LIKE crapadp.nrmeseve
      FIELD vezes    AS INT
      FIELD tpevento like crapedp.tpevento 
      INDEX ch-evemes cdevento mes
      INDEX ch-agemes cdagenci mes.

      DEF BUFFER b-agenda FOR tt-novaagenda.
      DEF temp-table wk-mes 
      FIELD mes LIKE crapadp.nrmeseve.
      /******/

      DEF TEMP-TABLE tt-evento 
      FIELD nrmeseve LIKE crapadp.nrmeseve
      FIELD cdevento LIKE crapadp.cdevento
      FIELD nmevento LIKE crapedp.nmevento      
      FIELD cdagenci LIKE crapadp.cdagenci
      FIELD idstaeve LIKE crapadp.idstaeve
      FIELD auxrowid AS CHAR
      FIELD idinseve AS LOGICAL FORMAT "yes/no".

      /*** Declaração de BOs ***/
      DEF VAR h-b1wpgd0029     AS HANDLE                NO-UNDO.

      DEF TEMP-TABLE cratrap
      FIELD cdagenci LIKE craprap.cdagenci        
      FIELD cdcooper LIKE craprap.cdcooper
      FIELD cdevento LIKE craprap.cdevento
      FIELD cdgruava LIKE craprap.cdgruava
      FIELD cditeava LIKE craprap.cditeava
      FIELD dsobserv AS CHAR
      FIELD dtanoage LIKE craprap.dtanoage
      FIELD idevento LIKE craprap.idevento
      FIELD nrseqeve LIKE craprap.nrseqeve
      FIELD qtavabom LIKE craprap.qtavabom
      FIELD qtavains LIKE craprap.qtavains
      FIELD qtavaoti LIKE craprap.qtavaoti
      FIELD qtavareg LIKE craprap.qtavareg
      FIELD qtavares LIKE craprap.qtavares.
		  			
      DEF TEMP-TABLE  tt-pa
        FIELD cdcooper LIKE crapage.cdcooper
        FIELD cdagenci LIKE crapage.cdagenci
        FIELD nmresage LIKE crapage.nmresage.
      
      DEF BUFFER crabrap FOR craprap.

      ASSIGN aux_selevento = INT(GET-VALUE("aux_selevento")).

      /* Usado FOR EACH para poder utilizar o CONTAINS e WORD-INDEX, alterado para MATCHES */
      FOR EACH gnapses WHERE gnapses.idsessao MATCHES "*" + get-cookie("cookie-usuario-em-uso") + "*" NO-LOCK:
        LEAVE.
      END.

      DEFINE VARIABLE IdentificacaoDaSessao AS CHARACTER FORMAT "x(47)".
      DEFINE VARIABLE aux_lspermis AS CHARACTER.
      DEFINE VARIABLE aux_cdcopope AS INTEGER.
      DEFINE VARIABLE aux_cdoperad AS CHARACTER.
      DEFINE VARIABLE aux_nrseqdig LIKE crapadp.nrseqdig.
			
      RUN PermissaoDeAcesso(INPUT 'wpgd0023', OUTPUT IdentificacaoDaSessao, OUTPUT aux_lspermis).
			
			RUN RodaJavaScript("aguarde();").
      /* Marcar primeiro evento selecionado  */
      IF REQUEST_METHOD = "GET" THEN
        DO: 
          ASSIGN aux_selevento = 0
                 aux_cdcooper = INT(GET-VALUE("aux_cdcooper"))
                 aux_cdoperad = GET-VALUE("aux_cdoperad")
                 aux_cdcopope = INT(GET-VALUE("aux_cdcopope"))
                 aux_idevento = INT(GET-VALUE("aux_idevento")).
        END. 
      
      IF REQUEST_METHOD = "POST" THEN 
	    bloco:  
        DO: 
          ASSIGN aux_cdcooper = INT(GET-VALUE("aux_cdcooper"))
                 aux_cdcopope = INT(GET-VALUE("aux_cdcopope"))
                 aux_cdoperad = GET-VALUE("aux_cdoperad")
                 aux_dtanoage = INT(GET-VALUE("aux_dtanoage")).
       
          IF aux_cdcooper  <> 0 THEN
            DO:
              IF aux_dtanoage <> 0   THEN
                FIND LAST gnpapgd WHERE gnpapgd.idevento = 2
                                    AND gnpapgd.cdcooper = INT(aux_cdcooper)
                                    AND gnpapgd.dtanonov = INT(aux_dtanoage) NO-LOCK NO-ERROR.
              ELSE
                DO:
                  FIND LAST gnpapgd WHERE gnpapgd.idevento = 2
                                      AND gnpapgd.cdcooper = INT(aux_cdcooper) NO-LOCK NO-ERROR.
                  IF AVAIL gnpapgd THEN
                    ASSIGN aux_dtanoage = gnpapgd.dtanonov.
                END.
            END.
            
          IF NOT AVAIL gnpapgd THEN
            DO:
              IF aux_dtanoage <> 0 THEN
                RUN RodaJavaScript("alert('Não existe agenda para o ano (" + STRING(aux_dtanoage) + ") informado!');").
              ELSE 
                DO:
                  RUN RodaJavaScript("alert('Não encontrado parametros da agenda.')").
                  aux_dtanoage = INT(SUBSTRING(STRING(TODAY,'99/99/9999'),7,10)).
                END.
      
              FIND LAST gnpapgd WHERE gnpapgd.idevento = 2
                                  AND gnpapgd.cdcooper = INT(aux_cdcooper) NO-LOCK NO-ERROR.
                
              IF AVAIL gnpapgd THEN
                ASSIGN aux_dtanoage = gnpapgd.dtanonov.
        
            END.   
          ELSE  
            DO:
              ASSIGN aux_dtanoage = gnpapgd.dtanonov.
            END.

		  /* rotina para buscar o registro de parametro correto */
		  FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
							   AND crapagp.cdcooper = gnpapgd.cdcooper
							   AND crapagp.dtanoage = gnpapgd.dtanonov NO-LOCK NO-ERROR.
						 
		  IF AVAIL crapagp THEN 
		    ASSIGN aux_dstextab = STRING(crapagp.idstagen).
		  
		  IF GET-VALUE("mudaevento") = "sim" THEN /* Verificando se o POST foi feito somente para trocar de evento ou de cooperativa */
			LEAVE bloco.
      
		  /* Verificando se o POST foi feito para gerar nova agenda */
		  IF GET-VALUE("gera") = "sim" THEN
			DO: 
			
			  IF CAN-FIND(FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
										  AND crapagp.cdcooper = gnpapgd.cdcooper
										  AND crapagp.dtanoage = gnpapgd.dtanonov) THEN
				DO:
				  IF crapagp.idstagen < 3 AND aux_idevento <> 2 THEN
					DO:
					  RUN RodaJavaScript("alert('Para a geração da agenda, todos os PAs deverão ter seus eventos confirmados. Verifique na tela de ~"Confirmação de Eventos~"')").
					  LEAVE bloco.
					END.
					
				  IF crapagp.idstagen  > 3 THEN
					DO:
					  RUN RodaJavaScript("alert('A geração da agenda já foi efetuada. Esse processo não pode ser refeito.')").
					  LEAVE bloco.
					END.
				END.
			
			  IF (gnpapgd.lsmeseve = ? OR gnpapgd.lsmeseve = "") AND gnpapgd.idevento <> 2 THEN
			DO:          
			  RUN RodaJavaScript("alert('Para a geração da agenda, favor cadastrar os meses para atribuição de eventos. Verifique na tela de ~"Parâmetros das Agendas~"')").
			  LEAVE bloco.              
			END.
          
		  RUN CriaAgenda.
			  
		  IF aux_erro = NO AND RETURN-VALUE <> "NOK" THEN
			DO:
			  FOR EACH  crapagp WHERE crapagp.idevento = gnpapgd.idevento
								  AND crapagp.cdcooper = gnpapgd.cdcooper
								  AND crapagp.dtanoage = gnpapgd.dtanonov EXCLUSIVE-LOCK:
				ASSIGN crapagp.idstagen = 4.  
			  END.
			  
			  ASSIGN aux_dstextab = '4'.
			  
			  RUN RodaJavaScript("alert('A agenda foi gerada com sucesso.Para libera-la aos PAs, clique no botão ~"Liberar Agenda~"')").
			END.
			
		  END.
		ELSE
			DO:
				
         /* Verificando se o POST foi feito para enviar nova agenda */
		IF GET-VALUE("envia") = "sim" THEN
          DO:
            
            IF CAN-FIND(FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
                                        AND crapagp.cdcooper = gnpapgd.cdcooper
                                        AND crapagp.dtanoage = gnpapgd.dtanonov) THEN
              DO:
                IF crapagp.idstagen < 4 THEN /* 4-agenda gerada*/
                  DO:
                    RUN RodaJavaScript("alert('A liberação da agenda só pode ser efetuada após sua geração. Efetue a geração através do botão ~"Gerar Agenda~".')").
                    LEAVE bloco.
                  END.

                /* 5-Enviada aos pacs*/
                IF crapagp.idstagen  > 4 THEN
                  DO: 
                    RUN RodaJavaScript("alert('A liberação da agenda já foi efetuada anteriormente. Todos os eventos da agenda estão disponíveis aos PAs.')").
                    LEAVE bloco.
                  END.
              END.

              RUN EnviaAgenda.

              ASSIGN aux_dsdemail = "".
              
              FOR EACH crapagp WHERE crapagp.idevento = gnpapgd.idevento
                                 AND crapagp.cdcooper = gnpapgd.cdcooper
                                 AND crapagp.dtanoage = gnpapgd.dtanonov EXCLUSIVE-LOCK:

                ASSIGN crapagp.idstagen = 5. 
                /* busca o email dos pacs */
                FIND FIRST crapage WHERE crapage.cdcooper = crapagp.cdcooper
                                     AND crapage.cdagenci = crapagp.cdagenci NO-LOCK NO-ERROR.    

                IF AVAIL crapage AND crapage.dsdemail <> ? THEN
                  IF aux_dsdemail = "" THEN 
                    ASSIGN aux_dsdemail = crapage.dsdemail.
                  ELSE        
                    ASSIGN aux_dsdemail = aux_dsdemail + ";" + crapage.dsdemail.  

              END. /*crapagp*/
              
              /* busca o e-mail de liberação agenda para cooperativa */
              FIND FIRST crapppc WHERE crapppc.cdcooper = gnpapgd.cdcooper NO-LOCK NO-ERROR.    

              IF AVAIL crapppc AND crapppc.dsemllib <> ? THEN
                IF aux_dsdemail = "" THEN 
                  aux_dsdemail =  crapppc.dsemllib.
                ELSE        
                  aux_dsdemail = aux_dsdemail  + ";" + crapppc.dsemllib.             
             
              ASSIGN aux_dstextab = '5'.
        
              ASSIGN aux_dsdemail = REPLACE(aux_dsdemail,";",",")
                     aux_dsconteu = "A agenda do PROGRID para este ano já está liberada. " +                 
                                    "\nConsulte-a através da tela Agenda Anual.".
              
              /* envia email avisando os pacs da liberação da nova agenda*/    
              IF aux_dsdemail <> "" THEN
                DO:

                  RUN sistema/generico/procedures/b1wgen0011.p PERSISTENT SET h-b1wgen0011.

                  IF VALID-HANDLE (h-b1wgen0011) THEN
                    DO:
                      RUN solicita_email_oracle IN h-b1wgen0011(INPUT  INTEGER(gnpapgd.cdcooper)             	  /* par_cdcooper        */
                                                               ,INPUT  "wpgd0023"                                 /* par_cdprogra        */
                                                               ,INPUT  aux_dsdemail                               /* par_des_destino     */
                                                               ,INPUT  "PROGRID - AGENDA LIBERADA" 				  /* par_des_assunto     */
                                                               ,INPUT  aux_dsconteu                               /* par_des_corpo       */
                                                               ,INPUT  ""                                         /* par_des_anexo       */
                                                               ,INPUT  "N"                                        /* par_flg_remove_anex */
                                                               ,INPUT  "N"                                        /* par_flg_remete_coop */
                                                               ,INPUT  "Sistema de Relacionamento"                /* par_des_nome_reply  */
                                                               ,INPUT  "gc.oqs@ailos.coop.br"                    /* par_des_email_reply */
                                                               ,INPUT  "N"                                        /* par_flg_log_batch   */
                                                               ,INPUT  "N"                                        /* par_flg_enviar      */
                                                               ,OUTPUT aux_dscritic).                             /* par_des_erro        */
                                   
                    DELETE PROCEDURE h-b1wgen0011.
                  END.
        
				END. /* aux_dsdemail */
                
              /*fim da rotina de envio de email*/
              RUN RodaJavaScript("alert('A agenda foi liberada com sucesso.')").
          END. /* GET-VALUE("envia") */
        ELSE
		  DO:
            
			  ASSIGN aux_pac     = GET-VALUE("auxpac")
					 aux_mes     = GET-VALUE("auxmes")
					 aux_motivos = GET-VALUE("auxmotivos")
					 aux_evento  = GET-VALUE("auxevento")
					 aux_rowid   = GET-VALUE("auxrowid").
               
              REPEAT aux_i=1 TO NUM-ENTRIES(aux_pac):
                FIND crapadp WHERE ROWID(crapadp) = TO-ROWID(ENTRY(aux_i,aux_rowid)) EXCLUSIVE-LOCK NO-ERROR. /* verifica se o evento já existe na agenda */
                IF AVAIL crapadp THEN
                  DO:
           
                    /* caso esteja marcado para deletar*/
                    IF ENTRY(aux_i,aux_pac) = "X" THEN 
                      DELETE crapadp.
                    ELSE
                      DO:
                        IF crapadp.nrmeseve <> INT(ENTRY(aux_i,aux_mes)) and aux_dstextab > '4' THEN
                          DO:
                            ASSIGN crapadp.idstaeve  = 3. 
                            
                            CREATE craphep.
                            ASSIGN craphep.nrseqdig  = NEXT-VALUE(nrseqhep)
                                   craphep.cdagenci  = crapadp.nrseqdig     
                                   craphep.dshiseve  = "Evento transferido em " + STRING(TODAY,"99/99/9999") + " pelo usuário " + gnapses.cdoperad + " Motivo : " + ENTRY(aux_i,aux_motivos)
                                   craphep.dtmvtolt  = TODAY. 
                            
                            ASSIGN crapadp.dtinieve  = ?
                                   crapadp.dtfineve  = ?
                                   crapadp.dshroeve  = " "
                                   crapadp.dsdiaeve  = " "
                                   crapadp.cdabrido  = 0
                                   crapadp.cdlocali  = 0.   

                            VALIDATE craphep.
                          END.
                        ASSIGN crapadp.idevento = gnpapgd.idevento
                               crapadp.cdcooper = gnpapgd.cdcooper
                               crapadp.dtanoage = gnpapgd.dtanonov
                               crapadp.cdevento = INT(ENTRY(aux_i,aux_evento))
                               crapadp.cdagenci = INT(ENTRY(aux_i,aux_pac))    
                               crapadp.nrmeseve = INT(ENTRY(aux_i,aux_mes)).
                      END.
                  END.  /* IF AVAIL crapadp THEN */
                ELSE /* caso registro nao exista */
                  DO:
					
										/*IF INT(ENTRY(aux_i,aux_pac)) <> 0 THEN
											DO:JMD LIB*/
					
                        /* AJUSTE PARA FORCAR NRSEQDIG CRAPADP */
						Contador: DO aux_contnrseq = 1 TO 5:

							ASSIGN aux_nrseqdig = NEXT-VALUE(nrseqadp).
							
							IF aux_nrseqdig = 0 OR aux_nrseqdig = ? THEN
								DO:
									IF  aux_contnrseq = 5 THEN
										DO:
											ASSIGN aux_msgderro = 'Erro ao gerar agenda, tente novamente.'
												   aux_erro = NO.
										   
											RUN RodaJavaScript("alert('" + aux_msgderro + "')").
											RETURN "NOK".
										END.
									ELSE 
									   DO:
										   PAUSE 1 NO-MESSAGE.				   
									   END.
								END.
							ELSE
								LEAVE Contador.
                        
						END.

						IF aux_nrseqdig = 0 OR aux_nrseqdig = ? THEN
							DO:
								ASSIGN aux_msgderro = 'Erro ao gerar agenda, tente novamente.'
									   aux_erro = NO.
							   
								RUN RodaJavaScript("alert('" + aux_msgderro + "')").
								RETURN "NOK".
							END.														
						/* FIM AJUSTE PARA FORCAR NRSEQDIG CRAPADP */
                        
                        CREATE crapadp.
                        ASSIGN crapadp.nrseqdig  = aux_nrseqdig
                               crapadp.idevento  = gnpapgd.idevento
                               crapadp.cdcooper  = gnpapgd.cdcooper
                               crapadp.dtanoage  = gnpapgd.dtanonov 
                               crapadp.cdevento  = INT(ENTRY(aux_i,aux_evento))
                               crapadp.cdagenci  = INT(ENTRY(aux_i,aux_pac))    
                               crapadp.nrmeseve  = INT(ENTRY(aux_i,aux_mes))
                               crapadp.idstaeve  = 1 /*Agendado */
                               crapadp.cdcopope  = aux_cdcopope
                               crapadp.cdoperad  = aux_cdoperad.

						FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
          								     AND crapagp.cdcooper = gnpapgd.cdcooper
											 AND crapagp.dtanoage = gnpapgd.dtanonov
											 AND crapagp.cdagenci = INT(ENTRY(aux_i,aux_pac)) NO-LOCK NO-ERROR.
							   
                        /* Se a agenda já está liberada, guarda o mes de agendamento inicial do novo evento,
                        e cria o histórico de acréscimo */
                        IF crapagp.idstagen > 4 THEN
                          DO:
							
                            ASSIGN crapadp.nrmesage  = INT(ENTRY(aux_i,aux_mes))
                                   crapadp.idstaeve  = 6.

                            CREATE craphep.
                            ASSIGN craphep.nrseqdig  = NEXT-VALUE(nrseqhep)
                                   craphep.cdagenci  = crapadp.nrseqdig     
                                   craphep.dshiseve  = "Evento acrescido em " + STRING(TODAY,"99/99/9999") + " pelo usuário " + gnapses.cdoperad + " Motivo : " + ENTRY(aux_i,aux_motivos)
                                   craphep.dtmvtolt  = TODAY.

                            VALIDATE craphep.

                            /* Busca itens de avaliação já cadastrados */ 
                            FIND FIRST craprap WHERE craprap.idevento = gnpapgd.idevento
                                                 AND craprap.cdcooper = gnpapgd.cdcooper
                                                 AND craprap.dtanoage = gnpapgd.dtanonov
                                                 AND craprap.cdevento = INT(ENTRY(aux_i,aux_evento)) NO-LOCK NO-ERROR.           

                            IF AVAIL craprap THEN
                              DO:
                                /* Instancia a BO para executar as procedures */  
                                RUN dbo/b1wpgd0029.p PERSISTENT SET h-b1wpgd0029.

                                /* Se BO foi instanciada */  
                                IF VALID-HANDLE(h-b1wpgd0029)  THEN
                                  DO:
                                    ASSIGN aux_msgderro = "".

                                    FOR EACH crabrap WHERE crabrap.idevento = craprap.idevento
                                                       AND crabrap.cdcooper = craprap.cdcooper
                                                       AND crabrap.dtanoage = craprap.dtanoage 
                                                       AND crabrap.cdevento = craprap.cdevento
                                                       AND crabrap.cdagenci = craprap.cdagenci
                                                       AND crabrap.nrseqeve = craprap.nrseqeve EXCLUSIVE-LOCK:
                                           
                                      EMPTY TEMP-TABLE cratrap.

                                      CREATE cratrap.
                                      /* BUFFER-COPY crabrap  EXCEPT cdagenci nrseqeve qtavabom qtavains qtavaoti qtavareg qtavares TO cratrap. */
                                      ASSIGN cratrap.dsobserv = ""
                                             cratrap.cdagenci = INT(ENTRY(aux_i,aux_pac))
                                             cratrap.nrseqeve = crapadp.nrseqdig
                                             cratrap.cdcooper = crabrap.cdcooper
                                             cratrap.cdevento = crabrap.cdevento
                                             cratrap.cdgruava = crabrap.cdgruava
                                             cratrap.cditeava = crabrap.cditeava
                                             cratrap.dtanoage = crabrap.dtanoage
                                             cratrap.idevento = crabrap.idevento.

                                      RUN inclui-registro IN h-b1wpgd0029(INPUT TABLE cratrap, OUTPUT aux_msgderro, OUTPUT aux_nrdrowid).

                                      IF aux_msgderro <> "" THEN
                                        DO:
                                          RUN RodaJavaScript("alert('" + aux_msgderro + "')").
                                          LEAVE.
                                        END.
                                    END. /* FOR EACH crabrap */

                                  END. /*VALID-HANDLE(h-b1wpgd0029)*/ 

                                /* "mata" a instância da BO */  
                                DELETE PROCEDURE h-b1wpgd0029 NO-ERROR.          
                              END. /* AVAIL craprap */
                          END. /* crapagp.idstagen > 4 */
						ELSE
							DO:
														
								FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
																	 AND crapagp.cdcooper = gnpapgd.cdcooper
																	 AND crapagp.dtanoage = gnpapgd.dtanonov
																	 AND crapagp.cdagenci <> INT(ENTRY(aux_i,aux_pac)) 
																	 AND crapagp.idstagen = 5 NO-LOCK NO-ERROR NO-WAIT.
																	 
								IF AVAILABLE crapagp THEN
									DO:
										
										FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
																				 AND crapagp.cdcooper = gnpapgd.cdcooper
																				 AND crapagp.dtanoage = gnpapgd.dtanonov
																				 AND crapagp.cdagenci = INT(ENTRY(aux_i,aux_pac)) EXCLUSIVE-LOCK NO-ERROR NO-WAIT.
											
										IF AVAILABLE crapagp AND crapagp.idstagen < 5 THEN /* 5-Liberado*/
											DO:
												ASSIGN crapagp.idstagen = 5.
											END.																	

									END. /* AVAILABLE crapagp */
							END. /* ELSE  crapagp.idstagen */
                        VALIDATE crapadp.
									/*END. JMD LIB*/ /* INT(ENTRY(aux_i,aux_pac)) <> 0*/
                  END. /* /* caso registro nao exista */ */
			END. /* REPEAT */
		  END. /* ELSE */
		END.
      END. /* REQUEST_METHOD = POST */

      PROCEDURE EnviaAgenda:

        /* limpa a tabela de eventos do progrid no PAC*/
        FOR EACH crapadp WHERE crapadp.idevento = gnpapgd.idevento
                           AND crapadp.cdcooper = gnpapgd.cdcooper
                           AND crapadp.dtanoage = gnpapgd.dtanonov EXCLUSIVE-LOCK:

          IF crapadp.idstaeve = 0 then
            ASSIGN crapadp.idstaeve = 1.

          /* Guarda o mês de agendamento inicial do evento */
          IF crapadp.nrmesage = 0 THEN
            crapadp.nrmesage = crapadp.nrmeseve.                
        END.

      END PROCEDURE.

      PROCEDURE CriaAgenda:

        /* Limpa a tabela de eventos do progrid no PAC*/
        FOR EACH crapadp WHERE crapadp.idevento = gnpapgd.idevento
                           AND crapadp.cdcooper = gnpapgd.cdcooper
                           AND crapadp.dtanoage = gnpapgd.dtanonov EXCLUSIVE-LOCK:
          DELETE crapadp.
        END.

        FOR EACH crapeap WHERE crapeap.idevento = gnpapgd.idevento
                           AND crapeap.cdcooper = gnpapgd.cdcooper
                           AND crapeap.dtanoage = gnpapgd.dtanonov
                           AND crapeap.flgevsel = YES NO-LOCK BREAK BY crapeap.cdagenci BY crapeap.cdevento:
          
          IF crapeap.idevento = 1 THEN
            DO:
              FIND crapage WHERE crapage.cdcooper = crapeap.cdcooper
                             AND crapage.cdagenci = crapeap.cdagenci NO-LOCK NO-ERROR.

              IF NOT AVAIL crapage THEN NEXT.
            END.
          
          FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
                               AND crapagp.cdcooper = gnpapgd.cdcooper
                               AND crapagp.dtanoage = gnpapgd.dtanonov
                               AND crapagp.cdagenci = crapeap.cdagenci
                               AND crapagp.cdagenci = crapagp.cdageagr NO-LOCK NO-ERROR.
                               
          IF NOT AVAIL crapagp THEN NEXT.

          FIND FIRST crapedp WHERE crapedp.cdevento = crapeap.cdevento NO-LOCK NO-ERROR.
          
          FOR EACH crapsde where crapsde.idevento = gnpapgd.idevento
                             and crapsde.cdcooper = gnpapgd.cdcooper
                             and crapsde.dtanoage = gnpapgd.dtanonov
                             and crapsde.cdevento = crapedp.cdevento
                             and crapsde.cdagenci = crapagp.cdagenci NO-LOCK:
						
			/* AJUSTE PARA FORCAR NRSEQDIG CRAPADP */
			Contador: DO aux_contnrseq = 1 TO 5:

				ASSIGN aux_nrseqdig = NEXT-VALUE(nrseqadp).
				
				IF aux_nrseqdig = 0 OR aux_nrseqdig = ? THEN
					DO:
						IF  aux_contnrseq = 5 THEN
							DO:
								ASSIGN aux_msgderro = 'Erro ao gerar agenda, tente novamente.'
									   aux_erro = NO.
							   
								RUN RodaJavaScript("alert('" + aux_msgderro + "')").
								RETURN "NOK".
							END.
						ELSE 
						   DO:
							   PAUSE 1 NO-MESSAGE.				   
						   END.
					END.
				ELSE
					LEAVE Contador.

			END.
			
			IF aux_nrseqdig = 0 OR aux_nrseqdig = ? THEN
				DO:
					ASSIGN aux_msgderro = 'Erro ao gerar agenda, tente novamente.'
						   aux_erro = NO.
				   
					RUN RodaJavaScript("alert('" + aux_msgderro + "')").
					RETURN "NOK".
				END.														
			/* FIM AJUSTE PARA FORCAR NRSEQDIG CRAPADP */
						
            CREATE crapadp.
            ASSIGN crapadp.nrseqdig = aux_nrseqdig
                   crapadp.idevento = gnpapgd.idevento
                   crapadp.cdcooper = gnpapgd.cdcooper
                   crapadp.dtanoage = gnpapgd.dtanonov 
                   crapadp.cdevento = crapsde.cdevento
                   crapadp.cdagenci = crapsde.cdagenci
                   crapadp.idstaeve = 1
                   crapadp.cdcopope = aux_cdcopope
                   crapadp.cdoperad = aux_cdoperad.
            
            IF LENGTH(crapsde.dsdatsug) = 7 THEN
              assign crapadp.nrmeseve  = INT(SUBSTR(STRING(crapsde.dsdatsug),1,2)).
            else
              assign crapadp.nrmeseve  = INT(SUBSTR(STRING(crapsde.dsdatsug),4,2)).
              
            VALIDATE crapadp.
          END.
        END.
		
      END PROCEDURE.
      
      PROCEDURE CriaCratedp:
      
        FOR EACH crapedp WHERE crapedp.idevento = gnpapgd.idevento
                           AND crapedp.cdcooper = gnpapgd.cdcooper
                           AND crapedp.dtanoage = gnpapgd.dtanonov NO-LOCK by crapedp.tpevento :

          CREATE cratedp.
          BUFFER-COPY crapedp TO cratedp.
          
          IF crapedp.tpevento = 2  THEN /* integracao */
            ASSIGN cratedp.tpevento = 999
                   cratedp.flgordem = YES.
        END.
      END PROCEDURE.
      
      PROCEDURE CriaEventosTemp:
        /* guarda os eventos de integracao */
        DEF VAR aux_cdeveint AS CHAR             NO-UNDO.

        FOR EACH cratedp WHERE cratedp.tpevento = 999 NO-LOCK:
          aux_cdeveint = aux_cdeveint + STRING(cratedp.cdevento) + ",".
        END.

        FOR EACH crapadp WHERE crapadp.idevento = gnpapgd.idevento
                           AND crapadp.cdcooper = gnpapgd.cdcooper
                           AND crapadp.dtanoage = gnpapgd.dtanonov NO-LOCK:

          FIND FIRST crapidp WHERE crapidp.idevento = crapadp.idevento
                               AND crapidp.cdcooper = crapadp.cdcooper
                               AND crapidp.dtanoage = crapadp.dtanoage
                               AND crapidp.cdageins = crapadp.cdagenci
                               AND crapidp.cdevento = crapadp.cdevento 
                               AND crapidp.nrseqeve = crapadp.nrseqdig
                               AND (crapidp.idstains = 1 OR /*Pendente*/ 
                                    crapidp.idstains = 2)   /*Confirmado*/  NO-LOCK NO-ERROR.

          CREATE tt-evento.
          ASSIGN tt-evento.nrmeseve = crapadp.nrmeseve
                 tt-evento.cdagenci = crapadp.cdagenci
                 tt-evento.nmevento = (IF crapadp.idevento = 2 THEN 'TODOS' ELSE '')
                 tt-evento.cdevento = crapadp.cdevento
                 tt-evento.idstaeve = crapadp.idstaeve
                 tt-evento.auxrowid = STRING(ROWID(crapadp))
                 tt-evento.idinseve = AVAILABLE crapidp.

          IF crapadp.cdlocali <> 0  AND 
             crapadp.dtinieve <> ?  AND
             crapadp.dtfineve <> ?  AND   
             crapadp.dshroeve <> "" AND
             crapadp.idstaeve <> 2  /*Cancelado*/ THEN  
            ASSIGN tt-evento.idstaeve = 99.

          /* Total de Eventos + Integracoes */
          aux_qttotger = aux_qttotger + 1.

          IF CAN-DO(aux_cdeveint,STRING(crapadp.cdevento)) THEN
            /* Total de Integracoes */
            aux_qttotint = aux_qttotint + 1.

        END. /* FOR EACH */

        /* Total de Eventos */
        ASSIGN aux_qttoteve = aux_qttotger - aux_qttotint
               aux_idevento = gnpapgd.idevento.

      END PROCEDURE.

      PROCEDURE RodaJavaScript:
        {includes/rodajava.i}
      END PROCEDURE.

      FUNCTION NumeroDoMesmoEventoNoMes RETURNS INTEGER 
        (INPUT aux_param_cdcooper AS INT,INPUT aux_param_dtanoage AS INT, INPUT aux_param_cdevento AS INT, INPUT aux_param_mes AS INT):
        DEF VAR aux_conta AS INT INIT 0 NO-UNDO.
        
        FOR EACH b-crapadp WHERE b-crapadp.idevento = gnpapgd.idevento
                             AND b-crapadp.cdcooper = aux_param_cdcooper
                             AND b-crapadp.dtanoage = aux_param_dtanoage
                             AND b-crapadp.cdevento = aux_param_cdevento
                             AND b-crapadp.nrmeseve = aux_param_mes NO-LOCK :
          
          aux_conta = aux_conta + 1.
        END.
        
        IF aux_conta < 2 THEN /* minimo de 2 linhas por evento */
          aux_conta = 2. 
          
        RETURN aux_conta.
      END FUNCTION.

      PROCEDURE PermissaoDeAcesso :
        {includes/wpgd0009.i}
      END PROCEDURE.

      /* left: 37px; top: 3px; */
    </script>
  </head>
  <body style="margin-left: 3px; " onload="mudaEvento(document.form.aux_cdcooper.value);" >
   <script type="text/javascript" src="/cecred/jsbiblio/wz_dragdrop.js"></script></head>

    <div id="Layer1" style="position:absolute; border:0px; width:35px; height:35; z-index:1; left: 25px; top: 2px; visibility: ;"><img src="/cecred/images/icones/ico_fornecedor.gif" width="28" height="32" align="bottom"> </div>
    
    <form action="#." method="POST" name="form" >
      <input type="hidden" name="aux_lspermis" value="`aux_lspermis`">
      <input type="hidden" name="aux_cdcopope" value="`aux_cdcopope`" />
      <input type="hidden" name="aux_cdoperad" value="`aux_cdoperad`" />
      <table  height="360" border="0" align="left" cellpadding="0" cellspacing="0" background="/cecred/images/geral/guia_fundo.gif">
        <tr>
          <td height="20" colspan="5">
            <table width="100%"  border="0" cellspacing="0" cellpadding="0">
              <tr> 
                <td width="11"><img src="/cecred/images/geral/guia_esquerda.gif" width="11" height="21"></td>
                <td width="56"><img src="/cecred/images/geral/spacer.gif" width="10" height="10"></td>
                <td height="20" class="linkGuia">Composição das Agendas</td>
                <td width="80" class="linkGuia" align="right">wpgd0023</td>
                <td width="11" align="right" valign="middle" class="linkGuia"><img src="/cecred/images/geral/guia_direita.gif" width="11" height="21"></td>
              </tr>
            </table>
          </td>
        </tr>
        <tr valign="top" bgcolor="#FFFFFF"> 
          <td colspan="5"> 
            <table id="tbprimeira" width="100%" height="80%" align="left" cellpadding="0" cellspacing="1" bgcolor="#999999" >
              <tr> 
                <td align="left" valign="top" bgcolor="#FFFFFF">    
                  <fieldset style="border: 2px solid #6B7984; margin-left: 2px;margin-right: 2px;padding-top: 0.35em;padding-bottom: 0.625em;padding-left: 0.75em;padding-right: 0.75em;">
                  <legend style="fotn-color:black;">FILTROS</legend>
                    <table id="tbanobase" width="100%" cellpadding="0" cellspacing="0" border="0" >
                      <tr> 
                        <td height="23" align="left" valign="middle" class="NomeCampo">Cooperativa:
                          <select name="aux_cdcooper" class="Campo" id="cdcooper" onchange="document.form.aux_dtanoage.value=''; buscaEvento(this.value)" class="LinhaTabelaSelect">
                            <script language="SpeedScript">
                              /* Carregamento de COOPERATIVAS conforme includes/wpgd0098.i */
                              
                              FIND crapope WHERE crapope.cdcooper = gnapses.cdcooper
                                             AND crapope.cdoperad = gnapses.cdoperad NO-LOCK NO-ERROR.

                              FOR EACH crapcop NO-LOCK BY  crapcop.nmrescop:
                                /* Implementa a segurança por Cooperativa */
                                IF gnapses.nvoperad <> 0 AND
                                   gnapses.cdcooper <> crapcop.cdcooper AND
                                   (AVAIL crapope AND crapope.cddepart <> 20) THEN    /* "TI" */ 
                                  NEXT.
                                  
                                IF aux_cdcooper = crapcop.cdcooper THEN
                                  aux_selected = "SELECTED".
                                ELSE
                                aux_selected = "".
                            </script>
                            <OPTION VALUE="`crapcop.cdcooper`" class="LinhaTabelaSelect" `aux_selected` >`CAPS(crapcop.nmrescop)`</OPTION>
                            <script language="SpeedScript">
                              END.

                              /* Se um evento foi selecionado, carrega somente os PAC que possuem esse evento */
                              IF aux_selevento <> 0 THEN
                                DO:
                                  FOR EACH crapeap WHERE crapeap.idevento = gnpapgd.idevento
                                                     AND crapeap.cdcooper = gnpapgd.cdcooper
                                                     AND crapeap.dtanoage = gnpapgd.dtanonov
                                                     AND crapeap.cdevento = aux_selevento
                                                     AND crapeap.flgevsel = YES NO-LOCK:

                                    /* Visao somente do pac do usuário */
                                    IF (gnapses.nvoperad = 1   OR
                                       gnapses.nvoperad = 2)  AND
                                       gnapses.cdagenci <> crapeap.cdagenci   THEN
                                      NEXT.
                                           
                                    aux_nmresage23 = "".
                                    FOR EACH crapagp WHERE crapagp.idevento = crapeap.idevento
                                                       AND crapagp.cdcooper = crapeap.cdcooper
                                                       AND crapagp.dtanoage = crapeap.dtanoage
                                                       AND crapagp.cdageagr = crapeap.cdagenci NO-LOCK,
                                      FIRST crapage WHERE crapage.cdcooper = crapagp.cdcooper
                                                      AND crapage.cdagenci = crapagp.cdagenci NO-LOCK
                                                       BY crapage.nmresage:

                                      IF   crapagp.cdagenci = crapagp.cdageagr   THEN
                                        aux_nmresage23 = crapage.nmresage + "/" + aux_nmresage23.
                                      ELSE
                                        aux_nmresage23 = aux_nmresage23 + crapage.nmresage + "/".
										
									  
                                    END.
                                                                                                                                                                     
                                    /* Tira a ultima "/" */
                                    aux_nmresage23 = SUBSTRING(aux_nmresage23,1,LENGTH(aux_nmresage23) - 1).
                                    
                                    CREATE tt-pa.
                                    ASSIGN tt-pa.cdcooper = crapeap.cdcooper
                                           tt-pa.cdagenci = crapeap.cdagenci
                                           tt-pa.nmresage = LC( string(aux_nmresage23,"x(30)")). 
                                                                                            
                                  END. /* FOR EACH crapeap */
                                  
                                  FOR EACH tt-pa NO-LOCK BY tt-pa.nmresage:
                                    IF vetorpac <> ""  THEN
                                      vetorpac = vetorpac + ",".
                                    
                                    vetorpac = vetorpac + "~{cdcooper:'" + TRIM(STRING(tt-pa.cdcooper)) 
                                                        + "',cdagenci:'" + TRIM(STRING(tt-pa.cdagenci))
                                                        + "',nmresage:'" + LC(tt-pa.nmresage) + "'~}".
                                                        
                                  END.
                                  
                                END. /* Fim de evento selecionado */
                              ELSE
                                DO:
                                  { includes/wpgd0096.i gnpapgd.dtanonov }
                                  /* coloca os PAs em minusculo */
                                  vetorpac = LC(vetorpac).                  
                                END. 
                                
                              IF aux_selevento = 0 THEN
                                DO:
                                  RUN RodaJavaScript("var maux_acdagenci = new Array(" + aux_acdagenci +  ");").
                                  RUN RodaJavaScript("var maux_acdevento = new Array(" + aux_acdevento +  ");").
                                END.
                              
                              ASSIGN aux_corfundo = "white".
                            </script>
                          </select>
                        </td>
                        <td height="23" align="left" valign="middle" class="NomeCampo">
                          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eventos:
                          <select name="aux_selevento" class="Campo" id="cdevento" onchange="buscaEvento(this.value)">
                          <script language="SpeedScript">
                              RUN RodaJavaScript("aguarde()").
                              RUN CriaCratedp.
                              RUN CriaEventosTemp.
                              RUN RodaJavaScript("hideMsgAguardo()").
                              FOR EACH cratedp WHERE cratedp.idevento = gnpapgd.idevento
                                                 AND cratedp.cdcooper = gnpapgd.cdcooper
                                                 AND cratedp.dtanoage = gnpapgd.dtanonov 
                                                 AND cratedp.tpevento <> 10
                                                 AND cratedp.tpevento <> 11 NO-LOCK
                                                  BY cratedp.flgordem
                                                  BY cratedp.nmevento:
                                IF cratedp.tpevento <> 2 AND cratedp.tpevento <> 10 THEN
                                  DO:  /* nao for integracao de novos associados e eventos EAD */
                                    FIND FIRST crapeap WHERE crapeap.idevento = cratedp.idevento
                                                         AND crapeap.cdcooper = cratedp.cdcooper
                                                         AND crapeap.dtanoage = cratedp.dtanoage
                                                         AND crapeap.cdevento = cratedp.cdevento
                                                         AND crapeap.flgevsel = yes NO-LOCK NO-ERROR.
                                  
                                    IF NOT AVAIL crapeap THEN
                                      NEXT.
                                  END.
                                  
                              IF aux_selevento = cratedp.cdevento THEN
                                assign aux_selected = "SELECTED".																					      
                              ELSE
                                assign aux_selected = "".																				          
                            </script>
                            <option value="`cratedp.cdevento`" `aux_selected` tpevento="`cratedp.tpevento`">`CAPS(cratedp.nmevento)`</option>
                            <script language="SpeedScript">						
                              END.             
                            </script>               							              
                          </select>                          
                        </td>
                        <td height="23" align="left" valign="middle" colspan="2" class="NomeCampo">Ano Base:
                          <input type="text" name="aux_dtanoage" size="4" class="Campo" onChange="aguarde(); document.form.submit();" value="`aux_dtanoage`">						 
						  
                        </td>
                      </tr>
                    </table>
                  </fieldset>
      
                  <fieldset style="border: 2px solid #6B7984; margin-left: 2px;margin-right: 2px;padding-top: 0.35em;padding-bottom: 0.625em;padding-left: 0.75em;padding-right: 0.75em;">
                  <legend style="fotn-color:black;">INCLUIR EVENTO</legend> 
                    <table>
                      <tr>
                        <td width="250" height="23" align="left" valign="middle" class="NomeCampo">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PAs:
                        <select name="aux_cdagenci" class="Campo" id="cdagenci" onchange="mudaTitulo(this.options[this.selectedIndex].innerText)"></select>
                        </td>
                        <td class="NomeCampo" width="100">PA para Inclusão:</td>
                        <td nowrap id="tdpac" width="60" class="LinhaTabelaSelect" ><div STYLE="width:'55px';BACKGROUND-COLOR:'`aux_corfundo`';" class="infparcela"  id="novo" nowrap>&nbsp;</div></td>
                      </tr>
                    </table> <!-- tbcabec --> 
                  </fieldset>
    
                  <fieldset style="border: 2px solid #6B7984; margin-left: 2px;margin-right: 2px;padding-top: 0.35em;padding-bottom: 0.625em;padding-left: 0.75em;padding-right: 0.75em;">
                  <legend style="fotn-color:black;">TOTALIZADORES</legend>
                    <table>
                      <tr height="22">                          
                        <td align="center" valign="middle" class="NomeCampo" width="33%">
                          Total de Eventos:&nbsp;&nbsp;
                          <input type="text" name="aux_qttoteve" id="aux_qttoteve" size="4" readOnly="true" value="`aux_qttoteve`">
                        </td>
                        <script language="SpeedScript">
                          IF aux_idevento = 1 THEN
                            DO:
                        </script>
                          <td align="center" valign="middle" class="NomeCampo" width="33%">
                            Total de Integrações:&nbsp;&nbsp;
                            <input type="text" name="aux_qttotint" id="aux_qttotint" size="4" readOnly="true" value="`aux_qttotint`">
                          </td>                                
                          <td align="center" valign="middle" class="NomeCampo" width="33%">
                            Total Geral:&nbsp;&nbsp;
                            <input type="text" name="aux_qttotger" id="aux_qttotger" size="4" readOnly="true" value="`aux_qttotger`">
                          </td>
                        <script language="SpeedScript">
                          END.
                        </script>
                      </tr>
                    </table>
                  </fieldset>
                </td>
              </tr>
              <tr>
                <td align="left" valign="top" bgcolor="#FFFFFF">              
                  <table class="dataTable" cellpadding="0" cellspacing="0">
                    <tr class="dataTableRow">
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabevento">
                        <div STYLE="width:'120px'"><font color="#000000">Eventos</font></div>
                      </td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabjan"><div STYLE="width:'55px'"><font color="#000000">Janeiro</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabfev"><div STYLE="width:'55px'"><font color="#000000">Fevereiro</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabmar"><div STYLE="width:'55px'"><font color="#000000">Março</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cababr"><div STYLE="width:'55px'"><font color="#000000">Abril</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabmai"><div STYLE="width:'55px'"><font color="#000000">Maio</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabjun"><div STYLE="width:'55px'"><font color="#000000">Junho</font></div></td>                
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabjul"><div STYLE="width:'55px'"><font color="#000000">Julho</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabago"><div STYLE="width:'55px'"><font color="#000000">Agosto</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabset"><div STYLE="width:'55px'"><font color="#000000">Setembro</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabout"><div STYLE="width:'55px'"><font color="#000000">Outubro</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabnov"><div STYLE="width:'55px'"><font color="#000000">Novembro</font></div></td>
                      <td  height="26" nowrap background="/cecred/images/menu/fnd_title.jpg" class="dataTableHeader" id="cabdez"><div STYLE="width:'55px'"><font color="#000000">Dezembro</font></div></td>
                      <td width="3%" height="26">&nbsp;</td>
                    </tr>
                  </table>
                </td>  
              </tr> 
              <tr>
                <td align="left" valign="top" bgcolor="#FFFFFF" >              
                  <table class="dataTable" id="selecao" cellpadding="0" cellspacing="0" border="0"> 
                    <script language="SpeedScript">                                                 
                      FOR EACH cratedp WHERE cratedp.idevento  = gnpapgd.idevento
                                         AND cratedp.cdcooper  = gnpapgd.cdcooper
                                         AND cratedp.dtanoage  = gnpapgd.dtanonov NO-LOCK
                                          BY cratedp.flgordem
                                          BY cratedp.nmevento:

                        IF aux_selevento <> 0 THEN
                          IF aux_selevento <> cratedp.cdevento THEN
                            NEXT.                                                        
                          
                        FIND FIRST crapeap WHERE crapeap.idevento = cratedp.idevento
                                             AND crapeap.cdcooper = cratedp.cdcooper
                                             AND crapeap.dtanoage = cratedp.dtanoage
                                             AND crapeap.cdevento = cratedp.cdevento
                                             AND crapeap.flgevsel = yes NO-LOCK NO-ERROR.
                        
                        ASSIGN aux_mescont = aux_mesini
                               aux_maxlin = 2.
                      
                        DO WHILE aux_mescont <= aux_mesmax. /* numero de linhas do evento */
                          aux_mesaux = NumeroDoMesmoEventoNoMes(INPUT cratedp.cdcooper,INPUT cratedp.dtanoage, INPUT cratedp.cdevento, INPUT aux_mescont).
                          IF aux_maxlin < aux_mesaux THEN
                            ASSIGN aux_maxlin = aux_mesaux.
                                   aux_mescont = aux_mescont + 1.
                        END. /* fim numero de linhas do evento */

                        IF NOT AVAIL crapeap THEN
                          NEXT.

                        IF aux_zebra = "" THEN
                          ASSIGN aux_zebra = "2".
                        ELSE
                          ASSIGN aux_zebra = "".
                    </script>    
                    <tr class="dataTableRow`aux_zebra`">
                      <td rowspan="`aux_maxlin`" id="ev`cratedp.cdevento`" nowrap class="LinhaTabelaSelect`aux_zebra`" width="120px"><font size="1">`CAPS(cratedp.nmevento)`</font><br><a href="#."onclick='novaLinha(document.form.ultimadiv.value,`aux_posicaovetor`,"`cratedp.cdevento`",document.form.ultimalinha.value,"`aux_zebra`");'>nova linha</a></td>       
                        <script language="SpeedScript">
                          aux_linha = 0.
                          DO WHILE aux_linha < aux_maxlin.
                            ASSIGN aux_contador = aux_contador + 1
                                   aux_linha    = aux_linha + 1.
                            IF aux_prievento = "" THEN
                              DO:
                                ASSIGN aux_prievento = STRING(aux_linha)     + aux_meses[3] + STRING(cratedp.cdevento)
                                aux_segevento = STRING(aux_linha)     + aux_meses[4] + STRING(cratedp.cdevento)
                                aux_abaevento = STRING(aux_linha + 1) + aux_meses[4] + STRING(cratedp.cdevento).
                              END.
                              
                            aux_mescont = aux_mesini.
                            
                            DO WHILE aux_mescont <= aux_mesmax.
                              ASSIGN aux_nmresage23 = ""
                                     aux_cdagenci   = 0
                                     aux_ttrowid    = "".
                                     
                              FIND FIRST tt-evento WHERE tt-evento.cdevento = cratedp.cdevento
                                                     AND tt-evento.nrmeseve = aux_mescont NO-ERROR.
                              
                              IF AVAIL tt-evento THEN
                                DO:
                                  ASSIGN aux_cdagenci = tt-evento.cdagenci.
                                  FIND FIRST crapage WHERE crapage.cdcooper = gnpapgd.cdcooper
                                                       AND crapage.cdagenci = tt-evento.cdagenci NO-LOCK NO-ERROR.
                                  
                                  IF AVAIL crapage THEN
                                    DO:
                                      ASSIGN aux_nmresage23 = crapage.nmresage.
                                      FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento 
                                                           AND crapagp.cdcooper = gnpapgd.cdcooper
                                                           AND crapagp.dtanoage = gnpapgd.dtanonov
                                                           AND crapagp.cdageagr = crapage.cdagenci
                                                           AND crapagp.cdagenci <> crapage.cdagenci NO-LOCK NO-ERROR.
                                      
                                      IF AVAIL crapagp THEN
                                        DO:
										
                                          FIND FIRST b-crapage WHERE b-crapage.cdcooper = gnpapgd.cdcooper
                                                                 AND b-crapage.cdagenci  = crapagp.cdagenci NO-LOCK NO-ERROR.
                                          
                                          IF AVAIL b-crapage THEN 
                                            ASSIGN aux_nmresage23 = crapage.nmresage + "/" + b-crapage.nmresage.
                                        END.
                                    END.
                                  ELSE
                                    ASSIGN aux_nmresage23 = tt-evento.nmevento.
                                    
                                  IF aux_evts = "" THEN
                                    ASSIGN aux_evts = '"nome'  + STRING(aux_contador) + '"'.
                                  ELSE
                                    aux_evts = aux_evts  + ',"nome'  + STRING(aux_contador) + '"'.

                                  aux_ttrowid = tt-evento.auxrowid.
                                  CASE tt-evento.idstaeve :
                                         WHEN 0  THEN aux_corfundo = '#FFFF99'.
                                         WHEN 1  THEN aux_corfundo = '#FFFF99'.
                                         WHEN 2  THEN aux_corfundo = 'tomato'.
                                         WHEN 3  THEN aux_corfundo = '#FFFF99'.
                                         WHEN 4  THEN aux_corfundo = '#FFFF99'.
                                         WHEN 5  THEN aux_corfundo = '#FFFF99'.                                                                                                                                                                                                      
                                         WHEN 6  THEN aux_corfundo = '#FFFF99'.
                                    WHEN 99 THEN aux_corfundo = '#66CC66'. /* inventado*/
                                  END CASE.

                                  aux_idinseve = STRING(tt-evento.idinseve).
                                                                                      
                                  DELETE tt-evento.
                                END.
                              
                               /* rotina para buscar o registro de parametro correto */
                                FIND FIRST crapagp WHERE crapagp.idevento = gnpapgd.idevento
                                         AND crapagp.cdcooper = gnpapgd.cdcooper
                                         AND crapagp.dtanoage = gnpapgd.dtanonov NO-LOCK NO-ERROR.
                                     
                              IF AVAIL crapagp THEN 
                                ASSIGN aux_dstextab = STRING(crapagp.idstagen).	
								
                              IF aux_nmresage23 = "" THEN
                                IF aux_zebra = "" THEN
                                  ASSIGN aux_corfundo = "white".
                                ELSE
                                  ASSIGN aux_corfundo = "#e4e6dd".

                              RUN RodaJavaScript("mesEvento.push(~{mo:'',bg:'" + aux_corfundo + "',a:'n',m:" + STRING(aux_mescont) + ",e:" + STRING(cratedp.cdevento) + ",x:0,y:0,p:'" + STRING(aux_cdagenci) + "',td:'" + STRING(aux_linha) + aux_meses[aux_mescont] + STRING(cratedp.cdevento) + "',rw:'" + aux_ttrowid + "',ix:'" + STRING(aux_linha) + "',ev:'nome" + STRING(aux_contador) + "'~});").                                                                  
                          </script>      
                        <td nowrap class="LinhaTabelaSelect`aux_zebra`" id="`STRING(aux_linha) + aux_meses[aux_mescont] + STRING(cratedp.cdevento)`">
                          <input type="hidden" name="aux_idstagen" size="1" class="Campo" value="`aux_dstextab`">
                          <div STYLE="width:'55px'; BACKGROUND-COLOR:'`aux_corfundo`'; cursor:default" class="infparcela`aux_zebra`" id="nome`aux_contador`" idstagen="`aux_dstextab`" idinseve="`aux_idinseve`" registro="`aux_ttrowid`" mes="`STRING(aux_mescont)`" nowrap ondblclick="EdEvento(this.registro,this.mes,`aux_dstextab`)" title="`LC(TRIM(STRING(aux_nmresage23)))`">`LC(TRIM(STRING(aux_nmresage23,"x(8)")))`</div>
                        </td>
                        <script language="SpeedScript">                                                        
                            ASSIGN aux_contador = aux_contador + 1
                                   aux_mescont = aux_mescont + 1.
                          END. /* do meses */
                        </script>            
                      </tr>
                    <script language="SpeedScript">                                                        
                        END. 
                          
                        i-poseventos = ((i-poseventos + aux_maxlin)).
                        
                        IF c-poseventos = "" THEN
                          ASSIGN c-poseventos = STRING(i-poseventos).
                        ELSE
                          ASSIGN c-poseventos = c-poseventos + "," + STRING(i-poseventos).

                        aux_posicaovetor = aux_posicaovetor + 1.
                        /* RANGHETTI */
                        leave.
                      END. /*fim cratedp */
                      
                      IF aux_evts = "" THEN
                        aux_evts = '"novo"'.
                      ELSE
                        aux_evts = aux_evts + ',"novo"'.

                      RUN RodaJavaScript("SET_DHTML(CURSOR_HAND," + aux_evts + ");").         
                      RUN RodaJavaScript("hideMsgAguardo()").
                    </script>        
                  </table>          
                </td>
              </tr>
              <tr>
                <td valign="bottom" align="center" bgcolor="#FFFFFF">
                  <br>
                  <center>                                   
                    <img src="/cecred/images/botoes/btn_salvar.gif" onClick="salvar();" style="cursor: hand; ">
                    <img src="/cecred/images/botoes/btn_gerar_agenda.gif" onClick="gerar();" style="cursor: hand; ">
                    <img src="/cecred/images/botoes/btn_liberar_agenda.gif" onClick="enviar();" style="cursor: hand; ">
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    
      <input type="hidden" name="aux_dsendurl" value="`AppURL`">
      <input type="hidden" name="ultimadiv" value="`aux_contador + 1`">
      <input type="hidden" name="ultimalinha" value="`aux_linha + 1`">
      <input type="hidden" name="novopac" value="novo">
      <input type="hidden" name="auxpac" value="">
      <input type="hidden" name="auxmes" value="">
      <input type="hidden" name="auxmotivos" value="">
      <input type="hidden" name="auxevento" value="">
      <input type="hidden" name="auxrowid" value="">
      <input type="hidden" name="mudaevento" value="">
      <input type="hidden" name="gera" value="">
      <input type="hidden" name="envia" value="">
      <input type="hidden" name="auxdstextab" value="`aux_dstextab`">

    </form>
    
    <script language="JavaScript">
      var tdev='';tdp='';tdx=0;tdy=0;tdbg='';tdrw='';tde=0;tdm=0;
      // evento chamado ao clicar na div para arrastar 
      function eventoClicado(){ 
        tdev='';tdp='';tdx=0;tdy=0;tdbg='';tdrw='';tde=0;
        for (i=0;i<mesEvento.length;i++){
          if (dd.obj.name == mesEvento[i].ev) {         
            tdev = mesEvento[i].ev;
            tdp  = mesEvento[i].p;
            tdy  = mesEvento[i].y;
            tdx  = mesEvento[i].x;
            tdbg = mesEvento[i].bg;
            tdrw = mesEvento[i].rw;
            tde  = mesEvento[i].e;
            tdm  = mesEvento[i].m;
            if (tdev=='novo') {
              tdp  = document.form.cdagenci.value;
            }
            mesEvento[i].a='s';
            break;
          }
        }
      }
      
      // evento chamdo após a div ser arrastada
      function eventoDropado(){
      
        var posicionou=false; // flag indicando se jah achou onde a div deve ser posicionada
        
        ehdd = false; // flag indicando que a div é movel
        ehexclusao = false; // flag indicando se é uma exclusao de evento
        eheventodopac = false; // flag indicando se o pac esta relacionado com o evento (crapeap)

        if (((dd.obj.x >= findPosX(document.all['tdpac']) &&
          dd.obj.x <= (findPosX(document.all['tdpac']) + parseInt(vXD) ))) &&
          ((dd.obj.y >= findPosY(document.all['tdpac']) &&
          dd.obj.y <= (findPosY(document.all['tdpac']) + parseInt(vXD) )))) // se foi posicionado dentro da lixeira      
          {  
            ehexclusao=true;
          }

        for (i=0;i<mesEvento.length;i++){
          // despreza o evento excluido e nao deixa mudar de posicao
          if (document.all[mesEvento[i].ev].style.backgroundColor=='#000000'){
            break;
          }
          
         if (((dd.obj.x >= findPosX(document.all[mesEvento[i].td]) &&
              dd.obj.x <= (findPosX(document.all[mesEvento[i].td]) + parseInt(vXD)))) &&
              ((dd.obj.y >= findPosY(document.all[mesEvento[i].td]) &&
              dd.obj.y <= (findPosY(document.all[mesEvento[i].td]) + parseInt(vYD))))){ // se foi posicionado dentro de uma celula valida                        
              
              if ((document.all[mesEvento[i].ev].innerText != '') /* && (mesEvento[i].ev != 'novo')*/  ){ // regra para nao sobrepor eventos
                break;
              }     
              
              if ((document.form.aux_selevento.value==0) &&
                  (mesEvento[i].ev!='novo')) { // ao mostrar todos os eventos, validar se evento esta relacionado ao pac
                eheventodopac = false;
                if (maux_acdagenci) {
                  for (k=0;k<maux_acdagenci.length;k++) {
                    if (maux_acdagenci[k] == tdp) {
                      if (maux_acdevento[k] == mesEvento[i].e) {
                        eheventodopac = true;
                      }
                    }
                  }
                  if (eheventodopac==false){
                    alert("PA não está relacionado com esse evento.");break;
                  }
                }
              }
              
              if (dd.obj.name == 'novo') {           
                mesEvento[i].p  = document.form.cdagenci.value;
                document.all[mesEvento[i].ev].innerText = document.all[dd.obj.name].innerText.substr(0,9);
                
				//Adicionado valores para centralizar a posição do pac ao voltar (Vanessa)
				dd.obj.moveTo(parseInt(findPosX(document.all['tdpac']))+5,parseInt(findPosY(document.all['tdpac']))+7);
                
				for (j=0;j<dd.elements.length;j++) {
                  if (mesEvento[i].ev==dd.elements[j].name){
                    ehdd=true;break;
                  }
                }
                if (ehdd==false){
                  ADD_DHTML(mesEvento[i].ev+CURSOR_HAND);
                }
              }else{
                // pede confirmacao para transferir um evento com pré-inscritos
                if((document.all[tdev].idinseve=='yes')&&
                (!confirm('Este evento possui pré-inscritos, deseja continuar?')))
                break;

                //dd.obj.moveTo(parseInt(mesEvento[i].x),parseInt(mesEvento[i].y));
                if (document.all[tdev].id !=document.all[mesEvento[i].ev].id){ // evitar apagar o nome do evento
                  document.all[mesEvento[i].ev].innerText = document.all[dd.obj.name].innerText.substr(0,9); // abreviar para 9 letras o nome da agencia
                  document.all[tdev].innerText = ''; // limpar o nome na div onde estava o pac

                  // deixar a cor de fundo da div onde estava o pac com a cor da div posicionada
                  document.all[tdev].style.backgroundColor = document.all[mesEvento[i].ev].style.backgroundColor;   

                  document.all[mesEvento[i].ev].style.backgroundColor = tdbg; 
                  document.all[mesEvento[i].ev].title = document.all[tdev].title; 
                  document.all[mesEvento[i].ev].idinseve = document.all[tdev].idinseve;
                  document.all[tdev].idinseve='no';

                  document.all[tdev].title = ''; // limpar o title na div onde estava o pac
                  mesEvento[i].bg = tdbg;
                  mesEvento[i].p  = tdp;
                  document.all[mesEvento[i].ev].registro = tdrw; 
                  mesEvento[i].rw = tdrw;
                  
                  if ((mesEvento[i].m != tdm) &&
                  (mesEvento[i].bg != 'white')){
                    mesEvento[i].mo = 'X';
                  }

                  for (j=0;j<dd.elements.length;j++) {
                    if (mesEvento[i].ev==dd.elements[j].name){
                      ehdd=true;break;
                    }
                  }
                  
                  if(ehdd==false){
                    ADD_DHTML(mesEvento[i].ev+CURSOR_HAND);
                  }
                  
                  if (mesEvento[i].m != tdm){
                    document.all[mesEvento[i].ev].style.backgroundColor = '#FFFF99';
                  }
                }                
                dd.obj.moveTo(parseInt(tdx),parseInt(tdy));
              }
              mesEvento[i].a='s';
              posicionou=true;                        
            }

            if (ehexclusao==true) {
              if (mesEvento[i].ev==dd.obj.name){
                mesEvento[i].p  = 'X';
                ehexclusao=false;
              }
            }       
            
           if ((posicionou==true)&&(ehexclusao==false)){
              break;
            }
          }

        /*if (posicionou==false){
          if (dd.obj.name=="novo"){
            dd.obj.moveTo(parseInt(findPosX(document.all['tdpac'])),parseInt(findPosY(document.all['tdpac'])));
          }else{
            dd.obj.moveTo(parseInt(tdx),parseInt(tdy));
          }
        } */
      }
      
      var mpac = new Array();
      mpac = [`vetorpac`];
      
      var poseventos = new Array();
      poseventos = [`c-poseventos`];
      mesEvento.push({mo:'',m:0,e:0,x:0,y:0,p:'0',td:'tdpac',ix:0,ev:'novo'});

      MostraPACs();

      function salvar(){
        var vaux = document.form.aux_lspermis.value;  
        if (vaux.substring(1,2) == 'A'){                         
          var vaux = document.form.aux_lspermis.value; 
          if ((vaux.substring(1,2) == 'A')) { 
            for (i=0;i<dd.elements.length;i++) {
              for (j=0;j<mesEvento.length;j++) {
                if ((mesEvento[j].ev==dd.elements[i].name) &&
                  (mesEvento[j].ev != 'novo') &&
                  (mesEvento[j].a == 's')
                  ){
                    if ((document.all[mesEvento[j].ev].innerText=='')
                      &&(mesEvento[j].p!='X')){ // condicao para nao enviar movimentos dos PAC
                      continue;
                    }

                    mEventos.push(mesEvento[j].e);
                    mPacs.push(mesEvento[j].p);
                    mMes.push(mesEvento[j].m);

                    if ((mesEvento[j].mo == 'X') &&
                    (document.form.auxdstextab.value == '5')){

                    if (mesEvento[j].mo=prompt('Motivo da Transferência do Evento no PA: ' + document.all[mesEvento[j].ev].innerText.toUpperCase(),'')) {}else{mesEvento[j].mo='Não informado.'}

                    }

                    if ((mesEvento[j].bg == 'white') &&
                    (document.form.auxdstextab.value == '5')){

                    if (mesEvento[j].mo=prompt('Motivo do Acréscimo do Evento no PA: ' + document.all[mesEvento[j].ev].innerText.toUpperCase(),'')) {}else{mesEvento[j].mo='Não informado.'}
                    }

                    if ((mesEvento[j].bg == '#e4e6dd') &&
                        (document.form.auxdstextab.value == '5')){
                      if (mesEvento[j].mo=prompt('Motivo do Acréscimo do Evento no PA: ' + document.all[mesEvento[j].ev].innerText.toUpperCase(),'')) {}else{mesEvento[j].mo='Não informado.'}
                    }
                    mMotivos.push(mesEvento[j].mo);
                    mRowids.push(mesEvento[j].rw);
                    break;
                  }        
              }                            
            }
          }
        }else{ 
          alert('Desculpe, mas você não tem permissão para executar esta função.'); 
          return false;
        }

        document.form.auxpac.value=mPacs;
        document.form.auxmes.value=mMes;
        document.form.auxmotivos.value=mMotivos;
        document.form.auxevento.value=mEventos;
        document.form.auxrowid.value=mRowids;
        aguarde();   
        document.form.submit();
      }
      
      function mudaEvento(){
        var dtanoage = document.form.aux_dtanoage.value;
      
        if(dtanoage == 0){
          buscaEvento();
        }
      }
      
      function buscaEvento(){
        var dtanoage = document.form.aux_dtanoage.value;
        document.form.mudaevento.value="sim";
        aguarde();
        document.form.submit();
      }
      
      function gerar(){
        var vaux = document.form.aux_lspermis.value; 
        if (vaux.substring(1,2) == 'A'){                         
          document.form.gera.value="sim";
          aguarde();
          document.form.submit();
        }else{ 
          alert('Desculpe, mas você não tem permissão para executar esta função.'); 
          return false;
        }
      }

      function enviar(){
        var vaux = document.form.aux_lspermis.value; 
        if ((vaux.substring(1,2) == 'A')){
          document.form.envia.value="sim";
          aguarde();
          document.form.submit();
        }else{ 
          alert('Desculpe, mas você não tem permissão para executar esta função.'); 
          return false;
        }
      }

      function EdEvento(rowid,mes,idstagen ){
        if (rowid=='') {
          alert("Evento não salvo.");
        }else{ 
          VarURL = document.form.aux_dsendurl.value  + '/wpgd0023a.htm?LinkRowid=' + rowid + '&mes=' + mes +'&aux_dtanoage=' + document.form.aux_dtanoage.value + '&aux_cdevento=' + document.form.aux_selevento.value + '&aux_cdcopope=' + document.form.aux_cdcopope.value + '&aux_cdoperad=' + document.form.aux_cdoperad.value + '&aux_cdcooper=' + document.form.aux_cdcooper.value + '&aux_idstagen=' + idstagen;
          window.open(VarURL,'','toolbar=no,location=no,diretories=no,status=yes,menubar=no,scrollbars=yes,resizable=yes,width=620,height=490,top=10,left=10');
        } 
      }
          
      function mudaCorDiv(rowid,cor){

        var contador=0;
        var pula=0;
        
        while(true){
          contador = contador + 1;   

          if(document.all['nome' + contador] == null){
            pula = pula + 1;

            /* Existem intervalos de numeros, se testar 10 numeros consecutivos que nao existem, aborta */
            if(pula == 10){
              break;
            }else{
              continue;
            }
          }

          if(document.all['nome' + contador].registro==rowid){
            document.all['nome' + contador].style.backgroundColor = cor;
            // evento excluido nao abre mais com 2 cliques
            if (cor == '#000000'){
              document.all['nome' + contador].ondblclick='';
              document.all['nome' + contador].innerText='';
            }
            break;             
          }
          pula = 0;
        }   
      }    

      NomeDoProgramaPrincipal  = '/wpgd0023.w';
      NomeDoProgramaPrincipal = document.form.aux_dsendurl.value + NomeDoProgramaPrincipal;
      document.form.action = NomeDoProgramaPrincipal;
      
      if (document.all.cdagenci.selectedIndex >= 0){
        document.all[document.form.novopac.value].innerHTML = document.all.cdagenci.options[document.all.cdagenci.selectedIndex].innerText.substr(0,9);
      }	  
	  
    </script>
    <script language="SpeedScript">
      IF aux_segevento <> ''  THEN DO:
    </script>
    <script language="JavaScript">
        vXD = (parseInt(findPosX(document.all['`aux_segevento`'])) - parseInt(findPosX(document.all['`aux_prievento`'])));  // posicao X da div da agencia
        vYD = (parseInt(findPosY(document.all['`aux_abaevento`'])) - parseInt(findPosY(document.all['`aux_prievento`'])) - 7 ); // posicao Y da div da agencia
        mudaXYdoEvento(); 
    </script>
    
    <script language="SpeedScript">
      END.
    </script>

    <script language="JavaScript">
      // faz com que a janela de aguarde feche
      hideMsgAguardo();
      // tira a moldura dos totais
      
      $("#aux_qttoteve").css({"border": "none"});
      $("#aux_qttotint").css({"border": "none"});
      $("#aux_qttotger").css({"border": "none"});
    </script>
  </body>
</html>
