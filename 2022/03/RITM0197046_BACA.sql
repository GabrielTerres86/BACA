begin

declare

ds_exc_erro_v		exception;
ds_dados_rollback_v	clob			:= null;
ds_texto_rollback_v	varchar2(32600);

cd_cooperativa_v	crapcop.cdcooper%type	:= 3;
ds_nome_arquivo_bkp_v	varchar2(100);
ds_nome_diretorio_v	crapprm.dsvlrprm%type;
ds_critica_v		crapcri.dscritic%type;

qt_registro	number(10)	:= 0;
nr_arquivo	number(10)	:= 1;
qt_reg_arquivo	number(10)	:= 50000;

vr_dscritic	VARCHAR2(1000);

cursor	c01 is
select	b.rowid as id_linha,
	b.dtfimvig,
	b.dtcancel,
	b.cdsitseg,
	b.cdopeexc,
	b.cdageexc,
	b.dtinsexc,
	b.cdopecnl
from	crapcop d,
	tbseg_prestamista c,
	crapseg b
where	c.cdcooper	= d.cdcooper
and	b.cdsitseg	<> 5
and	c.cdcooper	= b.cdcooper
and	c.nrdconta	= b.nrdconta
and	c.nrctrseg	= b.nrctrseg
and	c.nrproposta	in
('770356246713',
'770358524478',
'770352764809',
'770356544510',
'770350098658',
'770359945841',
'770356194039',
'770358072631',
'770353694570',
'770354284294',
'770355297659',
'770349224470',
'770349231336',
'770358772021',
'770351373857',
'770358352383',
'770357030447',
'770357531624',
'770356727665',
'770355996573',
'770356736044',
'770358128777',
'770358059910',
'770351043601',
'770359807899',
'770356360150',
'770357878900',
'770356986261',
'770350740988',
'770356155114',
'770353925474',
'770349522934',
'770349522977',
'770357340560',
'770354428342',
'770355244490',
'770357630428',
'770359150369',
'770349506670',
'770349506688',
'770358674208',
'770357605490',
'770355275086',
'770357987407',
'770354477076',
'770350886982',
'770351403233',
'770359510250',
'770357127491',
'770351350903',
'770351615940',
'770353611240',
'770356796390',
'770356446135',
'770359350422',
'770357801524',
'770357978661',
'770357066662',
'770351350962',
'770351350768',
'770356808940',
'770356760948',
'770354152223',
'770351350830',
'770356916808',
'770356516265',
'770355181685',
'770359650612',
'770359650426',
'770359650485',
'770358678254',
'770355506142',
'770358788394',
'770357516951',
'770349370506',
'770354240009',
'770358859127',
'770355722996',
'770349319071',
'770355150500',
'770356491424',
'770351737590',
'770357232082',
'770359018312',
'770355988848',
'770357709075',
'770359441789',
'770349153947',
'770357136261',
'770356574095',
'770356529197',
'770357315654',
'770353737503',
'770358294731',
'770356864867',
'770358812341',
'770356473396',
'770356812697',
'770356115660',
'770359231970',
'770359412070',
'770356441770',
'770356454120',
'770356093399',
'770359373228',
'770359355190',
'770356980760',
'770350682058',
'770355978800',
'770357473942',
'770358823831',
'770359771746',
'770359968965',
'770356192435',
'770359647573',
'770359140193',
'770358685927',
'770357306728',
'770358912001',
'770355917681',
'770358765190',
'770358765220',
'770358504400',
'770357325366',
'770357002940',
'770353582720',
'770357371082',
'770355199312',
'770352761451',
'770350899456',
'770351318139',
'770357245958',
'770355413730',
'770355952673',
'770358579434',
'770357340357',
'770353593234',
'770356840550',
'770359232683',
'770354597837',
'770355077349',
'770359555490',
'770355985695',
'770354829053',
'770354540266',
'770354540274',
'770354540282',
'770355661415',
'770356651200',
'770357792851',
'770358491057',
'770356172655',
'770356705467',
'770356234669',
'770358049400',
'770353728520',
'770356864336',
'770355813029',
'770354631148',
'770359649100',
'770355612848',
'770351156368',
'770355589102',
'770355955141',
'770357310601',
'770355001105',
'770355329070',
'770355102602',
'770351031751',
'770353774433',
'770355443272',
'770356323106',
'770354364514',
'770355878643',
'770351322446',
'770355041581',
'770356689976',
'770355213382',
'770356730798',
'770358240631',
'770355447928',
'770355216314',
'770351323787',
'770353773879',
'770355957063',
'770358869211',
'770357463998',
'770355811980',
'770358173489',
'770355516776',
'770356319656',
'770357664063',
'770356370864',
'770355729710',
'770355708144',
'770352474592',
'770354540754',
'770354540762',
'770354540770',
'770354540843',
'770354540851',
'770354540860',
'770353678000',
'770355729699',
'770355154726',
'770349995409',
'770349995417',
'770349995433',
'770349995441',
'770349995450',
'770349995468',
'770349995476',
'770349995484',
'770349995506',
'770349995530',
'770349995549',
'770349995557',
'770349995565',
'770349995581',
'770349995590',
'770349995603',
'770349995611',
'770350937382',
'770352819611',
'770359708556',
'770358196330',
'770357561639',
'770351656255',
'770357054940',
'770358830471',
'770354467585',
'770355465837',
'770355216080',
'770357877512',
'770354541270',
'770356259394',
'770356259459',
'770350780947',
'770357202639',
'770357698154',
'770355140423',
'770355666921',
'770355151697',
'770355040062',
'770358301061',
'770359218389',
'770355953874',
'770353998820',
'770356538870',
'770355511146',
'770358867340',
'770357521700',
'770359629591',
'770358396445',
'770353548921',
'770359526474',
'770357910013',
'770356488377',
'770357509378',
'770355262111',
'770355925170',
'770354783894',
'770358210953',
'770355559246',
'770355380130',
'770352614262',
'770354399016',
'770355879216',
'770355430669',
'770355160262',
'770355463915',
'770355463923',
'770355879313',
'770356657888',
'770355264246',
'770357647401',
'770356169735',
'770355702103',
'770355214001',
'770356850190',
'770354630826',
'770358047718',
'770355249441',
'770355245535',
'770355977579',
'770357567505',
'770355735249',
'770358823696',
'770355975622',
'770357444900',
'770359292058',
'770356741439',
'770356438671',
'770354008491',
'770359392710',
'770359147961',
'770356257316',
'770356630955',
'770357546630',
'770356934202',
'770355750981',
'770356308999',
'770355222381',
'770355399974',
'770357850037',
'770355250164',
'770355328791',
'770354597969',
'770354152720',
'770358880495',
'770355678725',
'770355955192',
'770355201040',
'770355733262',
'770359186479',
'770356337190',
'770358874320',
'770358129501',
'770356334574',
'770358829660',
'770358829678',
'770358829686',
'770358829694',
'770358829708',
'770358829716',
'770358829724',
'770358829732',
'770358829740',
'770357645590',
'770355865100',
'770355631060',
'770355272419',
'770354547813',
'770355258424',
'770355258386',
'770356840933',
'770359319347',
'770355142094',
'770359114761',
'770355222870',
'770355444040',
'770355686604',
'770358261264',
'770355064042',
'770351319070',
'770355973999',
'770354561948',
'770354548062',
'770354548070',
'770354867745',
'770351690070',
'770355212947',
'770356589750',
'770355199630',
'770358230016',
'770355447618',
'770355447626',
'770355447634',
'770355447642',
'770355212920',
'770358698484',
'770353708589',
'770355132161',
'770357030749',
'770355665852',
'770355093034',
'770353641140',
'770355582337',
'770357575095',
'770355803201',
'770355214168',
'770354863901',
'770355063569',
'770358227546',
'770353728768',
'770355026752',
'770355215890',
'770354548291',
'770354548305',
'770356828534',
'770358424694',
'770354488752',
'770355245241',
'770355310671',
'770358455816',
'770355205568',
'770354094347',
'770355358364',
'770355733475',
'770355301168',
'770354413337',
'770356257669',
'770359248377',
'770355502546',
'770355954714',
'770356946472',
'770355505898',
'770354548461',
'770350762205',
'770356918347',
'770358836437',
'770358490107',
'770354317508',
'770354548585',
'770354570742',
'770354570750',
'770354570718',
'770356993349',
'770357250226',
'770358663710',
'770352260053',
'770355871916',
'770359394438',
'770351321393',
'770357968690',
'770357129630',
'770355787567',
'770358234763',
'770358547940',
'770355041727',
'770355212963',
'770357253470',
'770356971345',
'770355248151',
'770355731812',
'770356587979',
'770355719995',
'770353570366',
'770356665201',
'770356665210',
'770356665228',
'770356974760',
'770356237439',
'770355491030',
'770355406229',
'770355456897',
'770355728579',
'770355512185',
'770355415252',
'770353758705',
'770357716462',
'770355215130',
'770353765787',
'770355701611',
'770356795156',
'770352520098',
'770359709765',
'770356679121',
'770352148512',
'770355917754',
'770356231473',
'770355921590',
'770357084814',
'770355878600',
'770355465497',
'770355884180',
'770359140851',
'770356244001',
'770355329283',
'770356585836',
'770357385938',
'770355562441',
'770353694707',
'770357320534',
'770359423047',
'770357479657',
'770355923967',
'770355332098',
'770356320948',
'770359023588',
'770354048906',
'770353495895',
'770354287625',
'770355983170',
'770355734544',
'770357647088',
'770356235894',
'770352127906',
'770354541629',
'770354929929',
'770354929937',
'770355943755',
'770358352650',
'770355586936',
'770358038441',
'770359331053',
'770355305910',
'770358167772',
'770355198316',
'770355893790',
'770355697436',
'770353926950',
'770355403025',
'770358230890',
'770356931246',
'770358796567',
'770355698092',
'770355658872',
'770355591441',
'770359694067',
'770354100312',
'770353480790',
'770355633080',
'770356742613',
'770354137470',
'770357297834',
'770355707172',
'770355302636',
'770355784819',
'770355893090',
'770357361710',
'770357701201',
'770359654502',
'770358358152',
'770356938569',
'770359814178',
'770359849664',
'770353984187',
'770357700221',
'770355625010',
'770355214567',
'770359342780',
'770358936911',
'770355229181',
'770355298876',
'770353930281',
'770354460866',
'770354688751',
'770354688760',
'770354688778',
'770355790576',
'770359581076',
'770359702426',
'770355597261',
'770354536889',
'770355718425',
'770355516016',
'770359968787',
'770355556514',
'770354957078',
'770358189202',
'770356397320',
'770354477475',
'770355154327',
'770352532940',
'770358790011',
'770352833924',
'770355254798',
'770355971309',
'770352682268',
'770359101490',
'770357729548',
'770352007668',
'770355586448',
'770353657895',
'770355924580',
'770354719827',
'770355770060',
'770355770079',
'770355770087',
'770354868709',
'770359194250',
'770356586603',
'770357086604',
'770355771695',
'770355990125',
'770351343516',
'770350690816',
'770355903567',
'770355811697',
'770354562391',
'770357861853',
'770354628139',
'770355199452',
'770354582228',
'770356097289',
'770359015577',
'770353769235',
'770358337392',
'770357024838',
'770356953320',
'770351823640',
'770351823631',
'770354595290',
'770358350836',
'770349759519',
'770355234878',
'770356295919',
'770359118627',
'770358428754',
'770357977665',
'770359194366',
'770356199383',
'770353832212',
'770356320484',
'770358284248',
'770354136023',
'770354629801',
'770356730569',
'770357098580',
'770358617212',
'770359214448',
'770355272613',
'770354436906',
'770358472842',
'770358588140',
'770356668863',
'770357445892',
'770354109379',
'770356759702',
'770358735495',
'770359793855',
'770356539680',
'770357542804',
'770357237084',
'770358754198',
'770359975589',
'770357483174',
'770357580587',
'770359593120',
'770352840491',
'770351344776',
'770359364431',
'770356775104',
'770359007663',
'770359007540',
'770358811248',
'770356290003',
'770358744133',
'770349623161',
'770356900278',
'770359181582',
'770354968940',
'770355477258',
'770358816410',
'770358007228',
'770359588895',
'770354163993',
'770357336392',
'770355452476',
'770355452484',
'770355452492',
'770355452450',
'770355796825',
'770359998112',
'770355216594',
'770358003788',
'770355922740',
'770356050002',
'770354157136',
'770359405219',
'770355578780',
'770357415802',
'770353229869',
'770355750388',
'770358689515',
'770356787528',
'770357462096',
'770352037397',
'770357593891',
'770355222144',
'770359044852',
'770355886700',
'770356936523',
'770351376392',
'770358097936',
'770355511243',
'770355024067',
'770358701434',
'770353715704',
'770354428091',
'770353952030',
'770355979130',
'770351821876',
'770359160020',
'770354428148',
'770359741391',
'770356721616',
'770359970218',
'770356092287',
'770356078985',
'770356078993',
'770356079000',
'770356079019',
'770356079027',
'770356079035',
'770356079043',
'770356078977',
'770355927121',
'770356092058',
'770358677959',
'770353395610',
'770355560643',
'770353904345',
'770356553993',
'770358929494',
'770355984346',
'770357007488',
'770357785600',
'770349708329',
'770349708337',
'770350422331',
'770354271583',
'770353811088',
'770356504747',
'770359812981',
'770354833956',
'770356832787',
'770355332292',
'770357628288',
'770356443519',
'770355959775',
'770358754490',
'770355321584',
'770355747174',
'770354534258',
'770358266983',
'770354479540',
'770357898609',
'770354609983',
'770359710410',
'770358750869',
'770355442764',
'770359761848',
'770353889486',
'770359132956',
'770355171256',
'770358713777',
'770354497867',
'770354975025',
'770358522157',
'770355536467',
'770356475755',
'770357565057',
'770355771490',
'770358456782',
'770358916929',
'770356974395',
'770356974409',
'770355037371',
'770355783677',
'770355617670',
'770355587150',
'770354976633',
'770354562197',
'770353648225',
'770357597927',
'770355063542',
'770355551245',
'770354564823',
'770351926260',
'770356875460',
'770356124561',
'770355198200',
'770356970780',
'770351320087',
'770355924068',
'770355991067',
'770355135012',
'770359342020',
'770356932684',
'770355556590',
'770354360420',
'770358396305',
'770355442543',
'770355297675',
'770351312610',
'770352647977',
'770355483860',
'770358472389',
'770355585026',
'770353832522',
'770359688890',
'770359220618',
'770355330346',
'770355726380',
'770354537028',
'770359408307',
'770359701616',
'770356945042',
'770357446422',
'770354498090',
'770356433599',
'770358283454',
'770354977559',
'770354977567',
'770354977575',
'770354977583',
'770354977591',
'770355397823',
'770356877594',
'770353121472',
'770357934230',
'770355584925',
'770353078739',
'770359536330',
'770353895214',
'770355921670',
'770353484290',
'770356101014',
'770359257180',
'770351912405',
'770354267616',
'770355221555',
'770355221563',
'770358015344',
'770354969459',
'770355821633',
'770351532530',
'770357531608',
'770351826002',
'770359339194',
'770359859643',
'770349130556',
'770358733239',
'770357115400',
'770349134462',
'770349038927',
'770350198474',
'770351541261',
'770355454223',
'770349142171',
'770354539209',
'770355414477',
'770358241077',
'770355792994',
'770354034700',
'770354539322',
'770354539330',
'770356213521',
'770349078678',
'770349078686',
'770349078694',
'770349078708',
'770350851402',
'770357595223',
'770358774490',
'770356589190',
'770359937903',
'770357410150',
'770359641095');

procedure valida_diretorio_p(	ds_nome_diretorio_p	in	varchar2,
				ds_critica_p		out	crapcri.dscritic%TYPE) is

ds_critica_v	crapcri.dscritic%type;
ie_tipo_saida_v	varchar2(3);
ds_saida_v	varchar2(1000);
   
begin

	if	(gene0001.fn_exis_diretorio(ds_nome_diretorio_p)) then

		ds_critica_p	:= null;

	else

		gene0001.pc_OSCommand_Shell(	pr_des_comando	=> 'mkdir ' || ds_nome_diretorio_p || ' 1> /dev/null',
						pr_typ_saida	=> ie_tipo_saida_v,
						pr_des_saida	=> ds_saida_v);

		if	(ie_tipo_saida_v	= 'ERR') then

			ds_critica_v	:= 'CRIAR DIRETORIO ARQUIVO -> Nao foi possivel criar o diretorio para gerar os arquivos. ' || ds_saida_v;
			raise		ds_exc_erro_v;

		end if;

		gene0001.pc_OSCommand_Shell(	pr_des_comando	=> 'chmod 777 ' || ds_nome_diretorio_p || ' 1> /dev/null',
						pr_typ_saida	=> ie_tipo_saida_v,
						pr_des_saida	=> ds_saida_v);

		if	(ie_tipo_saida_v	= 'ERR') then

			ds_critica_v	:= 'PERMISSAO NO DIRETORIO -> Nao foi possivel adicionar permissao no diretorio dos arquivos. ' || ds_saida_v;
			raise		ds_exc_erro_v;

		end if;

	end if;

exception
when	ds_exc_erro_v then

        ds_critica_p	:= ds_critica_v;

end valida_diretorio_p;

begin

if	(upper(gene0001.fn_database_name) like '%AYLLOSP%') then

	select	max(a.dsvlrprm)
	into	ds_nome_diretorio_v
	from	crapprm a
	where	a.nmsistem	= 'CRED'
	and	a.cdcooper	= cd_cooperativa_v
	and	a.cdacesso	= 'ROOT_MICROS';

	if	(ds_nome_diretorio_v	is null) then

		select	max(a.dsvlrprm)
		into	ds_nome_diretorio_v
		from	crapprm a
		where	a.nmsistem	= 'CRED'
		and	a.cdcooper	= 0
		and	a.cdacesso	= 'ROOT_MICROS';

	end if;

	ds_nome_diretorio_v	:= ds_nome_diretorio_v || 'cpd/bacas/RITM0197046';

else

	ds_nome_diretorio_v	:= gene0001.fn_diretorio(	pr_tpdireto => 'C',
								pr_cdcooper => 3);

	ds_nome_diretorio_v	:= ds_nome_diretorio_v || '/RITM0197046';

end if;
 
valida_diretorio_p(	ds_nome_diretorio_p	=> ds_nome_diretorio_v,
			ds_critica_p		=> ds_critica_v);

if	(trim(ds_critica_v) is not null) then

	raise ds_exc_erro_v;

end if;

for	r01 in c01 loop

	begin

	if	(qt_reg_arquivo	>= 50000) then

		qt_reg_arquivo	:= 0;

		dbms_lob.createtemporary(ds_dados_rollback_v, true, dbms_lob.CALL);
		dbms_lob.open(ds_dados_rollback_v, dbms_lob.lob_readwrite);
		gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'begin '||chr(13), false);  
		ds_nome_arquivo_bkp_v	:= 'ROLLBACK_RITM0197046_'||nr_arquivo||'.sql';

		nr_arquivo	:= nr_arquivo + 1;

	end if;

	qt_registro	:= qt_registro + 1;
	qt_reg_arquivo	:= qt_reg_arquivo + 1;

	update	crapseg a
	set	a.dtfimvig	= trunc(sysdate),
		a.dtcancel	= trunc(sysdate),
		a.cdsitseg	= 5,
		a.cdopeexc	= '1',
		a.cdageexc	= 1,
		a.dtinsexc	= trunc(sysdate),
		a.cdopecnl	= '1'
	where	a.rowid		= r01.id_linha;

	gene0002.pc_escreve_xml(	ds_dados_rollback_v,
					ds_texto_rollback_v,
					'update	crapseg a ' || chr(13) ||
					'set	a.dtfimvig	= ' || 'to_date(' || chr(39) || trim(to_char(r01.dtfimvig,'dd/mm/yyyy')) || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' || chr(13) ||
					'	a.dtcancel	= ' || 'to_date(' || chr(39) || trim(to_char(r01.dtcancel,'dd/mm/yyyy')) || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' || chr(13) ||
					'	a.cdsitseg	= ' || replace(nvl(trim(to_char(r01.cdsitseg)),'null'),',','.') || ', ' || chr(13) ||
					'	a.cdopeexc	= ' || chr(39) || r01.cdopeexc || chr(39) || ', ' || chr(13) ||
					'	a.cdageexc	= ' || replace(nvl(trim(to_char(r01.cdageexc)),'null'),',','.') || ', ' || chr(13) ||
					'	a.dtinsexc	= ' || 'to_date(' || chr(39) || trim(to_char(r01.dtinsexc,'dd/mm/yyyy')) || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' || chr(13) ||
					'	a.cdopecnl	= ' || chr(39) || r01.cdopecnl || chr(39) || chr(13) ||
					'where	a.rowid		= ' || chr(39) || r01.id_linha || chr(39) || ';' || chr(13) || chr(13), false);

	if	(qt_registro	>= 10000) then

		gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'commit;' || chr(13) || chr(13), FALSE);

		commit;

		qt_registro	:= 0;

	end if;

	if	(qt_reg_arquivo	>= 50000) then

		gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'commit;' || chr(13) || chr(13), FALSE);
		gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'end;'||chr(13), FALSE);
		gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, chr(13), TRUE);

		gene0002.pc_solicita_relato_arquivo(	pr_cdcooper	=> cd_cooperativa_v,
							pr_cdprogra	=> 'ATENDA',
							pr_dtmvtolt	=> trunc(sysdate),
							pr_dsxml	=> ds_dados_rollback_v,
							pr_dsarqsaid	=> ds_nome_diretorio_v || '/' || ds_nome_arquivo_bkp_v,
							pr_flg_impri	=> 'N',
							pr_flg_gerar	=> 'S',
							pr_flgremarq	=> 'N',
							pr_nrcopias	=> 1,
							pr_des_erro	=> ds_critica_v);

		if	(trim(ds_critica_v) is not null) then

			rollback;
			raise	ds_exc_erro_v;

		end if;

		dbms_lob.close(ds_dados_rollback_v);
		dbms_lob.freetemporary(ds_dados_rollback_v);

	end if;

	exception
	when others then
		vr_dscritic	:= 'Falha ao atualizar crapseg';
		rollback;
		exit;
	end;

end loop;

if	(qt_reg_arquivo	<> 50000) then

	gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'commit;' || chr(13) || chr(13), FALSE);
	gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, 'end;' || chr(13), FALSE);
	gene0002.pc_escreve_xml(ds_dados_rollback_v, ds_texto_rollback_v, chr(13), TRUE);

	gene0002.pc_solicita_relato_arquivo(	pr_cdcooper	=> cd_cooperativa_v,
						pr_cdprogra	=> 'ATENDA',
						pr_dtmvtolt	=> trunc(sysdate),
						pr_dsxml	=> ds_dados_rollback_v,
						pr_dsarqsaid	=> ds_nome_diretorio_v || '/' || ds_nome_arquivo_bkp_v,
						pr_flg_impri	=> 'N',
						pr_flg_gerar	=> 'S',
						pr_flgremarq	=> 'N',
						pr_nrcopias	=> 1,
						pr_des_erro	=> ds_critica_v);

	if	(trim(ds_critica_v) is not null) then

		raise	ds_exc_erro_v;

	end if;

	dbms_lob.close(ds_dados_rollback_v);
	dbms_lob.freetemporary(ds_dados_rollback_v);

end if;

if	(trim(vr_dscritic) is not null) then

	ds_critica_v	:= vr_dscritic;
	raise	ds_exc_erro_v;

end if;

commit;

exception
when	ds_exc_erro_v then

	raise_application_error(-20111, ds_critica_v);

end;

end;