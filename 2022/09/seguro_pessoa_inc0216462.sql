DECLARE
  vr_cdprogra  CONSTANT CECRED.crapprg.cdprogra%TYPE := 'SC_PRSTFIL';
  vr_idprglog  CECRED.tbgen_prglog.idprglog%TYPE := 0;
  vr_exc_saida EXCEPTION;
  vr_exc_erro  EXCEPTION;
  vr_dscritic  VARCHAR2(500);
  vr_cdcritic  PLS_INTEGER;
  vr_nrsequen  NUMBER(5);
  vr_endereco  VARCHAR2(100);    
  vr_login     VARCHAR2(100);
  vr_senha     VARCHAR2(100);
  vr_dsdemail  VARCHAR2(100);
  vr_linha     VARCHAR2(32767); 
  vr_seqtran   INTEGER;
  vr_vlsdatua  NUMBER;
  vr_vlminimo  NUMBER;
  vr_vlenviad  NUMBER;
  vr_vlsdeved  NUMBER := 0;
  vr_tpregist  INTEGER;
  pr_cdcooper  CECRED.tbseg_prestamista.cdcooper%TYPE;
  vr_nrproposta CECRED.tbseg_prestamista.NRPROPOSTA%TYPE;
  vr_cdapolic  CECRED.tbseg_prestamista.cdapolic%TYPE;
  vr_dtdevend  CECRED.tbseg_prestamista.dtdevend%TYPE;
  vr_dtinivig  CECRED.tbseg_prestamista.dtinivig%TYPE;
  vr_flgnvenv  BOOLEAN;
  vr_contrcpf CECRED.tbseg_prestamista.nrcpfcgc%TYPE;
  vr_index    VARCHAR2(50);
  vr_vltotenv NUMBER;
  vr_vlmaximo NUMBER;
  vr_nmrescop CECRED.crapcop.nmrescop%TYPE;
  vr_apolice  VARCHAR2(20);
  vr_nmarquiv  VARCHAR2(100);
  vr_linha_txt VARCHAR2(32600);
  vr_ultimoDia DATE;
  vr_pgtosegu  NUMBER;
  vr_vlprodvl  NUMBER;
  vr_dtfimvig  DATE;
  vr_dtcalcidade DATE; 
  vr_nrdeanos PLS_INTEGER;
  vr_dtmvtolt DATE;
  vr_nmdir    VARCHAR2(4000) := CECRED.gene0001.fn_param_sistema('CRED',3,'ROOT_MICROS')||'cpd/bacas/INC0216462';
  vr_nmarq    VARCHAR2(100)  := 'ROLLBACK_INC0216462.sql';
        
  TYPE typ_reg_ctrl_prst IS RECORD(nrcpfcgc CECRED.tbseg_prestamista.nrcpfcgc%TYPE,
                                   nrctremp CECRED.tbseg_prestamista.nrctremp%TYPE);  

  TYPE typ_tab_ctrl_prst IS TABLE OF typ_reg_ctrl_prst INDEX BY VARCHAR2(40);
  vr_tab_ctrl_prst typ_tab_ctrl_prst ;
        
  vr_ind_arquivo utl_file.file_type;
  vr_ind_arquivo_backup utl_file.file_type;
             
  CURSOR cr_cpf(pr_cdcooper IN CECRED.tbseg_prestamista.cdcooper%TYPE) IS
     SELECT p.cdcooper, p.nrcpfcgc
       FROM CECRED.tbseg_prestamista2 p
      WHERE p.cdcooper = pr_cdcooper
        AND p.nrproposta IN ('770349015447',
                             '770349030268',
                             '770349060043',
                             '770349083175',
                             '770349136880',
                             '770349136899',
                             '770349136902',
                             '770349136910',
                             '770349136929',
                             '770349155362',
                             '770349164256',
                             '770349164264',
                             '770349559307',
                             '770349559315',
                             '770349687453',
                             '770349687461',
                             '770349742292',
                             '770349742306',
                             '770349748800',
                             '770349748819',
                             '770349748827',
                             '770349771837',
                             '770349771853',
                             '770349771861',
                             '770349771870',
                             '770349771888',
                             '770349771926',
                             '770349782138',
                             '770349782146',
                             '770349817160',
                             '770349817179',
                             '770349817187',
                             '770349841126',
                             '770349841134',
                             '770349841142',
                             '770349876205',
                             '770349876213',
                             '770349907844',
                             '770349908930',
                             '770349912732',
                             '770349912740',
                             '770349930870',
                             '770349932733',
                             '770349932741',
                             '770349939401',
                             '770350093699',
                             '770350105280',
                             '770350111336',
                             '770350115374',
                             '770350124853',
                             '770350132961',
                             '770350141677',
                             '770350142045',
                             '770350178937',
                             '770350183213',
                             '770350191895',
                             '770350191909',
                             '770350199748',
                             '770350206868',
                             '770350207449',
                             '770350207465',
                             '770350219277',
                             '770350219285',
                             '770350219293',
                             '770350230033',
                             '770350230076',
                             '770350238450',
                             '770350238468',
                             '770350247211',
                             '770350267310',
                             '770350267328',
                             '770350272763',
                             '770350336028',
                             '770350344233',
                             '770350361979',
                             '770350361995',
                             '770350362010',
                             '770350390553',
                             '770350390570',
                             '770350453890',
                             '770350470069',
                             '770350470077',
                             '770350470085',
                             '770350470093',
                             '770350470107',
                             '770350470115',
                             '770350480366',
                             '770350480374',
                             '770350506314',
                             '770350506349',
                             '770350506357',
                             '770350544569',
                             '770350590692',
                             '770350591001',
                             '770350594132',
                             '770350612335',
                             '770350885269',
                             '770350942254',
                             '770351041790',
                             '770351181184',
                             '770351200898',
                             '770351226064',
                             '770351312920',
                             '770351312955',
                             '770351325240',
                             '770351325267',
                             '770351343982',
                             '770351417560',
                             '770351643862',
                             '770351670932',
                             '770351670940',
                             '770351670959',
                             '770351670967',
                             '770351670975',
                             '770351670983',
                             '770351670991',
                             '770351671009',
                             '770351671017',
                             '770351671343',
                             '770351699434',
                             '770351734612',
                             '770351824670',
                             '770351824697',
                             '770351858990',
                             '770351883669',
                             '770351931485',
                             '770351931493',
                             '770351973862',
                             '770352055450',
                             '770352055522',
                             '770352056065',
                             '770352062170',
                             '770352132730',
                             '770352234346',
                             '770352315338',
                             '770352318531',
                             '770352318817',
                             '770352368008',
                             '770352382922',
                             '770352382930',
                             '770352486493',
                             '770352489433',
                             '770352543020',
                             '770352596701',
                             '770352651109',
                             '770352652237',
                             '770352652245',
                             '770352652253',
                             '770352657522',
                             '770352727016',
                             '770353072560',
                             '770353095250',
                             '770353102494',
                             '770353118811',
                             '770353118820',
                             '770353118838',
                             '770353118846',
                             '770353118854',
                             '770353127055',
                             '770353127063',
                             '770353148494',
                             '770353149202',
                             '770353335421',
                             '770353346105',
                             '770353396668',
                             '770353396749',
                             '770353407406',
                             '770353407414',
                             '770353407422',
                             '770353412965',
                             '770353426311',
                             '770353484443',
                             '770353507842',
                             '770353512617',
                             '770353641000',
                             '770353668323',
                             '770353668358',
                             '770353668366',
                             '770353669729',
                             '770353768441',
                             '770353784978',
                             '770353831941',
                             '770353832107',
                             '770353850334',
                             '770353865242',
                             '770353872451',
                             '770353899155',
                             '770353899163',
                             '770353913085',
                             '770354014386',
                             '770354028638',
                             '770354123207',
                             '770354164884',
                             '770354185148',
                             '770354200120',
                             '770354220130',
                             '770354220148',
                             '770354220253',
                             '770354232260',
                             '770354261758',
                             '770354293234',
                             '770354294575',
                             '770354319829',
                             '770354374471',
                             '770354435993',
                             '770354436000',
                             '770354455374',
                             '770354483459',
                             '770354483475',
                             '770354490668',
                             '770354516454',
                             '770354523906',
                             '770354523914',
                             '770354523922',
                             '770354523930',
                             '770354525380',
                             '770354525399',
                             '770354525402',
                             '770354534096',
                             '770354540002',
                             '770354540010',
                             '770354548399',
                             '770354548402',
                             '770354548410',
                             '770354548429',
                             '770354548437',
                             '770354555646',
                             '770354555662',
                             '770354589842',
                             '770354589850',
                             '770354589869',
                             '770354589877',
                             '770354589885',
                             '770354596784',
                             '770354596792',
                             '770354596806',
                             '770354596814',
                             '770354605015',
                             '770354605023',
                             '770354605031',
                             '770354605040',
                             '770354612780',
                             '770354613190',
                             '770354613204',
                             '770354613212',
                             '770354613220',
                             '770354649438',
                             '770354688948',
                             '770354688956',
                             '770354688964',
                             '770354688972',
                             '770354688980',
                             '770354688999',
                             '770354701561',
                             '770354709392',
                             '770354719584',
                             '770354719592',
                             '770354719606',
                             '770354720825',
                             '770354720833',
                             '770354720841',
                             '770354721236',
                             '770354721244',
                             '770354721287',
                             '770354721295',
                             '770354721783',
                             '770354721791',
                             '770354721902',
                             '770354721910',
                             '770354723301',
                             '770354723352',
                             '770354826011',
                             '770354826020',
                             '770354847655',
                             '770354847663',
                             '770354847671',
                             '770354875071',
                             '770354898268',
                             '770354969696',
                             '770354969700',
                             '770354970090',
                             '770354977176',
                             '770354977184',
                             '770354977192',
                             '770354977206',
                             '770354982080',
                             '770355002209',
                             '770355028356',
                             '770355028364',
                             '770355028372',
                             '770355038637',
                             '770355038645',
                             '770355073190',
                             '770355092623',
                             '770355133885',
                             '770355194914',
                             '770355194922',
                             '770355194930',
                             '770355194949',
                             '770355194957',
                             '770355198863',
                             '770355202070',
                             '770355202089',
                             '770355202097',
                             '770355202100',
                             '770355202623',
                             '770355202640',
                             '770355202658',
                             '770355202666',
                             '770355202674',
                             '770355219453',
                             '770355227448',
                             '770355227618',
                             '770355241840',
                             '770355241858',
                             '770355256383',
                             '770355256391',
                             '770355256405',
                             '770355256413',
                             '770355259552',
                             '770355267580',
                             '770355267598',
                             '770355267610',
                             '770355267628',
                             '770355275418',
                             '770355277275',
                             '770355277283',
                             '770355277291',
                             '770355277305',
                             '770355277313',
                             '770355277321',
                             '770355277330',
                             '770355277348',
                             '770355277356',
                             '770355305686',
                             '770355351688',
                             '770355374521',
                             '770355374530',
                             '770355374548',
                             '770355374556',
                             '770355374564',
                             '770355374572',
                             '770355461572',
                             '770355491625',
                             '770355526062',
                             '770355526089',
                             '770355533026',
                             '770355533042',
                             '770355533921',
                             '770355549887',
                             '770355549895',
                             '770355603784',
                             '770355603792',
                             '770355603806',
                             '770355609740',
                             '770355618250',
                             '770355618269',
                             '770355618277',
                             '770355618285',
                             '770355681289',
                             '770355683192',
                             '770355683265',
                             '770355683273',
                             '770355750337',
                             '770355815226',
                             '770355816583',
                             '770355816591',
                             '770355818497',
                             '770355830780',
                             '770355830942',
                             '770355830950',
                             '770355843360',
                             '770355846814',
                             '770355846822',
                             '770355846830',
                             '770355850676',
                             '770355870243',
                             '770355870251',
                             '770355870260',
                             '770355921557',
                             '770355960145',
                             '770355960153',
                             '770355960161',
                             '770355960170',
                             '770355964043',
                             '770355992349',
                             '770356014847',
                             '770356014863',
                             '770356014880',
                             '770356016548',
                             '770356016599',
                             '770356020707',
                             '770356021150',
                             '770356021169',
                             '770356021177',
                             '770356021185',
                             '770356023773',
                             '770356023781',
                             '770356023790',
                             '770356083180',
                             '770356083202',
                             '770356130456',
                             '770356135636',
                             '770356135644',
                             '770356137442',
                             '770356140265',
                             '770356159233',
                             '770356159748',
                             '770356173678',
                             '770356186974',
                             '770356186982',
                             '770356186990',
                             '770356187008',
                             '770356187016',
                             '770356187024',
                             '770356247787',
                             '770356255690',
                             '770356256824',
                             '770356276000',
                             '770356313208',
                             '770356398556',
                             '770356398637',
                             '770356426363',
                             '770356487761',
                             '770356494350',
                             '770356494369',
                             '770356496434',
                             '770356544846',
                             '770356544854',
                             '770356591437',
                             '770356656059',
                             '770356693094',
                             '770356724410',
                             '770356751906',
                             '770356751914',
                             '770356763416',
                             '770356771575',
                             '770356777824',
                             '770356780264',
                             '770356823133',
                             '770356841492',
                             '770356841506',
                             '770356841514',
                             '770356841522',
                             '770356841549',
                             '770356841565',
                             '770356841573',
                             '770356841581',
                             '770356841603',
                             '770356841611',
                             '770356841620',
                             '770356946626',
                             '770356993748',
                             '770356993756',
                             '770356993764',
                             '770356993772',
                             '770356993780',
                             '770356993799',
                             '770356993802',
                             '770356998960',
                             '770357006120',
                             '770357006139',
                             '770357007070',
                             '770357007097',
                             '770357038693',
                             '770357038707',
                             '770357068720',
                             '770357080525',
                             '770357094429',
                             '770357094437',
                             '770357114659',
                             '770357114675',
                             '770357146526',
                             '770357146534',
                             '770357221617',
                             '770357241367',
                             '770357274753',
                             '770357279283',
                             '770357288819',
                             '770357288827',
                             '770357307554',
                             '770357307899',
                             '770357308585',
                             '770357334276',
                             '770357334675',
                             '770357334683',
                             '770357393787',
                             '770357394821',
                             '770357394830',
                             '770357394848',
                             '770357430526',
                             '770357430534',
                             '770357457998',
                             '770357503167',
                             '770357508630',
                             '770357508649',
                             '770357508657',
                             '770357508665',
                             '770357513707',
                             '770357518571',
                             '770357518580',
                             '770357522803',
                             '770357522811',
                             '770357528038',
                             '770357535719',
                             '770357535727',
                             '770357535735',
                             '770357535743',
                             '770357542596',
                             '770357543045',
                             '770357608503',
                             '770357608511',
                             '770357626420',
                             '770357627001',
                             '770357656826',
                             '770357663520',
                             '770357663539',
                             '770357714737',
                             '770357725755',
                             '770357734762',
                             '770357748070',
                             '770357780055',
                             '770357791383',
                             '770357809886',
                             '770357814545',
                             '770357821789',
                             '770357824478',
                             '770357844819',
                             '770357870194',
                             '770357895600',
                             '770357919398',
                             '770357927390',
                             '770357943760',
                             '770357943779',
                             '770357943787',
                             '770357953561',
                             '770357973031',
                             '770357973040',
                             '770357973058',
                             '770357997445',
                             '770358021387',
                             '770358021395',
                             '770358049583',
                             '770358178782',
                             '770358198872',
                             '770358218830',
                             '770358218849',
                             '770358218857',
                             '770358218865',
                             '770358226884',
                             '770358268250',
                             '770358268269',
                             '770358295444',
                             '770358310699',
                             '770358310702',
                             '770358310710',
                             '770358310737',
                             '770358310745',
                             '770358310753',
                             '770358310770',
                             '770358366406',
                             '770358368824',
                             '770358370950',
                             '770358370969',
                             '770358370977',
                             '770358370985',
                             '770358381502',
                             '770358423051',
                             '770358428568',
                             '770358437710',
                             '770358437788',
                             '770358437796',
                             '770358438253',
                             '770358438261',
                             '770358438288',
                             '770358438296',
                             '770358438300',
                             '770358438318',
                             '770358448984',
                             '770358531911',
                             '770358551564',
                             '770358602177',
                             '770358635067',
                             '770358635075',
                             '770358635903',
                             '770358635938',
                             '770358635946',
                             '770358651526',
                             '770358651534',
                             '770358688462',
                             '770358688489',
                             '770358688497',
                             '770358688500',
                             '770358688527',
                             '770358688535',
                             '770358688560',
                             '770358688586',
                             '770358698093',
                             '770358698123',
                             '770358703267',
                             '770358703291',
                             '770358703305',
                             '770358703313',
                             '770358703321',
                             '770358703860',
                             '770358731597',
                             '770358736319',
                             '770358736327',
                             '770358743153',
                             '770358770495',
                             '770358771980',
                             '770358827713',
                             '770358836194',
                             '770358836224',
                             '770358836232',
                             '770358836240',
                             '770358836828',
                             '770358836836',
                             '770358836844',
                             '770358836852',
                             '770358836860',
                             '770358839266',
                             '770358911323',
                             '770358968309',
                             '770358975453',
                             '770358975470',
                             '770358991009',
                             '770358991017',
                             '770358991033',
                             '770359019920',
                             '770359019939',
                             '770359115806',
                             '770359162677',
                             '770359165900',
                             '770359165927',
                             '770359165935',
                             '770359165943',
                             '770359178506',
                             '770359178514',
                             '770359178522',
                             '770359178530',
                             '770359180640',
                             '770359180659',
                             '770359180667',
                             '770359286902',
                             '770359367384',
                             '770359380747',
                             '770359390998',
                             '770359419716',
                             '770359453892',
                             '770359453914',
                             '770359453922',
                             '770359453930',
                             '770359506481',
                             '770359516371',
                             '770359538570',
                             '770359574304',
                             '770359586868',
                             '770359633033',
                             '770359639317',
                             '770359639325',
                             '770359639333',
                             '770359639341',
                             '770359652232',
                             '770359710070',
                             '770359742800',
                             '770359743408',
                             '770359850271',
                             '770359867573',
                             '770572841952',
                             '770572841960',
                             '770572841979',
                             '770572841987',
                             '770572851087',
                             '770572851095',
                             '770572883124',
                             '770572891909',
                             '770572892085',
                             '770572903001',
                             '770572909581',
                             '770572909590',
                             '770572909603',
                             '770572909611',
                             '770572920127',
                             '770572920135',
                             '770572920143',
                             '770572943488',
                             '770572950344',
                             '770572950360',
                             '770572950379',
                             '770572950387',
                             '770572950395',
                             '770572965902',
                             '770573020383',
                             '770573020391',
                             '770573020405',
                             '770573020413',
                             '770573039947',
                             '770573070216',
                             '770573093402',
                             '770573093801',
                             '770573093844',
                             '770573143540',
                             '770573149378',
                             '770573149386',
                             '770573149394',
                             '770573149483',
                             '770573241398',
                             '770573241401',
                             '770573241410',
                             '770573241428',
                             '770573258460',
                             '770573273400',
                             '770573273419',
                             '770573273427',
                             '770573273435',
                             '770573273443',
                             '770573273451',
                             '770573289390',
                             '770573310985',
                             '770573323459',
                             '770573338952',
                             '770573338960',
                             '770573338979',
                             '770573338987',
                             '770573355199',
                             '770573355202',
                             '770573355237',
                             '770573454901',
                             '770573469089',
                             '770573469160',
                             '770573490770',
                             '770573504593',
                             '770573504607',
                             '770573521757',
                             '770573521781',
                             '770573532775',
                             '770573540670',
                             '770573554604',
                             '770573574559',
                             '770573574567',
                             '770573574575',
                             '770573574583',
                             '770573574591',
                             '770573592590',
                             '770573592603',
                             '770573592611',
                             '770573598555',
                             '770573601920',
                             '770573602536',
                             '770573612566',
                             '770573612680',
                             '770573612698',
                             '770573612701',
                             '770573617355',
                             '770573617363',
                             '770573617371',
                             '770573617380',
                             '770573617398',
                             '770573617401',
                             '770573623398',
                             '770573654102',
                             '770573677919',
                             '770573698703',
                             '770573721012',
                             '770573778669',
                             '770573785380',
                             '770573816684',
                             '770573816692',
                             '770573821343',
                             '770612776261',
                             '770612776270',
                             '770612776288',
                             '770612825513',
                             '770612848220',
                             '770612872503',
                             '770612873291',
                             '770612890145',
                             '770612890161',
                             '770612891168',
                             '770612891176',
                             '770612891192',
                             '770612981523',
                             '770613030409',
                             '770613063161',
                             '770613063170',
                             '770613063196',
                             '770613063200',
                             '770613063218',
                             '770613063226',
                             '770613063234',
                             '770613063242',
                             '770613063250',
                             '770613090150',
                             '770613092676',
                             '770613116575',
                             '770613130543',
                             '770613208909',
                             '770613241779',
                             '770613244352',
                             '770613244360',
                             '770613244379',
                             '770613244409',
                             '770613244417',
                             '770613244719',
                             '770613244727',
                             '770613283420',
                             '770613283439',
                             '770613304550',
                             '770613304568',
                             '770613304576',
                             '770613304584',
                             '770613304592',
                             '770613304606',
                             '770613305068',
                             '770613312153',
                             '770613313761',
                             '770613314148',
                             '770613314156',
                             '770613314164',
                             '770613314172',
                             '770613331107',
                             '770613344470',
                             '770613365737',
                             '770613365745',
                             '770613365753',
                             '770613365761',
                             '770613375627',
                             '770613376070',
                             '770613376089',
                             '770613376097',
                             '770613390871',
                             '770613390880',
                             '770613390901',
                             '770613390910',
                             '770613390928',
                             '770613390944',
                             '770613390952',
                             '770613540385',
                             '770613547975',
                             '770613561269',
                             '770613561277',
                             '770613561285',
                             '770613561293',
                             '770613561307',
                             '770613561889',
                             '770613561897',
                             '770613640827',
                             '770613652132',
                             '770613653147',
                             '770613653198',
                             '770613653201',
                             '770613654160',
                             '770613654178',
                             '770613654186',
                             '770613688625',
                             '770613719334',
                             '770613719342',
                             '770613726330',
                             '770613726780',
                             '770613726802',
                             '770613752242',
                             '770613755535',
                             '770613755560',
                             '770613755578',
                             '770613766170',
                             '770657223999',
                             '770657224014',
                             '770657224022',
                             '770657224030',
                             '770657262978',
                             '770657263486',
                             '770657292699',
                             '770657292931',
                             '770657292940',
                             '770657292958',
                             '770657292966',
                             '770657293024',
                             '770657293032',
                             '770657293040',
                             '770657294918',
                             '770657296074',
                             '770657296082',
                             '770657299901',
                             '770657300500',
                             '770657300519',
                             '770657300527',
                             '770657300535',
                             '770657305880',
                             '770657305898',
                             '770657305901',
                             '770657325104',
                             '770657325112',
                             '770657325120',
                             '770657456179',
                             '770657456187',
                             '770657456195',
                             '770657467448',
                             '770657476994',
                             '770657478504',
                             '770657478512',
                             '770657494240',
                             '770657503681',
                             '770657503690',
                             '770657503711',
                             '770657503754',
                             '770657594083',
                             '770657711764',
                             '770657711810',
                             '770657711829',
                             '770657711837',
                             '770657711845',
                             '770657726745',
                             '770657783676',
                             '770657788392',
                             '770657809926',
                             '770657815500',
                             '770657829277',
                             '770657829307',
                             '770657829315',
                             '770657829323',
                             '770657829340',
                             '770657888729',
                             '770657972940',
                             '770657988405',
                             '770657988502',
                             '770657988510',
                             '770657988529',
                             '770657988650',
                             '770657988669',
                             '770657988677',
                             '770657988685',
                             '770657988731',
                             '770657988847',
                             '770657989355',
                             '770657989363',
                             '770657989460',
                             '770657989720',
                             '770657990094',
                             '770657990108',
                             '770657990620',
                             '770657990655',
                             '770657990663',
                             '770657997404',
                             '770657997870',
                             '770657999695',
                             '770658023543',
                             '770658023578',
                             '770658023586',
                             '770658023594',
                             '770658023608',
                             '770658122070',
                             '770658144057',
                             '770658145096',
                             '770658145100',
                             '770658162802',
                             '770658163760',
                             '770658165380',
                             '770658165399',
                             '770658166360',
                             '770658166670',
                             '770658177273',
                             '770658177290',
                             '770658177540',
                             '770658177907',
                             '770658177915',
                             '770658177923',
                             '770658178008',
                             '770658178016',
                             '770658178024',
                             '770658178580',
                             '770658178598',
                             '770658178601',
                             '770658178610',
                             '770658179420',
                             '770658179519',
                             '770658179659',
                             '770658179667',
                             '770658179950',
                             '770658179985',
                             '770658179993',
                             '770658180134',
                             '770658180142',
                             '770658180150',
                             '770658180169',
                             '770658180754',
                             '770658180800',
                             '770658244299',
                             '770658257404',
                             '770658257420',
                             '770658257439',
                             '770658257447',
                             '770658264206',
                             '770658273469',
                             '770658367641',
                             '770658367650',
                             '770658367668',
                             '770658367676')
      GROUP BY p.cdcooper, p.nrcpfcgc
      UNION
      SELECT p.cdcooper, p.nrcpfcgc
        FROM CECRED.tbseg_prestamista2 p
       WHERE p.cdcooper = pr_cdcooper
         AND p.nrproposta IN ('770658367684',
                              '770658370502',
                              '770658491920',
                              '770658500414',
                              '770658509101',
                              '770658509110',
                              '770658509128',
                              '770658524780',
                              '770658641760')
      GROUP BY p.cdcooper, p.nrcpfcgc;
            
  CURSOR cr_cpf2(pr_cdcooper IN CECRED.tbseg_prestamista.cdcooper%TYPE) IS
      SELECT p.cdcooper, p.nrcpfcgc
        FROM CECRED.tbseg_prestamista3 p
       WHERE p.cdcooper = pr_cdcooper
         AND p.tpregist <> 0
         AND p.nrproposta IN ('770349902451',
                              '770349837889',
                              '770349837870',
                              '770349837897',
                              '770349837900',
                              '770349743132',
                              '770349743159',
                              '770349743140',
                              '770349845709',
                              '770349845695',
                              '770349845687',
                              '770350460209',
                              '770350261087',
                              '770657391220',
                              '770657391247',
                              '770657391255',
                              '770358384773',
                              '770355328600',
                              '770355328619',                                    
                              '770573393600',
                              '770657195880')
      GROUP BY p.cdcooper, p.nrcpfcgc;
        
  CURSOR cr_nrproposta(pr_cdcooper   IN CECRED.tbseg_prestamista.cdcooper%TYPE
                      ,pr_nrproposta IN CECRED.tbseg_prestamista.nrproposta%TYPE) IS
     SELECT p.nrproposta
       FROM CECRED.tbseg_prestamista2 p
      WHERE p.cdcooper = pr_cdcooper            
        AND p.nrproposta = pr_nrproposta
        AND p.nrproposta IN ('770349015447',
                             '770349030268',
                             '770349060043',
                             '770349083175',
                             '770349136880',
                             '770349136899',
                             '770349136902',
                             '770349136910',
                             '770349136929',
                             '770349155362',
                             '770349164256',
                             '770349164264',
                             '770349559307',
                             '770349559315',
                             '770349687453',
                             '770349687461',
                             '770349742292',
                             '770349742306',
                             '770349748800',
                             '770349748819',
                             '770349748827',
                             '770349771837',
                             '770349771853',
                             '770349771861',
                             '770349771870',
                             '770349771888',
                             '770349771926',
                             '770349782138',
                             '770349782146',
                             '770349817160',
                             '770349817179',
                             '770349817187',
                             '770349841126',
                             '770349841134',
                             '770349841142',
                             '770349876205',
                             '770349876213',
                             '770349907844',
                             '770349908930',
                             '770349912732',
                             '770349912740',
                             '770349930870',
                             '770349932733',
                             '770349932741',
                             '770349939401',
                             '770350093699',
                             '770350105280',
                             '770350111336',
                             '770350115374',
                             '770350124853',
                             '770350132961',
                             '770350141677',
                             '770350142045',
                             '770350178937',
                             '770350183213',
                             '770350191895',
                             '770350191909',
                             '770350199748',
                             '770350206868',
                             '770350207449',
                             '770350207465',
                             '770350219277',
                             '770350219285',
                             '770350219293',
                             '770350230033',
                             '770350230076',
                             '770350238450',
                             '770350238468',
                             '770350247211',
                             '770350267310',
                             '770350267328',
                             '770350272763',
                             '770350336028',
                             '770350344233',
                             '770350361979',
                             '770350361995',
                             '770350362010',
                             '770350390553',
                             '770350390570',
                             '770350453890',
                             '770350470069',
                             '770350470077',
                             '770350470085',
                             '770350470093',
                             '770350470107',
                             '770350470115',
                             '770350480366',
                             '770350480374',
                             '770350506314',
                             '770350506349',
                             '770350506357',
                             '770350544569',
                             '770350590692',
                             '770350591001',
                             '770350594132',
                             '770350612335',
                             '770350885269',
                             '770350942254',
                             '770351041790',
                             '770351181184',
                             '770351200898',
                             '770351226064',
                             '770351312920',
                             '770351312955',
                             '770351325240',
                             '770351325267',
                             '770351343982',
                             '770351417560',
                             '770351643862',
                             '770351670932',
                             '770351670940',
                             '770351670959',
                             '770351670967',
                             '770351670975',
                             '770351670983',
                             '770351670991',
                             '770351671009',
                             '770351671017',
                             '770351671343',
                             '770351699434',
                             '770351734612',
                             '770351824670',
                             '770351824697',
                             '770351858990',
                             '770351883669',
                             '770351931485',
                             '770351931493',
                             '770351973862',
                             '770352055450',
                             '770352055522',
                             '770352056065',
                             '770352062170',
                             '770352132730',
                             '770352234346',
                             '770352315338',
                             '770352318531',
                             '770352318817',
                             '770352368008',
                             '770352382922',
                             '770352382930',
                             '770352486493',
                             '770352489433',
                             '770352543020',
                             '770352596701',
                             '770352651109',
                             '770352652237',
                             '770352652245',
                             '770352652253',
                             '770352657522',
                             '770352727016',
                             '770353072560',
                             '770353095250',
                             '770353102494',
                             '770353118811',
                             '770353118820',
                             '770353118838',
                             '770353118846',
                             '770353118854',
                             '770353127055',
                             '770353127063',
                             '770353148494',
                             '770353149202',
                             '770353335421',
                             '770353346105',
                             '770353396668',
                             '770353396749',
                             '770353407406',
                             '770353407414',
                             '770353407422',
                             '770353412965',
                             '770353426311',
                             '770353484443',
                             '770353507842',
                             '770353512617',
                             '770353641000',
                             '770353668323',
                             '770353668358',
                             '770353668366',
                             '770353669729',
                             '770353768441',
                             '770353784978',
                             '770353831941',
                             '770353832107',
                             '770353850334',
                             '770353865242',
                             '770353872451',
                             '770353899155',
                             '770353899163',
                             '770353913085',
                             '770354014386',
                             '770354028638',
                             '770354123207',
                             '770354164884',
                             '770354185148',
                             '770354200120',
                             '770354220130',
                             '770354220148',
                             '770354220253',
                             '770354232260',
                             '770354261758',
                             '770354293234',
                             '770354294575',
                             '770354319829',
                             '770354374471',
                             '770354435993',
                             '770354436000',
                             '770354455374',
                             '770354483459',
                             '770354483475',
                             '770354490668',
                             '770354516454',
                             '770354523906',
                             '770354523914',
                             '770354523922',
                             '770354523930',
                             '770354525380',
                             '770354525399',
                             '770354525402',
                             '770354534096',
                             '770354540002',
                             '770354540010',
                             '770354548399',
                             '770354548402',
                             '770354548410',
                             '770354548429',
                             '770354548437',
                             '770354555646',
                             '770354555662',
                             '770354589842',
                             '770354589850',
                             '770354589869',
                             '770354589877',
                             '770354589885',
                             '770354596784',
                             '770354596792',
                             '770354596806',
                             '770354596814',
                             '770354605015',
                             '770354605023',
                             '770354605031',
                             '770354605040',
                             '770354612780',
                             '770354613190',
                             '770354613204',
                             '770354613212',
                             '770354613220',
                             '770354649438',
                             '770354688948',
                             '770354688956',
                             '770354688964',
                             '770354688972',
                             '770354688980',
                             '770354688999',
                             '770354701561',
                             '770354709392',
                             '770354719584',
                             '770354719592',
                             '770354719606',
                             '770354720825',
                             '770354720833',
                             '770354720841',
                             '770354721236',
                             '770354721244',
                             '770354721287',
                             '770354721295',
                             '770354721783',
                             '770354721791',
                             '770354721902',
                             '770354721910',
                             '770354723301',
                             '770354723352',
                             '770354826011',
                             '770354826020',
                             '770354847655',
                             '770354847663',
                             '770354847671',
                             '770354875071',
                             '770354898268',
                             '770354969696',
                             '770354969700',
                             '770354970090',
                             '770354977176',
                             '770354977184',
                             '770354977192',
                             '770354977206',
                             '770354982080',
                             '770355002209',
                             '770355028356',
                             '770355028364',
                             '770355028372',
                             '770355038637',
                             '770355038645',
                             '770355073190',
                             '770355092623',
                             '770355133885',
                             '770355194914',
                             '770355194922',
                             '770355194930',
                             '770355194949',
                             '770355194957',
                             '770355198863',
                             '770355202070',
                             '770355202089',
                             '770355202097',
                             '770355202100',
                             '770355202623',
                             '770355202640',
                             '770355202658',
                             '770355202666',
                             '770355202674',
                             '770355219453',
                             '770355227448',
                             '770355227618',
                             '770355241840',
                             '770355241858',
                             '770355256383',
                             '770355256391',
                             '770355256405',
                             '770355256413',
                             '770355259552',
                             '770355267580',
                             '770355267598',
                             '770355267610',
                             '770355267628',
                             '770355275418',
                             '770355277275',
                             '770355277283',
                             '770355277291',
                             '770355277305',
                             '770355277313',
                             '770355277321',
                             '770355277330',
                             '770355277348',
                             '770355277356',
                             '770355305686',
                             '770355351688',
                             '770355374521',
                             '770355374530',
                             '770355374548',
                             '770355374556',
                             '770355374564',
                             '770355374572',
                             '770355461572',
                             '770355491625',
                             '770355526062',
                             '770355526089',
                             '770355533026',
                             '770355533042',
                             '770355533921',
                             '770355549887',
                             '770355549895',
                             '770355603784',
                             '770355603792',
                             '770355603806',
                             '770355609740',
                             '770355618250',
                             '770355618269',
                             '770355618277',
                             '770355618285',
                             '770355681289',
                             '770355683192',
                             '770355683265',
                             '770355683273',
                             '770355750337',
                             '770355815226',
                             '770355816583',
                             '770355816591',
                             '770355818497',
                             '770355830780',
                             '770355830942',
                             '770355830950',
                             '770355843360',
                             '770355846814',
                             '770355846822',
                             '770355846830',
                             '770355850676',
                             '770355870243',
                             '770355870251',
                             '770355870260',
                             '770355921557',
                             '770355960145',
                             '770355960153',
                             '770355960161',
                             '770355960170',
                             '770355964043',
                             '770355992349',
                             '770356014847',
                             '770356014863',
                             '770356014880',
                             '770356016548',
                             '770356016599',
                             '770356020707',
                             '770356021150',
                             '770356021169',
                             '770356021177',
                             '770356021185',
                             '770356023773',
                             '770356023781',
                             '770356023790',
                             '770356083180',
                             '770356083202',
                             '770356130456',
                             '770356135636',
                             '770356135644',
                             '770356137442',
                             '770356140265',
                             '770356159233',
                             '770356159748',
                             '770356173678',
                             '770356186974',
                             '770356186982',
                             '770356186990',
                             '770356187008',
                             '770356187016',
                             '770356187024',
                             '770356247787',
                             '770356255690',
                             '770356256824',
                             '770356276000',
                             '770356313208',
                             '770356398556',
                             '770356398637',
                             '770356426363',
                             '770356487761',
                             '770356494350',
                             '770356494369',
                             '770356496434',
                             '770356544846',
                             '770356544854',
                             '770356591437',
                             '770356656059',
                             '770356693094',
                             '770356724410',
                             '770356751906',
                             '770356751914',
                             '770356763416',
                             '770356771575',
                             '770356777824',
                             '770356780264',
                             '770356823133',
                             '770356841492',
                             '770356841506',
                             '770356841514',
                             '770356841522',
                             '770356841549',
                             '770356841565',
                             '770356841573',
                             '770356841581',
                             '770356841603',
                             '770356841611',
                             '770356841620',
                             '770356946626',
                             '770356993748',
                             '770356993756',
                             '770356993764',
                             '770356993772',
                             '770356993780',
                             '770356993799',
                             '770356993802',
                             '770356998960',
                             '770357006120',
                             '770357006139',
                             '770357007070',
                             '770357007097',
                             '770357038693',
                             '770357038707',
                             '770357068720',
                             '770357080525',
                             '770357094429',
                             '770357094437',
                             '770357114659',
                             '770357114675',
                             '770357146526',
                             '770357146534',
                             '770357221617',
                             '770357241367',
                             '770357274753',
                             '770357279283',
                             '770357288819',
                             '770357288827',
                             '770357307554',
                             '770357307899',
                             '770357308585',
                             '770357334276',
                             '770357334675',
                             '770357334683',
                             '770357393787',
                             '770357394821',
                             '770357394830',
                             '770357394848',
                             '770357430526',
                             '770357430534',
                             '770357457998',
                             '770357503167',
                             '770357508630',
                             '770357508649',
                             '770357508657',
                             '770357508665',
                             '770357513707',
                             '770357518571',
                             '770357518580',
                             '770357522803',
                             '770357522811',
                             '770357528038',
                             '770357535719',
                             '770357535727',
                             '770357535735',
                             '770357535743',
                             '770357542596',
                             '770357543045',
                             '770357608503',
                             '770357608511',
                             '770357626420',
                             '770357627001',
                             '770357656826',
                             '770357663520',
                             '770357663539',
                             '770357714737',
                             '770357725755',
                             '770357734762',
                             '770357748070',
                             '770357780055',
                             '770357791383',
                             '770357809886',
                             '770357814545',
                             '770357821789',
                             '770357824478',
                             '770357844819',
                             '770357870194',
                             '770357895600',
                             '770357919398',
                             '770357927390',
                             '770357943760',
                             '770357943779',
                             '770357943787',
                             '770357953561',
                             '770357973031',
                             '770357973040',
                             '770357973058',
                             '770357997445',
                             '770358021387',
                             '770358021395',
                             '770358049583',
                             '770358178782',
                             '770358198872',
                             '770358218830',
                             '770358218849',
                             '770358218857',
                             '770358218865',
                             '770358226884',
                             '770358268250',
                             '770358268269',
                             '770358295444',
                             '770358310699',
                             '770358310702',
                             '770358310710',
                             '770358310737',
                             '770358310745',
                             '770358310753',
                             '770358310770',
                             '770358366406',
                             '770358368824',
                             '770358370950',
                             '770358370969',
                             '770358370977',
                             '770358370985',
                             '770358381502',
                             '770358423051',
                             '770358428568',
                             '770358437710',
                             '770358437788',
                             '770358437796',
                             '770358438253',
                             '770358438261',
                             '770358438288',
                             '770358438296',
                             '770358438300',
                             '770358438318',
                             '770358448984',
                             '770358531911',
                             '770358551564',
                             '770358602177',
                             '770358635067',
                             '770358635075',
                             '770358635903',
                             '770358635938',
                             '770358635946',
                             '770358651526',
                             '770358651534',
                             '770358688462',
                             '770358688489',
                             '770358688497',
                             '770358688500',
                             '770358688527',
                             '770358688535',
                             '770358688560',
                             '770358688586',
                             '770358698093',
                             '770358698123',
                             '770358703267',
                             '770358703291',
                             '770358703305',
                             '770358703313',
                             '770358703321',
                             '770358703860',
                             '770358731597',
                             '770358736319',
                             '770358736327',
                             '770358743153',
                             '770358770495',
                             '770358771980',
                             '770358827713',
                             '770358836194',
                             '770358836224',
                             '770358836232',
                             '770358836240',
                             '770358836828',
                             '770358836836',
                             '770358836844',
                             '770358836852',
                             '770358836860',
                             '770358839266',
                             '770358911323',
                             '770358968309',
                             '770358975453',
                             '770358975470',
                             '770358991009',
                             '770358991017',
                             '770358991033',
                             '770359019920',
                             '770359019939',
                             '770359115806',
                             '770359162677',
                             '770359165900',
                             '770359165927',
                             '770359165935',
                             '770359165943',
                             '770359178506',
                             '770359178514',
                             '770359178522',
                             '770359178530',
                             '770359180640',
                             '770359180659',
                             '770359180667',
                             '770359286902',
                             '770359367384',
                             '770359380747',
                             '770359390998',
                             '770359419716',
                             '770359453892',
                             '770359453914',
                             '770359453922',
                             '770359453930',
                             '770359506481',
                             '770359516371',
                             '770359538570',
                             '770359574304',
                             '770359586868',
                             '770359633033',
                             '770359639317',
                             '770359639325',
                             '770359639333',
                             '770359639341',
                             '770359652232',
                             '770359710070',
                             '770359742800',
                             '770359743408',
                             '770359850271',
                             '770359867573',
                             '770572841952',
                             '770572841960',
                             '770572841979',
                             '770572841987',
                             '770572851087',
                             '770572851095',
                             '770572883124',
                             '770572891909',
                             '770572892085',
                             '770572903001',
                             '770572909581',
                             '770572909590',
                             '770572909603',
                             '770572909611',
                             '770572920127',
                             '770572920135',
                             '770572920143',
                             '770572943488',
                             '770572950344',
                             '770572950360',
                             '770572950379',
                             '770572950387',
                             '770572950395',
                             '770572965902',
                             '770573020383',
                             '770573020391',
                             '770573020405',
                             '770573020413',
                             '770573039947',
                             '770573070216',
                             '770573093402',
                             '770573093801',
                             '770573093844',
                             '770573143540',
                             '770573149378',
                             '770573149386',
                             '770573149394',
                             '770573149483',
                             '770573241398',
                             '770573241401',
                             '770573241410',
                             '770573241428',
                             '770573258460',
                             '770573273400',
                             '770573273419',
                             '770573273427',
                             '770573273435',
                             '770573273443',
                             '770573273451',
                             '770573289390',
                             '770573310985',
                             '770573323459',
                             '770573338952',
                             '770573338960',
                             '770573338979',
                             '770573338987',
                             '770573355199',
                             '770573355202',
                             '770573355237',
                             '770573454901',
                             '770573469089',
                             '770573469160',
                             '770573490770',
                             '770573504593',
                             '770573504607',
                             '770573521757',
                             '770573521781',
                             '770573532775',
                             '770573540670',
                             '770573554604',
                             '770573574559',
                             '770573574567',
                             '770573574575',
                             '770573574583',
                             '770573574591',
                             '770573592590',
                             '770573592603',
                             '770573592611',
                             '770573598555',
                             '770573601920',
                             '770573602536',
                             '770573612566',
                             '770573612680',
                             '770573612698',
                             '770573612701',
                             '770573617355',
                             '770573617363',
                             '770573617371',
                             '770573617380',
                             '770573617398',
                             '770573617401',
                             '770573623398',
                             '770573654102',
                             '770573677919',
                             '770573698703',
                             '770573721012',
                             '770573778669',
                             '770573785380',
                             '770573816684',
                             '770573816692',
                             '770573821343',
                             '770612776261',
                             '770612776270',
                             '770612776288',
                             '770612825513',
                             '770612848220',
                             '770612872503',
                             '770612873291',
                             '770612890145',
                             '770612890161',
                             '770612891168',
                             '770612891176',
                             '770612891192',
                             '770612981523',
                             '770613030409',
                             '770613063161',
                             '770613063170',
                             '770613063196',
                             '770613063200',
                             '770613063218',
                             '770613063226',
                             '770613063234',
                             '770613063242',
                             '770613063250',
                             '770613090150',
                             '770613092676',
                             '770613116575',
                             '770613130543',
                             '770613208909',
                             '770613241779',
                             '770613244352',
                             '770613244360',
                             '770613244379',
                             '770613244409',
                             '770613244417',
                             '770613244719',
                             '770613244727',
                             '770613283420',
                             '770613283439',
                             '770613304550',
                             '770613304568',
                             '770613304576',
                             '770613304584',
                             '770613304592',
                             '770613304606',
                             '770613305068',
                             '770613312153',
                             '770613313761',
                             '770613314148',
                             '770613314156',
                             '770613314164',
                             '770613314172',
                             '770613331107',
                             '770613344470',
                             '770613365737',
                             '770613365745',
                             '770613365753',
                             '770613365761',
                             '770613375627',
                             '770613376070',
                             '770613376089',
                             '770613376097',
                             '770613390871',
                             '770613390880',
                             '770613390901',
                             '770613390910',
                             '770613390928',
                             '770613390944',
                             '770613390952',
                             '770613540385',
                             '770613547975',
                             '770613561269',
                             '770613561277',
                             '770613561285',
                             '770613561293',
                             '770613561307',
                             '770613561889',
                             '770613561897',
                             '770613640827',
                             '770613652132',
                             '770613653147',
                             '770613653198',
                             '770613653201',
                             '770613654160',
                             '770613654178',
                             '770613654186',
                             '770613688625',
                             '770613719334',
                             '770613719342',
                             '770613726330',
                             '770613726780',
                             '770613726802',
                             '770613752242',
                             '770613755535',
                             '770613755560',
                             '770613755578',
                             '770613766170',
                             '770657223999',
                             '770657224014',
                             '770657224022',
                             '770657224030',
                             '770657262978',
                             '770657263486',
                             '770657292699',
                             '770657292931',
                             '770657292940',
                             '770657292958',
                             '770657292966',
                             '770657293024',
                             '770657293032',
                             '770657293040',
                             '770657294918',
                             '770657296074',
                             '770657296082',
                             '770657299901',
                             '770657300500',
                             '770657300519',
                             '770657300527',
                             '770657300535',
                             '770657305880',
                             '770657305898',
                             '770657305901',
                             '770657325104',
                             '770657325112',
                             '770657325120',
                             '770657456179',
                             '770657456187',
                             '770657456195',
                             '770657467448',
                             '770657476994',
                             '770657478504',
                             '770657478512',
                             '770657494240',
                             '770657503681',
                             '770657503690',
                             '770657503711',
                             '770657503754',
                             '770657594083',
                             '770657711764',
                             '770657711810',
                             '770657711829',
                             '770657711837',
                             '770657711845',
                             '770657726745',
                             '770657783676',
                             '770657788392',
                             '770657809926',
                             '770657815500',
                             '770657829277',
                             '770657829307',
                             '770657829315',
                             '770657829323',
                             '770657829340',
                             '770657888729',
                             '770657972940',
                             '770657988405',
                             '770657988502',
                             '770657988510',
                             '770657988529',
                             '770657988650',
                             '770657988669',
                             '770657988677',
                             '770657988685',
                             '770657988731',
                             '770657988847',
                             '770657989355',
                             '770657989363',
                             '770657989460',
                             '770657989720',
                             '770657990094',
                             '770657990108',
                             '770657990620',
                             '770657990655',
                             '770657990663',
                             '770657997404',
                             '770657997870',
                             '770657999695',
                             '770658023543',
                             '770658023578',
                             '770658023586',
                             '770658023594',
                             '770658023608',
                             '770658122070',
                             '770658144057',
                             '770658145096',
                             '770658145100',
                             '770658162802',
                             '770658163760',
                             '770658165380',
                             '770658165399',
                             '770658166360',
                             '770658166670',
                             '770658177273',
                             '770658177290',
                             '770658177540',
                             '770658177907',
                             '770658177915',
                             '770658177923',
                             '770658178008',
                             '770658178016',
                             '770658178024',
                             '770658178580',
                             '770658178598',
                             '770658178601',
                             '770658178610',
                             '770658179420',
                             '770658179519',
                             '770658179659',
                             '770658179667',
                             '770658179950',
                             '770658179985',
                             '770658179993',
                             '770658180134',
                             '770658180142',
                             '770658180150',
                             '770658180169',
                             '770658180754',
                             '770658180800',
                             '770658244299',
                             '770658257404',
                             '770658257420',
                             '770658257439',
                             '770658257447',
                             '770658264206',
                             '770658273469',
                             '770658367641',
                             '770658367650',
                             '770658367668',
                             '770658367676')
      UNION ALL
      SELECT p.nrproposta
        FROM CECRED.tbseg_prestamista2 p
       WHERE p.cdcooper = pr_cdcooper
         AND p.nrproposta = pr_nrproposta
         AND p.nrproposta IN ('770658367684',
                              '770658370502',
                              '770658491920',
                              '770658500414',
                              '770658509101',
                              '770658509110',
                              '770658509128',
                              '770658524780',
                              '770658641760');
  rw_nrproposta cr_nrproposta%ROWTYPE;
        
  CURSOR cr_nrproposta2(pr_cdcooper   IN CECRED.tbseg_prestamista.cdcooper%TYPE
                       ,pr_nrproposta IN CECRED.tbseg_prestamista.nrproposta%TYPE) IS
     SELECT p.nrproposta
       FROM CECRED.tbseg_prestamista3 p
      WHERE p.cdcooper = pr_cdcooper            
        AND p.nrproposta = pr_nrproposta
        AND p.nrproposta IN ('770349902451',
                             '770349837889',
                             '770349837870',
                             '770349837897',
                             '770349837900',
                             '770349743132',
                             '770349743159',
                             '770349743140',
                             '770349845709',
                             '770349845695',
                             '770349845687',
                             '770350460209',
                             '770350261087',
                             '770657391220',
                             '770657391247',
                             '770657391255',
                             '770358384773',
                             '770355328600',
                             '770355328619',
                             '770573393600',
                             '770657195880');     
  rw_nrproposta2 cr_nrproposta2%ROWTYPE;
        
  CURSOR cr_prestamista(pr_cdcooper IN CECRED.crapcop.cdcooper%TYPE,
                        pr_vlminimo IN NUMBER,
                        pr_idadelim IN NUMBER,
                        pr_dtmvtolt IN DATE,
                        pr_nrcpfcgc IN CECRED.tbseg_prestamista.nrcpfcgc%TYPE) IS
    SELECT p.idseqtra
          ,p.cdcooper
          ,p.nrdconta
          ,ass.cdagenci
          ,p.nrctrseg
          ,p.tpregist
          ,p.cdapolic
          ,p.nrcpfcgc
          ,p.nmprimtl
          ,p.dtnasctl
          ,p.cdsexotl
          ,p.dsendres
          ,p.dsdemail
          ,p.nmbairro
          ,p.nmcidade
          ,p.cdufresd
          ,p.nrcepend
          ,p.nrtelefo
          ,p.dtdevend
          ,p.dtdenvio
          ,p.dtrefcob
          ,p.dtinivig
          ,p.nrctremp
          ,p.cdcobran
          ,p.cdadmcob
          ,p.tpfrecob
          ,p.tpsegura
          ,p.cdplapro
          ,p.vlprodut
          ,p.tpcobran
          ,p.vlsdeved
          ,p.vldevatu
          ,p.dtfimvig
          ,c.inliquid
          ,c.dtmvtolt data_emp
          ,p.nrproposta
          ,lpad(decode(p.cdcooper , 5,1, 7,2, 10,3,  11,4, 14,5, 9,6, 16,7, 2,8, 8,9, 6,10, 12,11, 13,12, 1,13  )   ,6,'0') cdcooperativa
          ,SUM (
             CASE 
               WHEN (TRUNC(p.dtinivig) >= vr_dtmvtolt AND p.tpregist = 1) THEN
                 0
               WHEN (p.vlsdeved >= pr_vlminimo AND p.tpregist = 2 AND p.vldevatu > 0 AND
                    (TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) > pr_idadelim OR 
                     TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) < 14))THEN
                 0
               WHEN (p.idseqtra <> (SELECT MAX(t.idseqtra) 
                                      FROM CECRED.tbseg_prestamista2 t
                                     WHERE t.cdcooper = p.cdcooper
                                       AND t.nrdconta = p.nrdconta
                                       AND t.nrctremp = p.nrctremp
                                       AND TRUNC(t.dtinivig) < vr_dtmvtolt
                                       AND t.tpregist <> 0
                                       AND t.tpcustei = 1)) THEN
                 0  
               ELSE                
                 p.vldevatu                       
               END) over(partition by  p.cdcooper, p.nrcpfcgc ) saldo_cpf             
                
          ,ADD_MONTHS(c.dtmvtolt, c.qtpreemp)  dtfimctr
          ,s.cdsitseg
          ,s.dtcancel
      FROM CECRED.tbseg_prestamista2 p, CECRED.crapepr c, CECRED.crapass ass, CECRED.crapseg s
     WHERE p.cdcooper = pr_cdcooper  
       AND c.cdcooper = p.cdcooper
       AND c.nrdconta = p.nrdconta
       AND c.nrctremp = p.nrctremp             
       AND ass.cdcooper = c.cdcooper
       AND ass.nrdconta = c.nrdconta
       AND p.cdcooper = s.cdcooper
       AND p.nrdconta = s.nrdconta
       AND p.nrctrseg = s.nrctrseg
       AND TRUNC(p.dtinivig) < vr_dtmvtolt
       AND p.tpregist <> 0      
       AND p.tpcustei = 1 
       AND p.nrcpfcgc = pr_nrcpfcgc
       ORDER BY p.nrcpfcgc ASC , p.dtinivig, p.nrctremp;
        
  CURSOR cr_prestamista2(pr_cdcooper IN CECRED.crapcop.cdcooper%TYPE,
                        pr_vlminimo IN NUMBER,
                        pr_idadelim IN NUMBER,
                        pr_dtmvtolt IN DATE) IS
    SELECT p.idseqtra
          ,p.cdcooper
          ,p.nrdconta
          ,ass.cdagenci
          ,p.nrctrseg
          ,p.tpregist
          ,p.cdapolic
          ,p.nrcpfcgc
          ,p.nmprimtl
          ,p.dtnasctl
          ,p.cdsexotl
          ,p.dsendres
          ,p.dsdemail
          ,p.nmbairro
          ,p.nmcidade
          ,p.cdufresd
          ,p.nrcepend
          ,p.nrtelefo
          ,p.dtdevend
          ,p.dtdenvio
          ,p.dtrefcob
          ,p.dtinivig
          ,p.nrctremp
          ,p.cdcobran
          ,p.cdadmcob
          ,p.tpfrecob
          ,p.tpsegura
          ,p.cdplapro
          ,p.vlprodut
          ,p.tpcobran
          ,p.vlsdeved
          ,p.vldevatu
          ,p.dtfimvig
          ,c.inliquid
          ,c.dtmvtolt data_emp
          ,p.nrproposta
          ,lpad(decode(p.cdcooper , 5,1, 7,2, 10,3,  11,4, 14,5, 9,6, 16,7, 2,8, 8,9, 6,10, 12,11, 13,12, 1,13  )   ,6,'0') cdcooperativa
          ,SUM (
             CASE 
               WHEN (TRUNC(p.dtinivig) >= vr_dtmvtolt AND p.tpregist = 1) THEN
                 0
               WHEN (p.vlsdeved >= pr_vlminimo AND p.tpregist = 2 AND p.vldevatu > 0 AND
                    (TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) > pr_idadelim OR 
                     TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) < 14))THEN
                 0
               WHEN (p.idseqtra <> (SELECT MAX(t.idseqtra) 
                                      FROM CECRED.tbseg_prestamista t
                                     WHERE t.cdcooper = p.cdcooper
                                       AND t.nrdconta = p.nrdconta
                                       AND t.nrctremp = p.nrctremp
                                       AND TRUNC(t.dtinivig) < vr_dtmvtolt
                                       AND t.tpregist <> 0
                                       AND t.tpcustei = 1)) THEN
                 0  
               ELSE                
                 p.vldevatu                       
               END) over(partition by  p.cdcooper, p.nrcpfcgc ) saldo_cpf             
                
          ,ADD_MONTHS(c.dtmvtolt, c.qtpreemp)  dtfimctr
          ,s.cdsitseg
          ,s.dtcancel
      FROM CECRED.tbseg_prestamista p, CECRED.crapepr c, CECRED.crapass ass, CECRED.crapseg s
     WHERE p.cdcooper = pr_cdcooper  
       AND c.cdcooper = p.cdcooper
       AND c.nrdconta = p.nrdconta
       AND c.nrctremp = p.nrctremp             
       AND ass.cdcooper = c.cdcooper
       AND ass.nrdconta = c.nrdconta
       AND p.cdcooper = s.cdcooper
       AND p.nrdconta = s.nrdconta
       AND p.nrctrseg = s.nrctrseg  
       AND p.tpcustei = 1 
       AND p.nrproposta in ('770657292818',
'770573595920',
'770657292982',
'770657292990',
'770352083178',
'770657293059',
'770349989417',
'770352390470',
'770356564049',
'770358826768',
'770358826776',
'770358826784',
'770358826792',
'770358929257',
'770354337681',
'770355314944',
'770355640477',
'770355314928',
'770355314936',
'770657293822',
'770657293830',
'770357926998',
'770350323376',
'770350323384',
'770357968399',
'770357393302',
'770357006660',
'770357006686',
'770657294179',
'770657294152',
'770657294160',
'770356303342',
'770356303369',
'770356303377',
'770356303326',
'770356857674',
'770657294411',
'770657294420',
'770354697947',
'770573542010',
'770573542029',
'770573542037',
'770657294802',
'770355651240',
'770657295051',
'770657295060',
'770657295086',
'770657295094',
'770353639846',
'770353619365',
'770353618458',
'770355360350',
'770355360369',
'770355359492',
'770657295868',
'770349672421',
'770349672464',
'770613449663',
'770572961516',
'770356894995',
'770356895010',
'770356894987',
'770613110348',
'770359353057',
'770359353065',
'770352627631',
'770356499620',
'770356499611',
'770356130863',
'770657389927',
'770657390321',
'770657390330',
'770613653961',
'770613653970',
'770613653988',
'770355275949',
'770359313144',
'770359313152',
'770358593712',
'770657390976',
'770358285554',
'770358285562',
'770358285570',
'770358285589',
'770358285937',
'770355306828',
'770357387396',
'770357387400',
'770356857933',
'770657391190',
'770657391204',
'770613191917',
'770612892610',
'770612892628',
'770612892636',
'770612892644',
'770612892652',
'770612892660',
'770350586067',
'770350241906',
'770354144433',
'770350427279',
'770350427287',
'770350427309',
'770350417516',
'770351331976',
'770356998731',
'770350468412',
'770356998740',
'770356998758',
'770356998766',
'770356998774',
'770356998782',
'770356892445',
'770350507906',
'770350507914',
'770350507922',
'770613002359',
'770613002340',
'770657789410',
'770657391816',
'770657391824',
'770657391832',
'770349792176',
'770350139001',
'770351823143',
'770657391913',
'770354299887',
'770354299895',
'770354299879',
'770354299917',
'770354299941',
'770354299950',
'770350895361',
'770350832920',
'770350833099',
'770349943727',
'770349943735',
'770349941856',
'770349790106',
'770349790114',
'770349790122',
'770349790130',
'770349790149',
'770349067633',
'770354900831',
'770354900840',
'770354958643',
'770657636894',
'770354276909',
'770354276895',
'770357799112',
'770573275888',
'770572898180',
'770613244883',
'770613244891',
'770355334317',
'770355334236',
'770354721589',
'770354721597',
'770354721600',
'770354721619',
'770354721627',
'770354721635',
'770354721643',
'770355325300',
'770657456500',
'770357200750',
'770357200768',
'770357200776',
'770357200784',
'770357081041',
'770357536103',
'770357200857',
'770357200865',
'770357200873',
'770357200881',
'770355413993',
'770355414043',
'770657891584',
'770613491309',
'770613491317',
'770613491325',
'770356359224',
'770356359240',
'770356359259',
'770356359208',
'770356359267',
'770355016013',
'770357186617',
'770357186625',
'770357186633',
'770357166926',
'770357186668',
'770358736408',
'770358736416',
'770358736424',
'770358736394',
'770358343716',
'770358343724',
'770358343732',
'770358343708',
'770357962323',
'770358405860',
'770657813400',
'770657891843',
'770613061070',
'770613061088',
'770613061096',
'770613388117',
'770613283323',
'770350338861',
'770350338942',
'770350338950',
'770350338969',
'770350074651',
'770350074660',
'770350074678',
'770350076018',
'770350076042',
'770350076050',
'770350076069',
'770359292562',
'770358909795',
'770613599312',
'770357485843',
'770357485860',
'770357485827',
'770354977117',
'770356902181',
'770356902190',
'770356011058',
'770573408942',
'770350028609',
'770350028617',
'770350028625',
'770350028633',
'770350028641',
'770350028650',
'770350228845',
'770352613070',
'770657892440',
'770657892459',
'770351750286',
'770351750294',
'770351750308',
'770351750243',
'770573322851',
'770573273931',
'770573273940',
'770573273958',
'770573273966',
'770573273974',
'770657892505',
'770657892513',
'770355782867',
'770355782875',
'770357260779',
'770357260752',
'770356189833',
'770356189850',
'770573811640',
'770573811615',
'770359225385',
'770358282679',
'770356906349',
'770353103954',
'770354806177',
'770354806185',
'770354806169',
'770351841044',
'770359985592',
'770354563487',
'770354563460',
'770354969599',
'770355424103',
'770355424090',
'770355227820',
'770573583671',
'770355052567',
'770359834802',
'770359834810',
'770359020724',
'770359304676',
'770354916592',
'770354916576',
'770572941639',
'770572941647',
'770572941655',
'770572941663',
'770572941671',
'770572941680',
'770572941698',
'770359116497',
'770355938212',
'770355438554',
'770353958640',
'770357875447',
'770357875455',
'770357875463',
'770357875439',
'770354963582',
'770356931670',
'770355706710',
'770353104853',
'770356810490',
'770356810503',
'770356810511',
'770356204484',
'770573730453',
'770354804115',
'770573732979',
'770354313014',
'770358237762',
'770352404110',
'770613587110',
'770355103676',
'770355103684',
'770355103650',
'770355103692',
'770354767864',
'770354807122',
'770355149781',
'770350903798',
'770349097818',
'770355149803',
'770355149811',
'770350462066',
'770573801121',
'770355312127',
'770350102760',
'770350102779',
'770352412457',
'770355227839',
'770351717696',
'770350241710',
'770573519566',
'770356810481',
'770356509625',
'770355328597',
'770355993051',
'770657391212',
'770657391239',
'770355328589')
       ORDER BY p.nrcpfcgc ASC , p.dtinivig, p.nrctremp;

  CURSOR cr_prestamista3(pr_cdcooper IN CECRED.crapcop.cdcooper%TYPE,
                        pr_vlminimo IN NUMBER,
                        pr_idadelim IN NUMBER,
                        pr_dtmvtolt IN DATE,
                        pr_nrcpfcgc IN CECRED.tbseg_prestamista.nrcpfcgc%TYPE) IS
    SELECT p.idseqtra
          ,p.cdcooper
          ,p.nrdconta
          ,ass.cdagenci
          ,p.nrctrseg
          ,p.tpregist
          ,p.cdapolic
          ,p.nrcpfcgc
          ,p.nmprimtl
          ,p.dtnasctl
          ,p.cdsexotl
          ,p.dsendres
          ,p.dsdemail
          ,p.nmbairro
          ,p.nmcidade
          ,p.cdufresd
          ,p.nrcepend
          ,p.nrtelefo
          ,p.dtdevend
          ,p.dtdenvio
          ,p.dtrefcob
          ,p.dtinivig
          ,p.nrctremp
          ,p.cdcobran
          ,p.cdadmcob
          ,p.tpfrecob
          ,p.tpsegura
          ,p.cdplapro
          ,p.vlprodut
          ,p.tpcobran
          ,p.vlsdeved
          ,p.vldevatu
          ,p.dtfimvig
          ,c.inliquid
          ,c.dtmvtolt data_emp
          ,p.nrproposta
          ,lpad(decode(p.cdcooper , 5,1, 7,2, 10,3,  11,4, 14,5, 9,6, 16,7, 2,8, 8,9, 6,10, 12,11, 13,12, 1,13  )   ,6,'0') cdcooperativa
          ,SUM (
             CASE 
               WHEN (TRUNC(p.dtinivig) >= vr_dtmvtolt AND p.tpregist = 1) THEN
                 0
               WHEN (p.vlsdeved >= pr_vlminimo AND p.tpregist = 2 AND p.vldevatu > 0 AND
                    (TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) > pr_idadelim OR 
                     TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) < 14))THEN
                 0
               WHEN (p.idseqtra <> (SELECT MAX(t.idseqtra) 
                                      FROM CECRED.tbseg_prestamista3 t
                                     WHERE t.cdcooper = p.cdcooper
                                       AND t.nrdconta = p.nrdconta
                                       AND t.nrctremp = p.nrctremp
                                       AND TRUNC(t.dtinivig) < vr_dtmvtolt
                                       AND t.tpregist <> 0
                                       AND t.tpcustei = 1)) THEN
                 0  
               ELSE                
                 p.vldevatu                       
               END) over(partition by  p.cdcooper, p.nrcpfcgc ) saldo_cpf             
                
          ,ADD_MONTHS(c.dtmvtolt, c.qtpreemp)  dtfimctr
          ,s.cdsitseg
          ,s.dtcancel
      FROM CECRED.tbseg_prestamista3 p, CECRED.crapepr c, CECRED.crapass ass, CECRED.crapseg s
     WHERE p.cdcooper = pr_cdcooper  
       AND c.cdcooper = p.cdcooper
       AND c.nrdconta = p.nrdconta
       AND c.nrctremp = p.nrctremp             
       AND ass.cdcooper = c.cdcooper
       AND ass.nrdconta = c.nrdconta
       AND p.cdcooper = s.cdcooper
       AND p.nrdconta = s.nrdconta
       AND p.nrctrseg = s.nrctrseg
       AND TRUNC(p.dtinivig) < vr_dtmvtolt
       AND p.tpregist <> 0      
       AND p.tpcustei = 1 
       AND p.nrcpfcgc = pr_nrcpfcgc
       ORDER BY p.nrcpfcgc ASC , p.dtinivig, p.nrctremp;
             
  CURSOR cr_prestamista4(pr_cdcooper IN CECRED.crapcop.cdcooper%TYPE,
                        pr_vlminimo IN NUMBER,
                        pr_idadelim IN NUMBER,
                        pr_dtmvtolt IN DATE) IS
    SELECT p.idseqtra
          ,p.cdcooper
          ,p.nrdconta
          ,ass.cdagenci
          ,p.nrctrseg
          ,p.tpregist
          ,p.cdapolic
          ,p.nrcpfcgc
          ,p.nmprimtl
          ,p.dtnasctl
          ,p.cdsexotl
          ,p.dsendres
          ,p.dsdemail
          ,p.nmbairro
          ,p.nmcidade
          ,p.cdufresd
          ,p.nrcepend
          ,p.nrtelefo
          ,p.dtdevend
          ,p.dtdenvio
          ,p.dtrefcob
          ,p.dtinivig
          ,p.nrctremp
          ,p.cdcobran
          ,p.cdadmcob
          ,p.tpfrecob
          ,p.tpsegura
          ,p.cdplapro
          ,p.vlprodut
          ,p.tpcobran
          ,p.vlsdeved
          ,p.vldevatu
          ,p.dtfimvig
          ,c.inliquid
          ,c.dtmvtolt data_emp
          ,p.nrproposta
          ,lpad(decode(p.cdcooper , 5,1, 7,2, 10,3,  11,4, 14,5, 9,6, 16,7, 2,8, 8,9, 6,10, 12,11, 13,12, 1,13  )   ,6,'0') cdcooperativa
          ,SUM (
             CASE 
               WHEN (TRUNC(p.dtinivig) >= vr_dtmvtolt AND p.tpregist = 1) THEN
                 0
               WHEN (p.vlsdeved >= pr_vlminimo AND p.tpregist = 2 AND p.vldevatu > 0 AND
                    (TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) > pr_idadelim OR 
                     TRUNC(Months_Between(pr_dtmvtolt,p.dtnasctl) /12,0) < 14))THEN
                 0
               WHEN (p.idseqtra <> (SELECT MAX(t.idseqtra) 
                                      FROM CECRED.tbseg_prestamista2 t
                                     WHERE t.cdcooper = p.cdcooper
                                       AND t.nrdconta = p.nrdconta
                                       AND t.nrctremp = p.nrctremp
                                       AND TRUNC(t.dtinivig) < vr_dtmvtolt
                                       AND t.tpregist <> 0
                                       AND t.tpcustei = 1)) THEN
                 0  
               ELSE                
                 p.vldevatu                       
               END) over(partition by  p.cdcooper, p.nrcpfcgc ) saldo_cpf             
                
          ,ADD_MONTHS(c.dtmvtolt, c.qtpreemp)  dtfimctr
          ,s.cdsitseg
          ,s.dtcancel
      FROM CECRED.tbseg_prestamista p, CECRED.crapepr c, CECRED.crapass ass, CECRED.crapseg s
     WHERE p.cdcooper = pr_cdcooper  
       AND c.cdcooper = p.cdcooper
       AND c.nrdconta = p.nrdconta
       AND c.nrctremp = p.nrctremp             
       AND ass.cdcooper = c.cdcooper
       AND ass.nrdconta = c.nrdconta
       AND p.cdcooper = s.cdcooper
       AND p.nrdconta = s.nrdconta
       AND p.nrctrseg = s.nrctrseg     
       AND p.tpcustei = 1
       AND p.idseqtra IN (
567331,
566912,
566936,
565952,
565205,
565691)
       ORDER BY p.nrcpfcgc ASC , p.dtinivig, p.nrctremp;
       
  CURSOR cr_seg_parametro_prst(pr_cdcooper IN CECRED.tbseg_prestamista.cdcooper%TYPE
                              ,pr_tpcustei IN CECRED.tbseg_parametros_prst.tpcustei%TYPE) IS
    SELECT pp.idseqpar,
           pp.tppessoa,
           pp.cdsegura,
           pp.tpcustei,
           pp.nrapolic,
           pp.pagsegu,
           pp.seqarqu,
           pp.enderftp,
           pp.loginftp,
           pp.senhaftp
      FROM CECRED.tbseg_parametros_prst pp
     WHERE pp.cdcooper = pr_cdcooper
       AND pp.tppessoa = 1
       AND pp.cdsegura = CECRED.segu0001.busca_seguradora
       AND pp.tpcustei = pr_tpcustei;
  rw_seg_parametro_prst cr_seg_parametro_prst%ROWTYPE;
        
  CURSOR cr_crapcop IS
    SELECT c.cdcooper
          ,c.nmrescop
          ,d.dtmvtolt
      FROM CECRED.crapcop c,
           CECRED.crapdat d
     WHERE c.flgativo = 1
       AND c.cdcooper IN (1,16)
       AND c.cdcooper <> 3
       AND c.cdcooper = d.cdcooper;
BEGIN
  vr_dtmvtolt := TRUNC(SYSDATE);
        
  CECRED.GENE0001.pc_abre_arquivo(pr_nmdireto => vr_nmdir
                                 ,pr_nmarquiv => vr_nmarq   
                                 ,pr_tipabert => 'W'
                                 ,pr_utlfileh => vr_ind_arquivo_backup
                                 ,pr_des_erro => vr_dscritic);
                                  
  IF vr_dscritic IS NOT NULL THEN         
    RAISE vr_exc_erro;
  END IF;

  CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,'BEGIN');
  FOR rw_crapcop IN cr_crapcop LOOP
    vr_seqtran := 1;
    vr_linha_txt := '';
    vr_nmrescop := rw_crapcop.nmrescop;
    pr_cdcooper := rw_crapcop.cdcooper;
          
    OPEN cr_seg_parametro_prst(pr_cdcooper => rw_crapcop.cdcooper,
                               pr_tpcustei => 1);
      FETCH cr_seg_parametro_prst INTO rw_seg_parametro_prst;        
      IF cr_seg_parametro_prst%NOTFOUND THEN
        CLOSE cr_seg_parametro_prst;
        vr_dscritic := 'Nao foi possivel localizar taxa de pagamento da seguradora. PC_PARAMETROS_PRST';
        RAISE vr_exc_saida;
      END IF;           
    CLOSE cr_seg_parametro_prst;
             
    vr_vlminimo := CECRED.segu0003.fn_capital_seguravel_min(pr_cdcooper => rw_crapcop.cdcooper,
                                                     pr_tppessoa => rw_seg_parametro_prst.tppessoa,
                                                     pr_cdsegura => rw_seg_parametro_prst.cdsegura,
                                                     pr_tpcustei => rw_seg_parametro_prst.tpcustei,
                                                     pr_dtnasc   => TO_DATE('01/01/1990','DD/MM/RRRR'),
                                                     pr_cdcritic => vr_cdcritic,
                                                     pr_dscritic => vr_dscritic);

    vr_vlmaximo := CECRED.segu0003.fn_capital_seguravel_max(pr_cdcooper => rw_crapcop.cdcooper,
                                                     pr_tppessoa => rw_seg_parametro_prst.tppessoa,
                                                     pr_cdsegura => rw_seg_parametro_prst.cdsegura,
                                                     pr_tpcustei => rw_seg_parametro_prst.tpcustei,
                                                     pr_dtnasc   => TO_DATE('01/01/1990','DD/MM/RRRR'),
                                                     pr_cdcritic => vr_cdcritic,
                                                     pr_dscritic => vr_dscritic);
            
    IF vr_dscritic IS NOT NULL THEN            
      RAISE vr_exc_saida;
    END IF;
            
    vr_nrsequen := rw_seg_parametro_prst.seqarqu+ 1;

    vr_apolice  := rw_seg_parametro_prst.nrapolic;
            
    vr_pgtosegu := rw_seg_parametro_prst.pagsegu;
            
    vr_endereco := rw_seg_parametro_prst.enderftp;
    vr_login    := rw_seg_parametro_prst.loginftp;
    vr_senha    := rw_seg_parametro_prst.senhaftp;
            
    BEGIN
      UPDATE CECRED.tbseg_parametros_prst p
         SET p.seqarqu = vr_nrsequen
       WHERE p.idseqpar = rw_seg_parametro_prst.idseqpar;
      COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        vr_cdcritic := 0;
        vr_dscritic := 'Erro ao atualizar sequencia da cooperativa: ' || rw_crapcop.cdcooper || ' - ' || SQLERRM;
        RAISE vr_exc_saida;
    END;
          
    vr_ultimoDia := trunc(SYSDATE,'MONTH')-1;    
          
    vr_nmarquiv := 'AILOS_'||replace(vr_nmrescop,' ','_')||'_'
                 ||REPLACE(to_char(vr_ultimoDia , 'MM/YYYY'), '/', '_') || '_' ||
                   CECRED.gene0002.fn_mask(vr_nrsequen, '99999') || '.txt';                                             
        
    CECRED.GENE0001.pc_abre_arquivo(pr_nmdireto => vr_nmdir
                                   ,pr_nmarquiv => vr_nmarquiv   
                                   ,pr_tipabert => 'W'
                                   ,pr_utlfileh => vr_ind_arquivo
                                   ,pr_des_erro => vr_dscritic);          
                                  
    IF vr_dscritic IS NOT NULL THEN         
      RAISE vr_exc_erro;
    END IF;
        
    vr_contrcpf := NULL;

    FOR rw_cpf IN cr_cpf(pr_cdcooper => rw_crapcop.cdcooper) LOOP
      FOR rw_prestamista IN cr_prestamista(pr_cdcooper => rw_crapcop.cdcooper,
                                           pr_vlminimo => vr_vlminimo,
                                           pr_idadelim => 70,
                                           pr_dtmvtolt => TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR'),
                                           pr_nrcpfcgc => rw_cpf.nrcpfcgc) LOOP

        vr_vlsdeved := rw_prestamista.saldo_cpf;
        vr_vlsdatua := rw_prestamista.vldevatu;
        vr_tpregist := rw_prestamista.tpregist;  
        vr_cdapolic := rw_prestamista.cdapolic;
        vr_nrproposta := nvl(rw_prestamista.nrproposta,0);
        vr_dtdevend := rw_prestamista.dtdevend;
        vr_dtinivig := rw_prestamista.dtinivig;
        vr_dtfimvig := rw_prestamista.dtfimvig;
        vr_flgnvenv := FALSE;
              
        IF rw_prestamista.dtfimvig IS NULL THEN
          vr_dtfimvig := rw_prestamista.dtfimctr;
        END IF;
              
        vr_dtcalcidade:= TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR');
                  
        vr_nrdeanos := TRUNC(Months_Between(vr_dtcalcidade,rw_prestamista.dtnasctl) / 12, 0);
                        
        IF (vr_vlsdeved < vr_vlminimo) THEN
          vr_tpregist := 2;
        END IF;
              
        IF rw_prestamista.cdsitseg <> 2 THEN
          IF vr_tab_ctrl_prst.EXISTS(rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp) THEN
            vr_tpregist:= 2;
          ELSE
            vr_index := rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp;
            vr_tab_ctrl_prst(vr_index).nrcpfcgc := rw_prestamista.nrcpfcgc;
            vr_tab_ctrl_prst(vr_index).nrctremp := rw_prestamista.nrctremp;
          END IF;
        END IF;              
              
        IF vr_contrcpf IS NULL OR vr_contrcpf <> rw_prestamista.nrcpfcgc THEN 
          vr_contrcpf := rw_prestamista.nrcpfcgc;
          vr_vlenviad := vr_vlsdatua;
          vr_vltotenv := vr_vlsdatua;
                
          IF vr_vlenviad > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
            vr_vlenviad := vr_vlmaximo; 
                  
            IF vr_vlenviad <= 0 THEN
              vr_tpregist:= 2;
            END IF;                         
          END IF;  
        ELSE
          vr_vltotenv := vr_vltotenv + vr_vlsdatua;
          IF vr_vltotenv > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
            vr_vlenviad := vr_vlmaximo - (vr_vltotenv - vr_vlsdatua);              
                   
            IF vr_vlenviad <= 0 THEN
              vr_tpregist:= 2;
            END IF;
          ELSE 
            vr_vlenviad := vr_vlsdatua;
          END IF;
        END IF; 
              
        vr_vlprodvl := vr_vlenviad * (vr_pgtosegu/100);
              
        IF vr_vlprodvl < 0.01 THEN
          vr_vlprodvl:= 0.01;
        END IF;  
              
        IF vr_vlenviad < 0.01 THEN
          vr_vlenviad:= 0.01;
        END IF;
              
        OPEN cr_nrproposta(pr_cdcooper   => rw_prestamista.cdcooper
                          ,pr_nrproposta => rw_prestamista.nrproposta);
          FETCH cr_nrproposta INTO rw_nrproposta;
            IF cr_nrproposta%NOTFOUND THEN
              CLOSE cr_nrproposta;
              CONTINUE;
            ELSE
              IF vr_tpregist = 3 THEN
                vr_tpregist := 1;
              END IF;                      
              vr_nrproposta := CECRED.segu0003.fn_nrproposta;
            END IF;
        CLOSE cr_nrproposta;
              
        IF vr_tpregist <> 2 THEN
          vr_linha_txt := '';

          vr_linha_txt := vr_linha_txt || LPAD(vr_seqtran, 5, 0);
          vr_linha_txt := vr_linha_txt || LPAD(vr_tpregist, 2, 0);
          vr_linha_txt := vr_linha_txt || LPAD(vr_apolice, 15, 0);
          vr_linha_txt := vr_linha_txt || RPAD(to_char(rw_prestamista.nrcpfcgc,'fm00000000000'), 14, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 20, ' ');
          vr_linha_txt := vr_linha_txt ||
                          RPAD(UPPER(gene0007.fn_caract_especial(rw_prestamista.nmprimtl)), 70, ' ');
          vr_linha_txt := vr_linha_txt ||
                          LPAD(to_char(rw_prestamista.dtnasctl, 'YYYY-MM-DD'), 10, 0);
          vr_linha_txt := vr_linha_txt || LPAD(rw_prestamista.cdsexotl, 2, 0);
          vr_linha_txt := vr_linha_txt ||
                          RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.dsendres,' '))), 60, ' ');
          vr_linha_txt := vr_linha_txt ||
                          RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmbairro,' '))), 30, ' ');
          vr_linha_txt := vr_linha_txt ||
                          RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmcidade,' '))), 30, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdufresd), ' '),2,' ');
          vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrcepend, 'zzzzz-zz9'), 10, ' ');
                
          IF length(rw_prestamista.nrtelefo) = 11 THEN
            vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)99999-9999'), 15, ' ');
          ELSIF length(rw_prestamista.nrtelefo) = 10 THEN
            vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)9999-9999'), 15, ' ');
          ELSE
            vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '99999-9999'), 15, ' ');
          END IF;
                
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
                
          vr_dsdemail := rw_prestamista.dsdemail;
          CECRED.segu0003.pc_limpa_email(vr_dsdemail);
                
          vr_linha_txt := vr_linha_txt || RPAD(' ', 1, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(nvl(vr_dsdemail, ' '), 50, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 12, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || RPAD( vr_NRPROPOSTA, 30, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtdevend, 'YYYY-MM-DD'), 10, 0);
          vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtinivig, 'YYYY-MM-DD'), 10, 0);
          vr_linha_txt := vr_linha_txt || LPAD(' ', 2, ' ');
                                                                
          vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.nrctremp), 0), 10, 0);
                
          vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
                
          vr_linha_txt := vr_linha_txt || RPAD(LPAD(rw_prestamista.cdcooper, 4, 0), 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcobran), ' ');
          vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdadmcob), ' '), 3, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 2, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 5, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpfrecob), ' '), 2, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpsegura), ' '), 2, ' ');
          vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcooperativa), ' ');
          vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdplapro), ' ');
                
          vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlprodvl,'fm99999990d00'), ',', '.'), 12, 0);
          vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.tpcobran), ' '), 1, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlenviad,'fm999999999999990d00'), ',', '.'), 30, 0);
          vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_ultimoDia, 'YYYY-MM-DD'), 10, 0);
          vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtfimvig, 'YYYY-MM-DD'), 10, 0);
                
          vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 89, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
          vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
          vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
          vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
          vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
          vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
                
          vr_linha_txt := vr_linha_txt || chr(13);
                
          CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo,vr_linha_txt);
          vr_seqtran := vr_seqtran + 1;
        END IF;

        vr_linha :=   'UPDATE CECRED.tbseg_prestamista '                    
                    ||'   SET tpregist = ' || rw_prestamista.tpregist                
                    ||'      ,nrproposta = ''' || rw_prestamista.nrproposta || ''''
                    ||'      ,dtdenvio = ''' || rw_prestamista.dtdenvio || ''''
                    ||'      ,vlprodut =  ' || REPLACE(TO_CHAR(rw_prestamista.vlprodut ,'fm999999999999990d00'), ',', '.')
                    ||'      ,dtrefcob = ''' || rw_prestamista.dtrefcob || ''''               
                    ||'      ,dtdevend = ''' || rw_prestamista.dtdevend || ''''                
                    ||'      ,dtfimvig = ''' || rw_prestamista.dtfimvig || ''''               
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper                
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta 
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg 
                    ||'   AND nrctremp =  ' || rw_prestamista.nrctremp 
                    ||'   AND cdapolic =  ' || vr_cdapolic ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
              
        vr_linha :=   'UPDATE CECRED.crawseg '                    
                    ||'   SET nrproposta = ''' || rw_prestamista.nrproposta || ''''
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
              
        IF vr_tpregist = 1 THEN
          vr_tpregist := 3;
        ELSIF vr_tpregist = 2 THEN
          vr_tpregist := 0;
        END IF;
                
        BEGIN 
          UPDATE CECRED.tbseg_prestamista
             SET tpregist = vr_tpregist
                ,nrproposta = vr_nrproposta
                ,dtdenvio = vr_dtmvtolt
                ,vlprodut = vr_vlprodvl
                ,dtrefcob = vr_ultimoDia
                ,dtdevend = vr_dtdevend
                ,dtfimvig = vr_dtfimvig
           WHERE cdcooper = pr_cdcooper
             AND nrdconta = rw_prestamista.nrdconta
             AND nrctrseg = rw_prestamista.nrctrseg
             AND nrctremp = rw_prestamista.nrctremp
             AND cdapolic = vr_cdapolic;
                   
          UPDATE CECRED.crawseg w
             SET w.nrproposta = vr_nrproposta
           WHERE w.cdcooper = rw_prestamista.cdcooper
             AND w.nrdconta = rw_prestamista.nrdconta
             AND w.nrctrseg = rw_prestamista.nrctrseg;
        EXCEPTION
          WHEN OTHERS THEN
            vr_cdcritic := 0;
            vr_dscritic := 'Erro ao atualizar saldo do contrato: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
            RAISE vr_exc_saida;
        END;
              
        IF vr_tpregist = 0 THEN
          BEGIN
            UPDATE CECRED.crapseg c
               SET c.cdsitseg = 2,
                   c.dtcancel = vr_dtmvtolt 
             WHERE c.cdcooper = rw_prestamista.cdcooper
               AND c.nrdconta = rw_prestamista.nrdconta
               AND c.nrctrseg = rw_prestamista.nrctrseg
               AND c.tpseguro = 4; 
                     
            vr_linha :=   'UPDATE CECRED.crapseg '                    
                        ||'   SET cdsitseg = ' || rw_prestamista.cdsitseg  
                        ||'      ,dtcancel = ''' || rw_prestamista.dtcancel || '''' 
                        ||' WHERE cdcooper = ' || rw_prestamista.cdcooper
                        ||'   AND nrdconta = ' || rw_prestamista.nrdconta
                        ||'   AND tpseguro = 4 '
                        ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                          
            CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);               
          EXCEPTION
            WHEN OTHERS THEN
              vr_cdcritic := 0;
              vr_dscritic := 'Erro ao cancelar seguro prestamista: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
              RAISE vr_exc_saida;
          END;          
        END IF;
                       
      END LOOP;
    END LOOP;
          
    FOR rw_prestamista IN cr_prestamista2(pr_cdcooper => rw_crapcop.cdcooper,
                                         pr_vlminimo => vr_vlminimo,
                                         pr_idadelim => 70,
                                         pr_dtmvtolt => TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR')) LOOP

      vr_vlsdeved := rw_prestamista.saldo_cpf;
      vr_vlsdatua := rw_prestamista.vldevatu;  
      vr_cdapolic := rw_prestamista.cdapolic;
      vr_nrproposta := nvl(rw_prestamista.nrproposta,0);
      vr_dtdevend := rw_prestamista.dtdevend;
      vr_dtinivig := rw_prestamista.dtinivig;
      vr_dtfimvig := rw_prestamista.dtfimvig;
      vr_flgnvenv := FALSE;
              
      IF rw_prestamista.dtfimvig IS NULL THEN
        vr_dtfimvig := rw_prestamista.dtfimctr;
      END IF;
              
      vr_dtcalcidade:= TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR');
                  
      vr_nrdeanos := TRUNC(Months_Between(vr_dtcalcidade,rw_prestamista.dtnasctl) / 12, 0);
            
      vr_tpregist:= 2;
                        
      IF rw_prestamista.cdsitseg <> 2 THEN
        IF vr_tab_ctrl_prst.EXISTS(rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp) THEN
          vr_tpregist:= 2;
        ELSE
          vr_index := rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp;
          vr_tab_ctrl_prst(vr_index).nrcpfcgc := rw_prestamista.nrcpfcgc;
          vr_tab_ctrl_prst(vr_index).nrctremp := rw_prestamista.nrctremp;
        END IF;
      END IF;              
              
      IF vr_contrcpf IS NULL OR vr_contrcpf <> rw_prestamista.nrcpfcgc THEN 
        vr_contrcpf := rw_prestamista.nrcpfcgc;
        vr_vlenviad := vr_vlsdatua;
        vr_vltotenv := vr_vlsdatua;
                
        IF vr_vlenviad > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
          vr_vlenviad := vr_vlmaximo; 
                  
          IF vr_vlenviad <= 0 THEN
            vr_tpregist:= 2;
          END IF;                         
        END IF;  
      ELSE
        vr_vltotenv := vr_vltotenv + vr_vlsdatua;
        IF vr_vltotenv > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
          vr_vlenviad := vr_vlmaximo - (vr_vltotenv - vr_vlsdatua);              
                   
          IF vr_vlenviad <= 0 THEN
            vr_tpregist:= 2;
          END IF;
        ELSE 
          vr_vlenviad := vr_vlsdatua;
        END IF;
      END IF; 
              
      vr_vlprodvl := vr_vlenviad * (vr_pgtosegu/100);
              
      IF vr_vlprodvl < 0.01 THEN
        vr_vlprodvl:= 0.01;
      END IF;  
              
      IF vr_vlenviad < 0.01 THEN
        vr_vlenviad:= 0.01;
      END IF;
              
      vr_linha_txt := '';

      vr_linha_txt := vr_linha_txt || LPAD(vr_seqtran, 5, 0);
      vr_linha_txt := vr_linha_txt || LPAD(vr_tpregist, 2, 0);
      vr_linha_txt := vr_linha_txt || LPAD(vr_apolice, 15, 0);
      vr_linha_txt := vr_linha_txt || RPAD(to_char(rw_prestamista.nrcpfcgc,'fm00000000000'), 14, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(rw_prestamista.nmprimtl)), 70, ' ');
      vr_linha_txt := vr_linha_txt ||
                      LPAD(to_char(rw_prestamista.dtnasctl, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(rw_prestamista.cdsexotl, 2, 0);
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.dsendres,' '))), 60, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmbairro,' '))), 30, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmcidade,' '))), 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdufresd), ' '),2,' ');
      vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrcepend, 'zzzzz-zz9'), 10, ' ');
                
      IF length(rw_prestamista.nrtelefo) = 11 THEN
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)99999-9999'), 15, ' ');
      ELSIF length(rw_prestamista.nrtelefo) = 10 THEN
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)9999-9999'), 15, ' ');
      ELSE
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '99999-9999'), 15, ' ');
      END IF;
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
                
      vr_dsdemail := rw_prestamista.dsdemail;
      CECRED.segu0003.pc_limpa_email(vr_dsdemail);
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 1, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(vr_dsdemail, ' '), 50, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 12, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD( vr_NRPROPOSTA, 30, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtdevend, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtinivig, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(' ', 2, ' ');
                                                                
      vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.nrctremp), 0), 10, 0);
                
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
                
      vr_linha_txt := vr_linha_txt || RPAD(LPAD(rw_prestamista.cdcooper, 4, 0), 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcobran), ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdadmcob), ' '), 3, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 2, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 5, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpfrecob), ' '), 2, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpsegura), ' '), 2, ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcooperativa), ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdplapro), ' ');
                
      vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlprodvl,'fm99999990d00'), ',', '.'), 12, 0);
      vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.tpcobran), ' '), 1, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlenviad,'fm999999999999990d00'), ',', '.'), 30, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_ultimoDia, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtfimvig, 'YYYY-MM-DD'), 10, 0);
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 89, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
                
      vr_linha_txt := vr_linha_txt || chr(13);
                
      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo,vr_linha_txt);
              
      IF vr_tpregist = 2 THEN
        vr_tpregist := 0;
      END IF;
            
      vr_linha :=   'UPDATE CECRED.tbseg_prestamista '                    
                    ||'   SET tpregist = ' || rw_prestamista.tpregist
                    ||'      ,dtdenvio = ''' || rw_prestamista.dtdenvio || ''''
                    ||'      ,vlprodut =  ' || REPLACE(TO_CHAR(rw_prestamista.vlprodut ,'fm999999999999990d00'), ',', '.')
                    ||'      ,dtrefcob = ''' || rw_prestamista.dtrefcob || ''''               
                    ||'      ,dtdevend = ''' || rw_prestamista.dtdevend || ''''                
                    ||'      ,dtfimvig = ''' || rw_prestamista.dtfimvig || ''''               
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper                
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta 
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg 
                    ||'   AND nrctremp =  ' || rw_prestamista.nrctremp 
                    ||'   AND cdapolic =  ' || vr_cdapolic ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
                
      BEGIN 
        UPDATE CECRED.tbseg_prestamista
           SET tpregist = vr_tpregist
              ,dtdenvio = vr_dtmvtolt
              ,vlprodut = vr_vlprodvl
              ,dtrefcob = vr_ultimoDia
              ,dtdevend = vr_dtdevend
              ,dtfimvig = vr_dtfimvig
         WHERE cdcooper = pr_cdcooper
           AND nrdconta = rw_prestamista.nrdconta
           AND nrctrseg = rw_prestamista.nrctrseg
           AND nrctremp = rw_prestamista.nrctremp
           AND cdapolic = vr_cdapolic;
      EXCEPTION
        WHEN OTHERS THEN
          vr_cdcritic := 0;
          vr_dscritic := 'Erro ao atualizar saldo do contrato: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
          RAISE vr_exc_saida;
      END;
              
      IF vr_tpregist = 0 THEN
        BEGIN
          UPDATE CECRED.crapseg c
             SET c.cdsitseg = 2,
                 c.dtcancel = vr_dtmvtolt 
           WHERE c.cdcooper = rw_prestamista.cdcooper
             AND c.nrdconta = rw_prestamista.nrdconta
             AND c.nrctrseg = rw_prestamista.nrctrseg
             AND c.tpseguro = 4; 
                     
          vr_linha :=   'UPDATE CECRED.crapseg '                    
                      ||'   SET cdsitseg = ' || rw_prestamista.cdsitseg  
                      ||'      ,dtcancel = ''' || rw_prestamista.dtcancel || '''' 
                      ||' WHERE cdcooper = ' || rw_prestamista.cdcooper
                      ||'   AND nrdconta = ' || rw_prestamista.nrdconta
                      ||'   AND tpseguro = 4 '
                      ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                          
          CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);               
        EXCEPTION
          WHEN OTHERS THEN
            vr_cdcritic := 0;
            vr_dscritic := 'Erro ao cancelar seguro prestamista: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
            RAISE vr_exc_saida;
        END;          
      END IF;
            
      vr_seqtran := vr_seqtran + 1;         
    END LOOP;          
          
    FOR rw_cpf IN cr_cpf2(pr_cdcooper => rw_crapcop.cdcooper) LOOP
      FOR rw_prestamista IN cr_prestamista3(pr_cdcooper => rw_crapcop.cdcooper,
                                           pr_vlminimo => vr_vlminimo,
                                           pr_idadelim => 70,
                                           pr_dtmvtolt => TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR'),
                                           pr_nrcpfcgc => rw_cpf.nrcpfcgc) LOOP

        vr_vlsdeved := rw_prestamista.saldo_cpf;
        vr_vlsdatua := rw_prestamista.vldevatu;
        vr_tpregist := rw_prestamista.tpregist;  
        vr_cdapolic := rw_prestamista.cdapolic;
        vr_nrproposta := nvl(rw_prestamista.nrproposta,0);
        vr_dtdevend := rw_prestamista.dtdevend;
        vr_dtinivig := rw_prestamista.dtinivig;
        vr_dtfimvig := rw_prestamista.dtfimvig;
        vr_flgnvenv := FALSE;
              
        IF rw_prestamista.dtfimvig IS NULL THEN
          vr_dtfimvig := rw_prestamista.dtfimctr;
        END IF;
              
        vr_dtcalcidade:= TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR');
                  
        vr_nrdeanos := TRUNC(Months_Between(vr_dtcalcidade,rw_prestamista.dtnasctl) / 12, 0);
                        
        IF (vr_vlsdeved < vr_vlminimo) THEN
          vr_tpregist := 2;
        END IF;
              
        IF rw_prestamista.cdsitseg <> 2 THEN
          IF vr_tab_ctrl_prst.EXISTS(rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp) THEN
            vr_tpregist:= 2;
          ELSE
            vr_index := rw_prestamista.nrcpfcgc || rw_prestamista.nrctremp;
            vr_tab_ctrl_prst(vr_index).nrcpfcgc := rw_prestamista.nrcpfcgc;
            vr_tab_ctrl_prst(vr_index).nrctremp := rw_prestamista.nrctremp;
          END IF;
        END IF;              
              
        IF vr_contrcpf IS NULL OR vr_contrcpf <> rw_prestamista.nrcpfcgc THEN 
          vr_contrcpf := rw_prestamista.nrcpfcgc;
          vr_vlenviad := vr_vlsdatua;
          vr_vltotenv := vr_vlsdatua;
                
          IF vr_vlenviad > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
            vr_vlenviad := vr_vlmaximo; 
                  
            IF vr_vlenviad <= 0 THEN
              vr_tpregist:= 2;
            END IF;                         
          END IF;  
        ELSE
          vr_vltotenv := vr_vltotenv + vr_vlsdatua;
          IF vr_vltotenv > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
            vr_vlenviad := vr_vlmaximo - (vr_vltotenv - vr_vlsdatua);              
                   
            IF vr_vlenviad <= 0 THEN
              vr_tpregist:= 2;
            END IF;
          ELSE 
            vr_vlenviad := vr_vlsdatua;
          END IF;
        END IF;
              
        OPEN cr_nrproposta2(pr_cdcooper   => rw_prestamista.cdcooper
                          ,pr_nrproposta => rw_prestamista.nrproposta);
          FETCH cr_nrproposta2 INTO rw_nrproposta2;
            IF cr_nrproposta2%NOTFOUND THEN
              CLOSE cr_nrproposta2;
              CONTINUE;
            END IF;
        CLOSE cr_nrproposta2;
              
        vr_vlprodvl := vr_vlenviad * (vr_pgtosegu/100);
              
        IF vr_vlprodvl < 0.01 THEN
          vr_vlprodvl:= 0.01;
        END IF;  
              
        IF vr_vlenviad < 0.01 THEN
          vr_vlenviad:= 0.01;
        END IF;
              
        vr_linha_txt := '';

        vr_linha_txt := vr_linha_txt || LPAD(vr_seqtran, 5, 0);
        vr_linha_txt := vr_linha_txt || LPAD(vr_tpregist, 2, 0);
        vr_linha_txt := vr_linha_txt || LPAD(vr_apolice, 15, 0);
        vr_linha_txt := vr_linha_txt || RPAD(to_char(rw_prestamista.nrcpfcgc,'fm00000000000'), 14, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 20, ' ');
        vr_linha_txt := vr_linha_txt ||
                        RPAD(UPPER(gene0007.fn_caract_especial(rw_prestamista.nmprimtl)), 70, ' ');
        vr_linha_txt := vr_linha_txt ||
                        LPAD(to_char(rw_prestamista.dtnasctl, 'YYYY-MM-DD'), 10, 0);
        vr_linha_txt := vr_linha_txt || LPAD(rw_prestamista.cdsexotl, 2, 0);
        vr_linha_txt := vr_linha_txt ||
                        RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.dsendres,' '))), 60, ' ');
        vr_linha_txt := vr_linha_txt ||
                        RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmbairro,' '))), 30, ' ');
        vr_linha_txt := vr_linha_txt ||
                        RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmcidade,' '))), 30, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdufresd), ' '),2,' ');
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrcepend, 'zzzzz-zz9'), 10, ' ');
                
        IF length(rw_prestamista.nrtelefo) = 11 THEN
          vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)99999-9999'), 15, ' ');
        ELSIF length(rw_prestamista.nrtelefo) = 10 THEN
          vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)9999-9999'), 15, ' ');
        ELSE
          vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '99999-9999'), 15, ' ');
        END IF;
                
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
                
        vr_dsdemail := rw_prestamista.dsdemail;
        CECRED.segu0003.pc_limpa_email(vr_dsdemail);
                
        vr_linha_txt := vr_linha_txt || RPAD(' ', 1, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(nvl(vr_dsdemail, ' '), 50, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 12, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || RPAD( vr_NRPROPOSTA, 30, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtdevend, 'YYYY-MM-DD'), 10, 0);
        vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtinivig, 'YYYY-MM-DD'), 10, 0);
        vr_linha_txt := vr_linha_txt || LPAD(' ', 2, ' ');
                                                                
        vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.nrctremp), 0), 10, 0);
                
        vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
                
        vr_linha_txt := vr_linha_txt || RPAD(LPAD(rw_prestamista.cdcooper, 4, 0), 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcobran), ' ');
        vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdadmcob), ' '), 3, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 2, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 5, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpfrecob), ' '), 2, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpsegura), ' '), 2, ' ');
        vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcooperativa), ' ');
        vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdplapro), ' ');
                
        vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlprodvl,'fm99999990d00'), ',', '.'), 12, 0);
        vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.tpcobran), ' '), 1, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlenviad,'fm999999999999990d00'), ',', '.'), 30, 0);
        vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_ultimoDia, 'YYYY-MM-DD'), 10, 0);
        vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtfimvig, 'YYYY-MM-DD'), 10, 0);
                
        vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 89, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
        vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
        vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
        vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
        vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
        vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
                
        vr_linha_txt := vr_linha_txt || chr(13);
                
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo,vr_linha_txt);
        vr_seqtran := vr_seqtran + 1;

        vr_linha :=   'UPDATE CECRED.tbseg_prestamista '                    
                    ||'   SET tpregist = ' || rw_prestamista.tpregist
                    ||'      ,dtdenvio = ''' || rw_prestamista.dtdenvio || ''''
                    ||'      ,vlprodut =  ' || REPLACE(TO_CHAR(rw_prestamista.vlprodut ,'fm999999999999990d00'), ',', '.')
                    ||'      ,dtrefcob = ''' || rw_prestamista.dtrefcob || ''''               
                    ||'      ,dtdevend = ''' || rw_prestamista.dtdevend || ''''                
                    ||'      ,dtfimvig = ''' || rw_prestamista.dtfimvig || ''''               
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper                
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta 
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg 
                    ||'   AND nrctremp =  ' || rw_prestamista.nrctremp 
                    ||'   AND cdapolic =  ' || vr_cdapolic ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
              
        IF vr_tpregist = 1 THEN
          vr_tpregist := 3;
        ELSIF vr_tpregist = 2 THEN
          vr_tpregist := 0;
        END IF;
                
        BEGIN 
          UPDATE CECRED.tbseg_prestamista
             SET tpregist = vr_tpregist
                ,dtdenvio = vr_dtmvtolt
                ,vlprodut = vr_vlprodvl
                ,dtrefcob = vr_ultimoDia
                ,dtdevend = vr_dtdevend
                ,dtfimvig = vr_dtfimvig
           WHERE cdcooper = pr_cdcooper
             AND nrdconta = rw_prestamista.nrdconta
             AND nrctrseg = rw_prestamista.nrctrseg
             AND nrctremp = rw_prestamista.nrctremp
             AND cdapolic = vr_cdapolic;
        EXCEPTION
          WHEN OTHERS THEN
            vr_cdcritic := 0;
            vr_dscritic := 'Erro ao atualizar saldo do contrato: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
            RAISE vr_exc_saida;
        END;
              
        IF vr_tpregist = 0 THEN
          BEGIN
            UPDATE CECRED.crapseg c
               SET c.cdsitseg = 2,
                   c.dtcancel = vr_dtmvtolt 
             WHERE c.cdcooper = rw_prestamista.cdcooper
               AND c.nrdconta = rw_prestamista.nrdconta
               AND c.nrctrseg = rw_prestamista.nrctrseg
               AND c.tpseguro = 4; 
                     
            vr_linha :=   'UPDATE CECRED.crapseg '                    
                        ||'   SET cdsitseg = ' || rw_prestamista.cdsitseg  
                        ||'      ,dtcancel = ''' || rw_prestamista.dtcancel || '''' 
                        ||' WHERE cdcooper = ' || rw_prestamista.cdcooper
                        ||'   AND nrdconta = ' || rw_prestamista.nrdconta
                        ||'   AND tpseguro = 4 '
                        ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                          
            CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);               
          EXCEPTION
            WHEN OTHERS THEN
              vr_cdcritic := 0;
              vr_dscritic := 'Erro ao cancelar seguro prestamista: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
              RAISE vr_exc_saida;
          END;          
        END IF;
                       
      END LOOP;
    END LOOP;
          
    FOR rw_prestamista IN cr_prestamista4(pr_cdcooper => rw_crapcop.cdcooper,
                                         pr_vlminimo => vr_vlminimo,
                                         pr_idadelim => 70,
                                         pr_dtmvtolt => TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR')) LOOP
            
      IF rw_prestamista.idseqtra IN (567331,566912,566936) THEN
        DELETE CECRED.tbseg_prestamista p
         WHERE p.idseqtra = rw_prestamista.idseqtra;               
         CONTINUE;
      ELSIF rw_prestamista.idseqtra = 565952 THEN
        vr_nrproposta := '770658023560';
      ELSIF rw_prestamista.idseqtra = 565205 THEN
        vr_nrproposta := '770658166034';
      ELSIF rw_prestamista.idseqtra = 565691 THEN
        vr_nrproposta := '770658165798';
      END IF;          
            
      vr_vlsdeved := rw_prestamista.saldo_cpf;
      vr_vlsdatua := rw_prestamista.vldevatu;  
      vr_cdapolic := rw_prestamista.cdapolic;
      vr_dtdevend := rw_prestamista.dtdevend;
      vr_dtinivig := rw_prestamista.dtinivig;
      vr_dtfimvig := rw_prestamista.dtfimvig;
      vr_flgnvenv := FALSE;
              
      IF rw_prestamista.dtfimvig IS NULL THEN
        vr_dtfimvig := rw_prestamista.dtfimctr;
      END IF;
              
      vr_dtcalcidade:= TO_DATE(ADD_MONTHS(vr_ultimoDia,-1),'DD/MM/RRRR');
                  
      vr_nrdeanos := TRUNC(Months_Between(vr_dtcalcidade,rw_prestamista.dtnasctl) / 12, 0);
              
      IF vr_contrcpf IS NULL OR vr_contrcpf <> rw_prestamista.nrcpfcgc THEN 
        vr_contrcpf := rw_prestamista.nrcpfcgc;
        vr_vlenviad := vr_vlsdatua;
        vr_vltotenv := vr_vlsdatua;
                
        IF vr_vlenviad > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
          vr_vlenviad := vr_vlmaximo; 
                  
          IF vr_vlenviad <= 0 THEN
            vr_tpregist:= 2;
          END IF;                         
        END IF;  
      ELSE
        vr_vltotenv := vr_vltotenv + vr_vlsdatua;
        IF vr_vltotenv > vr_vlmaximo AND vr_tpregist NOT IN (0,2) THEN
          vr_vlenviad := vr_vlmaximo - (vr_vltotenv - vr_vlsdatua);              
                   
          IF vr_vlenviad <= 0 THEN
            vr_tpregist:= 2;
          END IF;
        ELSE 
          vr_vlenviad := vr_vlsdatua;
        END IF;
      END IF; 
              
      vr_vlprodvl := vr_vlenviad * (vr_pgtosegu/100);
              
      IF vr_vlprodvl < 0.01 THEN
        vr_vlprodvl:= 0.01;
      END IF;  
              
      IF vr_vlenviad < 0.01 THEN
        vr_vlenviad:= 0.01;
      END IF;
              
      IF vr_tpregist = 0 THEN
        vr_tpregist := 3;
      END IF;
            
      vr_linha_txt := '';

      vr_linha_txt := vr_linha_txt || LPAD(vr_seqtran, 5, 0);
      vr_linha_txt := vr_linha_txt || LPAD(vr_tpregist, 2, 0);
      vr_linha_txt := vr_linha_txt || LPAD(vr_apolice, 15, 0);
      vr_linha_txt := vr_linha_txt || RPAD(to_char(rw_prestamista.nrcpfcgc,'fm00000000000'), 14, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(rw_prestamista.nmprimtl)), 70, ' ');
      vr_linha_txt := vr_linha_txt ||
                      LPAD(to_char(rw_prestamista.dtnasctl, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(rw_prestamista.cdsexotl, 2, 0);
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.dsendres,' '))), 60, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmbairro,' '))), 30, ' ');
      vr_linha_txt := vr_linha_txt ||
                      RPAD(UPPER(gene0007.fn_caract_especial(nvl(rw_prestamista.nmcidade,' '))), 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdufresd), ' '),2,' ');
      vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrcepend, 'zzzzz-zz9'), 10, ' ');
                
      IF length(rw_prestamista.nrtelefo) = 11 THEN
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)99999-9999'), 15, ' ');
      ELSIF length(rw_prestamista.nrtelefo) = 10 THEN
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '(99)9999-9999'), 15, ' ');
      ELSE
        vr_linha_txt := vr_linha_txt || RPAD(CECRED.gene0002.fn_mask(rw_prestamista.nrtelefo, '99999-9999'), 15, ' ');
      END IF;
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
                
      vr_dsdemail := rw_prestamista.dsdemail;
      CECRED.segu0003.pc_limpa_email(vr_dsdemail);
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 1, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(vr_dsdemail, ' '), 50, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 12, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD( vr_NRPROPOSTA, 30, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtdevend, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtinivig, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(' ', 2, ' ');
                                                                
      vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.nrctremp), 0), 10, 0);
                
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 10, ' ');
                
      vr_linha_txt := vr_linha_txt || RPAD(LPAD(rw_prestamista.cdcooper, 4, 0), 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcobran), ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.cdadmcob), ' '), 3, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 2, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 5, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 10, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpfrecob), ' '), 2, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(nvl(to_char(rw_prestamista.tpsegura), ' '), 2, ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdcooperativa), ' ');
      vr_linha_txt := vr_linha_txt || nvl(to_char(rw_prestamista.cdplapro), ' ');
                
      vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlprodvl,'fm99999990d00'), ',', '.'), 12, 0);
      vr_linha_txt := vr_linha_txt || LPAD(nvl(to_char(rw_prestamista.tpcobran), ' '), 1, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(replace(to_char(vr_vlenviad,'fm999999999999990d00'), ',', '.'), 30, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_ultimoDia, 'YYYY-MM-DD'), 10, 0);
      vr_linha_txt := vr_linha_txt || LPAD(to_char(vr_dtfimvig, 'YYYY-MM-DD'), 10, 0);
                
      vr_linha_txt := vr_linha_txt || RPAD(' ', 20, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 50, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 89, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
      vr_linha_txt := vr_linha_txt || RPAD(' ', 30, ' ');
      vr_linha_txt := vr_linha_txt || RPAD(' ', 15, ' ');
      vr_linha_txt := vr_linha_txt || LPAD(' ', 3, ' '); 
                
      vr_linha_txt := vr_linha_txt || chr(13);
                
      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo,vr_linha_txt);              
                
        vr_linha :=   'UPDATE CECRED.tbseg_prestamista '                    
                    ||'   SET tpregist = ' || rw_prestamista.tpregist                
                    ||'      ,nrproposta = ''' || rw_prestamista.nrproposta || ''''
                    ||'      ,dtdenvio = ''' || rw_prestamista.dtdenvio || ''''
                    ||'      ,vlprodut =  ' || REPLACE(TO_CHAR(rw_prestamista.vlprodut ,'fm999999999999990d00'), ',', '.')
                    ||'      ,dtrefcob = ''' || rw_prestamista.dtrefcob || ''''               
                    ||'      ,dtdevend = ''' || rw_prestamista.dtdevend || ''''                
                    ||'      ,dtfimvig = ''' || rw_prestamista.dtfimvig || ''''               
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper                
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta 
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg 
                    ||'   AND nrctremp =  ' || rw_prestamista.nrctremp 
                    ||'   AND cdapolic =  ' || vr_cdapolic ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
              
        vr_linha :=   'UPDATE CECRED.crawseg '                    
                    ||'   SET nrproposta = ''' || rw_prestamista.nrproposta || ''''
                    ||' WHERE cdcooper =  ' || rw_prestamista.cdcooper
                    ||'   AND nrdconta =  ' || rw_prestamista.nrdconta
                    ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                          
        CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);

         vr_linha :=   'UPDATE CECRED.crapseg '                    
                     ||'   SET cdsitseg = ' || rw_prestamista.cdsitseg  
                     ||'      ,dtcancel = ''' || rw_prestamista.dtcancel || '''' 
                     ||' WHERE cdcooper = ' || rw_prestamista.cdcooper
                     ||'   AND nrdconta = ' || rw_prestamista.nrdconta
                     ||'   AND tpseguro = 4 '
                     ||'   AND nrctrseg =  ' || rw_prestamista.nrctrseg ||' ; ';
                              
         CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,vr_linha);
                
        BEGIN 
          UPDATE CECRED.tbseg_prestamista
             SET tpregist = vr_tpregist
                ,nrproposta = vr_nrproposta
                ,dtdenvio = vr_dtmvtolt
                ,vlprodut = vr_vlprodvl
                ,dtrefcob = vr_ultimoDia
                ,dtdevend = vr_dtdevend
                ,dtfimvig = vr_dtfimvig
           WHERE cdcooper = pr_cdcooper
             AND nrdconta = rw_prestamista.nrdconta
             AND nrctrseg = rw_prestamista.nrctrseg
             AND nrctremp = rw_prestamista.nrctremp
             AND cdapolic = vr_cdapolic;
                   
          UPDATE CECRED.crawseg w
             SET w.nrproposta = vr_nrproposta
           WHERE w.cdcooper = rw_prestamista.cdcooper
             AND w.nrdconta = rw_prestamista.nrdconta
             AND w.nrctrseg = rw_prestamista.nrctrseg;
                   
          UPDATE CECRED.crapseg p
             SET p.cdsitseg = 1
                ,p.dtcancel = NULL
           WHERE p.cdcooper = rw_prestamista.cdcooper
             AND p.nrdconta = rw_prestamista.nrdconta
             AND p.nrctrseg = rw_prestamista.nrctrseg;
        EXCEPTION
          WHEN OTHERS THEN
            vr_cdcritic := 0;
            vr_dscritic := 'Erro ao atualizar saldo do contrato: ' || pr_cdcooper || ' - nrdconta' || rw_prestamista.nrdconta || ' - ' || SQLERRM;
            RAISE vr_exc_saida;
        END;
            
      vr_seqtran := vr_seqtran + 1;         
    END LOOP; 
          
    CECRED.GENE0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquivo);
          
    IF vr_linha_txt IS NOT NULL THEN            
      CECRED.GENE0003.pc_converte_arquivo(pr_cdcooper => pr_cdcooper             
                                  ,pr_nmarquiv => vr_nmdir || '/'||vr_nmarquiv   
                                  ,pr_nmarqenv => vr_nmarquiv          
                                  ,pr_des_erro => vr_dscritic);                 

      IF vr_dscritic IS NOT NULL THEN             
        RAISE vr_exc_erro;               
      END IF;
            
      CECRED.segu0003.pc_processa_arq_ftp_prest(pr_nmarquiv => vr_nmarquiv,   
                                                pr_idoperac => 'E',           
                                                pr_nmdireto => vr_nmdir, 
                                                pr_idenvseg => 'S',           
                                                pr_ftp_site => vr_endereco,   
                                                pr_ftp_user => vr_login,      
                                                pr_ftp_pass => vr_senha,      
                                                pr_ftp_path => 'Envio', 
                                                pr_dscritic => vr_dscritic);  

      IF vr_dscritic IS NOT NULL THEN
        vr_dscritic := 'Erro ao processar arquivo via FTP - Cooperativa: ' || pr_cdcooper || ' - ' || vr_dscritic;
              
        CECRED.btch0001.pc_gera_log_batch(pr_cdcooper     => pr_cdcooper
                                  ,pr_ind_tipo_log => 2 
                                  ,pr_des_log      => to_char(SYSDATE,'hh24:mi:ss')||' - '
                                                      || vr_cdprogra || ' > '
                                                      || 'Processamento de ftp retornou erro: '||vr_dscritic);
      END IF;
          
      cecred.pc_log_programa(pr_dstiplog   => 'F',
                             pr_cdprograma => vr_cdprogra,
                             pr_cdcooper   => pr_cdcooper,
                             pr_tpexecucao => 2,
                             pr_idprglog   => vr_idprglog);
            
    END IF;
  END LOOP;
  vr_tab_ctrl_prst.delete;
        
  CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,' COMMIT;');
  CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,' END; ');
  CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arquivo_backup,'/ ');
  CECRED.GENE0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquivo_backup );
  COMMIT;
EXCEPTION
  WHEN vr_exc_saida THEN
    IF vr_cdcritic > 0 AND vr_dscritic IS NULL THEN
      vr_dscritic := CECRED.GENE0001.fn_busca_critica(vr_cdcritic);
    END IF;
        
    vr_dscritic := vr_dscritic || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
    ROLLBACK;
    cecred.pc_log_programa(pr_dstiplog           => 'E',         
                           pr_cdprograma         => vr_cdprogra, 
                           pr_cdcooper           => pr_cdcooper, 
                           pr_tpexecucao         => 2,           
                           pr_tpocorrencia       => 0,           
                           pr_cdcriticidade      => 2,           
                           pr_dsmensagem         => vr_dscritic, 
                           pr_flgsucesso         => 0,           
                           pr_nmarqlog           => NULL,
                           pr_idprglog           => vr_idprglog);


  WHEN OTHERS THEN
    vr_dscritic := SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
    ROLLBACK;
    cecred.pc_log_programa(pr_dstiplog           => 'E',
                           pr_cdprograma         => vr_cdprogra,
                           pr_cdcooper           => pr_cdcooper,
                           pr_tpexecucao         => 2,
                           pr_tpocorrencia       => 0,
                           pr_cdcriticidade      => 2,
                           pr_dsmensagem         => vr_dscritic,
                           pr_flgsucesso         => 0,
                           pr_nmarqlog           => NULL,
                           pr_destinatario_email => NULL,
                           pr_idprglog           => vr_idprglog);
END;
/
