DECLARE
  vr_ind_arq        utl_file.file_type;
  vr_linha          VARCHAR2(32767);
  vr_dscritic       VARCHAR2(2000);
  vr_nmdir          VARCHAR2(4000) := CECRED.gene0001.fn_param_sistema('CRED',3,'ROOT_MICROS')||'cpd/bacas/INC0210067';
  vr_nmarq          VARCHAR2(100)  := 'ROLLBACK_INC0210067_4.sql';
  vr_exc_saida      EXCEPTION;
  vcount            NUMBER;

  CURSOR cr_principal(pr_cdcooper CECRED.crapseg.cdcooper%TYPE) IS
    SELECT a.idseqtra,
           a.tpregist
      FROM CECRED.crapepr c, 
           CECRED.crapseg b, 
           CECRED.tbseg_prestamista a
     WHERE a.cdcooper = b.cdcooper
       AND a.nrdconta = b.nrdconta
       AND a.nrctrseg = b.nrctrseg
       AND a.cdcooper = c.cdcooper
       AND a.nrdconta = c.nrdconta
       AND a.nrctremp = c.nrctremp
       AND c.inliquid = 1
       AND a.nrproposta IN ('770356557778',
                            '770356557786',
                            '770356557794',
                            '770356802446',
                            '770358914993',
                            '770658164139',
                            '770658164155',
                            '770352281514',
                            '770352261521',
                            '770353964739',
                            '770353964747',
                            '770359516789',
                            '770359412916',
                            '770359412924',
                            '770359918216',
                            '770359918224',
                            '770359918232',
                            '770359918240',
                            '770351627840',
                            '770658163302',
                            '770612777853',
                            '770613653155',
                            '770350003410',
                            '770350003428',
                            '770350003436',
                            '770350003444',
                            '770658218484',
                            '770658102800',
                            '770613305076',
                            '770613305084',
                            '770353807625',
                            '770353807633',
                            '770352503177',
                            '770613653210',
                            '770613653228',
                            '770613653236',
                            '770613653244',
                            '770613653252',
                            '770613653260',
                            '770613653279',
                            '770613653287',
                            '770350631100',
                            '770355930971',
                            '770355196895',
                            '770355196909',
                            '770354273870',
                            '770354273888',
                            '770354273896',
                            '770354273900',
                            '770350121870',
                            '770658142097',
                            '770352158941',
                            '770612891184',
                            '770352152528',
                            '770352152536',
                            '770352328090',
                            '770353647504',
                            '770350979298',
                            '770350979328',
                            '770354097770',
                            '770613549579',
                            '770613549587',
                            '770354231875',
                            '770354215357',
                            '770354215365',
                            '770354215373',
                            '770354215381',
                            '770658522418',
                            '770353952730',
                            '770350230041',
                            '770657990540',
                            '770657990558',
                            '770657295221',
                            '770350032118',
                            '770658122223',
                            '770658122207',
                            '770353912771',
                            '770353912780',
                            '770353912798',
                            '770353912801',
                            '770352724041',
                            '770573541901',
                            '770352835846',
                            '770351315709',
                            '770351670053',
                            '770351670061',
                            '770351670070',
                            '770351670088',
                            '770351670096',
                            '770351670100',
                            '770355195953',
                            '770355207455',
                            '770355207447',
                            '770355207463',
                            '770359964072',
                            '770359631898',
                            '770359631901',
                            '770612776679',
                            '770612776687',
                            '770657296040',
                            '770657296058',
                            '770573150457',
                            '770573150465',
                            '770573150473',
                            '770573150481',
                            '770358537758',
                            '770359466552',
                            '770657988316',
                            '770353927779',
                            '770612890153',
                            '770354098180',
                            '770354097923',
                            '770354084104',
                            '770353102567',
                            '770657389439',
                            '770657389447',
                            '770658179381',
                            '770357007089',
                            '770349131528',
                            '770349131536',
                            '770359507496',
                            '770359367660',
                            '770351420219',
                            '770351420227',
                            '770351420235',
                            '770351475935',
                            '770349042622',
                            '770658180576',
                            '770658180584',
                            '770658180592',
                            '770658180606',
                            '770658180614',
                            '770657389773',
                            '770613561870',
                            '770657989398',
                            '770657989401',
                            '770351397543',
                            '770657973610',
                            '770658586572',
                            '770358651224',
                            '770359851766',
                            '770657295973',
                            '770657295981',
                            '770359411685',
                            '770350558365',
                            '770353548387',
                            '770353548409',
                            '770353458345',
                            '770658374036',
                            '770658225618',
                            '770355573249',
                            '770352266230',
                            '770657294110',
                            '770358714250',
                            '770358714242',
                            '770355513742',
                            '770354261553',
                            '770354261642',
                            '770354261650',
                            '770354261669',
                            '770613062998',
                            '770613063005',
                            '770613063013',
                            '770613063021',
                            '770353580728',
                            '770353572857',
                            '770353572865',
                            '770353572873',
                            '770353572881',
                            '770353572903',
                            '770353572911',
                            '770353523988',
                            '770351730773',
                            '770350104410',
                            '770350104429',
                            '770350104453',
                            '770350104461',
                            '770358538533',
                            '770353122908',
                            '770352784192',
                            '770353809792',
                            '770356228855',
                            '770356624475',
                            '770573767624',
                            '770657990175',
                            '770350491520',
                            '770358437010',
                            '770350198016',
                            '770354540347',
                            '770354540355',
                            '770354540363',
                            '770354540371',
                            '770349737981',
                            '770350004041',
                            '770351474572',
                            '770359159790',
                            '770613705406',
                            '770612890838',
                            '770351700548',
                            '770613654461',
                            '770613654470',
                            '770613654488',
                            '770613654496',
                            '770613654500',
                            '770613654518',
                            '770613654526',
                            '770613654534',
                            '770359361653',
                            '770657989746',
                            '770349753596',
                            '770351972327',
                            '770350947710',
                            '770350947736',
                            '770573542150',
                            '770573542169',
                            '770573542177',
                            '770573542185',
                            '770350857281',
                            '770350857303',
                            '770358398006',
                            '770358398014',
                            '770358596428',
                            '770358596436',
                            '770358397999',
                            '770358596444',
                            '770358596452',
                            '770354833255',
                            '770573672534',
                            '770573672542',
                            '770573672550',
                            '770573671775');

  CURSOR cr_crapcop IS
    SELECT c.cdcooper
          ,d.dtmvtolt
      FROM CECRED.crapcop c,
           CECRED.crapdat d
     WHERE c.flgativo = 1
       AND c.cdcooper <> 3
       AND c.cdcooper = d.cdcooper;
  BEGIN
    BEGIN
      CECRED.GENE0001.pc_abre_arquivo(pr_nmdireto => vr_nmdir
                                     ,pr_nmarquiv => vr_nmarq
                                     ,pr_tipabert => 'W'
                                     ,pr_utlfileh => vr_ind_arq
                                     ,pr_des_erro => vr_dscritic);

      IF vr_dscritic IS NOT NULL THEN
         vr_dscritic := vr_dscritic ||'  Não pode abrir arquivo '|| vr_nmdir || vr_nmarq;
         RAISE vr_exc_saida;
      END IF;

      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,'BEGIN');

      FOR rw_crapcop IN cr_crapcop LOOP
        vcount := 0;
        vr_linha := '';

        FOR rw_principal IN cr_principal(pr_cdcooper => rw_crapcop.cdcooper) LOOP
          vr_linha :=   'UPDATE CECRED.tbseg_prestamista '
                      ||'   SET tpregist   = ''' || rw_principal.tpregist   || ''''
                      ||' WHERE idseqtra = ' || rw_principal.idseqtra ||' ; ';

          CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,vr_linha);

          UPDATE CECRED.tbseg_prestamista p
             SET p.tpregist = 3
           WHERE p.idseqtra = rw_principal.idseqtra;

          IF vcount = 1000 THEN
            COMMIT;
          ELSE
            vcount := vcount + 1;
          END IF;
        END LOOP;

        COMMIT;
      END LOOP;

      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,' COMMIT;');
      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,' END; ');
      CECRED.GENE0001.pc_escr_linha_arquivo(vr_ind_arq,'/ ');
      CECRED.GENE0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arq );
    EXCEPTION
       WHEN vr_exc_saida THEN
            vr_dscritic := vr_dscritic || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
            dbms_output.put_line(vr_dscritic);
            ROLLBACK;
       WHEN OTHERS THEN
            vr_dscritic := vr_dscritic || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE;
            dbms_output.put_line(vr_dscritic);
            ROLLBACK;
    END;
END;
/
