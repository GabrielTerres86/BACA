--REQ0037383 - Ana - 23/09/2019
DECLARE
  --Busca contas - Credicomin
  CURSOR cr_crapass IS
    SELECT cdcooper, nrdconta, nrdctitg, flgctitg
    FROM   CRAPASS 
    WHERE  cdcooper = 10 --Credicomin
    AND    nrdconta IN (221 ,  5002 ,  10561,  17140,  26220,  40584,  54500,  64343,  72052,  83453,  91308,  92177 ,  100650,  126187
          ,  345 ,  5134 ,  10588,  17574,  26280,  41041,  55131,  64890,  72257,  83925,  91324,  92193 ,  100943,  126489
          ,  426 ,  5142 ,  11495,  17701,  26808,  41181,  56014,  65129,  72583,  84387,  91340,  92371 ,  101583,  126802
          ,  450 ,  5576 ,  11550,  17779,  27170,  42234,  56227,  65137,  73210,  85049,  91359,  92444 ,  101605
          ,  507 ,  5746 ,  11754,  17876,  27294,  42714,  56235,  66060,  73504,  85391,  91367,  92460 ,  102350
          ,  574 ,  5843 ,  12173,  18945,  27804,  43389,  57029,  66117,  74187,  85413,  91383,  92550 ,  102504
          ,  779 ,  5967 ,  12394,  18996,  28126,  43869,  57070,  67180,  74250,  87440,  91413,  92568 ,  103403
          ,  809 ,  6050 ,  12521,  19461,  28312,  44300,  57088,  67334,  74780,  88200,  91430,  92584 ,  104680
          ,  825 ,  6130 ,  12637,  19488,  28592,  44652,  57878,  67407,  75167,  88935,  91537,  92592 ,  106038
          ,  884 ,  6700 ,  13064,  20443,  28975,  44806,  59056,  67504,  76660,  89869,  91545,  92657 ,  107069
          ,  990 ,  7030 ,  13188,  20907,  29890,  45454,  59544,  67741,  76708,  90301,  91588,  92819 ,  109614
          ,  1163,  7285 ,  13552,  20923,  30031,  45640,  59781,  67920,  77135,  90646,  91634,  92827 ,  110990
          ,  1201,  7676 ,  13730,  22250,  31593,  46388,  60593,  68691,  77763,  90654,  91693,  92932 ,  113492
          ,  1309,  7870 ,  14265,  23507,  33057,  49867,  60623,  68896,  79502,  90905,  91740,  92940 ,  116394
          ,  1481,  8095 ,  14354,  23558,  34835,  50245,  61387,  68934,  80128,  91049,  91758,  92967 ,  118770
          ,  1635,  8320 ,  14486,  23620,  35050,  50342,  61760,  69060,  80454,  91057,  91804,  92975 ,  118834
          ,  2305,  8966 ,  15032,  24066,  37346,  52213,  61999,  69078,  80594,  91103,  91820,  93033 ,  119814
          ,  2828,  9520 ,  15253,  24163,  38059,  52434,  62758,  69159,  80608,  91111,  91847,  94650 ,  122408
          ,  3921,  9580 ,  15997,  25046,  38717,  52620,  63207,  70254,  80772,  91146,  91855,  94790 ,  122475
          ,  4774,  9741 ,  16322,  25100,  39403,  52752,  63541,  70351,  81574,  91162,  91871,  100048,  124087
          ,  4812,  10286,  16950,  25186,  39527,  52990,  63932,  71170,  82090,  91197,  91901,  100161,  124397
          ,  4839,  10456,  17132,  25500,  40550,  53899,  64181,  71692,  82198,  91235,  92118,  100188,  125750)
     AND    flgctitg <> 3
     ORDER BY nrdconta;

    rw_crapass       cr_crapass%rowtype;
    vr_qtdcta        NUMBER;
BEGIN
  FOR rw_crapass IN cr_crapass LOOP
    BEGIN
      --Atualiza status da conta ITG
      UPDATE CRAPASS
      SET    flgctitg = 3
      WHERE  cdcooper = rw_crapass.cdcooper
      AND    nrdconta = rw_crapass.nrdconta;
    END;

    BEGIN
      --Inclui log de alteração da conta ITG
      INSERT INTO crapalt 
        (nrdconta
        ,dtaltera
        ,cdoperad
        ,dsaltera
        ,tpaltera
        ,flgctitg
        ,cdcooper)
      VALUES
        (rw_crapass.nrdconta
        ,sysdate
        ,1
        ,'exclusao conta-itg('||rw_crapass.nrdctitg||')- ope.1'
        ,2 
        ,0  --nao enviada
        ,rw_crapass.cdcooper);
    END;
    vr_qtdcta := cr_crapass%rowcount;
  END LOOP;
  
  dbms_output.put_line('Qtde contas atualizadas:'||vr_qtdcta);
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN 
    ROLLBACK;
END;
