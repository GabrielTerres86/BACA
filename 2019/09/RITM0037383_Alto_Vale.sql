--REQ0037383 - Ana - 23/09/2019
DECLARE
  --Busca contas - Alto Vale
  CURSOR cr_crapass IS
    SELECT cdcooper, nrdconta, nrdctitg, flgctitg
    FROM   CRAPASS 
    WHERE  cdcooper = 16  --Alto Vale
    AND    nrdconta IN (388   ,  55743,  100587,  152595,  196967,  243337,  283053,  323810,  358940,  413909,  420417,  507369 ,  1909444,  2430207,  3668690,  6534414
          ,  1430  ,  56685,  100838,  152994,  198595,  245461,  283355,  324400,  359246,  413941,  420441,  508764 ,  1942620,  2471876,  3675904,  6545874 
          ,  2186  ,  57118,  101206,  154016,  200174,  246603,  284467,  324663,  360503,  414182,  420468,  509612 ,  1943073,  2473291,  3676641,  6546641 
          ,  3522  ,  62626,  102008,  154164,  200573,  246913,  285013,  325368,  361127,  414255,  420484,  511943 ,  1943600,  2500329,  3679799,  6546919 
          ,  3689  ,  64122,  102830,  154440,  200794,  247006,  288500,  325643,  361887,  414263,  420506,  513245 ,  1946544,  2533677,  3680037,  6546935 
          ,  4154  ,  66435,  105104,  154962,  201634,  248207,  288675,  325880,  363006,  415189,  420514,  514276 ,  1981420,  2533758,  3746704,  6555217 
          ,  4502  ,  67717,  105554,  154970,  202550,  249408,  290840,  325910,  363332,  415847,  420549,  515434 ,  1982419,  2534568,  3801616,  6555276 
          ,  5991  ,  70009,  105619,  156140,  203173,  250171,  292818,  326038,  363626,  415863,  420557,  516112 ,  2004321,  2534738,  3802582,  6555330 
          ,  7595  ,  70203,  105929,  156850,  203483,  251089,  293270,  326348,  363685,  415944,  420603,  516635 ,  2037297,  2538849,  3900410,  6597394 
          ,  8117  ,  70220,  105988,  158070,  204552,  252042,  293296,  326585,  365076,  415995,  420654,  516643 ,  2054507,  2539837,  3986268,  6597726 
          ,  9504  ,  70300,  106640,  159298,  205001,  252530,  293407,  327824,  365653,  416444,  420662,  516651 ,  2111691,  2540096,  3986314,  6608825 
          ,  10367 ,  70378,  113158,  159310,  205516,  253359,  293555,  328600,  366889,  416460,  421847,  517348 ,  2112728,  2547872,  3987043,  6612091
          ,  11916 ,  70653,  113646,  159433,  209716,  253642,  293733,  328774,  372285,  416894,  426717,  518212 ,  2113023,  2557398,  3987469,  6646794
          ,  12548 ,  72508,  114944,  160440,  212016,  253677,  295787,  330183,  376183,  417106,  432091,  521370 ,  2113279,  2557576,  3987728,  6647685
          ,  14389 ,  73369,  117030,  163414,  212440,  253715,  297038,  330833,  377422,  417157,  432598,  522120 ,  2113376,  2557789,  3988449,  6648010
          ,  17906 ,  73989,  119903,  165506,  212822,  254495,  297674,  334030,  377899,  417700,  434540,  522430 ,  2130360,  2599473,  3989623,  6648401
          ,  18600 ,  75256,  120782,  165522,  213152,  254509,  298832,  334413,  377929,  417904,  434582,  523003 ,  2137151,  2602512,  6014925,  6648576
          ,  18619 ,  75949,  122785,  165778,  215937,  255777,  300284,  335347,  378755,  417920,  434701,  524018 ,  2137291,  2650720,  6033903,  6671357
          ,  19186 ,  77283,  123048,  168351,  216437,  256765,  301620,  335665,  380350,  418544,  434833,  524514 ,  2137429,  2688417,  6034250,  6671519
          ,  21229 ,  77593,  123536,  171166,  218170,  260290,  304123,  335754,  381853,  418560,  435430,  526495 ,  2138352,  2720450,  6059791,  6671845
          ,  22292 ,  78182,  123919,  172294,  218570,  261521,  305081,  335843,  383430,  418579,  441074,  529184 ,  2138433,  2733722,  6059848,  6764002
          ,  29793 ,  78700,  125075,  172391,  219053,  261653,  308048,  336858,  384089,  418617,  444472,  533645 ,  2155370,  2734990,  6061427,  6782442
          ,  31410 ,  79464,  125326,  172804,  219533,  263559,  308170,  337447,  391700,  418757,  446262,  534072 ,  2155389,  2735385,  6077420,  6837921
          ,  31917 ,  80624,  125407,  173037,  219746,  264970,  309192,  338168,  392103,  418803,  449822,  534510 ,  2155664,  2736373,  6097162
          ,  35696 ,  80683,  125679,  174335,  220230,  265900,  310034,  340103,  392642,  419281,  449865,  535800 ,  2166437,  2736551,  6097405
          ,  36170 ,  81094,  126799,  174505,  220329,  267686,  310476,  340111,  393380,  419320,  450197,  536555 ,  2167433,  2767031,  6126111
          ,  36412 ,  81361,  128058,  176400,  221902,  268135,  311022,  340707,  398330,  419516,  453196,  543063 ,  2175738,  2780062,  6126758
          ,  36706 ,  81400,  128627,  178268,  224600,  268194,  311758,  340804,  399370,  419966,  454249,  543802 ,  2178982,  2852101,  6157912
          ,  37001 ,  82619,  129887,  179086,  226246,  268399,  312193,  341177,  401617,  419990,  456683,  544426 ,  2179946,  2889803,  6161219
          ,  37281 ,  83437,  133094,  180033,  226319,  269638,  312452,  341711,  405043,  420018,  461342,  544450 ,  2206838,  2890402,  6254306
          ,  37770 ,  83518,  133949,  181250,  228087,  270059,  312568,  341797,  409120,  420042,  462110,  610143 ,  2207370,  2930226,  6276024
          ,  38180 ,  83798,  134600,  181676,  228370,  271551,  312967,  342157,  409413,  420077,  468487,  610526 ,  2231557,  3039854,  6283241
          ,  39020 ,  83836,  135003,  182230,  229466,  271900,  313289,  342696,  409464,  420085,  476510,  613550 ,  2265710,  3039960,  6284396
          ,  39160 ,  87351,  135577,  184381,  231096,  272523,  313980,  344184,  409596,  420093,  477621,  614696 ,  2271796,  3040224,  6310400
          ,  41319 ,  88102,  135860,  185019,  231770,  274607,  315370,  345253,  409910,  420123,  478580,  615919 ,  2272580,  3040380,  6317170
          ,  41564 ,  88234,  137090,  187011,  232092,  275700,  315532,  345946,  409979,  420140,  480460,  616664 ,  2283948,  3064166,  6318185
          ,  42722 ,  90654,  137251,  187461,  232106,  276537,  316717,  345970,  409995,  420166,  481912,  833770 ,  2283964,  3076440,  6329896
          ,  43753 ,  92770,  138169,  188549,  232513,  276677,  318817,  345997,  410365,  420204,  482676,  884715 ,  2284111,  3123111,  6331122
          ,  44466 ,  93386,  140040,  188620,  233099,  277207,  320277,  347280,  410446,  420247,  484911,  895687 ,  2320770,  3132811,  6371566
          ,  45012 ,  94323,  140295,  188999,  233617,  278947,  320528,  348180,  410802,  420255,  485969,  917117 ,  2321564,  3149722,  6431879
          ,  47120 ,  94790,  141410,  189472,  234389,  279218,  321249,  348643,  410888,  420271,  487872,  938181 ,  2321599,  3511308,  6437605
          ,  48429 ,  95907,  143472,  192090,  237159,  281395,  321702,  348678,  411086,  420301,  489140,  951102 ,  2367289,  3511391,  6438334
          ,  49522 ,  96202,  143855,  192163,  237930,  282472,  322202,  348996,  411760,  420310,  489743,  963275 ,  2408694,  3512070,  6438474
          ,  50474 ,  97187,  144576,  192570,  237949,  282510,  322288,  350079,  412040,  420328,  493082,  1837931,  2409909,  3512509,  6442528
          ,  51586 ,  97950,  147400,  193054,  239089,  282642,  322512,  350230,  412287,  420344,  495824,  1887300,  2428814,  3541401,  6443060
          ,  52833 ,  98671,  148326,  194000,  241792,  282715,  322806,  350494,  413089,  420352,  497096,  1908480,  2428830,  3586669,  6467636
          ,  53953 ,  99317,  148644,  194336,  241857,  282723,  323446,  351733,  413755,  420395,  498335,  1908979,  2429322,  3586774,  6468780
          ,  54925 ,  99856,  149616,  194514,  242110,  282979,  323578,  353329,  413771,  420409,  504181,  1909053,  2429543,  3611213,  6522246)
     AND    flgctitg <> 3
     ORDER BY nrdconta;

    rw_crapass       cr_crapass%rowtype;
    vr_qtdcta        NUMBER;
BEGIN
  FOR rw_crapass IN cr_crapass LOOP
    BEGIN
      --Atualiza status da conta ITG
      UPDATE CRAPASS
      SET    flgctitg = 3
      WHERE  cdcooper = rw_crapass.cdcooper
      AND    nrdconta = rw_crapass.nrdconta;
    END;

    BEGIN
      --Inclui log de alteração da conta ITG
      INSERT INTO crapalt 
        (nrdconta
        ,dtaltera
        ,cdoperad
        ,dsaltera
        ,tpaltera
        ,flgctitg
        ,cdcooper)
      VALUES
        (rw_crapass.nrdconta
        ,sysdate
        ,1
        ,'exclusao conta-itg('||rw_crapass.nrdctitg||')- ope.1'
        ,2 
        ,0  --nao enviada
        ,rw_crapass.cdcooper);
    END;
    vr_qtdcta := cr_crapass%rowcount;
  END LOOP;
  
  dbms_output.put_line('Qtde contas atualizadas:'||vr_qtdcta);
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN 
    ROLLBACK;
END;
