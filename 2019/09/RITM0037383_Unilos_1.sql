--REQ0037383 - Ana - 23/09/2019
DECLARE
  --Busca contas - Unilos
  CURSOR cr_crapass IS
    SELECT cdcooper, nrdconta, nrdctitg, flgctitg
    FROM   CRAPASS 
    WHERE  cdcooper = 6 --Unilos
    AND    nrdconta IN (  19,  51,  60,  78,  94,  108,  116,  132,  159,  167,  191,  230,  264,  299,  329,  345,  353,  361,  370,  450,  469,  477,  493,  540,  574,  604,  671,  680,  728
          ,  825,  868,  876,  884,  892,  957,  965,  1015,  1031,  1066,  1104,  1120,  1139,  1163,  1228,  1244,  1406,  1422,  1465,  1473,  1490,  1511,  1619,  1627,  1694
          ,  1708,  1732,  1759,  1791,  1813,  1821,  1830,  1848,  1945,  1953,  1996,  2003,  2100,  2127,  2208,  2216,  2224,  2275,  2291,  2305,  2313,  2402,  2461,  2500
          ,  2518,  2550,  2623,  2704,  2801,  2895,  2917,  2941,  2968,  3000,  3018,  3077,  3093,  3115,  3140,  3158,  3166,  3174,  3212,  3301,  3336,  3352,  3360,  3379
          ,  3387,  3409,  3425,  3433,  3492,  3506,  3522,  3530,  3565,  3700,  3816,  3824,  3875,  3948,  4006,  4014,  4030,  4154,  4162,  4189,  4308,  4383,  4430,  4448
          ,  4464,  4588,  4723,  4758,  4766,  4820,  4855,  4936,  5029,  5126,  5177,  5207,  5274,  5320,  5355,  5371,  5380,  5428,  5444,  5487,  5495,  5509,  5525,  5533
          ,  5576,  5592,  5614,  5622,  5665,  5690,  5703,  5711,  5746,  5789,  5843,  5932,  5959,  6025,  6041,  6050,  6084,  6106,  6238,  6289,  6327,  6335,  6378,  6394
          ,  6440,  6572,  6580,  6602,  6629,  6726,  6734,  6777,  6793,  6858,  6890,  6912,  6955,  6998,  7030,  7064,  7080,  7196,  7234,  7269,  7285,  7307,  7340,  7404
          ,  7412,  7498,  7552,  7692,  7749,  7781,  7803,  7811,  7862,  7889,  7935,  7978,  7986,  8060,  8095,  8125,  8168,  8354,  8397,  8486,  8494,  8532,  8559,  8621
          ,  8656,  8710,  8737,  8745,  8761,  8826,  8850,  8907,  8915,  8940,  8990,  9008,  9040,  9067,  9083,  9121,  9229,  9237,  9270,  9288,  9296,  9300,  9342,  9350
          ,  9369,  9377,  9415,  9431,  9458,  9466,  9504,  9547,  9644,  9652,  9695,  9709,  9750,  9784,  9822,  9873,  9903,  9911,  9920,  9938,  10049,  10057,  10103,  10120
          ,  10138,  10154,  10162,  10170,  10197,  10200,  10251,  10260,  10278,  10286,  10308,  10332,  10367,  10448,  10456,  10464,  10472,  10480,  10499,  10553,  10588
          ,  10596,  10618,  10626,  10650,  10669,  10677,  10723,  10774,  10782,  10839,  10855,  10863,  10871,  10901,  10936,  10944,  10960,  10979,  11010,  11037,  11061
          ,  11070,  11096,  11118,  11126,  11134,  11142,  11207,  11223,  11258,  11347,  11355,  11380,  11401,  11479,  11509,  11525,  11576,  11711,  11754,  11800,  11843
          ,  11851,  11860,  11878,  11908,  11916,  11991,  12041,  12068,  12114,  12157,  12181,  12203,  12319,  12327,  12335,  12386,  12394,  12432,  12440,  12467,  12530
          ,  12572,  12610,  12629,  12645,  12769,  12793,  12840,  12874,  12890,  12904,  12947,  12963,  12980,  12998,  13048,  13110,  13129,  13170,  13196,  13307,  13331
          ,  13447,  13455,  13471,  13498,  13510,  13552,  13579,  13587,  13595,  13625,  13668,  13676,  13730,  13781,  13811,  13838,  13870,  13927,  13951,  13960,  14001
          ,  14010,  14176,  14206,  14249,  14257,  14320,  14338,  14362,  14427,  14443,  14451,  14508,  14559,  14591,  14605,  14613,  14745,  14753,  14800,  14834,  14850
          ,  14885,  14893,  14923,  14940,  14982,  15040,  15083,  15091,  15105,  15121,  15130,  15180,  15202,  15210,  15229,  15245,  15253,  15288,  15296,  15326,  15334
          ,  15342,  15369,  15407,  15458,  15512,  15580,  15601,  15636,  15652,  15709,  15717,  15733,  15750,  15768,  15784,  15792,  15857,  15865,  15881,  15890,  15903
          ,  15920,  15954,  15962,  15997,  16080,  16101,  16110,  16128,  16179,  16276,  16306,  16322,  16330,  16365,  16373,  16403,  16411,  16420,  16462,  16470,  16497
          ,  16543,  16586,  16594,  16608,  16616,  16640,  16659,  16683,  16748,  16772,  16829,  16861,  16888,  16934,  16942,  16969,  17027,  17043,  17051,  17060,  17132
          ,  17159,  17167,  17221,  17299,  17302,  17337,  17361,  17370,  17400,  17418,  17426,  17434,  17442,  17450,  17469,  17507,  17531,  17540,  17566,  17655,  17680
          ,  17698,  17736,  17779,  17787,  17817,  17876,  17906,  17922,  17930,  17957,  17965,  17981,  17990,  18031,  18074,  18082,  18090,  18120,  18171,  18201,  18210
          ,  18228,  18236,  18287,  18295,  18309,  18317,  18333,  18341,  18368,  18376,  18430,  18449,  18465,  18481,  18503,  18546,  18570,  18597,  18627,  18635,  18643
          ,  18651,  18678,  18694,  18724,  18732,  18759,  18791,  18864,  18872,  18902,  18910,  18929,  18953,  18961,  18988,  18996,  19046,  19054,  19070,  19143,  19151
          ,  19186,  19216,  19240,  19267,  19291,  19305,  19321,  19330,  19372,  19380,  19399,  19461,  19470,  19496,  19500,  19518,  19534,  19585,  19631,  19640,  19666
          ,  19682,  19690,  19720,  19747,  19763,  19771,  19828,  19844,  19852,  19917,  19984,  20001,  20010,  20036,  20060,  20109,  20125,  20150,  20265,  20303,  20311
          ,  20354,  20362,  20370,  20389,  20400,  20419,  20443,  20451,  20460,  20591,  20613,  20630,  20656,  20664,  20672,  20680,  20699,  20710,  20729,  20737,  20788
          ,  20796,  20800,  20818,  20834,  20842,  20869,  20877,  20885,  20915,  20923,  20931,  20958,  20966,  20974,  21008,  21016,  21024,  21032,  21040,  21091,  21121
          ,  21130,  21148,  21202,  21210,  21261,  21288,  21296,  21300,  21326,  21334,  21342,  21350,  21369,  21407,  21423,  21466,  21504,  21539,  21571,  21580,  21601
          ,  21628,  21636,  21644,  21687,  21695,  21709,  21725,  21733,  21741,  21768,  21784,  21792,  21890,  21903,  21911,  21954,  21970,  22004,  22080,  22098,  22128
          ,  22144,  22209,  22306,  22330,  22381,  22403,  22527,  22608,  22659,  22683,  22713,  22730,  22764,  22772,  22780,  22802,  22853,  22870,  22969,  23000,  23019
          ,  23027,  23035,  23183,  23191,  23280,  23337,  23345,  23396,  23400,  23515,  23523,  23531,  23639,  23647,  23655,  23680,  23698,  23710,  23736,  23760,  23779
          ,  23787,  23795,  23825,  23833,  23884,  23892,  23914,  23922,  23957,  24015,  24058,  24066,  24082,  24139,  24147,  24163,  24171,  24198,  24201,  24228,  24236
          ,  24279,  24317,  24341,  24384,  24392,  24465,  24538,  24554,  24562,  24570,  24600,  24635,  24716,  24732,  24759,  24767,  24783,  24813,  24937,  24961,  24996
          ,  25003,  25070,  25127,  25151,  25208,  25321,  25364,  25372,  25402,  25496,  25500,  25518,  25577,  25607,  25623,  25755,  25887,  26123,  26131,  26166,  26204
          ,  26522,  26530,  26620,  26999,  27006,  27154,  27170,  27308,  27316,  27537,  27596,  27600,  27618,  27790,  27898,  27936,  28215,  28223,  28347,  28509,  28525
          ,  28533,  28657,  29122,  29432,  29459,  29556,  29670,  29840,  29904,  29947,  29955,  30007,  30023,  30031,  30066,  30074,  30082,  30139,  30171,  30198,  30236
          ,  30244,  30376,  30384,  30457,  30473,  30481,  30490,  30678,  30724,  30732,  30775,  30830,  30848,  30856,  30880,  30899,  31003,  31020,  31054,  31097,  31143
          ,  31224,  31291,  31356,  31500,  31534,  31569,  31585,  31593,  31631,  31640,  31666,  31674,  31720,  31747,  31755,  31763,  31780,  31798,  31852,  31887,  31933
          ,  31950,  31968,  32000,  32034,  32093,  32115,  32204,  32271,  32280,  32298,  32387,  32395,  32417,  32450,  32484,  32514,  32573,  32590,  32603,  32662,  32719
          ,  32727,  32743,  32786,  32808,  32832,  32883,  32921,  32948,  33014,  33073,  33111,  33120,  33138,  33154,  33162,  33189,  33200,  33251,  33260,  33316,  33324
          ,  33332,  33367,  33375,  33405,  33413,  33430,  33480,  33537,  33545,  33553,  33570,  33618,  33626,  33634,  33731,  33782,  33804,  33839,  33898,  33910,  33960
          ,  33979,  33987,  34053,  34061,  34100,  34134,  34142,  34177,  34207,  34231,  34282,  34304,  34339,  34363)
     AND    flgctitg <> 3
     ORDER BY nrdconta;

    rw_crapass       cr_crapass%rowtype;
    vr_qtdcta        NUMBER;
BEGIN
  FOR rw_crapass IN cr_crapass LOOP
    BEGIN
      --Atualiza status da conta ITG
      UPDATE CRAPASS
      SET    flgctitg = 3
      WHERE  cdcooper = rw_crapass.cdcooper
      AND    nrdconta = rw_crapass.nrdconta;
    END;

    BEGIN
      --Inclui log de alteração da conta ITG
      INSERT INTO crapalt 
        (nrdconta
        ,dtaltera
        ,cdoperad
        ,dsaltera
        ,tpaltera
        ,flgctitg
        ,cdcooper)
      VALUES
        (rw_crapass.nrdconta
        ,sysdate
        ,1
        ,'exclusao conta-itg('||rw_crapass.nrdctitg||')- ope.1'
        ,2 
        ,0  --nao enviada
        ,rw_crapass.cdcooper);
    END;
    vr_qtdcta := cr_crapass%rowcount;
  END LOOP;
  
  dbms_output.put_line('Qtde contas atualizadas:'||vr_qtdcta);
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN 
    ROLLBACK;
END;
