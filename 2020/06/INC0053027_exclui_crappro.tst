PL/SQL Developer Test script 3.0
2382
declare 
  vr_contador number;
  vr_dscritic varchar2(500);
  vr_excsaida EXCEPTION;  

  vr_rootmicros      VARCHAR2(5000) := gene0001.fn_param_sistema('CRED',3,'ROOT_MICROS');
  vr_nmdireto        VARCHAR2(4000) := vr_rootmicros||'cpd/bacas/INC0053027';
  vr_nmarqimp        VARCHAR2(100)  := 'INC0053027_ROLLBACK.txt';     
  vr_ind_arquiv      utl_file.file_type;
  
  vr_nmarqimp2        VARCHAR2(100)  := 'INC0053027_atualizados.csv';   
  vr_ind_arquiv2      utl_file.file_type;
  
  TYPE typ_sicredi IS RECORD (idsicred number);  
  TYPE typ_tbsicredi IS TABLE OF typ_sicredi INDEX BY VARCHAR2(20);
  vr_tbsicredi typ_tbsicredi;
    
  cursor cr_protocolos_sic is
    select t.cdcooper cdcooper_lft
      ,t.cdagenci cdagenci_lft
      ,t.nrdconta nrdconta_lft
      ,t.dtmvtolt dtmvtolt_lft
      ,t.vllanmto vllanmto_lft
      ,t.idsicred idsicred_lft
      ,o.*
  FROM craplft t,
       crappro o
 where o.cdcooper = t.cdcooper
   AND o.dtmvtolt = t.dtmvtolt
   AND o.nrdconta = t.nrdconta
   AND o.nrseqaut = t.nrautdoc
   AND o.vldocmto = t.vllanmto
   AND t.cdagenci <> 91
   AND t.idsicred in(220024
                    ,220025
                    ,221760
                    ,255120
                    ,255115
                    ,276281
                    ,323626
                    ,368727
                    ,379376
                    ,380986
                    ,383225
                    ,380016
                    ,380017
                    ,379379
                    ,419530
                    ,398666
                    ,383951
                    ,383953
                    ,388680
                    ,398081
                    ,410141
                    ,408274
                    ,406838
                    ,428665
                    ,434471
                    ,434472
                    ,442506
                    ,442505
                    ,490471
                    ,490470
                    ,498428
                    ,497455
                    ,520227
                    ,513582
                    ,520226
                    ,526845
                    ,526846
                    ,546712
                    ,538773
                    ,542720
                    ,538775
                    ,549197
                    ,549196
                    ,551099
                    ,552602
                    ,553377
                    ,553376
                    ,561693
                    ,561696
                    ,561697
                    ,563884
                    ,563885
                    ,558727
                    ,564364
                    ,564365
                    ,576354
                    ,576353
                    ,568273
                    ,568274
                    ,574915
                    ,569724
                    ,569725
                    ,587435
                    ,587434
                    ,584786
                    ,584785
                    ,599315
                    ,593257
                    ,592002
                    ,592003
                    ,595543
                    ,593260
                    ,599351
                    ,593005
                    ,599350
                    ,593004
                    ,602700
                    ,610186
                    ,601654
                    ,601657
                    ,605943
                    ,601653
                    ,601652
                    ,636340
                    ,636344
                    ,636351
                    ,636335
                    ,632351
                    ,615283
                    ,636345
                    ,636356
                    ,626440
                    ,626442
                    ,626436
                    ,626439
                    ,626443
                    ,626522
                    ,626526
                    ,626445
                    ,626507
                    ,626408
                    ,636383
                    ,636406
                    ,636380
                    ,636382
                    ,636409
                    ,622429
                    ,626406
                    ,636411
                    ,622428
                    ,636376
                    ,636378
                    ,637772
                    ,636371
                    ,636360
                    ,626551
                    ,626540
                    ,626537
                    ,626541
                    ,626549
                    ,626545
                    ,647072
                    ,647073
                    ,651349
                    ,652874
                    ,652872
                    ,650911
                    ,651348
                    ,650913
                    ,655891
                    ,659006
                    ,656123
                    ,655890
                    ,659134
                    ,656879
                    ,656880
                    ,655165
                    ,655166
                    ,656116
                    ,657989
                    ,657988
                    ,656102
                    ,661516
                    ,660515
                    ,665493
                    ,666171
                    ,665494
                    ,672088
                    ,672086
                    ,674787
                    ,674790
                    ,667778
                    ,667777
                    ,672084
                    ,672085
                    ,678618
                    ,678367
                    ,676316
                    ,683385
                    ,683380
                    ,678619
                    ,676253
                    ,687002
                    ,687003
                    ,676315
                    ,676329
                    ,676330
                    ,693776
                    ,693775
                    ,700816
                    ,701705
                    ,713293
                    ,710600
                    ,710599
                    ,711230
                    ,711227
                    ,726236
                    ,726235
                    ,725329
                    ,725327
                    ,738109
                    ,740443
                    ,740447
                    ,752843
                    ,752183
                    ,787937
                    ,787936
                    ,780150
                    ,786608
                    ,786610
                    ,793810
                    ,793809
                    ,797870
                    ,797869
                    ,799592
                    ,803922
                    ,807755
                    ,802293
                    ,802294
                    ,840174
                    ,829085
                    ,836076
                    ,829090
                    ,814436
                    ,824026
                    ,824020
                    ,814103
                    ,825085
                    ,831351
                    ,828404
                    ,827543
                    ,832673
                    ,830980
                    ,832681
                    ,846728
                    ,831352
                    ,853286
                    ,853287
                    ,857374
                    ,855401
                    ,858223
                    ,857379
                    ,848971
                    ,848972
                    ,859612
                    ,858787
                    ,867322
                    ,866331
                    ,866332
                    ,864784
                    ,869568
                    ,869853
                    ,864783
                    ,869852
                    ,867313
                    ,867321
                    ,873522
                    ,876168
                    ,873519
                    ,877683
                    ,876167
                    ,873812
                    ,876165
                    ,876781
                    ,876166
                    ,876780
                    ,880674
                    ,882398
                    ,880675
                    ,889652
                    ,890473
                    ,890475
                    ,890477
                    ,887437
                    ,887439
                    ,890472
                    ,889651
                    ,887702
                    ,887701
                    ,887705
                    ,887704
                    ,888660
                    ,897091
                    ,898973
                    ,897092
                    ,892061
                    ,892060
                    ,896052
                    ,896053
                    ,894885
                    ,898971
                    ,894880
                    ,892022
                    ,891704
                    ,892023
                    ,897461
                    ,906804
                    ,898215
                    ,891703
                    ,898212
                    ,898200
                    ,921323
                    ,933076
                    ,927903
                    ,928680
                    ,974007
                    ,966594
                    ,1000404
                    ,1014715
                    ,1014714
                    ,1017963
                    ,1017964
                    ,1027389
                    ,1017960
                    ,1017961
                    ,1017962
                    ,1038838
                    ,1035710
                    ,1046601
                    ,1046588
                    ,1058751
                    ,1061894
                    ,1057517
                    ,1070213
                    ,1067472
                    ,1056822
                    ,1042058
                    ,1070247
                    ,1123735
                    ,1115225
                    ,1152408
                    ,1152407
                    ,1163056
                    ,1163057
                    ,1158184
                    ,1158183
                    ,1187403
                    ,1189607
                    ,1189605
                    ,1185817
                    ,1185332
                    ,1185334
                    ,1189018
                    ,1189017
                    ,1189023
                    ,1189024
                    ,1181895
                    ,1184150
                    ,1202354
                    ,1194963
                    ,1194962
                    ,1210707
                    ,1229389
                    ,1228934
                    ,1229388
                    ,1224437
                    ,1224436
                    ,1228933
                    ,1239845
                    ,1245733
                    ,1241689
                    ,1245353
                    ,1239220
                    ,1252251
                    ,1250319
                    ,1248659
                    ,1252253
                    ,1259282
                    ,1257007
                    ,1286394
                    ,1286297
                    ,1273021
                    ,1290761
                    ,1284376
                    ,1281700
                    ,1265470
                    ,1274231
                    ,1267644
                    ,1290231
                    ,1267603
                    ,1274313
                    ,1269491
                    ,1274279
                    ,1274254
                    ,1274260)
UNION ALL
  select p.cdcooper cdcooper_lft
      ,p.cdagenci cdagenci_lft
      ,p.nrctapag nrdconta_lft
      ,p.dtmvtolt dtmvtolt_lft
      ,p.vlrtotal vllanmto_lft
      ,p.idsicred idsicred_lft
      ,o.*
  FROM craplgp p,
       crappro o
 where o.cdcooper = p.cdcooper
   AND o.dtmvtolt = p.dtmvtolt
   AND o.nrdconta = p.nrctapag
   AND o.nrseqaut = p.nrautdoc
   AND o.vldocmto = p.vlrtotal
   AND p.nrctapag > 0
   AND p.cdagenci <> 91
   AND p.idsicred in(220024
                    ,220025
                    ,221760
                    ,255120
                    ,255115
                    ,276281
                    ,323626
                    ,368727
                    ,379376
                    ,380986
                    ,383225
                    ,380016
                    ,380017
                    ,379379
                    ,419530
                    ,398666
                    ,383951
                    ,383953
                    ,388680
                    ,398081
                    ,410141
                    ,408274
                    ,406838
                    ,428665
                    ,434471
                    ,434472
                    ,442506
                    ,442505
                    ,490471
                    ,490470
                    ,498428
                    ,497455
                    ,520227
                    ,513582
                    ,520226
                    ,526845
                    ,526846
                    ,546712
                    ,538773
                    ,542720
                    ,538775
                    ,549197
                    ,549196
                    ,551099
                    ,552602
                    ,553377
                    ,553376
                    ,561693
                    ,561696
                    ,561697
                    ,563884
                    ,563885
                    ,558727
                    ,564364
                    ,564365
                    ,576354
                    ,576353
                    ,568273
                    ,568274
                    ,574915
                    ,569724
                    ,569725
                    ,587435
                    ,587434
                    ,584786
                    ,584785
                    ,599315
                    ,593257
                    ,592002
                    ,592003
                    ,595543
                    ,593260
                    ,599351
                    ,593005
                    ,599350
                    ,593004
                    ,602700
                    ,610186
                    ,601654
                    ,601657
                    ,605943
                    ,601653
                    ,601652
                    ,636340
                    ,636344
                    ,636351
                    ,636335
                    ,632351
                    ,615283
                    ,636345
                    ,636356
                    ,626440
                    ,626442
                    ,626436
                    ,626439
                    ,626443
                    ,626522
                    ,626526
                    ,626445
                    ,626507
                    ,626408
                    ,636383
                    ,636406
                    ,636380
                    ,636382
                    ,636409
                    ,622429
                    ,626406
                    ,636411
                    ,622428
                    ,636376
                    ,636378
                    ,637772
                    ,636371
                    ,636360
                    ,626551
                    ,626540
                    ,626537
                    ,626541
                    ,626549
                    ,626545
                    ,647072
                    ,647073
                    ,651349
                    ,652874
                    ,652872
                    ,650911
                    ,651348
                    ,650913
                    ,655891
                    ,659006
                    ,656123
                    ,655890
                    ,659134
                    ,656879
                    ,656880
                    ,655165
                    ,655166
                    ,656116
                    ,657989
                    ,657988
                    ,656102
                    ,661516
                    ,660515
                    ,665493
                    ,666171
                    ,665494
                    ,672088
                    ,672086
                    ,674787
                    ,674790
                    ,667778
                    ,667777
                    ,672084
                    ,672085
                    ,678618
                    ,678367
                    ,676316
                    ,683385
                    ,683380
                    ,678619
                    ,676253
                    ,687002
                    ,687003
                    ,676315
                    ,676329
                    ,676330
                    ,693776
                    ,693775
                    ,700816
                    ,701705
                    ,713293
                    ,710600
                    ,710599
                    ,711230
                    ,711227
                    ,726236
                    ,726235
                    ,725329
                    ,725327
                    ,738109
                    ,740443
                    ,740447
                    ,752843
                    ,752183
                    ,787937
                    ,787936
                    ,780150
                    ,786608
                    ,786610
                    ,793810
                    ,793809
                    ,797870
                    ,797869
                    ,799592
                    ,803922
                    ,807755
                    ,802293
                    ,802294
                    ,840174
                    ,829085
                    ,836076
                    ,829090
                    ,814436
                    ,824026
                    ,824020
                    ,814103
                    ,825085
                    ,831351
                    ,828404
                    ,827543
                    ,832673
                    ,830980
                    ,832681
                    ,846728
                    ,831352
                    ,853286
                    ,853287
                    ,857374
                    ,855401
                    ,858223
                    ,857379
                    ,848971
                    ,848972
                    ,859612
                    ,858787
                    ,867322
                    ,866331
                    ,866332
                    ,864784
                    ,869568
                    ,869853
                    ,864783
                    ,869852
                    ,867313
                    ,867321
                    ,873522
                    ,876168
                    ,873519
                    ,877683
                    ,876167
                    ,873812
                    ,876165
                    ,876781
                    ,876166
                    ,876780
                    ,880674
                    ,882398
                    ,880675
                    ,889652
                    ,890473
                    ,890475
                    ,890477
                    ,887437
                    ,887439
                    ,890472
                    ,889651
                    ,887702
                    ,887701
                    ,887705
                    ,887704
                    ,888660
                    ,897091
                    ,898973
                    ,897092
                    ,892061
                    ,892060
                    ,896052
                    ,896053
                    ,894885
                    ,898971
                    ,894880
                    ,892022
                    ,891704
                    ,892023
                    ,897461
                    ,906804
                    ,898215
                    ,891703
                    ,898212
                    ,898200
                    ,921323
                    ,933076
                    ,927903
                    ,928680
                    ,974007
                    ,966594
                    ,1000404
                    ,1014715
                    ,1014714
                    ,1017963
                    ,1017964
                    ,1027389
                    ,1017960
                    ,1017961
                    ,1017962
                    ,1038838
                    ,1035710
                    ,1046601
                    ,1046588
                    ,1058751
                    ,1061894
                    ,1057517
                    ,1070213
                    ,1067472
                    ,1056822
                    ,1042058
                    ,1070247
                    ,1123735
                    ,1115225
                    ,1152408
                    ,1152407
                    ,1163056
                    ,1163057
                    ,1158184
                    ,1158183
                    ,1187403
                    ,1189607
                    ,1189605
                    ,1185817
                    ,1185332
                    ,1185334
                    ,1189018
                    ,1189017
                    ,1189023
                    ,1189024
                    ,1181895
                    ,1184150
                    ,1202354
                    ,1194963
                    ,1194962
                    ,1210707
                    ,1229389
                    ,1228934
                    ,1229388
                    ,1224437
                    ,1224436
                    ,1228933
                    ,1239845
                    ,1245733
                    ,1241689
                    ,1245353
                    ,1239220
                    ,1252251
                    ,1250319
                    ,1248659
                    ,1252253
                    ,1259282
                    ,1257007
                    ,1286394
                    ,1286297
                    ,1273021
                    ,1290761
                    ,1284376
                    ,1281700
                    ,1265470
                    ,1274231
                    ,1267644
                    ,1290231
                    ,1267603
                    ,1274313
                    ,1269491
                    ,1274279
                    ,1274254
                    ,1274260);                    
 rw_protocolos_sic cr_protocolos_sic%ROWTYPE;
 
 CURSOR cr_protocolos_todos IS
 select p.cdcooper cdcooper
      ,p.cdagenci cdagenci
      ,p.nrctapag nrdconta
      ,p.dtmvtolt dtmvtolt
      ,p.vlrtotal vllanmto
      ,p.idsicred idsicred
      ,o.dsprotoc dsprotoc
      ,o.progress_recid 
  FROM craplgp p,
       crappro o  
 where o.cdcooper = p.cdcooper
   AND o.dtmvtolt = p.dtmvtolt
   AND o.nrdconta = p.nrctapag
   AND o.nrseqaut = p.nrautdoc
   AND o.vldocmto = p.vlrtotal
   AND p.nrctapag > 0 
   AND p.idsicred in(553376
,553377
,552602
,549196
,549197
,549125
,551099
,561693
,561696
,561697
,558727
,563884
,563885
,564364
,564365
,568273
,568274
,576353
,576354
,569724
,569725
,568189
,587434
,587435
,584785
,584786
,593257
,593260
,592002
,592003
,599315
,599350
,599351
,591832
,598452
,593004
,593005
,602700
,605943
,601652
,601653
,601654
,601657
,607820
,610186
,626507
,615283
,621096
,622428
,622429
,623458
,626406
,626408
,626436
,626439
,626440
,626442
,626443
,626445
,626522
,626526
,626537
,626540
,626541
,626545
,626549
,626551
,632351
,636345
,614474
,622315
,641553
,626125
,645957
,647134
,649061
,647072
,647073
,648301
,647361
,650911
,650913
,650921
,651348
,651349
,652872
,652874
,655890
,655891
,656102
,656116
,656123
,658925
,659006
,657988
,657989
,659134
,656879
,656880
,655165
,655166
,660515
,661516
,666171
,665493
,665494
,672084
,672085
,672086
,672088
,667777
,667778
,671369
,674787
,674790
,676253
,676315
,676316
,676329
,676330
,678367
,678670
,683380
,683385
,687002
,687003
,678618
,678619
,694093
,693945
,693947
,693949
,693954
,693956
,693964
,693965
,693973
,693975
,693994
,693995
,694001
,694002
,694006
,694088
,694089
,694090
,694095
,694096
,694099
,694101
,694102
,694105
,694110
,694111
,694113
,694114
,694115
,694116
,694120
,694121
,694125
,694129
,694130
,694131
,694135
,694141
,694144
,694147
,694150
,694151
,694103
,694109
,694117
,694133
,694168
,694165
,694175
,694171
,694176
,694032
,694190
,694188
,694195
,693775
,693776
,694207
,701705
,700816
,711227
,711230
,712374
,713293
,711555
,710599
,710600
,706586
,725327
,725329
,720953
,720981
,726235
,726236
,733698
,738109
,740443
,740447
,741301
,742039
,743542
,752843
,759344
,752029
,752183
,774932
,780150
,780381
,786608
,786610
,787936
,787937
,797869
,797870
,793809
,793810
,799592
,802293
,802294
,807755
,800406
,803922
,840174
,831351
,831352
,832673
,832681
,814103
,814436
,824020
,824026
,827080
,835645
,839726
,839744
,848333
,831195
,845522
,825085
,823977
,828404
,846728
,855401
,848971
,848972
,855197
,857374
,857379
,856705
,858223
,858621
,853286
,853287
,858787
,859612
,864783
,864784
,865642
,866331
,866332
,867313
,867321
,867322
,867978
,869852
,869853
,869516
,869568
,876165
,876166
,876167
,876168
,873519
,873522
,873812
,876780
,876781
,877683
,880488
,880489
,880492
,880493
,880494
,882398
,884722
,882823
,882824
,882825
,882826
,882827
,880674
,880675
,882087
,890472
,890473
,890475
,890477
,887701
,887702
,887704
,887705
,887437
,887439
,888660
,890427
,889651
,889652
,890160
,896052
,896053
,897461
,898971
,898973
,898212
,898215
,898200
,891703
,891704
,892022
,892023
,892060
,892061
,894196
,894880
,894885
,904024
,906804
,897091
,897092
,911410
,918214
,927903
,928680
,929724
,930871
,933076
,942986
,936198
,935285
,945780
,947109
,948429
,966594
,974007
,996072
,1000404
,1004359
,1014714
,1014715
,1017960
,1017961
,1017962
,1017963
,1017964
,1027389
,1035710
,1038838
,1070247
,1061894
,1042058
,1045818
,1046588
,1046601
,1052213
,1057517
,1058751
,1062226
,1070213
,1075382
,1067472
,1045997
,1055748
,1060186
,1056822
,1075458
,1092456
,1099838
,1105501
,1105855
,1106815
,1115225
,1115235
,1123735
,1127122
,1127125
,1131058
,1131059
,1152407
,1152408
,1158183
,1158184
,1155482
,1163056
,1163057
,1172607
,1187403
,1184150
,1189605
,1189607
,1185332
,1185334
,1185817
,1189017
,1189018
,1189023
,1189024
,1181895
,1202354
,1194962
,1194963
,1192474
,1210707
,1228933
,1228934
,1229388
,1229389
,1235726
,1224436
,1224437
,1240380
,1239845
,1239220
,1240364
,1240366
,1240367
,1240369
,1240371
,1240372
,1240376
,1240384
,1240387
,1240390
,1240394
,1240414
,1241689
,1242058
,1245353
,1245733
,1240377
,1252251
,1252253
,1248659
,1250319
,1259282
,1257007
,1274313
,1265470
,1269491
,1273021
,1274231
,1274254
,1274260
,1274279
,1284376
,1290761
,1286297
,1267603
,1267644
,1286394
,1273954
,1290231
,1273738
,1281700
,1275386
,1275393
,1276614
,1276617
,1290550
,1304442
,1304443
,1292266
,1292267
,1292268
,1292269
,1292270
,1292271
,1292272
,1292273
,1292274
,1292275
,1292276
,1292277
,1292278
,1292279
,1292280
,1292281
,1292282
,1292283
,1292284
,1292285
,1292286
,1292287
,1292288
,1292289
,1292290
,1292291
,1292292
,1292293
,1292294
,1292295
,1292296
,1292297
,1292298
,1292299
,1292300
,1292301
,1292302
,1292303
,1292304
,1292305
,1292306
,1292307
,1292308
,1292309
,1292310
,1292311
,1292312
,1292313
,1292314
,1292315
,1292316
,1292317
,1292319
,1292320
,1292321
,1292322
,1292323
,1292325
,1292327
,1292328
,1292329
,1292330
,1292331
,1292332
,1292333
,1292334
,1292335
,1292336
,1292337
,1292338
,1292339
,1292340
,1292341
,1292342
,1292343
,1292344
,1292345
,1292346
,1292347
,1292348
,1292349
,1292350
,1292351
,1292352
,1292353
,1292354
,1292355
,1292356
,1292357
,1292358
,1292359
,1292360
,1292361
,1292362
,1292363
,1292364
,1292365
,1292366
,1292367
,1292368
,1292369
,1292370
,1292371
,1292372
,1292373
,1292374
,1292375
,1292376
,1292377
,1292378
,1292379
,1292380
,1292381
,1292382
,1292383
,1292384
,1292385
,1292386
,1292387
,1292388
,1292389
,1292456
,1292457
,1292458
,1292459
,1292460
,1292461
,1292462
,1292463
,1292464
,1292465
,1292466
,1292467
,1292478
,1292479
,1292480
,1292481
,1292482
,1292483
,1292484
,1292485
,1292486
,1292487
,1292488
,1292489
,1292490
,1292491
,1292513
,1292514
,1292551
,1292564
,1292565
,1297058
,1305783
,1292318
,1292324
,1292326
,1292390
,1292391
,1292392
,1292393
,1292394
,1292395
,1292396
,1292397
,1292398
,1292399
,1292400
,1292401
,1292402
,1292403
,1292404
,1292468
,1292405
,1292406
,1292407
,1292408
,1292409
,1292410
,1292411
,1292469
,1292470
,1292471
,1292492
,1292493
,1292494
,1292495
,1292496
,1292412
,1292413
,1292414
,1292415
,1292416
,1292417
,1292418
,1292419
,1292420
,1292421
,1292422
,1292423
,1292472
,1292473
,1292474
,1292424
,1292425
,1292475
,1297006
,1292426
,1292427
,1292428
,1292429
,1292430
,1292431
,1292432
,1292433
,1292434
,1292435
,1292436
,1292437
,1292438
,1292439
,1292476
,1292440
,1292441
,1292442
,1292443
,1292444
,1292445
,1292446
,1292447
,1292448
,1292449
,1292450
,1292451
,1292452
,1292453
,1292454
,1292455
,1292477
,1292497
,1292498
,1292499
,1292500
,1292501
,1292502)
UNION ALL
SELECT t.cdcooper cdcooper
      ,t.cdagenci cdagenci
      ,t.nrdconta nrdconta
      ,t.dtmvtolt dtmvtolt
      ,t.vllanmto vllanmto
      ,t.idsicred idsicred
      ,o.dsprotoc dsprotoc
      ,o.progress_recid 
FROM craplft t,
       crappro o
 where o.cdcooper = t.cdcooper
   AND o.dtmvtolt = t.dtmvtolt
   AND o.nrdconta = t.nrdconta
   AND o.nrseqaut = t.nrautdoc
   AND o.vldocmto = t.vllanmto
   AND t.cdagenci <> 91
   AND t.idsicred IN(553376
,553377
,552602
,549196
,549197
,549125
,551099
,561693
,561696
,561697
,558727
,563884
,563885
,564364
,564365
,568273
,568274
,576353
,576354
,569724
,569725
,568189
,587434
,587435
,584785
,584786
,593257
,593260
,592002
,592003
,599315
,599350
,599351
,591832
,598452
,593004
,593005
,602700
,605943
,601652
,601653
,601654
,601657
,607820
,610186
,626507
,615283
,621096
,622428
,622429
,623458
,626406
,626408
,626436
,626439
,626440
,626442
,626443
,626445
,626522
,626526
,626537
,626540
,626541
,626545
,626549
,626551
,632351
,636345
,614474
,622315
,641553
,626125
,645957
,647134
,649061
,647072
,647073
,648301
,647361
,650911
,650913
,650921
,651348
,651349
,652872
,652874
,655890
,655891
,656102
,656116
,656123
,658925
,659006
,657988
,657989
,659134
,656879
,656880
,655165
,655166
,660515
,661516
,666171
,665493
,665494
,672084
,672085
,672086
,672088
,667777
,667778
,671369
,674787
,674790
,676253
,676315
,676316
,676329
,676330
,678367
,678670
,683380
,683385
,687002
,687003
,678618
,678619
,694093
,693945
,693947
,693949
,693954
,693956
,693964
,693965
,693973
,693975
,693994
,693995
,694001
,694002
,694006
,694088
,694089
,694090
,694095
,694096
,694099
,694101
,694102
,694105
,694110
,694111
,694113
,694114
,694115
,694116
,694120
,694121
,694125
,694129
,694130
,694131
,694135
,694141
,694144
,694147
,694150
,694151
,694103
,694109
,694117
,694133
,694168
,694165
,694175
,694171
,694176
,694032
,694190
,694188
,694195
,693775
,693776
,694207
,701705
,700816
,711227
,711230
,712374
,713293
,711555
,710599
,710600
,706586
,725327
,725329
,720953
,720981
,726235
,726236
,733698
,738109
,740443
,740447
,741301
,742039
,743542
,752843
,759344
,752029
,752183
,774932
,780150
,780381
,786608
,786610
,787936
,787937
,797869
,797870
,793809
,793810
,799592
,802293
,802294
,807755
,800406
,803922
,840174
,831351
,831352
,832673
,832681
,814103
,814436
,824020
,824026
,827080
,835645
,839726
,839744
,848333
,831195
,845522
,825085
,823977
,828404
,846728
,855401
,848971
,848972
,855197
,857374
,857379
,856705
,858223
,858621
,853286
,853287
,858787
,859612
,864783
,864784
,865642
,866331
,866332
,867313
,867321
,867322
,867978
,869852
,869853
,869516
,869568
,876165
,876166
,876167
,876168
,873519
,873522
,873812
,876780
,876781
,877683
,880488
,880489
,880492
,880493
,880494
,882398
,884722
,882823
,882824
,882825
,882826
,882827
,880674
,880675
,882087
,890472
,890473
,890475
,890477
,887701
,887702
,887704
,887705
,887437
,887439
,888660
,890427
,889651
,889652
,890160
,896052
,896053
,897461
,898971
,898973
,898212
,898215
,898200
,891703
,891704
,892022
,892023
,892060
,892061
,894196
,894880
,894885
,904024
,906804
,897091
,897092
,911410
,918214
,927903
,928680
,929724
,930871
,933076
,942986
,936198
,935285
,945780
,947109
,948429
,966594
,974007
,996072
,1000404
,1004359
,1014714
,1014715
,1017960
,1017961
,1017962
,1017963
,1017964
,1027389
,1035710
,1038838
,1070247
,1061894
,1042058
,1045818
,1046588
,1046601
,1052213
,1057517
,1058751
,1062226
,1070213
,1075382
,1067472
,1045997
,1055748
,1060186
,1056822
,1075458
,1092456
,1099838
,1105501
,1105855
,1106815
,1115225
,1115235
,1123735
,1127122
,1127125
,1131058
,1131059
,1152407
,1152408
,1158183
,1158184
,1155482
,1163056
,1163057
,1172607
,1187403
,1184150
,1189605
,1189607
,1185332
,1185334
,1185817
,1189017
,1189018
,1189023
,1189024
,1181895
,1202354
,1194962
,1194963
,1192474
,1210707
,1228933
,1228934
,1229388
,1229389
,1235726
,1224436
,1224437
,1240380
,1239845
,1239220
,1240364
,1240366
,1240367
,1240369
,1240371
,1240372
,1240376
,1240384
,1240387
,1240390
,1240394
,1240414
,1241689
,1242058
,1245353
,1245733
,1240377
,1252251
,1252253
,1248659
,1250319
,1259282
,1257007
,1274313
,1265470
,1269491
,1273021
,1274231
,1274254
,1274260
,1274279
,1284376
,1290761
,1286297
,1267603
,1267644
,1286394
,1273954
,1290231
,1273738
,1281700
,1275386
,1275393
,1276614
,1276617
,1290550
,1304442
,1304443
,1292266
,1292267
,1292268
,1292269
,1292270
,1292271
,1292272
,1292273
,1292274
,1292275
,1292276
,1292277
,1292278
,1292279
,1292280
,1292281
,1292282
,1292283
,1292284
,1292285
,1292286
,1292287
,1292288
,1292289
,1292290
,1292291
,1292292
,1292293
,1292294
,1292295
,1292296
,1292297
,1292298
,1292299
,1292300
,1292301
,1292302
,1292303
,1292304
,1292305
,1292306
,1292307
,1292308
,1292309
,1292310
,1292311
,1292312
,1292313
,1292314
,1292315
,1292316
,1292317
,1292319
,1292320
,1292321
,1292322
,1292323
,1292325
,1292327
,1292328
,1292329
,1292330
,1292331
,1292332
,1292333
,1292334
,1292335
,1292336
,1292337
,1292338
,1292339
,1292340
,1292341
,1292342
,1292343
,1292344
,1292345
,1292346
,1292347
,1292348
,1292349
,1292350
,1292351
,1292352
,1292353
,1292354
,1292355
,1292356
,1292357
,1292358
,1292359
,1292360
,1292361
,1292362
,1292363
,1292364
,1292365
,1292366
,1292367
,1292368
,1292369
,1292370
,1292371
,1292372
,1292373
,1292374
,1292375
,1292376
,1292377
,1292378
,1292379
,1292380
,1292381
,1292382
,1292383
,1292384
,1292385
,1292386
,1292387
,1292388
,1292389
,1292456
,1292457
,1292458
,1292459
,1292460
,1292461
,1292462
,1292463
,1292464
,1292465
,1292466
,1292467
,1292478
,1292479
,1292480
,1292481
,1292482
,1292483
,1292484
,1292485
,1292486
,1292487
,1292488
,1292489
,1292490
,1292491
,1292513
,1292514
,1292551
,1292564
,1292565
,1297058
,1305783
,1292318
,1292324
,1292326
,1292390
,1292391
,1292392
,1292393
,1292394
,1292395
,1292396
,1292397
,1292398
,1292399
,1292400
,1292401
,1292402
,1292403
,1292404
,1292468
,1292405
,1292406
,1292407
,1292408
,1292409
,1292410
,1292411
,1292469
,1292470
,1292471
,1292492
,1292493
,1292494
,1292495
,1292496
,1292412
,1292413
,1292414
,1292415
,1292416
,1292417
,1292418
,1292419
,1292420
,1292421
,1292422
,1292423
,1292472
,1292473
,1292474
,1292424
,1292425
,1292475
,1297006
,1292426
,1292427
,1292428
,1292429
,1292430
,1292431
,1292432
,1292433
,1292434
,1292435
,1292436
,1292437
,1292438
,1292439
,1292476
,1292440
,1292441
,1292442
,1292443
,1292444
,1292445
,1292446
,1292447
,1292448
,1292449
,1292450
,1292451
,1292452
,1292453
,1292454
,1292455
,1292477
,1292497
,1292498
,1292499
,1292500
,1292501
,1292502);
rw_protocolos_todos cr_protocolos_todos%ROWTYPE;
 
begin
  vr_contador:=0;
  
  --Criar arquivo do rollback
  gene0001.pc_abre_arquivo(pr_nmdireto => vr_nmdireto        --> Diretorio do arquivo
                          ,pr_nmarquiv => vr_nmarqimp        --> Nome do arquivo
                          ,pr_tipabert => 'W'                --> modo de abertura (r,w,a)
                          ,pr_utlfileh => vr_ind_arquiv      --> handle do arquivo aberto
                          ,pr_des_erro => vr_dscritic);      --> erro
  -- em caso de crítica
  IF vr_dscritic IS NOT NULL THEN        
    RAISE vr_excsaida;
  END IF;
  
  --Criar arquivo dos registros atualizados
  gene0001.pc_abre_arquivo(pr_nmdireto => vr_nmdireto        --> Diretorio do arquivo
                          ,pr_nmarquiv => vr_nmarqimp2        --> Nome do arquivo
                          ,pr_tipabert => 'W'                --> modo de abertura (r,w,a)
                          ,pr_utlfileh => vr_ind_arquiv2      --> handle do arquivo aberto
                          ,pr_des_erro => vr_dscritic);      --> erro
  -- em caso de crítica
  IF vr_dscritic IS NOT NULL THEN        
    RAISE vr_excsaida;
  END IF;
  
  gene0001.pc_escr_linha_arquivo(vr_ind_arquiv2,'Coop;PA;Conta;Data;Valor;IdSicredi;Protocolo');
  
  vr_tbsicredi.delete;
  
  FOR rw_protocolos_sic IN cr_protocolos_sic LOOP
    
    vr_tbsicredi(to_char(rw_protocolos_sic.idsicred_lft)).idsicred := rw_protocolos_sic.idsicred_lft;
    
    IF rw_protocolos_sic.dsprotoc LIKE '%ESTORNADO%' THEN
      CONTINUE;
    END IF;

    vr_contador:= vr_contador + 1;       
    
    -- Gerar arquivo dos comprovantes que serão atualizados 
    gene0001.pc_escr_linha_arquivo(vr_ind_arquiv2,rw_protocolos_sic.cdcooper_lft||';'||
                                                  rw_protocolos_sic.cdagenci_lft||';'||
                                                  rw_protocolos_sic.nrdconta_lft||';'||
                                                  rw_protocolos_sic.dtmvtolt_lft||';'||
                                                  rw_protocolos_sic.vllanmto_lft||';'||
                                                  rw_protocolos_sic.idsicred_lft||';'||
                                                  rw_protocolos_sic.dsprotoc||chr(13));

    -- Gerar arquivo de rollback
    gene0001.pc_escr_linha_arquivo(vr_ind_arquiv,'UPDATE crappro o SET o.dsprotoc ='''|| rw_protocolos_sic.dsprotoc||''''||
                                                  'WHERE o.progress_recid = '||rw_protocolos_sic.progress_recid||';');
    
    BEGIN
      UPDATE crappro o
         SET o.dsprotoc = o.dsprotoc || ' ' ||'*** ESTORNADO ('||to_char(rw_protocolos_sic.dtmvtolt_lft,'DD/MM/RRRR')||')'
       WHERE o.progress_recid = rw_protocolos_sic.progress_recid;
    EXCEPTION
      WHEN OTHERS THEN
        vr_dscritic := 'Erro ao atualizar crappro! progress_recid: '||
                       rw_protocolos_sic.progress_recid || ' - '|| SQLERRM;
        RAISE vr_excsaida;
    END;
    
  END LOOP; 
  -- Fim do protocolos sic
  
  FOR rw_protocolos_todos IN cr_protocolos_todos LOOP
  
    -- Se ja fez no loop anterior continua
    IF vr_tbsicredi.exists(to_char(rw_protocolos_todos.idsicred)) THEN
      continue;
    END IF;    
    
    IF rw_protocolos_todos.dsprotoc LIKE '%ESTORNADO%' THEN
      CONTINUE;
    END IF;
    
    vr_contador:= vr_contador + 1;       
    
    -- Gerar arquivo dos comprovantes que serão atualizados 
    gene0001.pc_escr_linha_arquivo(vr_ind_arquiv2,rw_protocolos_todos.cdcooper||';'||
                                                  rw_protocolos_todos.cdagenci||';'||
                                                  rw_protocolos_todos.nrdconta||';'||
                                                  rw_protocolos_todos.dtmvtolt||';'||
                                                  rw_protocolos_todos.vllanmto||';'||
                                                  rw_protocolos_todos.idsicred||';'||
                                                  rw_protocolos_todos.dsprotoc||chr(13));

    -- Gerar arquivo de rollback
    gene0001.pc_escr_linha_arquivo(vr_ind_arquiv,'UPDATE crappro o SET o.dsprotoc ='''|| rw_protocolos_todos.dsprotoc||''''||
                                                  'WHERE o.progress_recid = '||rw_protocolos_todos.progress_recid||';');
    
    BEGIN
      UPDATE crappro o
         SET o.dsprotoc = dsprotoc || ' ' ||'*** ESTORNADO ('||to_char(rw_protocolos_todos.dtmvtolt,'DD/MM/RRRR')||')'
       WHERE o.progress_recid = rw_protocolos_todos.progress_recid;
    EXCEPTION
      WHEN OTHERS THEN
        vr_dscritic := 'Erro ao atualizar crappro! progress_recid: '||
                       rw_protocolos_todos.progress_recid || ' - '|| SQLERRM;
        RAISE vr_excsaida;
    END;
    
  END LOOP; 
  
  gene0001.pc_escr_linha_arquivo(vr_ind_arquiv,'commit;');
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquiv); --> Handle do arquivo aberto;  
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquiv2); --> Handle do arquivo aberto;  
  commit;
  
  :vr_dscritic := 'SUCESSO -> Registros atualizados: '|| vr_contador;
EXCEPTION
  WHEN vr_excsaida then 
    gene0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquiv); --> Handle do arquivo aberto;  
    gene0001.pc_fecha_arquivo(pr_utlfileh => vr_ind_arquiv2); --> Handle do arquivo aberto;  
    :vr_dscritic := 'ERRO ' || vr_dscritic;
    rollback;
end;
1
vr_dscritic
1
SUCESSO -> Registros atualizados: 408
5
0
