DECLARE

  -- Tratar 1.134 pagamentos rejeitados indevidamente, 866 comprovantes estornados indevidamente 
  
  vr_exc_erro EXCEPTION;

  CURSOR cr_pagto IS
    SELECT a.cdcooper
          ,a.dsprotoc
          ,r.idsicredi
          ,r.dhinclusao_processamento
          ,r.rowid
      FROM tbconv_registro_remessa_pagfor r
          ,tbconv_remessa_pagfor          p
          ,crapaut                        a
     WHERE -- 158 Pagamentos GPS 22/10/2020 
          (r.idsicredi IN (2250566,2251243,2251244,2251245,2253612,2252195,2252196,2250296,2250297,2250299,2250300,2250301,2250302,2250307,2250309,2253210,2253211,2253212,2253213,2252597,2252598,2251083,2251085,2250146,2252883,2252884,2252885,2252888,2252528,2252529,2252531,2252147,2252564,2252565,2252566,2252567,2251790,2251656,2253136,2251936,2251937,2251218,2251220,2251878,2249862,2251621,2251622,2250117,2253085,2253086,2252669,2252670,2251975,2251271,2251272,2251273,2251274,2250235,2249972,2249973,2249974,2249975,2249976,2249977,2249978,2249979,2250058,2253386,2253387,2253388,2253389,2250196,2251295,2251296,2251297,2252027,2252720,2253313,2253314,2253316,2252636,2252637,2252638,2252639,2250385,2250386,2249873,2251594,2251596,2251597,2250463,2252056,2252057,2252058,2253363,2253366,2250646,2253486,2252104,2250164,2249882,2249883,2251686,2250705,2250706,2252982,2252271,2252272,2251907,2252393,2250900,2250901,2250903,2252426,2252427,2252428,2252429,2253460,2253461,2252815,2252844,2252846,2250334,2250215,2250216,2250218,2250219,2252482,2252483,2252485,2253016,2253169,2253170,2253171,2253412,2253413,2253416,2253417,2253112,2253113,2253114,2252936,2250596,2250441,2251131,2250770,2250771,2250983,2250984,2250985,2250735,2250249,2251434,2253515,2253517,2251855,2252232,2252233)
           -- 306 Pagamentos GPS 27/10/2020
        OR r.idsicredi IN (2264350,2264451,2264452,2264453,2264454,2264455,2264456,2264457,2264458,2264459,2264518,2264533,2264566,2264567,2264635,2264660,2264661,2264662,2264663,2264664,2264665,2264666,2264667,2264668,2264685,2264686,2264687,2264702,2264703,2264747,2264769,2264770,2264780,2264781,2264782,2264800,2264868,2264889,2264890,2264891,2264909,2264931,2264950,2264971,2264972,2265007,2265008,2265009,2265045,2265046,2265166,2265167,2265168,2265169,2265170,2265171,2265172,2265173,2265174,2265175,2265176,2265213,2265214,2265215,2265216,2265251,2265286,2265287,2265288,2265289,2265290,2265291,2265292,2265293,2265305,2265306,2265307,2265369,2265398,2265399,2265400,2265423,2265440,2265492,2265493,2265494,2265495,2265496,2265513,2265533,2265534,2265559,2265596,2265597,2265615,2265631,2265632,2265633,2265634,2265635,2265636,2265637,2265638,2265639,2265661,2265662,2265681,2265682,2265683,2265684,2265717,2265718,2265719,2265720,2265738,2265739,2265740,2265741,2265768,2265769,2265796,2265836,2265837,2265838,2265885,2265886,2265887,2265888,2265889,2265890,2265891,2265912,2265938,2266003,2266004,2266044,2266061,2266062,2266063,2266064,2266065,2266066,2266067,2266068,2266069,2266094,2266095,2266112,2266113,2266148,2266149,2266150,2266151,2266022,2266023,2266193,2266194,2266195,2266196,2266234,2266235,2266236,2266266,2266297,2266368,2266399,2266400,2266401,2266402,2266432,2266433,2266434,2266469,2266493,2266536,2266537,2266538,2266574,2266575,2266642,2266643,2266685,2266686,2266727,2266728,2266729,2266730,2266731,2266732,2266733,2266734,2266795,2266796,2266797,2266798,2266799,2266800,2266801,2266802,2266841,2266882,2266883,2266926,2266927,2266928,2266982,2266983,2266984,2266985,2266986,2267026,2267027,2267028,2267067,2267068,2267069,2267070,2267110,2267111,2267112,2267165,2267166,2267167,2267193,2267194,2267225,2267226,2267227,2267253,2267254,2267255,2267256,2267257,2267258,2267259,2267260,2267261,2267262,2267263,2267264,2267302,2267303,2267361,2267362,2267363,2267364,2267365,2267366,2267367,2267368,2267406,2267431,2267432,2267433,2267434,2267435,2267449,2267450,2267451,2267452,2267453,2267511,2267512,2267537,2267538,2267539,2267540,2267541,2267558,2267559,2267597,2267620,2267621,2267622,2267623,2267624,2267625,2267626,2267668,2267669,2267670,2267671,2267672,2267673,2267674,2267685,2267686,2267687,2267688,2267689,2267703,2267724,2267725,2267749,2267750,2267767,2267794,2267795,2267805,2267823,2267824,2267825,2267839,2267840,2267859,2267869)
           -- 13 Pagamentos DARF 23/10/2020
        OR r.idsicredi IN (2260260,2260261,2260262,2260263,2260285,2260286,2260287,2260288,2260289,2260290,2260291,2260295,2260296)
           -- 657 Pagamentos DARF 27/10/2020
        OR r.idsicredi IN (2264298,2264299,2264321,2264435,2264436,2264437,2264438,2264439,2264440,2264441,2264442,2264443,2264444,2264445,2264446,2264447,2264448,2264449,2264450,2264517,2264532,2264580,2264581,2264597,2264654,2264700,2264701,2264719,2264720,2264721,2264722,2264723,2264724,2264742,2264743,2264744,2264745,2264746,2264760,2264761,2264762,2264763,2264764,2264765,2264766,2264767,2264768,2264776,2264777,2264778,2264779,2264795,2264796,2264797,2264798,2264799,2264828,2264829,2264842,2264843,2264844,2264845,2264846,2264847,2264848,2264867,2264877,2264878,2264879,2264880,2264881,2264882,2264883,2264884,2264885,2264886,2264887,2264888,2264906,2264907,2264908,2264930,2264947,2264948,2264949,2264968,2264969,2264970,2265003,2265004,2265005,2265006,2265042,2265043,2265044,2265073,2265074,2265096,2265097,2265098,2265100,2265137,2265139,2265140,2265141,2265142,2265163,2265164,2265165,2265205,2265206,2265207,2265208,2265210,2265211,2265212,2265248,2265249,2265285,2265302,2265303,2265304,2265354,2265355,2265356,2265357,2265358,2265359,2265360,2265361,2265362,2265363,2265364,2265365,2265366,2265367,2265368,2265420,2265421,2265422,2265437,2265438,2265458,2265459,2265460,2265461,2265462,2265463,2265464,2265465,2265466,2265467,2265468,2265486,2265487,2265488,2265489,2265490,2265491,2265504,2265505,2265506,2265507,2265508,2265509,2265510,2265511,2265512,2265526,2265527,2265528,2265529,2265531,2265532,2265550,2265551,2265552,2265553,2265554,2265555,2265556,2265557,2265558,2265593,2265594,2265595,2265613,2265614,2265624,2265625,2265626,2265627,2265628,2265629,2265630,2265656,2265657,2265658,2265659,2265660,2265676,2265677,2265678,2265679,2265680,2265713,2265714,2265715,2265716,2265737,2265765,2265766,2265767,2265787,2265788,2265789,2265790,2265791,2265792,2265793,2265794,2265795,2265805,2265806,2265807,2265808,2265809,2265820,2265829,2265830,2265831,2265832,2265833,2265834,2265835,2265860,2265861,2265862,2265863,2265882,2265883,2265884,2265908,2265909,2265910,2265911,2265934,2265935,2265936,2265937,2265968,2265969,2265970,2265971,2265972,2266000,2266001,2266002,2266038,2266039,2266040,2266041,2266042,2266043,2266057,2266058,2266059,2266060,2266090,2266091,2266092,2266093,2266107,2266108,2266109,2266110,2266111,2266144,2266145,2266146,2266147,2266170,2266171,2266172,2266173,2266174,2266175,2266176,2266223,2266224,2266225,2266226,2266227,2266228,2266229,2266230,2266231,2266232,2266263,2266264,2266265,2266296,2266321,2266322,2266323,2266324,2266325,2266348,2266349,2266350,2266351,2266353,2266354,2266355,2266356,2266357,2266358,2266359,2266360,2266361,2266362,2266363,2266364,2266365,2266366,2266367,2266392,2266393,2266394,2266395,2266396,2266397,2266398,2266427,2266428,2266429,2266430,2266431,2266460,2266461,2266462,2266463,2266464,2266465,2266466,2266467,2266468,2266490,2266491,2266492,2266520,2266521,2266522,2266523,2266524,2266525,2266526,2266527,2266528,2266529,2266530,2266531,2266532,2266533,2266534,2266564,2266565,2266566,2266567,2266568,2266569,2266570,2266571,2266572,2266573,2266600,2266601,2266602,2266603,2266604,2266605,2266606,2266607,2266608,2266609,2266610,2266631,2266632,2266633,2266634,2266635,2266636,2266637,2266638,2266639,2266640,2266641,2266674,2266675,2266676,2266678,2266679,2266680,2266681,2266682,2266683,2266684,2266715,2266717,2266718,2266719,2266720,2266721,2266722,2266723,2266724,2266725,2266726,2266779,2266780,2266781,2266782,2266783,2266784,2266785,2266786,2266787,2266788,2266789,2266790,2266791,2266792,2266793,2266794,2266831,2266832,2266833,2266834,2266835,2266836,2266837,2266838,2266839,2266840,2266870,2266871,2266872,2266873,2266874,2266876,2266877,2266878,2266879,2266880,2266881,2266915,2266916,2266917,2266918,2266919,2266920,2266921,2266922,2266923,2266924,2266925,2266971,2266972,2266973,2266974,2266975,2266976,2266977,2266978,2266979,2267021,2267022,2267023,2267024,2267025,2267061,2267062,2267063,2267064,2267065,2267066,2267104,2267105,2267106,2267108,2267109,2267126,2267127,2267128,2267129,2267130,2267131,2267132,2267153,2267154,2267155,2267156,2267157,2267158,2267160,2267161,2267162,2267163,2267164,2267189,2267190,2267191,2267192,2267219,2267220,2267221,2267222,2267223,2267224,2267243,2267244,2267245,2267246,2267247,2267248,2267249,2267250,2267251,2267252,2267290,2267291,2267292,2267293,2267294,2267295,2267296,2267297,2267298,2267299,2267300,2267301,2267353,2267354,2267355,2267356,2267357,2267358,2267359,2267360,2267394,2267395,2267396,2267397,2267398,2267399,2267400,2267401,2267402,2267403,2267404,2267405,2267422,2267423,2267424,2267425,2267426,2267427,2267428,2267429,2267430,2267440,2267441,2267442,2267443,2267444,2267445,2267446,2267447,2267448,2267473,2267474,2267475,2267476,2267477,2267478,2267479,2267480,2267500,2267501,2267502,2267503,2267504,2267505,2267506,2267507,2267508,2267509,2267510,2267536,2267555,2267556,2267557,2267578,2267591,2267592,2267594,2267595,2267596,2267619,2267644,2267663,2267664,2267665,2267666,2267667,2267700,2267701,2267702,2267715,2267716,2267717,2267718,2267719,2267720,2267721,2267722,2267723,2267748,2267764,2267765,2267766,2267781,2267782,2267783,2267784,2267785,2267786,2267787,2267788,2267789,2267790,2267791,2267792,2267793,2267802,2267803,2267804,2267821,2267822,2267835,2267836,2267837,2267838,2267856,2267857,2267858,2267868))
       AND p.idremessa = r.idremessa
       AND a.cdcooper = r.cdcooper
       AND a.dtmvtolt = p.dtmovimento
       AND a.cdagenci = r.cdagenci
       AND a.nrdcaixa = DECODE(r.cdempresa_documento
                              ,'C06'
                              ,(r.nrdolote - 31000)
                              ,(r.nrdolote - 15000))
       AND a.nrsequen = r.nrautenticacao_documento;
  rw_pagto cr_pagto%ROWTYPE;
  
  CURSOR cr_crappro(pr_cdcooper crappro.cdcooper%TYPE
                   ,pr_dsprotoc crappro.dsprotoc%TYPE) IS
    SELECT SUBSTR(p.dsprotoc, 1, INSTR(p.dsprotoc,' ',1,1) - 1) dsprotoc
          ,p.rowid
      FROM crappro p
     WHERE p.cdcooper = pr_cdcooper
       AND UPPER(p.dsprotoc) LIKE pr_dsprotoc || '%';
  rw_crappro cr_crappro%ROWTYPE;
   
BEGIN
  
  FOR rw_pagto IN cr_pagto LOOP    
    
    BEGIN
      UPDATE tbconv_registro_remessa_pagfor reg
         SET reg.cdstatus_processamento  = CASE WHEN rw_pagto.dhinclusao_processamento IS NOT NULL THEN 2 ELSE 1 END
            ,reg.dhretorno_processamento = NULL
            ,reg.nmarquivo_retorno       = NULL
            ,reg.dsprocessamento         = NULL
       WHERE reg.rowid = rw_pagto.rowid;
    EXCEPTION
      WHEN OTHERS THEN
        dbms_output.put_line('Erro ao atualizar registro da tbconv_registro_remessa_pagfor. Erro -> '|| SQLERRM);
        RAISE vr_exc_erro;
    END;
    
    OPEN cr_crappro(pr_cdcooper => rw_pagto.cdcooper
                   ,pr_dsprotoc => rw_pagto.dsprotoc);
    FETCH cr_crappro INTO rw_crappro;
    
    -- Caixa Online não possui comprovante na crappro
    IF cr_crappro%NOTFOUND THEN
      CLOSE cr_crappro;
      CONTINUE;
    END IF;
    
    CLOSE cr_crappro;

    BEGIN
      UPDATE crappro
         SET crappro.dsprotoc = rw_crappro.dsprotoc
       WHERE crappro.rowid = rw_crappro.rowid;
    EXCEPTION
      WHEN OTHERS THEN
        dbms_output.put_line('Erro ao atualizar registro da crappro. Erro -> '|| SQLERRM);
        RAISE vr_exc_erro;
    END;        
    
  END LOOP;
  
  COMMIT;
  
  EXCEPTION
    WHEN vr_exc_erro THEN
      ROLLBACK;
    WHEN OTHERS THEN
      dbms_output.put_line('Erro não tratado no script. Erro -> '|| SQLERRM);
      ROLLBACK;
      
END;
