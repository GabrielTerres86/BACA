PL/SQL Developer Test script 3.0
615
-- Created on 04/11/2020 by T0032500 
declare
  
--Identificador;Agencia;Conta;Convenio  
  arq_csv CLOB := '7100060010;3239;00000010613943;8261426
7100063035;3239;00000003018776;8261426
0000026278;3239;00000080481990;8261426
0000028003;3239;00000008283249;8261426
0000227245;3239;00000007764081;8261426
0150090249;3239;00000006572588;8261426
0150204236;3239;00000001936166;8261426
0150264272;3239;00000002908298;8261426
0150262390;3239;00000008184950;8261426
0150260015;3265;00000000803251;8261426
0000029087;3265;00000000876917;8261426
000330120522;3239;00000007180411;8460464
000000001234;3239;00000003997588;8460464
000321892564;3239;00000007678142;8460464
000329887070;3239;00000011241330;8460464
94752990920;3239;0000000381888;8460152
402036153904;3239;0000000704917;8460157
402065007895;3239;0000000704532;8460157
402085062396;3239;0000000889272;8460157
7101207171;3239;0000001179955;8460157
9126945636015;3239;0000000906922;8460157
402053156119;3239;0000000753791;8460157
5097519946101;3239;0000000829959;8460157
9104040891010;3239;0000000307336;8460157
9104040969019;3239;0000000307336;8460157
522789007;4420;0000000046132;8460157
8211095180;4468;0000000006068;8460157
00025471546;3239;00000010735070;8350005
00000032165;3239;00000010405720;8360100
0003189485;3239;00000010381163;8460071
0003175112;3239;00000009057056;8460071
0003169816;3239;00000006569927;8460071
0003187180;3239;00000006351964;8460071
0030011220;3239;00000009730346;8460071
0133663976;3239;00000007056842;8460071
0132320613;3239;00000007517823;8460071
0930019330;3239;00000011549734;8460071
0003187180;3239;00000006351964;8460071
0003189690;3239;00000010604472;8460071
0030011489;3239;00000008405140;8460071
0133207778;3239;00000002189437;8460071
0030010813;3239;00000002731983;8460071
0003172610;3239;00000007840535;8460071
0003189690;3239;00000010675299;8460071
0003189863;3239;00000008399336;8460071
0930011931;3239;00000011147598;8460071
0003170219;3239;00000009703543;8460071
0003188720;3239;00000008732493;8460071
0134876008;3239;00000002423936;8460071
0030011861;3239;00000011478179;8460071
0930018356;3239;00000011549831;8460071
0030011260;3239;00000010041915;8460071
0125351130;3239;00000002267993;8460071
0132231700;3239;00000002267993;8460071
0135183452;3239;00000002341794;8460071
0930011231;3239;00000002222752;8460071
0930060259;3239;00000007672845;8460071
0123368924;3239;00000009230696;8460071
0003187281;3239;00000003825230;8460071
0003189424;3239;00000008665885;8460071
0132320613;3239;00000007517823;8460071
0930014770;3239;00000009216154;8460071
0930020147;3239;00000010854894;8460071
0001937285;3239;00000002192128;8460071
0030011590;3239;00000011685441;8460071
0030010054;3239;00000009660836;8460071
0930019330;3239;00000011549734;8460071
0003164088;3239;00000008576939;8460071
0030011705;4416;00000000007412;8460071
0114846853;4420;00000002921413;8460071
0130010063;4443;00000000060615;8460071
0130010406;4443;00000000044989;8460071
0112874828;4444;00000000109940;8460071
0000017470;4449;00000000125792;8460071
0121833475;4449;00000000125792;8460071
0123110480;4449;00000000125792;8460071
0636179398;4457;00000000004375;8460071
0117231669;4468;00000000085014;8460071
201719924;3232;00000000011690;8480162
127642707;3232;00000000016080;8480162
615995834;3239;00000010627650;8480162
965399231;3239;00000006067611;8480162
965743604;3239;00000009481281;8480162
979614947;3239;00000009749985;8480162
101509986;3239;00000010203818;8480162
101697528;3239;00000006943900;8480162
222336732;3239;00000007946023;8480162
223877578;3239;00000007915365;8480162
225169495;3239;00000003904164;8480162
225719208;3239;00000006774679;8480162
240905137;3239;00000008179590;8480162
890510773;3239;00000003030601;8480162
897540217;3239;00000006368930;8480162
914423688;3239;00000007057377;8480162
927176618;3239;00000006211224;8480162
102981374;3239;00000006943900;8480162
103800243;3239;00000007645848;8480162
104102683;3239;00000002087189;8480162
104674705;3239;00000002792125;8480162
104850988;3239;00000080003826;8480162
105042065;3239;00000007706260;8480162
106497103;3239;00000007078706;8480162
107249058;3239;00000002616521;8480162
130081558;3239;00000008538824;8480162
130946579;3239;00000000508926;8480162
130967188;3239;00000007015429;8480162
132820384;3239;00000011598662;8480162
132832373;3239;00000003634981;8480162
132947195;3239;00000002942950;8480162
133335495;3239;00000003542718;8480162
133424503;3239;00000006953174;8480162
133861515;3239;00000002881870;8480162
134168369;3239;00000002660555;8480162
150189661;3239;00000008193789;8480162
159216630;3239;00000009660836;8480162
131999839;3239;00000003120350;8480162
191353474;3239;00000006897967;8480162
199320119;3239;00000008525404;8480162
200045734;3239;00000007178735;8480162
200887743;3239;00000006550070;8480162
203056426;3239;00000006958664;8480162
205035709;3239;00000007373210;8480162
206747144;3239;00000008328200;8480162
215812018;3239;00000009481281;8480162
243416346;3239;00000006943900;8480162
248860184;3239;00000002965151;8480162
479887582;3239;00000010554866;8480162
700010562;3239;00000009359346;8480162
700318869;3239;00000011152672;8480162
700610115;3239;00000080287786;8480162
802414362;3239;00000003971651;8480162
817795534;3239;00000003533344;8480162
824957944;3239;00000009481281;8480162
839150144;3239;00000009329145;8480162
843782114;3239;00000000970310;8480162
848697187;3239;00000008744939;8480162
860869818;3239;00000010188916;8480162
107838858;3239;00000006369588;8480162
107848282;3239;00000011298219;8480162
105285653;3239;00000006210228;8480162
107978322;3239;00000001843630;8480162
108015606;3239;00000008613320;8480162
109090596;3239;00000002039737;8480162
109188168;3239;00000002597055;8480162
108436685;3239;00000007494220;8480162
110246165;3239;00000002463490;8480162
111600165;3239;00000002755521;8480162
111861081;3239;00000011020946;8480162
112058755;3239;00000002755521;8480162
112142341;3239;00000011302097;8480162
112567313;3239;00000001986945;8480162
117750999;3239;00000006493823;8480162
118190839;3239;00000009973680;8480162
118631904;3239;00000007708726;8480162
118706632;3239;00000007298005;8480162
119249274;3239;00000009996192;8480162
119269492;3239;00000009924094;8480162
119292221;3239;00000002731258;8480162
119789732;3239;00000008428913;8480162
120510779;3239;00000000236527;8480162
121153721;3239;00000002546698;8480162
121226614;3239;00000010638490;8480162
121388806;3239;00000004040740;8480162
121791680;3239;00000007920202;8480162
124136838;3239;00000080422179;8480162
124178484;3239;00000007103069;8480162
124233815;3239;00000006834868;8480162
124365286;3239;00000007345666;8480162
124482126;3239;00000002446839;8480162
124531371;3239;00000006429394;8480162
124827039;3239;00000007252412;8480162
125095764;3239;00000010188916;8480162
125806284;3239;00000003706389;8480162
126116937;3239;00000006583830;8480162
126174390;3239;00000011587911;8480162
126366612;3239;00000011753331;8480162
126410411;3239;00000001921312;8480162
126412162;3239;00000001921312;8480162
126435961;3239;00000010138137;8480162
126580754;3239;00000008629609;8480162
122803223;3239;00000007401230;8480162
122803243;3239;00000007401230;8480162
123474504;3239;00000009100326;8480162
123511836;3239;00000010444467;8480162
123597289;3239;00000010616098;8480162
127347804;3239;00000008753920;8480162
127455837;3239;00000010761462;8480162
127831466;3239;00000004014910;8480162
128278552;3239;00000011471956;8480162
128412354;3239;00000003964655;8480162
129181331;3239;00000007585608;8480162
129252696;3239;00000010276017;8480162
129365602;3239;00000003983030;8480162
129739020;3239;00000006529500;8480162
134909771;3239;00000009776516;8480162
102772610;3239;00000011780789;8480162
128352704;3239;00000007558660;8480162
135174273;3239;00000007008457;8480162
131264288;3239;00000002446979;8480162
134391256;3239;00000002838133;8480162
134895686;3239;00000011466227;8480162
135722522;3239;00000008213402;8480162
133756148;3239;00000008944679;8480162
130681021;3265;00000000606057;8480162
247464659;3265;00000000149306;8480162
739244521;3265;00000000744123;8480162
123388863;3265;00000000780090;8480162
125658952;3265;00000000301515;8480162
110791225;3318;00000000222704;8480162
210660796;3318;00000000166510;8480162
111648197;4416;00000000225363;8480162
116091054;4416;00000000129399;8480162
203001147;4416;00000000271900;8480162
125110645;4416;00000000275824;8480162
127978529;4416;00000000082120;8480162
128246663;4416;00000000261653;8480162
132830898;4420;00000003987221;8480162
133478081;4420;00000000230065;8480162
182296533;4420;00000006126448;8480162
193077417;4420;00000006060323;8480162
193624374;4420;00000000032590;8480162
501678760;4420;00000000613843;8480162
752493393;4420;00000000241270;8480162
222245505;4420;00000006318908;8480162
244509179;4420;00000000346870;8480162
936526053;4420;00000002210827;8480162
873266292;4420;00000002155265;8480162
985992754;4420;00000000613843;8480162
102979266;4420;00000000082376;8480162
103102205;4420;00000000086142;8480162
106805775;4420;00000000200336;8480162
106806457;4420;00000000200336;8480162
105793753;4420;00000006642543;8480162
109911134;4420;00000000542555;8480162
116086790;4420;00000000113522;8480162
117039109;4420;00000000098388;8480162
118960555;4420;00000000355747;8480162
123161676;4420;00000000552747;8480162
123594608;4420;00000000200808;8480162
125156373;4420;00000000429970;8480162
125505368;4420;00000002175673;8480162
126703955;4420;00000000695807;8480162
126341831;4420;00000000399370;8480162
965929277;4438;00000000230375;8480162
104121188;4438;00000000364258;8480162
193001973;4438;00000000617415;8480162
210636570;4438;00000000371939;8480162
216884083;4438;00000000294241;8480162
126368334;4438;00000000611204;8480162
126906397;4438;00000000605166;8480162
111528511;4443;00000000035556;8480162
121617370;4443;00000000009806;8480162
120109401;4444;00000000909106;8480162
130473665;4444;00000000241407;8480162
106200894;4444;00000000326534;8480162
106911411;4444;00000000016705;8480162
132673636;4449;00000000128791;8480162
246704921;4449;00000000061344;8480162
119560830;4449;00000000127710;8480162
122813939;4449;00000000005150;8480162
122814133;4449;00000000005150;8480162
985042595;4457;00000000130141;8480162
106907487;4457;00000000048011;8480162
107512934;4457;00000000047805;8480162
111096720;4468;00000000009105;8480162
0000052294150;3239;00000009825843;8360111
0000141102036;3239;00000011258799;8360111
0000000082020;4416;00000000339784;8360111
0000000072020;4416;00000000352608;8360111
0000000092020;4416;00000000172766;8360111
0000000092020;4444;00000000335258;8360111
0000000062020;4444;00000000310247;8360111
0000000072020;4444;00000000329070;8360111
0000045046605;4444;00000000177199;8360111
0000011137113;4444;00000000352098;8360111
0000084291039;4468;00000000015920;8360111
000318953181;3239;00000009334823;8460004
000319825313;3239;00000009765018;8460004
000320972617;3239;00000007631480;8460004
000322198566;3239;00000008161852;8460004
000322912521;3239;00000007180209;8460004
000325161079;3239;00000007884915;8460004
000326829557;3239;00000008732353;8460004
846800000016;3239;00000002356899;8460004
846400000010;4438;00000000049123;8460004
000434033690;4444;00000000312002;8460004
116569956;3239;00000007368038;8360048
00180056440000;3239;00000004002768;00067561
00211679966283;3239;00000011023260;00067561
00270016940403;3239;00000007387032;00067561
00700318763790;3239;00000010970487;00067561
00916945636015;3239;00000009069224;00067561
09139757910013;3239;00000010541357;00067561
00134733820002;4457;00000000037656;00067561
00948946776;4468;00000000130494;8360050
83842659091;3239;00000006524206;8360049
00010216699;3239;00000080425623;8360001
09075331310;4468;00000000137081;8360001
000046257529;3239;00000006524206;8360051
0000000000000000001042388;3239;00000002414244;8460430
0000000000000000001464551;3239;0000001136456;8460430
0000000000000000001949999;3239;0000001136456;8460430
0000000000000000005082020;3239;00000001522981;8460430
0000000000000000005330212;3239;00000009413529;8460430
0000000000000000009136961;3239;00000010984712;8460430
0000000000000000009866080;3239;00000008260117;8460430
0000000000000000010395997;3239;00000008260117;8460430
0000000000000000010672632;3239;00000002526786;8460430
0000000000000000011257114;3239;00000007907370;8460430
0000000000000000000948314;3239;00000003024083;8460430
0000000000000000000181625;3239;00000009024620;8460430
0000000000000000000400678;3239;00000007645180;8460430
0000000000000000001118417;4420;00000000198200;8460430
0000000000000000001231726;4420;00000000676683;8460430
0000000000000000008889529;4443;00000000093769;8460430
0000000000000000734049412;3239;00000010506535;8480089
0000000000000007418749113;3239;00000010870342;8480089
0000000000000007843042718;3239;00000009043179;8480089
0000000000001930018736984;3239;00000010073302;8480089
0000000000001930018736984;3239;00000010073302;8480089
0000000000203001100005707;3239;00000011674598;8480089
0000000000000000281983569;3265;00000000838233;8480089
3884878974;3232;00000000037796;8460313
480838926;3232;00000000185981;8460313
481102235;3232;00000000185981;8460313
3215169908;3239;00000006954383;8460313
523825814;3239;00000002527731;8460313
530529305;3239;00000009528253;8460313
207672062520110;3239;00000010803475;8460313
5061000069046;3239;00000003550427;8460313
522633561;3239;00000010816020;8460313
8002818801;3239;00000001938576;8460313
821761224202005;3239;00000011264721;8460313
8433274000186;3239;00000003729656;8460313
846000000014;3239;00000011635037;8460313
8461000000053;3239;00000003173658;8460313
8466000000183;3239;00000011179457;8460313
8467;3239;00000009296166;8460313
846900000015;3239;00000010562028;8460313
8999366217704;3239;00000010947116;8460313
9001656935;3239;00000010908439;8460313
905;3239;00000003956202;8460313
9116779434015;3239;00000010182900;8460313
91338414;3239;00000002344688;8460313
9140965662017;3239;00000007625391;8460313
9142222428016;3239;00000003207137;8460313
991816553;3239;00000001940872;8460313
9956111966050;3239;00000009540210;8460313
1;3239;00000011104589;8460313
11327;3239;00000010781404;8460313
123;3239;00000011200170;8460313
125508373;3239;00000003657604;8460313
130;3239;00000011491272;8460313
13037521057;3239;00000010947116;8460313
132719250;3239;00000002018390;8460313
133274780;3239;00000011282959;8460313
183304748;3239;00000011392819;8460313
2014150462;3239;00000007406479;8460313
2015131449;3239;00000011551470;8460313
2018002045;3239;00000004036638;8460313
2019317210;3239;00000010120556;8460313
2729210896;3239;00000003661954;8460313
2734505179;3239;00000011047976;8460313
2981271268;3239;00000011047976;8460313
2998295788;3239;00000011397667;8460313
3296010957;3239;00000008698490;8460313
3722068;3239;00000006453325;8460313
4016;3239;00000009296166;8460313
401780212988;3239;00000003505626;8460313
401801196556401;3239;00000009337903;8460313
4019187346;3239;00000002653125;8460313
402001001206;3239;00000002370611;8460313
40200670291;3239;00000010785442;8460313
402018277558;3239;00000011212993;8460313
402022146024;3239;00000011464666;8460313
402025892633;3239;00000010217991;8460313
402069901585;3239;00000090122950;8460313
40207157850;3239;00000000130230;8460313
40207742200;3239;00000008756392;8460313
40207886359;3239;00000009420193;8460313
40208040118;3239;00000007438214;8460313
4028274700;3239;00000008649049;8460313
4200840957;3239;00000008458480;8460313
4282522505;3239;00000009217398;8460313
440904155;3239;00000003084671;8460313
45284;3239;00000006845851;8460313
47;3239;00000010354581;8460313
473148936;3239;00000008049106;8460313
4733245184;3239;00000006578071;8460313
4733761372;3239;00000010196641;8460313
482035343001;3239;00000000685135;8460313
489161933;3239;00000010519815;8460313
491170603;3239;00000010647538;8460313
491645336;3239;00000002046814;8460313
49925944879089;3239;00000003600432;8460313
499762612;3239;00000008769966;8460313
505395067;3239;00000007056508;8460313
505573206;3239;00000007323921;8460313
506352910;3239;00000008539529;8460313
508044679;3239;00000011471786;8460313
5092073507319;3239;00000010906100;8460313
5093022961622;3239;00000011104716;8460313
5093178081516;3239;00000010079629;8460313
5094037537797;3239;00000006445179;8460313
5094794182783;3239;00000007811390;8460313
513324883;3239;00000003501264;8460313
522585864;3239;00000011709430;8460313
522693558;3239;00000007442696;8460313
525691930;3239;00000010168370;8460313
531081303;3239;00000007710380;8460313
57611220900;3239;00000011359692;8460313
592507;3239;00000010961836;8460313
6002120159;3239;00000006006442;8460313
6002988298;3239;00000007309830;8460313
709;3239;00000003617106;8460313
7171949428;3239;00000006147194;8460313
7181152131;3239;00000002470578;8460313
125508373;3239;00000003657604;8460313
401226788233;3239;00000006059139;8460313
401830034409;3239;00000001894650;8460313
402024080634;3239;00000008180075;8460313
523825814;3239;00000002527731;8460313
539604393;3239;00000003704033;8460313
6003874485;3239;00000002148226;8460313
846900000007678;3239;00000002266679;8460313
13037521057;3239;00000010947116;8460313
2;3239;00000011467770;8460313
2013355808;3239;00000011356880;8460313
40206463258;3239;00000007057350;8460313
404795585626;3239;00000009928383;8460313
530127386;3239;00000002698757;8460313
538342590;3239;00000003787184;8460313
2490531927;3239;00000007880111;8460313
1;3239;00000010982655;8460313
401936773596401;3239;00000011132370;8460313
40277188070;3239;00000006996108;8460313
45284;3239;00000006845851;8460313
540844706;3239;00000011273747;8460313
4402024720463;3239;00000011512709;8460313
14065;3239;00000009495711;8460313
401988073585;3239;00000000884235;8460313
402058444363;3239;00000009866353;8460313
557096178;3239;00000009225480;8460313
846400000002;3239;00000002938057;8460313
50723818;3239;00000008323356;8460313
64686035953;3239;00000006075169;8460313
4020236129;3239;00000006062687;8460313
555620989001;3239;00000002859831;8460313
550257720001;3239;00000006721559;8460313
8467000000255;3239;00000007871244;8460313
54273390;3239;00000007700385;8460313
102020;3239;00000008179603;8460313
402030837186;3239;00000008377170;8460313
4020372969;3239;00000010959793;8460313
49776987;3239;00000010024263;8460313
557381996;3239;00000008653224;8460313
40200094076;3239;00000008371750;8460313
556680467001;3239;00000008633061;8460313
8468000000089;3239;00000002967855;8460313
110095;3265;00000000268747;8460313
522486897;3265;00000000579432;8460313
52301533;3265;00000000381829;8460313
40162162763;3265;00000000392030;8460313
4020415642013;4416;00000000027820;8460313
538504421;4416;00000000325147;8460313
4020415642013;4416;00000000347272;8460313
7167765849;4420;00000000105880;8460313
91438509;4438;00000000171395;8460313
507988374;4444;00000000009105;8460313
401966787562;4457;00000000070033;8460313';



  vr_arquivo      UTL_FILE.file_type;
  vr_dserro       varchar2(1000);
  vr_texto        varchar2(1000);
  vr_linhascsv    gene0002.typ_split;
  vr_linhacsv     gene0002.typ_split;
  --
  vr_rowid        rowid;
  vr_cdrefere     crapatr.cdrefere%type;
  vr_cdagebcb     crapcop.cdagebcb%type; 
  vr_nrdconta     crapatr.nrdconta%type;
  vr_cdempres     tbconv_arrecadacao.cdempres%type;
  
  --
  vr_linha        number(6) := 0;
  vr_delimitador  varchar2(1) := ';';
  --
  vr_dsmotivo     varchar2(1000);
  vr_sqlerrm      varchar2(1000);
  --
  wexiste         number(1);
  wexiste_conv    number(1);
  wcommit         number(5) := 5000;
  --
  err_convenio    exception;

  CURSOR cr_tbconv_arrecadacao (pr_cdempres  IN tbconv_arrecadacao.cdempres%TYPE) IS
       SELECT tbconv_arrecadacao.cdempcon, tbconv_arrecadacao.cdsegmto
         FROM tbconv_arrecadacao
        WHERE tbconv_arrecadacao.cdempres = pr_cdempres;
  rw_tbconv_arrecadacao cr_tbconv_arrecadacao%ROWTYPE;

  CURSOR cr_crapcop (pr_cdagebcb  IN crapcop.cdagebcb%TYPE) IS
    SELECT cop.cdcooper
      FROM crapcop cop
           where cop.cdagebcb = pr_cdagebcb
     ORDER BY cop.cdcooper;
  rw_crapcop   cr_crapcop%ROWTYPE;

  
  FUNCTION fn_quebra_string(pr_string   IN CLOB
                           ,pr_delimit  IN CHAR DEFAULT ',') RETURN gene0002.typ_split IS

    vr_vlret    gene0002.typ_split := gene0002.typ_split();
    vr_quebra   LONG DEFAULT pr_string || pr_delimit;
    vr_idx      NUMBER;

  BEGIN
    -- Incluir nome do módulo logado - Chamado 660322 18/07/2017
    -- Alterado pc_set_modulo da procedure - Chamado 776896 - 18/10/2017
    GENE0001.pc_set_modulo(pr_module =>  NULL, pr_action => 'GENE0002.fn_quebra_string');
    --Se a string estiver nula retorna count = 0 no vetor
    IF nvl(pr_string,'#') = '#' THEN
      RETURN vr_vlret;
    END IF;

    LOOP
      -- Identifica ponto de quebra inicial
      vr_idx := instr(vr_quebra, pr_delimit);

      -- Clausula de saída para o loop
      exit WHEN nvl(vr_idx, 0) = 0;

      -- Acrescenta elemento para a coleção
      vr_vlret.EXTEND;
      -- Acresce mais um registro gravado no array com o bloco de quebra
      vr_vlret(vr_vlret.count) := trim(substr(vr_quebra, 1, vr_idx - 1));
      -- Atualiza a variável com a string integral eliminando o bloco quebrado
      vr_quebra := substr(vr_quebra, vr_idx + LENGTH(pr_delimit));
    END LOOP;
    -- Alterado pc_set_modulo da procedure - Chamado 776896 - 18/10/2017
    GENE0001.pc_set_modulo(pr_module =>  NULL, pr_action => NULL);

    -- Retorno do array com as substrings separadas em cada registro
    RETURN vr_vlret;
  END fn_quebra_string;

 
begin
  vr_linhascsv := fn_quebra_string(arq_csv,CHR(10));
  FOR i IN 1 .. vr_linhascsv.COUNT
  LOOP
    vr_linhacsv := fn_quebra_string(vr_linhascsv(i), ';');
    vr_cdrefere := to_number(TRIM(vr_linhacsv(1)));
    vr_cdagebcb := to_number(vr_linhacsv(2));
    vr_nrdconta := to_number(vr_linhacsv(3));
    vr_cdempres := vr_linhacsv(4);
      
--      dbms_output.put_line('importando: -> '||vr_cdempcon||' '||vr_cdsegmto);  

      OPEN cr_crapcop (vr_cdagebcb);
             
      FETCH cr_crapcop INTO rw_crapcop;
             
      IF cr_crapcop%FOUND THEN

         OPEN cr_tbconv_arrecadacao (vr_cdempres);
             
         FETCH cr_tbconv_arrecadacao INTO rw_tbconv_arrecadacao;
             
         IF cr_tbconv_arrecadacao%FOUND THEN

            BEGIN
               UPDATE crapatr SET crapatr.dtiniatr = '05/11/2020',
                                  crapatr.cdopeexc = '1'
                            WHERE crapatr.cdcooper = rw_crapcop.cdcooper
                              AND crapatr.nrdconta = vr_nrdconta
                              AND crapatr.cdhistor = 3292
                              AND crapatr.cdrefere = vr_cdrefere
                              AND crapatr.cdempcon = rw_tbconv_arrecadacao.cdempcon
                              AND crapatr.cdsegmto = rw_tbconv_arrecadacao.cdsegmto
                              AND crapatr.dtfimatr IS NULL;
            EXCEPTION
                 WHEN others THEN
                    dbms_output.put_line('Nao foi possivel alterar ATR: '||vr_nrdconta||'->'||SQLERRM);
                      RAISE;
            END;
         ELSE  
          dbms_output.put_line('Nao localizado convenio: '||vr_cdempres);

      END IF;      

         CLOSE cr_tbconv_arrecadacao;

      ELSE
        dbms_output.put_line('Nao localizado cooperativa: '||vr_cdagebcb);
    
    END IF;

      CLOSE cr_crapcop;    
 
    END LOOP;  
                            
    COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line('Erro geral no script -> ' ||SQLERRM);                
END;
0
6
vr_cdrefere
vr_cdagebcb
vr_nrdconta
vr_cdempres
rw_tbconv_arrecadacao.cdempcon
rw_tbconv_arrecadacao.cdsegmto
