PL/SQL Developer Test script 3.0
614
-- Created on 04/11/2020 by T0032500 
declare
  
--Identificador;Agencia;Conta;Convenio  
  arq_csv CLOB := '402029647616;3239;0000000724176;8460014
402052228159;3239;0000000203471;8460014
40202791577;3239;0000001152217;8460014
7001282767;3239;0000001056216;8460014
9141063237019;3239;00000011291532;8460113
9143064111015;3239;00000003533956;8460113
99562165135;3239;00000008713553;8460113
1;3239;00000010907815;8460113
111111111111;3239;00000004031229;8460113
12835421;3239;00000011407743;8460113
1303763681;3239;00000002952173;8460113
15001300143;3239;00000007125666;8460113
2010166054;3239;00000010979247;8460113
2011089672;3239;00000006578071;8460113
2012226714;3239;00000008824118;8460113
2013250410;3239;00000010181628;8460113
2112308513;3239;00000009916725;8460113
2778405189;3239;00000010903348;8460113
40127552781;3239;00000006646590;8460113
401288366079;3239;00000003775054;8460113
40168529100;3239;00000006167403;8460113
40181750336;3239;00000007317417;8460113
40182720381;3239;00000010365796;8460113
40185450015;3239;00000002075440;8460113
40190255240;3239;00000009693246;8460113
40193150189;3239;00000006837263;8460113
40193312161;3239;00000002355019;8460113
401956579245;3239;00000006462596;8460113
40201510217;3239;00000009146881;8460113
40203068424;3239;00000003539482;8460113
40204032893;3239;00000009527516;8460113
40205440230;3239;00000010796630;8460113
40205584201;3239;00000011582715;8460113
40206109498;3239;00000011143860;8460113
40206608664;3239;00000003877663;8460113
402066498027;3239;00000008649049;8460113
40207725006;3239;00000011271230;8460113
40963432;3239;00000002637642;8460113
47110637311;3239;00000006644945;8460113
491405024;3239;00000009146717;8460113
5092686448099;3239;00000010298223;8460113
515478039;3239;00000006561659;8460113
6002815402;3239;00000006561659;8460113
6002950127;3239;00000008944180;8460113
6003332024;3239;00000008424373;8460113
4019474331883;3239;00000009529047;8460113
40205544782;3239;00000006354157;8460113
40193150189;3239;00000006837263;8460113
402003291191;3239;00000003654206;8460113
2019844067;3239;00000007220030;8460113
40200056391;4420;00000000392642;8460113
40203537995;4420;00000000578983;8460113
40205646468;4443;00000000153672;8460113
40205756033;4443;00000000010510;8460113
402089154775;3232;00000000056472;024756
401697364131;3232;00000000205532;024756
402048606416;3239;00000011481315;024756
402057072432;3239;00000011696150;024756
402088984405;3239;00000002959496;024756
401902555158;3239;00000011732814;024756
401939139944;3239;00000011077042;024756
40197548576;3239;00000008208506;024756
401996187742;3239;00000006506976;024756
402000947076;3239;00000008371768;024756
402003125069;3239;00000011728191;024756
402014919164;3239;00000004078071;024756
402025354010;3239;00000009609652;024756
402025939655;3239;00000009683755;024756
402030270798;3239;00000002085410;024756
402039708893;3239;00000011647930;024756
402040941976;3239;00000008017549;024756
402045865224;3239;00000007110979;024756
402046257996;3239;00000007739974;024756
402052727465;3239;00000007401230;024756
402053029893;3239;00000009146881;024756
402054545313;3239;00000001933450;024756
402060494240;3239;00000011671629;024756
402062992116;3239;00000010767762;024756
402067986564;3239;00000001872168;024756
402077382888;3239;00000010625917;024756
402079477231;3239;00000002224291;024756
402097374601;3239;00000003612872;024756
53741853;3239;00000010064389;024756
7000565471;3239;00000007545444;024756
7101264906;3239;00000002248220;024756
402006021868;3239;00000011514205;024756
402021615537;3239;00000007700172;024756
402026821682;3239;00000003141659;024756
402028105828;3239;00000008667055;024756
402031786771;3239;00000009261869;024756
402038488504;3239;00000007186355;024756
402051424167;3239;00000009352236;024756
402052447349;3239;00000008179603;024756
402079027007;3239;00000011726440;024756
402082920952;3239;00000008667055;024756
402092638783;3239;00000010816020;024756
401379309032;3239;00000002617994;024756
401936773596;3239;00000011132370;024756
402061563475;3239;00000008789762;024756
465192505;3239;00000008323356;024756
7180445526;3239;00000011347759;024756
401516190579;3239;00000006633471;024756
401626119306;3239;00000006482155;024756
401701948461;3239;00000011643390;024756
40191323583;3239;00000007146698;024756
401949954913;3239;00000010673539;024756
402002354455;3239;00000009534571;024756
402017693604;3239;00000007716702;024756
402037682161;3239;00000007981562;024756
402040427695;3239;00000003084574;024756
402044372208;3239;00000006935044;024756
40205098522;3239;00000002047330;024756
402058395391;3239;00000010108840;024756
402061563475;3239;00000008789762;024756
402061925423;3239;00000080044239;024756
402067329458;3239;00000007534647;024756
402086932904;3239;00000002408600;024756
402087878199;3239;00000002966719;024756
402095712003;3239;00000008895023;024756
7000565471;3239;00000007545444;024756
7179113884;3239;00000004075099;024756
8114900944;3239;00000011548649;024756
402003787029;3239;00000003216772;024756
402039235146;3239;00000001984098;024756
402039708893;3239;00000011647930;024756
402077382888;3239;00000010625917;024756
401701948461;3239;00000011643390;024756
402037487296;3239;00000011875100;024756
402057219964;3239;00000006225381;024756
402086580889;3239;00000001522221;024756
402086932904;3239;00000002408600;024756
402096939281;3239;00000006695167;024756
8238347490;3239;00000011352736;024756
401872410656;3239;00000002862883;024756
402018311152;3239;00000003927164;024756
402027754520;3239;00000007971052;024756
402028044381;3239;00000008602719;024756
402031786771;3239;00000009261869;024756
402037567672;3239;00000011582847;024756
402050981895;3239;00000008174229;024756
402068806977;3239;00000007347715;024756
402070033942;3239;00000010007865;024756
402084313875;3239;00000011531428;024756
402086439914;3239;00000006397727;024756
402090671953;3239;00000009471138;024756
402092092403;3239;00000010569243;024756
402093024657;3239;00000009613080;024756
8114900944;3239;00000011548649;024756
402020247437;3265;00000000500860;024756
402047162239;3318;00000000162604;024756
47110680696;4420;00000000126055;024756
402097372765;4420;00000000399370;024756
40273105332;4420;00000000684198;024756
522569327;4420;00000000408778;024756
7007282653;4420;00000006370918;024756
402097372765;4420;00000000399370;024756
401973544130;4420;00000000545473;024756
402046082339;4420;00000000037257;024756
40200166647;4420;00000000542164;024756
402065141931;4420;00000000412848;024756
563552857;4420;00000000476170;024756
402086667747;4438;00000000003085;024756
402040802658;4438;00000000335142;024756
509129024506;4438;00000000335142;024756
7106533212;4438;00000000509787;024756
7149432019;4438;00000000509787;024756
2010335710;4438;00000000003085;024756
401302417991;4457;00000000730645;024756
401637843154;4457;00000000179248;024756
401302417991;4457;00000000730645;024756
8180458120;4457;00000000116254;024756
401833922577;3239;0000000984220;8460026
244227205;3239;00000009113282;8460369
2942972087;3239;00000008417040;8460369
36266994;3239;00000009043853;8460369
401532196927;3239;00000010614273;8460369
401676370166;3239;00000080233368;8460369
401697354381;3239;00000003073360;8460369
401698979083;3239;00000002401738;8460369
401791114343;3239;00000010839259;8460369
401864148616;3239;00000009942157;8460369
401890784660;3239;00000011554460;8460369
401895522702;3239;00000006218407;8460369
401904333519;3239;00000002514575;8460369
401927744206;3239;00000007287364;8460369
401974989845;3239;00000010417192;8460369
402000916340;3239;00000008171203;8460369
40200425878;3239;00000010098496;8460369
40200425878;3239;00000010126805;8460369
402006406697;3239;00000008072507;8460369
402011381910;3239;00000004036913;8460369
402018363020;3239;00000002198991;8460369
402032459731;3239;00000007218567;8460369
402033084545;3239;00000002455285;8460369
402033349123;3239;00000008904600;8460369
402039817528;3239;00000009199144;8460369
402044412757;3239;00000009151770;8460369
402046828292;3239;00000003030881;8460369
402050292461;3239;00000011348461;8460369
402053079106;3239;00000007584814;8460369
402053586954;3239;00000002437147;8460369
402061184253;3239;00000001833626;8460369
402068219656;3239;00000010650520;8460369
402068519382;3239;00000002698757;8460369
402070022894;3239;00000007951523;8460369
402079718700;3239;00000006857540;8460369
402086161282;3239;00000002422603;8460369
402093055161;3239;00000007718543;8460369
402097308463;3239;00000003618218;8460369
5097213866113;3239;00000007187734;8460369
7168487460;3239;00000011324171;8460369
995609547806;3239;00000001882821;8460369
995609580803;3239;00000009117644;8460369
995611196050;3239;00000009540210;8460369
995622055874;3239;00000009461140;8460369
995629068254;3239;00000002992213;8460369
995633190749;3239;00000003612872;8460369
9966512084;3239;00000008156379;8460369
401334509464;3239;00000009446524;8460369
40200425878;3239;00000010098496;8460369
995631783114;3239;00000007015771;8460369
401676370166;3239;00000080233368;8460369
401697354381;3239;00000003073360;8460369
401927744206;3239;00000007287364;8460369
402006406697;3239;00000008072507;8460369
402033349123;3239;00000008904600;8460369
402093055161;3239;00000007718543;8460369
402070022894;3239;00000007951523;8460369
682;3239;00000010813217;8460369
402079718700;3239;00000006857540;8460369
402079701182;3239;00000007672845;8460369
4617142087;3239;00000002911027;8460369
2942972087;3239;00000008417040;8460369
402033084545;3239;00000002455285;8460369
402018087279;3265;00000000126870;8460369
402075816430;3265;00000000608084;8460369
402075816430;3265;00000000608084;8460369
99562311405;4416;00000000186546;8460369
401930660234;4420;00000000228060;8460369
401962066717;4420;00000000228060;8460369
480994910;4420;00000000261912;8460369
498278083;4420;00000000618918;8460369
40209038296;4420;00000000695386;8460369
402093556845;4444;00000000107859;8460369
003085463796;3239;00000011756888;8360086
003091133246;3239;00000003151816;8360086
003085102533;4444;00000000212415;8360086
003090534891;4444;00000000269069;8360086
8999334718341;3239;00000000832146;8260082
432969128;3232;00000000034363;8260097
131513478;3239;00000009583890;8260097
1489013151341;3239;00000009583890;8260097
0007052749;4443;00000000003000;8260843
0007002279;4443;00000000000060;8260843
0007049672;4443;00000000071960;8260843
0007053676;4443;00000000121487;8260843
899996870870;3239;00000008086060;08461029
899932883248;3239;00000007272740;08461029
899933324533;3239;00000011726520;08461029
89994071720;3239;00000002353520;08461029
899932751528;3239;00000009939954;08461029
899963021235;4416;00000000080110;08461029
13035523737;4444;00000000003301;08461029
899937090005;4444;00000000003301;08461029
995633262626;3239;0000000621018;8460002
123456789100;3239;0000001048915;8460002
401550966233;3239;0000000795727;8460002
401736078524;3239;0000000845283;8460002
401772365661;3239;0000000772134;8460002
401930249356;3239;0000000293790;8460002
402031130426;3239;0000000621018;8460002
402042731170;3239;0000001144253;8460002
402060806056;3239;0000000204692;8460002
402063309894;3239;0000000294122;8460002
402078846594;3239;0000000214011;8460002
402099545969;3239;0000000021427;8460002
7104550420;3239;0000000290523;8460002
402042731170;3239;0000001144253;8460002
401961826009;4420;0000000070797;8460002
402031217084;4444;0000000000910;8460002
402007136154;4449;0000000014890;8460002
985451;3239;00000007762046;8261330
132117;3239;00000011827114;8261330
302630;3318;00000000013137;8261330
304333;3318;00000000004022;8261330
304416;3318;00000000096210;8261330
304474;3318;00000000013137;8261330
429462;3318;00000000006556;8261330
431557;3318;00000000159280;8261330
432262;3318;00000000003077;8261330
604448;3318;00000000153206;8261330
658088;3318;00000000051160;8261330
665994;3318;00000000018384;8261330
665996;3318;00000000008060;8261330
665998;3318;00000000018384;8261330
756434;3318;00000000015032;8261330
930252;3318;00000000121541;8261330
994426;3318;00000000121584;8261330
994487;3318;00000000015407;8261330
122814;3318;00000000104345;8261330
124349;3318;00000000111635;8261330
127580;3318;00000000061247;8261330
132135;3318;00000000099449;8261330
132300;3318;00000000016225;8261330
132568;3318;00000000144444;8261330
132679;3318;00000000121584;8261330
132812;3318;00000000091731;8261330
132831;3318;00000000151971;8261330
133033;3318;00000000121584;8261330
133035;3318;00000000166510;8261330
173185;3318;00000000140775;8261330
175149;3318;00000000159280;8261330
175269;3318;00000000163554;8261330
175537;3318;00000000143413;8261330
175818;3318;00000000170178;8261330
175830;3318;00000000104000;8261330
235869;3318;00000000140775;8261330
237366;3318;00000000104620;8261330
239039;3318;00000000175153;8261330
239040;3318;00000000175153;8261330
239388;3318;00000000016136;8261330
239712;3318;00000000004898;8261330
121037;4416;00000000140325;8261330
132258;4435;00000000008273;8261330
118933;4444;00000000011754;8261330
130547;4444;00000000125032;8261330
132428;4444;00000000167851;8261330
132618;4444;00000000106470;8261330
132758;4444;00000000173207;8261330
132792;4444;00000000191361;8261330
174822;4444;00000000268054;8261330
236583;4444;00000000094633;8261330
302288;4444;00000000157740;8261330
302291;4444;00000000259810;8261330
303262;4444;00000000143235;8261330
430436;4444;00000000225592;8261330
431614;4444;00000000117056;8261330
834391;4444;00000000001350;8261330
849541;4444;00000000021830;8261330
891277;4444;00000000019950;8261330
430995;4444;00000000349550;8261330
530;3239;00000011280816;08460072
99907939074;3239;00000008315604;8460064
99997939074;3239;00000008315604;8460064
89993352547;3239;00000000929166;8460064
89993688874;3239;00000007029578;8460064
89993487958;3239;00000004052684;8460064
89994713032;3265;00000000647250;8460064
89993374562;4438;00000000623555;8460064
8999628564821;3232;00000000017701;00487561
402029348791;3239;00000001985418;00487561
8999354686119;4443;00000000038210;00487561
8999971925488;3232;00000000086924;8460079
20206427945702;3239;00000000943908;8460079
2107198840;3239;00000002642239;8460079
276251171;3239;00000011288060;8460079
2835642166;3239;00000001888331;8460079
2845171395;3239;00000007862180;8460079
3185879459;3239;00000006942504;8460079
3202797990;3239;00000002571250;8460079
3465162643;3239;00000010174729;8460079
3703162181;3239;00000002646013;8460079
3927624251;3239;00000010587489;8460079
3932194030;3239;00000003879267;8460079
846900000007599;3239;00000010882847;8460079
899934597600;3239;00000001883720;8460079
9999874790374;3239;00000008268614;8460079
1316490537;3239;00000009153004;8460079
3927624251;3239;00000010587489;8460079
2206553559;3239;00000010567550;8460079
3873019355;3239;00000011549831;8460079
2909529759;3239;00000011615583;8460079
2174454275;4416;00000000021865;8460079
2174454275;4416;00000000021865;8460079
3829468662;4420;00000000190276;8460079
8999331428946;4444;00000000204102;8460079
2238657597;4444;00000000139564;8460079
2805277664;4444;00000000911712;8460079
3509538570;4444;00000000235610;8460079
3651338772;4444;00000000266345;8460079
3651681698;4444;00000000238147;8460079
8999331428946;4444;00000000204102;8460079
3557971289;4468;00000000084190;8460079
2352417613;3232;00000000164321;8460080
8999332362329;3232;00000000070165;8460080
8999359102077;3232;00000000123960;8460080
8999396275990;3239;00000006401120;8460080
2038643037;3239;00000008025576;8460080
2273100544;3239;00000002066882;8460080
2767260062;3239;00000006589588;8460080
3006484519;3239;00000002384000;8460080
307254182;3239;00000011265124;8460080
3072541827;3239;00000011265124;8460080
3117010906;3239;00000001972383;8460080
3463657475;3239;00000011358629;8460080
3507767653;3239;00000007413637;8460080
3550168502;3239;00000009522093;8460080
3617517775;3239;00000010559191;8460080
3649776458;3239;00000011084421;8460080
379868127;3239;00000002543745;8460080
3888649082;3239;00000010001018;8460080
4009593317;3239;00000010933999;8460080
4022282699;3239;00000000943908;8460080
47992149296;3239;00000011368675;8460080
8999333896653;3239;00000006826024;8460080
8999337340838;3239;00000009962999;8460080
8999339641487;3239;00000002478021;8460080
8999339818956;3239;00000007742495;8460080
8999340257660;3239;00000007742495;8460080
8999340582367;3239;00000008366500;8460080
8999340729805;3239;00000000866105;8460080
899934163464;3239;00000010732365;8460080
8999343215802;3239;00000003762742;8460080
8999343333953;3239;00000011200030;8460080
8999344928861;3239;00000006616500;8460080
8999345166671;3239;00000000835064;8460080
8999345669177;3239;00000010153454;8460080
899934792206;3239;00000006996230;8460080
8999358544017;3239;00000006748414;8460080
8999359664768;3239;00000002020424;8460080
8999365392120;3239;00000003809803;8460080
8999365438901;3239;00000010928219;8460080
899945621660;3239;00000011599090;8460080
8999467839794;3239;00000000370479;8460080
8999479801851;3239;00000003155439;8460080
899954495845;3239;00000011306106;8460080
8999570966140;3239;00000006257232;8460080
8999587732776;3239;00000009870091;8460080
8999635386399;3239;00000010704400;8460080
8999644719460;3239;00000010049550;8460080
8999788321072;3239;00000008385114;8460080
8999823523292;3239;00000008563187;8460080
8999899519580;3239;00000006307680;8460080
8999951703064;3239;00000007274750;8460080
89999544995845;3239;00000011306106;8460080
8999965516636;3239;00000009047891;8460080
8999979139147;3239;00000002269864;8460080
899998181156;3239;00000011200960;8460080
9999807616155;3239;00000007096380;8460080
9999822440275;3239;00000009250565;8460080
9999840188000;3239;00000009126503;8460080
1110514620;3239;00000007521022;8460080
8999396275990;3239;00000006401120;8460080
9999992297767;3239;00000009013210;8460080
3964316328;3239;00000009732624;8460080
8999365438901;3239;00000010928219;8460080
3117010906;3239;00000001972383;8460080
3652420421;3239;00000011585803;8460080
8999337340838;3239;00000009962999;8460080
8999396275990;3239;00000006401120;8460080
8999951703064;3239;00000007274750;8460080
3072541827;3239;00000011265124;8460080
8999373341946;3239;00000011388587;8460080
4009593317;3239;00000010933999;8460080
8999743769279;3265;00000000695289;8460080
8999359427138;3265;00000000498742;8460080
8999340050578;4416;00000000203882;8460080
8999340434040;4416;00000000067539;8460080
8999346077079;4416;00000000093777;8460080
899958931504;4435;00000000040789;8460080
8999955889405;4438;00000000333735;8460080
8999406709149;4438;00000000387657;8460080
8999909992274;4438;00000000243949;8460080
8999570173167;4443;00000000003000;8460080
8999575654007;4443;00000000003000;8460080
8999743909860;4444;00000000008028;8460080
2657423447;4457;00000000431583;8460080
8999334074061;4457;00000000000507;8460080
8999355482037;4457;00000000281115;8460080';



  vr_arquivo      UTL_FILE.file_type;
  vr_dserro       varchar2(1000);
  vr_texto        varchar2(1000);
  vr_linhascsv    gene0002.typ_split;
  vr_linhacsv     gene0002.typ_split;
  --
  vr_rowid        rowid;
  vr_cdrefere     crapatr.cdrefere%type;
  vr_cdagebcb     crapcop.cdagebcb%type; 
  vr_nrdconta     crapatr.nrdconta%type;
  vr_cdempres     tbconv_arrecadacao.cdempres%type;
  
  --
  vr_linha        number(6) := 0;
  vr_delimitador  varchar2(1) := ';';
  --
  vr_dsmotivo     varchar2(1000);
  vr_sqlerrm      varchar2(1000);
  --
  wexiste         number(1);
  wexiste_conv    number(1);
  wcommit         number(5) := 5000;
  --
  err_convenio    exception;

  CURSOR cr_tbconv_arrecadacao (pr_cdempres  IN tbconv_arrecadacao.cdempres%TYPE) IS
       SELECT tbconv_arrecadacao.cdempcon, tbconv_arrecadacao.cdsegmto
         FROM tbconv_arrecadacao
        WHERE tbconv_arrecadacao.cdempres = pr_cdempres;
  rw_tbconv_arrecadacao cr_tbconv_arrecadacao%ROWTYPE;

  CURSOR cr_crapcop (pr_cdagebcb  IN crapcop.cdagebcb%TYPE) IS
    SELECT cop.cdcooper
      FROM crapcop cop
           where cop.cdagebcb = pr_cdagebcb
     ORDER BY cop.cdcooper;
  rw_crapcop   cr_crapcop%ROWTYPE;

  
  FUNCTION fn_quebra_string(pr_string   IN CLOB
                           ,pr_delimit  IN CHAR DEFAULT ',') RETURN gene0002.typ_split IS

    vr_vlret    gene0002.typ_split := gene0002.typ_split();
    vr_quebra   LONG DEFAULT pr_string || pr_delimit;
    vr_idx      NUMBER;

  BEGIN
    -- Incluir nome do módulo logado - Chamado 660322 18/07/2017
    -- Alterado pc_set_modulo da procedure - Chamado 776896 - 18/10/2017
    GENE0001.pc_set_modulo(pr_module =>  NULL, pr_action => 'GENE0002.fn_quebra_string');
    --Se a string estiver nula retorna count = 0 no vetor
    IF nvl(pr_string,'#') = '#' THEN
      RETURN vr_vlret;
    END IF;

    LOOP
      -- Identifica ponto de quebra inicial
      vr_idx := instr(vr_quebra, pr_delimit);

      -- Clausula de saída para o loop
      exit WHEN nvl(vr_idx, 0) = 0;

      -- Acrescenta elemento para a coleção
      vr_vlret.EXTEND;
      -- Acresce mais um registro gravado no array com o bloco de quebra
      vr_vlret(vr_vlret.count) := trim(substr(vr_quebra, 1, vr_idx - 1));
      -- Atualiza a variável com a string integral eliminando o bloco quebrado
      vr_quebra := substr(vr_quebra, vr_idx + LENGTH(pr_delimit));
    END LOOP;
    -- Alterado pc_set_modulo da procedure - Chamado 776896 - 18/10/2017
    GENE0001.pc_set_modulo(pr_module =>  NULL, pr_action => NULL);

    -- Retorno do array com as substrings separadas em cada registro
    RETURN vr_vlret;
  END fn_quebra_string;

 
begin
  vr_linhascsv := fn_quebra_string(arq_csv,CHR(10));
  FOR i IN 1 .. vr_linhascsv.COUNT
  LOOP
    vr_linhacsv := fn_quebra_string(vr_linhascsv(i), ';');
    vr_cdrefere := to_number(TRIM(vr_linhacsv(1)));
    vr_cdagebcb := to_number(vr_linhacsv(2));
    vr_nrdconta := to_number(vr_linhacsv(3));
    vr_cdempres := vr_linhacsv(4);
      
--      dbms_output.put_line('importando: -> '||vr_cdempcon||' '||vr_cdsegmto);  

      OPEN cr_crapcop (vr_cdagebcb);
             
      FETCH cr_crapcop INTO rw_crapcop;
             
      IF cr_crapcop%FOUND THEN

         OPEN cr_tbconv_arrecadacao (vr_cdempres);
             
         FETCH cr_tbconv_arrecadacao INTO rw_tbconv_arrecadacao;
             
         IF cr_tbconv_arrecadacao%FOUND THEN

            BEGIN
               UPDATE crapatr SET crapatr.dtiniatr = '05/11/2020',
                                  crapatr.cdopeexc = '1'
                            WHERE crapatr.cdcooper = rw_crapcop.cdcooper
                              AND crapatr.nrdconta = vr_nrdconta
                              AND crapatr.cdhistor = 3292
                              AND crapatr.cdrefere = vr_cdrefere
                              AND crapatr.cdempcon = rw_tbconv_arrecadacao.cdempcon
                              AND crapatr.cdsegmto = rw_tbconv_arrecadacao.cdsegmto
                              AND crapatr.dtfimatr IS NULL;
            EXCEPTION
                 WHEN others THEN
                    dbms_output.put_line('Nao foi possivel alterar ATR: '||vr_nrdconta||'->'||SQLERRM);
                      RAISE;
            END;
         ELSE  
          dbms_output.put_line('Nao localizado convenio: '||vr_cdempres);

      END IF;      

         CLOSE cr_tbconv_arrecadacao;

      ELSE
        dbms_output.put_line('Nao localizado cooperativa: '||vr_cdagebcb);
    
    END IF;

      CLOSE cr_crapcop;    
 
    END LOOP;  
                            
    COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line('Erro geral no script -> ' ||SQLERRM);                
END;
0
6
vr_cdrefere
vr_cdagebcb
vr_nrdconta
vr_cdempres
rw_tbconv_arrecadacao.cdempcon
rw_tbconv_arrecadacao.cdsegmto
