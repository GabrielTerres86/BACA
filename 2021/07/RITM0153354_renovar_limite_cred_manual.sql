BEGIN
DECLARE

  --variaveis arquivos
  vr_dsmensagem     VARCHAR2(500);
  vr_nmarq_rollback VARCHAR2(100);
  vr_nmarq_log      VARCHAR2(100);
  vr_des_erro       VARCHAR2(1000);

  vr_handle utl_file.file_type;
  vr_handle_log utl_file.file_type;

  vr_dsdireto VARCHAR2(100);

  -- Variável de críticas
  vr_cdcritic crapcri.cdcritic%TYPE;
  vr_dscritic crapcri.dscritic%TYPE;
  vr_exc_erro  EXCEPTION;

  --Tipo de registro do tipo data
  rw_crapdat BTCH0001.cr_crapdat%ROWTYPE;

  CURSOR c1 IS 
    SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
      FROM craplim a
    WHERE a.cdcooper =11
      AND a.tpctrlim =1
      AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
                                     556955||47441
                                    ,611549||107472
                                    ,619469||106789
                                    ,619914||47443
                                    ,684546||113320
                                    ,685348||112310
                                    ,19||305351
                                    ,183||293920
                                    ,442||115524
                                    ,2623||305239
                                    ,5410||110469
                                    ,7536||105414
                                    ,7730||305242
                                    ,17868||308305
                                    ,35459||100792
                                    ,48445||96
                                    ,48844||2401
                                    ,53856||9296491
                                    ,54925||21303
                                    ,55905||308278
                                    ,56260||308209
                                    ,56278||992031
                                    ,63894||308322
                                    ,64793||24303
                                    ,81965||2281
                                    ,83470||308242
                                    ,92266||21320
                                    ,92533||24719
                                    ,96229||24764
                                    ,114294||10635
                                    ,128554||25957
                                    ,134694||112791
                                    ,165573||12364
                                    ,167517||110117
                                    ,167983||26822
                                    ,190810||12254
                                    ,213110||15919
                                    ,214540||308362
                                    ,215414||106814
                                    ,238180||6067
                                    ,239437||15961
                                    ,250333||107187
                                    ,254401||915926
                                    ,268283||308231
                                    ,275719||114985
                                    ,284521||31386
                                    ,285358||23201
                                    ,285480||12306
                                    ,286710||16088
                                    ,289060||12257
                                    ,295124||12805
                                    ,297925||12843
                                    ,299545||12859
                                    ,304034||16037
                                    ,304085||15777
                                    ,304620||16041
                                    ,318850||41802
                                    ,319090||15974
                                    ,326526||24346
                                    ,329630||20815
                                    ,330922||29647
                                    ,338524||23244
                                    ,339830||18582
                                    ,347850||778002
                                    ,355518||308320
                                    ,356042||110107
                                    ,361941||106498
                                    ,364916||29565
                                    ,387100||114682
                                    ,389463||29650
                                    ,392251||34564
                                    ,399264||29507
                                    ,399345||29508
                                    ,411043||31418
                                    ,412929||34489
                                    ,418480||31320
                                    ,420298||32219
                                    ,424404||29585
                                    ,427683||32217
                                    ,429112||31480
                                    ,429678||114428
                                    ,431575||34596
                                    ,432440||103967
                                    ,433136||34570
                                    ,434736||103753
                                    ,444499||34589
                                    ,445746||308376
                                    ,447404||23237
                                    ,462330||23239
                                    ,471909||109963
                                    ,473367||34561
                                    ,474720||41801
                                    ,478199||34966
                                    ,482943||34508
                                    ,484210||484210
                                    ,484768||103475
                                    ,488739||38112
                                    ,492574||38346
                                    ,497088||38313
                                    ,498203||41189
                                    ,501700||100723
                                    ,502391||38723
                                    ,507687||101488
                                    ,508586||41857
                                    ,511200||41830
                                    ,511846||41817
                                    ,519952||41867
                                    ,522287||45602
                                    ,524565||103496
                                    ,525510||42437
                                    ,526460||42454
                                    ,529559||41870
                                    ,544183||113627
                                    ,559024||103342
                                    ,563820||109064
                                    ,564427||43606
                                    ,574724||42447
                                    ,610038||107101
                                    ,610640||108692
                                    ,624136||107598
                                    ,629464||109601
                                    ,647756||45674
                                    ,655880||109393
                                    ,657328||41179
                                    ,658790||110482
                                    ,664510||110232
                                    ,692123||42351
                                    ,696390||114673
                                    ,2682||308084
                                    ,6025||98207
                                    ,6270||103842
                                    ,10502||113966
                                    ,11223||262430
                                    ,18813||42505
                                    ,19364||20566
                                    ,21148||355822
                                    ,21571||10703
                                    ,24813||19633
                                    ,35050||104228
                                    ,35157||115183
                                    ,38202||22891
                                    ,40223||9296362
                                    ,40746||47017
                                    ,56693||308073
                                    ,60160||4821
                                    ,79251||12069
                                    ,79456||288935
                                    ,87556||7054
                                    ,87602||19615
                                    ,89079||15176
                                    ,93769||38478
                                    ,94374||3755
                                    ,105643||8835
                                    ,110981||9296352
                                    ,114260||11462
                                    ,120057||94768
                                    ,131105||915880
                                    ,159077||31965
                                    ,162523||3714
                                    ,185728||8353
                                    ,192031||114941
                                    ,206180||4489
                                    ,236527||30038
                                    ,240710||8254
                                    ,240915||11836
                                    ,240982||41045
                                    ,243426||31970
                                    ,243604||8994
                                    ,255645||112397
                                    ,257796||15746
                                    ,257800||15745
                                    ,260568||25825
                                    ,263010||33940
                                    ,267848||11821
                                    ,269271||11599
                                    ,271713||15156
                                    ,282375||13232
                                    ,285374||108007
                                    ,286613||19604
                                    ,293237||13933
                                    ,297410||39916
                                    ,299871||21965
                                    ,303933||15776
                                    ,311669||16332
                                    ,316067||16398
                                    ,317527||108989
                                    ,326860||18031
                                    ,329878||39902
                                    ,331775||30230
                                    ,334090||19689
                                    ,344419||21077
                                    ,345245||21175
                                    ,355399||26697
                                    ,357898||21988
                                    ,360864||24674
                                    ,363529||40856
                                    ,366870||41248
                                    ,367281||110078
                                    ,370991||37937
                                    ,377309||39928
                                    ,385778||27342
                                    ,392715||25893
                                    ,403571||31921
                                    ,404179||30011
                                    ,406023||106380
                                    ,406759||41962
                                    ,406864||41912
                                    ,407437||30079
                                    ,407976||30083
                                    ,411329||26717
                                    ,421430||26740
                                    ,421960||22819
                                    ,421987||22821
                                    ,424781||31967
                                    ,425214||31950
                                    ,425222||31951
                                    ,426504||31976
                                    ,428752||32528
                                    ,429210||32543
                                    ,433268||29344
                                    ,433896||32585
                                    ,433993||28630
                                    ,434299||32589
                                    ,436259||26630
                                    ,438170||26641
                                    ,439894||26651
                                    ,441147||28694
                                    ,441880||28692
                                    ,442062||26690
                                    ,442259||28693
                                    ,444570||40843
                                    ,445908||34843
                                    ,447315||103535
                                    ,449970||41201
                                    ,450936||102366
                                    ,454850||39927
                                    ,455032||42602
                                    ,461920||30671
                                    ,464198||47014
                                    ,467502||34691
                                    ,473405||33995
                                    ,478644||37886
                                    ,480720||37892
                                    ,483818||37826
                                    ,484750||37836
                                    ,486620||100534
                                    ,489441||41998
                                    ,492051||107477
                                    ,496545||39948
                                    ,498769||107304
                                    ,498904||38421
                                    ,501131||38447
                                    ,502707||33974
                                    ,504424||419400
                                    ,505161||39984
                                    ,506508||41927
                                    ,507920||38459
                                    ,508209||41935
                                    ,510580||42653
                                    ,510882||108139
                                    ,512125||38462
                                    ,512931||37037
                                    ,516619||41981
                                    ,520527||42686
                                    ,520810||40818
                                    ,520900||100152
                                    ,522910||40840
                                    ,523399||40866
                                    ,523437||42691
                                    ,523860||40872
                                    ,524298||42698
                                    ,525162||40855
                                    ,525987||40874
                                    ,526495||40877
                                    ,529877||100353
                                    ,531332||100485
                                    ,537314||41914
                                    ,541346||42526
                                    ,551180||42644
                                    ,558940||47053
                                    ,561134||102979
                                    ,561142||47096
                                    ,572675||104929
                                    ,586013||114974
                                    ,586501||113446
                                    ,590304||108084
                                    ,592579||113288
                                    ,593737||105274
                                    ,601047||114764
                                    ,602370||105458
                                    ,613444||107203
                                    ,616192||108192
                                    ,616362||114735
                                    ,617857||106270
                                    ,619299||106334
                                    ,619957||114894
                                    ,621200||106553
                                    ,623105||49299
                                    ,627640||108168
                                    ,648019||108591
                                    ,648108||108592
                                    ,658324||109096
                                    ,663816||47995
                                    ,671274||110177
                                    ,676675||113814
                                    ,679976||47989
                                    ,689106||49206
                                    ,699608||115599
                                    ,700037||41619
                                    ,704407||46955
                                    ,709190||114630
                                    ,711012||114480
                                    ,711411||114708
                                    ,712337||114880
                                    ,712434||115360
                                    ,717436||115374
                                    ,1252||325007
                                    ,4782||325023
                                    ,4790||260377
                                    ,41629||294061
                                    ,43516||8289338
                                    ,44598||14410
                                    ,80454||17043
                                    ,100706||36885
                                    ,101400||22589
                                    ,107026||33300
                                    ,111503||24534
                                    ,117595||33259
                                    ,119482||5231
                                    ,124680||40524
                                    ,152315||22583
                                    ,153281||32648
                                    ,154237||40709
                                    ,166766||62190
                                    ,171417||45407
                                    ,181439||43434
                                    ,188069||32105
                                    ,192228||340856
                                    ,216488||340845
                                    ,219410||7133
                                    ,245623||13532
                                    ,245968||113114
                                    ,246271||9187
                                    ,246891||340889
                                    ,248070||24511
                                    ,249360||308498
                                    ,285927||16619
                                    ,289299||17095
                                    ,291412||14487
                                    ,300969||16720
                                    ,301876||23929
                                    ,302724||340869
                                    ,302732||16930
                                    ,309648||340836
                                    ,311723||17011
                                    ,312061||17019
                                    ,312622||38294
                                    ,314447||29037
                                    ,323209||38805
                                    ,324051||18916
                                    ,332720||27109
                                    ,343684||22511
                                    ,364681||22012
                                    ,364991||24532
                                    ,365289||22025
                                    ,366935||33066
                                    ,376213||114045
                                    ,377414||26459
                                    ,385913||26064
                                    ,387258||40231
                                    ,387568||27161
                                    ,389528||112938
                                    ,396257||29092
                                    ,397385||28935
                                    ,397768||28944
                                    ,401153||40236
                                    ,401846||28967
                                    ,407950||33108
                                    ,409553||38093
                                    ,428493||101867
                                    ,432830||355309
                                    ,433780||32961
                                    ,437484||32001
                                    ,447137||100893
                                    ,447501||36708
                                    ,447609||33061
                                    ,447765||40799
                                    ,453048||32068
                                    ,454800||115444
                                    ,455857||32086
                                    ,458007||33063
                                    ,459038||50158
                                    ,460290||36746
                                    ,477931||100333
                                    ,479012||33228
                                    ,480150||38019
                                    ,485403||112792
                                    ,485675||38234
                                    ,487350||112648
                                    ,488240||38297
                                    );


  CURSOR c2 IS 
    SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
      FROM craplim a
    WHERE a.cdcooper =11
      AND a.tpctrlim =1
      AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
                                     492620||38859
                                    ,497428||38841
                                    ,500933||340820
                                    ,502588||40737
                                    ,504459||40662
                                    ,509949||40759
                                    ,510424||45402
                                    ,512273||308421
                                    ,512478||40743
                                    ,513067||40790
                                    ,513075||46607
                                    ,513490||104615
                                    ,514489||40771
                                    ,514640||40775
                                    ,515442||40212
                                    ,517801||40675
                                    ,519073||40780
                                    ,519081||43316
                                    ,519723||40676
                                    ,520179||43451
                                    ,520535||43437
                                    ,521426||43462
                                    ,524131||524131
                                    ,524190||43313
                                    ,524590||43361
                                    ,527009||100083
                                    ,529516||100503
                                    ,529761||40228
                                    ,530662||43370
                                    ,531979||40244
                                    ,532398||43371
                                    ,561100||114171
                                    ,564141||104292
                                    ,567906||105701
                                    ,573280||103811
                                    ,596507||105804
                                    ,607789||114255
                                    ,638480||110642
                                    ,644749||114817
                                    ,645192||114962
                                    ,647896||109365
                                    ,663026||114454
                                    ,680389||114991
                                    ,696161||113444
                                    ,710||253849
                                    ,1422||18396
                                    ,26069||27828
                                    ,32077||19501
                                    ,33804||13864
                                    ,37761||27280
                                    ,46248||23012
                                    ,60976||21839
                                    ,61425||289637
                                    ,78735||19176
                                    ,88552||100864
                                    ,122637||34021
                                    ,143111||28319
                                    ,143332||112901
                                    ,181145||21846
                                    ,181170||45526
                                    ,182346||111897
                                    ,205885||92794
                                    ,231134||112440
                                    ,232483||13861
                                    ,233420||28441
                                    ,234346||8194
                                    ,234516||36440
                                    ,262579||44314
                                    ,264997||31014
                                    ,272183||10927
                                    ,280208||918216
                                    ,299154||17189
                                    ,305790||305424
                                    ,309397||305435
                                    ,311219||28420
                                    ,312223||18352
                                    ,324698||111580
                                    ,326690||27212
                                    ,337242||27889
                                    ,338117||21857
                                    ,339253||305434
                                    ,343161||20932
                                    ,343676||27876
                                    ,347116||20959
                                    ,348910||40858
                                    ,353701||24122
                                    ,356670||40150
                                    ,358592||18383
                                    ,360422||31013
                                    ,364789||22651
                                    ,368539||28496
                                    ,370789||27221
                                    ,372587||115258
                                    ,374636||23047
                                    ,376256||114553
                                    ,376639||27222
                                    ,380547||28475
                                    ,382361||110863
                                    ,392529||29799
                                    ,393550||28764
                                    ,396028||103150
                                    ,396370||28467
                                    ,401455||107281
                                    ,405655||27817
                                    ,406139||33661
                                    ,409790||30330
                                    ,417483||100825
                                    ,424676||28330
                                    ,425486||34090
                                    ,425796||40360
                                    ,426857||104074
                                    ,430528||34042
                                    ,430803||104395
                                    ,432628||34178
                                    ,432920||113903
                                    ,433730||101156
                                    ,435961||36477
                                    ,436828||33725
                                    ,440078||28385
                                    ,448583||28360
                                    ,448834||33782
                                    ,464660||40328
                                    ,476048||40101
                                    ,479020||34061
                                    ,480169||34084
                                    ,487724||34116
                                    ,488216||44312
                                    ,494461||34191
                                    ,496154||28373
                                    ,510114||40354
                                    ,510939||40373
                                    ,513016||40377
                                    ,513890||40379
                                    ,514438||44302
                                    ,515566||44303
                                    ,515892||44309
                                    ,519197||44346
                                    ,519944||44349
                                    ,524808||40396
                                    ,525022||42701
                                    ,525103||42702
                                    ,525316||38526
                                    ,528633||45568
                                    ,528951||44379
                                    ,531227||40114
                                    ,531278||40115
                                    ,531839||38575
                                    ,532606||40116
                                    ,535761||43864
                                    ,543497||42769
                                    ,545201||102198
                                    ,553956||49907
                                    ,556700||103020
                                    ,557692||104841
                                    ,561720||49951
                                    ,566780||49968
                                    ,568813||49967
                                    ,570028||114873
                                    ,570303||49974
                                    ,573116||105606
                                    ,589497||45556
                                    ,590916||106454
                                    ,602027||45589
                                    ,606723||105954
                                    ,638510||107454
                                    ,653705||109071
                                    ,655937||114000
                                    ,667323||109895
                                    ,676322||113025
                                    ,691356||111884
                                    ,694975||114149
                                    ,697702||112551
                                    ,707309||115066
                                    ,841||45001
                                    ,2674||17535
                                    ,37788||8262303
                                    ,71811||262470
                                    ,74489||11023
                                    ,88765||11516
                                    ,91774||15402
                                    ,97330||97330
                                    ,150126||18105
                                    ,158631||33373
                                    ,162256||37375
                                    ,179248||42110
                                    ,199087||8350
                                    ,199257||37082
                                    ,207306||11511
                                    ,242179||32720
                                    ,255394||42101
                                    ,257036||39129
                                    ,257656||50216
                                    ,261637||102735
                                    ,349879||109854
                                    ,364525||50205
                                    ,366293||22744
                                    ,385310||50206
                                    ,388254||28807
                                    ,392278||30246
                                    ,393983||45070
                                    ,394610||50222
                                    ,399949||50204
                                    ,401277||28829
                                    ,403920||40850
                                    ,406856||28881
                                    ,408026||28891
                                    ,408891||28899
                                    ,410055||47013
                                    ,412481||103422
                                    ,412910||33533
                                    ,414379||32709
                                    ,435040||32770
                                    ,437654||33400
                                    ,442445||45151
                                    ,453544||32820
                                    ,458180||36550
                                    ,459305||36585
                                    ,468479||37067
                                    ,472140||37358
                                    ,473243||37343
                                    ,473863||37349
                                    ,475378||37355
                                    ,477680||35713
                                    ,480665||37374
                                    ,491233||37211
                                    ,492108||35839
                                    ,497517||35891
                                    ,498084||35895
                                    ,504130||39165
                                    ,509736||45147
                                    ,510068||45024
                                    ,514071||45129
                                    ,514217||45128
                                    ,515604||42111
                                    ,519553||45158
                                    ,519898||39127
                                    ,522074||39139
                                    ,522619||522619
                                    ,524930||45145
                                    ,530433||39175
                                    ,532037||45042
                                    ,538086||37074
                                    ,555762||39192
                                    ,557005||103777
                                    ,560944||104533
                                    ,570524||37025
                                    ,573353||37035
                                    ,579076||114922
                                    ,607495||36921
                                    ,619752||35779
                                    ,619850||106636
                                    ,679968||110999
                                    ,680966||114258
                                    ,687740||112386
                                    ,690422||111785
                                    ,693359||112974
                                    ,697893||115501
                                    ,699039||112763
                                    ,707872||113872
                                    ,709417||115011
                                    ,709425||114292
                                    ,712280||115036
                                    ,104582||23953
                                    ,141119||24488
                                    ,248258||12538
                                    ,269530||45453
                                    ,327654||43990
                                    ,350656||28991
                                    ,365076||22042
                                    ,367664||36852
                                    ,375586||26425
                                    ,380334||28909
                                    ,393339||36798
                                    ,393444||29026
                                    ,404152||36420
                                    ,404616||103256
                                    ,411817||33171
                                    ,413011||33184
                                    ,461806||39279
                                    ,468452||32197
                                    ,469122||36749
                                    ,470686||325044
                                    ,472433||36425
                                    ,472468||36424
                                    ,472930||37744
                                    ,473979||37738
                                    ,476749||35203
                                    ,480355||36429
                                    ,482749||35205
                                    ,483451||38080
                                    ,483869||36739
                                    ,486191||36741
                                    ,489859||325072
                                    ,492183||492183
                                    ,492973||39218
                                    ,495255||39323
                                    ,496219||39328
                                    ,497177||39237
                                    ,503479||43883
                                    ,504700||39347
                                    ,507130||39352
                                    ,510432||39359
                                    ,514551||43897
                                    ,516627||43827
                                    ,518794||43982
                                    ,521671||43961
                                    ,521990||43965
                                    ,522708||43977
                                    ,524450||43911
                                    ,524700||45414
                                    ,527483||45410
                                    ,528684||45413
                                    ,531090||45431
                                    ,532673||45445
                                    ,532738||45443
                                    ,548863||44651
                                    ,557358||44688
                                    ,561630||43876
                                    ,615463||107679
                                    ,621358||108176
                                    ,640034||112860
                                    ,647292||108822
                                    ,650862||108842
                                    ,690716||114911
                                    ,692530||114845
                                    ,694991||112335
                                    ,700258||113222
                                    ,709301||114624
                                    ,718432||115577
                                    ,6785||11218
                                    ,15040||35823
                                    ,36455||6520
                                    ,62316||752
                                    ,133426||14319
                                    ,139149||20793
                                    ,139866||23259
                                    ,165832||7383
                                    ,185124||34203
                                    ,209279||8472
                                    ,240389||15612
                                    ,288462||27713
                                    ,302961||25365
                                    ,306568||34214
                                    ,316857||22954
                                    ,321214||19831
                                    ,342912||24766
                                    ,352691||21380
                                    ,353035||45610
                                    ,359122||36019
                                    ,381462||114730
                                    ,384623||39569
                                    ,416851||33430
                                    ,423505||44747
                                    ,493457||39454
                                    ,496626||39459
                                    ,497029||39476
                                    ,500968||39432
                                    ,500984||39434
                                    ,513792||39537
                                    ,514004||44715
                                    ,519499||44767
                                    ,520349||44768
                                    ,520845||44771
                                    ,522996||39582
                                    ,527319||44794
                                    ,528064||44797
                                    ,528331||39586
                                    ,528404||44775
                                    ,528617||39589
                                    ,529060||41219
                                    ,529141||100252
                                    ,531928||100602
                                    ,532150||44123
                                    ,533831||45903
                                    ,563676||104206
                                    ,563757||111625
                                    ,563781||103252
                                    ,572934||103860
                                    ,576212||104010
                                    ,590517||104871
                                    ,601233||105612
                                    ,618454||106421
                                    ,675350||110783
                                    ,689769||111868
                                    ,694339||114932
                                    ,697060||112723
                                    ,712922||114798
                                    ,719390||115513
                                    ,752||106892
                                    ,25550||5775
                                    ,25666||26218
                                    ,26719||36009
                                    ,29424||913467
                                    ,38601||44244
                                    ,62855||29112
                                    ,68705||21212
                                    ,69647||22977
                                    ,73806||358071
                                    ,74071||107952
                                    ,75850||6439
                                    );

  CURSOR c3 IS 
    SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
      FROM craplim a
    WHERE a.cdcooper =11
      AND a.tpctrlim =1 
      AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
                                     86584||9289425
                                    ,97659||895
                                    ,97918||40033
                                    ,99112||9294376
                                    ,99252||27971
                                    ,133396||95668
                                    ,133639||358117
                                    ,134112||113479
                                    ,135976||8467
                                    ,135992||14294
                                    ,137170||9688
                                    ,139700||26214
                                    ,183920||16463
                                    ,184993||24870
                                    ,185698||358116
                                    ,186139||19823
                                    ,186171||6495
                                    ,186368||13441
                                    ,190039||911231
                                    ,208019||27764
                                    ,240451||9477
                                    ,242608||341738
                                    ,244589||39074
                                    ,258385||27946
                                    ,258695||30796
                                    ,259004||14930
                                    ,269298||25341
                                    ,269956||25342
                                    ,271284||358118
                                    ,282596||25337
                                    ,282715||28572
                                    ,286664||24809
                                    ,291846||14989
                                    ,295140||27949
                                    ,299936||15432
                                    ,305235||22933
                                    ,310042||23883
                                    ,313106||45223
                                    ,316920||23861
                                    ,318531||21231
                                    ,332534||332534
                                    ,336092||20090
                                    ,336769||42297
                                    ,336777||358210
                                    ,337439||20100
                                    ,339903||114187
                                    ,340766||22459
                                    ,350370||24030
                                    ,368830||115685
                                    ,368903||25348
                                    ,370924||25357
                                    ,374393||30907
                                    ,381225||33417
                                    ,393266||28508
                                    ,396923||28207
                                    ,402354||28250
                                    ,403741||31112
                                    ,409227||30930
                                    ,411027||34526
                                    ,413615||31238
                                    ,414778||31607
                                    ,419346||115549
                                    ,422630||34295
                                    ,423327||31661
                                    ,423343||31662
                                    ,425583||358097
                                    ,437689||30815
                                    ,454729||36039
                                    ,460710||105723
                                    ,466794||30748
                                    ,470287||50043
                                    ,473146||30864
                                    ,477311||115379
                                    ,477486||44241
                                    ,486604||38189
                                    ,495379||39022
                                    ,495395||39064
                                    ,498122||39072
                                    ,501719||40007
                                    ,510920||42261
                                    ,515752||45269
                                    ,518182||45261
                                    ,518212||45227
                                    ,518301||45216
                                    ,520551||45268
                                    ,520721||45251
                                    ,522163||45259
                                    ,523275||45208
                                    ,523461||45209
                                    ,523518||45210
                                    ,524204||45260
                                    ,524280||45276
                                    ,524913||40047
                                    ,527858||44251
                                    ,527998||100258
                                    ,530050||44277
                                    ,531049||44283
                                    ,531774||48140
                                    ,532525||48151
                                    ,542750||50100
                                    ,545376||47570
                                    ,546496||47533
                                    ,574155||115413
                                    ,583529||115034
                                    ,614220||106054
                                    ,615668||110238
                                    ,646954||111568
                                    ,661589||114832
                                    ,662771||114272
                                    ,693111||115669
                                    ,693898||113293
                                    ,693910||113113
                                    ,704326||114497
                                    ,706434||113879
                                    ,719188||115492
                                    ,719552||115508
                                    ,167||115058
                                    ,62022||952
                                    ,102890||329210
                                    ,103438||17407
                                    ,103942||35315
                                    ,104302||296665
                                    ,105538||11725
                                    ,116912||112145
                                    ,119938||23151
                                    ,119946||30415
                                    ,124990||1173
                                    ,126691||19767
                                    ,149454||16863
                                    ,149942||24946
                                    ,150878||27029
                                    ,151025||25035
                                    ,151076||23467
                                    ,151505||27425
                                    ,151696||47260
                                    ,158950||20618
                                    ,159891||363924
                                    ,170453||18836
                                    ,171050||26996
                                    ,173479||6994
                                    ,174548||25677
                                    ,175374||36129
                                    ,175757||360610
                                    ,191272||23303
                                    ,200573||6908
                                    ,200794||5888
                                    ,201170||360943
                                    ,201804||32484
                                    ,202304||44448
                                    ,225509||17491
                                    ,225746||6959
                                    ,226041||104735
                                    ,226076||16864
                                    ,226777||23580
                                    ,227250||43772
                                    ,227510||7585
                                    ,227790||105114
                                    ,227986||23537
                                    ,228753||17401
                                    ,228885||7713
                                    ,229091||10322
                                    ,229105||360611
                                    ,229237||47134
                                    ,266710||49535
                                    ,270288||14547
                                    ,277266||12949
                                    ,282154||25656
                                    ,284947||25015
                                    ,290149||30409
                                    ,291714||110326
                                    ,295329||37619
                                    ,304867||17321
                                    ,306908||113919
                                    ,309150||17404
                                    ,316075||34734
                                    ,323691||20664
                                    ,331538||35352
                                    ,335207||17381
                                    ,340740||18824
                                    ,343960||29921
                                    ,345180||24274
                                    ,346721||26915
                                    ,347124||18895
                                    ,348082||24996
                                    ,349470||29974
                                    ,352179||25066
                                    ,352330||25383
                                    ,354570||26542
                                    ,354627||25100
                                    ,359661||23304
                                    ,359700||34708
                                    ,364959||37476
                                    ,367672||23526
                                    ,368245||23348
                                    ,368881||24924
                                    ,376620||34764
                                    ,379093||26588
                                    ,382027||25647
                                    ,385611||29835
                                    ,389277||25672
                                    ,392049||47290
                                    ,392375||30483
                                    ,399329||31596
                                    ,400963||30443
                                    ,400998||37604
                                    ,401951||28118
                                    ,405051||28180
                                    ,405922||28007
                                    ,406104||32251
                                    ,410373||28029
                                    ,413771||31514
                                    ,421057||31582
                                    ,422088||34702
                                    ,423530||32208
                                    ,423572||27468
                                    ,427179||32247
                                    ,427870||32259
                                    ,432253||32287
                                    ,433942||35311
                                    ,437972||27530
                                    ,438146||27433
                                    ,440183||35263
                                    ,440230||35264
                                    ,442003||43786
                                    ,442550||442550
                                    ,443131||31886
                                    ,443514||27551
                                    ,443522||27552
                                    ,443565||27562
                                    ,445916||36207
                                    ,449180||3
                                    ,449490||27494
                                    ,449610||35358
                                    ,452785||35925
                                    ,456020||35468
                                    ,456411||35432
                                    ,462942||35946
                                    ,467669||35345
                                    ,471860||43759
                                    ,471887||37426
                                    ,472611||37434
                                    ,477885||27575
                                    ,478121||37459
                                    ,478628||27581
                                    ,479110||37469
                                    ,482870||35687
                                    ,484474||36237
                                    ,486647||103396
                                    ,488089||36276
                                    ,488755||36283
                                    ,489557||34786
                                    ,492256||38615
                                    ,492892||43727
                                    ,494100||37573
                                    ,509752||44471
                                    ,510890||38669
                                    ,512583||44449
                                    ,512753||44481
                                    ,516520||37639
                                    ,517950||37678
                                    ,518786||44499
                                    ,520330||43735
                                    ,520977||37670
                                    ,522805||37666
                                    ,523968||43747
                                    ,525413||43712
                                    ,526762||47241
                                    ,526975||43762
                                    ,527653||43766
                                    ,527793||43770
                                    ,531847||47216
                                    ,540420||101382
                                    ,540749||101372
                                    ,540986||32357
                                    ,541885||47116
                                    ,551813||102799
                                    ,569283||103540
                                    ,570850||104150
                                    ,574139||103973
                                    ,575054||40573
                                    ,583715||104829
                                    ,605093||32373
                                    ,607444||108148
                                    ,608947||106058
                                    ,610631||112341
                                    ,619949||46380
                                    ,620092||106477
                                    ,621307||46381
                                    ,623466||46354
                                    ,626520||46355
                                    ,629316||106894
                                    ,629545||106888
                                    ,637092||107453
                                    ,642070||107680
                                    ,642703||114868
                                    ,643122||108593
                                    ,644587||115589
                                    ,676900||113706
                                    ,685402||111505
                                    ,688967||111961
                                    ,692581||112046
                                    ,694673||113963
                                    ,697680||112552
                                    ,708615||113938
                                    ,716421||115177
                                    ,719889||115518
                                    ,108847||13733
                                    ,118354||8743
                                    ,150630||10816
                                    ,168696||329235
                                    ,168700||3233
                                    ,168742||102608
                                    ,168769||9329171
                                    ,171107||329128
                                    ,196428||3068
                                    ,197793||17928
                                    ,220094||21573
                                    ,220310||104958
                                    ,221104||112755
                                    ,221589||910883
                                    ,222020||357511
                                    ,222933||357512
                                    ,223921||93195
                                    ,273970||22213
                                    ,274534||111271
                                    ,275999||14061
                                    ,285153||357502
                                    ,290840||361407
                                    ,291986||357513
                                    ,296856||20353
                                    ,296902||20354
                                    ,312894||22275
                                    ,316644||357598
                                    ,326550||20300
                                    ,334960||20373
                                    ,336750||102765
                                    ,347418||22274
                                    ,349330||21657
                                    ,349798||104809
                                    ,352241||21678
                                    ,352918||21596
                                    ,353663||21692
                                    ,357871||21756
                                    ,362921||21518
                                    ,365203||21737
                                    ,365211||39661
                                    ,365505||22301
                                    ,367125||357521
                                    ,380725||25522
                                    ,388416||36167
                                    ,415251||27619
                                    ,416703||27629
                                    ,418005||27641
                                    ,418528||26173
                                    ,419354||27644
                                    ,424382||37120
                                    ,427691||31813
                                    ,428051||31816
                                    ,428370||31818
                                    ,428710||31824
                                    ,439231||31781
                                    ,444782||31887
                                    ,452238||35164
                                    ,457051||35072
                                    ,462969||35079
                                    ,463531||39691
                                    ,463540||36375
                                    ,465631||36363
                                    ,471755||37135
                                    ,471852||39620
                                    ,472042||37128
                                    ,477400||36329
                                    ,479330||36339
                                    ,479942||35027
                                    ,482714||107555
                                    ,488291||38266
                                    ,492671||37533
                                    ,497584||39636
                                    ,500828||39681
                                    ,501000||107401
                                    ,503010||39697
                                    ,504769||44919
                                    ,505226||44938
                                    ,507253||44557
                                    ,509035||44912
                                    ,514411||44552
                                    ,514705||100990
                                    ,515477||44994
                                    ,517321||44802
                                    ,521221||103952
                                    ,523747||44567
                                    ,525588||100080
                                    ,527963||112030
                                    ,529575||100890
                                    ,531073||101176
                                    ,551848||102381
                                    ,567990||103723
                                    ,568686||103470
                                    ,584053||104640
                                    ,589616||110790
                                    ,592250||110465
                                    ,600008||106834
                                    ,602051||107012
                                    ,603600||105529
                                    ,609315||106846
                                    ,610119||106047
                                    ,626031||46624
                                    ,626139||106695
                                    ,628620||107132
                                    ,631060||107118
                                    ,643149||107761
                                    ,644307||107807
                                    ,706850||113899
                                    ,716634||115322
                                    ,2212560||7430
                                    ,490350||104143
                                    ,554260||102739
                                    ,555606||104332
                                    ,556076||47603
                                    ,556289||104559
                                    ,567922||103682
                                    ,575437||104196
                                    ,576050||104335
                                    ,587028||105109
                                    ,597600||106241
                                    ,601039||47674
                                    ,607525||105896
                                    ,612545||105960
                                    ,617067||106210
                                    ,626325||106699
                                    ,627291||106859
                                    ,627313||106750
                                    ,627860||106801
                                    ,669776||110060
                                    ,671690||110305
                                    ,671738||113238
                                    ,679330||110942
                                    ,683060||113845
                                    ,694690||112749
                                    ,701017||114283
                                    ,701033||113063
                                    ,702005||113228
                                    ,717061||115316
                                    ,720038||115529
                                    ,126993||48788
                                    ,520357||102774
                                    ,521051||42220
                                    ,531464||44580
                                    ,533360||47741
                                    ,577030||104132
                                    ,577456||104159
                                    ,583049||104961
                                    ,588520||104740
                                    ,593710||105549
                                    ,603082||105810
                                    ,613410||115161
                                    ,618225||115089
                                    ,625825||111599
                                    ,638722||107867
                                    ,642649||111515
                                    ,645923||108600
                                    ,665053||109677
                                    ,671754||114703
                                    ,690430||112129
                                    ,690473||111788
                                    ,227595||35984
                                    ,327379||19755
                                    ,394599||44596
                                    ,400050||30433
                                    ,425192||47203
                                    ,425257||47202
                                    ,436518||35239
                                    ,490016||101177
                                    ,513300||37643
                                    ,515213||37623
                                    ,515302||3
                                    ,639907||114021
                                    ,646776||108003
                                    ,658812||112300
                                    ,684570||46475
                                    ,684880||112531
                                    ,686190||112849
                                    ,692689||112057
                                    ,697907||113558
                                    ,698024||113568
                                    ,698490||113447
                                    ,707236||113960
                                    ,720232||46473
                                    );


  PROCEDURE pc_renovar_limite_cred_manual(pr_cdcooper IN crapcop.cdcooper%TYPE  --> Código da Cooperativa
                                         ,pr_cdoperad IN crapope.cdoperad%TYPE  --> Código do Operador
                                         ,pr_nmdatela IN craptel.nmdatela%TYPE  --> Nome da Tela
                                         ,pr_idorigem IN INTEGER                --> Identificador de Origem =5--aimaro
                                         ,pr_nrdconta IN crapass.nrdconta%TYPE  --> Número da Conta
                                         ,pr_dtmvtolt IN crapdat.dtmvtolt%TYPE  --> Data de Movimento
                                         ,pr_nrctrlim IN craplim.nrctrlim%TYPE  --> Contrato
                                         ,pr_cdcritic OUT PLS_INTEGER           --> Código da crítica
                                         ,pr_dscritic OUT VARCHAR2) IS         --> Descrição da crítica
  BEGIN

  DECLARE
    -- Variável de críticas
    vr_cdcritic crapcri.cdcritic%TYPE;
    vr_dscritic crapcri.dscritic%TYPE;

    -- Variaveis de Log de Alteracao
    vr_flgctitg crapalt.flgctitg%TYPE;
    vr_dsaltera LONG;

    vr_retorno  BOOLEAN DEFAULT(FALSE);
    vr_xml      xmltype;
  
    vr_nrdrowid   rowid;
  
    -- Tratamento de erros
    vr_exc_saida EXCEPTION;

    -- Parametro de Flag Rating Renovacao Ativo: 0-Não Ativo, 1-Ativo
    vr_flg_Rating_Renovacao_Ativo    NUMBER := 0;

    -- Cursor Limite de cheque especial
    CURSOR cr_craplim(pr_cdcooper IN craplim.cdcooper%TYPE     --> Código da Cooperativa
                     ,pr_nrdconta IN craplim.nrdconta%TYPE     --> Número da Conta
                     ,pr_nrctrlim IN craplim.nrctrlim%TYPE) IS --> Número do Contrato

      SELECT craplim.cddlinha,
             craplim.insitlim,
             craplim.qtrenova,
             craplim.dtrenova,
             craplim.vllimite,
             nvl(craplim.dtfimvig, craplim.dtinivig + craplim.qtdiavig) as dtfimvig,
          ---        
             craplim.tprenova,
             craplim.dsnrenov,
             craplim.dtfimvig dtfimvig_rollback,
             craplim.cdoperad ,
             craplim.cdopelib 
                          
        FROM craplim
       WHERE craplim.cdcooper = pr_cdcooper
         AND craplim.nrdconta = pr_nrdconta
         AND craplim.nrctrlim = pr_nrctrlim
         AND craplim.tpctrlim = 1
         AND craplim.insitlim = 2;-- ativa.
    rw_craplim cr_craplim%ROWTYPE;

    -- Cursor Linhas de Credito Rotativo
    CURSOR cr_craplrt (pr_cdcooper IN craplrt.cdcooper%TYPE,
                       pr_cddlinha IN craplrt.cddlinha%TYPE) IS
      SELECT craplrt.flgstlcr
        FROM craplrt
       WHERE craplrt.cdcooper = pr_cdcooper AND
             craplrt.cddlinha = pr_cddlinha;
    rw_craplrt cr_craplrt%ROWTYPE;

    -- Cursor Regras do limite de cheque especial
    CURSOR cr_craprli (pr_cdcooper IN craprli.cdcooper%TYPE,
                       pr_inpessoa IN craprli.inpessoa%TYPE) IS
      SELECT qtmaxren
        FROM craprli
       WHERE craprli.cdcooper = pr_cdcooper AND
             craprli.inpessoa = DECODE(pr_inpessoa,3,2,pr_inpessoa)
             AND craprli.tplimite = 1; -- Limite Credito
    rw_craprli cr_craprli%ROWTYPE;

    -- Cursor Associado
    CURSOR cr_crapass (pr_cdcooper IN crapass.cdcooper%TYPE,
                       pr_nrdconta IN crapass.nrdconta%TYPE) IS
      SELECT inpessoa,
             nrdctitg,
             flgctitg,
             nrcpfcnpj_base,
             cdagenci
        FROM crapass
       WHERE crapass.cdcooper = pr_cdcooper AND
             crapass.nrdconta = pr_nrdconta;
    rw_crapass cr_crapass%ROWTYPE;

    -- Cursor alteracao de cadastro
    CURSOR cr_crapalt (pr_cdcooper IN crapcop.cdcooper%TYPE
                      ,pr_nrdconta IN crapass.nrdconta%TYPE
                      ,pr_dtmvtolt IN crapdat.dtmvtolt%TYPE) IS
      SELECT crapalt.dsaltera,
             crapalt.rowid,
             crapalt.cdoperad,
             crapalt.flgctitg
        FROM crapalt
       WHERE crapalt.cdcooper = pr_cdcooper
         AND crapalt.nrdconta = pr_nrdconta
         AND crapalt.dtaltera = pr_dtmvtolt;
    rw_crapalt cr_crapalt%ROWTYPE;


    CURSOR cr_tbrisco_operacoes(pr_cdcooper IN craplim.cdcooper%TYPE     --> Código da Cooperativa
                     ,pr_nrdconta IN craplim.nrdconta%TYPE               --> Número da Conta
                     ,pr_nrctrlim IN craplim.nrctrlim%TYPE) IS           --> Número do Contrato
    SELECT 1 FROM tbrisco_operacoes o
                 WHERE o.cdcooper = pr_cdcooper
                   AND o.nrdconta = pr_nrdconta
                   AND o.nrctremp = pr_nrctrlim
                   AND o.tpctrato = 1
                   AND o.flintegrar_sas = 1;--- já marcado para atualizar
    rw_tbrisco_operacoes cr_tbrisco_operacoes%ROWTYPE;

    vr_in_risco_rat INTEGER;
    vr_habrat VARCHAR2(1) := 'N'; -- P450 - Paramentro para Habilitar Novo Ratin (S/N)

    -- P450 Valida Endividamento
    vr_strating     NUMBER;
    vr_flgrating    NUMBER;
    vr_vlendivid    craplim.vllimite%TYPE; -- Valor do Endividamento do Cooperado
    vr_vllimrating  craplim.vllimite%TYPE; -- Valor do Parametro Rating (Limite) TAB056
    -- P450 Valida Endividamento

    -- Informações de data do sistema
    rw_crapdat      btch0001.rw_crapdat%TYPE;
    vr_innivris     NUMBER;

    BEGIN
      --> Buscar Parametro
      vr_flg_Rating_Renovacao_Ativo := gene0001.fn_param_sistema(pr_nmsistem => 'CRED'
                                                                ,pr_cdcooper => 0
                                                                ,pr_cdacesso => 'RATING_RENOVACAO_ATIVO');

      vr_habrat := gene0001.fn_param_sistema(pr_nmsistem => 'CRED',
                                             pr_cdcooper => pr_cdcooper,
                                             pr_cdacesso => 'HABILITA_RATING_NOVO');

      -- Consultar o limite de credito
      OPEN cr_craplim(pr_cdcooper => pr_cdcooper,
                      pr_nrdconta => pr_nrdconta,
                      pr_nrctrlim => pr_nrctrlim);
      FETCH cr_craplim INTO rw_craplim;
    
      -- Verifica se o limite de credito existe
      IF cr_craplim%NOTFOUND THEN
        CLOSE cr_craplim;
        vr_dscritic := 'Associado nao possui proposta de limite de credito Ativa. ';
        RAISE vr_exc_saida;
      ELSE
        CLOSE cr_craplim;
      END IF;

      -- Verifica se a data esta cadastrada
      OPEN BTCH0001.cr_crapdat(pr_cdcooper => pr_cdcooper);
      FETCH BTCH0001.cr_crapdat INTO rw_crapdat;

      -- Se não encontrar
      IF BTCH0001.cr_crapdat%NOTFOUND THEN
        -- Fechar o cursor pois haverá raise
        CLOSE BTCH0001.cr_crapdat;
    
        -- Montar mensagem de critica
        vr_dscritic := gene0001.fn_busca_critica(pr_cdcritic => 1);
        RAISE vr_exc_saida;
      ELSE
        -- Apenas fechar o cursor
        CLOSE BTCH0001.cr_crapdat;
      END IF;

      -- Verifica a situacao do limite do cheque especial
      IF nvl(rw_craplim.insitlim,0) <> 2 THEN
        vr_dscritic := 'O contrato de limite de credito deve estar ativo.';
        RAISE vr_exc_saida;
      END IF;

      -- Verificacao para saber se jah passou o vencimento do limite para a renovacao
      IF rw_craplim.dtfimvig > pr_dtmvtolt THEN
        vr_dscritic := 'Nao e possivel realizar a renovacao do limite. Contrato nao esta vencido.';
        RAISE vr_exc_saida;
      END IF;

      -- Consulta o limite de credito
      OPEN cr_craplrt(pr_cdcooper => pr_cdcooper,
                      pr_cddlinha => rw_craplim.cddlinha);
      FETCH cr_craplrt INTO rw_craplrt;
      -- Verifica se o limite de credito existe
      IF cr_craplrt%NOTFOUND THEN
        CLOSE cr_craplrt;
        vr_dscritic := 'Linha de Credito nao cadastrada. Linha: ' || rw_craplim.cddlinha;
        RAISE vr_exc_saida;
      ELSE
        CLOSE cr_craplrt;
      END IF;

      -- Consulta o Associado
      OPEN cr_crapass(pr_cdcooper => pr_cdcooper,
                      pr_nrdconta => pr_nrdconta);
      FETCH cr_crapass INTO rw_crapass;
      -- Verifica se o limite de credito existe
      IF cr_crapass%NOTFOUND THEN
        CLOSE cr_crapass;
        vr_dscritic := 'Associado nao cadastrado. Conta: ' || pr_nrdconta;
        RAISE vr_exc_saida;
      ELSE
        CLOSE cr_crapass;
      END IF;

      -- Consulta a regra do limite de cheque especial
      OPEN cr_craprli(pr_cdcooper => pr_cdcooper,
                      pr_inpessoa => rw_crapass.inpessoa);
      FETCH cr_craprli INTO rw_craprli;
      -- Verifica se o limite de credito existe
      IF cr_craprli%NOTFOUND THEN
        CLOSE cr_craprli;
        vr_dscritic := 'Regras do Linha de Credito nao cadastrada.';
        RAISE vr_exc_saida;
      ELSE
        CLOSE cr_craprli;
      END IF;
      

      -- P450 SPT13 - alteracao para habilitar rating novo
      IF (pr_cdcooper <> 3 AND vr_habrat = 'S') THEN
        
        -- Verifica processamento do Rating Renovacao
        IF vr_flg_Rating_Renovacao_Ativo = 1 THEN
          -- Validar Status rating
          RATI0003.pc_busca_status_rating(pr_cdcooper  => pr_cdcooper
                                         ,pr_nrdconta  => pr_nrdconta
                                         ,pr_tpctrato  => 1 -- Limite Credito
                                         ,pr_nrctrato  => pr_nrctrlim
                                         ,pr_strating  => vr_strating
                                         ,pr_flgrating => vr_flgrating
                                         ,pr_cdcritic  => vr_cdcritic
                                         ,pr_dscritic  => vr_dscritic);

          IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
          
            IF substr(vr_dscritic,1,47) = 'Contrato nao pode ser efetivado, Rating vencido' THEN

              -- verificar se já está marcado para atualizar o rating a noite via lote, se já está não precisa fazer novamente.
              OPEN cr_tbrisco_operacoes(pr_cdcooper => pr_cdcooper,
                              pr_nrdconta => pr_nrdconta,
                              pr_nrctrlim => pr_nrctrlim);
              FETCH cr_tbrisco_operacoes INTO rw_tbrisco_operacoes;
              
              IF cr_tbrisco_operacoes%NOTFOUND THEN
        
                BEGIN 
                  UPDATE tbrisco_operacoes o
                     SET o.flintegrar_sas = 1
                   WHERE o.cdcooper = pr_cdcooper
                     AND o.nrdconta = pr_nrdconta
                     AND o.nrctremp = pr_nrctrlim
                     AND o.tpctrato = 1;
                EXCEPTION
                  WHEN OTHERS THEN
                  vr_dscritic := 'Erro atualizar tabela tbrisco_operacoes, para rating vencido '||SQLERRM;
                  RAISE vr_exc_saida;
                END;
                                                
                vr_retorno := rati0003.fn_registra_historico(pr_cdcooper             => pr_cdcooper
                                                            ,pr_cdoperad             => pr_cdoperad
                                                            ,pr_nrdconta             => pr_nrdconta
                                                            ,pr_nrctro               => pr_nrctrlim
                                                            ,pr_dtmvtolt             => NULL
                                                            ,pr_valor                => 0
                                                            ,pr_tpctrato             => 1
                                                            ,pr_rating_sugerido      => NULL
                                                            ,pr_justificativa        => 'Renovacao Limite de credito em massa1'
                                                            ,pr_inrisco_rating       => NULL
                                                            ,pr_dtrisco_rating       => NULL
                                                            ,pr_inrisco_rating_autom => NULL
                                                            ,pr_dtrisco_rating_autom => NULL
                                                            ,pr_insituacao_rating    => NULL
                                                            ,pr_inorigem_rating      => NULL
                                                            ,pr_cdoperad_rating      => pr_cdoperad
                                                            ,pr_tpoperacao_rating    => NULL
                                                            ,pr_cdcritic             => vr_cdcritic
                                                            ,pr_dscritic             => vr_dscritic);
                                        
                IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
                  RAISE vr_exc_saida;
                END IF;
                    
                gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                ,pr_des_text => 'UPDATE tbrisco_operacoes SET '
                                          ||' flintegrar_sas = 0 '
                                      ||' WHERE cdcooper = '||pr_cdcooper
                                      ||'   AND nrdconta = '||pr_nrdconta
                                      ||'   AND nrctremp = '||pr_nrctrlim
                                      ||'   AND tpctrato = 1;' -- Limite Credito        
                                );           
              
                gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                ,pr_des_text => 'DELETE tbrating_historicos '
                                      ||' WHERE cdcooper = '||pr_cdcooper           
                                      ||'   AND nrdconta = '||pr_nrdconta                                 
                                      ||'   AND nrctremp = '||pr_nrctrlim                                 
                                      ||'   AND tpctrato = 1 '                                 
                                      ||'   AND ds_justificativa = '||''''||'Renovacao Limite de credito em massa1'||''''                                 
                                      ||';'                                 
                                 );
              END IF;                                                  
                                   
            ELSE
              RAISE vr_exc_saida;
            END IF;  
          
          ELSE
            -- Buscar Valor Endividamento e Valor Limite Rating (TAB056)
            RATI0003.pc_busca_endivid_param(pr_cdcooper => pr_cdcooper
                                           ,pr_nrdconta => pr_nrdconta
                                           ,pr_vlendivi => vr_vlendivid
                                           ,pr_vlrating => vr_vllimrating
                                           ,pr_dscritic => vr_dscritic);
            IF TRIM(vr_dscritic) IS NOT NULL THEN
               RAISE vr_exc_saida;
            END IF;

            -- Status do rating inválido
            IF vr_flgrating = 0 THEN
              vr_dscritic := 'Contrato não pode ser efetivado porque não há Rating válido.';
              RAISE vr_exc_saida;
            ELSE
              -- Se Endividamento + Contrato atual > Parametro Rating (TAB056)
              IF ((vr_vlendivid) > vr_vllimrating) THEN

                -- Gravar o Rating da operação, efetivando-o
                rati0003.pc_grava_rating_operacao(pr_cdcooper          => pr_cdcooper
                                                 ,pr_nrdconta          => pr_nrdconta
                                                 ,pr_tpctrato          => 1 -- Limite Credito
                                                 ,pr_nrctrato          => pr_nrctrlim
                                                 ,pr_dtrating          => pr_dtmvtolt
                                                 ,pr_strating          => 4
                                                 ,pr_efetivacao_rating => 1 -- Identificar se deve considerar o parâmetro de contingência
                                                 --Variáveis para gravar o histórico
                                                 ,pr_cdoperad          => pr_cdoperad
                                                 ,pr_dtmvtolt          => pr_dtmvtolt
                                                 ,pr_valor             => rw_craplim.vllimite
                                                 ,pr_rating_sugerido   => NULL
                                                 ,pr_justificativa     => 'Renovação de Contrato - Efetivação do Rating [LIMI0001.pc_renovar_limite_cred_manual]'
                                                 ,pr_tpoperacao_rating => 2
                                                 ,pr_nrcpfcnpj_base    => rw_crapass.nrcpfcnpj_base
                                                 --Variáveis de crítica
                                                 ,pr_cdcritic          => vr_cdcritic
                                                 ,pr_dscritic          => vr_dscritic);

                IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
                  RAISE vr_exc_saida;
                END IF;

                rati0005.pc_altera_flag_alterar(pr_cdcooper => pr_cdcooper
                                               ,pr_nrdconta => pr_nrdconta
                                               ,pr_nrctrato => pr_nrctrlim
                                               ,pr_tpctrato => 1 -- Limite Credito
                                               ,pr_flgalter => 0
                                               ,pr_dscritic => vr_dscritic);

                IF TRIM(vr_dscritic) IS NOT NULL THEN
                  RAISE vr_exc_saida;
                END IF;

              END IF;
              
            END IF; -- Status do rating válido

          END IF; --- rating vencido
        END IF;-- Verifica processamento do Rating Renovacao
      END IF; -- P450 SPT13 - alteracao para habilitar rating novo

      gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                    ,pr_des_text => 'UPDATE craplim SET '
                                                        ||' dtrenova = '||''''||to_char(rw_craplim.dtrenova,'dd/mm/rrrr')||''''
                                                       ||' ,tprenova = '||''''||rw_craplim.tprenova||''''
                                                       ||' ,dsnrenov = '||''''||rw_craplim.dsnrenov||''''                
                                                       ||' ,dtfimvig = '||''''||to_char(rw_craplim.dtfimvig_rollback,'dd/mm/rrrr')||''''
                                                       ||' ,qtrenova = '||rw_craplim.qtrenova
                                                       ||' ,cdoperad = '||''''||rw_craplim.cdoperad||''''
                                                       ||' ,cdopelib = '||''''||rw_craplim.cdoperad||''''
                                                ||' WHERE cdcooper = '||pr_cdcooper
                                                ||'   AND nrdconta = '||pr_nrdconta
                                                 ||'  AND nrctrlim = '||pr_nrctrlim
                                                 ||'  AND tpctrlim = 1;' -- Limite Credito        
                                    );
 
      -- Atualiza os dados do limite de cheque especial
      BEGIN
        UPDATE craplim SET
               dtrenova = pr_dtmvtolt,
               tprenova = 'M',
               dsnrenov = '',
               dtfimvig = pr_dtmvtolt + nvl(qtdiavig,0),
               qtrenova = nvl(qtrenova,0) + 1,
               cdoperad = pr_cdoperad,
               cdopelib = pr_cdoperad
         WHERE cdcooper = pr_cdcooper
           AND nrdconta = pr_nrdconta
           AND nrctrlim = pr_nrctrlim
           AND tpctrlim = 1; -- Limite Credito
      EXCEPTION
        WHEN OTHERS THEN
          vr_dscritic := 'Erro ao renovar o limite de credito: ' || SQLERRM;
          RAISE vr_exc_saida;
      END;

      /* Por default fica como 3 */
      vr_flgctitg  := 3;
      vr_dsaltera  := 'Renov. Manual Limite Cred. Ctr: ' || pr_nrctrlim || ',';

      /* Se for conta integracao ativa, seta a flag para enviar ao BB */
      IF trim(rw_crapass.nrdctitg) IS NOT NULL AND rw_crapass.flgctitg = 2 THEN  /* Ativa */
        --Conta Integracao
        vr_flgctitg := 0;
      END IF;

      /* Verifica se ja possui alteracao */
      OPEN cr_crapalt (pr_cdcooper => pr_cdcooper
                      ,pr_nrdconta => pr_nrdconta
                      ,pr_dtmvtolt => pr_dtmvtolt);
      FETCH cr_crapalt INTO rw_crapalt;
    
      --Verificar se encontrou
      IF cr_crapalt%FOUND THEN
        CLOSE cr_crapalt;

        gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                      ,pr_des_text => 'UPDATE crapalt SET '
                                                          ||' dsaltera = '||''''||to_char(rw_craplim.dtrenova,'dd/mm/rrrr')||''''
                                                          ||' ,cdoperad = '||''''||rw_craplim.cdoperad||''''
                                                          ||' ,flgctitg = '||''''||rw_craplim.cdoperad||''''
                                                     ||' WHERE rowid = '||''''||rw_crapalt.rowid||''''
                                                     ||';'
                                      );          

        BEGIN
          UPDATE crapalt SET
                 crapalt.dsaltera = rw_crapalt.dsaltera || vr_dsaltera,
                 crapalt.cdoperad = pr_cdoperad,
                 crapalt.flgctitg = vr_flgctitg
           WHERE crapalt.rowid = rw_crapalt.rowid;
        EXCEPTION
          WHEN OTHERS THEN
            vr_dscritic:= 'Erro ao atualizar crapalt. '||SQLERRM;
            RAISE vr_exc_saida;
        END;
      ELSE
        CLOSE cr_crapalt;

        BEGIN
          INSERT INTO crapalt
            (crapalt.nrdconta
            ,crapalt.dtaltera
            ,crapalt.tpaltera
            ,crapalt.dsaltera
            ,crapalt.cdcooper
            ,crapalt.flgctitg
            ,crapalt.cdoperad)
          VALUES
            (pr_nrdconta
            ,pr_dtmvtolt
            ,2
            ,vr_dsaltera
            ,pr_cdcooper
            ,vr_flgctitg
            ,pr_cdoperad);

            gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                          ,pr_des_text => 'DELETE crapalt '
                                                        ||' WHERE cdcooper = '||pr_cdcooper
                                                          ||' AND nrdconta = '||pr_nrdconta
                                                          ||' AND tpaltera = 2'
                                                          ||' AND dtaltera = '||''''||to_char(pr_dtmvtolt,'dd/mm/rrrr')||''''
                                                          ||';'
                                          );          
       
        EXCEPTION
          WHEN OTHERS THEN
            vr_dscritic := 'Erro ao inserir crapalt. '||SQLERRM;
            RAISE vr_exc_saida;
        END;

      END IF;
      
     GENE0001.pc_gera_log(pr_cdcooper =>  pr_cdcooper
                          ,pr_cdoperad => '1'
                          ,pr_dscritic => ' '
                          ,pr_dsorigem => gene0001.vr_vet_des_origens(5)
                          ,pr_dstransa => 'Renovacao manual Limite (RITM0153354)'
                          ,pr_dttransa => TRUNC(SYSDATE)
                          ,pr_flgtrans => 1
                          ,pr_hrtransa => gene0002.fn_busca_time
                          ,pr_idseqttl => 1
                          ,pr_nmdatela => 'Script'
                          ,pr_nrdconta => pr_nrdconta
                          ,pr_nrdrowid => vr_nrdrowid);
      --
      GENE0001.pc_gera_log_item(pr_nrdrowid => vr_nrdrowid,
                                pr_nmdcampo => 'Contrato',
                                pr_dsdadant => NULL,
                                pr_dsdadatu => pr_nrctrlim);    

    EXCEPTION
      WHEN vr_exc_saida THEN
        pr_cdcritic := vr_cdcritic;
        pr_dscritic := vr_dscritic;
      WHEN OTHERS THEN
        pr_cdcritic := vr_cdcritic;
        pr_dscritic := 'Erro geral pc_renovar_limite_cred_manual: '|| SQLERRM;
    END;

  END pc_renovar_limite_cred_manual;

BEGIN
  BEGIN
    --Verificar se a data existe
    OPEN BTCH0001.cr_crapdat(pr_cdcooper => 11);
      FETCH BTCH0001.cr_crapdat INTO rw_crapdat;
    CLOSE BTCH0001.cr_crapdat;  

    vr_dsdireto       := GENE0001.fn_param_sistema('CRED',3,'ROOT_MICROS') || 'cecred/naiara/';
    vr_nmarq_rollback := vr_dsdireto||'RITM0153354_ROLLBACK.sql';
    vr_nmarq_log      := vr_dsdireto||'LOG_RITM0153354.txt';


    /* Abrir o arquivo de rollback */
    gene0001.pc_abre_arquivo(pr_nmcaminh => vr_nmarq_rollback
                            ,pr_tipabert => 'W'           --> Modo de abertura (R,W,A)
                            ,pr_utlfileh => vr_handle     --> Handle do arquivo aberto
                            ,pr_des_erro => vr_des_erro);
                            
    if vr_des_erro is not null then
      vr_dsmensagem := 'Erro ao abrir arquivo de rollback: ' || vr_des_erro;
      RAISE vr_exc_erro;
    end if;

    /* Abrir o arquivo de LOG */
    gene0001.pc_abre_arquivo(pr_nmcaminh => vr_nmarq_log
                            ,pr_tipabert => 'W'                --> Modo de abertura (R,W,A)
                            ,pr_utlfileh => vr_handle_log     --> Handle do arquivo aberto
                            ,pr_des_erro => vr_des_erro);
                            
    if vr_des_erro is not null then
      vr_dsmensagem := 'Erro ao abrir arquivo de LOG: ' || vr_des_erro;
      RAISE vr_exc_erro;
    end if;
              
    gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                  ,pr_des_text => 'Coop;Conta;Contrato;Mensagem');
                                          

    FOR r1 IN c1 LOOP

      pc_renovar_limite_cred_manual(pr_cdcooper => 11
                                   ,pr_cdoperad =>'1'
                                   ,pr_nmdatela =>'ATENDA'
                                   ,pr_idorigem =>5  --aimaro
                                   ,pr_nrdconta =>r1.nrdconta
                                   ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                   ,pr_nrctrlim =>  r1.nrctrlim
                                   ,pr_cdcritic => vr_cdcritic
                                   ,pr_dscritic => vr_dscritic);
                                   
       IF vr_dscritic IS NOT NULL THEN
         gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                       ,pr_des_text => r1.cdcooper || ';' || r1.nrdconta || ';' || 
                                                       r1.nrctrlim || ';' || vr_dscritic);
         vr_dscritic := NULL;                                                
       END IF;                 

    END LOOP;
    
    
   FOR r2 IN c2 LOOP

      pc_renovar_limite_cred_manual(pr_cdcooper => 11
                                   ,pr_cdoperad =>'1'
                                   ,pr_nmdatela =>'ATENDA'
                                   ,pr_idorigem =>5  --aimaro
                                   ,pr_nrdconta =>r2.nrdconta
                                   ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                   ,pr_nrctrlim =>  r2.nrctrlim
                                   ,pr_cdcritic => vr_cdcritic
                                   ,pr_dscritic => vr_dscritic);
                                   
       IF vr_dscritic IS NOT NULL THEN
         gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                       ,pr_des_text => r2.cdcooper || ';' || r2.nrdconta || ';' || 
                                        r2.nrctrlim || ';' || vr_dscritic);
                                        
            vr_dscritic := NULL;                                                
       END IF;                     

    END LOOP;
    
   FOR r3 IN c3 LOOP

      pc_renovar_limite_cred_manual(pr_cdcooper => 11
                                   ,pr_cdoperad =>'1'
                                   ,pr_nmdatela =>'ATENDA'
                                   ,pr_idorigem =>5  --aimaro
                                   ,pr_nrdconta => r3.nrdconta
                                   ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                   ,pr_nrctrlim => r3.nrctrlim
                                   ,pr_cdcritic => vr_cdcritic
                                   ,pr_dscritic => vr_dscritic);
                                   
       IF vr_dscritic IS NOT NULL THEN
         gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                       ,pr_des_text => r3.cdcooper || ';' || r3.nrdconta || ';' || 
                                        r3.nrctrlim || ';' || vr_dscritic);
                                        
            vr_dscritic := NULL;                                                
       END IF;                  

    END LOOP;  


    gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                  ,pr_des_text => 'COMMIT;');                                

    COMMIT;

    EXCEPTION
      
      WHEN vr_exc_erro THEN
        dbms_output.put_line('Erro arquivos: ' || vr_dsmensagem);
        gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                      ,pr_des_text => 'Erro arquivos: ' || vr_dsmensagem || ' SQLERRM: ' || SQLERRM);      

        gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                      ,pr_des_text => 'COMMIT;');
        ROLLBACK;  
        
      WHEN OTHERS THEN
        dbms_output.put_line('Erro geral: ' || ' SQLERRM: ' || SQLERRM);
        gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                      ,pr_des_text => 'Erro geral: ' || ' SQLERRM: ' || SQLERRM);

        gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                      ,pr_des_text => 'COMMIT;');
        ROLLBACK;
    END;
      
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle);
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle_log);
END;
END;
