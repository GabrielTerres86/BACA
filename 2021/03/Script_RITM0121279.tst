PL/SQL Developer Test script 3.0
3027
DECLARE



--variaveis arquivos
  vr_dsmensagem varchar2(500);
  vr_nmarq_rollback VARCHAR2(100);
  vr_nmarq_log      VARCHAR2(100);
  vr_des_erro VARCHAR2(1000);

  vr_handle utl_file.file_type;
  vr_handle_log utl_file.file_type;


  vr_dsdireto VARCHAR2(100);

    -- Variável de críticas
    vr_cdcritic crapcri.cdcritic%TYPE;
    vr_dscritic crapcri.dscritic%TYPE;
    vr_exc_erro  EXCEPTION;

  --Tipo de registro do tipo data
    rw_crapdat BTCH0001.cr_crapdat%ROWTYPE;
--    vr_texto VARCHAR2(600);

CURSOR c1 IS 
SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
FROM craplim a
WHERE a.cdcooper =14
AND a.tpctrlim =1
--AND rownum < 20
AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
27||302317
,43||286873
,140||341301
,167||791
,175||302351
,183||302352
,191||302394
,264||285646
,299||4359
,310||262233
,329||262232
,345||341343
,361||310635
,388||335066
,485||302334
,540||357058
,558||341383
,566||302320
,620||384654
,671||335073
,680||262265
,698||334028
,736||411628
,809||302314
,850||334039
,868||101997
,981||3902
,1120||262254
,1139||302307
,1147||100614
,1163||365683
,1180||286804
,1198||335063
,1392||334057
,1422||100321
,1520||366666
,1651||280794
,1708||262293
,1716||285643
,1724||262294
,1821||286864
,1830||286925
,1899||262285
,1929||3294
,2160||286927
,2321||285647
,2372||290291
,2518||286874
,2755||302322
,2879||1806
,3115||262249
,3140||286883
,3212||4577
,3298||302338
,3328||286847
,3387||302330
,3409||286894
,3417||302304
,3522||314301
,3530||334033
,3565||302387
,3603||302355
,3670||357005
,3840||358493
,3930||366651
,3956||365656
,4103||280768
,4529||302341
,4685||3582
,4855||285699
,4898||286948
,5100||365665
,5185||334101
,5266||280704
,5363||3226
,5410||314309
,5436||286931
,5592||3642
,5720||3231
,5754||1783
,5835||286867
,6211||335090
,6289||334002
,6394||302354
,6432||286911
,6440||101500
,6513||6889
,6521||334061
,6548||302374
,6700||877
,6734||335089
,6777||1120
,6793||1102
,6904||4602
,7005||100221
,7366||280779
,7412||314391
,7480||6833
,7714||101740
,9148||334024
,9245||286871
,9350||286913
,9393||6520
,9466||286972
,9482||286962
,9520||304498
,9571||334058
,9717||335079
,9733||335080
,9741||335052
,10014||4594
,10090||366834
,10120||380440
,10227||358405
,10235||3604
,10278||832
,10502||618
,10707||668
,10766||4674
,10910||334047
,10995||290298
,11118||3922
,11169||334056
,11177||4202
,11193||411605
,11274||380498
,11290||1738
,11347||4318
,11363||358492
,11398||304490
,11525||304467
,11630||341310
,11703||262222
,11738||6843
,11789||100834
,11800||687
,11894||302353
,11959||304427
,12122||495
,12190||341385
,12289||663
,12343||366608
,12351||334009
,12521||411617
,12580||1841
,12688||4394
,12700||101399
,12831||417
,12866||366610
,12890||3272
,12947||3418
,13200||365682
,13218||286851
,13439||433
,13455||401
,13471||287000
,13579||913
,13889||334018
,13951||380419
,14699||341485
,14869||100695
,15229||1773
,15296||302343
,15490||741
,15733||100987
,15792||302312
,15806||341304
,15822||102449
,15920||100352
,16187||341390
,16330||3223
,16411||335008
,16608||334052
,16632||3628
,16799||1792
,17094||380415
,17159||358446
,17175||341340
,17418||366835
,17620||310611
,17671||380402
,17795||1822
,17817||101823
,17833||1805
,17892||100216
,17922||4477
,17957||335064
,18058||3417
,18066||335009
,18139||3256
,18252||3566
,18260||447
,18430||4514
,18740||4236
,18767||341372
,19038||358481
,19186||411630
,19208||4127
,19356||4597
,19488||310603
,19739||931
,19763||304471
,19879||4350
,23868||366657
,23981||366663
,24031||366662
,24201||384672
,24570||921
,24635||380500
,24953||380486
,24961||4611
,25097||384642
,25259||380453
,25747||380462
,25755||841
,26093||380461
,26387||310602
,26409||7079
,26433||4339
,26484||380405
,26743||366872
,26824||4450
,26948||384670
,27510||3243
,27588||366811
,28142||4528
,28762||1130
,28860||3218
,29122||703
,29165||414
,29327||780
,29661||3220
,29858||3227
,29904||3660
,29998||4170
,30040||450
,30163||6566
,30171||100857
,30228||380436
,30279||366680
,30414||3567
,30422||366645
,30511||4546
,30589||357041
,30783||4520
,30856||358415
,31038||384692
,31062||4161
,31453||100748
,31607||380437
,31801||366627
,31976||4315
,32000||358434
,32085||3542
,32182||384656
,32204||365660
,32301||366626
,32450||3650
,32522||365670
,32638||101151
,32760||366640
,32859||476
,33430||4454
,33510||3232
,33650||3600
,33987||101403
,34070||1787
,34720||1771
,35050||3253
,35289||833
,35556||4356
,35980||3568
,36560||384700
,36714||310614
,36722||366888
,36730||358485
,37400||764
,37702||3915
,38032||411609
,38369||384693
,38636||1836
,38806||1899
,38938||7027
,39268||6866
,39560||848
,39918||6880
,39942||446
,39993||6563
,40045||365618
,41769||341475
,42030||365648
,42552||3419
,42587||675
,42633||4171
,42757||411611
,43087||4608
,43125||411610
,43281||7064
,43443||1121
,43761||100317
,44938||678
,45268||1724
,45721||1713
,46647||100472
,46884||1126
,47260||384653
,47279||1756
,47619||3907
,47961||878
,47970||1898
,48208||432
,48232||102490
,48542||441
,49026||6568
,49085||3681
,49239||6867
,49328||481
,49530||3624
,49646||100872
,49778||3283
,52108||100372
,52370||890
,52590||1712
,52760||1774
,52787||4550
,52809||3697
,53082||100467
,53805||401101
,54046||1758
,54291||384684
,54399||1731
,54712||100044
,55220||4561
,55492||55492
,55549||4473
,56243||3251
,56731||101120
,56995||6503
,58181||310630
,58203||365686
,58297||411608
,58637||3671
,59447||922
,59986||4560
,60003||2174
,60186||3664
,61387||3219
,61751||4523
,62189||411612
,62600||3269
,62626||6890
,62677||677
,63428||3238
,64173||411601
,64289||4142
,64491||357036
,64556||310601
,64815||4316
,65340||3629
,65420||3242
,65439||3249
,65811||100808
,65889||4302
,65927||7032
,65951||3207
,66060||3634
,66125||102579
,66168||3635
,66877||298810
,67490||3643
,67504||4669
,68101||411614
,68152||418
,68284||4410
,68730||4580
,68977||4621
,69604||4219
,69680||4599
,69841||4524
,69906||7014
,69965||3657
,69981||488
,70378||3259
,70459||384665
,70467||4226
,70548||4229
,70580||4622
,71501||419
,71595||5298
,71609||358498
,71935||6836
,72265||6555
,72770||310629
,72800||411618
,72958||3668
,73113||100149
,73164||430
,73300||384666
,73750||442
,73890||4601
,73997||480
,74063||494
,74250||7058
,74900||411623
,74918||467
,75132||384668
,75280||483
,75469||491
,75590||499
,75680||4374
,75973||4647
,76350||6884
,76430||3686
,76635||100171
,76961||6526
,77186||6860
,77232||4665
,78239||3695
,78468||100325
,78808||7041
,78867||100050
,78913||4427
,78921||4431
,79103||4444
,79170||4440
,79260||3552
,79294||7080
,79707||3925
,79731||4480
,79979||4487
,80012||4491
,80101||384669
,80217||4494
,80233||4378
,80250||4495
,80659||6550
,81051||5428
,81663||3287
,82139||4303
,84190||101143
,84751||4547
,85499||4574
,85570||6898
,86436||3507
,86690||3511
,86975||3520
,88137||4121
,88420||4126
,88579||100158
,89630||5578
,89850||4168
,89982||3576
,90271||101166
,91162||100552
,91464||6505
,92851||6541
,93165||7008
,93203||6458
,93394||6540
,93653||5653
,94145||7060
,94293||6553
,94439||6560
,94528||6571
,94552||6564
,94820||6804
,100625||310613
,101370||7011
,101508||7039
,102563||7069
,102628||7025
,103020||3928
,103357||6842
,103772||7081
,103985||100107
,104361||100995
,104426||7044
,104523||6893
,104558||100111
,104639||310634
,104930||7034
,105112||357074
,105350||7026
,105880||100080
,106488||7062
,106623||6865
,106780||100236
,107514||7073
,107654||3905
,107743||7075
,107760||6872
,108057||7076
,108650||6871
,108758||6874
,109118||8461
,109150||101156
,109207||6883
,109789||3910
,110566||3923
,111341||100463
,111449||100071
,111481||6885
,111902||357072
,113921||100095
,115061||4193
,117617||100233
,117927||100214
,117943||100190
,120359||100308
,121088||100445
,121185||100343
,121592||100358
,121797||100413
,122149||101063
,122980||100462
,123021||100643
,123455||100492
,123714||100525
,123790||100557
,124150||100559
,124303||100600
,124370||100581
,124400||100594
,124540||101840
,124885||100688
,124915||101559
,124940||101841
,124982||100630
,125040||100710
,125962||100727
,126373||100754
,126578||100775
,127906||100887
,128430||100922
,128660||101822
,129267||101150
,129542||101356
,130915||101379
,131482||101195
,131725||101221
,131784||101218
,132322||101286
,132357||101284
,132519||101368
,132551||101371
,132683||101332
,133604||101367
,133612||101365
,133990||101436
,134201||101425
,134449||101441
,134619||101691
,134708||101475
,134791||101470
,135453||101820
,135925||101629
,135933||101630
,137421||101665
,138150||101672
,165140||103530
,165638||103378
,205||402044
,15016||298969
,18198||402043
,20044||304142
,20176||304104
,20192||304102
,20206||298998
,20214||352332
,20222||133
,20230||7344
,20249||298913
,20257||3713
,20346||102410
,20516||352241
,20699||7547
,20931||298958
,21121||2265
,21342||3781
,21385||2300
,21466||304112
,21547||298967
,21598||352240
,21660||298982
,21687||352277
,21717||402038
,21733||352324
,21962||304211
,22268||304164
,22306||308589
,22357||101230
,22390||402012
,22403||7342
,22462||352275
,22489||352262
,22519||402052
,22578||352264
,22713||7434
,22748||352210
,22756||352207
,22870||352222
,22896||304216
,23086||1155
,23183||3795
,23205||304203
,23370||352239
,23469||308556
,23493||308512
,23582||2182
,24724||308533
,25828||3724
,27227||308579
,27235||7432
,27286||352347
,27294||304207
,27316||308585
,27340||352256
,27367||308566
,27502||100603
,28070||108
,28355||352259
,28606||352265
,28657||135
,28754||352266
,28894||136
,28932||107
,29262||402050
,29270||7362
,29440||114
,29831||2109
,32255||160
,33081||3759
,33111||138
,33170||7306
,33480||308598
,33855||352305
,34983||154
,35190||294
,35327||7476
,35769||6432
,36145||3835
,36803||182
,36927||188
,37141||2203
,37168||402047
,37664||2240
,38105||100570
,38229||7431
,38482||100580
,39411||2140
,39640||220
,43257||7486
,44091||3824
,44164||2299
,45217||7403
,45225||103065
,45519||6492
,45586||308597
,45705||2151
,45845||352328
,45969||352311
,46019||2218
,46477||2359
,47155||352337
,48062||3814
,48712||265
,49131||2214
,49468||7417
,49751||2313
,52701||3755
,53040||2317
,54062||1162
,54844||2101
,55212||2126
,55662||100963
,56723||1181
,56847||2160
,57940||2144
,58041||2114
,58238||2119
,58327||402034
,59129||2166
,59749||2127
,59790||2333
,59854||2172
,59870||100820
,60259||2128
,60895||2186
,62090||2158
,62731||7549
,64572||1149
,65072||402013
,65099||2329
,65226||3808
,65269||3806
,65285||3807
,66249||3712
,67920||3815
,68420||7330
,69647||2353
,70017||3711
,70556||6438
,70866||402024
,70920||2347
,70998||3844
,71552||3714
,71765||3748
,72460||3729
,72710||3862
,72907||3719
,73458||3861
,73628||2221
,73857||402004
,75639||2231
,75647||2230
,76236||2232
,76600||3727
,77275||7503
,77712||3836
,77801||2241
,77917||2242
,78417||6457
,79138||2250
,79227||402023
,79847||7312
,80047||3865
,80292||2259
,80721||2256
,80969||7490
,80985||100913
,81191||2260
,81280||3837
,81450||100563
,81965||3766
,82651||3838
,83771||2283
,84220||7310
,85103||352279
,86240||7365
,86266||2286
,86541||2274
,86606||3760
,87009||100364
,87386||3788
,87394||3786
,87572||3792
,87750||402033
,87807||7400
,87904||402035
,87980||2285
,88234||402037
,88544||352331
,88684||2295
,88889||2297
,89249||3797
,89826||100592
,90255||352346
,90964||7471
,91758||7401
,91839||6401
,91855||402053
,91880||7346
,92576||7302
,93238||7406
,93343||7304
,93718||7338
,93734||7410
,100021||352334
,100250||6414
,103365||6428
,105732||352342
,106569||7500
,107034||7438
,107379||7439
,108235||6446
,108464||7460
,108960||7456
,110132||7513
,110752||6444
,110787||7464
,110990||7461
,111120||7541
,111538||7472
,111651||7511
,111813||7512
,113328||7523
,113433||7340
,114308||7329
,115231||100703
,115568||7368
,115681||7369
,116327||7532
,116513||7376
,117471||7389
,118869||7391
,119288||6463
,119431||7393
,119474||7331
,120324||6443
,121339||7585
,123250||100554
,123692||100745
,123897||100725
,124273||7592
,125083||100658
,126454||6460
,126896||100806
,127124||7327
,129313||6478
,130087||102414
,130966||101198
,131156||6488
,131423||101199
,134171||101429
,136093||7566
,138355||7576
,138363||7567
,166863||103482
,170178||103708
,86||286866
,94||100133
,124||302379
,400||286854
,515||357033
,1350||314410
,1694||4483
,2291||302332
,2623||5681
,2844||286895
,3069||5417
,3107||100451
,3816||100135
,3921||286802
,3964||302365
,4677||285675
,4740||304346
,4820||366824
,4901||302372
,4979||1718
,5096||5408
,5576||454
,5584||302345
,5746||302390
,6459||4352
,6718||366621
,8168||8447
,9105||8433
,9296||262264
,9644||3565
,9814||9814
,9865||411604
,10057||100931
,10189||4654
,10553||304473
,10871||358455
,10952||304320
,11282||304317
,11452||334076
,11487||3533
,11584||314403
,11940||298816
,12203||302358
,12270||357034
,12491||4633
,12513||335055
,12572||4438
,12777||262202
,12980||286865
,13110||334087
,13137||3235
,13269||380454
,13390||304308
,15261||304494
,15350||100579
,15474||100132
,15539||304318
,16136||100458
,16764||304499
,16861||380446
,17000||304403
,17280||380470
,17388||4680
,17680||3405
,17787||4401
,17884||334045
,18074||384657
,18422||366649
,18490||4529
,18880||6220
,19828||4166
,23850||4314
,24023||8442
,24120||3569
,24678||380499
,24813||103156
,25267||380468
,25283||380467
,25399||100134
,25801||380431
,26123||366898
,26441||3602
,26654||366802
,26760||6257
,27057||100853
,27219||100353
,27448||466
,28576||3573
,28630||366836
,28681||366843
,30686||5402
,30716||366808
,30821||358447
,30830||813
,30880||341345
,30910||6285
,30996||366825
,31046||380460
,31119||384664
,31526||5442
,31569||3503
,31860||304313
,31992||4595
,32018||358453
,32867||366654
,33685||358483
,33910||100367
,34304||358458
,35165||307
,36315||101180
,36781||5418
,37249||365669
,38148||837
,38776||358480
,38890||6295
,41548||341473
,42994||101047
,46531||5671
,46841||6256
,47180||1108
,47856||5692
,48119||482
,48569||882
,48801||881
,48860||48860
,49140||4379
,49565||5666
,49611||4658
,52221||4579
,54437||4342
,54500||1115
,54828||900
,55417||102548
,56839||8475
,57029||100771
,57614||1730
,57975||3209
,59706||5401
,59994||924
,60020||925
,61026||3654
,61190||100766
,61298||960
,61530||3401
,62324||100759
,63835||941
,64076||4114
,64521||3547
,64912||3408
,65536||3291
,66621||425
,68012||4205
,69779||3539
,70190||3659
,70220||4498
,71102||4101
,71250||4151
,71498||5551
,72508||6544
,72877||357002
,73733||402011
,74110||4351
,74578||411699
,74667||384667
,75019||6255
,75043||470
,75051||304314
,75396||5301
,75400||4623
,75434||3683
,75442||5302
,76058||102537
,77135||384674
,77151||357001
,77682||5678
,77992||3687
,78140||5434
,78522||4405
,78727||8436
,78794||5465
,78883||4430
);


CURSOR c2 IS 
SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
FROM craplim a
WHERE a.cdcooper =14
AND a.tpctrlim =1
AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
 78948||4432
,79022||5447
,79146||5470
,79391||4464
,79812||5424
,79960||5407
,80519||5427
,80543||298809
,80802||6250
,80810||5449
,80829||5448
,80900||3233
,81140||100758
,81299||5450
,81400||3254
,81574||5409
,81701||4355
,81710||5457
,81841||5436
,81850||5454
,81892||5453
,82210||5411
,82350||100303
,82562||5416
,82678||4331
,82732||5471
,82759||5542
,83348||5529
,83356||5522
,83518||5437
,83720||5525
,83798||5539
,83810||4508
,83852||4507
,83933||5533
,83941||6854
,84123||100187
,84603||5601
,84670||4540
,85073||8467
,85162||5550
,85200||5523
,85375||4569
,85456||8441
,85588||5634
,85600||5626
,85642||5439
,85650||5440
,85758||5438
,85766||4598
,85782||100635
,86193||304309
,86487||5553
,86533||3509
,86657||304322
,86959||5609
,87262||5502
,87300||5559
,87467||3532
,87610||5560
,87645||100852
,87777||5573
,88498||5567
,88773||5645
,88790||5443
,88854||5572
,88870||5444
,89451||6207
,89508||5579
,89664||100958
,89699||5577
,89818||5580
,89923||5582
,90468||100751
,90620||5663
,90646||5646
,90727||100724
,90760||5510
,90972||6219
,90980||5649
,91090||5664
,91324||6504
,91650||6226
,91910||6224
,92517||6243
,92690||8491
,92754||6228
,92908||5672
,93122||6238
,93661||6242
,93815||6249
,93980||6204
,94153||8468
,94358||6206
,94650||100354
,94668||304311
,100030||6830
,100277||6265
,100331||9272
,100781||5669
,101060||5670
,101400||100527
,101869||5674
,101907||8401
,102199||100764
,102474||6277
,103764||100146
,104469||8445
,104817||6858
,104990||5691
,105678||8413
,105961||6857
,107166||298804
,107409||100344
,107468||8480
,108278||298897
,108740||8426
,108936||298805
,109312||8432
,109398||100122
,109983||8440
,111244||8448
,112020||6294
,112127||100715
,112569||6896
,112631||8470
,112755||102890
,112852||8451
,113115||8482
,113875||8455
,113905||6299
,113972||100138
,114243||8478
,114448||8459
,115401||8486
,115436||100315
,116750||100172
,116939||100139
,117293||100121
,117714||100151
,118028||100867
,118168||100165
,118311||100147
,118885||100534
,119016||100197
,119873||100465
,120057||100341
,120715||100328
,120928||100345
,120936||100409
,120995||100340
,121223||100351
,121452||100378
,121541||100359
,121827||100373
,121878||100384
,123080||100692
,123188||100638
,123722||100536
,124419||100636
,125717||100704
,125849||100772
,126152||100747
,126209||100749
,126772||100799
,127221||100927
,127426||100896
,127515||101089
,127787||100878
,128120||100900
,128139||100908
,128600||100934
,128821||100970
,128910||100969
,128996||101032
,129062||101006
,129089||100997
,129550||101480
,132810||101294
,134945||101476
,137103||101575
,137731||101618
,138720||101693
,139653||101791
,149284||102505
,149837||102551
,152005||102734
,152374||102807
,155217||102765
,159042||103074
,161241||103702
,167940||103612
,168424||103601
,169315||103671
,90816||7637
,100595||7624
,101788||101765
,102300||7635
,103101||102731
,103179||7645
,105368||7660
,106046||7678
,106470||7695
,108189||102715
,110744||7694
,112003||7699
,116920||100098
,117390||100102
,119571||100646
,119644||100271
,122599||100476
,123943||102971
,129011||100979
,139360||103722
,144541||103588
,1015||302311
,1767||334078
,2089||286817
,2100||7059
,2682||1874
,2917||357068
,3549||4177
,3697||358440
,3735||286842
,4154||100446
,4332||100726
,4391||302391
,4561||310616
,4766||7070
,5037||314304
,5428||280730
,5886||827
,5991||435
,6041||310625
,6637||100112
,6815||3651
,9075||286995
,9202||101714
,9458||4341
,9849||3237
,10600||527
,10634||290300
,10782||3636
,12807||358482
,12815||5263
,15172||4138
,15300||7065
,16071||3515
,16284||4672
,16292||7012
,16373||304485
,16705||1888
,17086||341373
,17124||335032
,17876||310642
,18520||310621
,19178||4437
,19518||310633
,19690||1876
,24619||366678
,24783||380494
,24791||380493
,24899||1754
,26751||440
,27545||100110
,27596||3930
,27928||3537
,28088||380407
,28223||3205
,29890||6841
,30457||888
,30465||3277
,30481||3262
,31178||100334
,31232||823
,31640||4310
,31720||1114
,33197||744
,33200||1118
,33790||1793
,34924||801
,35203||358494
,36587||4133
,36625||765
,36811||411621
,39616||384696
,39705||4465
,42129||365647
,42668||3655
,42919||4460
,44601||4636
,45012||1818
,45802||1835
,46280||855
,47538||411631
,53627||3545
,54453||3529
,55360||100672
,55859||103590
,56030||1768
,57304||6577
,57576||100262
,57924||1751
,58572||357038
,62014||4559
,62642||357073
,62685||3293
,62723||100871
,63193||3252
,63614||942
,63878||3268
,64548||357079
,64939||3510
,65552||6861
,66958||3638
,68268||4397
,69531||4518
,70211||3843
,70360||4340
,70955||3932
,71285||4425
,71323||310626
,71390||6258
,73369||358499
,73814||7085
,74233||4586
,74659||457
,74675||458
,75299||7061
,75507||365694
,75744||4605
,75876||3672
,75892||4584
,76260||101384
,76333||4429
,76686||4643
,77089||4660
,77623||4696
,78670||4497
,78832||4426
,79111||100553
,80098||4492
,81493||3501
,81779||5451
,83313||6897
,83992||6579
,86428||3505
,86444||5555
,87939||7042
,88242||4119
,89770||3584
,90719||3590
,92398||102536
,92444||6227
,93084||100956
,93785||6832
,93866||7007
,94471||6847
,94633||6567
,94919||8481
,100790||6229
,101524||7010
,108081||6868
,108103||7077
,109290||8460
,109592||3916
,110493||101203
,111708||6888
,114898||4192
,115240||4194
,115584||100048
,116262||100229
,116360||100049
,116386||100162
,117188||100073
,119180||100304
,119253||100228
,121312||100455
,121363||100350
,121673||100443
,122289||100454
,123307||100508
,123781||100809
,123820||100523
,125679||100697
,125806||100709
,125903||100717
,126780||100800
,126942||100805
,127043||100818
,127418||100901
,129585||101036
,129631||101048
,130710||101133
,130826||101214
,131326||101243
,132543||101277
,132632||101309
,132969||101317
,132977||101315
,135283||101492
,142034||101977
,142964||102049
,143065||102054
,143383||102067
,143537||102085
,144177||102109
,145645||102200
,147400||102318
,148520||102417
,149020||102480
,149101||102487
,152196||102676
,168661||103672
,169200||103670
,20028||352321
,20060||352276
,20397||352214
,20451||352340
,20575||352333
,20770||352218
,20796||352233
,20826||304133
,20850||304135
,20907||304163
,21105||304144
,21180||304157
,21237||123
,21253||304179
,21296||7489
,21458||2289
,21563||298971
,21741||101025
,21814||3839
,21881||308518
,21946||304136
,21954||304184
,21989||3756
,22004||304131
,22039||2322
,22144||304197
,22195||150
,22217||7427
,22381||155
,22446||304200
,22500||352344
,22551||2187
,22624||6421
,22640||402028
,22667||308538
,22691||3702
,22780||401901
,23108||101345
,23256||2266
,23345||352235
,23353||308508
,23361||352237
,23418||1192
,23434||308505
,23558||7347
,24066||3750
,24228||352242
,24457||2142
,24520||352247
,24600||100670
,24910||308542
,25607||7528
,25674||304217
,26000||352257
,26662||308554
,27081||7377
,27138||2358
,27146||300
,27405||3804
,27472||304201
,27626||3752
,28363||352258
,28916||7371
,28940||2198
,28983||109
,29157||7530
,32115||352338
,32603||100369
,33014||130
,34215||2239
,35220||101079
,35688||7502
,35700||166
,35718||7328
,36218||2357
,36226||402039
,36668||308572
,36854||2288
,36897||2104
,37036||190
,37087||1153
,37117||7303
,38318||214
,38709||236
,39233||7404
,39810||352343
,42544||225
,43737||3842
,44512||2318
,45853||7462
,45888||2228
,45896||2196
,47104||7332
,47627||6415
,48658||263
,48976||2135
,52698||2163
,52795||2103
,53201||1175
,53449||3841
,53570||3725
,53902||1179
,54313||2217
,54410||2366
,55450||2268
,56049||2302
,56898||100578
,57754||2137
,57894||100716
,58254||2152
,58459||2159
,58939||2180
,58947||2179
,59269||2167
,59382||2296
,60062||2201
,60747||7504
,60844||7364
,60860||1186
,60879||1145
,60909||1185
,61743||2192
,62367||2195
,63851||2319
,65544||5547
,65781||352273
,66508||7454
,67237||352322
,67644||7599
,67741||402003
,67814||2335
,68195||3840
,69035||7361
,69574||3825
,69671||3818
,70068||7479
,70084||2244
,70157||2364
,71579||2222
,71587||3828
,71641||100829
,72443||3848
,73580||2220
,74985||3863
,75108||3864
,75809||7317
,76783||2368
,76880||7387
,76899||2235
,77658||7318
,77828||8372
,78220||2375
,79049||100919
,79839||3732
,79901||7448
,80055||3866
,80349||2384
,80357||2385
,80764||2257
,81833||7458
,83089||7311
,85006||352278
,85120||3749
,86665||3777
,87335||3783
,87351||3785
,87670||2292
,87700||2281
,88455||2287
,89877||3799
,90182||1157
,90557||101606
,90590||7353
,90611||1156
,91618||352330
,93041||6408
,93602||6409
,94226||6412
,94870||6413
,100269||7326
,100340||100535
,100374||352339
,100692||7415
,100935||7322
,100986||7309
,100994||7395
,103594||7313
,105872||7497
,105970||7435
,106097||6434
,106100||7481
,106496||7348
,106909||7477
,108448||6436
,108561||6435
,109347||7455
,109843||100623
,109878||7518
,110540||7510
,110825||6440
,111287||6464
,111716||101207
,113263||102784
,114170||7341
,114375||7358
,116211||7367
,116335||100846
,116408||6498
,119091||7397
,119393||6450
,119539||7550
,119660||7516
,120090||7583
,120677||100583
,121134||7553
,121932||7588
,125768||100702
,125911||100721
,125920||6462
,126950||7380
,127485||7398
,127582||7379
,128309||7388
,129020||6467
,130699||6482
,138622||7573
,141992||101966
,142913||102043
,155438||103453
,165301||103414
,168491||103621
,168823||103664
,169420||103685
,2577||334034
,7056||365633
,7242||286743
,7250||280137
,7323||341411
,7471||366503
,7749||286756
,7820||329
,8079||314346
,8362||341431
,8494||1216
,8524||341458
,8788||314333
,13277||335098
,14010||341446
,14150||350
,14222||341439
,14346||314387
,14559||341445
,14826||314328
,15008||314342
,16250||4911
,25224||1732
,28835||1800
,34037||302
,34193||4811
,34991||4807
,37842||521
,38156||517
,38245||546
,40436||314329
,40614||367
,40800||4718
,40967||356920
,41190||365606
,41220||1202
,41700||103110
,41920||365652
,41998||508
,42196||365640
,42226||6010
,42420||4741
,42447||100280
,46388||100068
,47830||6059
,48283||318
,49018||590
,49921||4724
,54194||100129
,54267||1270
,54321||100402
,55077||6048
,55387||6014
,55409||349
,55778||366501
,55891||1227
,56367||6029
,57703||6037
,59960||571
,61077||569
,61131||6021
,61778||100998
,63290||4739
,64467||1204
,65277||6016
,65412||1277
,65692||383
,66524||1215
,67199||581
,68829||4852
,69663||4717
,69825||595
,69850||100959
,70181||372
,70750||4753
,71030||1252
,71218||4725
,71757||6020
,72346||4738
,73210||366513
,74616||4769
,74624||7210
,76082||6011
,77321||6087
,78395||378
,79855||7238
,80403||5429
,81213||3245
,81620||371
,83305||385
,85057||4948
,85634||4813
,85928||6060
,86460||4762
,86843||6024
,87521||100125
,89184||6068
,89346||6081
,90484||6100
,92126||6077
,93599||6085
,100145||4810
,101109||7005
,101281||7202
,103748||4830
,104086||100075
,104779||4857
,104876||7201
,106941||4859
,107549||6006
,108014||6009
,110671||356921
,110850||6022
,113123||100217
,113158||100780
,118052||100150
,118397||100148
,118613||100876
,118672||100246
,118699||100247
,120170||100414
,120600||6064
,121428||6061
,121959||6071
,122548||6078
,125601||6097
,125644||6098
,128740||7221
,128759||7222
,128953||7228
,129208||7231
,134252||4916
,135267||4920
,136220||7249
,144266||7267
,167800||103531
,167827||103691
,256||334111
,2780||1387
,14419||3
,18007||358346
,22829||224
,23698||1965
,23914||358364
,24171||2062
,24872||358352
,25046||101615
,25925||358363
,25950||2815
,26239||1907
,26301||1411
,26646||384701
,26700||2027
,26727||2816
,27561||358383
,28134||60
,28460||424004
,28924||384804
,29564||6
,29700||5
,29840||1383
,33120||2896
,34665||2081
,34827||21
,35653||394425
,36129||2857
,36293||8310
,36307||48
,36331||8333
,36943||43
,36951||1320
,36960||1460
,37478||5235
,38083||2003
,38490||358390
,38768||1902
,39250||92
,39470||392201
,43400||2770
,43567||10005
,44415||1784
,44768||1972
,44857||8396
,44890||2014
,45349||5295
,45446||1908
,45780||8225
,46051||2066
,46655||2646
,46698||424028
,47040||5236
,47228||2028
,48747||1971
,48755||2762
,48852||2032
,49514||5120
,50016||100968
,50024||334148
,50091||334150
,50113||8305
,50130||334105
,50148||334158
,50156||334106
,50164||100253
,50199||10001
,50326||70
,50350||334116
,50466||394402
,50610||334124
,50628||334142
,50636||8242
,50776||3004
,50849||394428
,50989||334154
,51004||100302
,51160||358385
,51357||356805
,51381||394432
,51462||356822
,51551||358302
,51578||820
,51632||334190
,51705||384713
,51756||334144
,51810||5205
,51829||5104
,51837||358314
,51896||384803
,51926||358317
,51934||1326
,51977||424014
,52000||358333
,52175||8323
,52361||8239
,52825||1347
,53147||6338
,53163||394434
,53210||1397
,53228||2049
,53244||1428
,53392||100116
,53520||8324
,53538||2625
,53597||2937
,53619||2061
,53651||8217
,54070||2071
,54305||1488
,55190||1974
,55263||424007
,55425||2859
,55743||1975
,55824||8303
,56090||2618
,56103||2743
,56170||1956
,56308||1984
,56464||8326
,56472||8400
,57282||1363
,57320||1489
,57509||2082
,57908||5082
,58076||2093
,58378||1410
,58483||2841
,58580||8237
,58742||2000
,58750||1415
,59188||2818
,59196||2817
,60038||1372
,60208||1449
,60275||8342
,60658||1455
,60887||2869
,61034||8376
,61042||1457
,61450||1374
,61514||2644
,61603||2858
,61948||8320
,62170||1477
,62332||1466
,62545||1467
,62774||1420
,62987||2750
,63029||2740
,63037||1435
,63568||424024
,63746||1398
,63754||8362
,63789||1426
,63800||1427
,64009||1487
,64050||2721
,64238||2730
,64475||2843
,64602||1434
,66451||2653
,67377||2809
,68020||8319
,68390||2806
,68519||8248
,68942||1334
,69698||424017
,69817||9703
,70041||2748
,70289||394430
,70440||2855
,70505||2722
,70777||5075
,70874||1388
,71048||2834
,71196||8312
,71447||2710
,71463||2704
,71633||2705
,72001||1400
,72648||101094
,72664||2874
,73229||2880
,73237||2614
,73350||2719
,73563||101095
,74683||2769
,74810||5207
,74950||2866
,74977||2713
,75370||5224
,75612||2741
,75825||2652
,75850||8371
,75930||384806
,76376||5041
,76716||5215
,76740||5005
,76759||5020
,76864||5219
,77593||5229
,78450||2723
,78638||424009
,78751||5240
,78824||5245
,79235||5027
,79553||2933
,79677||5294
,79685||5034
,80063||100662
,80390||2757
,80799||100490
,81043||394426);

CURSOR c3 IS 
SELECT a.cdcooper, a.nrdconta, a.nrctrlim, a.tpctrlim, a.dtpropos, a.dtfimvig, a.insitlim
FROM craplim a
WHERE a.cdcooper =14
AND a.tpctrlim =1
AND a.nrdconta||a.nrctrlim IN (--conta||Contrato
 81230||9710
,81396||2752
,81914||2942
,82600||2765
,82619||5262
,82694||5073
,82929||8238
,83054||2654
,83216||2768
,83666||100909
,83755||5079
,84263||424012
,84506||2895
,84662||5084
,84840||100937
,85146||101311
,85154||100292
,85308||100035
,85626||5090
,85790||8328
,86355||8229
,87025||2627
,87076||100479
,87173||2639
,87378||2642
,87530||2907
,87602||100410
,87882||2796
,87920||394431
,88196||2641
,88315||8218
,88366||2648
,88978||2782
,89028||2780
,90417||2786
,91103||8203
,91634||2789
,92223||8204
,92584||8317
,93297||8309
,94676||8230
,94730||8380
,94846||8210
,100439||8338
,100900||394429
,101192||8337
,102032||8334
,102113||8331
,102172||101086
,103241||8339
,103284||2910
,103519||8363
,103977||8227
,105007||8240
,105147||2917
,105520||8241
,105597||8384
,105694||8340
,105783||424019
,105902||8361
,106585||100470
,106593||100683
,106925||8347
,107450||8354
,107492||100498
,107638||8390
,107735||8356
,108120||8395
,108588||2667
,108782||100804
,108812||10002
,108952||2921
,108987||10004
,109479||8367
,109738||100480
,110574||8399
,110680||2665
,110922||8378
,111694||100045
,111767||2928
,111929||2929
,111961||9615
,111988||2931
,112402||8382
,112623||100571
,112780||100265
,112828||2925
,112933||2932
,113468||9605
,113727||9709
,114030||100079
,114839||2940
,115738||9613
,115860||100084
,116190||100058
,116599||9712
,117013||9716
,117609||100113
,117757||100159
,118222||100161
,118630||100154
,118648||100167
,119172||100611
,119814||100237
,119903||100249
,120073||100285
,120138||100269
,120219||100268
,120472||100295
,120731||101011
,121002||100440
,121193||100346
,121240||100456
,121738||100565
,122394||100491
,122424||100575
,122475||100435
,123161||100473
,123358||100489
,124362||100591
,124591||100604
,124621||100674
,124680||101288
,124737||100665
,124800||100656
,125016||100634
,125059||100653
,125377||100679
,125687||100722
,125733||100738
,127167||100880
,127540||100855
,128163||100907
,128589||100930
,128775||100967
,128830||100972
,128880||101007
,132179||101261
,135070||101489
,139750||101788
,141020||103521
,167843||103576
,168254||103581
,168343||103658
,168564||103667
,168998||103696
,111880||102434
,111996||9205
,112186||9203
,112240||9208
,112372||9211
,112577||9210
,113336||9227
,113352||9212
,113441||100714
,113476||100860
,113484||9218
,113654||9252
,113948||9219
,114090||103153
,114600||100761
,115339||9233
,115487||100519
,116041||9247
,116343||100816
,116491||9251
,116866||9259
,117196||100192
,117510||100194
,117552||100711
,117560||100509
,117722||100127
,117978||100128
,117986||100266
,118079||100157
,118095||100166
,118524||100457
,118540||100198
,118559||100348
,118770||100174
,118796||100195
,119156||100213
,119199||100222
,119318||100256
,120146||100296
,120235||100284
,120243||102642
,120294||100297
,120391||100897
,120430||100288
,120561||100316
,120618||100339
,120871||100323
,121029||100439
,121347||100434
,121479||100437
,121487||100429
,121630||100362
,121665||100442
,121681||100424
,122068||100423
,122084||100431
,122130||100398
,122386||100430
,123048||100487
,123218||100518
,123269||100503
,123277||100502
,123480||100505
,123668||100512
,123889||100620
,123900||100544
,123951||100612
,123960||100545
,124036||100622
,124168||100619
,124443||100584
,124559||100596
,124575||100640
,124583||100621
,124664||100641
,124850||100632
,124893||100647
,124931||100633
,124958||100639
,125164||100686
,125180||100668
,125520||100698
,125636||100699
,126020||100776
,126047||100750
,126357||100844
,126543||100788
,126667||100798
,127337||100848
,127345||100903
,127434||100885
,127680||100904
,127809||100895
,127981||100884
,131180||101167
,133639||101409
,133825||101391
,134180||101454
,134953||101497
,137006||101574
,138681||101683
,139734||101784
,142638||102000
,145823||102210
,148709||103403
,149462||102566
,157295||102832
,161128||103109
,161152||103111
,167983||103571
,168262||103713
,168530||103646
,168696||103624
,168742||103648
,169463||103694
,169625||103692
,112135||9206
,112399||9209
,149039||102482
,157430||102834
,161926||103169
,168165||103608
,168238||103625
,168700||103631
,168815||103677
,36900||6050
,88463||5902
);


  -- Local variables here
  PROCEDURE pc_renovar_limite_cred_manual(pr_cdcooper IN crapcop.cdcooper%TYPE  --> Código da Cooperativa
                                         ,pr_cdoperad IN crapope.cdoperad%TYPE  --> Código do Operador
                                         ,pr_nmdatela IN craptel.nmdatela%TYPE  --> Nome da Tela
                                         ,pr_idorigem IN INTEGER                --> Identificador de Origem =5--aimaro
                                         ,pr_nrdconta IN crapass.nrdconta%TYPE  --> Número da Conta
                                         ,pr_dtmvtolt IN crapdat.dtmvtolt%TYPE  --> Data de Movimento
                                         ,pr_nrctrlim IN craplim.nrctrlim%TYPE  --> Contrato
                                         ,pr_cdcritic OUT PLS_INTEGER           --> Código da crítica
                                         ,pr_dscritic OUT VARCHAR2) IS         --> Descrição da crítica
  BEGIN

  DECLARE
    -- Variável de críticas
    vr_cdcritic crapcri.cdcritic%TYPE;
    vr_dscritic crapcri.dscritic%TYPE;

    -- Variaveis de Log de Alteracao
    vr_flgctitg crapalt.flgctitg%TYPE;
    vr_dsaltera LONG;

    vr_retorno     BOOLEAN DEFAULT(FALSE);
    vr_xml      xmltype;
  
    vr_nrdrowid   rowid;
  
    -- Tratamento de erros
    vr_exc_saida EXCEPTION;

    -- Parametro de Flag Rating Renovacao Ativo: 0-Não Ativo, 1-Ativo
    vr_flg_Rating_Renovacao_Ativo    NUMBER := 0;

    -- Cursor Limite de cheque especial
    CURSOR cr_craplim(pr_cdcooper IN craplim.cdcooper%TYPE     --> Código da Cooperativa
                     ,pr_nrdconta IN craplim.nrdconta%TYPE     --> Número da Conta
                     ,pr_nrctrlim IN craplim.nrctrlim%TYPE) IS --> Número do Contrato

      SELECT craplim.cddlinha,
             craplim.insitlim,
             craplim.qtrenova,
             craplim.dtrenova,
             craplim.vllimite,
             nvl(craplim.dtfimvig, craplim.dtinivig + craplim.qtdiavig) as dtfimvig,
          ---        
             craplim.tprenova,
             craplim.dsnrenov,
             craplim.dtfimvig dtfimvig_rollback,
             craplim.cdoperad ,
             craplim.cdopelib 
                          
        FROM craplim
       WHERE craplim.cdcooper = pr_cdcooper
         AND craplim.nrdconta = pr_nrdconta
         AND craplim.nrctrlim = pr_nrctrlim
         AND craplim.tpctrlim = 1
         AND craplim.insitlim = 2;-- ativa.
    rw_craplim cr_craplim%ROWTYPE;

    -- Cursor Linhas de Credito Rotativo
    CURSOR cr_craplrt (pr_cdcooper IN craplrt.cdcooper%TYPE,
                       pr_cddlinha IN craplrt.cddlinha%TYPE) IS
      SELECT craplrt.flgstlcr
        FROM craplrt
       WHERE craplrt.cdcooper = pr_cdcooper AND
             craplrt.cddlinha = pr_cddlinha;
    rw_craplrt cr_craplrt%ROWTYPE;

    -- Cursor Regras do limite de cheque especial
    CURSOR cr_craprli (pr_cdcooper IN craprli.cdcooper%TYPE,
                       pr_inpessoa IN craprli.inpessoa%TYPE) IS
      SELECT qtmaxren
        FROM craprli
       WHERE craprli.cdcooper = pr_cdcooper AND
             craprli.inpessoa = DECODE(pr_inpessoa,3,2,pr_inpessoa)
             AND craprli.tplimite = 1; -- Limite Credito
    rw_craprli cr_craprli%ROWTYPE;

    -- Cursor Associado
    CURSOR cr_crapass (pr_cdcooper IN crapass.cdcooper%TYPE,
                       pr_nrdconta IN crapass.nrdconta%TYPE) IS
      SELECT inpessoa,
             nrdctitg,
             flgctitg,
             nrcpfcnpj_base,
             cdagenci
        FROM crapass
       WHERE crapass.cdcooper = pr_cdcooper AND
             crapass.nrdconta = pr_nrdconta;
    rw_crapass cr_crapass%ROWTYPE;

    -- Cursor alteracao de cadastro
    CURSOR cr_crapalt (pr_cdcooper IN crapcop.cdcooper%TYPE
                      ,pr_nrdconta IN crapass.nrdconta%TYPE
                      ,pr_dtmvtolt IN crapdat.dtmvtolt%TYPE) IS
      SELECT crapalt.dsaltera,
             crapalt.rowid,
             crapalt.cdoperad,
             crapalt.flgctitg
        FROM crapalt
       WHERE crapalt.cdcooper = pr_cdcooper
         AND crapalt.nrdconta = pr_nrdconta
         AND crapalt.dtaltera = pr_dtmvtolt;
    rw_crapalt cr_crapalt%ROWTYPE;


    CURSOR cr_tbrisco_operacoes(pr_cdcooper IN craplim.cdcooper%TYPE     --> Código da Cooperativa
                     ,pr_nrdconta IN craplim.nrdconta%TYPE     --> Número da Conta
                     ,pr_nrctrlim IN craplim.nrctrlim%TYPE) IS --> Número do Contrato
    SELECT 1 FROM tbrisco_operacoes o
                 WHERE o.cdcooper = pr_cdcooper
                   AND o.nrdconta = pr_nrdconta
                   AND o.nrctremp = pr_nrctrlim
                   AND o.tpctrato = 1
                   AND o.flintegrar_sas = 1;--- já marcado para atualizar
    rw_tbrisco_operacoes cr_tbrisco_operacoes%ROWTYPE;

    vr_in_risco_rat INTEGER;
    vr_habrat VARCHAR2(1) := 'N'; -- P450 - Paramentro para Habilitar Novo Ratin (S/N)

    -- P450 Valida Endividamento
    vr_strating     NUMBER;
    vr_flgrating    NUMBER;
    vr_vlendivid    craplim.vllimite%TYPE; -- Valor do Endividamento do Cooperado
    vr_vllimrating  craplim.vllimite%TYPE; -- Valor do Parametro Rating (Limite) TAB056
    -- P450 Valida Endividamento

    -- Informações de data do sistema
    rw_crapdat      btch0001.rw_crapdat%TYPE;
    vr_innivris     NUMBER;


  BEGIN

    --> Buscar Parametro
    vr_flg_Rating_Renovacao_Ativo := gene0001.fn_param_sistema(pr_nmsistem => 'CRED'
                                                              ,pr_cdcooper => 0
                                                              ,pr_cdacesso => 'RATING_RENOVACAO_ATIVO');

    vr_habrat := gene0001.fn_param_sistema(pr_nmsistem => 'CRED',
                                           pr_cdcooper => pr_cdcooper,
                                           pr_cdacesso => 'HABILITA_RATING_NOVO');

    -- Consultar o limite de credito
    OPEN cr_craplim(pr_cdcooper => pr_cdcooper,
                    pr_nrdconta => pr_nrdconta,
                    pr_nrctrlim => pr_nrctrlim);
    FETCH cr_craplim INTO rw_craplim;
    -- Verifica se o limite de credito existe
    IF cr_craplim%NOTFOUND THEN
      CLOSE cr_craplim;
      vr_dscritic := 'Associado nao possui proposta de limite de credito Ativa. ';
      RAISE vr_exc_saida;
    ELSE
      CLOSE cr_craplim;
    END IF;

    -- Verifica se a data esta cadastrada
    OPEN BTCH0001.cr_crapdat(pr_cdcooper => pr_cdcooper);
    FETCH BTCH0001.cr_crapdat INTO rw_crapdat;

    -- Se não encontrar
    IF BTCH0001.cr_crapdat%NOTFOUND THEN
      -- Fechar o cursor pois haverá raise
      CLOSE BTCH0001.cr_crapdat;
      -- Montar mensagem de critica
      vr_dscritic := gene0001.fn_busca_critica(pr_cdcritic => 1);
      RAISE vr_exc_saida;
    ELSE
      -- Apenas fechar o cursor
      CLOSE BTCH0001.cr_crapdat;
    END IF;

    -- Verifica a situacao do limite do cheque especial
    IF nvl(rw_craplim.insitlim,0) <> 2 THEN
      vr_dscritic := 'O contrato de limite de credito deve estar ativo.';
      RAISE vr_exc_saida;
    END IF;

    -- Verificacao para saber se jah passou o vencimento do limite para a renovacao
    IF rw_craplim.dtfimvig > pr_dtmvtolt THEN
      vr_dscritic := 'Nao e possivel realizar a renovacao do limite. Contrato nao esta vencido.';
      RAISE vr_exc_saida;
    END IF;

    -- Consulta o limite de credito
    OPEN cr_craplrt(pr_cdcooper => pr_cdcooper,
                    pr_cddlinha => rw_craplim.cddlinha);
    FETCH cr_craplrt INTO rw_craplrt;
    -- Verifica se o limite de credito existe
    IF cr_craplrt%NOTFOUND THEN
      CLOSE cr_craplrt;
      vr_dscritic := 'Linha de Credito nao cadastrada. Linha: ' || rw_craplim.cddlinha;
      RAISE vr_exc_saida;
    ELSE
      CLOSE cr_craplrt;
    END IF;


  --- Não validar
 /*   -- Verifica a situacao do limite do credito
    IF nvl(rw_craplrt.flgstlcr,0) = 0 THEN
      vr_dscritic := 'Linha de credito bloqueada. Nao e possivel efetuar a renovacao. E necessario incluir um novo limite. ' || rw_craplim.cddlinha;
      RAISE vr_exc_saida;
    END IF;*/


    -- Consulta o Associado
    OPEN cr_crapass(pr_cdcooper => pr_cdcooper,
                    pr_nrdconta => pr_nrdconta);
    FETCH cr_crapass INTO rw_crapass;
    -- Verifica se o limite de credito existe
    IF cr_crapass%NOTFOUND THEN
      CLOSE cr_crapass;
      vr_dscritic := 'Associado nao cadastrado. Conta: ' || pr_nrdconta;
      RAISE vr_exc_saida;
    ELSE
      CLOSE cr_crapass;
    END IF;

    -- Consulta a regra do limite de cheque especial
    OPEN cr_craprli(pr_cdcooper => pr_cdcooper,
                    pr_inpessoa => rw_crapass.inpessoa);
    FETCH cr_craprli INTO rw_craprli;
    -- Verifica se o limite de credito existe
    IF cr_craprli%NOTFOUND THEN
      CLOSE cr_craprli;
      vr_dscritic := 'Regras do Linha de Credito nao cadastrada.';
      RAISE vr_exc_saida;
    ELSE
      CLOSE cr_craprli;
    END IF;

/* Não validar
    -- Verificar a quantidade maxima que pode renovar
    IF ((nvl(rw_craprli.qtmaxren,0) > 0) AND (nvl(rw_craplim.qtrenova,0) >= nvl(rw_craprli.qtmaxren,0))) THEN
      vr_dscritic := 'Nao e possivel realizar a renovacao do limite. Incluir novo contrato';
      RAISE vr_exc_saida;
    END IF;
*/

    -- P450 SPT13 - alteracao para habilitar rating novo
    IF (pr_cdcooper <> 3 AND vr_habrat = 'S') THEN

      -- Verifica processamento do Rating Renovacao
      IF vr_flg_Rating_Renovacao_Ativo = 1 THEN
    /*    rati0003.pc_solicitar_rating_motor( pr_cdcooper => pr_cdcooper,
                                            pr_nrdconta => pr_nrdconta,
                                            pr_tpctrato => 1, -- Limite Credito
                                            pr_nrctrato => pr_nrctrlim,
                                            pr_cdoperad => pr_cdoperad,
                                            pr_cdagenci => rw_crapass.cdagenci,
                                            pr_dtmvtolt => pr_dtmvtolt,
                                            pr_inpessoa => rw_crapass.inpessoa,
                                            pr_cdcritic => vr_cdcritic,
                                            pr_dscritic => vr_dscritic);

        IF TRIM(vr_dscritic) IS NOT NULL OR nvl(vr_cdcritic,0) > 0 THEN
          RAISE vr_exc_saida;
        END IF;*/

        -- Validar Status rating
        RATI0003.pc_busca_status_rating(pr_cdcooper  => pr_cdcooper
                                       ,pr_nrdconta  => pr_nrdconta
                                       ,pr_tpctrato  => 1 -- Limite Credito
                                       ,pr_nrctrato  => pr_nrctrlim
                                       ,pr_strating  => vr_strating
                                       ,pr_flgrating => vr_flgrating
                                       ,pr_cdcritic  => vr_cdcritic
                                       ,pr_dscritic  => vr_dscritic);

        IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
          
           IF substr(vr_dscritic,1,47) = 'Contrato nao pode ser efetivado, Rating vencido' THEN

              -- verificar se já está marcado para atualizar o rating a noite via lote, se já está não precisa fazer novamente.
              OPEN cr_tbrisco_operacoes(pr_cdcooper => pr_cdcooper,
                              pr_nrdconta => pr_nrdconta,
                              pr_nrctrlim => pr_nrctrlim);
              FETCH cr_tbrisco_operacoes INTO rw_tbrisco_operacoes;
              IF cr_tbrisco_operacoes%NOTFOUND THEN

                BEGIN 
                  UPDATE tbrisco_operacoes o
                     SET o.flintegrar_sas = 1
                   WHERE o.cdcooper = pr_cdcooper
                     AND o.nrdconta = pr_nrdconta
                     AND o.nrctremp = pr_nrctrlim
                     AND o.tpctrato = 1;
                EXCEPTION
                  WHEN OTHERS THEN
                  vr_dscritic := 'Erro atualizar tabela tbrisco_operacoes, para rating vencido '||SQLERRM;
                  RAISE vr_exc_saida;
                END;         
  --tbrating_historicos
                vr_retorno := rati0003.fn_registra_historico(pr_cdcooper             => pr_cdcooper
                                                            ,pr_cdoperad             => pr_cdoperad
                                                            ,pr_nrdconta             => pr_nrdconta
                                                            ,pr_nrctro               => pr_nrctrlim
                                                            ,pr_dtmvtolt             => NULL
                                                            ,pr_valor                => 0
                                                            ,pr_tpctrato             => 1
                                                            ,pr_rating_sugerido      => NULL
                                                            ,pr_justificativa        => 'Renovacao Limite de credito em massa1'
                                                            ,pr_inrisco_rating       => NULL
                                                            ,pr_dtrisco_rating       => NULL
                                                            ,pr_inrisco_rating_autom => NULL
                                                            ,pr_dtrisco_rating_autom => NULL
                                                            ,pr_insituacao_rating    => NULL
                                                            ,pr_inorigem_rating      => NULL
                                                            ,pr_cdoperad_rating      => pr_cdoperad
                                                            ,pr_tpoperacao_rating    => NULL
                                                            ,pr_retxml               => vr_xml
                                                            ,pr_cdcritic             => vr_cdcritic
                                                            ,pr_dscritic             => vr_dscritic);
                IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
                  RAISE vr_exc_saida;
                END IF;
                
                gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                              ,pr_des_text => 'UPDATE tbrisco_operacoes SET '
                                                                  ||' flintegrar_sas = 0 '
                                                            ||' WHERE cdcooper = '||pr_cdcooper
                                                            ||'   AND nrdconta = '||pr_nrdconta
                                                             ||'  AND nrctremp = '||pr_nrctrlim
                                                             ||'  AND tpctrato = 1;' -- Limite Credito        
                                                          );        
   
  
                 gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                         ,pr_des_text => 'delete tbrating_historicos '
                       ||' WHERE cdcooper = '||pr_cdcooper           
                       ||' and nrdconta = '||pr_nrdconta                                 
                       ||'  AND nrctremp = '||pr_nrctrlim                                 
                       ||' AND tpctrato = 1 '                                 
                       ||' and ds_justificativa = '||''''||'Renovacao Limite de credito em massa1'||''''                                 
                       ||';'                                 
                      );                                  
              END IF;                                                  
                                   
           ELSE
             RAISE vr_exc_saida;
           END IF;  
        ELSE

          -- Buscar Valor Endividamento e Valor Limite Rating (TAB056)
          RATI0003.pc_busca_endivid_param(pr_cdcooper => pr_cdcooper
                                         ,pr_nrdconta => pr_nrdconta
                                         ,pr_vlendivi => vr_vlendivid
                                         ,pr_vlrating => vr_vllimrating
                                         ,pr_dscritic => vr_dscritic);
          IF TRIM(vr_dscritic) IS NOT NULL THEN
             RAISE vr_exc_saida;
          END IF;

          -- Status do rating inválido
          IF vr_flgrating = 0 THEN
            vr_dscritic := 'Contrato não pode ser efetivado porque não há Rating válido.';
            RAISE vr_exc_saida;

          ELSE -- Status do rating válido

            -- Se Endividamento + Contrato atual > Parametro Rating (TAB056)
            IF ((vr_vlendivid) > vr_vllimrating) THEN

              -- Gravar o Rating da operação, efetivando-o
              rati0003.pc_grava_rating_operacao(pr_cdcooper          => pr_cdcooper
                                               ,pr_nrdconta          => pr_nrdconta
                                               ,pr_tpctrato          => 1 -- Limite Credito
                                               ,pr_nrctrato          => pr_nrctrlim
                                               ,pr_dtrating          => pr_dtmvtolt
                                               ,pr_strating          => 4
                                               ,pr_efetivacao_rating => 1 -- Identificar se deve considerar o parâmetro de contingência
                                               --Variáveis para gravar o histórico
                                               ,pr_cdoperad          => pr_cdoperad
                                               ,pr_dtmvtolt          => pr_dtmvtolt
                                               ,pr_valor             => rw_craplim.vllimite
                                               ,pr_rating_sugerido   => NULL
                                               ,pr_justificativa     => 'Renovação de Contrato - Efetivação do Rating [LIMI0001.pc_renovar_limite_cred_manual]'
                                               ,pr_tpoperacao_rating => 2
                                               ,pr_nrcpfcnpj_base    => rw_crapass.nrcpfcnpj_base
                                               --Variáveis de crítica
                                               ,pr_cdcritic          => vr_cdcritic
                                               ,pr_dscritic          => vr_dscritic);

              IF NVL(vr_cdcritic,0) > 0 OR TRIM(vr_dscritic) IS NOT NULL THEN
                RAISE vr_exc_saida;
              END IF;

              rati0005.pc_altera_flag_alterar(pr_cdcooper => pr_cdcooper
                                             ,pr_nrdconta => pr_nrdconta
                                             ,pr_nrctrato => pr_nrctrlim
                                             ,pr_tpctrato => 1 -- Limite Credito
                                             ,pr_flgalter => 0
                                             ,pr_dscritic => vr_dscritic);

              IF TRIM(vr_dscritic) IS NOT NULL THEN
                RAISE vr_exc_saida;
              END IF;

            END IF;
          END IF;

        END IF; --- rating vencido

      END IF;
      -- Verifica processamento do Rating Renovacao
    END IF;

    gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                  ,pr_des_text => 'UPDATE craplim SET '
                                                      ||' dtrenova = '||''''||to_char(rw_craplim.dtrenova,'dd/mm/rrrr')||''''
                                                      ||' ,tprenova = '||''''||rw_craplim.tprenova||''''
                                                      ||' ,dsnrenov = '||''''||rw_craplim.dsnrenov||''''                
                                                     ||' ,dtfimvig = '||''''||to_char(rw_craplim.dtfimvig_rollback,'dd/mm/rrrr')||''''
                                                      ||' ,qtrenova = '||rw_craplim.qtrenova
                                                      ||' ,cdoperad = '||''''||rw_craplim.cdoperad||''''
                                                      ||' ,cdopelib = '||''''||rw_craplim.cdoperad||''''
                                                ||' WHERE cdcooper = '||pr_cdcooper
                                                ||'   AND nrdconta = '||pr_nrdconta
                                                 ||'  AND nrctrlim = '||pr_nrctrlim
                                                 ||'  AND tpctrlim = 1;' -- Limite Credito        
                                              );
 
    -- Atualiza os dados do limite de cheque especial
    BEGIN
      UPDATE craplim SET
             dtrenova = pr_dtmvtolt,
             tprenova = 'M',
             dsnrenov = '',
             dtfimvig = pr_dtmvtolt + nvl(qtdiavig,0),
             qtrenova = nvl(qtrenova,0) + 1,
             cdoperad = pr_cdoperad,
             cdopelib = pr_cdoperad
       WHERE cdcooper = pr_cdcooper
         AND nrdconta = pr_nrdconta
         AND nrctrlim = pr_nrctrlim
         AND tpctrlim = 1; -- Limite Credito
    EXCEPTION
      WHEN OTHERS THEN
        vr_dscritic := 'Erro ao renovar o limite de credito: ' || SQLERRM;
        RAISE vr_exc_saida;
    END;

    /* Por default fica como 3 */
    vr_flgctitg  := 3;
    vr_dsaltera  := 'Renov. Manual Limite Cred. Ctr: ' || pr_nrctrlim || ',';

    /* Se for conta integracao ativa, seta a flag para enviar ao BB */
    IF trim(rw_crapass.nrdctitg) IS NOT NULL AND rw_crapass.flgctitg = 2 THEN  /* Ativa */
      --Conta Integracao
      vr_flgctitg := 0;
    END IF;

    /* Verifica se jah possui alteracao */
    OPEN cr_crapalt (pr_cdcooper => pr_cdcooper
                    ,pr_nrdconta => pr_nrdconta
                    ,pr_dtmvtolt => pr_dtmvtolt);
    FETCH cr_crapalt INTO rw_crapalt;
    --Verificar se encontrou
    IF cr_crapalt%FOUND THEN
      --Fechar Cursor
      CLOSE cr_crapalt;

    gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                  ,pr_des_text => 'UPDATE crapalt SET '
                                                          ||' dsaltera = '||''''||to_char(rw_craplim.dtrenova,'dd/mm/rrrr')||''''
                                                          ||' ,cdoperad = '||''''||rw_craplim.cdoperad||''''
                                                          ||' ,flgctitg = '||''''||rw_craplim.cdoperad||''''
                                                    ||' WHERE rowid = '||''''||rw_crapalt.rowid||''''
                                                    ||';'
                                                   );          

      -- Altera o registro
      BEGIN
        UPDATE crapalt SET
               crapalt.dsaltera = rw_crapalt.dsaltera || vr_dsaltera,
               crapalt.cdoperad = pr_cdoperad,
               crapalt.flgctitg = vr_flgctitg
         WHERE crapalt.rowid = rw_crapalt.rowid;
      EXCEPTION
        WHEN OTHERS THEN
          vr_dscritic:= 'Erro ao atualizar crapalt. '||SQLERRM;
          --Sair
          RAISE vr_exc_saida;
      END;
    ELSE
      --Fechar Cursor
      CLOSE cr_crapalt;

      --Inserir Alteracao
      BEGIN
        INSERT INTO crapalt
          (crapalt.nrdconta
          ,crapalt.dtaltera
          ,crapalt.tpaltera
          ,crapalt.dsaltera
          ,crapalt.cdcooper
          ,crapalt.flgctitg
          ,crapalt.cdoperad)
        VALUES
          (pr_nrdconta
          ,pr_dtmvtolt
          ,2
          ,vr_dsaltera
          ,pr_cdcooper
          ,vr_flgctitg
          ,pr_cdoperad);

          gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                        ,pr_des_text => 'delete crapalt '
                                      ||' WHERE cdcooper = '||pr_cdcooper
                                      ||' and nrdconta = '||pr_nrdconta
                                      ||' and tpaltera = 2'
                                      ||' and dtaltera = '||''''||to_char(pr_dtmvtolt,'dd/mm/rrrr')||''''
                                      ||';'
                                     );          
    
      EXCEPTION
        WHEN OTHERS THEN
          vr_dscritic := 'Erro ao inserir crapalt. '||SQLERRM;
          RAISE vr_exc_saida;
      END;

    END IF;
    
   GENE0001.pc_gera_log(pr_cdcooper =>  pr_cdcooper
                        ,pr_cdoperad => '1'
                        ,pr_dscritic => ' '
                        ,pr_dsorigem => gene0001.vr_vet_des_origens(5)
                        ,pr_dstransa => 'Renovacao manual Limite (RITM00121279)'
                        ,pr_dttransa => TRUNC(SYSDATE)
                        ,pr_flgtrans => 1
                        ,pr_hrtransa => gene0002.fn_busca_time
                        ,pr_idseqttl => 1
                        ,pr_nmdatela => 'Script'
                        ,pr_nrdconta => pr_nrdconta
                        ,pr_nrdrowid => vr_nrdrowid);
    --
    GENE0001.pc_gera_log_item(pr_nrdrowid => vr_nrdrowid,
                              pr_nmdcampo => 'Contrato',
                              pr_dsdadant => NULL,
                              pr_dsdadatu => pr_nrctrlim);    

  EXCEPTION
    WHEN vr_exc_saida THEN
      pr_cdcritic := vr_cdcritic;
      pr_dscritic := vr_dscritic;
--      ROLLBACK;
    WHEN OTHERS THEN
      pr_cdcritic := vr_cdcritic;
      pr_dscritic := 'Erro geral pc_renovar_limite_cred_manual: '|| SQLERRM;
    --  ROLLBACK;
    END;

  END pc_renovar_limite_cred_manual;





begin
  -- Test statements here

      --Verificar se a data existe
      OPEN BTCH0001.cr_crapdat(pr_cdcooper => 14);
      FETCH BTCH0001.cr_crapdat INTO rw_crapdat;
      CLOSE BTCH0001.cr_crapdat;  

-- Banco individual
     --     vr_nmarq_rollback := '/progress/t0031664/micros/cpd/bacas/RITM0121279_ROLLBACK.sql';
     --     vr_nmarq_log      := '/progress/t0031664/micros/cpd/bacas/LOG_RITM0121279.txt';

-- Banco Test      
-- \\pkgtest\micros---  /microstst/cecred/Elton/
        --  vr_nmarq_rollback := '/microstst/cecred/Elton/RITM0121279_ROLLBACK.sql';
        --  vr_nmarq_log      := '/microstst/cecred/Elton/LOG_RITM0121279.txt';

 

-- caminho para produção:
          vr_dsdireto       := SISTEMA.obternomedirectory(GENE0001.fn_param_sistema('CRED',3,'ROOT_MICROS') || 'cecred/jaison/');
          vr_nmarq_rollback := vr_dsdireto||'RITM0121279_ROLLBACK.sql';
          vr_nmarq_log      := vr_dsdireto||'LOG_RITM0121279.txt';


         /* Abrir o arquivo de rollback */
          gene0001.pc_abre_arquivo(pr_nmcaminh => vr_nmarq_rollback
                                  ,pr_tipabert => 'W'           --> Modo de abertura (R,W,A)
                                  ,pr_utlfileh => vr_handle     --> Handle do arquivo aberto
                                  ,pr_des_erro => vr_des_erro);
          if vr_des_erro is not null then
            vr_dsmensagem := 'Erro ao abrir arquivo de rollback: ' || vr_des_erro;
            RAISE vr_exc_erro;
          end if;
          --
          /* Abrir o arquivo de LOG */
          gene0001.pc_abre_arquivo(pr_nmcaminh => vr_nmarq_log
                                  ,pr_tipabert => 'W'                --> Modo de abertura (R,W,A)
                                  ,pr_utlfileh => vr_handle_log     --> Handle do arquivo aberto
                                  ,pr_des_erro => vr_des_erro);
          if vr_des_erro is not null then
            vr_dsmensagem := 'Erro ao abrir arquivo de LOG: ' || vr_des_erro;
            RAISE vr_exc_erro;
          end if;
          
          gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                        ,pr_des_text => 'Coop;Conta;Contrato;Mensagem');
                                        
--          dbms_output.put_line('Coop;Conta;Contrato;Mensagem');

 FOR r1 IN c1 LOOP

    pc_renovar_limite_cred_manual(pr_cdcooper => 14
                                 ,pr_cdoperad =>'1'
                                 ,pr_nmdatela =>'ATENDA'
                                 ,pr_idorigem =>5  --aimaro
                                 ,pr_nrdconta =>r1.nrdconta
                                 ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                 ,pr_nrctrlim =>  r1.nrctrlim
                                 ,pr_cdcritic => vr_cdcritic
                                 ,pr_dscritic => vr_dscritic);
     IF vr_dscritic IS NOT NULL THEN
          gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                        ,pr_des_text => r1.cdcooper || ';' || r1.nrdconta ||
                                                          ';' || r1.nrctrlim || ';' || vr_dscritic);
          vr_dscritic := NULL;                                                
     END IF;                 

  END LOOP;
  
  
 FOR r2 IN c2 LOOP

    pc_renovar_limite_cred_manual(pr_cdcooper => 14
                                 ,pr_cdoperad =>'1'
                                 ,pr_nmdatela =>'ATENDA'
                                 ,pr_idorigem =>5  --aimaro
                                 ,pr_nrdconta =>r2.nrdconta
                                 ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                 ,pr_nrctrlim =>  r2.nrctrlim
                                 ,pr_cdcritic => vr_cdcritic
                                 ,pr_dscritic => vr_dscritic);
     IF vr_dscritic IS NOT NULL THEN
          gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                        ,pr_des_text => r2.cdcooper || ';' || r2.nrdconta ||
                                                          ';' || r2.nrctrlim || ';' || vr_dscritic);
          vr_dscritic := NULL;                                                
     END IF;                     

  END LOOP;
  
 FOR r3 IN c3 LOOP

    pc_renovar_limite_cred_manual(pr_cdcooper => 14
                                 ,pr_cdoperad =>'1'
                                 ,pr_nmdatela =>'ATENDA'
                                 ,pr_idorigem =>5  --aimaro
                                 ,pr_nrdconta => r3.nrdconta
                                 ,pr_dtmvtolt => rw_crapdat.dtmvtolt
                                 ,pr_nrctrlim => r3.nrctrlim
                                 ,pr_cdcritic => vr_cdcritic
                                 ,pr_dscritic => vr_dscritic);
     IF vr_dscritic IS NOT NULL THEN
          gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                        ,pr_des_text => r3.cdcooper || ';' || r3.nrdconta ||
                                                          ';' || r3.nrctrlim || ';' || vr_dscritic);
          vr_dscritic := NULL;                                                
     END IF;                  

  END LOOP;  


  gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                ,pr_des_text => 'COMMIT;');
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle);
  gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle_log);
  
 -- ROLLBACK;
  COMMIT;

  EXCEPTION
    
    WHEN vr_exc_erro THEN
      dbms_output.put_line('Erro arquivos: ' || vr_dsmensagem);
      gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                    ,pr_des_text => 'Erro arquivos: ' || vr_dsmensagem || ' SQLERRM: ' || SQLERRM);      

      gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                    ,pr_des_text => 'COMMIT;');
      gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle);
      gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle_log);
      ROLLBACK;  
    WHEN OTHERS THEN
      dbms_output.put_line('Erro geral: ' || ' SQLERRM: ' || SQLERRM);
      gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle_log
                                    ,pr_des_text => 'Erro geral: ' || ' SQLERRM: ' || SQLERRM);

      gene0001.pc_escr_linha_arquivo(pr_utlfileh => vr_handle
                                    ,pr_des_text => 'COMMIT;');
      gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle);
      gene0001.pc_fecha_arquivo(pr_utlfileh => vr_handle_log);
      ROLLBACK;
END;
0
1
vr_dsdireto
